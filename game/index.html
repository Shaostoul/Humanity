<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Humanity</title>
  <link rel="manifest" href="/shared/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Humanity">
  <link rel="apple-touch-icon" href="/shared/icons/icon-192.png">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%231a1a2e'/%3E%3Ctext x='32' y='46' font-family='Arial,Helvetica,sans-serif' font-weight='bold' font-size='42' fill='%23FF8811' text-anchor='middle'%3EH%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="/shared/theme.css">
  <style>
    :root {
      --bg-panel: #141414;
      --border: #2a2a2a;
      --success: #4a8;
      --error: #e55;
      --warning: #eb4;

      /* Button state colors */
      --btn-clickable: #44cc66;
      --btn-hover: #4488ff;
      --btn-activated: #ee3333;
      --btn-disabled: #222222;
      --btn-cooldown: #8844cc;
    }

    body {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Tab Content ‚îÄ‚îÄ */
    .tab-content {
      flex: 1;
      display: none;
      padding: 1.5rem;
      padding-bottom: 80px;
      overflow-y: auto;
    }
    .tab-content.active { display: block; }

    .panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .panel h2 {
      font-size: 1.1rem;
      color: var(--accent);
      margin-bottom: 0.8rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.4rem;
    }

    .panel h3 {
      font-size: 0.9rem;
      color: var(--text);
      margin: 1rem 0 0.5rem;
    }

    .panel p {
      font-size: 0.85rem;
      color: var(--text-muted);
      line-height: 1.6;
      margin-bottom: 0.5rem;
    }

    .placeholder-text {
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.9rem;
      text-align: center;
      padding: 2rem 1rem;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }

    .card-grid .panel {
      transition: border-color 0.2s;
    }
    .card-grid .panel:hover {
      border-color: rgba(255, 136, 17, 0.3);
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       BUTTON DESIGN SYSTEM
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 120px;
      min-height: 44px;
      padding: 0.5rem 1.2rem;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      background: var(--bg-panel);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: box-shadow 0.15s ease;
      position: relative;
      user-select: none;
      font-family: inherit;
      box-shadow: inset 0 0 0 1px var(--btn-clickable);
    }

    .btn.btn-clickable,
    .btn:not(.btn-disabled):not(.btn-cooldown):not(.btn-channeling):not(.btn-activated) {
      box-shadow: inset 0 0 0 1px var(--btn-clickable);
    }

    .btn:not(.btn-disabled):not(.btn-cooldown):not(.btn-activated):hover {
      box-shadow: inset 0 0 0 3px var(--btn-hover), 0 0 12px rgba(68, 136, 255, 0.4) !important;
      animation: none;
    }

    .btn.btn-activated {
      box-shadow: inset 0 0 0 5px var(--btn-activated), 0 0 12px rgba(238, 51, 51, 0.4) !important;
      animation: none;
    }

    .btn.btn-channeling {
      animation: rainbow-shadow 3s linear infinite;
    }

    @keyframes rainbow-shadow {
      0%   { box-shadow: inset 0 0 0 1px #ff0000, 0 0 8px rgba(255,0,0,0.3); }
      16%  { box-shadow: inset 0 0 0 1px #ff8800, 0 0 8px rgba(255,136,0,0.3); }
      33%  { box-shadow: inset 0 0 0 1px #ffff00, 0 0 8px rgba(255,255,0,0.3); }
      50%  { box-shadow: inset 0 0 0 1px #00ff44, 0 0 8px rgba(0,255,68,0.3); }
      66%  { box-shadow: inset 0 0 0 1px #0088ff, 0 0 8px rgba(0,136,255,0.3); }
      83%  { box-shadow: inset 0 0 0 1px #8800ff, 0 0 8px rgba(136,0,255,0.3); }
      100% { box-shadow: inset 0 0 0 1px #ff0000, 0 0 8px rgba(255,0,0,0.3); }
    }

    .btn.btn-disabled {
      box-shadow: inset 0 0 0 2px var(--btn-disabled);
      color: var(--text-muted);
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn.btn-disabled:hover {
      box-shadow: inset 0 0 0 2px var(--btn-disabled) !important;
    }

    .btn.btn-cooldown {
      box-shadow: inset 0 0 0 7px var(--btn-cooldown);
      cursor: wait;
      color: var(--text-muted);
    }
    .btn.btn-cooldown:hover {
      box-shadow: inset 0 0 0 7px var(--btn-cooldown) !important;
    }

    .btn-cooldown-timer {
      position: absolute;
      font-size: 0.6rem;
      font-weight: 700;
      color: var(--btn-cooldown);
      background: var(--bg-panel);
      padding: 0 0.3rem;
      letter-spacing: 0.05em;
    }
    .btn-cooldown-timer.top {
      top: -2px;
      left: 50%;
      transform: translateX(-50%);
    }
    .btn-cooldown-timer.bottom {
      bottom: -2px;
      left: 50%;
      transform: translateX(-50%);
    }

    .btn-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1.2rem;
      margin: 0.5rem 0;
      align-items: center;
    }

    .btn-demo {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.4rem;
    }

    .btn-demo .btn-label {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    /* ‚îÄ‚îÄ Settings Panel (inline) ‚îÄ‚îÄ */
    #tab-settings .panel { max-width: 600px; }

    /* ‚îÄ‚îÄ Debug info items ‚îÄ‚îÄ */
    .debug-info {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 0.3rem 1rem;
      font-size: 0.82rem;
      margin: 0.5rem 0;
    }
    .debug-info dt {
      color: var(--text-muted);
      font-weight: 600;
    }
    .debug-info dd {
      color: var(--text);
      font-family: monospace;
      font-size: 0.78rem;
    }

    /* ‚îÄ‚îÄ Reality Cards ‚îÄ‚îÄ */
    .reality-card-header {
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .reality-card-header .collapse-icon {
      font-size: 0.7rem;
      color: var(--text-muted);
      transition: transform 0.2s;
    }
    .reality-card.collapsed .reality-card-body { display: none; }
    .reality-card.collapsed .collapse-icon { transform: rotate(-90deg); }

    /* Todo */
    .todo-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.4rem;
      border-radius: 4px;
      font-size: 0.85rem;
    }
    .todo-item:hover { background: var(--bg-hover); }
    .todo-item.completed { opacity: 0.5; }
    .todo-item.completed .todo-text { text-decoration: line-through; }
    .todo-item input[type="checkbox"] { accent-color: var(--accent); cursor: pointer; }
    .todo-text { flex: 1; color: var(--text); }
    .todo-delete {
      background: none; border: none; color: var(--text-muted); cursor: pointer;
      font-size: 0.75rem; padding: 0.1rem 0.3rem; border-radius: 3px; opacity: 0;
    }
    .todo-item:hover .todo-delete { opacity: 1; }
    .todo-delete:hover { color: var(--danger, #c44); }

    /* Notes */
    .note-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.5rem;
      border-radius: 4px;
      font-size: 0.82rem;
      cursor: pointer;
      color: var(--text-muted);
    }
    .note-item:hover { background: var(--bg-hover); color: var(--text); }
    .note-item.active { background: var(--accent-dim); color: var(--accent); font-weight: 600; }
    .note-delete {
      background: none; border: none; color: var(--text-muted); cursor: pointer;
      font-size: 0.7rem; padding: 0.1rem 0.3rem; opacity: 0; margin-left: auto;
    }
    .note-item:hover .note-delete { opacity: 1; }
    .note-delete:hover { color: var(--danger, #c44); }

    /* Garden */
    #garden-grid {
      display: grid;
      gap: 4px;
    }
    .garden-plot {
      aspect-ratio: 1;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: var(--text-muted);
      cursor: pointer;
      text-align: center;
      padding: 2px;
      word-break: break-word;
      transition: border-color 0.15s;
    }
    .garden-plot:hover { border-color: var(--accent); }
    .garden-plot.planted {
      background: rgba(68,170,68,0.1);
      border-color: rgba(68,170,68,0.3);
      color: var(--text);
      font-weight: 600;
    }

    /* ‚îÄ‚îÄ Catalog System ‚îÄ‚îÄ */
    .catalog-search-bar {
      display: flex; gap: 0.5rem; margin-bottom: 1.2rem; position: sticky; top: 0; z-index: 10;
      background: var(--bg, #0a0a0a); padding: 0.5rem 0;
    }
    .catalog-search-bar input {
      flex: 1; background: var(--bg-input); border: 1px solid var(--border); color: var(--text);
      padding: 0.6rem 1rem; border-radius: 8px; font-size: 0.9rem; outline: none; font-family: inherit;
    }
    .catalog-search-bar input:focus { border-color: var(--accent); }
    .catalog-search-results {
      background: var(--bg-card, #1a1a1a); border: 1px solid var(--border); border-radius: 8px;
      margin-bottom: 1rem; max-height: 300px; overflow-y: auto;
    }
    .catalog-search-results:empty { display: none; }
    .catalog-result-item {
      display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem 0.8rem;
      cursor: pointer; font-size: 0.82rem; border-bottom: 1px solid var(--border);
    }
    .catalog-result-item:last-child { border-bottom: none; }
    .catalog-result-item:hover { background: var(--bg-hover, rgba(255,255,255,0.03)); }
    .catalog-result-badge {
      font-size: 0.6rem; font-weight: 700; padding: 0.1rem 0.4rem; border-radius: 3px;
      text-transform: uppercase; flex-shrink: 0;
    }

    /* Reference Sources Grid */
    .ref-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem; }
    .ref-card {
      display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.7rem;
      background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px;
      text-decoration: none; color: var(--text); font-size: 0.78rem; transition: border-color 0.15s;
    }
    .ref-card:hover { border-color: var(--accent); }
    .ref-card .ref-icon { font-size: 1.1rem; flex-shrink: 0; }
    .ref-card .ref-name { font-weight: 600; color: var(--text); }
    .ref-card .ref-desc { font-size: 0.7rem; color: var(--text-muted); }

    /* Element Cards */
    .element-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 0.4rem; }
    .element-card {
      background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px;
      padding: 0.4rem; text-align: center; cursor: pointer; transition: border-color 0.15s, transform 0.1s;
      position: relative;
    }
    .element-card:hover { transform: scale(1.05); z-index: 1; }
    .element-card .el-number { font-size: 0.6rem; color: var(--text-muted); position: absolute; top: 3px; left: 5px; }
    .element-card .el-symbol { font-size: 1.3rem; font-weight: 700; margin: 0.1rem 0; }
    .element-card .el-name { font-size: 0.6rem; color: var(--text-muted); }
    .element-card .el-mass { font-size: 0.55rem; color: var(--text-muted); opacity: 0.6; }
    .el-cat-nonmetal { border-color: rgba(76,175,80,0.4); } .el-cat-nonmetal .el-symbol { color: #4caf50; }
    .el-cat-metal { border-color: rgba(66,165,245,0.4); } .el-cat-metal .el-symbol { color: #42a5f5; }
    .el-cat-metalloid { border-color: rgba(255,167,38,0.4); } .el-cat-metalloid .el-symbol { color: #ffa726; }
    .el-cat-noble-gas { border-color: rgba(171,71,188,0.4); } .el-cat-noble-gas .el-symbol { color: #ab47bc; }
    .el-cat-transition-metal { border-color: rgba(66,165,245,0.4); } .el-cat-transition-metal .el-symbol { color: #42a5f5; }
    .el-cat-actinide { border-color: rgba(239,83,80,0.4); } .el-cat-actinide .el-symbol { color: #ef5350; }

    /* Element Detail */
    .element-detail {
      background: var(--bg-card, #1a1a1a); border: 1px solid var(--border); border-radius: 10px;
      padding: 1.2rem; margin-bottom: 1rem; animation: fadeIn 0.15s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: none; } }
    .element-detail h3 { margin: 0 0 0.6rem; font-size: 1.1rem; }
    .element-detail .el-props { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.4rem; margin: 0.6rem 0; }
    .element-detail .el-prop { background: var(--bg-input); border-radius: 4px; padding: 0.3rem 0.5rem; font-size: 0.78rem; }
    .element-detail .el-prop dt { color: var(--text-muted); font-size: 0.65rem; text-transform: uppercase; }
    .element-detail .el-prop dd { color: var(--text); font-weight: 600; margin: 0; }

    /* Materials */
    .material-card {
      background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px;
      padding: 0.7rem; cursor: pointer; transition: border-color 0.15s;
    }
    .material-card:hover { border-color: var(--accent); }
    .material-type-badge {
      display: inline-block; font-size: 0.6rem; font-weight: 700; padding: 0.1rem 0.4rem;
      border-radius: 3px; text-transform: uppercase;
    }
    .mat-raw { background: rgba(139,195,74,0.2); color: #8bc34a; }
    .mat-processed { background: rgba(66,165,245,0.2); color: #42a5f5; }
    .mat-composite { background: rgba(255,167,38,0.2); color: #ffa726; }
    .processing-chain {
      display: flex; align-items: center; gap: 0.3rem; flex-wrap: wrap;
      font-size: 0.75rem; color: var(--text-muted); margin-top: 0.4rem;
    }
    .processing-chain .chain-arrow { color: var(--accent); font-weight: 700; }

    /* Inventory */
    .inv-privacy-banner {
      background: rgba(76,175,80,0.1); border: 1px solid rgba(76,175,80,0.3); border-radius: 8px;
      padding: 0.5rem 0.8rem; font-size: 0.78rem; color: #4caf50; text-align: center; margin-bottom: 0.8rem;
    }
    .inv-toolbar { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 0.8rem; align-items: center; }
    .inv-toolbar select, .inv-toolbar input {
      background: var(--bg-input); border: 1px solid var(--border); color: var(--text);
      padding: 0.35rem 0.6rem; border-radius: 6px; font-size: 0.8rem; font-family: inherit; outline: none;
    }
    .inv-item {
      background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px;
      padding: 0.6rem; transition: border-color 0.15s;
    }
    .inv-item:hover { border-color: var(--accent); }

    /* Modal */
    .catalog-modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;
    }
    .catalog-modal-overlay.open { display: flex; }
    .catalog-modal {
      background: var(--bg-card, #1a1a1a); border: 1px solid var(--border); border-radius: 12px;
      padding: 1.5rem; max-width: 550px; width: 92%; max-height: 85vh; overflow-y: auto; position: relative;
    }
    .catalog-modal .modal-close {
      position: absolute; top: 0.5rem; right: 0.8rem; background: none; border: none;
      color: var(--text-muted); font-size: 1.3rem; cursor: pointer;
    }
    .catalog-modal label { font-size: 0.75rem; color: var(--text-muted); display: block; margin: 0.4rem 0 0.15rem; }
    .catalog-modal input, .catalog-modal select, .catalog-modal textarea {
      width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text);
      padding: 0.4rem 0.6rem; border-radius: 6px; font-size: 0.82rem; outline: none; font-family: inherit;
      box-sizing: border-box;
    }
    .catalog-modal textarea { resize: vertical; }
    .catalog-modal .modal-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .catalog-modal .modal-actions button {
      flex: 1; padding: 0.5rem; border: none; border-radius: 6px; font-size: 0.85rem;
      font-weight: 600; cursor: pointer; font-family: inherit;
    }

    .filter-pills { display: flex; gap: 0.3rem; flex-wrap: wrap; margin-bottom: 0.6rem; }
    .filter-pill {
      background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted);
      padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.72rem; cursor: pointer; transition: all 0.15s;
    }
    .filter-pill.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .filter-pill:hover { border-color: var(--accent); }

    /* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
    @media (max-width: 600px) {
      .tab-content {
        padding: 1rem;
      }
      .card-grid {
        grid-template-columns: 1fr;
      }
      .element-grid { grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); }
      .ref-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <script src="/shared/shell.js"></script>
  <script src="/shared/settings.js"></script>
  <script>
    document.querySelectorAll('.hub-nav .tab[href^="/board"]').forEach(el => el.setAttribute('data-tab', 'board'));
    document.querySelectorAll('.hub-nav .tab[href^="/reality"]').forEach(el => el.setAttribute('data-tab', 'reality'));
    document.querySelectorAll('.hub-nav .tab[href^="/fantasy"]').forEach(el => el.setAttribute('data-tab', 'fantasy'));
    document.querySelectorAll('.hub-nav .tab[href^="/streams"]').forEach(el => el.setAttribute('data-tab', 'streams'));
    document.querySelectorAll('.hub-nav .tab[href^="/info"]').forEach(el => el.setAttribute('data-tab', 'info'));
    document.querySelectorAll('.hub-nav .tab[href^="/market"]').forEach(el => el.setAttribute('data-tab', 'market'));
    document.querySelectorAll('.hub-nav .tab[href^="/browse"]').forEach(el => el.setAttribute('data-tab', 'browse'));
    document.querySelectorAll('.hub-nav .tab[href^="/dashboard"]').forEach(el => el.setAttribute('data-tab', 'dashboard'));
    document.querySelectorAll('.hub-nav .tab[href^="/debug"]').forEach(el => el.setAttribute('data-tab', 'debug'));
  </script>

  <!-- Board Tab -->
  <div id="tab-board" class="tab-content" style="padding:1rem;overflow-y:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
      <h2 style="color:var(--accent);margin:0;font-size:1.1rem;">üìã Project Board</h2>
      <button class="btn btn-clickable" id="board-create-btn" style="display:none;min-width:auto;min-height:36px;padding:0.3rem 0.8rem;font-size:0.8rem;" onclick="showCreateTaskModal()">+ New Task</button>
    </div>
    <div id="board-columns" style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.8rem;min-height:300px;">
      <div class="board-column" data-status="backlog">
        <div class="board-col-header" style="font-size:0.85rem;font-weight:700;color:var(--text-muted);padding:0.4rem 0.5rem;border-bottom:2px solid #555;margin-bottom:0.5rem;">üì• Backlog <span class="board-col-count" data-status="backlog">0</span></div>
        <div class="board-col-cards" data-status="backlog"></div>
      </div>
      <div class="board-column" data-status="in_progress">
        <div class="board-col-header" style="font-size:0.85rem;font-weight:700;color:#4488ff;padding:0.4rem 0.5rem;border-bottom:2px solid #4488ff;margin-bottom:0.5rem;">üîß In Progress <span class="board-col-count" data-status="in_progress">0</span></div>
        <div class="board-col-cards" data-status="in_progress"></div>
      </div>
      <div class="board-column" data-status="testing">
        <div class="board-col-header" style="font-size:0.85rem;font-weight:700;color:#eb4;padding:0.4rem 0.5rem;border-bottom:2px solid #eb4;margin-bottom:0.5rem;">üß™ Testing <span class="board-col-count" data-status="testing">0</span></div>
        <div class="board-col-cards" data-status="testing"></div>
      </div>
      <div class="board-column" data-status="done">
        <div class="board-col-header" style="font-size:0.85rem;font-weight:700;color:#4a8;padding:0.4rem 0.5rem;border-bottom:2px solid #4a8;margin-bottom:0.5rem;">‚úÖ Done <span class="board-col-count" data-status="done">0</span></div>
        <div class="board-col-cards" data-status="done"></div>
      </div>
    </div>
    <div id="board-loading" style="text-align:center;color:var(--text-muted);padding:2rem;font-size:0.85rem;">Loading tasks‚Ä¶</div>

    <!-- Task Modal -->
    <div id="task-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;display:none;align-items:center;justify-content:center;">
      <div style="background:var(--bg-card,#1a1a1a);border:1px solid var(--border);border-radius:12px;padding:1.5rem;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;position:relative;">
        <button onclick="closeTaskModal()" style="position:absolute;top:0.8rem;right:0.8rem;background:none;border:none;color:var(--text-muted);font-size:1.2rem;cursor:pointer;">‚úï</button>
        <div id="task-modal-content"></div>
      </div>
    </div>
  </div>

  <!-- Reality Tab -->
  <div id="tab-reality" class="tab-content">
    <!-- Universal Search -->
    <div class="catalog-search-bar">
      <input type="text" id="universal-search" placeholder="üîç Search elements, materials, inventory‚Ä¶" oninput="universalSearch(this.value)">
    </div>
    <div class="catalog-search-results" id="universal-search-results"></div>

    <div class="panel" style="margin-bottom:1rem;">
      <h2>üü¢ Reality</h2>
      <p>Your real-world dashboard. Knowledge base, catalogs, and personal tools ‚Äî all local-first.</p>
    </div>

    <!-- ‚îÄ‚îÄ Todo List ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="reality-todo">
      <h2 class="reality-card-header" onclick="toggleRealityCard('todo')">‚úÖ Todo List <span class="collapse-icon" id="todo-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="todo-body">
        <div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;">
          <input type="text" id="todo-input" placeholder="Add a task‚Ä¶" style="flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;" onkeydown="if(event.key==='Enter')addTodo()">
          <button onclick="addTodo()" style="background:var(--accent);color:#fff;border:none;padding:0.4rem 0.8rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;">Add</button>
        </div>
        <div id="todo-list"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Notes ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="reality-notes">
      <h2 class="reality-card-header" onclick="toggleRealityCard('notes')">üìù Notes <span class="collapse-icon" id="notes-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="notes-body">
        <div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;">
          <button onclick="addNote()" style="background:var(--accent);color:#fff;border:none;padding:0.4rem 0.8rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;">+ New Note</button>
        </div>
        <div id="notes-list" style="margin-bottom:0.6rem;"></div>
        <div id="notes-editor" style="display:none;">
          <input type="text" id="note-title" placeholder="Note title" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:0.4rem;" oninput="saveCurrentNote()">
          <textarea id="note-content" placeholder="Write your note‚Ä¶" rows="8" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.5rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;resize:vertical;line-height:1.5;" oninput="saveCurrentNote()"></textarea>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Garden Tracker ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="reality-garden">
      <h2 class="reality-card-header" onclick="toggleRealityCard('garden')">üå± Garden Tracker <span class="collapse-icon" id="garden-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="garden-body">
        <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.6rem;">Click a plot to set what's planted. Your garden, your data.</p>
        <div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;align-items:center;">
          <label style="font-size:0.8rem;color:var(--text-muted);">Grid:</label>
          <select id="garden-size" onchange="resizeGarden()" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.3rem 0.5rem;border-radius:4px;font-size:0.8rem;">
            <option value="3">3√ó3</option>
            <option value="4" selected>4√ó4</option>
            <option value="5">5√ó5</option>
            <option value="6">6√ó6</option>
          </select>
        </div>
        <div id="garden-grid"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Reference Sources ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="reality-references">
      <h2 class="reality-card-header" onclick="toggleRealityCard('references')">üìö Reference Sources <span class="collapse-icon" id="references-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="references-body">
        <div class="ref-grid" id="ref-sources-grid"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Element Catalog ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="reality-elements">
      <h2 class="reality-card-header" onclick="toggleRealityCard('elements')">üß™ Element Catalog <span class="collapse-icon" id="elements-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="elements-body">
        <div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;flex-wrap:wrap;align-items:center;">
          <input type="text" id="element-filter" placeholder="Filter elements‚Ä¶" oninput="renderElements()" style="flex:1;min-width:140px;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.35rem 0.6rem;border-radius:6px;font-size:0.8rem;outline:none;font-family:inherit;">
        </div>
        <div class="filter-pills" id="element-cat-pills"></div>
        <div id="element-detail-slot"></div>
        <div class="element-grid" id="element-grid"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Materials Catalog ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="reality-materials">
      <h2 class="reality-card-header" onclick="toggleRealityCard('materials')">üèóÔ∏è Materials Catalog <span class="collapse-icon" id="materials-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="materials-body">
        <div class="filter-pills" id="material-type-pills"></div>
        <div id="material-detail-slot"></div>
        <div id="materials-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:0.5rem;"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Personal Inventory ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="reality-inventory">
      <h2 class="reality-card-header" onclick="toggleRealityCard('inventory')">üì¶ Personal Inventory <span class="collapse-icon" id="inventory-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="inventory-body">
        <div class="inv-privacy-banner">üîí Private ‚Äî stored only on this device, never uploaded</div>
        <div class="inv-toolbar">
          <button onclick="openInventoryModal()" style="background:var(--accent);color:#fff;border:none;padding:0.35rem 0.8rem;border-radius:6px;font-size:0.8rem;cursor:pointer;font-weight:600;">+ Add Item</button>
          <select id="inv-category-filter" onchange="renderInventory()" style="min-width:100px;">
            <option value="">All Categories</option>
          </select>
          <input type="text" id="inv-search" placeholder="Search‚Ä¶" oninput="renderInventory()" style="flex:1;min-width:100px;">
          <button onclick="exportInventory()" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.35rem 0.6rem;border-radius:6px;font-size:0.75rem;cursor:pointer;" title="Export JSON">üì§</button>
          <button onclick="document.getElementById('inv-import-file').click()" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.35rem 0.6rem;border-radius:6px;font-size:0.75rem;cursor:pointer;" title="Import JSON">üì•</button>
          <input type="file" id="inv-import-file" accept=".json" style="display:none" onchange="importInventory(event)">
        </div>
        <div id="inventory-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:0.5rem;"></div>
      </div>
    </div>

    <!-- Inventory Modal -->
    <div class="catalog-modal-overlay" id="inv-modal">
      <div class="catalog-modal">
        <button class="modal-close" onclick="closeInventoryModal()">‚úï</button>
        <h3 style="color:var(--text);margin:0 0 0.8rem;" id="inv-modal-title">Add Item</h3>
        <input type="hidden" id="inv-edit-id">
        <label>Name *</label><input type="text" id="inv-name" maxlength="100">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
          <div><label>Category</label><select id="inv-category"></select></div>
          <div><label>Subcategory</label><input type="text" id="inv-subcategory" maxlength="50"></div>
        </div>
        <label>Description</label><textarea id="inv-description" rows="2"></textarea>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.5rem;">
          <div><label>Quantity</label><input type="number" id="inv-quantity" min="1" value="1"></div>
          <div><label>Condition</label><select id="inv-condition"><option>New</option><option selected>Good</option><option>Fair</option><option>Poor</option></select></div>
          <div><label>Acquired</label><input type="text" id="inv-acquired" placeholder="2024" maxlength="20"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
          <div><label>Location</label><input type="text" id="inv-location" maxlength="50"></div>
          <div><label>Est. Value</label><input type="text" id="inv-value" maxlength="20"></div>
        </div>
        <label>Notes</label><textarea id="inv-notes" rows="2"></textarea>
        <label>Tags (comma-separated)</label><input type="text" id="inv-tags" placeholder="daily-use, important">
        <div class="modal-actions">
          <button onclick="closeInventoryModal()" style="background:var(--bg-input);color:var(--text-muted);">Cancel</button>
          <button onclick="saveInventoryItem()" style="background:var(--accent);color:#fff;">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Fantasy Tab -->
  <div id="tab-fantasy" class="tab-content">
    <div class="panel" style="border-color:rgba(120,80,200,0.3);">
      <h2 style="color:var(--fantasy-accent,#9966ff);">‚ú® Fantasy</h2>
      <p>The game side of Humanity. Your character, the world lore, and achievements ‚Äî all stored locally. The adventure begins here.</p>
    </div>
    <div class="card-grid">

      <!-- ‚îÄ‚îÄ World Map ‚îÄ‚îÄ -->
      <div class="panel reality-card" id="fantasy-worldmap" style="border-color:rgba(120,80,200,0.2);">
        <h2 class="reality-card-header" onclick="toggleFantasyCard('worldmap')" style="color:var(--fantasy-accent,#9966ff);">üó∫Ô∏è World Map <span class="collapse-icon" id="worldmap-collapse">‚ñº</span></h2>
        <div class="reality-card-body" id="worldmap-body">
          <canvas id="world-map-canvas" width="560" height="280" style="width:100%;border-radius:8px;background:#0a0a1a;cursor:crosshair;"></canvas>
          <p style="text-align:center;margin-top:0.6rem;color:var(--fantasy-accent,#9966ff);font-style:italic;font-size:0.85rem;">
            "The world is being built‚Ä¶"
          </p>
          <p style="font-size:0.8rem;color:var(--text-muted);text-align:center;line-height:1.6;">
            In the age before networks, humanity was scattered ‚Äî isolated villages of thought, unable to share their fire.<br>
            Now the map fills itself, one connection at a time.
          </p>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Character Sheet ‚îÄ‚îÄ -->
      <div class="panel reality-card" id="fantasy-character" style="border-color:rgba(120,80,200,0.2);">
        <h2 class="reality-card-header" onclick="toggleFantasyCard('character')" style="color:var(--fantasy-accent,#9966ff);">‚öîÔ∏è Character Sheet <span class="collapse-icon" id="character-collapse">‚ñº</span></h2>
        <div class="reality-card-body" id="character-body">
          <div id="char-create" style="display:none;">
            <p style="font-size:0.82rem;color:var(--text-muted);margin-bottom:0.6rem;">Create your character to begin.</p>
            <input type="text" id="char-name-input" placeholder="Character name" maxlength="24" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:0.4rem;">
            <select id="char-class-input" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;font-family:inherit;margin-bottom:0.6rem;">
              <option value="Explorer">üß≠ Explorer</option>
              <option value="Builder">üî® Builder</option>
              <option value="Scholar">üìö Scholar</option>
              <option value="Guardian">üõ°Ô∏è Guardian</option>
            </select>
            <button onclick="createCharacter()" style="background:var(--fantasy-accent,#9966ff);color:#fff;border:none;padding:0.5rem 1.2rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;width:100%;">Create Character</button>
          </div>
          <div id="char-display" style="display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
              <div>
                <span id="char-d-name" style="font-weight:700;font-size:1rem;color:var(--text);"></span>
                <span id="char-d-class" style="font-size:0.8rem;color:var(--fantasy-accent,#9966ff);margin-left:0.4rem;"></span>
              </div>
              <span id="char-d-level" style="font-size:0.75rem;color:var(--text-muted);background:var(--bg-input);padding:0.15rem 0.5rem;border-radius:10px;"></span>
            </div>
            <div id="char-stats" style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;margin-bottom:0.6rem;"></div>
            <div style="display:flex;gap:0.4rem;">
              <button onclick="rerollStats()" style="flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem;border-radius:6px;font-size:0.8rem;cursor:pointer;font-family:inherit;">üé≤ Reroll Stats</button>
              <button onclick="deleteCharacter()" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.4rem 0.8rem;border-radius:6px;font-size:0.8rem;cursor:pointer;font-family:inherit;">üóëÔ∏è</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Lore / Codex ‚îÄ‚îÄ -->
      <div class="panel reality-card" id="fantasy-lore" style="border-color:rgba(120,80,200,0.2);">
        <h2 class="reality-card-header" onclick="toggleFantasyCard('lore')" style="color:var(--fantasy-accent,#9966ff);">üìú Lore / Codex <span class="collapse-icon" id="lore-collapse">‚ñº</span></h2>
        <div class="reality-card-body" id="lore-body">
          <div id="lore-entries" style="display:flex;flex-direction:column;gap:0.4rem;"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Achievements ‚îÄ‚îÄ -->
      <div class="panel reality-card" id="fantasy-achievements" style="border-color:rgba(120,80,200,0.2);">
        <h2 class="reality-card-header" onclick="toggleFantasyCard('achievements')" style="color:var(--fantasy-accent,#9966ff);">üèÜ Achievements <span class="collapse-icon" id="achievements-collapse">‚ñº</span></h2>
        <div class="reality-card-body" id="achievements-body">
          <div id="achievement-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:0.5rem;"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Streams Tab -->
  <div id="tab-streams" class="tab-content">
    <style>
      #tab-streams .stream-grid { display:grid; grid-template-columns:1fr 320px; gap:1rem; }
      @media (max-width:768px) { #tab-streams .stream-grid { grid-template-columns:1fr; } }
      #tab-streams .stream-panel { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:10px; padding:1rem; }
      #tab-streams .stream-preview { position:relative; width:100%; aspect-ratio:16/9; background:#000; border-radius:8px; overflow:hidden; }
      #tab-streams .stream-preview canvas,
      #tab-streams .stream-preview video { width:100%; height:100%; object-fit:contain; }
      #tab-streams .pip-overlay { position:absolute; border:2px solid rgba(153,102,255,0.6); border-radius:6px; cursor:move; z-index:2; overflow:hidden; }
      #tab-streams .pip-overlay video { width:100%; height:100%; object-fit:cover; }
      #tab-streams .stream-stats { display:flex; gap:1rem; flex-wrap:wrap; font-size:0.8rem; color:var(--text-muted); margin:0.6rem 0; }
      #tab-streams .stream-stats span { display:flex; align-items:center; gap:0.3rem; }
      #tab-streams .stream-setting { display:flex; align-items:center; gap:0.5rem; margin:0.4rem 0; font-size:0.82rem; }
      #tab-streams .stream-setting label { color:var(--text-muted); min-width:100px; }
      #tab-streams .stream-setting input[type="text"],
      #tab-streams .stream-setting select { background:var(--bg); border:1px solid var(--border); color:var(--text); padding:0.3rem 0.5rem; border-radius:5px; flex:1; font-size:0.8rem; }
      #tab-streams .stream-setting input[type="checkbox"] { accent-color:var(--accent); }
      #tab-streams .corner-picker { display:grid; grid-template-columns:1fr 1fr; gap:2px; width:36px; }
      #tab-streams .corner-picker span { width:16px; height:16px; border:1px solid var(--border); border-radius:3px; cursor:pointer; background:rgba(255,255,255,0.03); }
      #tab-streams .corner-picker span.active { background:var(--accent); border-color:var(--accent); }
      #tab-streams .stream-chat-panel { display:flex; flex-direction:column; height:400px; }
      #tab-streams .stream-chat-tabs { display:flex; gap:0.3rem; margin-bottom:0.5rem; flex-wrap:wrap; }
      #tab-streams .stream-chat-tabs button { font-size:0.72rem; padding:0.2rem 0.5rem; border-radius:4px; border:1px solid var(--border); background:transparent; color:var(--text-muted); cursor:pointer; }
      #tab-streams .stream-chat-tabs button.active { background:var(--accent); color:#fff; border-color:var(--accent); }
      #tab-streams .stream-chat-messages { flex:1; overflow-y:auto; font-size:0.8rem; padding:0.3rem; background:rgba(0,0,0,0.2); border-radius:6px; }
      #tab-streams .stream-chat-msg { padding:0.15rem 0; }
      #tab-streams .stream-chat-msg .src-humanity { color:#f90; }
      #tab-streams .stream-chat-msg .src-twitch { color:#9146ff; }
      #tab-streams .stream-chat-msg .src-youtube { color:#e55; }
      #tab-streams .stream-chat-msg .src-rumble { color:#6c5; }
      #tab-streams .stream-chat-input { display:flex; gap:0.3rem; margin-top:0.4rem; }
      #tab-streams .stream-chat-input input { flex:1; background:var(--bg); border:1px solid var(--border); color:var(--text); padding:0.3rem 0.5rem; border-radius:5px; font-size:0.8rem; }
      #tab-streams .stream-chat-input button { padding:0.3rem 0.7rem; }
      #tab-streams .viewer-card { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:10px; padding:0; overflow:hidden; cursor:pointer; transition:border-color 0.2s; }
      #tab-streams .viewer-card:hover { border-color:var(--accent); }
      #tab-streams .viewer-card .thumb { width:100%; aspect-ratio:16/9; background:#000; display:flex; align-items:center; justify-content:center; font-size:2.5rem; }
      #tab-streams .viewer-card .meta { padding:0.6rem; }
      #tab-streams .viewer-card .meta h3 { font-size:0.9rem; margin:0 0 0.2rem; }
      #tab-streams .viewer-card .meta .sub { font-size:0.75rem; color:var(--text-muted); }
      #tab-streams .stream-section { margin-bottom:1rem; }
      #tab-streams #stream-viewer-panel { display:none; }
      #tab-streams #stream-viewer-panel.active { display:block; }
    </style>

    <div class="card-grid">

      <!-- ‚îÄ‚îÄ Streamer Dashboard (collapsible) ‚îÄ‚îÄ -->
      <div class="panel reality-card" id="streams-dashboard">
        <h2 class="reality-card-header" onclick="toggleStreamsCard('dashboard')">üì° Stream Control <span class="collapse-icon" id="dashboard-collapse">‚ñº</span></h2>
        <div class="reality-card-body" id="dashboard-body">
          <div class="stream-grid">
            <!-- Left: Preview -->
            <div>
              <div class="stream-preview" id="stream-preview-container">
                <canvas id="stream-composite-canvas" width="1920" height="1080"></canvas>
                <div class="pip-overlay" id="pip-overlay" style="display:none;width:240px;height:180px;bottom:10px;right:10px;">
                  <video id="pip-webcam-video" autoplay muted playsinline></video>
                </div>
                <div id="stream-preview-placeholder" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;color:var(--text-muted);font-size:0.85rem;">
                  <div style="font-size:2.5rem;margin-bottom:0.5rem;">üé¨</div>
                  <div>Start screen capture to preview</div>
                </div>
              </div>
              <div class="stream-stats" id="stream-stats-bar">
                <span id="stream-stat-viewers">üëÅ 0 viewers</span>
                <span id="stream-stat-duration">‚è± --:--</span>
                <span id="stream-stat-quality">üìä --</span>
                <span id="stream-stat-bitrate">üì∂ --</span>
              </div>
              <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.5rem;">
                <button class="btn btn-clickable" id="stream-go-live-btn" onclick="streamGoLive()">üî¥ GO LIVE</button>
                <button class="btn btn-disabled" id="stream-stop-btn" onclick="streamStop()" style="display:none;">‚èπ Stop</button>
              </div>
            </div>

            <!-- Right: Settings -->
            <div>
              <div class="stream-panel" style="margin-bottom:0.8rem;">
                <div style="font-weight:600;font-size:0.9rem;margin-bottom:0.6rem;">Stream Settings</div>
                <div class="stream-setting">
                  <input type="checkbox" id="stream-screen-cb" checked onchange="streamToggleScreen()">
                  <label for="stream-screen-cb" style="min-width:auto;">Screen Capture</label>
                  <button class="btn btn-clickable" style="font-size:0.7rem;padding:0.15rem 0.4rem;margin-left:auto;" onclick="streamStartScreen()">Select</button>
                </div>
                <div class="stream-setting">
                  <input type="checkbox" id="stream-webcam-cb" onchange="streamToggleWebcam()">
                  <label for="stream-webcam-cb" style="min-width:auto;">Webcam Overlay</label>
                  <select id="stream-webcam-size" onchange="streamUpdatePipSize()" style="width:80px;flex:none;">
                    <option value="small">Small</option>
                    <option value="medium" selected>Medium</option>
                    <option value="large">Large</option>
                  </select>
                </div>
                <div class="stream-setting" style="margin-left:1.4rem;">
                  <label style="min-width:auto;font-size:0.75rem;">Position:</label>
                  <div class="corner-picker" id="pip-corner-picker">
                    <span data-corner="tl" onclick="streamSetPipCorner('tl')"></span>
                    <span data-corner="tr" onclick="streamSetPipCorner('tr')"></span>
                    <span data-corner="bl" onclick="streamSetPipCorner('bl')"></span>
                    <span data-corner="br" class="active" onclick="streamSetPipCorner('br')"></span>
                  </div>
                </div>
                <div class="stream-setting">
                  <label>Title</label>
                  <input type="text" id="stream-title" placeholder="My Stream" maxlength="100">
                </div>
                <div class="stream-setting">
                  <label>Category</label>
                  <input type="text" id="stream-category" placeholder="Just Chatting" maxlength="50">
                </div>
              </div>

              <div class="stream-panel">
                <div style="font-weight:600;font-size:0.9rem;margin-bottom:0.6rem;">Restream To</div>
                <div class="stream-setting">
                  <input type="checkbox" id="stream-relay-cb" checked>
                  <label for="stream-relay-cb" style="min-width:auto;">Relay (direct)</label>
                  <span style="font-size:0.7rem;color:var(--text-muted);margin-left:auto;">Admin only</span>
                </div>
                <div class="stream-setting">
                  <input type="checkbox" id="stream-twitch-cb">
                  <label for="stream-twitch-cb" style="min-width:auto;">Twitch</label>
                  <input type="text" id="stream-twitch-url" placeholder="twitch.tv/username" style="flex:1;">
                </div>
                <div class="stream-setting">
                  <input type="checkbox" id="stream-youtube-cb">
                  <label for="stream-youtube-cb" style="min-width:auto;">YouTube</label>
                  <input type="text" id="stream-youtube-url" placeholder="youtube.com/live/..." style="flex:1;">
                </div>
                <div class="stream-setting">
                  <input type="checkbox" id="stream-rumble-cb">
                  <label for="stream-rumble-cb" style="min-width:auto;">Rumble</label>
                  <input type="text" id="stream-rumble-url" placeholder="rumble.com/user/..." style="flex:1;">
                </div>
              </div>
            </div>
          </div>

          <!-- Stream Chat -->
          <div class="stream-panel stream-chat-panel" style="margin-top:1rem;" id="stream-chat-section">
            <div style="font-weight:600;font-size:0.9rem;margin-bottom:0.4rem;">üí¨ Stream Chat</div>
            <div class="stream-chat-tabs" id="stream-chat-tabs">
              <button class="active" onclick="streamChatFilter('all')">All</button>
              <button onclick="streamChatFilter('humanity')">Humanity</button>
              <button onclick="streamChatFilter('twitch')">Twitch</button>
              <button onclick="streamChatFilter('youtube')">YouTube</button>
              <button onclick="streamChatFilter('rumble')">Rumble</button>
            </div>
            <div class="stream-chat-messages" id="stream-chat-messages"></div>
            <div class="stream-chat-input">
              <input type="text" id="stream-chat-input" placeholder="Type a message..." onkeydown="if(event.key==='Enter')streamChatSend()">
              <button class="btn btn-clickable" onclick="streamChatSend()">Send</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Live Streams (viewer) ‚îÄ‚îÄ -->
      <div class="panel reality-card" id="streams-live">
        <h2 class="reality-card-header" onclick="toggleStreamsCard('live')">üì∫ Live Now <span class="collapse-icon" id="live-collapse">‚ñº</span></h2>
        <div class="reality-card-body" id="live-body">
          <div id="stream-live-list">
            <div id="stream-live-empty" style="text-align:center;padding:2rem 1rem;">
              <div style="font-size:2rem;margin-bottom:0.5rem;">üì∫</div>
              <div style="color:var(--text-muted);font-size:0.85rem;">No one is live right now</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Viewer Panel (shown when watching) ‚îÄ‚îÄ -->
      <div class="panel reality-card" id="stream-viewer-panel">
        <h2 class="reality-card-header">
          <span id="viewer-stream-title">üì∫ Watching Stream</span>
          <button class="btn btn-clickable" style="font-size:0.7rem;padding:0.15rem 0.5rem;margin-left:auto;" onclick="streamViewerLeave()">‚úï Close</button>
        </h2>
        <div class="reality-card-body">
          <div class="stream-preview" id="viewer-video-container">
            <video id="viewer-video" autoplay playsinline style="width:100%;height:100%;"></video>
            <div id="viewer-embed-container" style="display:none;width:100%;height:100%;"></div>
          </div>
          <div class="stream-stats" id="viewer-stats-bar">
            <span id="viewer-stat-viewers">üëÅ 0</span>
            <span id="viewer-stat-duration">‚è± --:--</span>
            <span id="viewer-stat-quality">üìä --</span>
          </div>
          <!-- Viewer chat -->
          <div class="stream-panel stream-chat-panel" style="margin-top:0.6rem;height:300px;">
            <div class="stream-chat-tabs" id="viewer-chat-tabs">
              <button class="active" onclick="streamChatFilter('all','viewer')">All</button>
              <button onclick="streamChatFilter('humanity','viewer')">Humanity</button>
              <button onclick="streamChatFilter('twitch','viewer')">Twitch</button>
              <button onclick="streamChatFilter('youtube','viewer')">YouTube</button>
              <button onclick="streamChatFilter('rumble','viewer')">Rumble</button>
            </div>
            <div class="stream-chat-messages" id="viewer-chat-messages"></div>
            <div class="stream-chat-input">
              <input type="text" id="viewer-chat-input" placeholder="Type a message..." onkeydown="if(event.key==='Enter')streamChatSend('viewer')">
              <button class="btn btn-clickable" onclick="streamChatSend('viewer')">Send</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Server List ‚îÄ‚îÄ -->
      <div class="panel reality-card" id="streams-servers">
        <h2 class="reality-card-header" onclick="toggleStreamsCard('servers')">üñ•Ô∏è Servers <span class="collapse-icon" id="servers-collapse">‚ñº</span></h2>
        <div class="reality-card-body" id="servers-body">
          <div id="stream-servers-list">
            <div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem;background:rgba(255,255,255,0.02);border-radius:6px;margin-bottom:0.4rem;">
              <span style="font-size:1.1rem;" id="server-status-dot">üü¢</span>
              <div>
                <div style="font-weight:600;font-size:0.85rem;">Humanity HQ</div>
                <div style="font-size:0.7rem;color:var(--text-muted);">united-humanity.us ¬∑ Verified + Accord</div>
              </div>
              <span style="margin-left:auto;font-size:0.75rem;color:var(--text-muted);" id="server-live-count">0 live</span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Info Tab -->
  <!-- NOTE: Add /info to the nginx hub route regex, e.g. location ~ ^/(board|reality|fantasy|streams|info|debug) -->
  <div id="tab-info" class="tab-content" style="padding:1.5rem;">
    <style>
      #tab-info .info-section { margin-bottom:1.5rem; }
      #tab-info .info-section h2 { font-size:1.1rem; color:var(--accent); margin-bottom:0.8rem; border-bottom:1px solid var(--border); padding-bottom:0.4rem; cursor:pointer; user-select:none; }
      #tab-info .info-section h2::after { content:' ‚ñæ'; font-size:0.7rem; opacity:0.5; }
      #tab-info .info-section.collapsed h2::after { content:' ‚ñ∏'; }
      #tab-info .info-section.collapsed .info-body { display:none; }
      #tab-info .role-card { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:10px; padding:1rem; margin-bottom:0.75rem; }
      #tab-info .role-card h3 { margin:0 0 0.4rem; font-size:0.95rem; }
      #tab-info .role-card .perms { font-size:0.8rem; color:var(--text-muted); line-height:1.6; }
      #tab-info .role-card .perms .yes { color:#4a8; }
      #tab-info .role-card .perms .no { color:#e55; }
      #tab-info .cmd-group { margin-bottom:1rem; }
      #tab-info .cmd-group h4 { font-size:0.85rem; color:var(--text); margin:0.6rem 0 0.3rem; }
      #tab-info .cmd-row { font-size:0.8rem; color:var(--text-muted); padding:0.15rem 0; }
      #tab-info .cmd-row code { background:rgba(255,255,255,0.06); padding:0.1rem 0.4rem; border-radius:3px; color:var(--accent); font-size:0.78rem; }
      #tab-info .stat-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:0.8rem; }
      #tab-info .stat-card { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:8px; padding:0.8rem; text-align:center; }
      #tab-info .stat-card .stat-val { font-size:1.4rem; font-weight:700; color:var(--accent); }
      #tab-info .stat-card .stat-label { font-size:0.7rem; color:var(--text-muted); margin-top:0.2rem; }
    </style>

    <!-- Server Info -->
    <div class="info-section" id="info-server">
      <h2>üñ•Ô∏è Server Info</h2>
      <div class="info-body">
        <div class="stat-grid" id="info-stats">
          <div class="stat-card"><div class="stat-val" id="info-online">‚Äî</div><div class="stat-label">Online</div></div>
          <div class="stat-card"><div class="stat-val" id="info-registered">‚Äî</div><div class="stat-label">Registered</div></div>
          <div class="stat-card"><div class="stat-val" id="info-uptime">‚Äî</div><div class="stat-label">Uptime</div></div>
          <div class="stat-card"><div class="stat-val" id="info-version">‚Äî</div><div class="stat-label">Version</div></div>
        </div>
      </div>
    </div>

    <!-- Roles & Permissions -->
    <div class="info-section">
      <h2>üõ°Ô∏è Roles & Permissions</h2>
      <div class="info-body">
        <div class="role-card">
          <h3>üë§ Unverified</h3>
          <div class="perms">
            <span class="yes">‚úì</span> Chat (rate limited) ¬∑ Voice ¬∑ View channels<br>
            <span class="no">‚úó</span> Upload files ¬∑ DM ¬∑ Create channels ¬∑ Follow/unfollow
          </div>
        </div>
        <div class="role-card">
          <h3>‚ú¶ Verified</h3>
          <div class="perms">
            <span class="yes">‚úì</span> All above + Upload files ¬∑ DM friends ¬∑ Follow/unfollow
          </div>
        </div>
        <div class="role-card">
          <h3>üíé Donor</h3>
          <div class="perms">
            <span class="yes">‚úì</span> Same as Verified + üíé badge ¬∑ Priority support
          </div>
        </div>
        <div class="role-card">
          <h3>üõ°Ô∏è Moderator</h3>
          <div class="perms">
            <span class="yes">‚úì</span> All above + DM anyone ¬∑ Kick/mute/ban ¬∑ Create/edit channels ¬∑ Manage reports
          </div>
        </div>
        <div class="role-card">
          <h3>üëë Admin</h3>
          <div class="perms">
            <span class="yes">‚úì</span> All above + Verify/unverify ¬∑ Promote/demote ¬∑ Lockdown ¬∑ Wipe ¬∑ Server config
          </div>
        </div>
      </div>
    </div>

    <!-- Social System -->
    <div class="info-section">
      <h2>ü§ù Social System</h2>
      <div class="info-body">
        <div class="role-card">
          <h3>üëÅÔ∏è Follow</h3>
          <div class="perms">One-way ‚Äî shows you care. Use <code>/follow &lt;name&gt;</code>. Right-click a user for quick follow.</div>
        </div>
        <div class="role-card">
          <h3>ü§ù Friends (Mutual Follow)</h3>
          <div class="perms">When both users follow each other, they become friends. This unlocks DMs and shows the ü§ù badge.</div>
        </div>
        <div class="role-card">
          <h3>üö´ Block</h3>
          <div class="perms">Client-side ‚Äî hides their messages from your view. Use <code>/block &lt;name&gt;</code>.</div>
        </div>
      </div>
    </div>

    <!-- Rate Limits -->
    <div class="info-section">
      <h2>‚è±Ô∏è Rate Limits</h2>
      <div class="info-body">
        <div class="role-card">
          <div class="perms">
            <strong>Messages:</strong> Fibonacci rate limiting (1,1,2,3,5,8‚Ä¶ second delays on rapid posting)<br>
            <strong>New accounts:</strong> 5s minimum delay for first 10 minutes<br>
            <strong>Uploads:</strong> 2/minute, 4 image max per user (FIFO ‚Äî oldest replaced)<br>
            <strong>API:</strong> 10 req/s general, 5 req/s for read endpoints
          </div>
        </div>
      </div>
    </div>

    <!-- Commands Reference -->
    <div class="info-section">
      <h2>üìú Commands Reference</h2>
      <div class="info-body">
        <div class="cmd-group">
          <h4>üë• Social</h4>
          <div class="cmd-row"><code>/follow &lt;name&gt;</code> ‚Äî Follow a user</div>
          <div class="cmd-row"><code>/unfollow &lt;name&gt;</code> ‚Äî Unfollow a user</div>
          <div class="cmd-row"><code>/block &lt;name&gt;</code> ‚Äî Block a user</div>
          <div class="cmd-row"><code>/unblock &lt;name&gt;</code> ‚Äî Unblock a user</div>
          <div class="cmd-row"><code>/blocklist</code> ‚Äî Show blocked users</div>
        </div>
        <div class="cmd-group">
          <h4>üí¨ DMs & Groups</h4>
          <div class="cmd-row"><code>/dm &lt;name&gt; &lt;msg&gt;</code> ‚Äî Send a direct message</div>
          <div class="cmd-row"><code>/dms</code> ‚Äî List DM conversations</div>
          <div class="cmd-row"><code>/group-create &lt;name&gt;</code> ‚Äî Create a group chat</div>
          <div class="cmd-row"><code>/group-join &lt;code&gt;</code> ‚Äî Join group by invite code</div>
          <div class="cmd-row"><code>/group-invite</code> ‚Äî Copy current group's invite code</div>
          <div class="cmd-row"><code>/group-leave</code> ‚Äî Leave current group</div>
        </div>
        <div class="cmd-group">
          <h4>‚úèÔ∏è Profile</h4>
          <div class="cmd-row"><code>/bio &lt;text&gt;</code> ‚Äî Set your bio</div>
          <div class="cmd-row"><code>/social &lt;platform&gt; &lt;handle&gt;</code> ‚Äî Set social link</div>
          <div class="cmd-row"><code>/profile</code> ‚Äî Edit profile</div>
          <div class="cmd-row"><code>/name &lt;name&gt;</code> ‚Äî Change display name</div>
        </div>
        <div class="cmd-group">
          <h4>üìå Pins</h4>
          <div class="cmd-row"><code>/pin</code> ‚Äî Pin the last message (mod/admin)</div>
          <div class="cmd-row"><code>/unpin &lt;N&gt;</code> ‚Äî Unpin by index (mod/admin)</div>
          <div class="cmd-row"><code>/mypin</code> ‚Äî Pin your last message (for yourself)</div>
          <div class="cmd-row"><code>/unmypin &lt;N&gt;</code> ‚Äî Unpin your pin by index</div>
          <div class="cmd-row"><code>/pins</code> ‚Äî View pins</div>
        </div>
        <div class="cmd-group">
          <h4>üìû Voice</h4>
          <div class="cmd-row"><code>/call</code> ‚Äî Start a voice call (or use üìû button)</div>
        </div>
        <div class="cmd-group">
          <h4>üõ°Ô∏è Moderation</h4>
          <div class="cmd-row"><code>/kick &lt;name&gt;</code> ‚Äî Disconnect a user</div>
          <div class="cmd-row"><code>/mute &lt;name&gt;</code> ‚Äî Mute a user</div>
          <div class="cmd-row"><code>/ban &lt;name&gt;</code> ‚Äî Ban a user</div>
          <div class="cmd-row"><code>/report &lt;name&gt; [reason]</code> ‚Äî Report a user</div>
        </div>
        <div class="cmd-group">
          <h4>üëë Admin</h4>
          <div class="cmd-row"><code>/verify &lt;name&gt;</code> ‚Äî Verify a user</div>
          <div class="cmd-row"><code>/unverify &lt;name&gt;</code> ‚Äî Remove verified</div>
          <div class="cmd-row"><code>/mod &lt;name&gt;</code> ‚Äî Promote to moderator</div>
          <div class="cmd-row"><code>/unmod &lt;name&gt;</code> ‚Äî Remove moderator</div>
          <div class="cmd-row"><code>/donor &lt;name&gt;</code> ‚Äî Set donor role</div>
          <div class="cmd-row"><code>/lockdown</code> ‚Äî Toggle registration lock</div>
          <div class="cmd-row"><code>/channel-create &lt;name&gt; [desc]</code> ‚Äî Create channel</div>
          <div class="cmd-row"><code>/channel-delete &lt;name&gt;</code> ‚Äî Delete channel</div>
          <div class="cmd-row"><code>/wipe</code> ‚Äî Delete all chat history</div>
        </div>
        <div class="cmd-group">
          <h4>üîß Utility</h4>
          <div class="cmd-row"><code>/help</code> ‚Äî Show help</div>
          <div class="cmd-row"><code>/export</code> ‚Äî Download identity backup</div>
          <div class="cmd-row"><code>/link</code> ‚Äî Link another device</div>
          <div class="cmd-row"><code>/revoke &lt;key&gt;</code> ‚Äî Remove a device</div>
          <div class="cmd-row"><code>/users</code> ‚Äî List all users</div>
        </div>
      </div>
    </div>

    <script>
    // Collapsible sections
    document.querySelectorAll('#tab-info .info-section h2').forEach(h2 => {
      h2.addEventListener('click', () => {
        h2.parentElement.classList.toggle('collapsed');
      });
    });
    // Fetch server stats
    (async function loadInfoStats() {
      try {
        const [statsRes, infoRes] = await Promise.all([
          fetch('/api/stats').then(r => r.ok ? r.json() : null).catch(() => null),
          fetch('/api/server-info').then(r => r.ok ? r.json() : null).catch(() => null)
        ]);
        if (statsRes) {
          if (statsRes.online !== undefined) document.getElementById('info-online').textContent = statsRes.online;
          if (statsRes.registered !== undefined) document.getElementById('info-registered').textContent = statsRes.registered;
          if (statsRes.uptime) {
            const s = statsRes.uptime;
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            document.getElementById('info-uptime').textContent = h + 'h ' + m + 'm';
          }
        }
        if (infoRes) {
          if (infoRes.version) document.getElementById('info-version').textContent = infoRes.version;
          else if (infoRes.name) document.getElementById('info-version').textContent = infoRes.name;
        }
      } catch(e) { console.warn('Info stats fetch failed:', e); }
    })();
    </script>
  </div>

  <!-- Source Tab ‚Äî NOTE: add /source to nginx hub regex for routing -->
  <div id="tab-source" class="tab-content" style="padding:1.5rem;">
    <style>
      #tab-source .info-section { margin-bottom:1.5rem; }
      #tab-source .info-section h2 { font-size:1.1rem; color:var(--accent); margin-bottom:0.8rem; border-bottom:1px solid var(--border); padding-bottom:0.4rem; cursor:pointer; user-select:none; }
      #tab-source .info-section h2::after { content:' ‚ñæ'; font-size:0.7rem; opacity:0.5; }
      #tab-source .info-section.collapsed h2::after { content:' ‚ñ∏'; }
      #tab-source .info-section.collapsed .info-body { display:none; }
      #tab-source .src-card { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:10px; padding:1.2rem; margin-bottom:0.75rem; }
      #tab-source .src-card p { font-size:0.85rem; color:var(--text-muted); line-height:1.6; margin:0.4rem 0; }
      #tab-source .src-card ul { list-style:none; padding:0; margin:0.5rem 0; }
      #tab-source .src-card li { font-size:0.85rem; color:var(--text-muted); padding:0.25rem 0; line-height:1.5; }
      #tab-source .src-card li::before { margin-right:0.4rem; }
      #tab-source .big-statement { font-size:1.2rem; color:var(--text); font-weight:700; text-align:center; margin:1rem 0; }
      #tab-source .sub-statement { font-size:0.9rem; color:var(--text-muted); text-align:center; margin-bottom:1rem; line-height:1.6; }
      #tab-source .btn-row { display:flex; gap:0.8rem; flex-wrap:wrap; justify-content:center; margin:1rem 0; }
      #tab-source .src-btn { display:inline-flex; align-items:center; gap:0.5rem; padding:0.7rem 1.4rem; border-radius:8px; font-size:0.9rem; font-weight:600; text-decoration:none; color:#fff; transition:opacity 0.15s; }
      #tab-source .src-btn:hover { opacity:0.85; }
      #tab-source .src-btn.gh { background:#333; }
      #tab-source .src-btn.donate { background:var(--accent,#e07020); }
      #tab-source .arch-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:0.8rem; margin:0.8rem 0; }
      #tab-source .arch-box { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:8px; padding:0.8rem; }
      #tab-source .arch-box h4 { font-size:0.85rem; color:var(--accent); margin:0 0 0.3rem; }
      #tab-source .arch-box p { font-size:0.78rem; margin:0; }
      #tab-source .tech-tags { display:flex; flex-wrap:wrap; gap:0.4rem; margin:0.6rem 0; }
      #tab-source .tech-tag { background:rgba(255,255,255,0.06); border:1px solid var(--border); border-radius:4px; padding:0.2rem 0.6rem; font-size:0.75rem; color:var(--text-muted); }
      #tab-source .stat-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:0.8rem; margin:0.8rem 0; }
      #tab-source .stat-card { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:8px; padding:0.8rem; text-align:center; }
      #tab-source .stat-card .stat-val { font-size:1.4rem; font-weight:700; color:var(--accent); }
      #tab-source .stat-card .stat-label { font-size:0.7rem; color:var(--text-muted); margin-top:0.2rem; }
    </style>

    <!-- Open Source -->
    <div class="info-section">
      <h2>üîì Open Source</h2>
      <div class="info-body">
        <div class="src-card">
          <div class="big-statement">Humanity is 100% open source and public domain (CC0-1.0)</div>
          <div class="sub-statement">Anyone can use, modify, and distribute this code for any purpose.<br>No permission needed. No strings attached.</div>
          <div class="btn-row">
            <a href="https://github.com/Shaostoul/Humanity" target="_blank" class="src-btn gh">‚≠ê GitHub ‚Äî Shaostoul/Humanity</a>
            <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank" class="src-btn" style="background:#555;">üìÑ CC0 1.0 License</a>
          </div>
        </div>
      </div>
    </div>

    <!-- The Accord -->
    <div class="info-section">
      <h2>üìú The Accord</h2>
      <div class="info-body">
        <div class="src-card">
          <div class="big-statement" style="font-size:1rem;">Wholesomely aiding humanity's betterment</div>
          <ul>
            <li>üîí <strong>Privacy first</strong> ‚Äî No tracking, no accounts. Your identity is your keys.</li>
            <li>üó£Ô∏è <strong>Free speech</strong> ‚Äî No censorship. Line drawn at genuine threats and predatory harassment.</li>
            <li>üîû <strong>18+ community</strong> ‚Äî Mature, responsible communication.</li>
            <li>üíõ <strong>Unconditional love</strong> ‚Äî For all life.</li>
            <li>‚ú® <strong>The 7 heavenly virtues</strong> ‚Äî Chastity, temperance, charity, diligence, patience, kindness, humility.</li>
          </ul>
          <div class="btn-row">
            <a href="https://shaostoul.github.io/Humanity" target="_blank" class="src-btn" style="background:#555;">üìñ Read the Full Accord</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Architecture -->
    <div class="info-section">
      <h2>üèóÔ∏è Architecture</h2>
      <div class="info-body">
        <div class="src-card">
          <div class="arch-grid">
            <div class="arch-box"><h4>üîë Identity</h4><p>Ed25519 key pairs stored in your browser ‚Äî no accounts, no passwords</p></div>
            <div class="arch-box"><h4>üîè Encryption</h4><p>Messages signed cryptographically ‚Äî tamper-proof</p></div>
            <div class="arch-box"><h4>üì° Communication</h4><p>WebSocket relay for group chat, WebRTC P2P for voice/video</p></div>
            <div class="arch-box"><h4>üíæ Storage</h4><p>SQLite on server, localStorage + IndexedDB on client</p></div>
            <div class="arch-box"><h4>üåê Federation</h4><p>Servers can link together ‚Äî your identity works everywhere</p></div>
          </div>
          <p style="font-size:0.85rem;color:var(--text-muted);margin-top:0.8rem;"><strong>Tech stack:</strong></p>
          <div class="tech-tags">
            <span class="tech-tag">Rust</span><span class="tech-tag">Axum</span><span class="tech-tag">Tokio</span>
            <span class="tech-tag">SQLite</span><span class="tech-tag">Ed25519</span><span class="tech-tag">BLAKE3</span>
            <span class="tech-tag">WebRTC</span><span class="tech-tag">Vanilla JS</span>
          </div>
          <p style="font-size:0.82rem;color:var(--text-muted);margin-top:0.6rem;"><strong>Future:</strong> CBOR signed objects, P2P direct messaging, peer-assisted streaming</p>
        </div>
      </div>
    </div>

    <!-- Contributing -->
    <div class="info-section">
      <h2>ü§ù Contributing</h2>
      <div class="info-body">
        <div class="src-card">
          <p style="font-size:0.95rem;color:var(--text);font-weight:600;">Everyone can help, not just programmers</p>
          <ul>
            <li>üêõ <strong>Report bugs</strong> ‚Äî Use <code style="background:rgba(255,255,255,0.06);padding:0.1rem 0.4rem;border-radius:3px;color:var(--accent);">/report</code> in chat or <a href="https://github.com/Shaostoul/Humanity/issues" target="_blank" style="color:var(--accent);">GitHub Issues</a></li>
            <li>üí° <strong>Suggest features</strong> ‚Äî Chat in #dev or <a href="https://github.com/Shaostoul/Humanity/discussions" target="_blank" style="color:var(--accent);">GitHub Discussions</a></li>
            <li>üîß <strong>Write code</strong> ‚Äî Fork, hack, PR ‚Äî it's CC0, go wild</li>
            <li>üìñ <strong>Improve docs</strong> ‚Äî Website at <a href="https://shaostoul.github.io/Humanity" target="_blank" style="color:var(--accent);">shaostoul.github.io/Humanity</a></li>
            <li>üß™ <strong>Test features</strong> ‚Äî Just use the app and tell us what breaks</li>
            <li>üí∞ <strong>Donate</strong> ‚Äî Support development directly</li>
          </ul>
          <div class="btn-row">
            <a href="https://github.com/sponsors/Shaostoul" target="_blank" class="src-btn donate">‚ù§Ô∏è GitHub Sponsors</a>
            <a href="https://ko-fi.com/shaostoul" target="_blank" class="src-btn donate">‚òï Ko-fi</a>
          </div>
          <p style="font-size:0.82rem;color:var(--text-muted);margin-top:0.8rem;"><strong>Self-hosting:</strong> <code style="background:rgba(255,255,255,0.06);padding:0.1rem 0.4rem;border-radius:3px;font-size:0.78rem;color:var(--text-muted);">git clone ‚Üí install Rust ‚Üí cargo build --release ‚Üí ./target/release/humanity-relay</code></p>
          <p style="font-size:0.78rem;"><a href="https://github.com/Shaostoul/Humanity#readme" target="_blank" style="color:var(--accent);">Full build instructions on GitHub README ‚Üí</a></p>
        </div>
      </div>
    </div>

    <!-- Project Stats -->
    <div class="info-section" id="source-stats-section">
      <h2>üìä Project Stats</h2>
      <div class="info-body">
        <div class="stat-grid">
          <div class="stat-card"><div class="stat-val" id="src-online">‚Äî</div><div class="stat-label">Online Now</div></div>
          <div class="stat-card"><div class="stat-val" id="src-registered">‚Äî</div><div class="stat-label">Registered</div></div>
          <div class="stat-card"><div class="stat-val" id="src-version">‚Äî</div><div class="stat-label">Version</div></div>
          <div class="stat-card"><div class="stat-val" id="src-uptime">‚Äî</div><div class="stat-label">Uptime</div></div>
          <div class="stat-card"><div class="stat-val">Rust</div><div class="stat-label">Language</div></div>
          <div class="stat-card"><div class="stat-val">CC0-1.0</div><div class="stat-label">License</div></div>
          <div class="stat-card"><div class="stat-val">Jan 2019</div><div class="stat-label">Started</div></div>
        </div>
        <div class="btn-row" style="margin-top:1rem;">
          <a href="https://github.com/Shaostoul/Humanity/commits" target="_blank" class="src-btn gh">üìà Commit History on GitHub</a>
        </div>
      </div>
    </div>

    <script>
    // Collapsible sections
    document.querySelectorAll('#tab-source .info-section h2').forEach(h2 => {
      h2.addEventListener('click', () => h2.parentElement.classList.toggle('collapsed'));
    });
    // Fetch stats
    (async function loadSourceStats() {
      try {
        const [statsRes, infoRes] = await Promise.all([
          fetch('/api/stats').then(r => r.ok ? r.json() : null).catch(() => null),
          fetch('/api/server-info').then(r => r.ok ? r.json() : null).catch(() => null)
        ]);
        if (statsRes) {
          if (statsRes.online !== undefined) document.getElementById('src-online').textContent = statsRes.online;
          if (statsRes.registered !== undefined) document.getElementById('src-registered').textContent = statsRes.registered;
          if (statsRes.uptime) {
            const s = statsRes.uptime;
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            document.getElementById('src-uptime').textContent = h + 'h ' + m + 'm';
          }
        }
        if (infoRes && infoRes.version) document.getElementById('src-version').textContent = infoRes.version;
      } catch(e) { console.warn('Source stats fetch failed:', e); }
    })();
    </script>
  </div>

  <!-- Debug Tab -->
  <div id="tab-debug" class="tab-content">
    <div class="panel">
      <h2>üîß System Information</h2>
      <p>Version, connection status, and system diagnostics.</p>
      <dl class="debug-info">
        <dt>Client Version</dt>
        <dd id="debug-version">‚Äî</dd>
        <dt>Server</dt>
        <dd id="debug-server">‚Äî</dd>
        <dt>Connection</dt>
        <dd id="debug-connection">Checking‚Ä¶</dd>
        <dt>User Agent</dt>
        <dd id="debug-ua">‚Äî</dd>
        <dt>Screen</dt>
        <dd id="debug-screen">‚Äî</dd>
        <dt>Page Loaded</dt>
        <dd id="debug-loaded">‚Äî</dd>
      </dl>
    </div>

    <div class="panel">
      <h2>üé® Button Design System</h2>
      <p>Interactive preview of all button states. These are the standard interaction patterns for the entire game UI.</p>

      <h3>All States (static preview)</h3>
      <div class="btn-grid">
        <div class="btn-demo">
          <button class="btn btn-clickable">Clickable</button>
          <span class="btn-label">Default ¬∑ 1px green</span>
        </div>
        <div class="btn-demo">
          <button class="btn btn-channeling">Channeling</button>
          <span class="btn-label">Active/looping ¬∑ 1px rainbow</span>
        </div>
        <div class="btn-demo">
          <button class="btn btn-activated">Activated</button>
          <span class="btn-label">Pressed ¬∑ 5px red</span>
        </div>
        <div class="btn-demo">
          <button class="btn btn-disabled">Disabled</button>
          <span class="btn-label">Unclickable ¬∑ 2px black</span>
        </div>
        <div class="btn-demo">
          <button class="btn btn-cooldown">
            Cooldown
            <span class="btn-cooldown-timer top">3.2s</span>
            <span class="btn-cooldown-timer bottom">3.2s</span>
          </button>
          <span class="btn-label">Waiting ¬∑ 7px purple + timer</span>
        </div>
      </div>

      <h3>Interactive Test ‚Äî Hover &amp; Click</h3>
      <p>Hover to see the blue border. Click and hold to see the red activated state.</p>
      <div class="btn-grid">
        <button class="btn" onclick="testBtnClick(this)">Hover / Click Me</button>
        <button class="btn" onclick="testBtnClick(this)">Another Button</button>
        <button class="btn" onclick="testBtnClick(this)">And Another</button>
      </div>

      <h3>Toggle Test ‚Äî Click to Cycle States</h3>
      <p>Click to cycle: clickable ‚Üí channeling ‚Üí activated ‚Üí cooldown ‚Üí clickable</p>
      <div class="btn-grid">
        <button class="btn btn-clickable" onclick="cycleState(this)">Cycle Me</button>
        <button class="btn btn-clickable" onclick="cycleState(this)">Cycle Me Too</button>
        <button class="btn btn-clickable" onclick="cycleState(this)">And Me</button>
      </div>

      <h3>Cooldown Test ‚Äî Click to Start Cooldown</h3>
      <div class="btn-grid">
        <button class="btn btn-clickable" onclick="startCooldown(this, 5)">5s Cooldown</button>
        <button class="btn btn-clickable" onclick="startCooldown(this, 10)">10s Cooldown</button>
        <button class="btn btn-clickable" onclick="startCooldown(this, 3)">3s Cooldown</button>
      </div>

      <h3>Channeling Test ‚Äî Click to Start/Stop</h3>
      <div class="btn-grid">
        <button class="btn btn-clickable" onclick="toggleChannel(this)">Channel Me</button>
        <button class="btn btn-clickable" onclick="toggleChannel(this)">Channel This</button>
      </div>
    </div>

    <div class="panel">
      <h2>üé® Color Reference</h2>
      <p>The visual language for button borders:</p>
      <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.8rem; margin-top: 0.5rem;">
        <div style="padding:0.5rem;border-left:3px solid #44cc66;background:rgba(68,204,102,0.05);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#44cc66;">Green 1px</strong> ‚Äî Clickable / ready
        </div>
        <div style="padding:0.5rem;border-left:3px solid #4488ff;background:rgba(68,136,255,0.05);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#4488ff;">Blue 3px</strong> ‚Äî Hovered / focused
        </div>
        <div style="padding:0.5rem;border-left:3px solid #ee3333;background:rgba(238,51,51,0.05);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#ee3333;">Red 5px</strong> ‚Äî Activated / pressed
        </div>
        <div style="padding:0.5rem;border-left:3px solid #222;background:rgba(0,0,0,0.1);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#666;">Black 2px</strong> ‚Äî Disabled / locked
        </div>
        <div style="padding:0.5rem;border-left:3px solid #8844cc;background:rgba(136,68,204,0.05);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#8844cc;">Purple 7px</strong> ‚Äî Cooldown + timer
        </div>
        <div style="padding:0.5rem;border-left:3px solid;border-image:linear-gradient(90deg,#f00,#ff0,#0f0,#0ff,#00f,#f0f,#f00) 1;background:rgba(255,255,255,0.03);border-radius:0 4px 4px 0;font-size:0.8rem;">
          <strong style="background:linear-gradient(90deg,#f00,#ff0,#0f0,#0ff,#00f,#f0f);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Rainbow 1px</strong> ‚Äî Channeling / active
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- Market Tab -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="tab-market" class="tab-content" style="padding:1rem;overflow-y:auto;">
    <!-- Sub-navigation -->
    <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap;align-items:center;">
      <button class="btn btn-clickable" onclick="showMarketSection('marketplace')" id="market-nav-marketplace" style="min-width:auto;min-height:32px;padding:0.25rem 0.7rem;font-size:0.8rem;">üè™ Marketplace</button>
      <button class="btn" onclick="showMarketSection('stores')" id="market-nav-stores" style="min-width:auto;min-height:32px;padding:0.25rem 0.7rem;font-size:0.8rem;">üè¨ Stores</button>
      <button class="btn" onclick="showMarketSection('mylistings')" id="market-nav-mylistings" style="min-width:auto;min-height:32px;padding:0.25rem 0.7rem;font-size:0.8rem;">üìã My Listings</button>
      <span style="flex:1;"></span>
      <button class="btn btn-clickable" onclick="openListingModal()" id="market-create-btn" style="min-width:auto;min-height:32px;padding:0.25rem 0.7rem;font-size:0.8rem;display:none;">+ Create Listing</button>
    </div>

    <!-- Marketplace Section -->
    <div id="market-section-marketplace">
      <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1rem;align-items:center;position:sticky;top:0;z-index:10;background:var(--bg);padding:0.5rem 0;">
        <input type="text" id="market-search" placeholder="üîç Search listings‚Ä¶" oninput="renderMarketListings()" style="flex:1;min-width:150px;padding:0.4rem 0.6rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.8rem;">
        <select id="market-category-filter" onchange="renderMarketListings()" style="padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.8rem;">
          <option value="">All Categories</option>
          <option>Electronics</option><option>Vehicles</option><option>Clothing</option><option>Tools</option>
          <option>Furniture</option><option>Home</option><option>Books/Media</option><option>Gaming</option>
          <option>Sports</option><option>Crafts</option><option>Food/Garden</option><option>Services</option><option>Other</option>
        </select>
        <select id="market-condition-filter" onchange="renderMarketListings()" style="padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.8rem;">
          <option value="">Any Condition</option>
          <option>New</option><option>Like New</option><option>Good</option><option>Fair</option><option>Poor</option><option>N/A</option>
        </select>
        <select id="market-sort" onchange="renderMarketListings()" style="padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.8rem;">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
          <option value="alpha">A-Z</option>
        </select>
      </div>
      <div id="market-listings-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;"></div>
      <div id="market-listings-empty" style="text-align:center;color:var(--text-muted);font-style:italic;padding:3rem 1rem;display:none;">No listings yet. Be the first to list something!</div>
    </div>

    <!-- Store Directory Section -->
    <div id="market-section-stores" style="display:none;">
      <div style="margin-bottom:1rem;">
        <select id="store-category-filter" onchange="renderStoreDirectory()" style="padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.8rem;">
          <option value="">All Categories</option>
        </select>
      </div>
      <div id="store-directory-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem;"></div>
    </div>

    <!-- My Listings Section -->
    <div id="market-section-mylistings" style="display:none;">
      <div id="my-listings-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;"></div>
      <div id="my-listings-empty" style="text-align:center;color:var(--text-muted);font-style:italic;padding:3rem 1rem;display:none;">You haven't listed anything yet.</div>
    </div>

    <!-- Listing Detail Modal -->
    <div id="listing-detail-modal" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);overflow-y:auto;" onclick="if(event.target===this)closeListingDetail()">
      <div style="max-width:600px;margin:3rem auto;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;">
        <div id="listing-detail-content"></div>
      </div>
    </div>

    <!-- Create/Edit Listing Modal -->
    <div id="listing-modal" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);overflow-y:auto;" onclick="if(event.target===this)closeListingModal()">
      <div style="max-width:500px;margin:3rem auto;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;">
        <h2 style="color:var(--accent);margin-bottom:1rem;font-size:1rem;" id="listing-modal-title">Create Listing</h2>
        <input type="hidden" id="listing-edit-id" value="">
        <div style="display:flex;flex-direction:column;gap:0.6rem;">
          <div>
            <label style="font-size:0.75rem;color:var(--text-muted);">Title *</label>
            <input type="text" id="listing-title" maxlength="100" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
          </div>
          <div>
            <label style="font-size:0.75rem;color:var(--text-muted);">Description</label>
            <textarea id="listing-description" rows="3" maxlength="2000" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;resize:vertical;"></textarea>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
            <div>
              <label style="font-size:0.75rem;color:var(--text-muted);">Category *</label>
              <select id="listing-category" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
                <option>Electronics</option><option>Vehicles</option><option>Clothing</option><option>Tools</option>
                <option>Furniture</option><option>Home</option><option>Books/Media</option><option>Gaming</option>
                <option>Sports</option><option>Crafts</option><option>Food/Garden</option><option>Services</option><option>Other</option>
              </select>
            </div>
            <div>
              <label style="font-size:0.75rem;color:var(--text-muted);">Condition</label>
              <select id="listing-condition" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
                <option>New</option><option>Like New</option><option>Good</option><option>Fair</option><option>Poor</option><option>N/A</option>
              </select>
            </div>
          </div>
          <div>
            <label style="font-size:0.75rem;color:var(--text-muted);">Price</label>
            <input type="text" id="listing-price" placeholder='$50, Trade, Free, Best offer‚Ä¶' maxlength="50" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
          </div>
          <div>
            <label style="font-size:0.75rem;color:var(--text-muted);">Payment Methods</label>
            <input type="text" id="listing-payment" placeholder='Venmo, Cash, Crypto, Trade‚Ä¶' maxlength="100" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
          </div>
          <div>
            <label style="font-size:0.75rem;color:var(--text-muted);">Location</label>
            <input type="text" id="listing-location" placeholder='Seattle area, Ships worldwide‚Ä¶' maxlength="100" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
          </div>
          <div style="display:flex;gap:0.5rem;justify-content:flex-end;margin-top:0.5rem;">
            <button class="btn" onclick="closeListingModal()" style="min-width:80px;min-height:36px;padding:0.3rem 0.8rem;font-size:0.8rem;">Cancel</button>
            <button class="btn btn-clickable" onclick="submitListing()" style="min-width:80px;min-height:36px;padding:0.3rem 0.8rem;font-size:0.8rem;">Submit</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Browse Tab -->
  <div id="tab-browse" class="tab-content" style="display:flex;flex-direction:column;height:100%;overflow:hidden;">
    <div id="browse-quickbar" style="display:flex;gap:0.5rem;padding:0.5rem 1rem;border-bottom:1px solid var(--border);overflow-x:auto;flex-shrink:0;align-items:center;">
      <span style="font-size:0.75rem;color:var(--text-muted);white-space:nowrap;">‚ö° Quick:</span>
      <div id="quickbar-sites" style="display:flex;gap:0.4rem;"></div>
    </div>
    <div style="display:flex;flex:1;min-height:0;">
      <div id="browse-directory" style="width:350px;min-width:280px;border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;">
        <div style="padding:0.5rem;border-bottom:1px solid var(--border);display:flex;gap:0.4rem;">
          <input type="text" id="browse-search" placeholder="Search sites..." oninput="filterBrowseSites()" style="flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.3rem 0.6rem;border-radius:6px;font-size:0.8rem;">
          <button onclick="showAddSiteModal()" style="background:var(--accent);border:none;border-radius:6px;color:#fff;padding:0.3rem 0.6rem;cursor:pointer;font-size:0.8rem;" title="Add site">+</button>
        </div>
        <div id="browse-categories" style="padding:0.4rem 0.5rem;display:flex;flex-wrap:wrap;gap:0.3rem;border-bottom:1px solid var(--border);"></div>
        <div id="browse-collections" style="padding:0.4rem 0.5rem;border-bottom:1px solid var(--border);max-height:120px;overflow-y:auto;"></div>
        <div id="browse-sort" style="padding:0.3rem 0.5rem;display:flex;gap:0.3rem;border-bottom:1px solid var(--border);align-items:center;">
          <span style="font-size:0.7rem;color:var(--text-muted);">Sort:</span>
          <span class="filter-pill active" onclick="setBrowseSort('popular')" id="sort-popular" style="font-size:0.68rem;padding:0.1rem 0.4rem;cursor:pointer;">üî• Popular</span>
          <span class="filter-pill" onclick="setBrowseSort('used')" id="sort-used" style="font-size:0.68rem;padding:0.1rem 0.4rem;cursor:pointer;">‚≠ê Most Used</span>
          <span class="filter-pill" onclick="setBrowseSort('recent')" id="sort-recent" style="font-size:0.68rem;padding:0.1rem 0.4rem;cursor:pointer;">üïê Recent</span>
          <span class="filter-pill" onclick="setBrowseSort('az')" id="sort-az" style="font-size:0.68rem;padding:0.1rem 0.4rem;cursor:pointer;">üî§ A-Z</span>
        </div>
        <div id="browse-sites" style="flex:1;overflow-y:auto;padding:0.4rem;"></div>
      </div>
      <div id="browse-panel" style="flex:1;display:flex;flex-direction:column;">
        <div id="browse-toolbar" style="display:flex;gap:0.4rem;padding:0.4rem 0.6rem;border-bottom:1px solid var(--border);align-items:center;">
          <button onclick="browsePanelBack()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1rem;" title="Back to directory">‚Üê</button>
          <input type="text" id="browse-url-bar" placeholder="Enter URL..." onkeydown="if(event.key==='Enter')browseNavigate(this.value)" style="flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.3rem 0.6rem;border-radius:6px;font-size:0.8rem;">
          <button onclick="browseNavigate(document.getElementById('browse-url-bar').value)" style="background:var(--accent);border:none;border-radius:6px;color:#fff;padding:0.3rem 0.6rem;cursor:pointer;font-size:0.8rem;">Go</button>
          <button onclick="browseOpenExternal()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.9rem;" title="Open in new tab">‚Üó</button>
        </div>
        <div id="browse-placeholder" style="flex:1;display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:0.9rem;">
          Select a site or enter a URL to browse
        </div>
        <iframe id="browse-iframe" style="flex:1;border:none;display:none;" sandbox="allow-scripts allow-same-origin allow-forms allow-popups" referrerpolicy="no-referrer"></iframe>
      </div>
    </div>
  </div>

  <!-- Dashboard Tab -->
  <div id="tab-dashboard" class="tab-content" style="padding:1rem;overflow-y:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
      <h2 style="color:var(--accent);margin:0;font-size:1.1rem;">üìä Dashboard</h2>
      <button onclick="showAddWidgetModal()" class="btn btn-clickable" style="min-width:auto;min-height:36px;padding:0.3rem 0.8rem;font-size:0.8rem;">+ Add Widget</button>
    </div>
    <div id="dashboard-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1rem;"></div>
    <div id="dashboard-empty" style="text-align:center;color:var(--text-muted);padding:3rem;">
      <p style="font-size:1.2rem;">Your dashboard is empty</p>
      <p>Click "+ Add Widget" to customize your view</p>
    </div>
  </div>

  <!-- Settings Panel (inline, replaces tab content) -->
  <div id="tab-settings" class="tab-content" style="padding:1.5rem;">
    <div class="panel">
      <h2 id="settings-title">‚öô Settings</h2>
      <div id="settings-body"></div>
    </div>
  </div>

  <script>
    // ‚îÄ‚îÄ Hub Tab System (SPA with pushState) ‚îÄ‚îÄ
    const HUB_TABS = ['board', 'reality', 'fantasy', 'market', 'browse', 'dashboard', 'streams', 'info', 'source', 'debug'];
    let currentTab = 'reality';

    function getTabFromPath() {
      const path = window.location.pathname.replace(/^\//, '').replace(/\/$/, '').toLowerCase();
      if (HUB_TABS.includes(path)) return path;
      return null;
    }

    function switchTab(tabId, pushState) {
      if (!HUB_TABS.includes(tabId)) tabId = 'reality';
      currentTab = tabId;

      // Update nav active state
      document.querySelectorAll('.hub-nav .tab').forEach(el => {
        el.classList.toggle('active', el.dataset.tab === tabId);
      });

      // Show correct content panel
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      const tabEl = document.getElementById('tab-' + tabId);
      if (tabEl) tabEl.classList.add('active');

      // Update page title
      const titles = { board: 'Board', reality: 'Reality', fantasy: 'Fantasy', market: 'Market', browse: 'Browse', dashboard: 'Dashboard', streams: 'Streams', info: 'Info', source: 'Source', debug: 'Debug' };
      document.title = 'Humanity ‚Äî ' + (titles[tabId] || 'Hub');

      // Update URL
      if (pushState !== false) {
        const newPath = '/' + tabId;
        if (window.location.pathname !== newPath) {
          history.pushState({ tab: tabId }, '', newPath);
        }
      }
    }

    // SPA navigation: intercept hub tab clicks
    document.querySelectorAll('.hub-nav .tab[data-tab]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        switchTab(link.dataset.tab);
      });
    });

    // Handle browser back/forward
    window.addEventListener('popstate', (e) => {
      const tab = (e.state && e.state.tab) || getTabFromPath();
      if (tab) switchTab(tab, false);
    });

    // Initialize from URL
    const initialTab = getTabFromPath() || 'reality';
    switchTab(initialTab, false);

    // ‚îÄ‚îÄ Debug Info ‚îÄ‚îÄ
    (function populateDebugInfo() {
      const el = (id) => document.getElementById(id);
      el('debug-version').textContent = '0.1.0-dev';
      el('debug-server').textContent = window.location.origin;
      el('debug-ua').textContent = navigator.userAgent.slice(0, 100);
      el('debug-screen').textContent = screen.width + '√ó' + screen.height + ' ¬∑ ' + (window.devicePixelRatio || 1) + 'x DPR';
      el('debug-loaded').textContent = new Date().toISOString();

      // Check relay connection
      async function checkConnection() {
        try {
          const res = await fetch('/api/stats');
          if (res.ok) {
            const data = await res.json();
            el('debug-connection').textContent = '‚úÖ Connected ‚Äî ' + (data.online_users || 0) + ' users online';
            el('debug-connection').style.color = '#4a8';
            if (data.version) el('debug-version').textContent = data.version;
          } else {
            el('debug-connection').textContent = '‚ö†Ô∏è Server responded ' + res.status;
            el('debug-connection').style.color = '#eb4';
          }
        } catch (e) {
          el('debug-connection').textContent = '‚ùå Cannot reach server';
          el('debug-connection').style.color = '#e55';
        }
      }
      checkConnection();
    })();

    // ‚îÄ‚îÄ Global: Click activates red border for 1s ‚îÄ‚îÄ
    document.addEventListener('click', function(e) {
      const btn = e.target.closest('.btn');
      if (!btn || btn.classList.contains('btn-disabled') || btn.classList.contains('btn-cooldown')) return;
      const wasChanneling = btn.classList.contains('btn-channeling');
      btn.classList.add('btn-activated');
      if (wasChanneling) btn.style.animation = 'none';
      setTimeout(() => {
        btn.classList.remove('btn-activated');
        if (wasChanneling) btn.style.animation = '';
      }, 1000);
    });

    // ‚îÄ‚îÄ Button Test Functions ‚îÄ‚îÄ
    function testBtnClick(btn) {
      btn.textContent = '‚úì Clicked!';
      setTimeout(() => { btn.textContent = 'Hover / Click Me'; }, 800);
    }

    const states = ['btn-clickable', 'btn-channeling', 'btn-activated', 'btn-cooldown', 'btn-disabled'];
    function cycleState(btn) {
      const current = states.find(s => btn.classList.contains(s)) || 'btn-clickable';
      const idx = states.indexOf(current);
      const next = states[(idx + 1) % states.length];
      states.forEach(s => btn.classList.remove(s));
      btn.classList.add(next);
      btn.querySelectorAll('.btn-cooldown-timer').forEach(t => t.remove());
      if (next === 'btn-cooldown') {
        btn.innerHTML = btn.textContent.replace(/[\d.]+s/g, '').trim();
        const topT = document.createElement('span');
        topT.className = 'btn-cooldown-timer top';
        topT.textContent = '‚àû';
        const botT = document.createElement('span');
        botT.className = 'btn-cooldown-timer bottom';
        botT.textContent = '‚àû';
        btn.appendChild(topT);
        btn.appendChild(botT);
      }
    }

    function startCooldown(btn, seconds) {
      if (btn.classList.contains('btn-cooldown')) return;
      const originalText = btn.textContent;
      btn.classList.remove('btn-clickable');
      btn.classList.add('btn-cooldown');

      const topT = document.createElement('span');
      topT.className = 'btn-cooldown-timer top';
      const botT = document.createElement('span');
      botT.className = 'btn-cooldown-timer bottom';
      btn.appendChild(topT);
      btn.appendChild(botT);

      let remaining = seconds;
      const update = () => {
        topT.textContent = remaining.toFixed(1) + 's';
        botT.textContent = remaining.toFixed(1) + 's';
      };
      update();

      const interval = setInterval(() => {
        remaining -= 0.1;
        if (remaining <= 0) {
          clearInterval(interval);
          btn.classList.remove('btn-cooldown');
          btn.classList.add('btn-clickable');
          topT.remove();
          botT.remove();
          btn.textContent = originalText;
        } else {
          update();
        }
      }, 100);
    }

    // toggleGoLive removed ‚Äî replaced by streamGoLive/streamStop

    function toggleChannel(btn) {
      if (btn.classList.contains('btn-channeling')) {
        btn.classList.remove('btn-channeling');
        btn.classList.add('btn-clickable');
        btn.textContent = btn.textContent.replace('Stop', 'Channel');
      } else {
        btn.classList.remove('btn-clickable');
        btn.classList.add('btn-channeling');
        btn.textContent = btn.textContent.replace('Channel', 'Stop');
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // REALITY TAB ‚Äî Todo, Notes, Garden, Catalogs
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // ‚îÄ‚îÄ Card collapse ‚îÄ‚îÄ
    const REALITY_CARDS = ['todo', 'notes', 'garden', 'references', 'elements', 'materials', 'inventory'];
    function toggleRealityCard(id) {
      const card = document.getElementById('reality-' + id);
      if (card) card.classList.toggle('collapsed');
      localStorage.setItem('reality_collapsed_' + id, card.classList.contains('collapsed'));
    }
    // Restore collapse state
    REALITY_CARDS.forEach(id => {
      if (localStorage.getItem('reality_collapsed_' + id) === 'true') {
        const card = document.getElementById('reality-' + id);
        if (card) card.classList.add('collapsed');
      }
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // REFERENCE SOURCES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const REF_SOURCES = [
      { icon: '‚öõÔ∏è', name: 'NIST', url: 'https://nist.gov', desc: 'Physical constants, element data, standards' },
      { icon: 'üß™', name: 'PubChem', url: 'https://pubchem.ncbi.nlm.nih.gov', desc: 'Chemical compounds database' },
      { icon: 'üî¨', name: 'PubMed', url: 'https://pubmed.ncbi.nlm.nih.gov', desc: 'Biomedical research papers' },
      { icon: 'üåå', name: 'NASA ADS', url: 'https://ui.adsabs.harvard.edu', desc: 'Astrophysics data system' },
      { icon: 'üìñ', name: 'Wikipedia', url: 'https://wikipedia.org', desc: 'General reference encyclopedia' },
      { icon: 'ü™®', name: 'USGS', url: 'https://usgs.gov', desc: 'Geological surveys, minerals, mines' },
      { icon: 'üèóÔ∏è', name: 'MatWeb', url: 'https://matweb.com', desc: 'Material property data' },
      { icon: 'üìä', name: 'Wolfram Alpha', url: 'https://wolframalpha.com', desc: 'Computational knowledge engine' },
    ];
    (function renderRefSources() {
      document.getElementById('ref-sources-grid').innerHTML = REF_SOURCES.map(s =>
        `<a href="${s.url}" target="_blank" rel="noopener" class="ref-card">
          <span class="ref-icon">${s.icon}</span>
          <div><div class="ref-name">${s.name}</div><div class="ref-desc">${s.desc}</div></div>
        </a>`
      ).join('');
    })();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ELEMENT CATALOG
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ELEMENTS = [
      { symbol:'H', name:'Hydrogen', number:1, category:'nonmetal', mass:1.008, phase:'Gas',
        density:'0.00008988 g/cm¬≥', meltingPoint:'-259.16 ¬∞C', boilingPoint:'-252.87 ¬∞C',
        discovered:'1766', discoverer:'Henry Cavendish',
        uses:['Fuel cells','Ammonia production','Rocket fuel','Hydrogenation'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C1333740'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Hydrogen'}],
        description:'Lightest element. Most abundant chemical substance in the universe.' },
      { symbol:'C', name:'Carbon', number:6, category:'nonmetal', mass:12.011, phase:'Solid',
        density:'2.267 g/cm¬≥', meltingPoint:'3550 ¬∞C', boilingPoint:'4027 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Steel production','Fuels','Plastics','Diamond/graphite'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440440'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Carbon'}],
        description:'Basis of all known life. Forms more compounds than any other element.' },
      { symbol:'N', name:'Nitrogen', number:7, category:'nonmetal', mass:14.007, phase:'Gas',
        density:'0.0012506 g/cm¬≥', meltingPoint:'-210.00 ¬∞C', boilingPoint:'-195.79 ¬∞C',
        discovered:'1772', discoverer:'Daniel Rutherford',
        uses:['Fertilizers','Explosives','Cryogenics','Food preservation'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7727379'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Nitrogen'}],
        description:'Makes up 78% of Earth\'s atmosphere. Essential for amino acids and DNA.' },
      { symbol:'O', name:'Oxygen', number:8, category:'nonmetal', mass:15.999, phase:'Gas',
        density:'0.001429 g/cm¬≥', meltingPoint:'-218.79 ¬∞C', boilingPoint:'-182.96 ¬∞C',
        discovered:'1774', discoverer:'Joseph Priestley',
        uses:['Respiration','Steel manufacturing','Medical','Welding'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7782447'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Oxygen'}],
        description:'Essential for aerobic life. Third most abundant element in the universe.' },
      { symbol:'Si', name:'Silicon', number:14, category:'metalloid', mass:28.085, phase:'Solid',
        density:'2.3296 g/cm¬≥', meltingPoint:'1414 ¬∞C', boilingPoint:'3265 ¬∞C',
        discovered:'1824', discoverer:'J√∂ns Jacob Berzelius',
        uses:['Semiconductors','Glass','Concrete','Solar cells'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440213'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Silicon'}],
        description:'Second most abundant element in Earth\'s crust. Foundation of modern electronics.' },
      { symbol:'Fe', name:'Iron', number:26, category:'transition-metal', mass:55.845, phase:'Solid',
        density:'7.874 g/cm¬≥', meltingPoint:'1538 ¬∞C', boilingPoint:'2862 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Steel','Construction','Machinery','Magnets'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439896'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Iron'}],
        description:'Most common element on Earth by mass. Core component of steel.' },
      { symbol:'Cu', name:'Copper', number:29, category:'transition-metal', mass:63.546, phase:'Solid',
        density:'8.96 g/cm¬≥', meltingPoint:'1084.62 ¬∞C', boilingPoint:'2562 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Electrical wiring','Plumbing','Electronics','Alloys'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440508'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Copper'}],
        description:'Excellent conductor of electricity and heat. One of few metals with natural color.' },
      { symbol:'Ag', name:'Silver', number:47, category:'transition-metal', mass:107.868, phase:'Solid',
        density:'10.49 g/cm¬≥', meltingPoint:'961.78 ¬∞C', boilingPoint:'2162 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Jewelry','Electronics','Photography','Antibacterial'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440224'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Silver'}],
        description:'Highest electrical and thermal conductivity of any element. Precious metal.' },
      { symbol:'Au', name:'Gold', number:79, category:'transition-metal', mass:196.967, phase:'Solid',
        density:'19.3 g/cm¬≥', meltingPoint:'1064.18 ¬∞C', boilingPoint:'2856 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Currency/Investment','Jewelry','Electronics','Dentistry'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440575'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Gold'}],
        description:'Highly valued precious metal. Extremely malleable and resistant to corrosion.' },
      { symbol:'U', name:'Uranium', number:92, category:'actinide', mass:238.029, phase:'Solid',
        density:'19.1 g/cm¬≥', meltingPoint:'1132.2 ¬∞C', boilingPoint:'4131 ¬∞C',
        discovered:'1789', discoverer:'Martin Heinrich Klaproth',
        uses:['Nuclear power','Nuclear weapons','Radiation shielding','Dating rocks'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440611'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Uranium'}],
        description:'Heaviest naturally occurring element. Primary fuel for nuclear reactors.' },
{ symbol:'He', name:'Helium', number:2, category:'noble-gas', mass:4.003, phase:'Gas',
        density:'0.0001786 g/cm¬≥', meltingPoint:'-272.20 ¬∞C', boilingPoint:'-268.93 ¬∞C',
        discovered:'1868', discoverer:'Pierre Janssen & Joseph Lockyer',
        uses:['Balloons','Cryogenics','Welding shield gas','MRI coolant'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440597'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Helium'}],
        description:'Second lightest element. Inert noble gas used in cryogenics and MRI cooling.' },
      { symbol:'Li', name:'Lithium', number:3, category:'alkali-metal', mass:6.941, phase:'Solid',
        density:'0.534 g/cm¬≥', meltingPoint:'180.54 ¬∞C', boilingPoint:'1342 ¬∞C',
        discovered:'1817', discoverer:'Johan August Arfwedson',
        uses:['Batteries','Ceramics','Pharmaceuticals','Lubricant grease'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439932'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Lithium'}],
        description:'Lightest metal. Key component in rechargeable lithium-ion batteries.' },
      { symbol:'Be', name:'Beryllium', number:4, category:'alkaline-earth', mass:9.012, phase:'Solid',
        density:'1.85 g/cm¬≥', meltingPoint:'1287 ¬∞C', boilingPoint:'2470 ¬∞C',
        discovered:'1798', discoverer:'Louis Nicolas Vauquelin',
        uses:['Aerospace alloys','X-ray windows','Nuclear reactors','Speakers'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440417'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Beryllium'}],
        description:'Lightweight, strong metal. Transparent to X-rays, used in aerospace.' },
      { symbol:'B', name:'Boron', number:5, category:'metalloid', mass:10.81, phase:'Solid',
        density:'2.34 g/cm¬≥', meltingPoint:'2076 ¬∞C', boilingPoint:'3927 ¬∞C',
        discovered:'1808', discoverer:'Joseph Louis Gay-Lussac & Louis Jacques Th√©nard',
        uses:['Fiberglass','Borosilicate glass','Detergents','Semiconductors'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440428'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Boron'}],
        description:'Metalloid essential for borosilicate glass and fiberglass insulation.' },
      { symbol:'F', name:'Fluorine', number:9, category:'halogen', mass:18.998, phase:'Gas',
        density:'0.001696 g/cm¬≥', meltingPoint:'-219.67 ¬∞C', boilingPoint:'-188.11 ¬∞C',
        discovered:'1886', discoverer:'Henri Moissan',
        uses:['Toothpaste','Teflon','Refrigerants','Uranium enrichment'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7782414'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Fluorine'}],
        description:'Most electronegative element. Essential for fluoride in dental care.' },
      { symbol:'Ne', name:'Neon', number:10, category:'noble-gas', mass:20.180, phase:'Gas',
        density:'0.0008999 g/cm¬≥', meltingPoint:'-248.59 ¬∞C', boilingPoint:'-246.08 ¬∞C',
        discovered:'1898', discoverer:'William Ramsay & Morris Travers',
        uses:['Neon signs','Lasers','Cryogenics','Television tubes'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440019'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Neon'}],
        description:'Noble gas famous for its bright reddish-orange glow in discharge tubes.' },
      { symbol:'Na', name:'Sodium', number:11, category:'alkali-metal', mass:22.990, phase:'Solid',
        density:'0.971 g/cm¬≥', meltingPoint:'97.72 ¬∞C', boilingPoint:'883 ¬∞C',
        discovered:'1807', discoverer:'Humphry Davy',
        uses:['Table salt','Street lighting','Heat transfer','Chemical synthesis'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440235'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Sodium'}],
        description:'Highly reactive alkali metal. Essential biological element in nerve function.' },
      { symbol:'Mg', name:'Magnesium', number:12, category:'alkaline-earth', mass:24.305, phase:'Solid',
        density:'1.738 g/cm¬≥', meltingPoint:'650 ¬∞C', boilingPoint:'1091 ¬∞C',
        discovered:'1755', discoverer:'Joseph Black',
        uses:['Lightweight alloys','Fireworks','Antacids','Electronics casings'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439954'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Magnesium'}],
        description:'Light structural metal. Burns with brilliant white flame.' },
      { symbol:'Al', name:'Aluminum', number:13, category:'post-transition-metal', mass:26.982, phase:'Solid',
        density:'2.70 g/cm¬≥', meltingPoint:'660.32 ¬∞C', boilingPoint:'2519 ¬∞C',
        discovered:'1825', discoverer:'Hans Christian √òrsted',
        uses:['Aircraft','Cans','Foil','Window frames','Electronics'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7429905'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Aluminum'}],
        description:'Most abundant metal in Earth\'s crust. Lightweight and corrosion-resistant.' },
      { symbol:'P', name:'Phosphorus', number:15, category:'nonmetal', mass:30.974, phase:'Solid',
        density:'1.82 g/cm¬≥', meltingPoint:'44.15 ¬∞C', boilingPoint:'280.5 ¬∞C',
        discovered:'1669', discoverer:'Hennig Brand',
        uses:['Fertilizers','Matches','Detergents','Steel production'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7723140'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Phosphorus'}],
        description:'Essential for life ‚Äî key part of DNA, RNA, and ATP.' },
      { symbol:'S', name:'Sulfur', number:16, category:'nonmetal', mass:32.06, phase:'Solid',
        density:'2.067 g/cm¬≥', meltingPoint:'115.21 ¬∞C', boilingPoint:'444.6 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Sulfuric acid','Fertilizers','Vulcanization','Gunpowder'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7704349'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Sulfur'}],
        description:'Yellow nonmetal known since ancient times. Essential for proteins.' },
      { symbol:'Cl', name:'Chlorine', number:17, category:'halogen', mass:35.45, phase:'Gas',
        density:'0.003214 g/cm¬≥', meltingPoint:'-101.5 ¬∞C', boilingPoint:'-34.04 ¬∞C',
        discovered:'1774', discoverer:'Carl Wilhelm Scheele',
        uses:['Water treatment','PVC production','Bleach','Disinfectants'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7782505'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Chlorine'}],
        description:'Greenish-yellow halogen. Widely used for water purification.' },
      { symbol:'Ar', name:'Argon', number:18, category:'noble-gas', mass:39.948, phase:'Gas',
        density:'0.001784 g/cm¬≥', meltingPoint:'-189.34 ¬∞C', boilingPoint:'-185.85 ¬∞C',
        discovered:'1894', discoverer:'Lord Rayleigh & William Ramsay',
        uses:['Welding shield gas','Light bulbs','Insulated windows','Lasers'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440371'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Argon'}],
        description:'Third most abundant gas in atmosphere. Inert, used as shielding gas.' },
      { symbol:'K', name:'Potassium', number:19, category:'alkali-metal', mass:39.098, phase:'Solid',
        density:'0.862 g/cm¬≥', meltingPoint:'63.5 ¬∞C', boilingPoint:'759 ¬∞C',
        discovered:'1807', discoverer:'Humphry Davy',
        uses:['Fertilizers','Soap','Glass','Salt substitutes'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440097'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Potassium'}],
        description:'Essential for plant growth and nerve function. Highly reactive metal.' },
      { symbol:'Ca', name:'Calcium', number:20, category:'alkaline-earth', mass:40.078, phase:'Solid',
        density:'1.55 g/cm¬≥', meltingPoint:'842 ¬∞C', boilingPoint:'1484 ¬∞C',
        discovered:'1808', discoverer:'Humphry Davy',
        uses:['Cement','Bone health supplements','Steel refining','Cheese making'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440702'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Calcium'}],
        description:'Fifth most abundant element in Earth\'s crust. Essential for bones and teeth.' },
      { symbol:'Sc', name:'Scandium', number:21, category:'transition-metal', mass:44.956, phase:'Solid',
        density:'2.985 g/cm¬≥', meltingPoint:'1541 ¬∞C', boilingPoint:'2836 ¬∞C',
        discovered:'1879', discoverer:'Lars Fredrik Nilson',
        uses:['Aerospace alloys','Sports equipment','Lighting','Lasers'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440200'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Scandium'}],
        description:'Light transition metal that strengthens aluminum alloys for aerospace.' },
      { symbol:'Ti', name:'Titanium', number:22, category:'transition-metal', mass:47.867, phase:'Solid',
        density:'4.506 g/cm¬≥', meltingPoint:'1668 ¬∞C', boilingPoint:'3287 ¬∞C',
        discovered:'1791', discoverer:'William Gregor',
        uses:['Aerospace','Medical implants','Pigments','Jewelry'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440326'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Titanium'}],
        description:'Strong, lightweight, corrosion-resistant. Ideal for aerospace and implants.' },
      { symbol:'V', name:'Vanadium', number:23, category:'transition-metal', mass:50.942, phase:'Solid',
        density:'6.11 g/cm¬≥', meltingPoint:'1910 ¬∞C', boilingPoint:'3407 ¬∞C',
        discovered:'1801', discoverer:'Andr√©s Manuel del R√≠o',
        uses:['Steel alloys','Vanadium redox batteries','Catalysts','Aerospace'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440622'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Vanadium'}],
        description:'Transition metal that adds strength and toughness to steel alloys.' },
      { symbol:'Cr', name:'Chromium', number:24, category:'transition-metal', mass:51.996, phase:'Solid',
        density:'7.15 g/cm¬≥', meltingPoint:'1907 ¬∞C', boilingPoint:'2671 ¬∞C',
        discovered:'1797', discoverer:'Louis Nicolas Vauquelin',
        uses:['Stainless steel','Chrome plating','Pigments','Leather tanning'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440473'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Chromium'}],
        description:'Hard, lustrous metal. Key ingredient in stainless steel.' },
      { symbol:'Mn', name:'Manganese', number:25, category:'transition-metal', mass:54.938, phase:'Solid',
        density:'7.21 g/cm¬≥', meltingPoint:'1246 ¬∞C', boilingPoint:'2061 ¬∞C',
        discovered:'1774', discoverer:'Johan Gottlieb Gahn',
        uses:['Steel production','Batteries','Pigments','Water treatment'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439965'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Manganese'}],
        description:'Essential for steel production. Improves strength and hardness.' },
      { symbol:'Co', name:'Cobalt', number:27, category:'transition-metal', mass:58.933, phase:'Solid',
        density:'8.90 g/cm¬≥', meltingPoint:'1495 ¬∞C', boilingPoint:'2927 ¬∞C',
        discovered:'1735', discoverer:'Georg Brandt',
        uses:['Lithium-ion batteries','Superalloys','Blue pigments','Magnets'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440484'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Cobalt'}],
        description:'Blue-tinted metal critical for rechargeable battery cathodes.' },
      { symbol:'Ni', name:'Nickel', number:28, category:'transition-metal', mass:58.693, phase:'Solid',
        density:'8.908 g/cm¬≥', meltingPoint:'1455 ¬∞C', boilingPoint:'2913 ¬∞C',
        discovered:'1751', discoverer:'Axel Fredrik Cronstedt',
        uses:['Stainless steel','Coins','Batteries','Plating'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440020'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Nickel'}],
        description:'Corrosion-resistant metal. Major component of stainless steel and coins.' },
      { symbol:'Zn', name:'Zinc', number:30, category:'transition-metal', mass:65.38, phase:'Solid',
        density:'7.134 g/cm¬≥', meltingPoint:'419.53 ¬∞C', boilingPoint:'907 ¬∞C',
        discovered:'1746', discoverer:'Andreas Sigismund Marggraf',
        uses:['Galvanizing','Alloys (brass)','Batteries','Sunscreen'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440666'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Zinc'}],
        description:'Used to galvanize steel against corrosion. Essential trace element.' },
      { symbol:'Ga', name:'Gallium', number:31, category:'post-transition-metal', mass:69.723, phase:'Solid',
        density:'5.91 g/cm¬≥', meltingPoint:'29.76 ¬∞C', boilingPoint:'2204 ¬∞C',
        discovered:'1875', discoverer:'Paul Emile Lecoq de Boisbaudran',
        uses:['Semiconductors','LEDs','Solar cells','Thermometers'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440553'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Gallium'}],
        description:'Melts near body temperature. Critical for GaAs semiconductors and LEDs.' },
      { symbol:'Ge', name:'Germanium', number:32, category:'metalloid', mass:72.630, phase:'Solid',
        density:'5.323 g/cm¬≥', meltingPoint:'938.25 ¬∞C', boilingPoint:'2833 ¬∞C',
        discovered:'1886', discoverer:'Clemens Winkler',
        uses:['Fiber optics','Infrared optics','Transistors','Solar cells'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440564'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Germanium'}],
        description:'Semiconductor metalloid. Predicted by Mendeleev as eka-silicon.' },
      { symbol:'As', name:'Arsenic', number:33, category:'metalloid', mass:74.922, phase:'Solid',
        density:'5.776 g/cm¬≥', meltingPoint:'816 ¬∞C (sublimes)', boilingPoint:'614 ¬∞C (sublimes)',
        discovered:'Ancient', discoverer:'Albertus Magnus (c. 1250)',
        uses:['Semiconductors','Wood preservatives','Pesticides','Lead alloys'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440382'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Arsenic'}],
        description:'Toxic metalloid historically used as a poison. Now used in semiconductors.' },
      { symbol:'Se', name:'Selenium', number:34, category:'nonmetal', mass:78.971, phase:'Solid',
        density:'4.809 g/cm¬≥', meltingPoint:'221 ¬∞C', boilingPoint:'685 ¬∞C',
        discovered:'1817', discoverer:'J√∂ns Jacob Berzelius',
        uses:['Glass decolorizer','Electronics','Solar cells','Dietary supplement'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7782492'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Selenium'}],
        description:'Essential trace element. Photoconductor used in photocopiers.' },
      { symbol:'Br', name:'Bromine', number:35, category:'halogen', mass:79.904, phase:'Liquid',
        density:'3.1028 g/cm¬≥', meltingPoint:'-7.2 ¬∞C', boilingPoint:'58.8 ¬∞C',
        discovered:'1826', discoverer:'Antoine J√©r√¥me Balard',
        uses:['Flame retardants','Pesticides','Pharmaceuticals','Photography'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7726956'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Bromine'}],
        description:'One of two elements liquid at room temperature. Reddish-brown and pungent.' },
      { symbol:'Kr', name:'Krypton', number:36, category:'noble-gas', mass:83.798, phase:'Gas',
        density:'0.003749 g/cm¬≥', meltingPoint:'-157.36 ¬∞C', boilingPoint:'-153.22 ¬∞C',
        discovered:'1898', discoverer:'William Ramsay & Morris Travers',
        uses:['Lighting','Photography flash','Insulated windows','Lasers'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439909'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Krypton'}],
        description:'Noble gas used in high-performance lighting and photographic flash.' },
      { symbol:'Rb', name:'Rubidium', number:37, category:'alkali-metal', mass:85.468, phase:'Solid',
        density:'1.532 g/cm¬≥', meltingPoint:'39.31 ¬∞C', boilingPoint:'688 ¬∞C',
        discovered:'1861', discoverer:'Robert Bunsen & Gustav Kirchhoff',
        uses:['Atomic clocks','Fireworks','Photocells','Medical imaging'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440177'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Rubidium'}],
        description:'Soft, silvery alkali metal. Used in precision atomic clocks.' },
      { symbol:'Sr', name:'Strontium', number:38, category:'alkaline-earth', mass:87.62, phase:'Solid',
        density:'2.64 g/cm¬≥', meltingPoint:'777 ¬∞C', boilingPoint:'1382 ¬∞C',
        discovered:'1790', discoverer:'Adair Crawford',
        uses:['Fireworks (red)','Ferrite magnets','Toothpaste','Flares'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440246'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Strontium'}],
        description:'Produces brilliant red flame. Used in fireworks and flares.' },
      { symbol:'Y', name:'Yttrium', number:39, category:'transition-metal', mass:88.906, phase:'Solid',
        density:'4.469 g/cm¬≥', meltingPoint:'1526 ¬∞C', boilingPoint:'3345 ¬∞C',
        discovered:'1794', discoverer:'Johan Gadolin',
        uses:['LEDs','Superconductors','Lasers','Camera lenses'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440655'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Yttrium'}],
        description:'Silvery metal used in phosphors for LEDs and display screens.' },
      { symbol:'Zr', name:'Zirconium', number:40, category:'transition-metal', mass:91.224, phase:'Solid',
        density:'6.506 g/cm¬≥', meltingPoint:'1855 ¬∞C', boilingPoint:'4409 ¬∞C',
        discovered:'1789', discoverer:'Martin Heinrich Klaproth',
        uses:['Nuclear fuel cladding','Ceramics','Prosthetics','Chemical processing'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440677'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Zirconium'}],
        description:'Corrosion-resistant metal. Primary use in nuclear reactor fuel cladding.' },
      { symbol:'Nb', name:'Niobium', number:41, category:'transition-metal', mass:92.906, phase:'Solid',
        density:'8.57 g/cm¬≥', meltingPoint:'2477 ¬∞C', boilingPoint:'4744 ¬∞C',
        discovered:'1801', discoverer:'Charles Hatchett',
        uses:['Superconducting magnets','Steel alloys','Jet engines','Jewelry'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440031'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Niobium'}],
        description:'Superconducting metal used in MRI magnets and particle accelerators.' },
      { symbol:'Mo', name:'Molybdenum', number:42, category:'transition-metal', mass:95.95, phase:'Solid',
        density:'10.22 g/cm¬≥', meltingPoint:'2623 ¬∞C', boilingPoint:'4639 ¬∞C',
        discovered:'1781', discoverer:'Carl Wilhelm Scheele',
        uses:['Steel alloys','Catalysts','Lubricants','Electronics'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439987'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Molybdenum'}],
        description:'High-melting-point metal that strengthens steel alloys.' },
      { symbol:'Tc', name:'Technetium', number:43, category:'transition-metal', mass:98, phase:'Solid',
        density:'11.5 g/cm¬≥', meltingPoint:'2157 ¬∞C', boilingPoint:'4265 ¬∞C',
        discovered:'1937', discoverer:'Carlo Perrier & Emilio Segr√®',
        uses:['Medical imaging','Nuclear medicine','Radiography','Catalysts'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440262'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Technetium'}],
        description:'First artificially produced element. Widely used in medical diagnostics.' },
      { symbol:'Ru', name:'Ruthenium', number:44, category:'transition-metal', mass:101.07, phase:'Solid',
        density:'12.37 g/cm¬≥', meltingPoint:'2334 ¬∞C', boilingPoint:'4150 ¬∞C',
        discovered:'1844', discoverer:'Karl Ernst Claus',
        uses:['Catalysts','Electronics','Wear-resistant coatings','Solar cells'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440188'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Ruthenium'}],
        description:'Rare platinum-group metal used in catalysis and electronics.' },
      { symbol:'Rh', name:'Rhodium', number:45, category:'transition-metal', mass:102.906, phase:'Solid',
        density:'12.41 g/cm¬≥', meltingPoint:'1964 ¬∞C', boilingPoint:'3695 ¬∞C',
        discovered:'1803', discoverer:'William Hyde Wollaston',
        uses:['Catalytic converters','Jewelry','Mirrors','Chemical catalysts'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440166'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Rhodium'}],
        description:'Rarest and most expensive precious metal. Key in automotive catalytic converters.' },
      { symbol:'Pd', name:'Palladium', number:46, category:'transition-metal', mass:106.42, phase:'Solid',
        density:'12.023 g/cm¬≥', meltingPoint:'1554.9 ¬∞C', boilingPoint:'2963 ¬∞C',
        discovered:'1803', discoverer:'William Hyde Wollaston',
        uses:['Catalytic converters','Electronics','Dentistry','Hydrogen purification'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440053'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Palladium'}],
        description:'Platinum-group metal. Absorbs up to 900 times its own volume of hydrogen.' },
      { symbol:'Cd', name:'Cadmium', number:48, category:'transition-metal', mass:112.414, phase:'Solid',
        density:'8.69 g/cm¬≥', meltingPoint:'321.07 ¬∞C', boilingPoint:'767 ¬∞C',
        discovered:'1817', discoverer:'Friedrich Stromeyer',
        uses:['Batteries (NiCd)','Pigments','Coatings','Nuclear reactor control rods'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440439'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Cadmium'}],
        description:'Toxic heavy metal. Used in rechargeable batteries and yellow pigments.' },
      { symbol:'In', name:'Indium', number:49, category:'post-transition-metal', mass:114.818, phase:'Solid',
        density:'7.31 g/cm¬≥', meltingPoint:'156.6 ¬∞C', boilingPoint:'2072 ¬∞C',
        discovered:'1863', discoverer:'Ferdinand Reich & Hieronymus Theodor Richter',
        uses:['Touchscreens (ITO)','Solders','Semiconductors','Low-melting alloys'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440746'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Indium'}],
        description:'Soft metal critical for transparent conductive coatings in touchscreens.' },
      { symbol:'Sn', name:'Tin', number:50, category:'post-transition-metal', mass:118.710, phase:'Solid',
        density:'7.287 g/cm¬≥', meltingPoint:'231.93 ¬∞C', boilingPoint:'2602 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Tin cans','Solder','Bronze alloy','Tin plating'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440315'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Tin'}],
        description:'One of the earliest metals used by humans. Key component of bronze and solder.' },
      { symbol:'Sb', name:'Antimony', number:51, category:'metalloid', mass:121.760, phase:'Solid',
        density:'6.685 g/cm¬≥', meltingPoint:'630.63 ¬∞C', boilingPoint:'1587 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Flame retardants','Lead-acid batteries','Semiconductors','Cosmetics'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440360'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Antimony'}],
        description:'Brittle metalloid used in flame retardants and lead-acid battery alloys.' },
      { symbol:'Te', name:'Tellurium', number:52, category:'metalloid', mass:127.60, phase:'Solid',
        density:'6.232 g/cm¬≥', meltingPoint:'449.51 ¬∞C', boilingPoint:'988 ¬∞C',
        discovered:'1783', discoverer:'Franz-Joseph M√ºller von Reichenstein',
        uses:['Solar cells (CdTe)','Thermoelectrics','Alloys','Rubber vulcanization'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C13494809'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Tellurium'}],
        description:'Rare metalloid used in thin-film solar cells and thermoelectric devices.' },
      { symbol:'I', name:'Iodine', number:53, category:'halogen', mass:126.904, phase:'Solid',
        density:'4.933 g/cm¬≥', meltingPoint:'113.7 ¬∞C', boilingPoint:'184.3 ¬∞C',
        discovered:'1811', discoverer:'Bernard Courtois',
        uses:['Disinfectants','Thyroid medicine','Photography','Dyes'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7553562'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Iodine'}],
        description:'Essential for thyroid hormones. Purple vapor when heated.' },
      { symbol:'Xe', name:'Xenon', number:54, category:'noble-gas', mass:131.293, phase:'Gas',
        density:'0.005887 g/cm¬≥', meltingPoint:'-111.75 ¬∞C', boilingPoint:'-108.10 ¬∞C',
        discovered:'1898', discoverer:'William Ramsay & Morris Travers',
        uses:['Headlights','Anesthesia','Ion propulsion','Medical imaging'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440633'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Xenon'}],
        description:'Heavy noble gas. Used in bright arc lamps and spacecraft ion engines.' },
      { symbol:'Cs', name:'Cesium', number:55, category:'alkali-metal', mass:132.905, phase:'Solid',
        density:'1.873 g/cm¬≥', meltingPoint:'28.44 ¬∞C', boilingPoint:'671 ¬∞C',
        discovered:'1860', discoverer:'Robert Bunsen & Gustav Kirchhoff',
        uses:['Atomic clocks','Drilling fluids','Photoelectric cells','Cancer treatment'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440462'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Cesium'}],
        description:'Most electropositive stable element. Defines the second via atomic clocks.' },
      { symbol:'Ba', name:'Barium', number:56, category:'alkaline-earth', mass:137.327, phase:'Solid',
        density:'3.594 g/cm¬≥', meltingPoint:'727 ¬∞C', boilingPoint:'1845 ¬∞C',
        discovered:'1808', discoverer:'Humphry Davy',
        uses:['Medical imaging (barium meal)','Drilling fluids','Fireworks (green)','Glass'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440393'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Barium'}],
        description:'Heavy alkaline earth metal. Barium sulfate used in X-ray imaging.' },
      { symbol:'La', name:'Lanthanum', number:57, category:'lanthanide', mass:138.905, phase:'Solid',
        density:'6.145 g/cm¬≥', meltingPoint:'920 ¬∞C', boilingPoint:'3464 ¬∞C',
        discovered:'1839', discoverer:'Carl Gustaf Mosander',
        uses:['Camera lenses','Catalysts','Lighter flints','Hybrid car batteries'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439910'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Lanthanum'}],
        description:'First of the lanthanides. Used in high-quality optical glass.' },
      { symbol:'Ce', name:'Cerium', number:58, category:'lanthanide', mass:140.116, phase:'Solid',
        density:'6.770 g/cm¬≥', meltingPoint:'799 ¬∞C', boilingPoint:'3443 ¬∞C',
        discovered:'1803', discoverer:'J√∂ns Jacob Berzelius & Wilhelm Hisinger',
        uses:['Catalytic converters','Glass polishing','Self-cleaning ovens','Lighter flints'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440451'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Cerium'}],
        description:'Most abundant lanthanide. Used in catalytic converters and glass polishing.' },
      { symbol:'Pr', name:'Praseodymium', number:59, category:'lanthanide', mass:140.908, phase:'Solid',
        density:'6.773 g/cm¬≥', meltingPoint:'931 ¬∞C', boilingPoint:'3520 ¬∞C',
        discovered:'1885', discoverer:'Carl Auer von Welsbach',
        uses:['Magnets','Aircraft engines','Yellow glass','Lighter flints'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440100'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Praseodymium'}],
        description:'Rare earth used in strong permanent magnets and aircraft engines.' },
      { symbol:'Nd', name:'Neodymium', number:60, category:'lanthanide', mass:144.242, phase:'Solid',
        density:'7.007 g/cm¬≥', meltingPoint:'1021 ¬∞C', boilingPoint:'3074 ¬∞C',
        discovered:'1885', discoverer:'Carl Auer von Welsbach',
        uses:['Powerful magnets','Lasers','Headphones','Wind turbines'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440008'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Neodymium'}],
        description:'Creates the strongest permanent magnets (NdFeB). Critical for green tech.' },
      { symbol:'Pm', name:'Promethium', number:61, category:'lanthanide', mass:145, phase:'Solid',
        density:'7.26 g/cm¬≥', meltingPoint:'1042 ¬∞C', boilingPoint:'3000 ¬∞C',
        discovered:'1945', discoverer:'Jacob A. Marinsky, Lawrence E. Glendenin & Charles D. Coryell',
        uses:['Nuclear batteries','Luminous paint','Thickness gauges','Research'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440126'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Promethium'}],
        description:'Only radioactive lanthanide with no stable isotopes. Extremely rare.' },
      { symbol:'Sm', name:'Samarium', number:62, category:'lanthanide', mass:150.36, phase:'Solid',
        density:'7.52 g/cm¬≥', meltingPoint:'1072 ¬∞C', boilingPoint:'1794 ¬∞C',
        discovered:'1879', discoverer:'Paul Emile Lecoq de Boisbaudran',
        uses:['Magnets','Cancer treatment','Nuclear reactor control','Headphones'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440199'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Samarium'}],
        description:'Used in samarium-cobalt magnets that resist demagnetization at high temperatures.' },
      { symbol:'Eu', name:'Europium', number:63, category:'lanthanide', mass:151.964, phase:'Solid',
        density:'5.243 g/cm¬≥', meltingPoint:'822 ¬∞C', boilingPoint:'1529 ¬∞C',
        discovered:'1901', discoverer:'Eug√®ne-Anatole Demar√ßay',
        uses:['Red phosphors (TVs)','Euro banknote security','Lasers','Fluorescent lamps'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440531'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Europium'}],
        description:'Most reactive lanthanide. Provides red color in TV screens and LEDs.' },
      { symbol:'Gd', name:'Gadolinium', number:64, category:'lanthanide', mass:157.25, phase:'Solid',
        density:'7.895 g/cm¬≥', meltingPoint:'1313 ¬∞C', boilingPoint:'3273 ¬∞C',
        discovered:'1880', discoverer:'Jean Charles Galissard de Marignac',
        uses:['MRI contrast agent','Nuclear reactors','Magnets','Neutron radiography'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440542'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Gadolinium'}],
        description:'Highest neutron absorption of any element. Widely used as MRI contrast agent.' },
      { symbol:'Tb', name:'Terbium', number:65, category:'lanthanide', mass:158.925, phase:'Solid',
        density:'8.229 g/cm¬≥', meltingPoint:'1356 ¬∞C', boilingPoint:'3230 ¬∞C',
        discovered:'1843', discoverer:'Carl Gustaf Mosander',
        uses:['Green phosphors','Solid-state devices','Sonar systems','Fuel cells'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440279'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Terbium'}],
        description:'Rare earth that provides green color in fluorescent lamps and displays.' },
      { symbol:'Dy', name:'Dysprosium', number:66, category:'lanthanide', mass:162.500, phase:'Solid',
        density:'8.55 g/cm¬≥', meltingPoint:'1412 ¬∞C', boilingPoint:'2567 ¬∞C',
        discovered:'1886', discoverer:'Paul Emile Lecoq de Boisbaudran',
        uses:['Permanent magnets','Nuclear control rods','Data storage','Lasers'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7429916'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Dysprosium'}],
        description:'Added to neodymium magnets to maintain strength at high temperatures.' },
      { symbol:'Ho', name:'Holmium', number:67, category:'lanthanide', mass:164.930, phase:'Solid',
        density:'8.795 g/cm¬≥', meltingPoint:'1474 ¬∞C', boilingPoint:'2700 ¬∞C',
        discovered:'1878', discoverer:'Marc Delafontaine & Jacques-Louis Soret',
        uses:['Lasers (medical)','Nuclear reactors','Magnets','Spectrophotometry'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440600'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Holmium'}],
        description:'Has the highest magnetic moment of any element. Used in medical lasers.' },
      { symbol:'Er', name:'Erbium', number:68, category:'lanthanide', mass:167.259, phase:'Solid',
        density:'9.066 g/cm¬≥', meltingPoint:'1529 ¬∞C', boilingPoint:'2868 ¬∞C',
        discovered:'1842', discoverer:'Carl Gustaf Mosander',
        uses:['Fiber optic amplifiers','Lasers','Glass colorant','Nuclear technology'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440520'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Erbium'}],
        description:'Critical for erbium-doped fiber amplifiers that enable long-distance internet.' },
      { symbol:'Tm', name:'Thulium', number:69, category:'lanthanide', mass:168.934, phase:'Solid',
        density:'9.321 g/cm¬≥', meltingPoint:'1545 ¬∞C', boilingPoint:'1950 ¬∞C',
        discovered:'1879', discoverer:'Per Teodor Cleve',
        uses:['Portable X-ray machines','Lasers','High-temp superconductors','Radiation dosimeters'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440304'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Thulium'}],
        description:'Rarest lanthanide. Used in portable X-ray devices and surgical lasers.' },
      { symbol:'Yb', name:'Ytterbium', number:70, category:'lanthanide', mass:173.045, phase:'Solid',
        density:'6.965 g/cm¬≥', meltingPoint:'819 ¬∞C', boilingPoint:'1196 ¬∞C',
        discovered:'1878', discoverer:'Jean Charles Galissard de Marignac',
        uses:['Atomic clocks','Stress gauges','Lasers','Metallurgy'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440644'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Ytterbium'}],
        description:'Used in world\'s most precise atomic clocks and as a stress gauge in explosions.' },
      { symbol:'Lu', name:'Lutetium', number:71, category:'lanthanide', mass:174.967, phase:'Solid',
        density:'9.84 g/cm¬≥', meltingPoint:'1663 ¬∞C', boilingPoint:'3402 ¬∞C',
        discovered:'1907', discoverer:'Georges Urbain',
        uses:['PET scan catalysts','Oil refining','LED phosphors','Research'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439943'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Lutetium'}],
        description:'Hardest and densest lanthanide. Used in PET scan detectors.' },
      { symbol:'Hf', name:'Hafnium', number:72, category:'transition-metal', mass:178.49, phase:'Solid',
        density:'13.31 g/cm¬≥', meltingPoint:'2233 ¬∞C', boilingPoint:'4603 ¬∞C',
        discovered:'1923', discoverer:'Dirk Coster & George de Hevesy',
        uses:['Nuclear reactor control rods','Superalloys','Plasma cutting','Microprocessors'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440586'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Hafnium'}],
        description:'Excellent neutron absorber. Used in nuclear control rods and Intel processors.' },
      { symbol:'Ta', name:'Tantalum', number:73, category:'transition-metal', mass:180.948, phase:'Solid',
        density:'16.654 g/cm¬≥', meltingPoint:'3017 ¬∞C', boilingPoint:'5458 ¬∞C',
        discovered:'1802', discoverer:'Anders Gustaf Ekeberg',
        uses:['Capacitors','Surgical implants','Jet engines','Chemical equipment'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440257'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Tantalum'}],
        description:'Highly corrosion-resistant. Essential for capacitors in smartphones.' },
      { symbol:'W', name:'Tungsten', number:74, category:'transition-metal', mass:183.84, phase:'Solid',
        density:'19.25 g/cm¬≥', meltingPoint:'3422 ¬∞C', boilingPoint:'5555 ¬∞C',
        discovered:'1783', discoverer:'Juan Jos√© Elhuyar & Fausto Elhuyar',
        uses:['Light bulb filaments','Cutting tools','Ammunition','Heating elements'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440337'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Tungsten'}],
        description:'Highest melting point of all elements. Extremely hard and dense.' },
      { symbol:'Re', name:'Rhenium', number:75, category:'transition-metal', mass:186.207, phase:'Solid',
        density:'21.02 g/cm¬≥', meltingPoint:'3186 ¬∞C', boilingPoint:'5596 ¬∞C',
        discovered:'1925', discoverer:'Masataka Ogawa (claimed), Walter Noddack, Ida Tacke & Otto Berg',
        uses:['Jet engine superalloys','Catalysts','Thermocouples','Filaments'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440155'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Rhenium'}],
        description:'One of the rarest elements. Critical for jet engine superalloys.' },
      { symbol:'Os', name:'Osmium', number:76, category:'transition-metal', mass:190.23, phase:'Solid',
        density:'22.587 g/cm¬≥', meltingPoint:'3033 ¬∞C', boilingPoint:'5012 ¬∞C',
        discovered:'1803', discoverer:'Smithson Tennant',
        uses:['Fountain pen tips','Electrical contacts','Fingerprint detection','Catalysts'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440044'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Osmium'}],
        description:'Densest naturally occurring element. Has a distinctive pungent odor.' },
      { symbol:'Ir', name:'Iridium', number:77, category:'transition-metal', mass:192.217, phase:'Solid',
        density:'22.56 g/cm¬≥', meltingPoint:'2466 ¬∞C', boilingPoint:'4428 ¬∞C',
        discovered:'1803', discoverer:'Smithson Tennant',
        uses:['Spark plugs','Crucibles','Fountain pen nibs','Kilogram standard'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439885'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Iridium'}],
        description:'Most corrosion-resistant metal. K-T extinction asteroid marker.' },
      { symbol:'Pt', name:'Platinum', number:78, category:'transition-metal', mass:195.084, phase:'Solid',
        density:'21.45 g/cm¬≥', meltingPoint:'1768.3 ¬∞C', boilingPoint:'3825 ¬∞C',
        discovered:'1735', discoverer:'Antonio de Ulloa',
        uses:['Catalytic converters','Jewelry','Chemotherapy','Fuel cells'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440064'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Platinum'}],
        description:'Precious metal. Critical for catalytic converters and cancer treatment drugs.' },
      { symbol:'Hg', name:'Mercury', number:80, category:'transition-metal', mass:200.592, phase:'Liquid',
        density:'13.534 g/cm¬≥', meltingPoint:'-38.83 ¬∞C', boilingPoint:'356.73 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Thermometers','Fluorescent lamps','Dental amalgams','Barometers'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439976'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Mercury'}],
        description:'Only metal that is liquid at room temperature. Toxic heavy metal.' },
      { symbol:'Tl', name:'Thallium', number:81, category:'post-transition-metal', mass:204.38, phase:'Solid',
        density:'11.85 g/cm¬≥', meltingPoint:'304 ¬∞C', boilingPoint:'1473 ¬∞C',
        discovered:'1861', discoverer:'William Crookes',
        uses:['Electronics','Infrared optics','Rat poison (historic)','Medical imaging'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440280'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Thallium'}],
        description:'Highly toxic heavy metal. Used in infrared optics and electronics.' },
      { symbol:'Pb', name:'Lead', number:82, category:'post-transition-metal', mass:207.2, phase:'Solid',
        density:'11.34 g/cm¬≥', meltingPoint:'327.46 ¬∞C', boilingPoint:'1749 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Batteries','Radiation shielding','Ammunition','Weights'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439921'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Lead'}],
        description:'Dense, soft, toxic metal. Primary use in lead-acid batteries.' },
      { symbol:'Bi', name:'Bismuth', number:83, category:'post-transition-metal', mass:208.980, phase:'Solid',
        density:'9.807 g/cm¬≥', meltingPoint:'271.5 ¬∞C', boilingPoint:'1564 ¬∞C',
        discovered:'1753', discoverer:'Claude Fran√ßois Geoffroy',
        uses:['Pepto-Bismol','Cosmetics','Lead-free solder','Fire sprinkler alloys'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440699'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Bismuth'}],
        description:'Least toxic heavy metal. Forms beautiful rainbow-colored oxide crystals.' },
      { symbol:'Po', name:'Polonium', number:84, category:'post-transition-metal', mass:209, phase:'Solid',
        density:'9.32 g/cm¬≥', meltingPoint:'254 ¬∞C', boilingPoint:'962 ¬∞C',
        discovered:'1898', discoverer:'Marie & Pierre Curie',
        uses:['Static eliminators','Nuclear triggers','Heat source (space)','Research'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440086'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Polonium'}],
        description:'Extremely radioactive. Named after Poland by Marie Curie.' },
      { symbol:'At', name:'Astatine', number:85, category:'halogen', mass:210, phase:'Solid',
        density:'~7 g/cm¬≥ (est.)', meltingPoint:'302 ¬∞C', boilingPoint:'337 ¬∞C (est.)',
        discovered:'1940', discoverer:'Dale R. Corson, Kenneth Ross MacKenzie & Emilio Segr√®',
        uses:['Targeted cancer therapy (At-211)','Research'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440681'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Astatine'}],
        description:'Rarest naturally occurring element. Being researched for cancer radiotherapy.' },
      { symbol:'Rn', name:'Radon', number:86, category:'noble-gas', mass:222, phase:'Gas',
        density:'0.00973 g/cm¬≥', meltingPoint:'-71 ¬∞C', boilingPoint:'-61.7 ¬∞C',
        discovered:'1900', discoverer:'Friedrich Ernst Dorn',
        uses:['Cancer treatment (historic)','Earthquake prediction research','Radon testing'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C10043922'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Radon'}],
        description:'Radioactive noble gas. Second leading cause of lung cancer after smoking.' },
      { symbol:'Fr', name:'Francium', number:87, category:'alkali-metal', mass:223, phase:'Solid',
        density:'~1.87 g/cm¬≥ (est.)', meltingPoint:'27 ¬∞C (est.)', boilingPoint:'677 ¬∞C (est.)',
        discovered:'1939', discoverer:'Marguerite Perey',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440735'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Francium'}],
        description:'Most unstable naturally occurring element. Half-life of only 22 minutes.' },
      { symbol:'Ra', name:'Radium', number:88, category:'alkaline-earth', mass:226, phase:'Solid',
        density:'5.5 g/cm¬≥', meltingPoint:'696 ¬∞C', boilingPoint:'1500 ¬∞C',
        discovered:'1898', discoverer:'Marie & Pierre Curie',
        uses:['Cancer treatment (historic)','Luminous paint (historic)','Neutron source','Research'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440144'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Radium'}],
        description:'Intensely radioactive. Once used in glow-in-the-dark watch dials.' },
      { symbol:'Ac', name:'Actinium', number:89, category:'actinide', mass:227, phase:'Solid',
        density:'10.07 g/cm¬≥', meltingPoint:'1050 ¬∞C', boilingPoint:'3200 ¬∞C',
        discovered:'1899', discoverer:'Andr√©-Louis Debierne',
        uses:['Neutron source','Cancer treatment research','Thermoelectric generators'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440341'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Actinium'}],
        description:'First of the actinides. Glows pale blue in the dark due to radioactivity.' },
      { symbol:'Th', name:'Thorium', number:90, category:'actinide', mass:232.038, phase:'Solid',
        density:'11.72 g/cm¬≥', meltingPoint:'1750 ¬∞C', boilingPoint:'4788 ¬∞C',
        discovered:'1829', discoverer:'J√∂ns Jacob Berzelius',
        uses:['Nuclear fuel (potential)','Gas mantles','Welding electrodes','Optics'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440291'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Thorium'}],
        description:'Potential nuclear fuel more abundant than uranium. Named after Thor.' },
      { symbol:'Pa', name:'Protactinium', number:91, category:'actinide', mass:231.036, phase:'Solid',
        density:'15.37 g/cm¬≥', meltingPoint:'1572 ¬∞C', boilingPoint:'4000 ¬∞C',
        discovered:'1913', discoverer:'Kasimir Fajans & Oswald Helmuth G√∂hring',
        uses:['Research','Ocean sediment dating'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440133'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Protactinium'}],
        description:'Rare, toxic, radioactive actinide. One of the rarest natural elements.' },
      { symbol:'Np', name:'Neptunium', number:93, category:'actinide', mass:237, phase:'Solid',
        density:'20.45 g/cm¬≥', meltingPoint:'644 ¬∞C', boilingPoint:'3902 ¬∞C',
        discovered:'1940', discoverer:'Edwin McMillan & Philip H. Abelson',
        uses:['Neutron detection','Nuclear waste research','Precursor to Pu-238'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439998'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Neptunium'}],
        description:'First transuranium element. Named after the planet Neptune.' },
      { symbol:'Pu', name:'Plutonium', number:94, category:'actinide', mass:244, phase:'Solid',
        density:'19.816 g/cm¬≥', meltingPoint:'640 ¬∞C', boilingPoint:'3228 ¬∞C',
        discovered:'1940', discoverer:'Glenn T. Seaborg, Edwin McMillan, Joseph W. Kennedy & Arthur Wahl',
        uses:['Nuclear weapons','Nuclear power','Space probe RTGs','Research'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440075'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Plutonium'}],
        description:'Used in nuclear weapons and as fuel in space probes. Extremely toxic.' },
      { symbol:'Am', name:'Americium', number:95, category:'actinide', mass:243, phase:'Solid',
        density:'13.69 g/cm¬≥', meltingPoint:'1176 ¬∞C', boilingPoint:'2011 ¬∞C',
        discovered:'1944', discoverer:'Glenn T. Seaborg, Ralph A. James, Leon O. Morgan & Albert Ghiorso',
        uses:['Smoke detectors','Neutron sources','Research'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440352'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Americium'}],
        description:'Found in household smoke detectors. Named after the Americas.' },
      { symbol:'Cm', name:'Curium', number:96, category:'actinide', mass:247, phase:'Solid',
        density:'13.51 g/cm¬≥', meltingPoint:'1345 ¬∞C', boilingPoint:'3110 ¬∞C',
        discovered:'1944', discoverer:'Glenn T. Seaborg, Ralph A. James & Albert Ghiorso',
        uses:['Space probe power (RTGs)','Alpha particle source','Research'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440510'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Curium'}],
        description:'Named after Marie & Pierre Curie. Powers some Mars rovers.' },
      { symbol:'Bk', name:'Berkelium', number:97, category:'actinide', mass:247, phase:'Solid',
        density:'14.78 g/cm¬≥', meltingPoint:'986 ¬∞C', boilingPoint:'2627 ¬∞C',
        discovered:'1949', discoverer:'Glenn T. Seaborg, Stanley G. Thompson & Albert Ghiorso',
        uses:['Research','Target for heavier element synthesis'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440405'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Berkelium'}],
        description:'Named after Berkeley, California. Only produced in microgram quantities.' },
      { symbol:'Cf', name:'Californium', number:98, category:'actinide', mass:251, phase:'Solid',
        density:'15.1 g/cm¬≥', meltingPoint:'900 ¬∞C', boilingPoint:'1472 ¬∞C',
        discovered:'1950', discoverer:'Glenn T. Seaborg, Stanley G. Thompson, Albert Ghiorso & Kenneth Street Jr.',
        uses:['Neutron source','Mineral analysis','Nuclear reactor startup','Cancer treatment'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440717'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Californium'}],
        description:'Strong neutron emitter. Used to detect gold and water in oil wells.' },
      { symbol:'Es', name:'Einsteinium', number:99, category:'actinide', mass:252, phase:'Solid',
        density:'8.84 g/cm¬≥', meltingPoint:'860 ¬∞C', boilingPoint:'996 ¬∞C (est.)',
        discovered:'1952', discoverer:'Albert Ghiorso et al.',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7429926'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Einsteinium'}],
        description:'Named after Albert Einstein. Discovered in debris of first hydrogen bomb test.' },
      { symbol:'Fm', name:'Fermium', number:100, category:'actinide', mass:257, phase:'Solid',
        density:'~9.7 g/cm¬≥ (est.)', meltingPoint:'1527 ¬∞C (est.)', boilingPoint:'Unknown',
        discovered:'1952', discoverer:'Albert Ghiorso et al.',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440726'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Fermium'}],
        description:'Named after Enrico Fermi. Can only be produced in nuclear reactors.' },
      { symbol:'Md', name:'Mendelevium', number:101, category:'actinide', mass:258, phase:'Solid',
        density:'~10.3 g/cm¬≥ (est.)', meltingPoint:'827 ¬∞C (est.)', boilingPoint:'Unknown',
        discovered:'1955', discoverer:'Albert Ghiorso, Bernard G. Harvey, Gregory R. Choppin, Stanley G. Thompson & Glenn T. Seaborg',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440111'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Mendelevium'}],
        description:'Named after Dmitri Mendeleev. Only about 17 atoms produced at a time.' },
      { symbol:'No', name:'Nobelium', number:102, category:'actinide', mass:259, phase:'Solid',
        density:'~9.9 g/cm¬≥ (est.)', meltingPoint:'827 ¬∞C (est.)', boilingPoint:'Unknown',
        discovered:'1958', discoverer:'Albert Ghiorso, Torbj√∏rn Sikkeland, John R. Walton & Glenn T. Seaborg',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C10028148'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Nobelium'}],
        description:'Named after Alfred Nobel. Most stable isotope has half-life of 58 minutes.' },
      { symbol:'Lr', name:'Lawrencium', number:103, category:'actinide', mass:266, phase:'Solid',
        density:'~14.4 g/cm¬≥ (est.)', meltingPoint:'1627 ¬∞C (est.)', boilingPoint:'Unknown',
        discovered:'1961', discoverer:'Albert Ghiorso, Torbj√∏rn Sikkeland, Almon Larsh & Robert M. Latimer',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C22537191'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Lawrencium'}],
        description:'Last actinide. Named after Ernest O. Lawrence, inventor of the cyclotron.' },
      { symbol:'Rf', name:'Rutherfordium', number:104, category:'transition-metal', mass:267, phase:'Solid',
        density:'~23.2 g/cm¬≥ (est.)', meltingPoint:'~2100 ¬∞C (est.)', boilingPoint:'~5500 ¬∞C (est.)',
        discovered:'1964', discoverer:'Joint Institute for Nuclear Research (Dubna)',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C53850367'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Rutherfordium'}],
        description:'First transactinide. Named after Ernest Rutherford.' },
      { symbol:'Db', name:'Dubnium', number:105, category:'transition-metal', mass:268, phase:'Solid',
        density:'~29.3 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'Unknown',
        discovered:'1967', discoverer:'Joint Institute for Nuclear Research (Dubna)',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C53850423'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Dubnium'}],
        description:'Named after Dubna, Russia. Most stable isotope lasts about 28 hours.' },
      { symbol:'Sg', name:'Seaborgium', number:106, category:'transition-metal', mass:269, phase:'Solid',
        density:'~35 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'Unknown',
        discovered:'1974', discoverer:'Albert Ghiorso et al.',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54038818'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Seaborgium'}],
        description:'Named after Glenn T. Seaborg while he was still alive ‚Äî a first.' },
      { symbol:'Bh', name:'Bohrium', number:107, category:'transition-metal', mass:270, phase:'Solid',
        density:'~37.1 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'Unknown',
        discovered:'1981', discoverer:'Peter Armbruster & Gottfried M√ºnzenberg',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54037149'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Bohrium'}],
        description:'Named after Niels Bohr. Only a few atoms have ever been produced.' },
      { symbol:'Hs', name:'Hassium', number:108, category:'transition-metal', mass:277, phase:'Solid',
        density:'~40.7 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'Unknown',
        discovered:'1984', discoverer:'Peter Armbruster & Gottfried M√ºnzenberg',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54037577'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Hassium'}],
        description:'Named after Hesse, Germany. Behaves like osmium chemically.' },
      { symbol:'Mt', name:'Meitnerium', number:109, category:'transition-metal', mass:278, phase:'Solid',
        density:'~37.4 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'Unknown',
        discovered:'1982', discoverer:'Peter Armbruster & Gottfried M√ºnzenberg',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54038016'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Meitnerium'}],
        description:'Named after Lise Meitner, who helped discover nuclear fission.' },
      { symbol:'Ds', name:'Darmstadtium', number:110, category:'transition-metal', mass:281, phase:'Solid',
        density:'~34.8 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'Unknown',
        discovered:'1994', discoverer:'Sigurd Hofmann et al. (GSI Darmstadt)',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54083778'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Darmstadtium'}],
        description:'Named after Darmstadt, Germany. Extremely short-lived.' },
      { symbol:'Rg', name:'Roentgenium', number:111, category:'transition-metal', mass:282, phase:'Solid',
        density:'~28.7 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'Unknown',
        discovered:'1994', discoverer:'Sigurd Hofmann et al. (GSI Darmstadt)',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54386243'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Roentgenium'}],
        description:'Named after Wilhelm R√∂ntgen, discoverer of X-rays.' },
      { symbol:'Cn', name:'Copernicium', number:112, category:'transition-metal', mass:285, phase:'Liquid (predicted)',
        density:'~23.7 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'~84 ¬∞C (est.)',
        discovered:'1996', discoverer:'Sigurd Hofmann et al. (GSI Darmstadt)',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54084269'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Copernicium'}],
        description:'Named after Nicolaus Copernicus. May be liquid at room temperature.' },
      { symbol:'Nh', name:'Nihonium', number:113, category:'post-transition-metal', mass:286, phase:'Solid (predicted)',
        density:'~16 g/cm¬≥ (est.)', meltingPoint:'~430 ¬∞C (est.)', boilingPoint:'~1100 ¬∞C (est.)',
        discovered:'2003', discoverer:'RIKEN (Kosuke Morita et al.)',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C71759'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Nihonium'}],
        description:'First element discovered in Asia. Named after Japan (Nihon).' },
      { symbol:'Fl', name:'Flerovium', number:114, category:'post-transition-metal', mass:289, phase:'Solid (predicted)',
        density:'~14 g/cm¬≥ (est.)', meltingPoint:'~67 ¬∞C (est.)', boilingPoint:'~147 ¬∞C (est.)',
        discovered:'1998', discoverer:'Joint Institute for Nuclear Research (Dubna) & LLNL',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54085161'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Flerovium'}],
        description:'Named after Flerov Laboratory. May behave like a noble gas.' },
      { symbol:'Mc', name:'Moscovium', number:115, category:'post-transition-metal', mass:290, phase:'Solid (predicted)',
        density:'~13.5 g/cm¬≥ (est.)', meltingPoint:'~400 ¬∞C (est.)', boilingPoint:'~1100 ¬∞C (est.)',
        discovered:'2003', discoverer:'Joint Institute for Nuclear Research (Dubna) & LLNL',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C71750'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Moscovium'}],
        description:'Named after Moscow Oblast. Superheavy element with very short half-life.' },
      { symbol:'Lv', name:'Livermorium', number:116, category:'post-transition-metal', mass:293, phase:'Solid (predicted)',
        density:'~12.9 g/cm¬≥ (est.)', meltingPoint:'~364 ¬∞C (est.)', boilingPoint:'~762 ¬∞C (est.)',
        discovered:'2000', discoverer:'Joint Institute for Nuclear Research (Dubna) & LLNL',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54100710'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Livermorium'}],
        description:'Named after Lawrence Livermore National Laboratory.' },
      { symbol:'Ts', name:'Tennessine', number:117, category:'halogen', mass:294, phase:'Solid (predicted)',
        density:'~7.2 g/cm¬≥ (est.)', meltingPoint:'~350 ¬∞C (est.)', boilingPoint:'~610 ¬∞C (est.)',
        discovered:'2010', discoverer:'Joint Institute for Nuclear Research (Dubna) & ORNL',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C87658'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Tennessine'}],
        description:'Named after Tennessee. Second heaviest known halogen.' },
      { symbol:'Og', name:'Oganesson', number:118, category:'noble-gas', mass:294, phase:'Solid (predicted)',
        density:'~5.0 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'~80 ¬∞C (est.)',
        discovered:'2002', discoverer:'Joint Institute for Nuclear Research (Dubna) & LLNL',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54144196'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Oganesson'}],
        description:'Heaviest known element. Named after Yuri Oganessian. May be solid, not gas.' },
    ];

    const ELEMENT_CATEGORIES = [...new Set(ELEMENTS.map(e => e.category))];
    let elementCatFilter = '';
    let selectedElement = null;

    function renderElementPills() {
      const pills = document.getElementById('element-cat-pills');
      pills.innerHTML = `<span class="filter-pill ${elementCatFilter===''?'active':''}" onclick="elementCatFilter='';renderElements()">All</span>` +
        ELEMENT_CATEGORIES.map(c => `<span class="filter-pill ${elementCatFilter===c?'active':''}" onclick="elementCatFilter='${c}';renderElements()">${c}</span>`).join('');
    }

    function renderElements() {
      const filter = (document.getElementById('element-filter').value || '').toLowerCase();
      const filtered = ELEMENTS.filter(e => {
        if (elementCatFilter && e.category !== elementCatFilter) return false;
        if (filter && !e.name.toLowerCase().includes(filter) && !e.symbol.toLowerCase().includes(filter) && !String(e.number).includes(filter)) return false;
        return true;
      });
      renderElementPills();
      document.getElementById('element-grid').innerHTML = filtered.map(e =>
        `<div class="element-card el-cat-${e.category}" onclick="showElementDetail('${e.symbol}')" title="${e.name}">
          <span class="el-number">${e.number}</span>
          <div class="el-symbol">${e.symbol}</div>
          <div class="el-name">${e.name}</div>
          <div class="el-mass">${e.mass}</div>
        </div>`
      ).join('');
    }

    function showElementDetail(symbol) {
      const e = ELEMENTS.find(el => el.symbol === symbol);
      if (!e) return;
      if (selectedElement === symbol) { selectedElement = null; document.getElementById('element-detail-slot').innerHTML = ''; return; }
      selectedElement = symbol;
      const srcLinks = e.sources.map(s => `<a href="${s.url}" target="_blank" rel="noopener" style="color:var(--accent);font-size:0.75rem;margin-right:0.6rem;">${s.name} ‚Üó</a>`).join('');
      document.getElementById('element-detail-slot').innerHTML = `
        <div class="element-detail">
          <div style="display:flex;justify-content:space-between;align-items:start;">
            <h3><span class="el-cat-${e.category}" style="border:none;display:inline;"><span class="el-symbol" style="font-size:1.4rem;">${e.symbol}</span></span> ${e.name} <span style="color:var(--text-muted);font-weight:400;font-size:0.85rem;">#${e.number}</span></h3>
            <button onclick="selectedElement=null;document.getElementById('element-detail-slot').innerHTML=''" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.1rem;">‚úï</button>
          </div>
          <p style="font-size:0.82rem;color:var(--text-muted);margin:0.3rem 0 0.6rem;">${e.description}</p>
          <div class="el-props">
            <div class="el-prop"><dt>Mass</dt><dd>${e.mass} u</dd></div>
            <div class="el-prop"><dt>Phase (STP)</dt><dd>${e.phase}</dd></div>
            <div class="el-prop"><dt>Density</dt><dd>${e.density}</dd></div>
            <div class="el-prop"><dt>Melting Pt</dt><dd>${e.meltingPoint}</dd></div>
            <div class="el-prop"><dt>Boiling Pt</dt><dd>${e.boilingPoint}</dd></div>
            <div class="el-prop"><dt>Category</dt><dd>${e.category}</dd></div>
            <div class="el-prop"><dt>Discovered</dt><dd>${e.discovered}</dd></div>
            <div class="el-prop"><dt>Discoverer</dt><dd>${e.discoverer}</dd></div>
          </div>
          <div style="margin:0.6rem 0;"><strong style="font-size:0.75rem;color:var(--text-muted);">USES:</strong>
            <div style="display:flex;flex-wrap:wrap;gap:0.3rem;margin-top:0.3rem;">
              ${e.uses.map(u => `<span style="background:rgba(255,136,17,0.1);color:var(--accent);font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:10px;">${u}</span>`).join('')}
            </div>
          </div>
          <div style="margin-top:0.5rem;">${srcLinks}</div>
        </div>`;
    }
    renderElements();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MATERIALS CATALOG
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const MATERIALS = [
      { name:'Iron Ore', type:'raw', category:'Metal',
        components:[], sources_natural:['Open-pit mines','Underground deposits','BIF formations'],
        properties:{ iron_content:'25-70%', density:'4.0-5.5 g/cm¬≥', hardness:'5-6.5 Mohs' },
        uses:['Steel production','Pigments','Cement additive'],
        processing:'Mining ‚Üí Crushing ‚Üí Beneficiation ‚Üí Iron ore concentrate',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/iron-ore-statistics-and-information'}] },
      { name:'Steel', type:'processed', category:'Metal',
        components:['Iron','Carbon'], sources_natural:['Iron ore deposits','Coal mines'],
        properties:{ tensile_strength:'400-550 MPa', density:'7.85 g/cm¬≥', melting_point:'1370-1510 ¬∞C' },
        uses:['Construction','Vehicles','Tools','Bridges'],
        processing:'Iron ore ‚Üí Blast furnace ‚Üí Pig iron ‚Üí Basic oxygen steelmaking ‚Üí Steel',
        references:[{name:'MatWeb',url:'https://matweb.com/search/DataSheet.aspx?MatGUID=1b3c3a1bc9d24cccb03b1bacbbcdfa8c'}] },
      { name:'Wood / Timber', type:'raw', category:'Organic',
        components:[], sources_natural:['Forests','Tree plantations'],
        properties:{ density:'0.4-0.9 g/cm¬≥', tensile_strength:'40-140 MPa', moisture:'12-20%' },
        uses:['Construction','Furniture','Paper','Fuel'],
        processing:'Felling ‚Üí Debarking ‚Üí Sawing ‚Üí Seasoning',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Wood'}] },
      { name:'Lumber', type:'processed', category:'Organic',
        components:['Wood / Timber'], sources_natural:['Managed forests','Sawmills'],
        properties:{ density:'0.35-0.6 g/cm¬≥', moisture:'6-12%', standard_sizes:'2√ó4, 2√ó6, 4√ó4 etc.' },
        uses:['Framing','Decking','Fencing','Shelving'],
        processing:'Timber ‚Üí Sawmill ‚Üí Kiln drying ‚Üí Planing ‚Üí Grading ‚Üí Lumber',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Lumber'}] },
      { name:'Sand', type:'raw', category:'Mineral',
        components:[], sources_natural:['Beaches','Riverbeds','Quarries','Deserts'],
        properties:{ composition:'Mostly SiO‚ÇÇ', grain_size:'0.1-2 mm', density:'1.5-1.7 g/cm¬≥' },
        uses:['Glass making','Concrete','Foundry casting','Filtration'],
        processing:'Extraction ‚Üí Washing ‚Üí Screening ‚Üí Grading',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/sand-and-gravel-statistics-and-information'}] },
      { name:'Glass', type:'processed', category:'Mineral',
        components:['Sand','Soda ash','Limestone'], sources_natural:['Sand quarries'],
        properties:{ density:'2.5 g/cm¬≥', melting_point:'~1700 ¬∞C', transparency:'High (visible spectrum)' },
        uses:['Windows','Bottles','Optics','Screens'],
        processing:'Sand + Soda ash + Limestone ‚Üí Furnace (1700¬∞C) ‚Üí Molten glass ‚Üí Forming ‚Üí Annealing ‚Üí Glass',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Glass'}] },
      { name:'Clay', type:'raw', category:'Mineral',
        components:[], sources_natural:['Riverbanks','Weathered rock deposits','Sedimentary layers'],
        properties:{ particle_size:'<0.002 mm', plasticity:'High when wet', density:'1.8-2.6 g/cm¬≥' },
        uses:['Pottery','Bricks','Ceramics','Sculpture'],
        processing:'Extraction ‚Üí Weathering ‚Üí Pugging ‚Üí Shaping',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Clay'}] },
      { name:'Concrete', type:'composite', category:'Mineral',
        components:['Sand','Gravel','Cement','Water'], sources_natural:['Quarries','Cement plants'],
        properties:{ compressive_strength:'20-40 MPa', density:'2.3-2.5 g/cm¬≥', curing_time:'28 days full strength' },
        uses:['Foundations','Roads','Dams','Buildings'],
        processing:'Cement + Sand + Gravel + Water ‚Üí Mixing ‚Üí Pouring ‚Üí Curing ‚Üí Concrete',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Concrete'}] },
{ name:'Aluminum Ore (Bauxite)', type:'raw', category:'Metal',
        components:[], sources_natural:['Open-pit mines in Australia, Guinea, Brazil, Jamaica'],
        properties:{ aluminum_content:'30-54% Al‚ÇÇO‚ÇÉ', density:'2.0-2.5 g/cm¬≥', hardness:'1-3 Mohs' },
        uses:['Aluminum production','Abrasives','Cement','Refractories'],
        processing:'Mining ‚Üí Crushing ‚Üí Washing ‚Üí Bayer process ‚Üí Alumina',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/bauxite-and-alumina-statistics-and-information'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Bauxite'}] },
      { name:'Aluminum', type:'processed', category:'Metal',
        components:['Bauxite'], sources_natural:['Bauxite mines in Australia, Guinea, Brazil'],
        properties:{ density:'2.7 g/cm¬≥', tensile_strength:'70-700 MPa', melting_point:'660 ¬∞C', conductivity:'High' },
        uses:['Aircraft','Cans','Foil','Window frames','Electronics'],
        processing:'Bauxite ‚Üí Bayer process ‚Üí Alumina ‚Üí Hall-H√©roult electrolysis ‚Üí Aluminum',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/aluminum-statistics-and-information'},{name:'MatWeb',url:'https://matweb.com/search/DataSheet.aspx?MatGUID=0cd1edf33ac145ee93a0aa06bcdbc073'}] },
      { name:'Copper Ore (Chalcopyrite)', type:'raw', category:'Metal',
        components:[], sources_natural:['Porphyry deposits in Chile, Peru, USA, DRC'],
        properties:{ copper_content:'25-35% Cu', density:'4.1-4.3 g/cm¬≥', hardness:'3.5-4 Mohs' },
        uses:['Copper production','Sulfuric acid byproduct'],
        processing:'Mining ‚Üí Crushing ‚Üí Flotation ‚Üí Concentrate ‚Üí Smelting',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/copper-statistics-and-information'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Chalcopyrite'}] },
      { name:'Brass', type:'processed', category:'Metal',
        components:['Copper','Zinc'], sources_natural:['Copper and zinc ores'],
        properties:{ density:'8.4-8.7 g/cm¬≥', tensile_strength:'338-469 MPa', melting_point:'900-940 ¬∞C', conductivity:'Moderate' },
        uses:['Plumbing fittings','Musical instruments','Ammunition casings','Decorative hardware'],
        processing:'Copper + Zinc ‚Üí Melting ‚Üí Alloying ‚Üí Casting/Rolling ‚Üí Brass',
        references:[{name:'MatWeb',url:'https://matweb.com/search/DataSheet.aspx?MatGUID=d3bd4617903543ada92f4c101c2a20e5'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Brass'}] },
      { name:'Bronze', type:'processed', category:'Metal',
        components:['Copper','Tin'], sources_natural:['Copper and tin ores'],
        properties:{ density:'7.4-8.9 g/cm¬≥', tensile_strength:'303-517 MPa', melting_point:'950-1050 ¬∞C', conductivity:'Moderate' },
        uses:['Bearings','Sculptures','Ship propellers','Springs'],
        processing:'Copper + Tin ‚Üí Melting ‚Üí Alloying ‚Üí Casting ‚Üí Bronze',
        references:[{name:'MatWeb',url:'https://matweb.com/search/DataSheet.aspx?MatGUID=b607236c21e545ca9ebf7875cbe0300d'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Bronze'}] },
      { name:'Stainless Steel', type:'processed', category:'Metal',
        components:['Iron','Chromium','Nickel','Carbon'], sources_natural:['Iron, chromium, and nickel ores'],
        properties:{ density:'7.75-8.1 g/cm¬≥', tensile_strength:'515-827 MPa', melting_point:'1400-1530 ¬∞C', conductivity:'Low-Moderate' },
        uses:['Kitchen appliances','Medical instruments','Architecture','Chemical tanks'],
        processing:'Iron + Chromium (10.5%+) + Nickel ‚Üí Electric arc furnace ‚Üí Rolling ‚Üí Stainless Steel',
        references:[{name:'MatWeb',url:'https://matweb.com/search/DataSheet.aspx?MatGUID=abc4415b0f8b490387e3c922237098da'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Stainless_steel'}] },
      { name:'Titanium', type:'processed', category:'Metal',
        components:['Ilmenite','Rutile'], sources_natural:['Mineral sands in Australia, South Africa, Canada'],
        properties:{ density:'4.506 g/cm¬≥', tensile_strength:'434-1103 MPa', melting_point:'1668 ¬∞C', conductivity:'Low' },
        uses:['Aerospace','Medical implants','Jewelry','Chemical processing'],
        processing:'Rutile/Ilmenite ‚Üí Chlorination ‚Üí Kroll process (Mg reduction) ‚Üí Titanium sponge ‚Üí Melting',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/titanium-statistics-and-information'},{name:'MatWeb',url:'https://matweb.com/search/DataSheet.aspx?MatGUID=66a15d609a3f4c829cb6ad08f0dafc01'}] },
      { name:'Zinc', type:'processed', category:'Metal',
        components:['Sphalerite'], sources_natural:['Zinc mines in China, Australia, Peru'],
        properties:{ density:'7.134 g/cm¬≥', tensile_strength:'37 MPa', melting_point:'419.5 ¬∞C', conductivity:'Moderate' },
        uses:['Galvanizing steel','Die casting','Brass alloy','Batteries'],
        processing:'Sphalerite ‚Üí Roasting ‚Üí Leaching ‚Üí Electrolysis ‚Üí Zinc',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/zinc-statistics-and-information'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Zinc'}] },
      { name:'Lead', type:'processed', category:'Metal',
        components:['Galena'], sources_natural:['Lead-zinc mines in China, Australia, USA'],
        properties:{ density:'11.34 g/cm¬≥', tensile_strength:'17 MPa', melting_point:'327.5 ¬∞C', conductivity:'Low' },
        uses:['Lead-acid batteries','Radiation shielding','Ammunition','Cable sheathing'],
        processing:'Galena ‚Üí Roasting ‚Üí Smelting ‚Üí Refining ‚Üí Lead',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/lead-statistics-and-information'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Lead'}] },
      { name:'Tin', type:'processed', category:'Metal',
        components:['Cassiterite'], sources_natural:['Alluvial and hard-rock mines in China, Indonesia, Myanmar'],
        properties:{ density:'7.287 g/cm¬≥', tensile_strength:'11-15 MPa', melting_point:'231.9 ¬∞C', conductivity:'Moderate' },
        uses:['Tin plating (tin cans)','Solder','Bronze alloy','Pewter'],
        processing:'Cassiterite ‚Üí Smelting with carbon ‚Üí Refining ‚Üí Tin',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/tin-statistics-and-information'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Tin'}] },
      { name:'Nickel', type:'processed', category:'Metal',
        components:['Pentlandite','Laterite ores'], sources_natural:['Mines in Indonesia, Philippines, Russia, Canada'],
        properties:{ density:'8.908 g/cm¬≥', tensile_strength:'317-462 MPa', melting_point:'1455 ¬∞C', conductivity:'Moderate' },
        uses:['Stainless steel','Batteries','Coins','Superalloys'],
        processing:'Laterite/Sulfide ore ‚Üí Roasting/Leaching ‚Üí Smelting ‚Üí Electrolytic refining ‚Üí Nickel',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/nickel-statistics-and-information'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Nickel'}] },
      { name:'Cotton', type:'raw', category:'Organic',
        components:[], sources_natural:['Cotton farms in India, China, USA, Brazil'],
        properties:{ density:'1.5-1.6 g/cm¬≥', tensile_strength:'287-597 MPa', moisture_regain:'8.5%', fiber_length:'10-65 mm' },
        uses:['Clothing','Towels','Medical supplies','Industrial fabrics'],
        processing:'Harvesting ‚Üí Ginning ‚Üí Carding ‚Üí Spinning ‚Üí Weaving/Knitting',
        references:[{name:'USDA',url:'https://usda.gov/topics/farming/crop-production'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Cotton'}] },
      { name:'Wool', type:'raw', category:'Organic',
        components:[], sources_natural:['Sheep farms in Australia, China, New Zealand'],
        properties:{ density:'1.3 g/cm¬≥', fiber_diameter:'15-40 Œºm', moisture_regain:'13-16%', flame_resistance:'Self-extinguishing' },
        uses:['Clothing','Blankets','Carpets','Insulation'],
        processing:'Shearing ‚Üí Scouring ‚Üí Carding ‚Üí Spinning ‚Üí Weaving',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Wool'}] },
      { name:'Leather', type:'processed', category:'Organic',
        components:['Animal hide'], sources_natural:['Cattle, sheep, goat hides (byproduct of meat industry)'],
        properties:{ density:'0.86 g/cm¬≥', tensile_strength:'10-30 MPa', thickness:'0.5-3.0 mm' },
        uses:['Shoes','Bags','Furniture','Belts','Jackets'],
        processing:'Hide ‚Üí Liming ‚Üí Dehairing ‚Üí Tanning (chrome/vegetable) ‚Üí Drying ‚Üí Finishing',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Leather'}] },
      { name:'Rubber (Natural)', type:'raw', category:'Organic',
        components:[], sources_natural:['Rubber tree plantations in Thailand, Indonesia, Malaysia'],
        properties:{ density:'0.92 g/cm¬≥', tensile_strength:'20-30 MPa', elongation:'600-800%', elasticity:'Very high' },
        uses:['Tires','Gloves','Hoses','Footwear','Elastic bands'],
        processing:'Tapping latex ‚Üí Coagulation ‚Üí Smoking/Drying ‚Üí Vulcanization',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Natural_rubber'}] },
      { name:'Paper', type:'processed', category:'Organic',
        components:['Wood pulp'], sources_natural:['Managed forests, recycled paper'],
        properties:{ density:'0.7-1.2 g/cm¬≥', tensile_strength:'2-10 kN/m', thickness:'0.05-0.5 mm' },
        uses:['Writing','Packaging','Printing','Tissue','Currency'],
        processing:'Wood ‚Üí Chipping ‚Üí Pulping ‚Üí Bleaching ‚Üí Pressing ‚Üí Drying ‚Üí Paper',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Paper'}] },
      { name:'Bamboo', type:'raw', category:'Organic',
        components:[], sources_natural:['Tropical and subtropical forests in Asia, South America'],
        properties:{ density:'0.3-0.8 g/cm¬≥', tensile_strength:'140-280 MPa', growth_rate:'Up to 91 cm/day' },
        uses:['Construction','Flooring','Textiles','Furniture','Scaffolding'],
        processing:'Harvesting ‚Üí Splitting ‚Üí Treating ‚Üí Drying ‚Üí Laminating',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Bamboo'}] },
      { name:'Hemp', type:'raw', category:'Organic',
        components:[], sources_natural:['Hemp farms in China, Canada, Europe'],
        properties:{ density:'1.48 g/cm¬≥', tensile_strength:'550-900 MPa', fiber_length:'1-5 m' },
        uses:['Rope','Textiles','Paper','Insulation','Bioplastics'],
        processing:'Harvesting ‚Üí Retting ‚Üí Breaking ‚Üí Scutching ‚Üí Hackling ‚Üí Spinning',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Hemp'}] },
      { name:'Cork', type:'raw', category:'Organic',
        components:[], sources_natural:['Cork oak forests in Portugal, Spain'],
        properties:{ density:'0.12-0.24 g/cm¬≥', compressibility:'Very high', thermal_conductivity:'0.04 W/m¬∑K' },
        uses:['Wine stoppers','Flooring','Insulation','Bulletin boards','Gaskets'],
        processing:'Bark stripping (every 9 years) ‚Üí Boiling ‚Üí Drying ‚Üí Cutting ‚Üí Finishing',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Cork_(material)'}] },
      { name:'Granite', type:'raw', category:'Mineral',
        components:[], sources_natural:['Quarries worldwide ‚Äî India, Brazil, Norway, USA'],
        properties:{ density:'2.63-2.75 g/cm¬≥', compressive_strength:'100-250 MPa', hardness:'6-7 Mohs' },
        uses:['Countertops','Building facades','Monuments','Paving'],
        processing:'Quarrying ‚Üí Diamond wire cutting ‚Üí Polishing ‚Üí Finishing',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Granite'}] },
      { name:'Marble', type:'raw', category:'Mineral',
        components:[], sources_natural:['Quarries in Italy (Carrara), Greece, Turkey, India'],
        properties:{ density:'2.56 g/cm¬≥', compressive_strength:'60-170 MPa', hardness:'3-4 Mohs' },
        uses:['Sculpture','Countertops','Flooring','Building facades'],
        processing:'Quarrying ‚Üí Block cutting ‚Üí Gang sawing ‚Üí Polishing ‚Üí Finishing',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Marble'}] },
      { name:'Limestone', type:'raw', category:'Mineral',
        components:[], sources_natural:['Sedimentary deposits worldwide'],
        properties:{ density:'2.3-2.7 g/cm¬≥', composition:'Primarily CaCO‚ÇÉ', hardness:'3-4 Mohs' },
        uses:['Cement production','Building stone','Agriculture (pH adjustment)','Steel flux'],
        processing:'Quarrying ‚Üí Crushing ‚Üí Calcination (for quicklime) ‚Üí Hydration (for slaked lime)',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/crushed-stone-statistics-and-information'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Limestone'}] },
      { name:'Cement', type:'processed', category:'Mineral',
        components:['Limestone','Clay','Gypsum'], sources_natural:['Limestone and clay quarries'],
        properties:{ density:'1.5 g/cm¬≥ (powder)', setting_time:'30-90 minutes initial', compressive_strength:'20-60 MPa (with water)' },
        uses:['Concrete production','Mortar','Grout','Stucco'],
        processing:'Limestone + Clay ‚Üí Kiln (1450¬∞C) ‚Üí Clinker ‚Üí Grinding with gypsum ‚Üí Cement',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/cement-statistics-and-information'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Cement'}] },
      { name:'Brick', type:'processed', category:'Mineral',
        components:['Clay','Shale'], sources_natural:['Clay pits and shale quarries'],
        properties:{ density:'1.8-2.0 g/cm¬≥', compressive_strength:'10-35 MPa', water_absorption:'5-20%' },
        uses:['Walls','Paving','Chimneys','Fireplaces','Landscaping'],
        processing:'Clay ‚Üí Mixing ‚Üí Molding/Extrusion ‚Üí Drying ‚Üí Kiln firing (900-1100¬∞C) ‚Üí Brick',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Brick'}] },
      { name:'Porcelain', type:'processed', category:'Mineral',
        components:['Kaolin clay','Feldspar','Quartz'], sources_natural:['Kaolin deposits in China, UK, USA'],
        properties:{ density:'2.3-2.5 g/cm¬≥', hardness:'7 Mohs', water_absorption:'<0.5%', firing_temp:'1260-1400 ¬∞C' },
        uses:['Dinnerware','Tiles','Electrical insulators','Dental crowns','Bathroom fixtures'],
        processing:'Kaolin + Feldspar + Quartz ‚Üí Ball milling ‚Üí Shaping ‚Üí Bisque firing ‚Üí Glazing ‚Üí High firing',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Porcelain'}] },
      { name:'Fiberglass', type:'composite', category:'Mineral',
        components:['Glass fibers','Polymer resin'], sources_natural:['Sand (for glass) + petrochemicals (for resin)'],
        properties:{ density:'1.5-2.0 g/cm¬≥', tensile_strength:'1000-3500 MPa', thermal_conductivity:'Low' },
        uses:['Insulation','Boats','Car bodies','Tanks','Surfboards'],
        processing:'Glass melting ‚Üí Fiber drawing ‚Üí Resin impregnation ‚Üí Layup ‚Üí Curing',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Fiberglass'}] },
      { name:'Plastic (Polyethylene)', type:'processed', category:'Synthetic',
        components:['Ethylene (from petroleum)'], sources_natural:['Petroleum refineries'],
        properties:{ density:'0.91-0.97 g/cm¬≥', tensile_strength:'8-33 MPa', melting_point:'115-135 ¬∞C' },
        uses:['Packaging','Bottles','Bags','Pipes','Toys'],
        processing:'Crude oil ‚Üí Cracking ‚Üí Ethylene ‚Üí Polymerization ‚Üí Polyethylene pellets ‚Üí Molding',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Polyethylene'}] },
      { name:'PVC (Polyvinyl Chloride)', type:'processed', category:'Synthetic',
        components:['Vinyl chloride (from ethylene + chlorine)'], sources_natural:['Petroleum + salt (NaCl)'],
        properties:{ density:'1.3-1.45 g/cm¬≥', tensile_strength:'40-60 MPa', melting_point:'100-260 ¬∞C' },
        uses:['Pipes','Window frames','Flooring','Cable insulation','Medical tubing'],
        processing:'Ethylene + Chlorine ‚Üí Vinyl chloride ‚Üí Polymerization ‚Üí PVC resin ‚Üí Extrusion/Molding',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Polyvinyl_chloride'}] },
      { name:'Nylon', type:'processed', category:'Synthetic',
        components:['Adipic acid','Hexamethylenediamine'], sources_natural:['Petroleum-derived chemicals'],
        properties:{ density:'1.13-1.15 g/cm¬≥', tensile_strength:'70-85 MPa', melting_point:'220-260 ¬∞C' },
        uses:['Stockings','Rope','Gears','Carpet','Parachutes','Toothbrush bristles'],
        processing:'Petrochemicals ‚Üí Polymerization ‚Üí Nylon chips ‚Üí Melt spinning ‚Üí Nylon fiber',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Nylon'}] },
      { name:'Carbon Fiber', type:'composite', category:'Synthetic',
        components:['Polyacrylonitrile (PAN)','Epoxy resin'], sources_natural:['Petroleum-derived PAN precursor'],
        properties:{ density:'1.55-1.6 g/cm¬≥', tensile_strength:'3500-7000 MPa', modulus:'230-540 GPa' },
        uses:['Aerospace','Racing cars','Sporting goods','Wind turbine blades','Prosthetics'],
        processing:'PAN fiber ‚Üí Oxidation (200-300¬∞C) ‚Üí Carbonization (1000-3000¬∞C) ‚Üí Surface treatment ‚Üí Resin layup',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Carbon_fiber_reinforced_polymer'}] },
      { name:'Kevlar', type:'processed', category:'Synthetic',
        components:['Para-phenylenediamine','Terephthaloyl chloride'], sources_natural:['Petroleum-derived chemicals'],
        properties:{ density:'1.44 g/cm¬≥', tensile_strength:'3620 MPa', modulus:'112 GPa', heat_resistance:'Decomposes ~450 ¬∞C' },
        uses:['Body armor','Tires','Brake pads','Ropes','Helmets'],
        processing:'Condensation polymerization ‚Üí Wet spinning ‚Üí Drawing ‚Üí Kevlar fiber',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Kevlar'}] },
      { name:'Plywood', type:'composite', category:'Organic',
        components:['Wood veneers','Adhesive'], sources_natural:['Managed forests (softwood and hardwood)'],
        properties:{ density:'0.4-0.7 g/cm¬≥', tensile_strength:'20-70 MPa', thickness:'3-25 mm standard' },
        uses:['Furniture','Subfloors','Wall sheathing','Boats','Formwork'],
        processing:'Logs ‚Üí Peeling (rotary lathe) ‚Üí Veneer drying ‚Üí Gluing ‚Üí Cross-lamination ‚Üí Hot pressing',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Plywood'}] },
      { name:'MDF (Medium-Density Fiberboard)', type:'composite', category:'Organic',
        components:['Wood fibers','Urea-formaldehyde resin'], sources_natural:['Sawmill residues, recycled wood'],
        properties:{ density:'0.6-0.8 g/cm¬≥', tensile_strength:'0.5-1.0 MPa (internal bond)', surface:'Very smooth' },
        uses:['Furniture','Cabinets','Molding','Speaker boxes','Shelving'],
        processing:'Wood chipping ‚Üí Defibration ‚Üí Resin blending ‚Üí Mat forming ‚Üí Hot pressing ‚Üí Sanding',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Medium-density_fibreboard'}] },
      { name:'Coal', type:'raw', category:'Energy',
        components:[], sources_natural:['Coal mines in China, India, USA, Indonesia, Australia'],
        properties:{ energy_content:'24-35 MJ/kg', carbon_content:'60-95%', density:'1.1-1.5 g/cm¬≥' },
        uses:['Electricity generation','Steel production (coking coal)','Cement','Chemical feedstock'],
        processing:'Mining (surface or underground) ‚Üí Washing ‚Üí Crushing ‚Üí Screening ‚Üí Coal',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Coal'}] },
      { name:'Petroleum (Crude Oil)', type:'raw', category:'Energy',
        components:[], sources_natural:['Oil fields in Saudi Arabia, USA, Russia, Canada, Iraq'],
        properties:{ energy_content:'42-47 MJ/kg', density:'0.82-0.95 g/cm¬≥ (API 10-45¬∞)', viscosity:'Varies widely' },
        uses:['Gasoline','Diesel','Jet fuel','Plastics','Lubricants','Asphalt'],
        processing:'Extraction ‚Üí Desalting ‚Üí Fractional distillation ‚Üí Cracking ‚Üí Refining ‚Üí Products',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Petroleum'}] },
      { name:'Natural Gas', type:'raw', category:'Energy',
        components:[], sources_natural:['Gas fields in USA, Russia, Iran, Qatar, Canada'],
        properties:{ energy_content:'38-50 MJ/m¬≥', composition:'70-90% Methane', density:'0.0007-0.0009 g/cm¬≥' },
        uses:['Electricity generation','Heating','Cooking','Fertilizer (ammonia)','Hydrogen production'],
        processing:'Extraction ‚Üí Separation ‚Üí Dehydration ‚Üí Sweetening (H‚ÇÇS removal) ‚Üí Compression/Liquefaction',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Natural_gas'}] },
    ];

    let materialTypeFilter = '';
    let selectedMaterial = null;

    function renderMaterialPills() {
      const types = ['raw','processed','composite'];
      document.getElementById('material-type-pills').innerHTML =
        `<span class="filter-pill ${materialTypeFilter===''?'active':''}" onclick="materialTypeFilter='';renderMaterials()">All</span>` +
        types.map(t => `<span class="filter-pill ${materialTypeFilter===t?'active':''}" onclick="materialTypeFilter='${t}';renderMaterials()"><span class="material-type-badge mat-${t}">${t}</span></span>`).join('');
    }

    function renderMaterials() {
      renderMaterialPills();
      const filtered = MATERIALS.filter(m => !materialTypeFilter || m.type === materialTypeFilter);
      document.getElementById('materials-list').innerHTML = filtered.map(m => {
        const chain = m.processing.split('‚Üí').map(s => s.trim());
        const chainHtml = `<div class="processing-chain">${chain.map((s,i) => (i>0?'<span class="chain-arrow">‚Üí</span>':'')+`<span>${s}</span>`).join('')}</div>`;
        return `<div class="material-card" onclick="showMaterialDetail('${m.name.replace(/'/g,"\\'")}')">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.3rem;">
            <span style="font-weight:600;font-size:0.88rem;color:var(--text);">${m.name}</span>
            <span class="material-type-badge mat-${m.type}">${m.type}</span>
          </div>
          <div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.3rem;">${m.category}${m.components.length?' ¬∑ From: '+m.components.join(', '):''}</div>
          ${chainHtml}
        </div>`;
      }).join('');
    }

    function showMaterialDetail(name) {
      const m = MATERIALS.find(x => x.name === name);
      if (!m) return;
      if (selectedMaterial === name) { selectedMaterial = null; document.getElementById('material-detail-slot').innerHTML = ''; return; }
      selectedMaterial = name;
      const propsHtml = Object.entries(m.properties).map(([k,v]) => `<div class="el-prop"><dt>${k.replace(/_/g,' ')}</dt><dd>${v}</dd></div>`).join('');
      const srcLinks = m.references.map(r => `<a href="${r.url}" target="_blank" rel="noopener" style="color:var(--accent);font-size:0.75rem;">${r.name} ‚Üó</a>`).join(' ');
      document.getElementById('material-detail-slot').innerHTML = `
        <div class="element-detail">
          <div style="display:flex;justify-content:space-between;align-items:start;">
            <h3>${m.name} <span class="material-type-badge mat-${m.type}" style="vertical-align:middle;">${m.type}</span></h3>
            <button onclick="selectedMaterial=null;document.getElementById('material-detail-slot').innerHTML=''" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.1rem;">‚úï</button>
          </div>
          <div class="el-props">${propsHtml}</div>
          <div style="margin:0.6rem 0;"><strong style="font-size:0.75rem;color:var(--text-muted);">USES:</strong>
            <div style="display:flex;flex-wrap:wrap;gap:0.3rem;margin-top:0.3rem;">
              ${m.uses.map(u => `<span style="background:rgba(255,136,17,0.1);color:var(--accent);font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:10px;">${u}</span>`).join('')}
            </div>
          </div>
          <div style="margin:0.6rem 0;"><strong style="font-size:0.75rem;color:var(--text-muted);">PROCESSING:</strong>
            <div class="processing-chain" style="margin-top:0.3rem;font-size:0.8rem;">${m.processing.split('‚Üí').map((s,i) => (i>0?'<span class="chain-arrow">‚Üí</span>':'')+`<span>${s.trim()}</span>`).join('')}</div>
          </div>
          <div style="margin-top:0.5rem;">${srcLinks}</div>
        </div>`;
    }
    renderMaterials();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PERSONAL INVENTORY
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const INV_CATEGORIES = [
      {id:'Vehicle',icon:'üöó'},{id:'Clothing',icon:'üëï'},{id:'Electronics',icon:'üíª'},{id:'Tools',icon:'üîß'},
      {id:'Furniture',icon:'ü™ë'},{id:'Kitchen',icon:'üç≥'},{id:'Books/Media',icon:'üìö'},{id:'Gaming',icon:'üéÆ'},
      {id:'Home',icon:'üè†'},{id:'Other',icon:'üì¶'}
    ];

    (function populateInvCategories() {
      const sel = document.getElementById('inv-category');
      const filterSel = document.getElementById('inv-category-filter');
      INV_CATEGORIES.forEach(c => {
        sel.innerHTML += `<option value="${c.id}">${c.icon} ${c.id}</option>`;
        filterSel.innerHTML += `<option value="${c.id}">${c.icon} ${c.id}</option>`;
      });
    })();

    function loadInventory() { try { return JSON.parse(localStorage.getItem('humanity_inventory')) || []; } catch { return []; } }
    function saveInventory(items) { localStorage.setItem('humanity_inventory', JSON.stringify(items)); }

    function renderInventory() {
      const items = loadInventory();
      const catFilter = document.getElementById('inv-category-filter').value;
      const search = (document.getElementById('inv-search').value || '').toLowerCase();
      const filtered = items.filter(item => {
        if (catFilter && item.category !== catFilter) return false;
        if (search && !item.name.toLowerCase().includes(search) && !(item.tags||[]).some(t => t.toLowerCase().includes(search)) && !(item.category||'').toLowerCase().includes(search)) return false;
        return true;
      });
      const catIcon = (id) => (INV_CATEGORIES.find(c => c.id === id) || {icon:'üì¶'}).icon;
      document.getElementById('inventory-list').innerHTML = filtered.length === 0
        ? '<div style="color:var(--text-muted);font-size:0.82rem;font-style:italic;padding:1rem;text-align:center;grid-column:1/-1;">No items yet ‚Äî click "+ Add Item" to start</div>'
        : filtered.map(item => `
          <div class="inv-item">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.3rem;">
              <span style="font-weight:600;font-size:0.88rem;">${catIcon(item.category)} ${escHtml(item.name)}</span>
              <div style="display:flex;gap:0.3rem;">
                <button onclick="listInventoryForSale('${item.id}')" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:0.65rem;" title="List for Sale">üì¢</button>
                <button onclick="editInventoryItem('${item.id}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.75rem;" title="Edit">‚úèÔ∏è</button>
                <button onclick="deleteInventoryItem('${item.id}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.75rem;" title="Delete">üóëÔ∏è</button>
              </div>
            </div>
            <div style="font-size:0.72rem;color:var(--text-muted);">
              ${item.category}${item.subcategory?' ¬∑ '+escHtml(item.subcategory):''} ¬∑ Qty: ${item.quantity||1} ¬∑ ${item.condition||'Good'}
            </div>
            ${item.location?`<div style="font-size:0.7rem;color:var(--text-muted);margin-top:0.15rem;">üìç ${escHtml(item.location)}</div>`:''}
            ${item.description?`<div style="font-size:0.75rem;color:var(--text);margin-top:0.3rem;">${escHtml(item.description)}</div>`:''}
            ${(item.tags||[]).length?`<div style="display:flex;flex-wrap:wrap;gap:0.2rem;margin-top:0.3rem;">${item.tags.map(t=>`<span style="background:rgba(255,255,255,0.05);font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:8px;color:var(--text-muted);">#${escHtml(t)}</span>`).join('')}</div>`:''}
          </div>`).join('');
    }

    function openInventoryModal(editId) {
      document.getElementById('inv-modal-title').textContent = editId ? 'Edit Item' : 'Add Item';
      document.getElementById('inv-edit-id').value = editId || '';
      if (editId) {
        const item = loadInventory().find(i => i.id === editId);
        if (!item) return;
        document.getElementById('inv-name').value = item.name || '';
        document.getElementById('inv-category').value = item.category || 'Other';
        document.getElementById('inv-subcategory').value = item.subcategory || '';
        document.getElementById('inv-description').value = item.description || '';
        document.getElementById('inv-quantity').value = item.quantity || 1;
        document.getElementById('inv-condition').value = item.condition || 'Good';
        document.getElementById('inv-acquired').value = item.acquired || '';
        document.getElementById('inv-location').value = item.location || '';
        document.getElementById('inv-value').value = item.value || '';
        document.getElementById('inv-notes').value = item.notes || '';
        document.getElementById('inv-tags').value = (item.tags||[]).join(', ');
      } else {
        ['inv-name','inv-subcategory','inv-description','inv-acquired','inv-location','inv-value','inv-notes','inv-tags'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('inv-quantity').value = 1;
        document.getElementById('inv-condition').value = 'Good';
        document.getElementById('inv-category').value = 'Other';
      }
      document.getElementById('inv-modal').classList.add('open');
    }
    function closeInventoryModal() { document.getElementById('inv-modal').classList.remove('open'); }
    function editInventoryItem(id) { openInventoryModal(id); }
    function deleteInventoryItem(id) {
      if (!confirm('Delete this item?')) return;
      saveInventory(loadInventory().filter(i => i.id !== id));
      renderInventory();
    }
    function saveInventoryItem() {
      const name = document.getElementById('inv-name').value.trim();
      if (!name) { document.getElementById('inv-name').style.borderColor = '#e55'; return; }
      const editId = document.getElementById('inv-edit-id').value;
      const items = loadInventory();
      const item = {
        id: editId || Date.now().toString(36) + Math.random().toString(36).slice(2,6),
        name,
        category: document.getElementById('inv-category').value,
        subcategory: document.getElementById('inv-subcategory').value.trim(),
        description: document.getElementById('inv-description').value.trim(),
        quantity: parseInt(document.getElementById('inv-quantity').value) || 1,
        condition: document.getElementById('inv-condition').value,
        acquired: document.getElementById('inv-acquired').value.trim(),
        location: document.getElementById('inv-location').value.trim(),
        value: document.getElementById('inv-value').value.trim(),
        notes: document.getElementById('inv-notes').value.trim(),
        tags: document.getElementById('inv-tags').value.split(',').map(t => t.trim()).filter(Boolean),
      };
      if (editId) {
        const idx = items.findIndex(i => i.id === editId);
        if (idx >= 0) items[idx] = item; else items.push(item);
      } else {
        items.push(item);
      }
      saveInventory(items);
      closeInventoryModal();
      renderInventory();
    }

    function exportInventory() {
      const data = JSON.stringify(loadInventory(), null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'humanity-inventory-' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
    }
    function importInventory(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          if (!Array.isArray(imported)) throw new Error('Not an array');
          const existing = loadInventory();
          const merged = [...existing, ...imported.map(i => ({...i, id: i.id || Date.now().toString(36)+Math.random().toString(36).slice(2,6)}))];
          saveInventory(merged);
          renderInventory();
          alert('Imported ' + imported.length + ' items.');
        } catch(err) { alert('Import failed: ' + err.message); }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // Close inv modal on backdrop
    document.getElementById('inv-modal').addEventListener('click', function(e) { if (e.target === this) closeInventoryModal(); });

    renderInventory();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MARKETPLACE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const STORE_DIRECTORY = [
      { name: "Amazon", url: "https://amazon.com", icon: "üè™", category: "General", description: "Everything store" },
      { name: "Walmart", url: "https://walmart.com", icon: "üè™", category: "General", description: "Everyday low prices" },
      { name: "Etsy", url: "https://etsy.com", icon: "üé®", category: "Handmade & Vintage", description: "Handmade, vintage, and unique goods" },
      { name: "eBay", url: "https://ebay.com", icon: "üè∑Ô∏è", category: "Auctions & Resale", description: "Buy and sell anything" },
      { name: "Newegg", url: "https://newegg.com", icon: "üíª", category: "Electronics", description: "Computer hardware and electronics" },
      { name: "Home Depot", url: "https://homedepot.com", icon: "üî®", category: "Home & Garden", description: "Home improvement and tools" },
      { name: "REI", url: "https://rei.com", icon: "‚õ∫", category: "Outdoors", description: "Outdoor gear and clothing" },
      { name: "Steam", url: "https://store.steampowered.com", icon: "üéÆ", category: "Gaming", description: "PC games and software" },
      { name: "GOG", url: "https://gog.com", icon: "üéÆ", category: "Gaming", description: "DRM-free games" },
      { name: "Bandcamp", url: "https://bandcamp.com", icon: "üéµ", category: "Music", description: "Independent music" },
      { name: "Ko-fi", url: "https://ko-fi.com", icon: "‚òï", category: "Creator Support", description: "Support creators directly" },
      { name: "GitHub Sponsors", url: "https://github.com/sponsors", icon: "üíù", category: "Creator Support", description: "Fund open source developers" },
    ];

    const LISTING_CATEGORIES = ['Electronics','Vehicles','Clothing','Tools','Furniture','Home','Books/Media','Gaming','Sports','Crafts','Food/Garden','Services','Other'];
    const LISTING_CONDITIONS = ['New','Like New','Good','Fair','Poor','N/A'];
    const CATEGORY_COLORS = {Electronics:'#08f',Vehicles:'#f80',Clothing:'#f0a',Tools:'#fa0',Furniture:'#a66',Home:'#4a8','Books/Media':'#84f',Gaming:'#0cf',Sports:'#4c4',Crafts:'#c4a','Food/Garden':'#6a4',Services:'#48f',Other:'#888'};

    let marketListings = [];
    let marketWs = null;
    let ws = null; // Alias for streaming code to use
    let marketMyKey = null;
    let marketMyName = null;
    let marketMyRole = '';
    let marketCurrentSection = 'marketplace';

    function showMarketSection(section) {
      marketCurrentSection = section;
      ['marketplace','stores','mylistings'].forEach(s => {
        const el = document.getElementById('market-section-' + s);
        const btn = document.getElementById('market-nav-' + s);
        if (el) el.style.display = s === section ? '' : 'none';
        if (btn) btn.className = s === section ? 'btn btn-clickable' : 'btn';
      });
      const createBtn = document.getElementById('market-create-btn');
      if (createBtn) createBtn.style.display = (section === 'marketplace' && canCreateListing()) ? '' : 'none';
      if (section === 'stores') renderStoreDirectory();
      if (section === 'mylistings') renderMyListings();
      if (section === 'marketplace') renderMarketListings();
    }

    function canCreateListing() {
      return marketMyRole === 'verified' || marketMyRole === 'donor' || marketMyRole === 'mod' || marketMyRole === 'admin';
    }

    function marketConnect() {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      marketWs = new WebSocket(proto + '//' + location.host + '/ws');
      marketWs.onopen = () => {
        const storedKey = localStorage.getItem('humanity_key');
        const storedName = localStorage.getItem('humanity_name');
        if (storedKey) {
          marketMyKey = storedKey;
          marketMyName = storedName;
          marketWs.send(JSON.stringify({ type: 'identify', public_key: storedKey, display_name: storedName || null }));
        } else {
          marketMyKey = 'viewer_' + Math.random().toString(36).slice(2, 10);
          marketWs.send(JSON.stringify({ type: 'identify', public_key: marketMyKey, display_name: null }));
        }
      };
      ws = marketWs; // Alias for streaming code
      marketWs.onmessage = (e) => {
        try {
          const msg = JSON.parse(e.data);
          handleMarketMessage(msg);
          // Route stream messages
          if (msg.type && msg.type.startsWith('stream_')) {
            streamHandleMessage(msg);
          }
        } catch {}
      };
      marketWs.onclose = () => { setTimeout(marketConnect, 3000); };
      marketWs.onerror = () => {};
    }

    function handleMarketMessage(msg) {
      switch (msg.type) {
        case 'peer_list':
          if (msg.peers && marketMyKey) {
            const me = msg.peers.find(p => p.public_key === marketMyKey);
            if (me) {
              marketMyRole = me.role || '';
              marketMyName = me.display_name || marketMyName;
            }
          }
          updateMarketPermissions();
          // Request listings
          if (marketWs && marketWs.readyState === 1) {
            marketWs.send(JSON.stringify({ type: 'listing_browse' }));
          }
          // Request stream info
          streamRequestInfo();
          break;
        case 'listing_list':
          marketListings = msg.listings || [];
          renderMarketListings();
          renderMyListings();
          break;
        case 'listing_new':
          if (msg.listing) {
            const existing = marketListings.findIndex(l => l.id === msg.listing.id);
            if (existing >= 0) marketListings[existing] = msg.listing;
            else marketListings.unshift(msg.listing);
            renderMarketListings();
            renderMyListings();
          }
          break;
        case 'listing_updated':
          if (msg.listing) {
            const idx = marketListings.findIndex(l => l.id === msg.listing.id);
            if (idx >= 0) marketListings[idx] = msg.listing;
            renderMarketListings();
            renderMyListings();
          }
          break;
        case 'listing_deleted':
          if (msg.id) {
            marketListings = marketListings.filter(l => l.id !== msg.id);
            renderMarketListings();
            renderMyListings();
          }
          break;
        case 'system':
          // Ignore system messages in market context
          break;
      }
    }

    function updateMarketPermissions() {
      const createBtn = document.getElementById('market-create-btn');
      if (createBtn) createBtn.style.display = (marketCurrentSection === 'marketplace' && canCreateListing()) ? '' : 'none';
    }

    function renderMarketListings() {
      const search = (document.getElementById('market-search').value || '').toLowerCase();
      const catFilter = document.getElementById('market-category-filter').value;
      const condFilter = document.getElementById('market-condition-filter').value;
      const sort = document.getElementById('market-sort').value;

      let filtered = marketListings.filter(l => {
        if (l.status !== 'active') return false;
        if (catFilter && l.category !== catFilter) return false;
        if (condFilter && l.condition !== condFilter) return false;
        if (search && !l.title.toLowerCase().includes(search) && !(l.description||'').toLowerCase().includes(search) && !(l.seller_name||'').toLowerCase().includes(search)) return false;
        return true;
      });

      if (sort === 'oldest') filtered.sort((a, b) => (a.created_at || '').localeCompare(b.created_at || ''));
      else if (sort === 'alpha') filtered.sort((a, b) => a.title.localeCompare(b.title));
      else filtered.sort((a, b) => (b.created_at || '').localeCompare(a.created_at || ''));

      const grid = document.getElementById('market-listings-grid');
      const empty = document.getElementById('market-listings-empty');
      if (filtered.length === 0) {
        grid.innerHTML = '';
        empty.style.display = '';
      } else {
        empty.style.display = 'none';
        grid.innerHTML = filtered.map(l => renderListingCard(l, false)).join('');
      }
    }

    function renderListingCard(l, showActions) {
      const catColor = CATEGORY_COLORS[l.category] || '#888';
      const isMine = l.seller_key === marketMyKey;
      const isAdmin = marketMyRole === 'admin' || marketMyRole === 'mod';
      const actions = (isMine || showActions) ? `
        <div style="display:flex;gap:0.3rem;margin-top:0.5rem;">
          ${isMine?`<button onclick="editListing('${l.id}')" style="flex:1;padding:0.25rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:4px;color:var(--text-muted);cursor:pointer;font-size:0.7rem;">‚úèÔ∏è Edit</button>`:''}
          ${isMine?`<button onclick="markListingSold('${l.id}')" style="flex:1;padding:0.25rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:4px;color:var(--success);cursor:pointer;font-size:0.7rem;">‚úÖ Sold</button>`:''}
          ${(isMine||isAdmin)?`<button onclick="deleteListing('${l.id}')" style="flex:1;padding:0.25rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:4px;color:var(--error);cursor:pointer;font-size:0.7rem;">üóëÔ∏è Delete</button>`:''}
        </div>` : '';
      const statusBadge = l.status === 'sold' ? '<span style="background:#4a8;color:#fff;font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:4px;margin-left:0.3rem;">SOLD</span>' :
                          l.status === 'withdrawn' ? '<span style="background:#888;color:#fff;font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:4px;margin-left:0.3rem;">WITHDRAWN</span>' : '';
      return `
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:10px;overflow:hidden;cursor:pointer;transition:border-color 0.2s;" onmouseenter="this.style.borderColor='rgba(255,136,17,0.3)'" onmouseleave="this.style.borderColor='var(--border)'" onclick="showListingDetail('${l.id}')">
          <div style="height:120px;background:linear-gradient(135deg,rgba(255,255,255,0.02),rgba(255,255,255,0.06));display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:2rem;">üì¶</div>
          <div style="padding:0.8rem;">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.3rem;">
              <span style="font-weight:600;font-size:0.85rem;color:var(--text);flex:1;">${escHtml(l.title)}${statusBadge}</span>
            </div>
            <div style="font-size:0.95rem;font-weight:700;color:var(--accent);margin-bottom:0.3rem;">${escHtml(l.price || 'Contact for price')}</div>
            <div style="display:flex;gap:0.3rem;flex-wrap:wrap;margin-bottom:0.3rem;">
              <span style="background:${catColor}22;color:${catColor};font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:4px;">${escHtml(l.category)}</span>
              ${l.condition && l.condition !== 'N/A' ? `<span style="background:rgba(255,255,255,0.05);color:var(--text-muted);font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:4px;">${escHtml(l.condition)}</span>` : ''}
            </div>
            <div style="font-size:0.72rem;color:var(--text-muted);">by ${escHtml(l.seller_name || 'Anonymous')}</div>
            ${l.location ? `<div style="font-size:0.68rem;color:var(--text-muted);">üìç ${escHtml(l.location)}</div>` : ''}
            ${actions}
          </div>
        </div>`;
    }

    function showListingDetail(id) {
      const l = marketListings.find(x => x.id === id);
      if (!l) return;
      const isMine = l.seller_key === marketMyKey;
      const isAdmin = marketMyRole === 'admin' || marketMyRole === 'mod';
      const catColor = CATEGORY_COLORS[l.category] || '#888';
      const contactBtn = !isMine ? `<button onclick="contactSeller('${escHtml(l.seller_key)}','${escHtml(l.seller_name||'Seller')}');closeListingDetail()" style="width:100%;padding:0.6rem;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:0.9rem;font-weight:600;margin-top:1rem;">üí¨ Contact Seller</button>` : '';
      document.getElementById('listing-detail-content').innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:start;">
          <h2 style="color:var(--text);margin:0;font-size:1.1rem;">${escHtml(l.title)}</h2>
          <button onclick="closeListingDetail()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.2rem;">‚úï</button>
        </div>
        <div style="font-size:1.3rem;font-weight:700;color:var(--accent);margin:0.8rem 0;">${escHtml(l.price || 'Contact for price')}</div>
        <div style="display:flex;gap:0.4rem;flex-wrap:wrap;margin-bottom:0.8rem;">
          <span style="background:${catColor}22;color:${catColor};font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:4px;">${escHtml(l.category)}</span>
          ${l.condition ? `<span style="background:rgba(255,255,255,0.05);color:var(--text-muted);font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:4px;">${escHtml(l.condition)}</span>` : ''}
          ${l.status !== 'active' ? `<span style="background:${l.status==='sold'?'#4a8':'#888'};color:#fff;font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:4px;">${l.status.toUpperCase()}</span>` : ''}
        </div>
        ${l.description ? `<div style="font-size:0.85rem;color:var(--text);line-height:1.5;margin-bottom:0.8rem;white-space:pre-wrap;">${escHtml(l.description)}</div>` : ''}
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;font-size:0.8rem;color:var(--text-muted);">
          <div>üë§ <strong>${escHtml(l.seller_name || 'Anonymous')}</strong></div>
          ${l.location ? `<div>üìç ${escHtml(l.location)}</div>` : '<div></div>'}
          ${l.payment_methods ? `<div>üí≥ ${escHtml(l.payment_methods)}</div>` : '<div></div>'}
          <div>üìÖ ${l.created_at ? new Date(l.created_at).toLocaleDateString() : 'Unknown'}</div>
        </div>
        ${contactBtn}
        ${isMine || isAdmin ? `
        <div style="display:flex;gap:0.5rem;margin-top:0.8rem;">
          ${isMine?`<button onclick="editListing('${l.id}');closeListingDetail()" class="btn" style="flex:1;min-width:auto;min-height:32px;padding:0.25rem;font-size:0.8rem;">‚úèÔ∏è Edit</button>`:''}
          ${isMine?`<button onclick="markListingSold('${l.id}');closeListingDetail()" class="btn" style="flex:1;min-width:auto;min-height:32px;padding:0.25rem;font-size:0.8rem;color:var(--success);">‚úÖ Mark Sold</button>`:''}
          <button onclick="deleteListing('${l.id}');closeListingDetail()" class="btn" style="flex:1;min-width:auto;min-height:32px;padding:0.25rem;font-size:0.8rem;color:var(--error);">üóëÔ∏è Delete</button>
        </div>` : ''}
      `;
      document.getElementById('listing-detail-modal').style.display = '';
    }

    function closeListingDetail() {
      document.getElementById('listing-detail-modal').style.display = 'none';
    }

    function contactSeller(sellerKey, sellerName) {
      // Navigate to chat and open DM ‚Äî use chat's existing DM system
      // We'll switch to chat tab and trigger a DM open via stored intent
      localStorage.setItem('dm_intent', JSON.stringify({ key: sellerKey, name: sellerName }));
      window.location.href = '/chat';
    }

    function openListingModal(prefill) {
      if (!canCreateListing()) {
        alert('You must be verified to create listings. Ask an admin to verify you.');
        return;
      }
      document.getElementById('listing-modal-title').textContent = prefill && prefill.editId ? 'Edit Listing' : 'Create Listing';
      document.getElementById('listing-edit-id').value = (prefill && prefill.editId) || '';
      document.getElementById('listing-title').value = (prefill && prefill.title) || '';
      document.getElementById('listing-description').value = (prefill && prefill.description) || '';
      document.getElementById('listing-category').value = (prefill && prefill.category) || 'Other';
      document.getElementById('listing-condition').value = (prefill && prefill.condition) || 'Good';
      document.getElementById('listing-price').value = (prefill && prefill.price) || '';
      document.getElementById('listing-payment').value = (prefill && prefill.payment_methods) || '';
      document.getElementById('listing-location').value = (prefill && prefill.location) || '';
      document.getElementById('listing-modal').style.display = '';
    }

    function closeListingModal() {
      document.getElementById('listing-modal').style.display = 'none';
    }

    function submitListing() {
      const title = document.getElementById('listing-title').value.trim();
      if (!title) { document.getElementById('listing-title').style.borderColor = '#e55'; return; }
      const editId = document.getElementById('listing-edit-id').value;
      const data = {
        title,
        description: document.getElementById('listing-description').value.trim(),
        category: document.getElementById('listing-category').value,
        condition: document.getElementById('listing-condition').value,
        price: document.getElementById('listing-price').value.trim(),
        payment_methods: document.getElementById('listing-payment').value.trim(),
        location: document.getElementById('listing-location').value.trim(),
      };
      if (editId) {
        data.id = editId;
        if (marketWs && marketWs.readyState === 1) {
          marketWs.send(JSON.stringify({ type: 'listing_update', ...data }));
        }
      } else {
        data.id = Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
        if (marketWs && marketWs.readyState === 1) {
          marketWs.send(JSON.stringify({ type: 'listing_create', ...data }));
        }
      }
      closeListingModal();
    }

    function editListing(id) {
      const l = marketListings.find(x => x.id === id);
      if (!l) return;
      openListingModal({
        editId: l.id,
        title: l.title,
        description: l.description,
        category: l.category,
        condition: l.condition,
        price: l.price,
        payment_methods: l.payment_methods,
        location: l.location,
      });
    }

    function markListingSold(id) {
      if (!confirm('Mark this listing as sold?')) return;
      if (marketWs && marketWs.readyState === 1) {
        const l = marketListings.find(x => x.id === id);
        if (l) marketWs.send(JSON.stringify({ type: 'listing_update', id, title: l.title, description: l.description, category: l.category, condition: l.condition, price: l.price, payment_methods: l.payment_methods, location: l.location, status: 'sold' }));
      }
    }

    function deleteListing(id) {
      if (!confirm('Delete this listing?')) return;
      if (marketWs && marketWs.readyState === 1) {
        marketWs.send(JSON.stringify({ type: 'listing_delete', id }));
      }
    }

    function renderMyListings() {
      const mine = marketListings.filter(l => l.seller_key === marketMyKey);
      const grid = document.getElementById('my-listings-grid');
      const empty = document.getElementById('my-listings-empty');
      if (mine.length === 0) {
        grid.innerHTML = '';
        empty.style.display = '';
      } else {
        empty.style.display = 'none';
        grid.innerHTML = mine.map(l => renderListingCard(l, true)).join('');
      }
    }

    // Store Directory
    function renderStoreDirectory() {
      const filter = document.getElementById('store-category-filter').value;
      const filtered = filter ? STORE_DIRECTORY.filter(s => s.category === filter) : STORE_DIRECTORY;
      document.getElementById('store-directory-grid').innerHTML = filtered.map(s => `
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:1rem;transition:border-color 0.2s;" onmouseenter="this.style.borderColor='rgba(255,136,17,0.3)'" onmouseleave="this.style.borderColor='var(--border)'">
          <div style="font-size:1.5rem;margin-bottom:0.4rem;">${s.icon}</div>
          <div style="font-weight:600;font-size:0.9rem;color:var(--text);margin-bottom:0.2rem;">${escHtml(s.name)}</div>
          <div style="font-size:0.7rem;color:var(--text-muted);margin-bottom:0.4rem;">${escHtml(s.category)}</div>
          <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.6rem;">${escHtml(s.description)}</div>
          <a href="${s.url}" target="_blank" rel="noopener" style="display:inline-block;padding:0.3rem 0.8rem;background:var(--accent);color:#fff;border-radius:6px;text-decoration:none;font-size:0.75rem;font-weight:600;">Visit Store ‚Üí</a>
        </div>`).join('');
    }

    // Populate store category filter
    (function() {
      const cats = [...new Set(STORE_DIRECTORY.map(s => s.category))];
      const sel = document.getElementById('store-category-filter');
      cats.forEach(c => { sel.innerHTML += `<option value="${escHtml(c)}">${escHtml(c)}</option>`; });
    })();

    // Inventory ‚Üí Listing bridge
    function listInventoryForSale(itemId) {
      const item = loadInventory().find(i => i.id === itemId);
      if (!item) return;
      // Map inventory category to marketplace category
      const catMap = {'Vehicle':'Vehicles','Clothing':'Clothing','Electronics':'Electronics','Tools':'Tools','Furniture':'Furniture','Kitchen':'Home','Books/Media':'Books/Media','Gaming':'Gaming','Home':'Home','Other':'Other'};
      const category = catMap[item.category] || 'Other';
      // Switch to market tab
      switchTab('market');
      showMarketSection('marketplace');
      openListingModal({
        title: item.name,
        description: (item.description || '') + (item.notes ? '\n\n' + item.notes : ''),
        category: category,
        condition: item.condition || 'Good',
      });
    }

    // Connect marketplace WS when market tab is shown
    let marketConnected = false;
    // Use a MutationObserver on the tab to detect when it becomes active
    const marketTabEl = document.getElementById('tab-market');
    if (marketTabEl) {
      new MutationObserver(() => {
        if (marketTabEl.classList.contains('active') && !marketConnected) {
          marketConnected = true;
          marketConnect();
        }
      }).observe(marketTabEl, { attributes: true, attributeFilter: ['class'] });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UNIVERSAL SEARCH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function universalSearch(query) {
      const results = document.getElementById('universal-search-results');
      if (!query || query.length < 2) { results.innerHTML = ''; return; }
      const q = query.toLowerCase();
      const hits = [];
      // Elements
      ELEMENTS.filter(e => e.name.toLowerCase().includes(q) || e.symbol.toLowerCase().includes(q) || String(e.number).includes(q))
        .forEach(e => hits.push({ label: `${e.symbol} ‚Äî ${e.name} (#${e.number})`, badge: 'Element', color: '#4caf50', action: () => { showElementDetail(e.symbol); } }));
      // Materials
      MATERIALS.filter(m => m.name.toLowerCase().includes(q) || m.category.toLowerCase().includes(q))
        .forEach(m => hits.push({ label: m.name + ' (' + m.type + ')', badge: 'Material', color: '#42a5f5', action: () => { showMaterialDetail(m.name); } }));
      // Inventory
      loadInventory().filter(i => i.name.toLowerCase().includes(q) || (i.category||'').toLowerCase().includes(q) || (i.tags||[]).some(t => t.toLowerCase().includes(q)))
        .forEach(i => hits.push({ label: i.name + (i.category ? ' ¬∑ ' + i.category : ''), badge: 'Inventory', color: '#ffa726', action: () => { editInventoryItem(i.id); } }));
      results.innerHTML = hits.length === 0 ? '<div style="padding:0.8rem;text-align:center;font-size:0.82rem;color:var(--text-muted);">No results</div>'
        : hits.slice(0, 20).map((h, i) => `<div class="catalog-result-item" onclick="universalSearchResults[${i}]()">
            <span class="catalog-result-badge" style="background:${h.color}22;color:${h.color};">${h.badge}</span>
            <span style="color:var(--text);">${escHtml(h.label)}</span>
          </div>`).join('');
      window.universalSearchResults = hits.slice(0, 20).map(h => h.action);
    }

    // ‚îÄ‚îÄ TODO ‚îÄ‚îÄ
    function loadTodos() {
      try { return JSON.parse(localStorage.getItem('humanity_todos')) || []; } catch { return []; }
    }
    function saveTodos(todos) { localStorage.setItem('humanity_todos', JSON.stringify(todos)); }

    function renderTodos() {
      const todos = loadTodos();
      const list = document.getElementById('todo-list');
      const active = todos.filter(t => !t.completed);
      const done = todos.filter(t => t.completed);
      const sorted = [...active, ...done];
      list.innerHTML = sorted.length === 0 ? '<div style="color:var(--text-muted);font-size:0.8rem;font-style:italic;padding:0.5rem;">No tasks yet</div>' : '';
      sorted.forEach(t => {
        const div = document.createElement('div');
        div.className = 'todo-item' + (t.completed ? ' completed' : '');
        div.innerHTML = `<input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleTodo('${t.id}')"><span class="todo-text">${escHtml(t.text)}</span><button class="todo-delete" onclick="deleteTodo('${t.id}')" title="Delete">‚úï</button>`;
        list.appendChild(div);
      });
    }

    function addTodo() {
      const input = document.getElementById('todo-input');
      const text = input.value.trim();
      if (!text) return;
      const todos = loadTodos();
      todos.push({ id: Date.now().toString(36), text, completed: false, createdAt: new Date().toISOString() });
      saveTodos(todos);
      input.value = '';
      renderTodos();
    }

    function toggleTodo(id) {
      const todos = loadTodos();
      const t = todos.find(x => x.id === id);
      if (t) t.completed = !t.completed;
      saveTodos(todos);
      renderTodos();
    }

    function deleteTodo(id) {
      saveTodos(loadTodos().filter(x => x.id !== id));
      renderTodos();
    }

    // ‚îÄ‚îÄ NOTES ‚îÄ‚îÄ
    let currentNoteId = null;

    function loadNotes() {
      try { return JSON.parse(localStorage.getItem('humanity_notes')) || []; } catch { return []; }
    }
    function saveNotes(notes) { localStorage.setItem('humanity_notes', JSON.stringify(notes)); }

    function renderNotes() {
      const notes = loadNotes();
      const list = document.getElementById('notes-list');
      list.innerHTML = notes.length === 0 ? '<div style="color:var(--text-muted);font-size:0.8rem;font-style:italic;padding:0.3rem;">No notes yet</div>' : '';
      notes.forEach(n => {
        const div = document.createElement('div');
        div.className = 'note-item' + (n.id === currentNoteId ? ' active' : '');
        div.innerHTML = `<span onclick="selectNote('${n.id}')">${escHtml(n.title || 'Untitled')}</span><button class="note-delete" onclick="event.stopPropagation();deleteNote('${n.id}')" title="Delete">‚úï</button>`;
        div.querySelector('span').style.flex = '1';
        div.querySelector('span').style.cursor = 'pointer';
        list.appendChild(div);
      });
    }

    function addNote() {
      const notes = loadNotes();
      const id = Date.now().toString(36);
      notes.unshift({ id, title: '', content: '', updatedAt: new Date().toISOString() });
      saveNotes(notes);
      selectNote(id);
    }

    function selectNote(id) {
      currentNoteId = id;
      const notes = loadNotes();
      const note = notes.find(n => n.id === id);
      const editor = document.getElementById('notes-editor');
      if (note) {
        document.getElementById('note-title').value = note.title;
        document.getElementById('note-content').value = note.content;
        editor.style.display = 'block';
      }
      renderNotes();
    }

    function saveCurrentNote() {
      if (!currentNoteId) return;
      const notes = loadNotes();
      const note = notes.find(n => n.id === currentNoteId);
      if (note) {
        note.title = document.getElementById('note-title').value;
        note.content = document.getElementById('note-content').value;
        note.updatedAt = new Date().toISOString();
        saveNotes(notes);
        renderNotes();
      }
    }

    function deleteNote(id) {
      saveNotes(loadNotes().filter(n => n.id !== id));
      if (currentNoteId === id) {
        currentNoteId = null;
        document.getElementById('notes-editor').style.display = 'none';
      }
      renderNotes();
    }

    // ‚îÄ‚îÄ GARDEN ‚îÄ‚îÄ
    function loadGarden() {
      try { return JSON.parse(localStorage.getItem('humanity_garden')) || { size: 4, plots: {} }; } catch { return { size: 4, plots: {} }; }
    }
    function saveGarden(g) { localStorage.setItem('humanity_garden', JSON.stringify(g)); }

    function renderGarden() {
      const g = loadGarden();
      const grid = document.getElementById('garden-grid');
      const sizeSelect = document.getElementById('garden-size');
      sizeSelect.value = g.size || 4;
      grid.style.gridTemplateColumns = `repeat(${g.size}, 1fr)`;
      grid.innerHTML = '';
      for (let i = 0; i < g.size * g.size; i++) {
        const plot = document.createElement('div');
        const data = g.plots[i];
        plot.className = 'garden-plot' + (data ? ' planted' : '');
        plot.textContent = data ? data.plant : 'üå±';
        plot.title = data ? `${data.plant}${data.planted ? '\nPlanted: ' + data.planted : ''}` : 'Empty plot ‚Äî click to plant';
        plot.onclick = () => editPlot(i);
        grid.appendChild(plot);
      }
    }

    function editPlot(index) {
      const g = loadGarden();
      const existing = g.plots[index];
      const plant = prompt('What is planted here?' + (existing ? ' (clear to remove)' : ''), existing ? existing.plant : '');
      if (plant === null) return;
      if (plant.trim() === '') {
        delete g.plots[index];
      } else {
        const planted = existing ? existing.planted : new Date().toISOString().split('T')[0];
        g.plots[index] = { plant: plant.trim(), planted };
      }
      saveGarden(g);
      renderGarden();
    }

    function resizeGarden() {
      const g = loadGarden();
      g.size = parseInt(document.getElementById('garden-size').value) || 4;
      saveGarden(g);
      renderGarden();
    }

    function escHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    // Init reality tab
    renderTodos();
    renderNotes();
    renderGarden();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FANTASY TAB
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // ‚îÄ‚îÄ Card collapse (reuse pattern) ‚îÄ‚îÄ
    function toggleFantasyCard(id) {
      const card = document.getElementById('fantasy-' + id);
      if (card) card.classList.toggle('collapsed');
      localStorage.setItem('fantasy_collapsed_' + id, card.classList.contains('collapsed'));
    }
    ['worldmap', 'character', 'lore', 'achievements'].forEach(id => {
      if (localStorage.getItem('fantasy_collapsed_' + id) === 'true') {
        const card = document.getElementById('fantasy-' + id);
        if (card) card.classList.add('collapsed');
      }
    });

    // ‚îÄ‚îÄ World Map (procedural grid) ‚îÄ‚îÄ
    (function drawWorldMap() {
      const canvas = document.getElementById('world-map-canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      // Seed-based pseudo-random
      let seed = 42;
      function rng() { seed = (seed * 16807 + 0) % 2147483647; return (seed - 1) / 2147483646; }

      // Draw terrain grid
      const cellSize = 8;
      const cols = Math.ceil(w / cellSize), rows = Math.ceil(h / cellSize);
      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          const v = rng();
          const cx = x / cols, cy = y / rows;
          const dist = Math.sqrt((cx - 0.5) ** 2 + (cy - 0.5) ** 2);
          if (v < 0.15 + dist * 0.3) {
            // water
            const b = Math.floor(40 + rng() * 30);
            ctx.fillStyle = `rgb(${5+Math.floor(rng()*10)},${10+Math.floor(rng()*15)},${b})`;
          } else if (v < 0.5) {
            // land
            const g = Math.floor(25 + rng() * 35);
            ctx.fillStyle = `rgb(${8+Math.floor(rng()*12)},${g},${8+Math.floor(rng()*10)})`;
          } else if (v < 0.75) {
            // highlands
            const g = Math.floor(35 + rng() * 20);
            ctx.fillStyle = `rgb(${15+Math.floor(rng()*10)},${g},${20+Math.floor(rng()*10)})`;
          } else {
            // mountains
            const g = Math.floor(20 + rng() * 15);
            ctx.fillStyle = `rgb(${g},${g},${g+5})`;
          }
          ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
        }
      }
      // Overlay fog
      const grad = ctx.createRadialGradient(w/2, h/2, w*0.15, w/2, h/2, w*0.5);
      grad.addColorStop(0, 'rgba(10,10,26,0)');
      grad.addColorStop(1, 'rgba(10,10,26,0.85)');
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, w, h);
      // Label
      ctx.font = '14px sans-serif';
      ctx.fillStyle = 'rgba(153,102,255,0.6)';
      ctx.textAlign = 'center';
      ctx.fillText('‚öî Terra Incognita ‚öî', w/2, h/2);
    })();

    // ‚îÄ‚îÄ Character Sheet ‚îÄ‚îÄ
    function loadCharacter() {
      try { return JSON.parse(localStorage.getItem('humanity_character')); } catch { return null; }
    }
    function saveCharacter(c) { localStorage.setItem('humanity_character', JSON.stringify(c)); }

    function rollStats() {
      const roll = () => Math.floor(Math.random() * 16) + 3; // 3-18
      return { Strength: roll(), Intelligence: roll(), Dexterity: roll(), Charisma: roll() };
    }

    function renderCharacter() {
      const c = loadCharacter();
      const create = document.getElementById('char-create');
      const display = document.getElementById('char-display');
      if (!c) {
        create.style.display = 'block';
        display.style.display = 'none';
        return;
      }
      create.style.display = 'none';
      display.style.display = 'block';
      const classIcons = { Explorer: 'üß≠', Builder: 'üî®', Scholar: 'üìö', Guardian: 'üõ°Ô∏è' };
      document.getElementById('char-d-name').textContent = c.name;
      document.getElementById('char-d-class').textContent = (classIcons[c.class] || '') + ' ' + c.class;
      document.getElementById('char-d-level').textContent = 'Lv. ' + (c.level || 1);
      const statsEl = document.getElementById('char-stats');
      const statColors = { Strength: '#e55', Intelligence: '#58f', Dexterity: '#4c8', Charisma: '#eb4' };
      statsEl.innerHTML = Object.entries(c.stats).map(([k, v]) => {
        const pct = ((v - 3) / 15 * 100).toFixed(0);
        return `<div style="background:var(--bg-input);border-radius:6px;padding:0.35rem 0.5rem;">
          <div style="display:flex;justify-content:space-between;font-size:0.75rem;margin-bottom:0.2rem;">
            <span style="color:var(--text-muted);">${k}</span><span style="color:${statColors[k]||'var(--text)'};font-weight:700;">${v}</span>
          </div>
          <div style="background:var(--bg);border-radius:3px;height:4px;overflow:hidden;">
            <div style="width:${pct}%;height:100%;background:${statColors[k]||'var(--accent)'};border-radius:3px;"></div>
          </div>
        </div>`;
      }).join('');

      // Auto-unlock achievements
      checkAchievements();
    }

    function createCharacter() {
      const name = document.getElementById('char-name-input').value.trim();
      if (!name) { document.getElementById('char-name-input').style.borderColor = '#e55'; return; }
      const cls = document.getElementById('char-class-input').value;
      saveCharacter({ name, class: cls, level: 1, stats: rollStats(), createdAt: new Date().toISOString() });
      renderCharacter();
      // Unlock achievement
      unlockAchievement('character_created');
    }

    function rerollStats() {
      const c = loadCharacter();
      if (!c) return;
      c.stats = rollStats();
      saveCharacter(c);
      renderCharacter();
    }

    function deleteCharacter() {
      if (!confirm('Delete your character? This cannot be undone.')) return;
      localStorage.removeItem('humanity_character');
      renderCharacter();
    }

    renderCharacter();

    // ‚îÄ‚îÄ Lore / Codex ‚îÄ‚îÄ
    const LORE_ENTRIES = [
      {
        title: 'üåÖ The Awakening',
        text: 'Before the Network, humanity existed in silos ‚Äî each mind an island, separated by distance, language, and power structures designed to keep them apart. The first spark came not from technology, but from a simple idea: what if we actually cooperated?'
      },
      {
        title: 'üîó The Accord',
        text: 'The Humanity Accord is not a contract ‚Äî it\'s a promise. Every node in the network agrees to three principles: Transparency in governance, equity in access, and cooperation over competition. Those who sign the Accord don\'t just join a network ‚Äî they join a movement.'
      },
      {
        title: 'üåå The Long Road',
        text: 'The destination was always the stars. But first, humanity had to learn to talk to itself. The Humanity Network is the foundation ‚Äî a mesh of minds, resources, and purpose. From chat rooms to space stations, every great journey begins with "hello."'
      },
      {
        title: 'üõ°Ô∏è The Guardians',
        text: 'Not every force in the world welcomes cooperation. The Guardians are those who protect the network ‚Äî not with weapons, but with code, with vigilance, with the simple act of refusing to let the dream die. They moderate, they build, they hold the line.'
      },
      {
        title: 'üì° The Relay',
        text: 'Messages travel through the Relay ‚Äî a decentralized web of servers that carry humanity\'s voice. No single point of failure, no single point of control. When one relay falls, others rise. The network remembers, even when individuals forget.'
      }
    ];

    function renderLore() {
      const container = document.getElementById('lore-entries');
      container.innerHTML = LORE_ENTRIES.map((entry, i) => `
        <details style="background:var(--bg-input);border-radius:6px;padding:0.1rem 0.6rem;" ${i === 0 ? 'open' : ''}>
          <summary style="cursor:pointer;font-weight:600;font-size:0.85rem;color:var(--text);padding:0.4rem 0;user-select:none;list-style:none;">
            ${entry.title}
          </summary>
          <p style="font-size:0.82rem;color:var(--text-muted);line-height:1.6;padding:0 0 0.5rem;">${entry.text}</p>
        </details>
      `).join('');
    }
    renderLore();

    // ‚îÄ‚îÄ Achievements ‚îÄ‚îÄ
    const ACHIEVEMENTS = [
      { id: 'first_steps', icon: 'üë£', name: 'First Steps', desc: 'Visited the Humanity Hub', auto: true },
      { id: 'character_created', icon: '‚öîÔ∏è', name: 'Born Anew', desc: 'Created a character' },
      { id: 'voice_of_people', icon: 'üì¢', name: 'Voice of the People', desc: 'Sent your first message' },
      { id: 'gardener', icon: 'üå±', name: 'Green Thumb', desc: 'Planted something in your garden' },
      { id: 'note_taker', icon: 'üìù', name: 'Scribe', desc: 'Created your first note' },
      { id: 'explorer', icon: 'üß≠', name: 'Explorer', desc: 'Visited all hub tabs' },
      { id: 'lore_reader', icon: 'üìú', name: 'Lorekeeper', desc: 'Read all codex entries' },
      { id: 'customizer', icon: 'üé®', name: 'Fashionista', desc: 'Changed your accent color' },
      { id: 'night_owl', icon: 'ü¶â', name: 'Night Owl', desc: 'Online past midnight' },
      { id: 'streamer', icon: 'üé•', name: 'Camera Ready', desc: 'Tested screen/camera capture' },
      { id: 'completionist', icon: 'üíé', name: 'Completionist', desc: 'Unlock all other achievements' },
      { id: 'secret', icon: 'üîÆ', name: '???', desc: 'A secret achievement‚Ä¶' },
    ];

    function loadAchievements() {
      try { return JSON.parse(localStorage.getItem('humanity_achievements')) || []; } catch { return []; }
    }
    function saveAchievements(a) { localStorage.setItem('humanity_achievements', JSON.stringify(a)); }

    function unlockAchievement(id) {
      const unlocked = loadAchievements();
      if (unlocked.includes(id)) return;
      unlocked.push(id);
      saveAchievements(unlocked);
      renderAchievements();
    }

    function checkAchievements() {
      // Auto-unlock based on conditions
      unlockAchievement('first_steps');
      if (localStorage.getItem('humanity_character')) unlockAchievement('character_created');
      if (localStorage.getItem('humanity_name')) unlockAchievement('voice_of_people');
      const garden = (() => { try { return JSON.parse(localStorage.getItem('humanity_garden')); } catch { return null; } })();
      if (garden && garden.plots && Object.keys(garden.plots).length > 0) unlockAchievement('gardener');
      const notes = (() => { try { return JSON.parse(localStorage.getItem('humanity_notes')) || []; } catch { return []; } })();
      if (notes && notes.length > 0) unlockAchievement('note_taker');
      const settings = (() => { try { return JSON.parse(localStorage.getItem('humanity_settings')) || {}; } catch { return {}; } })();
      if (settings && settings.accent && settings.accent !== '#FF8811') unlockAchievement('customizer');
      if (new Date().getHours() >= 0 && new Date().getHours() < 5) unlockAchievement('night_owl');
    }

    function renderAchievements() {
      const unlocked = loadAchievements();
      const grid = document.getElementById('achievement-grid');
      grid.innerHTML = ACHIEVEMENTS.map(a => {
        const isUnlocked = unlocked.includes(a.id);
        return `<div style="background:${isUnlocked ? 'rgba(153,102,255,0.1)' : 'var(--bg-input)'};border:1px solid ${isUnlocked ? 'rgba(153,102,255,0.3)' : 'var(--border)'};border-radius:8px;padding:0.5rem;text-align:center;transition:border-color 0.2s;" title="${a.desc}">
          <div style="font-size:1.5rem;${isUnlocked ? '' : 'filter:grayscale(1) brightness(0.4);'}">${a.icon}</div>
          <div style="font-size:0.72rem;font-weight:600;color:${isUnlocked ? 'var(--text)' : 'var(--text-muted)'};margin-top:0.2rem;">${isUnlocked ? a.name : 'üîí Locked'}</div>
          <div style="font-size:0.6rem;color:var(--text-muted);margin-top:0.1rem;">${a.desc}</div>
        </div>`;
      }).join('');
    }
    checkAchievements();
    renderAchievements();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STREAMS TAB
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function toggleStreamsCard(id) {
      const card = document.getElementById('streams-' + id);
      if (card) card.classList.toggle('collapsed');
      localStorage.setItem('streams_collapsed_' + id, card.classList.contains('collapsed'));
    }
    ['dashboard', 'live', 'servers'].forEach(id => {
      if (localStorage.getItem('streams_collapsed_' + id) === 'true') {
        const card = document.getElementById('streams-' + id);
        if (card) card.classList.add('collapsed');
      }
    });

    // ‚îÄ‚îÄ Stream State ‚îÄ‚îÄ
    let streamScreenStream = null;   // Screen capture MediaStream
    let streamWebcamStream = null;   // Webcam MediaStream
    let streamCompositeStream = null; // Canvas composite output MediaStream
    let streamIsLive = false;
    let streamStartTime = null;
    let streamDurationTimer = null;
    let streamPeerConnection = null;
    let streamViewerPC = null;
    let streamChatMessages = [];
    let streamChatFilter_ = 'all';
    let streamCurrentInfo = { active: false };
    let streamPipCorner = 'br';
    let streamCompositeAnimFrame = null;

    // Twitch IRC WebSocket for chat integration
    let twitchChatWs = null;

    // ‚îÄ‚îÄ PiP Compositing ‚îÄ‚îÄ
    const compositeCanvas = document.getElementById('stream-composite-canvas');
    const compositeCtx = compositeCanvas ? compositeCanvas.getContext('2d') : null;
    const hiddenScreenVideo = document.createElement('video');
    hiddenScreenVideo.muted = true; hiddenScreenVideo.playsInline = true;

    function streamCompositeLoop() {
      if (!compositeCtx) return;
      const w = compositeCanvas.width, h = compositeCanvas.height;
      compositeCtx.fillStyle = '#000';
      compositeCtx.fillRect(0, 0, w, h);

      // Draw screen capture
      if (streamScreenStream && hiddenScreenVideo.readyState >= 2) {
        const vw = hiddenScreenVideo.videoWidth, vh = hiddenScreenVideo.videoHeight;
        if (vw && vh) {
          const scale = Math.min(w / vw, h / vh);
          const dw = vw * scale, dh = vh * scale;
          compositeCtx.drawImage(hiddenScreenVideo, (w - dw) / 2, (h - dh) / 2, dw, dh);
        }
      }

      // Draw webcam PiP overlay
      const pipVideo = document.getElementById('pip-webcam-video');
      if (streamWebcamStream && pipVideo && pipVideo.readyState >= 2 && document.getElementById('stream-webcam-cb').checked) {
        const sizeMap = { small: 0.15, medium: 0.2, large: 0.3 };
        const sizeFrac = sizeMap[document.getElementById('stream-webcam-size').value] || 0.2;
        const pw = w * sizeFrac;
        const ph = pw * (pipVideo.videoHeight / pipVideo.videoWidth || 0.75);
        const margin = 16;
        let px, py;
        if (streamPipCorner === 'tl') { px = margin; py = margin; }
        else if (streamPipCorner === 'tr') { px = w - pw - margin; py = margin; }
        else if (streamPipCorner === 'bl') { px = margin; py = h - ph - margin; }
        else { px = w - pw - margin; py = h - ph - margin; }

        compositeCtx.save();
        compositeCtx.beginPath();
        compositeCtx.roundRect(px, py, pw, ph, 12);
        compositeCtx.clip();
        compositeCtx.drawImage(pipVideo, px, py, pw, ph);
        compositeCtx.restore();
        // Border
        compositeCtx.strokeStyle = 'rgba(153,102,255,0.6)';
        compositeCtx.lineWidth = 3;
        compositeCtx.beginPath();
        compositeCtx.roundRect(px, py, pw, ph, 12);
        compositeCtx.stroke();
      }

      streamCompositeAnimFrame = requestAnimationFrame(streamCompositeLoop);
    }

    function streamStartCompositing() {
      if (streamCompositeAnimFrame) cancelAnimationFrame(streamCompositeAnimFrame);
      streamCompositeLoop();
      document.getElementById('stream-preview-placeholder').style.display = 'none';
      // Create output stream from canvas
      streamCompositeStream = compositeCanvas.captureStream(30);
      // Add audio from screen if available
      if (streamScreenStream) {
        streamScreenStream.getAudioTracks().forEach(t => streamCompositeStream.addTrack(t));
      }
    }

    function streamStopCompositing() {
      if (streamCompositeAnimFrame) { cancelAnimationFrame(streamCompositeAnimFrame); streamCompositeAnimFrame = null; }
      streamCompositeStream = null;
      document.getElementById('stream-preview-placeholder').style.display = 'flex';
    }

    // ‚îÄ‚îÄ Screen Capture ‚îÄ‚îÄ
    async function streamStartScreen() {
      try {
        if (streamScreenStream) { streamScreenStream.getTracks().forEach(t => t.stop()); }
        streamScreenStream = await navigator.mediaDevices.getDisplayMedia({ video: { width: { ideal: 1920 }, height: { ideal: 1080 } }, audio: true });
        hiddenScreenVideo.srcObject = streamScreenStream;
        await hiddenScreenVideo.play();
        streamScreenStream.getVideoTracks()[0].onended = () => {
          streamScreenStream = null;
          hiddenScreenVideo.srcObject = null;
          if (!streamWebcamStream) streamStopCompositing();
        };
        document.getElementById('stream-screen-cb').checked = true;
        streamStartCompositing();
        unlockAchievement('streamer');
      } catch (e) {
        console.warn('Screen capture failed:', e);
      }
    }

    function streamToggleScreen() {
      if (!document.getElementById('stream-screen-cb').checked && streamScreenStream) {
        streamScreenStream.getTracks().forEach(t => t.stop());
        streamScreenStream = null;
        hiddenScreenVideo.srcObject = null;
        if (!streamWebcamStream) streamStopCompositing();
      }
    }

    // ‚îÄ‚îÄ Webcam ‚îÄ‚îÄ
    async function streamToggleWebcam() {
      const cb = document.getElementById('stream-webcam-cb');
      const overlay = document.getElementById('pip-overlay');
      if (cb.checked) {
        try {
          streamWebcamStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          const pipVid = document.getElementById('pip-webcam-video');
          pipVid.srcObject = streamWebcamStream;
          overlay.style.display = 'block';
          if (!streamCompositeAnimFrame) streamStartCompositing();
        } catch (e) {
          cb.checked = false;
          console.warn('Webcam failed:', e);
        }
      } else {
        if (streamWebcamStream) { streamWebcamStream.getTracks().forEach(t => t.stop()); streamWebcamStream = null; }
        overlay.style.display = 'none';
        document.getElementById('pip-webcam-video').srcObject = null;
      }
    }

    function streamUpdatePipSize() { /* Compositing loop reads the select value each frame */ }

    function streamSetPipCorner(corner) {
      streamPipCorner = corner;
      document.querySelectorAll('#pip-corner-picker span').forEach(s => s.classList.toggle('active', s.dataset.corner === corner));
    }

    // ‚îÄ‚îÄ Go Live / Stop ‚îÄ‚îÄ
    async function streamGoLive() {
      if (streamIsLive) return;
      if (!streamCompositeStream && !streamScreenStream) {
        await streamStartScreen();
        if (!streamScreenStream) return;
      }
      const title = document.getElementById('stream-title').value || 'Untitled Stream';
      const category = document.getElementById('stream-category').value || '';

      // Send StreamStart to relay
      if (typeof ws !== 'undefined' && ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'stream_start', title, category }));
      }

      streamIsLive = true;
      streamStartTime = Date.now();
      document.getElementById('stream-go-live-btn').style.display = 'none';
      document.getElementById('stream-stop-btn').style.display = 'inline-flex';
      document.getElementById('stream-stop-btn').classList.remove('btn-disabled');
      document.getElementById('stream-stop-btn').classList.add('btn-activated');

      // Duration timer
      streamDurationTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - streamStartTime) / 1000);
        const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const s = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('stream-stat-duration').textContent = '‚è± ' + m + ':' + s;
      }, 1000);

      // Update quality stats
      if (streamScreenStream) {
        const vt = streamScreenStream.getVideoTracks()[0];
        if (vt) {
          const settings = vt.getSettings();
          document.getElementById('stream-stat-quality').textContent = 'üìä ' + (settings.width || '?') + 'x' + (settings.height || '?') + ' @ ' + (settings.frameRate ? Math.round(settings.frameRate) + 'fps' : '?');
        }
      }

      // Set up external stream URLs if checked
      const externalUrls = [];
      if (document.getElementById('stream-twitch-cb').checked) {
        externalUrls.push({ platform: 'twitch', url: document.getElementById('stream-twitch-url').value });
      }
      if (document.getElementById('stream-youtube-cb').checked) {
        externalUrls.push({ platform: 'youtube', url: document.getElementById('stream-youtube-url').value });
      }
      if (document.getElementById('stream-rumble-cb').checked) {
        externalUrls.push({ platform: 'rumble', url: document.getElementById('stream-rumble-url').value });
      }
      if (externalUrls.length > 0 && ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'stream_set_external', urls: externalUrls }));
      }

      // Connect Twitch chat if enabled
      const twitchUrl = document.getElementById('stream-twitch-url').value;
      if (document.getElementById('stream-twitch-cb').checked && twitchUrl) {
        const twitchChannel = twitchUrl.replace(/.*twitch\.tv\/?/i, '').replace(/\//g, '').toLowerCase();
        if (twitchChannel) connectTwitchChat(twitchChannel);
      }
    }

    function streamStop() {
      if (!streamIsLive) return;
      streamIsLive = false;
      if (streamDurationTimer) { clearInterval(streamDurationTimer); streamDurationTimer = null; }
      document.getElementById('stream-go-live-btn').style.display = 'inline-flex';
      document.getElementById('stream-stop-btn').style.display = 'none';
      document.getElementById('stream-stat-duration').textContent = '‚è± --:--';
      document.getElementById('stream-stat-quality').textContent = 'üìä --';
      document.getElementById('stream-stat-bitrate').textContent = 'üì∂ --';

      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'stream_stop' }));
      }

      // Close WebRTC
      if (streamPeerConnection) { streamPeerConnection.close(); streamPeerConnection = null; }
      // Disconnect Twitch chat
      if (twitchChatWs) { twitchChatWs.close(); twitchChatWs = null; }
    }

    // ‚îÄ‚îÄ Stream Chat ‚îÄ‚îÄ
    function streamChatFilter(filter, context) {
      streamChatFilter_ = filter;
      const tabsId = context === 'viewer' ? 'viewer-chat-tabs' : 'stream-chat-tabs';
      document.querySelectorAll('#' + tabsId + ' button').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase() === filter || (filter === 'all' && b.textContent === 'All')));
      streamRenderChat(context);
    }

    function streamRenderChat(context) {
      const containerId = context === 'viewer' ? 'viewer-chat-messages' : 'stream-chat-messages';
      const container = document.getElementById(containerId);
      if (!container) return;
      const filtered = streamChatFilter_ === 'all' ? streamChatMessages : streamChatMessages.filter(m => m.source === streamChatFilter_);
      container.innerHTML = filtered.map(m => {
        const srcClass = 'src-' + (m.source || 'humanity');
        const srcIcon = { humanity: 'üü†', twitch: 'üü£', youtube: 'üî¥', rumble: 'üü¢' }[m.source] || '‚ö™';
        const name = m.from_name || m.source_user || 'Anonymous';
        return '<div class="stream-chat-msg">' + srcIcon + ' <span class="' + srcClass + '" style="font-weight:600;">' + escapeHtml(name) + '</span>: ' + escapeHtml(m.content) + '</div>';
      }).join('');
      container.scrollTop = container.scrollHeight;
    }

    function streamChatSend(context) {
      const inputId = context === 'viewer' ? 'viewer-chat-input' : 'stream-chat-input';
      const input = document.getElementById(inputId);
      if (!input || !input.value.trim()) return;
      const content = input.value.trim();
      input.value = '';
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'stream_chat', content, source: 'humanity' }));
      }
    }

    function streamHandleMessage(msg) {
      switch (msg.type) {
        case 'stream_info':
          streamCurrentInfo = msg;
          streamUpdateLiveList();
          // Update viewer counts
          document.getElementById('stream-stat-viewers').textContent = 'üëÅ ' + (msg.viewer_count || 0) + ' viewers';
          if (document.getElementById('viewer-stat-viewers')) {
            document.getElementById('viewer-stat-viewers').textContent = 'üëÅ ' + (msg.viewer_count || 0);
          }
          // Update server live count
          document.getElementById('server-live-count').textContent = msg.active ? '1 live' : '0 live';
          break;

        case 'stream_chat': {
          streamChatMessages.push(msg);
          if (streamChatMessages.length > 500) streamChatMessages.shift();
          streamRenderChat();
          streamRenderChat('viewer');
          break;
        }

        case 'stream_offer':
        case 'stream_answer':
        case 'stream_ice':
          streamHandleSignaling(msg);
          break;
      }
    }

    function streamUpdateLiveList() {
      const container = document.getElementById('stream-live-list');
      const empty = document.getElementById('stream-live-empty');
      if (!streamCurrentInfo.active) {
        if (empty) empty.style.display = 'block';
        // Remove any live cards
        container.querySelectorAll('.viewer-card').forEach(c => c.remove());
        document.getElementById('stream-viewer-panel').classList.remove('active');
        return;
      }
      if (empty) empty.style.display = 'none';
      // Remove old cards
      container.querySelectorAll('.viewer-card').forEach(c => c.remove());

      // Main relay stream card
      const card = document.createElement('div');
      card.className = 'viewer-card';
      card.onclick = () => streamViewerJoin();
      card.innerHTML = '<div class="thumb">üî¥</div><div class="meta"><h3>' + escapeHtml(streamCurrentInfo.title || 'Live Stream') + '</h3><div class="sub">' + escapeHtml(streamCurrentInfo.streamer_name || 'Unknown') + ' ¬∑ üëÅ ' + (streamCurrentInfo.viewer_count || 0) + (streamCurrentInfo.category ? ' ¬∑ ' + escapeHtml(streamCurrentInfo.category) : '') + '</div></div>';
      container.appendChild(card);

      // External platform cards
      if (streamCurrentInfo.external_urls) {
        streamCurrentInfo.external_urls.forEach(eu => {
          const ecard = document.createElement('div');
          ecard.className = 'viewer-card';
          ecard.onclick = () => streamViewerJoinExternal(eu.platform, eu.url);
          const icon = { twitch: 'üü£', youtube: 'üî¥', rumble: 'üü¢' }[eu.platform] || 'üì∫';
          ecard.innerHTML = '<div class="thumb">' + icon + '</div><div class="meta"><h3>' + escapeHtml(eu.platform.charAt(0).toUpperCase() + eu.platform.slice(1)) + '</h3><div class="sub">' + escapeHtml(eu.url) + '</div></div>';
          container.appendChild(ecard);
        });
      }
    }

    // ‚îÄ‚îÄ Viewer: Join/Leave Stream ‚îÄ‚îÄ
    function streamViewerJoin() {
      const panel = document.getElementById('stream-viewer-panel');
      panel.classList.add('active');
      document.getElementById('viewer-stream-title').textContent = 'üì∫ ' + (streamCurrentInfo.title || 'Live Stream');

      // Send viewer join
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'stream_viewer_join' }));
      }

      // Request WebRTC offer from streamer (relay forwards)
      // The streamer will send an offer when they see our join
    }

    function streamViewerJoinExternal(platform, url) {
      const panel = document.getElementById('stream-viewer-panel');
      panel.classList.add('active');
      document.getElementById('viewer-stream-title').textContent = 'üì∫ ' + platform.charAt(0).toUpperCase() + platform.slice(1) + ' Stream';
      document.getElementById('viewer-video').style.display = 'none';
      const embedContainer = document.getElementById('viewer-embed-container');
      embedContainer.style.display = 'block';

      // Build embed based on platform
      if (platform === 'twitch') {
        const channel = url.replace(/.*twitch\.tv\/?/i, '').replace(/\//g, '');
        embedContainer.innerHTML = '<iframe src="https://player.twitch.tv/?channel=' + encodeURIComponent(channel) + '&parent=' + location.hostname + '" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>';
        // Also connect Twitch chat
        if (channel) connectTwitchChat(channel);
      } else if (platform === 'youtube') {
        const videoId = url.match(/(?:live\/|watch\?v=|youtu\.be\/)([^&?/]+)/);
        if (videoId) {
          embedContainer.innerHTML = '<iframe src="https://www.youtube.com/embed/' + encodeURIComponent(videoId[1]) + '?autoplay=1" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>';
        }
      } else if (platform === 'rumble') {
        embedContainer.innerHTML = '<iframe src="' + escapeHtml(url) + '" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>';
      }
    }

    function streamViewerLeave() {
      document.getElementById('stream-viewer-panel').classList.remove('active');
      document.getElementById('viewer-video').style.display = 'block';
      document.getElementById('viewer-embed-container').style.display = 'none';
      document.getElementById('viewer-embed-container').innerHTML = '';
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'stream_viewer_leave' }));
      }
      if (streamViewerPC) { streamViewerPC.close(); streamViewerPC = null; }
      if (twitchChatWs) { twitchChatWs.close(); twitchChatWs = null; }
    }

    // ‚îÄ‚îÄ WebRTC Signaling ‚îÄ‚îÄ
    function streamHandleSignaling(msg) {
      // For viewer: handle offer from streamer
      if (msg.type === 'stream_offer' && !streamIsLive) {
        const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        streamViewerPC = pc;
        pc.ontrack = (e) => {
          document.getElementById('viewer-video').srcObject = e.streams[0];
        };
        pc.onicecandidate = (e) => {
          if (e.candidate && ws && ws.readyState === 1) {
            ws.send(JSON.stringify({ type: 'stream_ice', to: msg.from, data: e.candidate }));
          }
        };
        pc.setRemoteDescription(new RTCSessionDescription(msg.data)).then(() => pc.createAnswer()).then(answer => {
          pc.setLocalDescription(answer);
          if (ws && ws.readyState === 1) {
            ws.send(JSON.stringify({ type: 'stream_answer', to: msg.from, data: answer }));
          }
        }).catch(e => console.warn('WebRTC answer failed:', e));
      }

      // For streamer: handle answer from viewer
      if (msg.type === 'stream_answer' && streamIsLive && streamPeerConnection) {
        streamPeerConnection.setRemoteDescription(new RTCSessionDescription(msg.data)).catch(e => console.warn('setRemoteDescription failed:', e));
      }

      // ICE candidates
      if (msg.type === 'stream_ice') {
        const pc = streamIsLive ? streamPeerConnection : streamViewerPC;
        if (pc) {
          pc.addIceCandidate(new RTCIceCandidate(msg.data)).catch(e => console.warn('addIceCandidate failed:', e));
        }
      }
    }

    // ‚îÄ‚îÄ Twitch IRC Chat Integration ‚îÄ‚îÄ
    function connectTwitchChat(channel) {
      if (twitchChatWs) { twitchChatWs.close(); }
      try {
        twitchChatWs = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
        twitchChatWs.onopen = () => {
          twitchChatWs.send('CAP REQ :twitch.tv/tags');
          twitchChatWs.send('NICK justinfan' + Math.floor(Math.random() * 99999));
          twitchChatWs.send('JOIN #' + channel.toLowerCase());
        };
        twitchChatWs.onmessage = (e) => {
          const lines = e.data.split('\r\n');
          for (const line of lines) {
            if (line.startsWith('PING')) {
              twitchChatWs.send('PONG :tmi.twitch.tv');
              continue;
            }
            // Parse PRIVMSG
            const privmsgMatch = line.match(/:([^!]+)![^ ]+ PRIVMSG #[^ ]+ :(.+)/);
            if (privmsgMatch) {
              const twitchUser = privmsgMatch[1];
              const twitchMsg = privmsgMatch[2];
              streamChatMessages.push({ content: twitchMsg, source: 'twitch', source_user: twitchUser, from_name: twitchUser, timestamp: Date.now() });
              if (streamChatMessages.length > 500) streamChatMessages.shift();
              streamRenderChat();
              streamRenderChat('viewer');
            }
          }
        };
        twitchChatWs.onerror = () => {};
        twitchChatWs.onclose = () => { twitchChatWs = null; };
      } catch (e) { console.warn('Twitch chat connect failed:', e); }
    }

    // Helper: escape HTML
    function escapeHtml(str) {
      if (typeof str !== 'string') return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // ‚îÄ‚îÄ Request stream info on connect ‚îÄ‚îÄ
    function streamRequestInfo() {
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'stream_info_request' }));
      }
    }

    // Track tab visits for explorer achievement
    const visitedTabs = JSON.parse(localStorage.getItem('humanity_visited_tabs') || '[]');
    const origSwitchTab = switchTab;
    switchTab = function(tabId, pushState) {
      origSwitchTab(tabId, pushState);
      if (!visitedTabs.includes(tabId)) {
        visitedTabs.push(tabId);
        localStorage.setItem('humanity_visited_tabs', JSON.stringify(visitedTabs));
      }
      if (['reality', 'fantasy', 'streams', 'debug'].every(t => visitedTabs.includes(t))) {
        unlockAchievement('explorer');
      }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PROJECT BOARD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let boardTasks = [];
    let boardWs = null;
    let boardMyKey = null;
    let boardMyRole = '';

    const PRIORITY_COLORS = { critical: '#e55', high: '#f80', medium: '#eb4', low: '#666' };
    const STATUS_LABELS = { backlog: 'üì• Backlog', in_progress: 'üîß In Progress', testing: 'üß™ Testing', done: '‚úÖ Done' };
    const VALID_STATUSES = ['backlog', 'in_progress', 'testing', 'done'];

    const API_BASE = 'https://united-humanity.us';

    function boardConnect() {
      // Always try REST API first (reliable, works everywhere)
      fetch(API_BASE + '/api/tasks').then(r => r.json()).then(data => {
        if (data.tasks && data.tasks.length > 0) {
          boardTasks = data.tasks;
          renderBoard();
        }
      }).catch(e => console.warn('Board REST fetch failed:', e));

      // Also connect WebSocket for real-time updates
      try {
        const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = location.host || 'united-humanity.us';
        boardWs = new WebSocket(proto + '//' + host + '/ws');
        boardWs.onopen = () => {
          const storedKey = localStorage.getItem('humanity_key');
          const storedName = localStorage.getItem('humanity_name');
          if (storedKey) {
            boardMyKey = storedKey;
            boardWs.send(JSON.stringify({ type: 'identify', public_key: storedKey, display_name: storedName || null }));
          } else {
            boardMyKey = 'viewer_' + Math.random().toString(36).slice(2, 10);
            boardWs.send(JSON.stringify({ type: 'identify', public_key: boardMyKey, display_name: null }));
          }
        };
        boardWs.onmessage = (e) => {
          try {
            const msg = JSON.parse(e.data);
            handleBoardMessage(msg);
          } catch {}
        };
        boardWs.onclose = () => { setTimeout(boardConnect, 5000); };
        boardWs.onerror = () => {};
      } catch (e) { console.warn('Board WS failed:', e); }
    }

    function handleBoardMessage(msg) {
      switch (msg.type) {
        case 'peer_list':
          // Extract our role from peer list
          if (msg.peers && boardMyKey) {
            const me = msg.peers.find(p => p.public_key === boardMyKey);
            if (me) boardMyRole = me.role || '';
          }
          updateBoardPermissions();
          // Request task list
          if (boardWs && boardWs.readyState === 1) {
            boardWs.send(JSON.stringify({ type: 'task_list' }));
          }
          break;
        case 'task_list_response':
          boardTasks = msg.tasks || [];
          renderBoard();
          break;
        case 'task_created':
          if (msg.task) {
            boardTasks.push(msg.task);
            renderBoard();
          }
          break;
        case 'task_updated':
          if (msg.task) {
            const idx = boardTasks.findIndex(t => t.id === msg.task.id);
            if (idx >= 0) boardTasks[idx] = msg.task;
            else boardTasks.push(msg.task);
            renderBoard();
          }
          break;
        case 'task_moved':
          if (msg.id != null && msg.status) {
            const t = boardTasks.find(t => t.id === msg.id);
            if (t) t.status = msg.status;
            renderBoard();
          }
          break;
        case 'task_deleted':
          if (msg.id != null) {
            boardTasks = boardTasks.filter(t => t.id !== msg.id);
            renderBoard();
          }
          break;
        case 'task_comment_added':
          if (msg.task_id != null) {
            const t = boardTasks.find(t => t.id === msg.task_id);
            if (t) t.comment_count = (t.comment_count || 0) + 1;
            renderBoard();
            // If modal is open for this task, append comment
            const modalEl = document.getElementById('task-modal-content');
            if (modalEl && modalEl.dataset.taskId == msg.task_id && msg.comment) {
              const commentsDiv = document.getElementById('task-comments-list');
              if (commentsDiv) {
                commentsDiv.innerHTML += renderCommentHtml(msg.comment);
              }
            }
          }
          break;
        case 'task_comments_response':
          if (msg.task_id != null) {
            const commentsDiv = document.getElementById('task-comments-list');
            if (commentsDiv && commentsDiv.dataset.taskId == msg.task_id) {
              commentsDiv.innerHTML = (msg.comments || []).map(renderCommentHtml).join('') || '<div style="color:var(--text-muted);font-size:0.8rem;font-style:italic;">No comments yet</div>';
            }
          }
          break;
      }
    }

    function updateBoardPermissions() {
      const canEdit = boardMyRole === 'admin' || boardMyRole === 'mod';
      const btn = document.getElementById('board-create-btn');
      if (btn) btn.style.display = canEdit ? 'inline-flex' : 'none';
    }

    function renderBoard() {
      document.getElementById('board-loading').style.display = 'none';
      VALID_STATUSES.forEach(status => {
        const container = document.querySelector('.board-col-cards[data-status="' + status + '"]');
        const countEl = document.querySelector('.board-col-count[data-status="' + status + '"]');
        if (!container) return;
        const tasks = boardTasks.filter(t => t.status === status).sort((a, b) => a.position - b.position);
        if (countEl) countEl.textContent = '(' + tasks.length + ')';
        container.innerHTML = tasks.map(t => renderTaskCard(t)).join('');
      });
    }

    function renderTaskCard(task) {
      const pc = PRIORITY_COLORS[task.priority] || '#666';
      const labels = (() => { try { return JSON.parse(task.labels || '[]'); } catch { return []; } })();
      const labelHtml = labels.map(l => '<span style="display:inline-block;background:rgba(255,136,17,0.15);color:var(--accent);font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:3px;margin-right:0.2rem;">' + escHtml(l) + '</span>').join('');
      const assigneeHtml = task.assignee ? '<span style="font-size:0.7rem;color:var(--text-muted);">üë§ ' + escHtml(task.assignee) + '</span>' : '';
      const commentHtml = task.comment_count > 0 ? '<span style="font-size:0.7rem;color:var(--text-muted);">üí¨ ' + task.comment_count + '</span>' : '';
      const canEdit = boardMyRole === 'admin' || boardMyRole === 'mod';
      let moveHtml = '';
      if (canEdit) {
        const moves = VALID_STATUSES.filter(s => s !== task.status);
        moveHtml = '<div style="display:flex;gap:0.2rem;margin-top:0.3rem;flex-wrap:wrap;" onclick="event.stopPropagation()">' +
          moves.map(s => '<button onclick="boardMoveTask(' + task.id + ',\'' + s + '\')" style="background:none;border:1px solid var(--border);color:var(--text-muted);font-size:0.6rem;padding:0.1rem 0.3rem;border-radius:3px;cursor:pointer;" title="Move to ' + (STATUS_LABELS[s]||s) + '">‚Üí ' + (STATUS_LABELS[s]||s).split(' ').pop() + '</button>').join('') +
          '</div>';
      }
      return '<div onclick="openTaskModal(' + task.id + ')" style="background:var(--bg-panel,#141414);border:1px solid var(--border);border-left:3px solid ' + pc + ';border-radius:6px;padding:0.5rem 0.6rem;margin-bottom:0.4rem;cursor:pointer;transition:border-color 0.15s;" onmouseover="this.style.borderColor=\'rgba(255,136,17,0.3)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.borderLeftColor=\'' + pc + '\'">' +
        '<div style="font-size:0.82rem;font-weight:600;color:var(--text);margin-bottom:0.3rem;">' + escHtml(task.title) + '</div>' +
        '<div style="display:flex;gap:0.4rem;align-items:center;flex-wrap:wrap;">' +
          '<span style="display:inline-block;background:' + pc + ';color:#fff;font-size:0.6rem;padding:0.05rem 0.35rem;border-radius:3px;font-weight:700;text-transform:uppercase;">' + task.priority + '</span>' +
          labelHtml + assigneeHtml + commentHtml +
        '</div>' +
        moveHtml +
        '<div style="text-align:right;margin-top:0.3rem;font-size:0.6rem;color:var(--text-muted);opacity:0.5;">#' + task.id + '</div>' +
      '</div>';
    }

    function boardMoveTask(id, status) {
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({ type: 'task_move', id: id, status: status }));
      }
    }

    function openTaskModal(taskId) {
      const task = boardTasks.find(t => t.id === taskId);
      if (!task) return;
      const modal = document.getElementById('task-modal');
      const content = document.getElementById('task-modal-content');
      content.dataset.taskId = taskId;
      const canEdit = boardMyRole === 'admin' || boardMyRole === 'mod';
      const canComment = canEdit || boardMyRole === 'verified' || boardMyRole === 'donor';
      const pc = PRIORITY_COLORS[task.priority] || '#666';
      const labels = (() => { try { return JSON.parse(task.labels || '[]'); } catch { return []; } })();
      const created = new Date(task.created_at).toLocaleString();

      let html = '<h3 style="color:var(--text);margin:0 0 0.5rem;font-size:1.1rem;">' + escHtml(task.title) + '</h3>' +
        '<div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;margin-bottom:0.8rem;">' +
          '<span style="background:' + pc + ';color:#fff;font-size:0.7rem;padding:0.1rem 0.4rem;border-radius:3px;font-weight:700;text-transform:uppercase;">' + task.priority + '</span>' +
          '<span style="font-size:0.75rem;color:var(--text-muted);">' + (STATUS_LABELS[task.status] || task.status) + '</span>' +
          (task.assignee ? '<span style="font-size:0.75rem;color:var(--text-muted);">üë§ ' + escHtml(task.assignee) + '</span>' : '') +
          '<span style="font-size:0.7rem;color:var(--text-muted);">Created: ' + created + '</span>' +
        '</div>';

      if (labels.length) {
        html += '<div style="margin-bottom:0.5rem;">' + labels.map(l => '<span style="display:inline-block;background:rgba(255,136,17,0.15);color:var(--accent);font-size:0.7rem;padding:0.1rem 0.5rem;border-radius:3px;margin-right:0.3rem;">' + escHtml(l) + '</span>').join('') + '</div>';
      }

      if (task.description) {
        html += '<div style="background:var(--bg-input,#111);border-radius:6px;padding:0.6rem;margin-bottom:1rem;font-size:0.82rem;color:var(--text);line-height:1.6;white-space:pre-wrap;">' + escHtml(task.description) + '</div>';
      }

      if (canEdit) {
        html += '<div style="display:flex;gap:0.4rem;margin-bottom:1rem;flex-wrap:wrap;">' +
          '<button class="btn btn-clickable" style="min-width:auto;min-height:32px;padding:0.2rem 0.6rem;font-size:0.75rem;" onclick="showEditTaskForm(' + task.id + ')">‚úèÔ∏è Edit</button>' +
          '<button class="btn" style="min-width:auto;min-height:32px;padding:0.2rem 0.6rem;font-size:0.75rem;box-shadow:inset 0 0 0 1px #e55;" onclick="boardDeleteTask(' + task.id + ')">üóëÔ∏è Delete</button>' +
        '</div>';
      }

      html += '<h4 style="color:var(--text-muted);font-size:0.85rem;margin:1rem 0 0.5rem;border-top:1px solid var(--border);padding-top:0.8rem;">üí¨ Comments</h4>' +
        '<div id="task-comments-list" data-task-id="' + taskId + '" style="margin-bottom:0.8rem;"><div style="color:var(--text-muted);font-size:0.8rem;">Loading‚Ä¶</div></div>';

      if (canComment) {
        html += '<div style="display:flex;gap:0.4rem;">' +
          '<input type="text" id="task-comment-input" placeholder="Add a comment‚Ä¶" style="flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.82rem;outline:none;font-family:inherit;" onkeydown="if(event.key===\'Enter\')boardAddComment(' + taskId + ')">' +
          '<button onclick="boardAddComment(' + taskId + ')" style="background:var(--accent);color:#fff;border:none;padding:0.4rem 0.8rem;border-radius:6px;font-size:0.82rem;cursor:pointer;font-weight:600;">Post</button>' +
        '</div>';
      }

      content.innerHTML = html;
      modal.style.display = 'flex';

      // Request comments
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({ type: 'task_comments_request', task_id: taskId }));
      }
    }

    function renderCommentHtml(c) {
      const time = new Date(c.created_at).toLocaleString();
      return '<div style="background:var(--bg-input,#111);border-radius:6px;padding:0.4rem 0.6rem;margin-bottom:0.3rem;">' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:0.2rem;"><span style="font-size:0.75rem;font-weight:600;color:var(--accent);">' + escHtml(c.author_name) + '</span><span style="font-size:0.65rem;color:var(--text-muted);">' + time + '</span></div>' +
        '<div style="font-size:0.8rem;color:var(--text);white-space:pre-wrap;">' + escHtml(c.content) + '</div>' +
      '</div>';
    }

    function closeTaskModal() {
      document.getElementById('task-modal').style.display = 'none';
    }

    function boardAddComment(taskId) {
      const input = document.getElementById('task-comment-input');
      if (!input || !input.value.trim()) return;
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({ type: 'task_comment', task_id: taskId, content: input.value.trim() }));
        input.value = '';
      }
    }

    function boardDeleteTask(id) {
      if (!confirm('Delete this task?')) return;
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({ type: 'task_delete', id: id }));
      }
      closeTaskModal();
    }

    function showCreateTaskModal() {
      const modal = document.getElementById('task-modal');
      const content = document.getElementById('task-modal-content');
      content.dataset.taskId = '';
      content.innerHTML =
        '<h3 style="color:var(--text);margin:0 0 1rem;font-size:1.1rem;">Create New Task</h3>' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Title</label>' +
        '<input type="text" id="new-task-title" maxlength="200" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:0.6rem;">' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Description</label>' +
        '<textarea id="new-task-desc" rows="4" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;resize:vertical;margin-bottom:0.6rem;"></textarea>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.6rem;margin-bottom:0.6rem;">' +
          '<div><label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Priority</label>' +
            '<select id="new-task-priority" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem;border-radius:6px;font-size:0.82rem;font-family:inherit;"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option><option value="critical">Critical</option></select></div>' +
          '<div><label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Status</label>' +
            '<select id="new-task-status" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem;border-radius:6px;font-size:0.82rem;font-family:inherit;"><option value="backlog" selected>Backlog</option><option value="in_progress">In Progress</option><option value="testing">Testing</option><option value="done">Done</option></select></div>' +
        '</div>' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Assignee (optional)</label>' +
        '<input type="text" id="new-task-assignee" maxlength="50" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:0.6rem;">' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Labels (comma-separated)</label>' +
        '<input type="text" id="new-task-labels" placeholder="bug, feature, urgent" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:1rem;">' +
        '<button onclick="boardSubmitCreateTask()" style="background:var(--accent);color:#fff;border:none;padding:0.5rem 1.5rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;width:100%;">Create Task</button>';
      modal.style.display = 'flex';
    }

    function boardSubmitCreateTask() {
      const title = document.getElementById('new-task-title').value.trim();
      if (!title) return;
      const labelsStr = document.getElementById('new-task-labels').value.trim();
      const labels = labelsStr ? JSON.stringify(labelsStr.split(',').map(l => l.trim()).filter(Boolean)) : '[]';
      const assignee = document.getElementById('new-task-assignee').value.trim() || null;
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({
          type: 'task_create',
          title: title,
          description: document.getElementById('new-task-desc').value,
          priority: document.getElementById('new-task-priority').value,
          status: document.getElementById('new-task-status').value,
          assignee: assignee,
          labels: labels,
        }));
      }
      closeTaskModal();
    }

    function showEditTaskForm(taskId) {
      const task = boardTasks.find(t => t.id === taskId);
      if (!task) return;
      const content = document.getElementById('task-modal-content');
      const labels = (() => { try { return JSON.parse(task.labels || '[]'); } catch { return []; } })();
      content.innerHTML =
        '<h3 style="color:var(--text);margin:0 0 1rem;font-size:1.1rem;">Edit Task</h3>' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Title</label>' +
        '<input type="text" id="edit-task-title" maxlength="200" value="' + escHtml(task.title).replace(/"/g,'&quot;') + '" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:0.6rem;">' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Description</label>' +
        '<textarea id="edit-task-desc" rows="4" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;resize:vertical;margin-bottom:0.6rem;">' + escHtml(task.description) + '</textarea>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.6rem;margin-bottom:0.6rem;">' +
          '<div><label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Priority</label>' +
            '<select id="edit-task-priority" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem;border-radius:6px;font-size:0.82rem;font-family:inherit;"><option value="low"' + (task.priority==='low'?' selected':'') + '>Low</option><option value="medium"' + (task.priority==='medium'?' selected':'') + '>Medium</option><option value="high"' + (task.priority==='high'?' selected':'') + '>High</option><option value="critical"' + (task.priority==='critical'?' selected':'') + '>Critical</option></select></div>' +
          '<div><label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Assignee</label>' +
            '<input type="text" id="edit-task-assignee" maxlength="50" value="' + escHtml(task.assignee||'').replace(/"/g,'&quot;') + '" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.82rem;outline:none;font-family:inherit;"></div>' +
        '</div>' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Labels (comma-separated)</label>' +
        '<input type="text" id="edit-task-labels" value="' + labels.join(', ').replace(/"/g,'&quot;') + '" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:1rem;">' +
        '<button onclick="boardSubmitEditTask(' + task.id + ')" style="background:var(--accent);color:#fff;border:none;padding:0.5rem 1.5rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;width:100%;">Save Changes</button>';
    }

    function boardSubmitEditTask(id) {
      const title = document.getElementById('edit-task-title').value.trim();
      if (!title) return;
      const labelsStr = document.getElementById('edit-task-labels').value.trim();
      const labels = labelsStr ? JSON.stringify(labelsStr.split(',').map(l => l.trim()).filter(Boolean)) : '[]';
      const assignee = document.getElementById('edit-task-assignee').value.trim() || null;
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({
          type: 'task_update',
          id: id,
          title: title,
          description: document.getElementById('edit-task-desc').value,
          priority: document.getElementById('edit-task-priority').value,
          assignee: assignee,
          labels: labels,
        }));
      }
      closeTaskModal();
    }

    // Close modal on backdrop click
    document.getElementById('task-modal').addEventListener('click', function(e) {
      if (e.target === this) closeTaskModal();
    });

    // Connect board WebSocket when tab switches to board
    const origSwitchTab2 = switchTab;
    switchTab = function(tabId, pushState) {
      origSwitchTab2(tabId, pushState);
      if (tabId === 'board' && (!boardWs || boardWs.readyState > 1)) {
        boardConnect();
      } else if (tabId === 'board' && boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({ type: 'task_list' }));
      }
    };

    // Auto-connect if initial tab is board
    if (initialTab === 'board') boardConnect();

    // Mobile responsive: stack columns on small screens
    (function() {
      const style = document.createElement('style');
      style.textContent = '@media (max-width: 768px) { #board-columns { grid-template-columns: 1fr !important; } }';
      document.head.appendChild(style);
    })();

    // ‚îÄ‚îÄ Browse Tab ‚îÄ‚îÄ
    const TRANCO_RANKS = {
      'google.com': 1, 'youtube.com': 2, 'facebook.com': 3, 'amazon.com': 8,
      'wikipedia.org': 10, 'reddit.com': 15, 'netflix.com': 20, 'github.com': 25,
      'discord.com': 30, 'twitch.tv': 35, 'ebay.com': 40, 'aliexpress.com': 45,
      'stackoverflow.com': 50, 'fonts.google.com': 50, 'spotify.com': 55,
      'imdb.com': 60, 'duckduckgo.com': 70, 'bbc.com': 80,
      'store.steampowered.com': 100, 'etsy.com': 120, 'deepl.com': 150,
      'gitlab.com': 150, 'craigslist.org': 200, 'coursera.org': 200,
      'soundcloud.com': 200, 'reuters.com': 250, 'archive.org': 250,
      'apnews.com': 300, 'figma.com': 300, 'khanacademy.org': 350,
      'news.ycombinator.com': 400, 'proton.me': 400, 'unsplash.com': 500,
      'arstechnica.com': 500, 'libgen.is': 500, 'dev.to': 600,
      'codepen.io': 700, 'newegg.com': 800, 'wolframalpha.com': 900,
      'itch.io': 1000, 'nexusmods.com': 1500, 'blender.org': 2000,
      'regex101.com': 2000, 'coolors.co': 3000, 'bitwarden.com': 3000,
      'thingiverse.com': 4000, 'mastodon.social': 5000, 'excalidraw.com': 5000,
      'howlongtobeat.com': 5000, 'signal.org': 6000, 'lemmy.world': 8000,
      'pcgamingwiki.com': 10000, 'isthereanydeal.com': 15000, 'allsides.com': 20000,
    };

    function getDomainFromUrl(url) {
      try { return new URL(url.startsWith('http') ? url : 'https://'+url).hostname.replace(/^www\./,''); } catch { return ''; }
    }
    function getTrancoRank(url) {
      const domain = getDomainFromUrl(url);
      return TRANCO_RANKS[domain] || TRANCO_RANKS[domain.replace(/^[^.]+\./, '')] || 999999;
    }

    // Uptime ping system
    const _pingCache = {}; // { domain: { status: 'up'|'down'|'checking', ts: Date.now() } }
    const PING_TTL = 5 * 60 * 1000;
    function getPingStatus(url) {
      const domain = getDomainFromUrl(url);
      const cached = _pingCache[domain];
      if (cached && Date.now() - cached.ts < PING_TTL) return cached.status;
      return 'unchecked';
    }
    function getPingDot(url) {
      const s = getPingStatus(url);
      if (s === 'up') return 'üü¢';
      if (s === 'down') return 'üî¥';
      return '‚ö™';
    }
    let _pingQueue = [];
    let _pinging = false;
    async function pingBatch() {
      if (_pinging) return;
      _pinging = true;
      while (_pingQueue.length > 0) {
        const batch = _pingQueue.splice(0, 5);
        await Promise.all(batch.map(async url => {
          const domain = getDomainFromUrl(url);
          if (_pingCache[domain] && Date.now() - _pingCache[domain].ts < PING_TTL) return;
          _pingCache[domain] = { status: 'checking', ts: Date.now() };
          try {
            await fetch(url + '/favicon.ico', { mode: 'no-cors', signal: AbortSignal.timeout(5000) });
            _pingCache[domain] = { status: 'up', ts: Date.now() };
          } catch {
            _pingCache[domain] = { status: 'down', ts: Date.now() };
          }
        }));
        renderBrowseSiteCards();
        if (_pingQueue.length > 0) await new Promise(r => setTimeout(r, 300));
      }
      _pinging = false;
    }
    function enqueuePings(sites) {
      sites.forEach(s => {
        const domain = getDomainFromUrl(s.url);
        if (!_pingCache[domain] || Date.now() - _pingCache[domain].ts >= PING_TTL) {
          if (!_pingQueue.includes(s.url)) _pingQueue.push(s.url);
        }
      });
      pingBatch();
    }

    // RDAP system
    const RDAP_CACHE_KEY = 'humanity_rdap_cache';
    function loadRdapCache() { try { return JSON.parse(localStorage.getItem(RDAP_CACHE_KEY)) || {}; } catch { return {}; } }
    function saveRdapCache(cache) { localStorage.setItem(RDAP_CACHE_KEY, JSON.stringify(cache)); }
    const _rdapFetching = {};
    async function fetchRdap(url) {
      const domain = getDomainFromUrl(url);
      const cache = loadRdapCache();
      if (cache[domain] && Date.now() - cache[domain].ts < 24*60*60*1000) return cache[domain].data;
      if (_rdapFetching[domain]) return null;
      _rdapFetching[domain] = true;
      try {
        const resp = await fetch('https://rdap.org/domain/' + domain);
        if (!resp.ok) throw new Error('RDAP error');
        const json = await resp.json();
        let regYear = null, registrar = null;
        (json.events || []).forEach(e => { if (e.eventAction === 'registration' && e.eventDate) regYear = new Date(e.eventDate).getFullYear(); });
        (json.entities || []).forEach(e => { if ((e.roles || []).includes('registrar')) registrar = e.vcardArray?.[1]?.find(v=>v[0]==='fn')?.[3] || e.handle || null; });
        const data = { regYear, registrar };
        cache[domain] = { data, ts: Date.now() };
        saveRdapCache(cache);
        delete _rdapFetching[domain];
        return data;
      } catch { delete _rdapFetching[domain]; return null; }
    }
    function getRdapDisplay(url) {
      const domain = getDomainFromUrl(url);
      const cache = loadRdapCache();
      if (cache[domain] && Date.now() - cache[domain].ts < 24*60*60*1000) {
        const d = cache[domain].data;
        const parts = [];
        if (d.regYear) parts.push('üìÖ ' + d.regYear);
        if (d.registrar) parts.push('üè¢ ' + d.registrar);
        return parts.length ? parts.join(' ¬∑ ') + ' ¬∑ ' : '';
      }
      return '';
    }

    let browseCurrentSort = 'popular';
    function setBrowseSort(sort) {
      browseCurrentSort = sort;
      ['popular','used','recent','az'].forEach(s => {
        const el = document.getElementById('sort-' + s);
        if (el) el.classList.toggle('active', s === sort);
      });
      renderBrowseSites();
    }

    const DEFAULT_SITES = [
      { url:'https://github.com', name:'GitHub', description:'Code hosting and collaboration', category:'Tech', icon:'üêô' },
      { url:'https://stackoverflow.com', name:'Stack Overflow', description:'Programming Q&A', category:'Tech', icon:'üìö' },
      { url:'https://news.ycombinator.com', name:'Hacker News', description:'Tech news and discussion', category:'Tech', icon:'üüß' },
      { url:'https://dev.to', name:'DEV Community', description:'Developer blogs and articles', category:'Tech', icon:'üë©‚Äçüíª' },
      { url:'https://gitlab.com', name:'GitLab', description:'DevOps and code hosting', category:'Tech', icon:'ü¶ä' },
      { url:'https://codepen.io', name:'CodePen', description:'Frontend code playground', category:'Tech', icon:'‚úèÔ∏è' },
      { url:'https://amazon.com', name:'Amazon', description:'Online marketplace', category:'Shopping', icon:'üì¶' },
      { url:'https://ebay.com', name:'eBay', description:'Auction and buy-it-now marketplace', category:'Shopping', icon:'üè∑Ô∏è' },
      { url:'https://etsy.com', name:'Etsy', description:'Handmade and vintage goods', category:'Shopping', icon:'üé®' },
      { url:'https://craigslist.org', name:'Craigslist', description:'Local classifieds', category:'Shopping', icon:'üìã' },
      { url:'https://newegg.com', name:'Newegg', description:'Computer hardware and electronics', category:'Shopping', icon:'üñ•Ô∏è' },
      { url:'https://aliexpress.com', name:'AliExpress', description:'International marketplace', category:'Shopping', icon:'üåè' },
      { url:'https://reuters.com', name:'Reuters', description:'International news agency', category:'News', icon:'üì∞' },
      { url:'https://apnews.com', name:'AP News', description:'Associated Press', category:'News', icon:'üóûÔ∏è' },
      { url:'https://arstechnica.com', name:'Ars Technica', description:'Technology news and analysis', category:'News', icon:'üî¨' },
      { url:'https://bbc.com/news', name:'BBC News', description:'British Broadcasting Corporation', category:'News', icon:'üì∫' },
      { url:'https://allsides.com', name:'AllSides', description:'News from multiple perspectives', category:'News', icon:'‚öñÔ∏è' },
      { url:'https://youtube.com', name:'YouTube', description:'Video sharing platform', category:'Entertainment', icon:'‚ñ∂Ô∏è' },
      { url:'https://twitch.tv', name:'Twitch', description:'Live streaming platform', category:'Entertainment', icon:'üíú' },
      { url:'https://netflix.com', name:'Netflix', description:'Streaming movies and shows', category:'Entertainment', icon:'üé¨' },
      { url:'https://spotify.com', name:'Spotify', description:'Music streaming', category:'Entertainment', icon:'üéµ' },
      { url:'https://soundcloud.com', name:'SoundCloud', description:'Independent music platform', category:'Entertainment', icon:'üîä' },
      { url:'https://imdb.com', name:'IMDB', description:'Movie and TV database', category:'Entertainment', icon:'‚≠ê' },
      { url:'https://store.steampowered.com', name:'Steam', description:'PC game store and community', category:'Gaming', icon:'üéÆ' },
      { url:'https://pcgamingwiki.com', name:'PCGamingWiki', description:'PC game fixes and info', category:'Gaming', icon:'üîß' },
      { url:'https://nexusmods.com', name:'Nexus Mods', description:'Game modding community', category:'Gaming', icon:'‚öôÔ∏è' },
      { url:'https://isthereanydeal.com', name:'IsThereAnyDeal', description:'Game price comparison', category:'Gaming', icon:'üí∞' },
      { url:'https://howlongtobeat.com', name:'HowLongToBeat', description:'Game completion times', category:'Gaming', icon:'‚è±Ô∏è' },
      { url:'https://itch.io', name:'itch.io', description:'Indie game marketplace', category:'Gaming', icon:'üïπÔ∏è' },
      { url:'https://wikipedia.org', name:'Wikipedia', description:'Free encyclopedia', category:'Education', icon:'üìñ' },
      { url:'https://khanacademy.org', name:'Khan Academy', description:'Free courses and lessons', category:'Education', icon:'üéì' },
      { url:'https://wolframalpha.com', name:'Wolfram Alpha', description:'Computational knowledge engine', category:'Education', icon:'üßÆ' },
      { url:'https://coursera.org', name:'Coursera', description:'Online university courses', category:'Education', icon:'üè´' },
      { url:'https://archive.org', name:'Internet Archive', description:'Digital library and Wayback Machine', category:'Education', icon:'üèõÔ∏è' },
      { url:'https://libgen.is', name:'Library Genesis', description:'Book and paper archive', category:'Education', icon:'üìï' },
      { url:'https://figma.com', name:'Figma', description:'Collaborative design tool', category:'Creative', icon:'üé®' },
      { url:'https://blender.org', name:'Blender', description:'Open source 3D creation', category:'Creative', icon:'üßä' },
      { url:'https://unsplash.com', name:'Unsplash', description:'Free high-quality photos', category:'Creative', icon:'üì∑' },
      { url:'https://fonts.google.com', name:'Google Fonts', description:'Free web fonts', category:'Creative', icon:'üî§' },
      { url:'https://coolors.co', name:'Coolors', description:'Color palette generator', category:'Creative', icon:'üåà' },
      { url:'https://thingiverse.com', name:'Thingiverse', description:'3D printing models', category:'Creative', icon:'üñ®Ô∏è' },
      { url:'https://reddit.com', name:'Reddit', description:'Community forums and discussion', category:'Social', icon:'ü§ñ' },
      { url:'https://discord.com', name:'Discord', description:'Chat and voice communities', category:'Social', icon:'üí¨' },
      { url:'https://mastodon.social', name:'Mastodon', description:'Decentralized social network', category:'Social', icon:'üêò' },
      { url:'https://lemmy.world', name:'Lemmy', description:'Federated link aggregator', category:'Social', icon:'üîó' },
      { url:'https://signal.org', name:'Signal', description:'Private messaging', category:'Social', icon:'üîí' },
      { url:'https://duckduckgo.com', name:'DuckDuckGo', description:'Private search engine', category:'Tools', icon:'ü¶Ü' },
      { url:'https://proton.me', name:'Proton Mail', description:'Encrypted email', category:'Tools', icon:'‚úâÔ∏è' },
      { url:'https://bitwarden.com', name:'Bitwarden', description:'Password manager', category:'Tools', icon:'üîê' },
      { url:'https://excalidraw.com', name:'Excalidraw', description:'Virtual whiteboard', category:'Tools', icon:'‚úèÔ∏è' },
      { url:'https://regex101.com', name:'Regex101', description:'Regular expression tester', category:'Tools', icon:'üîç' },
      { url:'https://deepl.com', name:'DeepL', description:'AI translation', category:'Tools', icon:'üåê' },
    ];

    const BROWSE_STORAGE_KEY = 'humanity_browse';
    function loadBrowseData() { try { return JSON.parse(localStorage.getItem(BROWSE_STORAGE_KEY)) || {}; } catch { return {}; } }
    function saveBrowseData(data) { localStorage.setItem(BROWSE_STORAGE_KEY, JSON.stringify(data)); if (typeof scheduleSyncSave === 'function') scheduleSyncSave(); }
    function getBrowseData() {
      const data = loadBrowseData();
      if (!data.quickBar) data.quickBar = ['https://duckduckgo.com','https://youtube.com','https://github.com','https://reddit.com','https://wikipedia.org'];
      if (!data.collections) data.collections = {};
      if (!data.hidden) data.hidden = [];
      if (!data.customSites) data.customSites = [];
      if (!data.clickCounts) data.clickCounts = {};
      if (!data.lastVisited) data.lastVisited = {};
      return data;
    }
    function getAllSites() { const data = getBrowseData(); return [...DEFAULT_SITES, ...data.customSites]; }

    let browseActiveCategory = '';
    let browseCurrentUrl = '';

    function renderQuickBar() {
      const data = getBrowseData();
      const container = document.getElementById('quickbar-sites');
      if (!container) return;
      const allSites = getAllSites();
      container.innerHTML = data.quickBar.map(url => {
        const site = allSites.find(s => s.url === url);
        const icon = site ? site.icon : 'üåê';
        const name = site ? site.name : new URL(url).hostname;
        return `<button onclick="browseNavigate('${url}')" title="${name}" style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:0.25rem 0.5rem;cursor:pointer;font-size:0.85rem;white-space:nowrap;color:var(--text);display:flex;align-items:center;gap:0.25rem;" oncontextmenu="event.preventDefault();removeFromQuickBar('${url}')">${icon} <span style="font-size:0.72rem;">${name}</span></button>`;
      }).join('');
    }

    function renderBrowseCategories() {
      const categories = [...new Set(getAllSites().map(s => s.category))];
      const container = document.getElementById('browse-categories');
      if (!container) return;
      container.innerHTML = `<span class="filter-pill ${browseActiveCategory===''?'active':''}" onclick="browseActiveCategory='';renderBrowseSites()" style="font-size:0.72rem;padding:0.15rem 0.5rem;cursor:pointer;">All</span>` +
        categories.map(c => `<span class="filter-pill ${browseActiveCategory===c?'active':''}" onclick="browseActiveCategory='${c}';renderBrowseSites()" style="font-size:0.72rem;padding:0.15rem 0.5rem;cursor:pointer;">${c}</span>`).join('');
    }

    function renderCollections() {
      const data = getBrowseData();
      const container = document.getElementById('browse-collections');
      if (!container) return;
      const collNames = Object.keys(data.collections);
      if (collNames.length === 0) { container.innerHTML = '<div style="font-size:0.72rem;color:var(--text-muted);padding:0.2rem;">No collections yet. Right-click a site to add to a collection.</div>'; return; }
      container.innerHTML = collNames.map(name => {
        const count = data.collections[name].length;
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:0.2rem 0.3rem;cursor:pointer;border-radius:4px;font-size:0.8rem;" onclick="browseActiveCategory='collection:${name}';renderBrowseSites()" oncontextmenu="event.preventDefault();deleteCollection('${name}')"><span>üìÅ ${name} <span style="color:var(--text-muted);">(${count})</span></span><button onclick="event.stopPropagation();deleteCollection('${name}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.7rem;">‚úï</button></div>`;
      }).join('') + `<button onclick="createCollection()" style="font-size:0.72rem;color:var(--accent);background:none;border:none;cursor:pointer;padding:0.2rem;">+ New Collection</button>`;
    }

    function sortBrowseSites(sites, data) {
      const sorted = [...sites];
      switch (browseCurrentSort) {
        case 'popular': sorted.sort((a, b) => getTrancoRank(a.url) - getTrancoRank(b.url)); break;
        case 'used': sorted.sort((a, b) => (data.clickCounts[b.url]||0) - (data.clickCounts[a.url]||0)); break;
        case 'recent': sorted.sort((a, b) => (data.lastVisited[b.url]||0) - (data.lastVisited[a.url]||0)); break;
        case 'az': sorted.sort((a, b) => a.name.localeCompare(b.name)); break;
      }
      return sorted;
    }
    let _lastRenderedSites = [];
    function renderBrowseSites() {
      renderBrowseCategories(); renderCollections();
      const data = getBrowseData();
      const search = (document.getElementById('browse-search')?.value || '').toLowerCase();
      let sites = getAllSites().filter(s => !data.hidden.includes(s.url));
      if (browseActiveCategory.startsWith('collection:')) {
        const collName = browseActiveCategory.replace('collection:', '');
        const collUrls = data.collections[collName] || [];
        sites = sites.filter(s => collUrls.includes(s.url));
      } else if (browseActiveCategory) { sites = sites.filter(s => s.category === browseActiveCategory); }
      if (search) { sites = sites.filter(s => s.name.toLowerCase().includes(search) || s.description.toLowerCase().includes(search) || s.url.toLowerCase().includes(search)); }
      sites = sortBrowseSites(sites, data);
      _lastRenderedSites = sites;
      const container = document.getElementById('browse-sites');
      if (!container) return;
      renderBrowseSiteCards();
      enqueuePings(sites);
    }
    function renderBrowseSiteCards() {
      const sites = _lastRenderedSites;
      const data = getBrowseData();
      const container = document.getElementById('browse-sites');
      if (!container) return;
      container.innerHTML = sites.map(s => {
        const rank = getTrancoRank(s.url);
        const rankStr = rank < 999999 ? `#${rank} globally` : '';
        const dot = getPingDot(s.url);
        const rdap = getRdapDisplay(s.url);
        const domain = getDomainFromUrl(s.url);
        return `<div class="browse-site-card" style="padding:0.5rem;margin-bottom:0.3rem;background:var(--bg-secondary);border-radius:6px;cursor:pointer;border:1px solid var(--border);" onclick="browseNavigateTracked('${s.url.replace(/'/g,"\\'")}')" oncontextmenu="event.preventDefault();showSiteContextMenu(event,'${s.url.replace(/'/g,"\\'")}','${s.name.replace(/'/g,"\\'")}');" onmouseenter="lazyFetchRdap('${s.url.replace(/'/g,"\\'")}')">`+
          `<div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:600;font-size:0.85rem;">${s.icon} ${s.name} ${dot}</span><span style="font-size:0.65rem;color:var(--text-muted);background:var(--bg);padding:0.1rem 0.4rem;border-radius:8px;">${s.category}</span></div>`+
          (rankStr ? `<div style="font-size:0.62rem;color:var(--text-muted);margin-top:0.1rem;">${rankStr}</div>` : '')+
          `<div style="font-size:0.72rem;color:var(--text-muted);margin-top:0.2rem;">${s.description}</div>`+
          `<div style="font-size:0.62rem;color:var(--accent);margin-top:0.15rem;">${rdap}${domain}</div></div>`;
      }).join('') || '<div style="padding:1rem;color:var(--text-muted);text-align:center;">No sites found</div>';
    }

    function filterBrowseSites() { renderBrowseSites(); }
    function browseNavigateTracked(url) {
      if (!url) return;
      const status = getPingStatus(url.startsWith('http') ? url : 'https://'+url);
      if (status === 'down') {
        if (!confirm('‚ö†Ô∏è This site may be down. Continue anyway?')) return;
      }
      const data = getBrowseData();
      data.clickCounts[url] = (data.clickCounts[url] || 0) + 1;
      data.lastVisited[url] = Date.now();
      saveBrowseData(data);
      browseNavigate(url);
    }
    function lazyFetchRdap(url) {
      const domain = getDomainFromUrl(url);
      const cache = loadRdapCache();
      if (cache[domain] && Date.now() - cache[domain].ts < 24*60*60*1000) return;
      fetchRdap(url).then(() => renderBrowseSiteCards());
    }
    function browseNavigate(url) {
      if (!url) return;
      if (!url.startsWith('http')) url = 'https://' + url;
      browseCurrentUrl = url;
      document.getElementById('browse-url-bar').value = url;
      document.getElementById('browse-iframe').src = url;
      document.getElementById('browse-iframe').style.display = 'block';
      document.getElementById('browse-placeholder').style.display = 'none';
    }
    function browsePanelBack() {
      document.getElementById('browse-iframe').style.display = 'none';
      document.getElementById('browse-iframe').src = '';
      document.getElementById('browse-placeholder').style.display = 'flex';
      document.getElementById('browse-url-bar').value = '';
      browseCurrentUrl = '';
    }
    function browseOpenExternal() { if (browseCurrentUrl) window.open(browseCurrentUrl, '_blank'); }
    function addToQuickBar(url) { const data = getBrowseData(); if (!data.quickBar.includes(url)) { data.quickBar.push(url); saveBrowseData(data); renderQuickBar(); } }
    function removeFromQuickBar(url) { const data = getBrowseData(); data.quickBar = data.quickBar.filter(u => u !== url); saveBrowseData(data); renderQuickBar(); }
    function hideSite(url) { const data = getBrowseData(); if (!data.hidden.includes(url)) { data.hidden.push(url); saveBrowseData(data); renderBrowseSites(); } }
    function createCollection() { const name = prompt('Collection name:'); if (!name || !name.trim()) return; const data = getBrowseData(); if (!data.collections[name.trim()]) { data.collections[name.trim()] = []; saveBrowseData(data); renderCollections(); } }
    function deleteCollection(name) { if (!confirm('Delete collection "' + name + '"?')) return; const data = getBrowseData(); delete data.collections[name]; saveBrowseData(data); if (browseActiveCategory === 'collection:' + name) browseActiveCategory = ''; renderBrowseSites(); }
    function addToCollection(url, collectionName) { const data = getBrowseData(); if (!data.collections[collectionName]) data.collections[collectionName] = []; if (!data.collections[collectionName].includes(url)) { data.collections[collectionName].push(url); saveBrowseData(data); renderBrowseSites(); } }
    function showAddSiteModal() {
      const url = prompt('Site URL:'); if (!url) return;
      const name = prompt('Site name:') || new URL(url.startsWith('http') ? url : 'https://'+url).hostname;
      const desc = prompt('Description (optional):') || '';
      const category = prompt('Category (Tech, Shopping, News, Entertainment, Gaming, Education, Creative, Social, Tools):') || 'Tools';
      const data = getBrowseData();
      data.customSites.push({ url: url.startsWith('http') ? url : 'https://'+url, name, description: desc, category, icon: 'üåê' });
      saveBrowseData(data); renderBrowseSites();
    }

    let siteContextMenu = null;
    function showSiteContextMenu(event, url, name) {
      if (siteContextMenu) siteContextMenu.remove();
      const data = getBrowseData();
      const inQuickBar = data.quickBar.includes(url);
      const collNames = Object.keys(data.collections);
      const menu = document.createElement('div');
      menu.style.cssText = 'position:fixed;z-index:9999;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:0.3rem 0;box-shadow:0 4px 12px rgba(0,0,0,0.3);min-width:160px;';
      menu.style.left = event.clientX + 'px'; menu.style.top = event.clientY + 'px';
      const items = [
        { label: inQuickBar ? '‚ö° Remove from Quick Bar' : '‚ö° Add to Quick Bar', action: () => inQuickBar ? removeFromQuickBar(url) : addToQuickBar(url) },
        { label: '‚Üó Open in New Tab', action: () => window.open(url, '_blank') },
        { label: 'üö´ Hide Site', action: () => hideSite(url) },
      ];
      if (collNames.length > 0) { items.push({ label: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', action: null }); collNames.forEach(c => { items.push({ label: 'üìÅ Add to ' + c, action: () => addToCollection(url, c) }); }); }
      menu.innerHTML = items.map((item, i) => {
        if (!item.action) return '<div style="border-top:1px solid var(--border);margin:0.2rem 0;"></div>';
        return `<div class="ctx-item" data-idx="${i}" style="padding:0.3rem 0.8rem;cursor:pointer;font-size:0.8rem;color:var(--text);" onmouseenter="this.style.background='var(--accent)'" onmouseleave="this.style.background=''">${item.label}</div>`;
      }).join('');
      menu.querySelectorAll('.ctx-item').forEach(el => { el.addEventListener('click', () => { items[parseInt(el.dataset.idx)].action(); menu.remove(); siteContextMenu = null; }); });
      document.body.appendChild(menu); siteContextMenu = menu;
      setTimeout(() => document.addEventListener('click', function dismiss() { if(siteContextMenu) siteContextMenu.remove(); siteContextMenu=null; document.removeEventListener('click',dismiss); }, { once: false }), 10);
    }

    function initBrowseTab() { renderQuickBar(); renderBrowseSites(); }

    // ‚îÄ‚îÄ Dashboard Tab ‚îÄ‚îÄ
    const DASHBOARD_STORAGE_KEY = 'humanity_dashboard';
    const WIDGET_TYPES = {
      clock: { name: 'Clock', icon: 'üïê', description: 'Current time and date', defaultSize: 'small' },
      notes: { name: 'Notes', icon: 'üìù', description: 'Quick notes pad', defaultSize: 'medium' },
      todos: { name: 'Todos', icon: '‚úÖ', description: 'Your todo list', defaultSize: 'medium' },
      friends: { name: 'Friends Online', icon: 'üë•', description: 'Who is online now', defaultSize: 'small' },
      stats: { name: 'Server Stats', icon: 'üìà', description: 'Relay server statistics', defaultSize: 'small' },
      quicklinks: { name: 'Quick Links', icon: '‚ö°', description: 'Your favorite bookmarks', defaultSize: 'small' },
      embed: { name: 'Website Embed', icon: 'üåê', description: 'Embed any website', defaultSize: 'large' },
      chat: { name: 'Chat Feed', icon: 'üí¨', description: 'Live messages from a channel', defaultSize: 'large' },
      weather: { name: 'Weather', icon: 'üå§Ô∏è', description: 'Current weather', defaultSize: 'small' },
      activity: { name: 'Recent Activity', icon: 'üîî', description: 'Latest messages across channels', defaultSize: 'medium' },
    };

    function loadDashboard() { try { return JSON.parse(localStorage.getItem(DASHBOARD_STORAGE_KEY)) || { widgets: [] }; } catch { return { widgets: [] }; } }
    function saveDashboard(data) { localStorage.setItem(DASHBOARD_STORAGE_KEY, JSON.stringify(data)); if (typeof scheduleSyncSave === 'function') scheduleSyncSave(); }

    function renderDashboard() {
      const data = loadDashboard();
      const grid = document.getElementById('dashboard-grid');
      const empty = document.getElementById('dashboard-empty');
      if (!grid) return;
      if (data.widgets.length === 0) { grid.style.display = 'none'; if (empty) empty.style.display = 'block'; return; }
      grid.style.display = 'grid'; if (empty) empty.style.display = 'none';
      grid.innerHTML = data.widgets.map((w, i) => {
        const sizeStyle = w.size === 'large' ? 'grid-column:span 2;min-height:300px;' : w.size === 'medium' ? 'min-height:200px;' : 'min-height:140px;';
        return `<div class="dashboard-widget" style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;overflow:hidden;${sizeStyle}display:flex;flex-direction:column;" data-widget-idx="${i}"><div style="display:flex;justify-content:space-between;align-items:center;padding:0.4rem 0.6rem;border-bottom:1px solid var(--border);flex-shrink:0;"><span style="font-size:0.8rem;font-weight:600;">${WIDGET_TYPES[w.type]?.icon || 'üì¶'} ${WIDGET_TYPES[w.type]?.name || w.type}</span><div style="display:flex;gap:0.3rem;"><button onclick="cycleWidgetSize(${i})" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.7rem;" title="Resize">‚áî</button><button onclick="moveWidget(${i},-1)" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.7rem;" title="Move left">‚óÄ</button><button onclick="moveWidget(${i},1)" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.7rem;" title="Move right">‚ñ∂</button><button onclick="removeWidget(${i})" style="background:none;border:none;color:#c0392b;cursor:pointer;font-size:0.7rem;" title="Remove">‚úï</button></div></div><div class="widget-content" style="flex:1;padding:0.5rem;overflow:auto;" id="widget-content-${i}"></div></div>`;
      }).join('');
      data.widgets.forEach((w, i) => renderWidgetContent(w, i));
    }

    function renderWidgetContent(widget, index) {
      const container = document.getElementById('widget-content-' + index);
      if (!container) return;
      switch (widget.type) {
        case 'clock': {
          function updateClock() {
            if (!document.getElementById('widget-content-' + index)) return;
            const now = new Date();
            container.innerHTML = `<div style="text-align:center;padding:0.5rem;"><div style="font-size:2rem;font-weight:700;color:var(--accent);">${now.toLocaleTimeString()}</div><div style="font-size:0.9rem;color:var(--text-muted);margin-top:0.3rem;">${now.toLocaleDateString(undefined, {weekday:'long',year:'numeric',month:'long',day:'numeric'})}</div></div>`;
            setTimeout(updateClock, 1000);
          }
          updateClock(); break;
        }
        case 'notes': {
          const notes = localStorage.getItem('humanity_notes'); let notesList = []; try { notesList = JSON.parse(notes) || []; } catch {}
          container.innerHTML = notesList.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:1rem;">No notes yet. Create them in the Reality tab.</div>' : notesList.map(n => `<div style="padding:0.3rem 0;border-bottom:1px solid var(--border);font-size:0.8rem;"><strong>${n.title || 'Untitled'}</strong><div style="color:var(--text-muted);font-size:0.72rem;max-height:40px;overflow:hidden;">${(n.content || '').substring(0, 100)}</div></div>`).join('');
          break;
        }
        case 'todos': {
          const todos = localStorage.getItem('humanity_todos'); let todoList = []; try { todoList = JSON.parse(todos) || []; } catch {}
          container.innerHTML = todoList.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:1rem;">No todos yet. Create them in the Reality tab.</div>' : todoList.map(t => `<div style="padding:0.25rem 0;font-size:0.8rem;display:flex;gap:0.3rem;align-items:start;"><span>${t.done ? '‚òë' : '‚òê'}</span><span style="${t.done?'text-decoration:line-through;color:var(--text-muted);':''}">${t.text || t.title || ''}</span></div>`).join('');
          break;
        }
        case 'friends': {
          const peers = (typeof peerData !== 'undefined') ? Object.values(peerData).filter(p => !p.public_key?.startsWith('bot_') && !p.public_key?.startsWith('viewer_')) : [];
          container.innerHTML = peers.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:1rem;">Connect to chat to see friends online</div>' : peers.map(p => `<div style="padding:0.2rem 0;font-size:0.8rem;">üü¢ ${p.display_name || p.public_key?.substring(0,8) || 'Unknown'} ${p.role === 'admin' ? 'üëë' : p.role === 'mod' ? 'üõ°Ô∏è' : ''}</div>`).join('');
          break;
        }
        case 'stats': {
          fetch('/api/stats').then(r => r.json()).then(stats => {
            container.innerHTML = `<div style="padding:0.3rem;"><div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;"><div style="text-align:center;"><div style="font-size:1.5rem;font-weight:700;color:var(--accent);">${stats.connected_peers || 0}</div><div style="font-size:0.7rem;color:var(--text-muted);">Online</div></div><div style="text-align:center;"><div style="font-size:1.5rem;font-weight:700;color:var(--accent);">${stats.total_messages || 0}</div><div style="font-size:0.7rem;color:var(--text-muted);">Messages</div></div></div></div>`;
          }).catch(() => { container.innerHTML = '<div style="color:var(--text-muted);text-align:center;">Could not load stats</div>'; });
          break;
        }
        case 'quicklinks': {
          const qlData = typeof getBrowseData === 'function' ? getBrowseData() : { quickBar: [] };
          const allSites = typeof getAllSites === 'function' ? getAllSites() : [];
          container.innerHTML = qlData.quickBar.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:1rem;">No quick links yet</div>' :
            `<div style="display:flex;flex-wrap:wrap;gap:0.4rem;">${qlData.quickBar.map(url => { const site = allSites.find(s => s.url === url); return `<a href="${url}" target="_blank" rel="noopener" style="background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:0.25rem 0.5rem;font-size:0.75rem;color:var(--text);text-decoration:none;display:flex;align-items:center;gap:0.2rem;">${site?.icon || 'üåê'} ${site?.name || new URL(url).hostname}</a>`; }).join('')}</div>`;
          break;
        }
        case 'embed': {
          const embedUrl = widget.config?.url || '';
          if (!embedUrl) { container.innerHTML = `<div style="text-align:center;padding:1rem;"><input type="text" placeholder="Enter URL to embed..." id="embed-url-${index}" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.3rem 0.6rem;border-radius:6px;font-size:0.8rem;width:80%;"><button onclick="setEmbedUrl(${index})" style="background:var(--accent);border:none;border-radius:6px;color:#fff;padding:0.3rem 0.6rem;cursor:pointer;font-size:0.8rem;margin-top:0.3rem;">Load</button></div>`; }
          else { container.style.padding = '0'; container.innerHTML = `<iframe src="${embedUrl}" style="width:100%;height:100%;border:none;" sandbox="allow-scripts allow-same-origin allow-forms allow-popups" referrerpolicy="no-referrer"></iframe>`; }
          break;
        }
        case 'weather': {
          container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:1rem;">Loading weather...</div>';
          fetch('https://wttr.in/?format=j1').then(r => r.json()).then(w => {
            const current = w.current_condition?.[0] || {}; const area = w.nearest_area?.[0] || {};
            container.innerHTML = `<div style="text-align:center;padding:0.3rem;"><div style="font-size:1.8rem;">${current.temp_F || '?'}¬∞F</div><div style="font-size:0.8rem;color:var(--text-muted);">${current.weatherDesc?.[0]?.value || 'Unknown'}</div><div style="font-size:0.72rem;color:var(--text-muted);margin-top:0.2rem;">${area.areaName?.[0]?.value || ''}, ${area.region?.[0]?.value || ''}</div><div style="font-size:0.7rem;color:var(--text-muted);margin-top:0.2rem;">üí® ${current.windspeedMiles || '?'} mph ¬∑ üíß ${current.humidity || '?'}%</div></div>`;
          }).catch(() => { container.innerHTML = '<div style="color:var(--text-muted);text-align:center;">Weather unavailable</div>'; });
          break;
        }
        case 'chat': {
          const channel = widget.config?.channel || 'general';
          container.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:1rem;">Loading chat...</div>';
          fetch('/api/messages?limit=15&channel=' + encodeURIComponent(channel)).then(r => r.json()).then(d => {
            if (d.messages && d.messages.length > 0) { container.innerHTML = d.messages.map(m => `<div style="padding:0.2rem 0;font-size:0.78rem;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="color:var(--accent);font-weight:600;">${m.from_name || 'Unknown'}</span><span style="color:var(--text-muted);font-size:0.65rem;margin-left:0.3rem;">${new Date(m.timestamp).toLocaleTimeString()}</span><div style="color:var(--text);">${m.content.substring(0, 200)}</div></div>`).join(''); }
            else { container.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:1rem;">No messages in #' + channel + '</div>'; }
          }).catch(() => { container.innerHTML = '<div style="color:var(--text-muted);text-align:center;">Could not load chat</div>'; });
          break;
        }
        case 'activity': {
          fetch('/api/messages?limit=20').then(r => r.json()).then(d => {
            if (d.messages && d.messages.length > 0) { container.innerHTML = d.messages.map(m => `<div style="padding:0.2rem 0;font-size:0.78rem;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="font-size:0.65rem;color:var(--text-muted);">#${m.channel || 'general'}</span><span style="color:var(--accent);font-weight:600;margin-left:0.3rem;">${m.from_name || 'Unknown'}</span><span style="color:var(--text-muted);font-size:0.65rem;margin-left:0.3rem;">${new Date(m.timestamp).toLocaleTimeString()}</span><div style="color:var(--text);">${m.content.substring(0, 150)}</div></div>`).join(''); }
            else { container.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:1rem;">No recent activity</div>'; }
          }).catch(() => { container.innerHTML = '<div style="color:var(--text-muted);text-align:center;">Could not load activity</div>'; });
          break;
        }
        default: container.innerHTML = '<div style="color:var(--text-muted);text-align:center;">Unknown widget type</div>';
      }
    }

    function showAddWidgetModal() {
      const types = Object.entries(WIDGET_TYPES);
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;';
      modal.innerHTML = `<div style="background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:1.5rem;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;"><h3 style="margin:0;color:var(--accent);">Add Widget</h3><button onclick="this.closest('[style*=fixed]').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.2rem;">‚úï</button></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">${types.map(([key, t]) => `<div onclick="addWidget('${key}');this.closest('[style*=fixed]').remove()" style="padding:0.8rem;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;cursor:pointer;text-align:center;" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'"><div style="font-size:1.5rem;">${t.icon}</div><div style="font-weight:600;font-size:0.85rem;margin-top:0.2rem;">${t.name}</div><div style="font-size:0.7rem;color:var(--text-muted);margin-top:0.1rem;">${t.description}</div></div>`).join('')}</div></div>`;
      document.body.appendChild(modal);
      modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    }

    function addWidget(type) {
      const data = loadDashboard(); const config = {};
      if (type === 'chat') { const ch = prompt('Channel name:', 'general'); if (!ch) return; config.channel = ch; }
      else if (type === 'embed') { const url = prompt('URL to embed (or leave empty to set later):'); if (url) config.url = url.startsWith('http') ? url : 'https://' + url; }
      data.widgets.push({ type, config, size: WIDGET_TYPES[type]?.defaultSize || 'medium', id: 'w' + Date.now() });
      saveDashboard(data); renderDashboard();
    }
    function removeWidget(index) { const data = loadDashboard(); data.widgets.splice(index, 1); saveDashboard(data); renderDashboard(); }
    function moveWidget(index, direction) { const data = loadDashboard(); const newIndex = index + direction; if (newIndex < 0 || newIndex >= data.widgets.length) return; [data.widgets[index], data.widgets[newIndex]] = [data.widgets[newIndex], data.widgets[index]]; saveDashboard(data); renderDashboard(); }
    function cycleWidgetSize(index) { const data = loadDashboard(); const sizes = ['small', 'medium', 'large']; const current = sizes.indexOf(data.widgets[index].size); data.widgets[index].size = sizes[(current + 1) % sizes.length]; saveDashboard(data); renderDashboard(); }
    function setEmbedUrl(index) { const input = document.getElementById('embed-url-' + index); if (!input) return; let url = input.value; if (!url) return; if (!url.startsWith('http')) url = 'https://' + url; const data = loadDashboard(); data.widgets[index].config = data.widgets[index].config || {}; data.widgets[index].config.url = url; saveDashboard(data); renderDashboard(); }

    // ‚îÄ‚îÄ Browse/Dashboard tab activation ‚îÄ‚îÄ
    {
      const origSwitchTab3 = switchTab;
      switchTab = function(tabId, pushState) {
        origSwitchTab3(tabId, pushState);
        if (tabId === 'browse') initBrowseTab();
        if (tabId === 'dashboard') renderDashboard();
      };
      if (initialTab === 'browse') initBrowseTab();
      if (initialTab === 'dashboard') renderDashboard();
    }

    // ‚îÄ‚îÄ Mobile responsive for browse/dashboard ‚îÄ‚îÄ
    (function() {
      const style = document.createElement('style');
      style.textContent = '@media (max-width: 768px) { #tab-browse > div:nth-child(2) { flex-direction: column !important; } #browse-directory { width: 100% !important; min-width: auto !important; max-height: 40vh; border-right: none !important; border-bottom: 1px solid var(--border); } #dashboard-grid { grid-template-columns: 1fr !important; } .dashboard-widget { grid-column: span 1 !important; } }';
      document.head.appendChild(style);
    })();

    // ‚îÄ‚îÄ Auto-refresh on server update ‚îÄ‚îÄ
    (function() {
      let knownVersion = null;
      async function checkVersion() {
        try {
          const res = await fetch('/api/stats');
          if (!res.ok) return;
          const data = await res.json();
          if (!data.version) return;
          if (knownVersion === null) {
            knownVersion = data.version;
          } else if (knownVersion !== data.version) {
            console.log('Server updated (' + knownVersion + ' ‚Üí ' + data.version + '), reloading‚Ä¶');
            location.reload();
          }
        } catch (e) { /* network hiccup, try again next cycle */ }
      }
      checkVersion();
      setInterval(checkVersion, 30000);
    })();
  </script>
</body>
</html>
