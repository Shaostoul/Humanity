<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Humanity</title>
  <link rel="manifest" href="/shared/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Humanity">
  <link rel="apple-touch-icon" href="/shared/icons/icon-192.png">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%231a1a2e'/%3E%3Ctext x='32' y='46' font-family='Arial,Helvetica,sans-serif' font-weight='bold' font-size='42' fill='%23FF8811' text-anchor='middle'%3EH%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="/shared/theme.css">
  <style>
    :root {
      --bg-panel: #141414;
      --border: #2a2a2a;
      --success: #4a8;
      --error: #e55;
      --warning: #eb4;

      /* Button state colors */
      --btn-clickable: #44cc66;
      --btn-hover: #4488ff;
      --btn-activated: #ee3333;
      --btn-disabled: #222222;
      --btn-cooldown: #8844cc;
    }

    body {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â”€â”€ Tab Content â”€â”€ */
    .tab-content {
      flex: 1;
      display: none;
      padding: 1.5rem;
      padding-bottom: 80px;
      overflow-y: auto;
    }
    .tab-content.active { display: block; }

    .panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .panel h2 {
      font-size: 1.1rem;
      color: var(--accent);
      margin-bottom: 0.8rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.4rem;
    }

    .panel h3 {
      font-size: 0.9rem;
      color: var(--text);
      margin: 1rem 0 0.5rem;
    }

    .panel p {
      font-size: 0.85rem;
      color: var(--text-muted);
      line-height: 1.6;
      margin-bottom: 0.5rem;
    }

    .placeholder-text {
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.9rem;
      text-align: center;
      padding: 2rem 1rem;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }

    .card-grid .panel {
      transition: border-color 0.2s;
    }
    .card-grid .panel:hover {
      border-color: rgba(255, 136, 17, 0.3);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BUTTON DESIGN SYSTEM
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 120px;
      min-height: 44px;
      padding: 0.5rem 1.2rem;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      background: var(--bg-panel);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: box-shadow 0.15s ease;
      position: relative;
      user-select: none;
      font-family: inherit;
      box-shadow: inset 0 0 0 1px var(--btn-clickable);
    }

    .btn.btn-clickable,
    .btn:not(.btn-disabled):not(.btn-cooldown):not(.btn-channeling):not(.btn-activated) {
      box-shadow: inset 0 0 0 1px var(--btn-clickable);
    }

    .btn:not(.btn-disabled):not(.btn-cooldown):not(.btn-activated):hover {
      box-shadow: inset 0 0 0 3px var(--btn-hover), 0 0 12px rgba(68, 136, 255, 0.4) !important;
      animation: none;
    }

    .btn.btn-activated {
      box-shadow: inset 0 0 0 5px var(--btn-activated), 0 0 12px rgba(238, 51, 51, 0.4) !important;
      animation: none;
    }

    .btn.btn-channeling {
      animation: rainbow-shadow 3s linear infinite;
    }

    @keyframes rainbow-shadow {
      0%   { box-shadow: inset 0 0 0 1px #ff0000, 0 0 8px rgba(255,0,0,0.3); }
      16%  { box-shadow: inset 0 0 0 1px #ff8800, 0 0 8px rgba(255,136,0,0.3); }
      33%  { box-shadow: inset 0 0 0 1px #ffff00, 0 0 8px rgba(255,255,0,0.3); }
      50%  { box-shadow: inset 0 0 0 1px #00ff44, 0 0 8px rgba(0,255,68,0.3); }
      66%  { box-shadow: inset 0 0 0 1px #0088ff, 0 0 8px rgba(0,136,255,0.3); }
      83%  { box-shadow: inset 0 0 0 1px #8800ff, 0 0 8px rgba(136,0,255,0.3); }
      100% { box-shadow: inset 0 0 0 1px #ff0000, 0 0 8px rgba(255,0,0,0.3); }
    }

    .btn.btn-disabled {
      box-shadow: inset 0 0 0 2px var(--btn-disabled);
      color: var(--text-muted);
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn.btn-disabled:hover {
      box-shadow: inset 0 0 0 2px var(--btn-disabled) !important;
    }

    .btn.btn-cooldown {
      box-shadow: inset 0 0 0 7px var(--btn-cooldown);
      cursor: wait;
      color: var(--text-muted);
    }
    .btn.btn-cooldown:hover {
      box-shadow: inset 0 0 0 7px var(--btn-cooldown) !important;
    }

    .btn-cooldown-timer {
      position: absolute;
      font-size: 0.6rem;
      font-weight: 700;
      color: var(--btn-cooldown);
      background: var(--bg-panel);
      padding: 0 0.3rem;
      letter-spacing: 0.05em;
    }
    .btn-cooldown-timer.top {
      top: -2px;
      left: 50%;
      transform: translateX(-50%);
    }
    .btn-cooldown-timer.bottom {
      bottom: -2px;
      left: 50%;
      transform: translateX(-50%);
    }

    .btn-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1.2rem;
      margin: 0.5rem 0;
      align-items: center;
    }

    .btn-demo {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.4rem;
    }

    .btn-demo .btn-label {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    /* â”€â”€ Settings Panel (inline) â”€â”€ */
    #tab-settings .panel { max-width: 600px; }

    /* â”€â”€ Debug info items â”€â”€ */
    .debug-info {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 0.3rem 1rem;
      font-size: 0.82rem;
      margin: 0.5rem 0;
    }
    .debug-info dt {
      color: var(--text-muted);
      font-weight: 600;
    }
    .debug-info dd {
      color: var(--text);
      font-family: monospace;
      font-size: 0.78rem;
    }

    /* â”€â”€ Reality Cards â”€â”€ */
    .reality-card-header {
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .reality-card-header .collapse-icon {
      font-size: 0.7rem;
      color: var(--text-muted);
      transition: transform 0.2s;
    }
    .reality-card.collapsed .reality-card-body { display: none; }
    .reality-card.collapsed .collapse-icon { transform: rotate(-90deg); }

    /* Todo */
    .todo-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.4rem;
      border-radius: 4px;
      font-size: 0.85rem;
    }
    .todo-item:hover { background: var(--bg-hover); }
    .todo-item.completed { opacity: 0.5; }
    .todo-item.completed .todo-text { text-decoration: line-through; }
    .todo-item input[type="checkbox"] { accent-color: var(--accent); cursor: pointer; }
    .todo-text { flex: 1; color: var(--text); }
    .todo-delete {
      background: none; border: none; color: var(--text-muted); cursor: pointer;
      font-size: 0.75rem; padding: 0.1rem 0.3rem; border-radius: 3px; opacity: 0;
    }
    .todo-item:hover .todo-delete { opacity: 1; }
    .todo-delete:hover { color: var(--danger, #c44); }

    /* Notes */
    .note-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.5rem;
      border-radius: 4px;
      font-size: 0.82rem;
      cursor: pointer;
      color: var(--text-muted);
    }
    .note-item:hover { background: var(--bg-hover); color: var(--text); }
    .note-item.active { background: var(--accent-dim); color: var(--accent); font-weight: 600; }
    .note-delete {
      background: none; border: none; color: var(--text-muted); cursor: pointer;
      font-size: 0.7rem; padding: 0.1rem 0.3rem; opacity: 0; margin-left: auto;
    }
    .note-item:hover .note-delete { opacity: 1; }
    .note-delete:hover { color: var(--danger, #c44); }

    /* Garden */
    #garden-grid {
      display: grid;
      gap: 4px;
    }
    .garden-plot {
      aspect-ratio: 1;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: var(--text-muted);
      cursor: pointer;
      text-align: center;
      padding: 2px;
      word-break: break-word;
      transition: border-color 0.15s;
    }
    .garden-plot:hover { border-color: var(--accent); }
    .garden-plot.planted {
      background: rgba(68,170,68,0.1);
      border-color: rgba(68,170,68,0.3);
      color: var(--text);
      font-weight: 600;
    }

    /* â”€â”€ Mobile â”€â”€ */
    @media (max-width: 600px) {
      .tab-content {
        padding: 1rem;
      }
      .card-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <script src="/shared/shell.js"></script>
  <script src="/shared/settings.js"></script>
  <script>
    document.querySelectorAll('.hub-nav .tab[href^="/reality"]').forEach(el => el.setAttribute('data-tab', 'reality'));
    document.querySelectorAll('.hub-nav .tab[href^="/fantasy"]').forEach(el => el.setAttribute('data-tab', 'fantasy'));
    document.querySelectorAll('.hub-nav .tab[href^="/streams"]').forEach(el => el.setAttribute('data-tab', 'streams'));
    document.querySelectorAll('.hub-nav .tab[href^="/debug"]').forEach(el => el.setAttribute('data-tab', 'debug'));
  </script>

  <!-- Reality Tab -->
  <div id="tab-reality" class="tab-content">
    <div class="panel">
      <h2>ğŸŸ¢ Reality</h2>
      <p>Your real-world dashboard. Track your actual life â€” garden, notes, todos â€” all in one place. Data stays on your device.</p>
    </div>
    <div class="card-grid">
      <!-- â”€â”€ Todo List â”€â”€ -->
      <div class="panel reality-card" id="reality-todo">
        <h2 class="reality-card-header" onclick="toggleRealityCard('todo')">âœ… Todo List <span class="collapse-icon" id="todo-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="todo-body">
          <div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;">
            <input type="text" id="todo-input" placeholder="Add a taskâ€¦" style="flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;" onkeydown="if(event.key==='Enter')addTodo()">
            <button onclick="addTodo()" style="background:var(--accent);color:#fff;border:none;padding:0.4rem 0.8rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;">Add</button>
          </div>
          <div id="todo-list"></div>
        </div>
      </div>

      <!-- â”€â”€ Notes â”€â”€ -->
      <div class="panel reality-card" id="reality-notes">
        <h2 class="reality-card-header" onclick="toggleRealityCard('notes')">ğŸ“ Notes <span class="collapse-icon" id="notes-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="notes-body">
          <div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;">
            <button onclick="addNote()" style="background:var(--accent);color:#fff;border:none;padding:0.4rem 0.8rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;">+ New Note</button>
          </div>
          <div id="notes-list" style="margin-bottom:0.6rem;"></div>
          <div id="notes-editor" style="display:none;">
            <input type="text" id="note-title" placeholder="Note title" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:0.4rem;" oninput="saveCurrentNote()">
            <textarea id="note-content" placeholder="Write your noteâ€¦" rows="8" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.5rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;resize:vertical;line-height:1.5;" oninput="saveCurrentNote()"></textarea>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Garden Tracker â”€â”€ -->
      <div class="panel reality-card" id="reality-garden">
        <h2 class="reality-card-header" onclick="toggleRealityCard('garden')">ğŸŒ± Garden Tracker <span class="collapse-icon" id="garden-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="garden-body">
          <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.6rem;">Click a plot to set what's planted. Your garden, your data.</p>
          <div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;align-items:center;">
            <label style="font-size:0.8rem;color:var(--text-muted);">Grid:</label>
            <select id="garden-size" onchange="resizeGarden()" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.3rem 0.5rem;border-radius:4px;font-size:0.8rem;">
              <option value="3">3Ã—3</option>
              <option value="4" selected>4Ã—4</option>
              <option value="5">5Ã—5</option>
              <option value="6">6Ã—6</option>
            </select>
          </div>
          <div id="garden-grid"></div>
        </div>
      </div>

      <!-- â”€â”€ Future cards â”€â”€ -->
      <div class="panel">
        <h2>ğŸ“¦ Inventory</h2>
        <p>Catalog your tools, supplies, materials, and resources.</p>
        <div class="placeholder-text">ğŸš§ Coming soon</div>
      </div>
      <div class="panel">
        <h2>â¤ï¸ Health</h2>
        <p>Track nutrition, exercise, sleep, and wellness goals.</p>
        <div class="placeholder-text">ğŸš§ Coming soon</div>
      </div>
      <div class="panel">
        <h2>ğŸ“š Learning</h2>
        <p>Skill trees, tutorials, and guides for real life.</p>
        <div class="placeholder-text">ğŸš§ Coming soon</div>
      </div>
    </div>
  </div>

  <!-- Fantasy Tab -->
  <div id="tab-fantasy" class="tab-content">
    <div class="panel" style="border-color:rgba(120,80,200,0.3);">
      <h2 style="color:var(--fantasy-accent,#9966ff);">âœ¨ Fantasy</h2>
      <p>The game side of Humanity. Your character, the world lore, and achievements â€” all stored locally. The adventure begins here.</p>
    </div>
    <div class="card-grid">

      <!-- â”€â”€ World Map â”€â”€ -->
      <div class="panel reality-card" id="fantasy-worldmap" style="border-color:rgba(120,80,200,0.2);">
        <h2 class="reality-card-header" onclick="toggleFantasyCard('worldmap')" style="color:var(--fantasy-accent,#9966ff);">ğŸ—ºï¸ World Map <span class="collapse-icon" id="worldmap-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="worldmap-body">
          <canvas id="world-map-canvas" width="560" height="280" style="width:100%;border-radius:8px;background:#0a0a1a;cursor:crosshair;"></canvas>
          <p style="text-align:center;margin-top:0.6rem;color:var(--fantasy-accent,#9966ff);font-style:italic;font-size:0.85rem;">
            "The world is being builtâ€¦"
          </p>
          <p style="font-size:0.8rem;color:var(--text-muted);text-align:center;line-height:1.6;">
            In the age before networks, humanity was scattered â€” isolated villages of thought, unable to share their fire.<br>
            Now the map fills itself, one connection at a time.
          </p>
        </div>
      </div>

      <!-- â”€â”€ Character Sheet â”€â”€ -->
      <div class="panel reality-card" id="fantasy-character" style="border-color:rgba(120,80,200,0.2);">
        <h2 class="reality-card-header" onclick="toggleFantasyCard('character')" style="color:var(--fantasy-accent,#9966ff);">âš”ï¸ Character Sheet <span class="collapse-icon" id="character-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="character-body">
          <div id="char-create" style="display:none;">
            <p style="font-size:0.82rem;color:var(--text-muted);margin-bottom:0.6rem;">Create your character to begin.</p>
            <input type="text" id="char-name-input" placeholder="Character name" maxlength="24" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:0.4rem;">
            <select id="char-class-input" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;font-family:inherit;margin-bottom:0.6rem;">
              <option value="Explorer">ğŸ§­ Explorer</option>
              <option value="Builder">ğŸ”¨ Builder</option>
              <option value="Scholar">ğŸ“š Scholar</option>
              <option value="Guardian">ğŸ›¡ï¸ Guardian</option>
            </select>
            <button onclick="createCharacter()" style="background:var(--fantasy-accent,#9966ff);color:#fff;border:none;padding:0.5rem 1.2rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;width:100%;">Create Character</button>
          </div>
          <div id="char-display" style="display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
              <div>
                <span id="char-d-name" style="font-weight:700;font-size:1rem;color:var(--text);"></span>
                <span id="char-d-class" style="font-size:0.8rem;color:var(--fantasy-accent,#9966ff);margin-left:0.4rem;"></span>
              </div>
              <span id="char-d-level" style="font-size:0.75rem;color:var(--text-muted);background:var(--bg-input);padding:0.15rem 0.5rem;border-radius:10px;"></span>
            </div>
            <div id="char-stats" style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;margin-bottom:0.6rem;"></div>
            <div style="display:flex;gap:0.4rem;">
              <button onclick="rerollStats()" style="flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem;border-radius:6px;font-size:0.8rem;cursor:pointer;font-family:inherit;">ğŸ² Reroll Stats</button>
              <button onclick="deleteCharacter()" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.4rem 0.8rem;border-radius:6px;font-size:0.8rem;cursor:pointer;font-family:inherit;">ğŸ—‘ï¸</button>
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Lore / Codex â”€â”€ -->
      <div class="panel reality-card" id="fantasy-lore" style="border-color:rgba(120,80,200,0.2);">
        <h2 class="reality-card-header" onclick="toggleFantasyCard('lore')" style="color:var(--fantasy-accent,#9966ff);">ğŸ“œ Lore / Codex <span class="collapse-icon" id="lore-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="lore-body">
          <div id="lore-entries" style="display:flex;flex-direction:column;gap:0.4rem;"></div>
        </div>
      </div>

      <!-- â”€â”€ Achievements â”€â”€ -->
      <div class="panel reality-card" id="fantasy-achievements" style="border-color:rgba(120,80,200,0.2);">
        <h2 class="reality-card-header" onclick="toggleFantasyCard('achievements')" style="color:var(--fantasy-accent,#9966ff);">ğŸ† Achievements <span class="collapse-icon" id="achievements-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="achievements-body">
          <div id="achievement-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:0.5rem;"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Streams Tab -->
  <div id="tab-streams" class="tab-content">
    <div class="card-grid">

      <!-- â”€â”€ How It Works â”€â”€ -->
      <div class="panel reality-card" id="streams-howitworks">
        <h2 class="reality-card-header" onclick="toggleStreamsCard('howitworks')">ğŸ¬ How It Works <span class="collapse-icon" id="howitworks-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="howitworks-body">
          <p style="margin-bottom:0.8rem;">Peer-assisted streaming: the more viewers, the <em>better</em> it works.</p>
          <!-- Visual diagram -->
          <div style="display:flex;align-items:center;justify-content:center;gap:0.3rem;flex-wrap:wrap;margin:1rem 0;font-size:0.75rem;">
            <div style="text-align:center;padding:0.6rem;background:rgba(153,102,255,0.15);border:1px solid rgba(153,102,255,0.3);border-radius:8px;min-width:80px;">
              <div style="font-size:1.3rem;">ğŸ¥</div>
              <div style="color:var(--text);font-weight:600;">Creator</div>
              <div style="color:var(--text-muted);font-size:0.65rem;">Captures screen/cam</div>
            </div>
            <div style="color:var(--text-muted);font-size:1.2rem;">â†’</div>
            <div style="text-align:center;padding:0.6rem;background:rgba(68,136,255,0.15);border:1px solid rgba(68,136,255,0.3);border-radius:8px;min-width:80px;">
              <div style="font-size:1.3rem;">ğŸ–¥ï¸</div>
              <div style="color:var(--text);font-weight:600;">Relay</div>
              <div style="color:var(--text-muted);font-size:0.65rem;">Distributes to first viewers</div>
            </div>
            <div style="color:var(--text-muted);font-size:1.2rem;">â†’</div>
            <div style="text-align:center;padding:0.6rem;background:rgba(68,204,102,0.15);border:1px solid rgba(68,204,102,0.3);border-radius:8px;min-width:80px;">
              <div style="font-size:1.3rem;">ğŸ‘¥</div>
              <div style="color:var(--text);font-weight:600;">Viewers</div>
              <div style="color:var(--text-muted);font-size:0.65rem;">Seed to each other (mesh)</div>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:0.6rem;margin-top:0.8rem;">
            <div style="padding:0.5rem;background:rgba(255,255,255,0.02);border-radius:6px;font-size:0.8rem;">
              <strong style="color:var(--accent);">1. You stream</strong><br>Your camera/screen goes to the relay server.
            </div>
            <div style="padding:0.5rem;background:rgba(255,255,255,0.02);border-radius:6px;font-size:0.8rem;">
              <strong style="color:var(--accent);">2. Relay distributes</strong><br>Server sends to the first viewers.
            </div>
            <div style="padding:0.5rem;background:rgba(255,255,255,0.02);border-radius:6px;font-size:0.8rem;">
              <strong style="color:var(--accent);">3. Viewers seed</strong><br>Each viewer shares chunks with others. More = better.
            </div>
            <div style="padding:0.5rem;background:rgba(255,255,255,0.02);border-radius:6px;font-size:0.8rem;">
              <strong style="color:var(--accent);">4. You control BW</strong><br>Set your upload contribution. Gaming? Low. Idle? Crank it.
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Go Live â”€â”€ -->
      <div class="panel reality-card" id="streams-golive">
        <h2 class="reality-card-header" onclick="toggleStreamsCard('golive')">ğŸ“¡ Go Live <span class="collapse-icon" id="golive-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="golive-body">
          <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.6rem;">Streaming infrastructure coming soon â€” for now, test your camera/screen capture.</p>
          <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.8rem;">
            <button class="btn btn-clickable" id="capture-camera-btn" onclick="startCapture('camera')">ğŸ“· Camera</button>
            <button class="btn btn-clickable" id="capture-screen-btn" onclick="startCapture('screen')">ğŸ–¥ï¸ Screen</button>
            <button class="btn btn-disabled" id="capture-stop-btn" onclick="stopCapture()" style="display:none;">â¹ Stop</button>
          </div>
          <div id="capture-status" style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.5rem;"></div>
          <video id="capture-preview" autoplay muted playsinline style="display:none;width:100%;max-height:300px;border-radius:8px;background:#000;"></video>
        </div>
      </div>

      <!-- â”€â”€ Live Streams â”€â”€ -->
      <div class="panel reality-card" id="streams-live">
        <h2 class="reality-card-header" onclick="toggleStreamsCard('live')">ğŸ“º Live Streams <span class="collapse-icon" id="live-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="live-body">
          <div style="text-align:center;padding:2rem 1rem;">
            <div style="font-size:2rem;margin-bottom:0.5rem;">ğŸ“º</div>
            <div style="color:var(--text-muted);font-size:0.85rem;">No one is live right now</div>
            <div style="color:var(--text-muted);font-size:0.75rem;margin-top:0.3rem;">Be the first to test your capture above!</div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Server List â”€â”€ -->
      <div class="panel reality-card" id="streams-servers">
        <h2 class="reality-card-header" onclick="toggleStreamsCard('servers')">ğŸ–¥ï¸ Server List <span class="collapse-icon" id="servers-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="servers-body">
          <div id="stream-servers-list">
            <div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem;background:rgba(255,255,255,0.02);border-radius:6px;margin-bottom:0.4rem;">
              <span style="font-size:1.1rem;" id="server-status-dot">ğŸŸ¢</span>
              <div>
                <div style="font-weight:600;font-size:0.85rem;">Humanity HQ</div>
                <div style="font-size:0.7rem;color:var(--text-muted);">united-humanity.us Â· Verified + Accord</div>
              </div>
              <span style="margin-left:auto;font-size:0.75rem;color:var(--text-muted);">0 live</span>
            </div>
          </div>
          <p style="font-size:0.75rem;color:var(--text-muted);margin-top:0.5rem;font-style:italic;">Federated server list coming soon.</p>
        </div>
      </div>

    </div>
  </div>

  <!-- Debug Tab -->
  <div id="tab-debug" class="tab-content">
    <div class="panel">
      <h2>ğŸ”§ System Information</h2>
      <p>Version, connection status, and system diagnostics.</p>
      <dl class="debug-info">
        <dt>Client Version</dt>
        <dd id="debug-version">â€”</dd>
        <dt>Server</dt>
        <dd id="debug-server">â€”</dd>
        <dt>Connection</dt>
        <dd id="debug-connection">Checkingâ€¦</dd>
        <dt>User Agent</dt>
        <dd id="debug-ua">â€”</dd>
        <dt>Screen</dt>
        <dd id="debug-screen">â€”</dd>
        <dt>Page Loaded</dt>
        <dd id="debug-loaded">â€”</dd>
      </dl>
    </div>

    <div class="panel">
      <h2>ğŸ¨ Button Design System</h2>
      <p>Interactive preview of all button states. These are the standard interaction patterns for the entire game UI.</p>

      <h3>All States (static preview)</h3>
      <div class="btn-grid">
        <div class="btn-demo">
          <button class="btn btn-clickable">Clickable</button>
          <span class="btn-label">Default Â· 1px green</span>
        </div>
        <div class="btn-demo">
          <button class="btn btn-channeling">Channeling</button>
          <span class="btn-label">Active/looping Â· 1px rainbow</span>
        </div>
        <div class="btn-demo">
          <button class="btn btn-activated">Activated</button>
          <span class="btn-label">Pressed Â· 5px red</span>
        </div>
        <div class="btn-demo">
          <button class="btn btn-disabled">Disabled</button>
          <span class="btn-label">Unclickable Â· 2px black</span>
        </div>
        <div class="btn-demo">
          <button class="btn btn-cooldown">
            Cooldown
            <span class="btn-cooldown-timer top">3.2s</span>
            <span class="btn-cooldown-timer bottom">3.2s</span>
          </button>
          <span class="btn-label">Waiting Â· 7px purple + timer</span>
        </div>
      </div>

      <h3>Interactive Test â€” Hover &amp; Click</h3>
      <p>Hover to see the blue border. Click and hold to see the red activated state.</p>
      <div class="btn-grid">
        <button class="btn" onclick="testBtnClick(this)">Hover / Click Me</button>
        <button class="btn" onclick="testBtnClick(this)">Another Button</button>
        <button class="btn" onclick="testBtnClick(this)">And Another</button>
      </div>

      <h3>Toggle Test â€” Click to Cycle States</h3>
      <p>Click to cycle: clickable â†’ channeling â†’ activated â†’ cooldown â†’ clickable</p>
      <div class="btn-grid">
        <button class="btn btn-clickable" onclick="cycleState(this)">Cycle Me</button>
        <button class="btn btn-clickable" onclick="cycleState(this)">Cycle Me Too</button>
        <button class="btn btn-clickable" onclick="cycleState(this)">And Me</button>
      </div>

      <h3>Cooldown Test â€” Click to Start Cooldown</h3>
      <div class="btn-grid">
        <button class="btn btn-clickable" onclick="startCooldown(this, 5)">5s Cooldown</button>
        <button class="btn btn-clickable" onclick="startCooldown(this, 10)">10s Cooldown</button>
        <button class="btn btn-clickable" onclick="startCooldown(this, 3)">3s Cooldown</button>
      </div>

      <h3>Channeling Test â€” Click to Start/Stop</h3>
      <div class="btn-grid">
        <button class="btn btn-clickable" onclick="toggleChannel(this)">Channel Me</button>
        <button class="btn btn-clickable" onclick="toggleChannel(this)">Channel This</button>
      </div>
    </div>

    <div class="panel">
      <h2>ğŸ¨ Color Reference</h2>
      <p>The visual language for button borders:</p>
      <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.8rem; margin-top: 0.5rem;">
        <div style="padding:0.5rem;border-left:3px solid #44cc66;background:rgba(68,204,102,0.05);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#44cc66;">Green 1px</strong> â€” Clickable / ready
        </div>
        <div style="padding:0.5rem;border-left:3px solid #4488ff;background:rgba(68,136,255,0.05);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#4488ff;">Blue 3px</strong> â€” Hovered / focused
        </div>
        <div style="padding:0.5rem;border-left:3px solid #ee3333;background:rgba(238,51,51,0.05);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#ee3333;">Red 5px</strong> â€” Activated / pressed
        </div>
        <div style="padding:0.5rem;border-left:3px solid #222;background:rgba(0,0,0,0.1);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#666;">Black 2px</strong> â€” Disabled / locked
        </div>
        <div style="padding:0.5rem;border-left:3px solid #8844cc;background:rgba(136,68,204,0.05);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#8844cc;">Purple 7px</strong> â€” Cooldown + timer
        </div>
        <div style="padding:0.5rem;border-left:3px solid;border-image:linear-gradient(90deg,#f00,#ff0,#0f0,#0ff,#00f,#f0f,#f00) 1;background:rgba(255,255,255,0.03);border-radius:0 4px 4px 0;font-size:0.8rem;">
          <strong style="background:linear-gradient(90deg,#f00,#ff0,#0f0,#0ff,#00f,#f0f);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Rainbow 1px</strong> â€” Channeling / active
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Panel (inline, replaces tab content) -->
  <div id="tab-settings" class="tab-content" style="padding:1.5rem;">
    <div class="panel">
      <h2 id="settings-title">âš™ Settings</h2>
      <div id="settings-body"></div>
    </div>
  </div>

  <script>
    // â”€â”€ Hub Tab System (SPA with pushState) â”€â”€
    const HUB_TABS = ['reality', 'fantasy', 'streams', 'debug'];
    let currentTab = 'reality';

    function getTabFromPath() {
      const path = window.location.pathname.replace(/^\//, '').replace(/\/$/, '').toLowerCase();
      if (HUB_TABS.includes(path)) return path;
      return null;
    }

    function switchTab(tabId, pushState) {
      if (!HUB_TABS.includes(tabId)) tabId = 'reality';
      currentTab = tabId;

      // Update nav active state
      document.querySelectorAll('.hub-nav .tab').forEach(el => {
        el.classList.toggle('active', el.dataset.tab === tabId);
      });

      // Show correct content panel
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      const tabEl = document.getElementById('tab-' + tabId);
      if (tabEl) tabEl.classList.add('active');

      // Update page title
      const titles = { reality: 'Reality', fantasy: 'Fantasy', streams: 'Streams', debug: 'Debug' };
      document.title = 'Humanity â€” ' + (titles[tabId] || 'Hub');

      // Update URL
      if (pushState !== false) {
        const newPath = '/' + tabId;
        if (window.location.pathname !== newPath) {
          history.pushState({ tab: tabId }, '', newPath);
        }
      }
    }

    // SPA navigation: intercept hub tab clicks
    document.querySelectorAll('.hub-nav .tab[data-tab]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        switchTab(link.dataset.tab);
      });
    });

    // Handle browser back/forward
    window.addEventListener('popstate', (e) => {
      const tab = (e.state && e.state.tab) || getTabFromPath();
      if (tab) switchTab(tab, false);
    });

    // Initialize from URL
    const initialTab = getTabFromPath() || 'reality';
    switchTab(initialTab, false);

    // â”€â”€ Debug Info â”€â”€
    (function populateDebugInfo() {
      const el = (id) => document.getElementById(id);
      el('debug-version').textContent = '0.1.0-dev';
      el('debug-server').textContent = window.location.origin;
      el('debug-ua').textContent = navigator.userAgent.slice(0, 100);
      el('debug-screen').textContent = screen.width + 'Ã—' + screen.height + ' Â· ' + (window.devicePixelRatio || 1) + 'x DPR';
      el('debug-loaded').textContent = new Date().toISOString();

      // Check relay connection
      async function checkConnection() {
        try {
          const res = await fetch('/api/stats');
          if (res.ok) {
            const data = await res.json();
            el('debug-connection').textContent = 'âœ… Connected â€” ' + (data.online_users || 0) + ' users online';
            el('debug-connection').style.color = '#4a8';
            if (data.version) el('debug-version').textContent = data.version;
          } else {
            el('debug-connection').textContent = 'âš ï¸ Server responded ' + res.status;
            el('debug-connection').style.color = '#eb4';
          }
        } catch (e) {
          el('debug-connection').textContent = 'âŒ Cannot reach server';
          el('debug-connection').style.color = '#e55';
        }
      }
      checkConnection();
    })();

    // â”€â”€ Global: Click activates red border for 1s â”€â”€
    document.addEventListener('click', function(e) {
      const btn = e.target.closest('.btn');
      if (!btn || btn.classList.contains('btn-disabled') || btn.classList.contains('btn-cooldown')) return;
      const wasChanneling = btn.classList.contains('btn-channeling');
      btn.classList.add('btn-activated');
      if (wasChanneling) btn.style.animation = 'none';
      setTimeout(() => {
        btn.classList.remove('btn-activated');
        if (wasChanneling) btn.style.animation = '';
      }, 1000);
    });

    // â”€â”€ Button Test Functions â”€â”€
    function testBtnClick(btn) {
      btn.textContent = 'âœ“ Clicked!';
      setTimeout(() => { btn.textContent = 'Hover / Click Me'; }, 800);
    }

    const states = ['btn-clickable', 'btn-channeling', 'btn-activated', 'btn-cooldown', 'btn-disabled'];
    function cycleState(btn) {
      const current = states.find(s => btn.classList.contains(s)) || 'btn-clickable';
      const idx = states.indexOf(current);
      const next = states[(idx + 1) % states.length];
      states.forEach(s => btn.classList.remove(s));
      btn.classList.add(next);
      btn.querySelectorAll('.btn-cooldown-timer').forEach(t => t.remove());
      if (next === 'btn-cooldown') {
        btn.innerHTML = btn.textContent.replace(/[\d.]+s/g, '').trim();
        const topT = document.createElement('span');
        topT.className = 'btn-cooldown-timer top';
        topT.textContent = 'âˆ';
        const botT = document.createElement('span');
        botT.className = 'btn-cooldown-timer bottom';
        botT.textContent = 'âˆ';
        btn.appendChild(topT);
        btn.appendChild(botT);
      }
    }

    function startCooldown(btn, seconds) {
      if (btn.classList.contains('btn-cooldown')) return;
      const originalText = btn.textContent;
      btn.classList.remove('btn-clickable');
      btn.classList.add('btn-cooldown');

      const topT = document.createElement('span');
      topT.className = 'btn-cooldown-timer top';
      const botT = document.createElement('span');
      botT.className = 'btn-cooldown-timer bottom';
      btn.appendChild(topT);
      btn.appendChild(botT);

      let remaining = seconds;
      const update = () => {
        topT.textContent = remaining.toFixed(1) + 's';
        botT.textContent = remaining.toFixed(1) + 's';
      };
      update();

      const interval = setInterval(() => {
        remaining -= 0.1;
        if (remaining <= 0) {
          clearInterval(interval);
          btn.classList.remove('btn-cooldown');
          btn.classList.add('btn-clickable');
          topT.remove();
          botT.remove();
          btn.textContent = originalText;
        } else {
          update();
        }
      }, 100);
    }

    function toggleGoLive(btn) {
      if (btn.classList.contains('btn-channeling')) {
        btn.classList.remove('btn-channeling');
        btn.classList.add('btn-clickable');
        btn.textContent = 'Start Stream';
        document.getElementById('stream-status').textContent = 'Not streaming';
        document.getElementById('stream-status').style.color = 'var(--text-muted)';
      } else {
        btn.classList.remove('btn-clickable');
        btn.classList.add('btn-channeling');
        btn.textContent = 'Stop Stream';
        document.getElementById('stream-status').innerHTML = '<span style="color:#e55;">â—</span> Streaming (demo mode)';
      }
    }

    function toggleChannel(btn) {
      if (btn.classList.contains('btn-channeling')) {
        btn.classList.remove('btn-channeling');
        btn.classList.add('btn-clickable');
        btn.textContent = btn.textContent.replace('Stop', 'Channel');
      } else {
        btn.classList.remove('btn-clickable');
        btn.classList.add('btn-channeling');
        btn.textContent = btn.textContent.replace('Channel', 'Stop');
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REALITY TAB â€” Todo, Notes, Garden
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â”€â”€ Card collapse â”€â”€
    function toggleRealityCard(id) {
      const card = document.getElementById('reality-' + id);
      if (card) card.classList.toggle('collapsed');
      localStorage.setItem('reality_collapsed_' + id, card.classList.contains('collapsed'));
    }
    // Restore collapse state
    ['todo', 'notes', 'garden'].forEach(id => {
      if (localStorage.getItem('reality_collapsed_' + id) === 'true') {
        const card = document.getElementById('reality-' + id);
        if (card) card.classList.add('collapsed');
      }
    });

    // â”€â”€ TODO â”€â”€
    function loadTodos() {
      try { return JSON.parse(localStorage.getItem('humanity_todos')) || []; } catch { return []; }
    }
    function saveTodos(todos) { localStorage.setItem('humanity_todos', JSON.stringify(todos)); }

    function renderTodos() {
      const todos = loadTodos();
      const list = document.getElementById('todo-list');
      const active = todos.filter(t => !t.completed);
      const done = todos.filter(t => t.completed);
      const sorted = [...active, ...done];
      list.innerHTML = sorted.length === 0 ? '<div style="color:var(--text-muted);font-size:0.8rem;font-style:italic;padding:0.5rem;">No tasks yet</div>' : '';
      sorted.forEach(t => {
        const div = document.createElement('div');
        div.className = 'todo-item' + (t.completed ? ' completed' : '');
        div.innerHTML = `<input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleTodo('${t.id}')"><span class="todo-text">${escHtml(t.text)}</span><button class="todo-delete" onclick="deleteTodo('${t.id}')" title="Delete">âœ•</button>`;
        list.appendChild(div);
      });
    }

    function addTodo() {
      const input = document.getElementById('todo-input');
      const text = input.value.trim();
      if (!text) return;
      const todos = loadTodos();
      todos.push({ id: Date.now().toString(36), text, completed: false, createdAt: new Date().toISOString() });
      saveTodos(todos);
      input.value = '';
      renderTodos();
    }

    function toggleTodo(id) {
      const todos = loadTodos();
      const t = todos.find(x => x.id === id);
      if (t) t.completed = !t.completed;
      saveTodos(todos);
      renderTodos();
    }

    function deleteTodo(id) {
      saveTodos(loadTodos().filter(x => x.id !== id));
      renderTodos();
    }

    // â”€â”€ NOTES â”€â”€
    let currentNoteId = null;

    function loadNotes() {
      try { return JSON.parse(localStorage.getItem('humanity_notes')) || []; } catch { return []; }
    }
    function saveNotes(notes) { localStorage.setItem('humanity_notes', JSON.stringify(notes)); }

    function renderNotes() {
      const notes = loadNotes();
      const list = document.getElementById('notes-list');
      list.innerHTML = notes.length === 0 ? '<div style="color:var(--text-muted);font-size:0.8rem;font-style:italic;padding:0.3rem;">No notes yet</div>' : '';
      notes.forEach(n => {
        const div = document.createElement('div');
        div.className = 'note-item' + (n.id === currentNoteId ? ' active' : '');
        div.innerHTML = `<span onclick="selectNote('${n.id}')">${escHtml(n.title || 'Untitled')}</span><button class="note-delete" onclick="event.stopPropagation();deleteNote('${n.id}')" title="Delete">âœ•</button>`;
        div.querySelector('span').style.flex = '1';
        div.querySelector('span').style.cursor = 'pointer';
        list.appendChild(div);
      });
    }

    function addNote() {
      const notes = loadNotes();
      const id = Date.now().toString(36);
      notes.unshift({ id, title: '', content: '', updatedAt: new Date().toISOString() });
      saveNotes(notes);
      selectNote(id);
    }

    function selectNote(id) {
      currentNoteId = id;
      const notes = loadNotes();
      const note = notes.find(n => n.id === id);
      const editor = document.getElementById('notes-editor');
      if (note) {
        document.getElementById('note-title').value = note.title;
        document.getElementById('note-content').value = note.content;
        editor.style.display = 'block';
      }
      renderNotes();
    }

    function saveCurrentNote() {
      if (!currentNoteId) return;
      const notes = loadNotes();
      const note = notes.find(n => n.id === currentNoteId);
      if (note) {
        note.title = document.getElementById('note-title').value;
        note.content = document.getElementById('note-content').value;
        note.updatedAt = new Date().toISOString();
        saveNotes(notes);
        renderNotes();
      }
    }

    function deleteNote(id) {
      saveNotes(loadNotes().filter(n => n.id !== id));
      if (currentNoteId === id) {
        currentNoteId = null;
        document.getElementById('notes-editor').style.display = 'none';
      }
      renderNotes();
    }

    // â”€â”€ GARDEN â”€â”€
    function loadGarden() {
      try { return JSON.parse(localStorage.getItem('humanity_garden')) || { size: 4, plots: {} }; } catch { return { size: 4, plots: {} }; }
    }
    function saveGarden(g) { localStorage.setItem('humanity_garden', JSON.stringify(g)); }

    function renderGarden() {
      const g = loadGarden();
      const grid = document.getElementById('garden-grid');
      const sizeSelect = document.getElementById('garden-size');
      sizeSelect.value = g.size || 4;
      grid.style.gridTemplateColumns = `repeat(${g.size}, 1fr)`;
      grid.innerHTML = '';
      for (let i = 0; i < g.size * g.size; i++) {
        const plot = document.createElement('div');
        const data = g.plots[i];
        plot.className = 'garden-plot' + (data ? ' planted' : '');
        plot.textContent = data ? data.plant : 'ğŸŒ±';
        plot.title = data ? `${data.plant}${data.planted ? '\nPlanted: ' + data.planted : ''}` : 'Empty plot â€” click to plant';
        plot.onclick = () => editPlot(i);
        grid.appendChild(plot);
      }
    }

    function editPlot(index) {
      const g = loadGarden();
      const existing = g.plots[index];
      const plant = prompt('What is planted here?' + (existing ? ' (clear to remove)' : ''), existing ? existing.plant : '');
      if (plant === null) return;
      if (plant.trim() === '') {
        delete g.plots[index];
      } else {
        const planted = existing ? existing.planted : new Date().toISOString().split('T')[0];
        g.plots[index] = { plant: plant.trim(), planted };
      }
      saveGarden(g);
      renderGarden();
    }

    function resizeGarden() {
      const g = loadGarden();
      g.size = parseInt(document.getElementById('garden-size').value) || 4;
      saveGarden(g);
      renderGarden();
    }

    function escHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    // Init reality tab
    renderTodos();
    renderNotes();
    renderGarden();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FANTASY TAB
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â”€â”€ Card collapse (reuse pattern) â”€â”€
    function toggleFantasyCard(id) {
      const card = document.getElementById('fantasy-' + id);
      if (card) card.classList.toggle('collapsed');
      localStorage.setItem('fantasy_collapsed_' + id, card.classList.contains('collapsed'));
    }
    ['worldmap', 'character', 'lore', 'achievements'].forEach(id => {
      if (localStorage.getItem('fantasy_collapsed_' + id) === 'true') {
        const card = document.getElementById('fantasy-' + id);
        if (card) card.classList.add('collapsed');
      }
    });

    // â”€â”€ World Map (procedural grid) â”€â”€
    (function drawWorldMap() {
      const canvas = document.getElementById('world-map-canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      // Seed-based pseudo-random
      let seed = 42;
      function rng() { seed = (seed * 16807 + 0) % 2147483647; return (seed - 1) / 2147483646; }

      // Draw terrain grid
      const cellSize = 8;
      const cols = Math.ceil(w / cellSize), rows = Math.ceil(h / cellSize);
      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          const v = rng();
          const cx = x / cols, cy = y / rows;
          const dist = Math.sqrt((cx - 0.5) ** 2 + (cy - 0.5) ** 2);
          if (v < 0.15 + dist * 0.3) {
            // water
            const b = Math.floor(40 + rng() * 30);
            ctx.fillStyle = `rgb(${5+Math.floor(rng()*10)},${10+Math.floor(rng()*15)},${b})`;
          } else if (v < 0.5) {
            // land
            const g = Math.floor(25 + rng() * 35);
            ctx.fillStyle = `rgb(${8+Math.floor(rng()*12)},${g},${8+Math.floor(rng()*10)})`;
          } else if (v < 0.75) {
            // highlands
            const g = Math.floor(35 + rng() * 20);
            ctx.fillStyle = `rgb(${15+Math.floor(rng()*10)},${g},${20+Math.floor(rng()*10)})`;
          } else {
            // mountains
            const g = Math.floor(20 + rng() * 15);
            ctx.fillStyle = `rgb(${g},${g},${g+5})`;
          }
          ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
        }
      }
      // Overlay fog
      const grad = ctx.createRadialGradient(w/2, h/2, w*0.15, w/2, h/2, w*0.5);
      grad.addColorStop(0, 'rgba(10,10,26,0)');
      grad.addColorStop(1, 'rgba(10,10,26,0.85)');
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, w, h);
      // Label
      ctx.font = '14px sans-serif';
      ctx.fillStyle = 'rgba(153,102,255,0.6)';
      ctx.textAlign = 'center';
      ctx.fillText('âš” Terra Incognita âš”', w/2, h/2);
    })();

    // â”€â”€ Character Sheet â”€â”€
    function loadCharacter() {
      try { return JSON.parse(localStorage.getItem('humanity_character')); } catch { return null; }
    }
    function saveCharacter(c) { localStorage.setItem('humanity_character', JSON.stringify(c)); }

    function rollStats() {
      const roll = () => Math.floor(Math.random() * 16) + 3; // 3-18
      return { Strength: roll(), Intelligence: roll(), Dexterity: roll(), Charisma: roll() };
    }

    function renderCharacter() {
      const c = loadCharacter();
      const create = document.getElementById('char-create');
      const display = document.getElementById('char-display');
      if (!c) {
        create.style.display = 'block';
        display.style.display = 'none';
        return;
      }
      create.style.display = 'none';
      display.style.display = 'block';
      const classIcons = { Explorer: 'ğŸ§­', Builder: 'ğŸ”¨', Scholar: 'ğŸ“š', Guardian: 'ğŸ›¡ï¸' };
      document.getElementById('char-d-name').textContent = c.name;
      document.getElementById('char-d-class').textContent = (classIcons[c.class] || '') + ' ' + c.class;
      document.getElementById('char-d-level').textContent = 'Lv. ' + (c.level || 1);
      const statsEl = document.getElementById('char-stats');
      const statColors = { Strength: '#e55', Intelligence: '#58f', Dexterity: '#4c8', Charisma: '#eb4' };
      statsEl.innerHTML = Object.entries(c.stats).map(([k, v]) => {
        const pct = ((v - 3) / 15 * 100).toFixed(0);
        return `<div style="background:var(--bg-input);border-radius:6px;padding:0.35rem 0.5rem;">
          <div style="display:flex;justify-content:space-between;font-size:0.75rem;margin-bottom:0.2rem;">
            <span style="color:var(--text-muted);">${k}</span><span style="color:${statColors[k]||'var(--text)'};font-weight:700;">${v}</span>
          </div>
          <div style="background:var(--bg);border-radius:3px;height:4px;overflow:hidden;">
            <div style="width:${pct}%;height:100%;background:${statColors[k]||'var(--accent)'};border-radius:3px;"></div>
          </div>
        </div>`;
      }).join('');

      // Auto-unlock achievements
      checkAchievements();
    }

    function createCharacter() {
      const name = document.getElementById('char-name-input').value.trim();
      if (!name) { document.getElementById('char-name-input').style.borderColor = '#e55'; return; }
      const cls = document.getElementById('char-class-input').value;
      saveCharacter({ name, class: cls, level: 1, stats: rollStats(), createdAt: new Date().toISOString() });
      renderCharacter();
      // Unlock achievement
      unlockAchievement('character_created');
    }

    function rerollStats() {
      const c = loadCharacter();
      if (!c) return;
      c.stats = rollStats();
      saveCharacter(c);
      renderCharacter();
    }

    function deleteCharacter() {
      if (!confirm('Delete your character? This cannot be undone.')) return;
      localStorage.removeItem('humanity_character');
      renderCharacter();
    }

    renderCharacter();

    // â”€â”€ Lore / Codex â”€â”€
    const LORE_ENTRIES = [
      {
        title: 'ğŸŒ… The Awakening',
        text: 'Before the Network, humanity existed in silos â€” each mind an island, separated by distance, language, and power structures designed to keep them apart. The first spark came not from technology, but from a simple idea: what if we actually cooperated?'
      },
      {
        title: 'ğŸ”— The Accord',
        text: 'The Humanity Accord is not a contract â€” it\'s a promise. Every node in the network agrees to three principles: Transparency in governance, equity in access, and cooperation over competition. Those who sign the Accord don\'t just join a network â€” they join a movement.'
      },
      {
        title: 'ğŸŒŒ The Long Road',
        text: 'The destination was always the stars. But first, humanity had to learn to talk to itself. The Humanity Network is the foundation â€” a mesh of minds, resources, and purpose. From chat rooms to space stations, every great journey begins with "hello."'
      },
      {
        title: 'ğŸ›¡ï¸ The Guardians',
        text: 'Not every force in the world welcomes cooperation. The Guardians are those who protect the network â€” not with weapons, but with code, with vigilance, with the simple act of refusing to let the dream die. They moderate, they build, they hold the line.'
      },
      {
        title: 'ğŸ“¡ The Relay',
        text: 'Messages travel through the Relay â€” a decentralized web of servers that carry humanity\'s voice. No single point of failure, no single point of control. When one relay falls, others rise. The network remembers, even when individuals forget.'
      }
    ];

    function renderLore() {
      const container = document.getElementById('lore-entries');
      container.innerHTML = LORE_ENTRIES.map((entry, i) => `
        <details style="background:var(--bg-input);border-radius:6px;padding:0.1rem 0.6rem;" ${i === 0 ? 'open' : ''}>
          <summary style="cursor:pointer;font-weight:600;font-size:0.85rem;color:var(--text);padding:0.4rem 0;user-select:none;list-style:none;">
            ${entry.title}
          </summary>
          <p style="font-size:0.82rem;color:var(--text-muted);line-height:1.6;padding:0 0 0.5rem;">${entry.text}</p>
        </details>
      `).join('');
    }
    renderLore();

    // â”€â”€ Achievements â”€â”€
    const ACHIEVEMENTS = [
      { id: 'first_steps', icon: 'ğŸ‘£', name: 'First Steps', desc: 'Visited the Humanity Hub', auto: true },
      { id: 'character_created', icon: 'âš”ï¸', name: 'Born Anew', desc: 'Created a character' },
      { id: 'voice_of_people', icon: 'ğŸ“¢', name: 'Voice of the People', desc: 'Sent your first message' },
      { id: 'gardener', icon: 'ğŸŒ±', name: 'Green Thumb', desc: 'Planted something in your garden' },
      { id: 'note_taker', icon: 'ğŸ“', name: 'Scribe', desc: 'Created your first note' },
      { id: 'explorer', icon: 'ğŸ§­', name: 'Explorer', desc: 'Visited all hub tabs' },
      { id: 'lore_reader', icon: 'ğŸ“œ', name: 'Lorekeeper', desc: 'Read all codex entries' },
      { id: 'customizer', icon: 'ğŸ¨', name: 'Fashionista', desc: 'Changed your accent color' },
      { id: 'night_owl', icon: 'ğŸ¦‰', name: 'Night Owl', desc: 'Online past midnight' },
      { id: 'streamer', icon: 'ğŸ¥', name: 'Camera Ready', desc: 'Tested screen/camera capture' },
      { id: 'completionist', icon: 'ğŸ’', name: 'Completionist', desc: 'Unlock all other achievements' },
      { id: 'secret', icon: 'ğŸ”®', name: '???', desc: 'A secret achievementâ€¦' },
    ];

    function loadAchievements() {
      try { return JSON.parse(localStorage.getItem('humanity_achievements')) || []; } catch { return []; }
    }
    function saveAchievements(a) { localStorage.setItem('humanity_achievements', JSON.stringify(a)); }

    function unlockAchievement(id) {
      const unlocked = loadAchievements();
      if (unlocked.includes(id)) return;
      unlocked.push(id);
      saveAchievements(unlocked);
      renderAchievements();
    }

    function checkAchievements() {
      // Auto-unlock based on conditions
      unlockAchievement('first_steps');
      if (localStorage.getItem('humanity_character')) unlockAchievement('character_created');
      if (localStorage.getItem('humanity_name')) unlockAchievement('voice_of_people');
      const garden = (() => { try { return JSON.parse(localStorage.getItem('humanity_garden')); } catch { return null; } })();
      if (garden && garden.plots && Object.keys(garden.plots).length > 0) unlockAchievement('gardener');
      const notes = (() => { try { return JSON.parse(localStorage.getItem('humanity_notes')); } catch { return []; } })();
      if (notes.length > 0) unlockAchievement('note_taker');
      const settings = (() => { try { return JSON.parse(localStorage.getItem('humanity_settings')); } catch { return {}; } })();
      if (settings.accent && settings.accent !== '#FF8811') unlockAchievement('customizer');
      if (new Date().getHours() >= 0 && new Date().getHours() < 5) unlockAchievement('night_owl');
    }

    function renderAchievements() {
      const unlocked = loadAchievements();
      const grid = document.getElementById('achievement-grid');
      grid.innerHTML = ACHIEVEMENTS.map(a => {
        const isUnlocked = unlocked.includes(a.id);
        return `<div style="background:${isUnlocked ? 'rgba(153,102,255,0.1)' : 'var(--bg-input)'};border:1px solid ${isUnlocked ? 'rgba(153,102,255,0.3)' : 'var(--border)'};border-radius:8px;padding:0.5rem;text-align:center;transition:border-color 0.2s;" title="${a.desc}">
          <div style="font-size:1.5rem;${isUnlocked ? '' : 'filter:grayscale(1) brightness(0.4);'}">${a.icon}</div>
          <div style="font-size:0.72rem;font-weight:600;color:${isUnlocked ? 'var(--text)' : 'var(--text-muted)'};margin-top:0.2rem;">${isUnlocked ? a.name : 'ğŸ”’ Locked'}</div>
          <div style="font-size:0.6rem;color:var(--text-muted);margin-top:0.1rem;">${a.desc}</div>
        </div>`;
      }).join('');
    }
    checkAchievements();
    renderAchievements();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STREAMS TAB
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function toggleStreamsCard(id) {
      const card = document.getElementById('streams-' + id);
      if (card) card.classList.toggle('collapsed');
      localStorage.setItem('streams_collapsed_' + id, card.classList.contains('collapsed'));
    }
    ['howitworks', 'golive', 'live', 'servers'].forEach(id => {
      if (localStorage.getItem('streams_collapsed_' + id) === 'true') {
        const card = document.getElementById('streams-' + id);
        if (card) card.classList.add('collapsed');
      }
    });

    let captureStream = null;

    async function startCapture(type) {
      try {
        stopCapture();
        if (type === 'camera') {
          captureStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        } else {
          captureStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
        }
        const video = document.getElementById('capture-preview');
        video.srcObject = captureStream;
        video.style.display = 'block';
        document.getElementById('capture-status').innerHTML = '<span style="color:#4a8;">â— Capturing ' + type + '</span> â€” local preview only, not streaming anywhere.';
        document.getElementById('capture-stop-btn').style.display = 'inline-flex';
        document.getElementById('capture-stop-btn').classList.remove('btn-disabled');
        document.getElementById('capture-stop-btn').classList.add('btn-activated');

        // Track end
        captureStream.getTracks().forEach(t => t.onended = () => stopCapture());

        // Unlock achievement
        unlockAchievement('streamer');
      } catch (e) {
        document.getElementById('capture-status').innerHTML = '<span style="color:#e55;">âš  ' + (e.name === 'NotAllowedError' ? 'Permission denied' : e.message) + '</span>';
      }
    }

    function stopCapture() {
      if (captureStream) {
        captureStream.getTracks().forEach(t => t.stop());
        captureStream = null;
      }
      const video = document.getElementById('capture-preview');
      if (video) { video.srcObject = null; video.style.display = 'none'; }
      const status = document.getElementById('capture-status');
      if (status) status.textContent = '';
      const stopBtn = document.getElementById('capture-stop-btn');
      if (stopBtn) { stopBtn.style.display = 'none'; }
    }

    // Track tab visits for explorer achievement
    const visitedTabs = JSON.parse(localStorage.getItem('humanity_visited_tabs') || '[]');
    const origSwitchTab = switchTab;
    switchTab = function(tabId, pushState) {
      origSwitchTab(tabId, pushState);
      if (!visitedTabs.includes(tabId)) {
        visitedTabs.push(tabId);
        localStorage.setItem('humanity_visited_tabs', JSON.stringify(visitedTabs));
      }
      if (['reality', 'fantasy', 'streams', 'debug'].every(t => visitedTabs.includes(t))) {
        unlockAchievement('explorer');
      }
    };

    // â”€â”€ Auto-refresh on server update â”€â”€
    (function() {
      let knownVersion = null;
      async function checkVersion() {
        try {
          const res = await fetch('/api/stats');
          if (!res.ok) return;
          const data = await res.json();
          if (!data.version) return;
          if (knownVersion === null) {
            knownVersion = data.version;
          } else if (knownVersion !== data.version) {
            console.log('Server updated (' + knownVersion + ' â†’ ' + data.version + '), reloadingâ€¦');
            location.reload();
          }
        } catch (e) { /* network hiccup, try again next cycle */ }
      }
      checkVersion();
      setInterval(checkVersion, 30000);
    })();
  </script>
</body>
</html>
