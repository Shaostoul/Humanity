<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Humanity</title>
  <link rel="manifest" href="/shared/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Humanity">
  <link rel="apple-touch-icon" href="/shared/icons/icon-192.png">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%231a1a2e'/%3E%3Ctext x='32' y='46' font-family='Arial,Helvetica,sans-serif' font-weight='bold' font-size='42' fill='%23FF8811' text-anchor='middle'%3EH%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="/shared/theme.css">
  <style>
    :root {
      --bg-panel: #141414;
      --border: #2a2a2a;
      --success: #4a8;
      --error: #e55;
      --warning: #eb4;

      /* Button state colors */
      --btn-clickable: #44cc66;
      --btn-hover: #4488ff;
      --btn-activated: #ee3333;
      --btn-disabled: #222222;
      --btn-cooldown: #8844cc;
    }

    body {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Tab Content ‚îÄ‚îÄ */
    .tab-content {
      flex: 1;
      display: none;
      padding: 1.5rem;
      padding-bottom: 80px;
      overflow-y: auto;
    }
    .tab-content.active { display: block; }

    .panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .panel h2 {
      font-size: 1.1rem;
      color: var(--accent);
      margin-bottom: 0.8rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.4rem;
    }

    .panel h3 {
      font-size: 0.9rem;
      color: var(--text);
      margin: 1rem 0 0.5rem;
    }

    .panel p {
      font-size: 0.85rem;
      color: var(--text-muted);
      line-height: 1.6;
      margin-bottom: 0.5rem;
    }

    .placeholder-text {
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.9rem;
      text-align: center;
      padding: 2rem 1rem;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }

    .card-grid .panel {
      transition: border-color 0.2s;
    }
    .card-grid .panel:hover {
      border-color: rgba(255, 136, 17, 0.3);
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       BUTTON DESIGN SYSTEM
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 120px;
      min-height: 44px;
      padding: 0.5rem 1.2rem;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      background: var(--bg-panel);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: box-shadow 0.15s ease;
      position: relative;
      user-select: none;
      font-family: inherit;
      box-shadow: inset 0 0 0 1px var(--btn-clickable);
    }

    .btn.btn-clickable,
    .btn:not(.btn-disabled):not(.btn-cooldown):not(.btn-channeling):not(.btn-activated) {
      box-shadow: inset 0 0 0 1px var(--btn-clickable);
    }

    .btn:not(.btn-disabled):not(.btn-cooldown):not(.btn-activated):hover {
      box-shadow: inset 0 0 0 3px var(--btn-hover), 0 0 12px rgba(68, 136, 255, 0.4) !important;
      animation: none;
    }

    .btn.btn-activated {
      box-shadow: inset 0 0 0 5px var(--btn-activated), 0 0 12px rgba(238, 51, 51, 0.4) !important;
      animation: none;
    }

    .btn.btn-channeling {
      animation: rainbow-shadow 3s linear infinite;
    }

    @keyframes rainbow-shadow {
      0%   { box-shadow: inset 0 0 0 1px #ff0000, 0 0 8px rgba(255,0,0,0.3); }
      16%  { box-shadow: inset 0 0 0 1px #ff8800, 0 0 8px rgba(255,136,0,0.3); }
      33%  { box-shadow: inset 0 0 0 1px #ffff00, 0 0 8px rgba(255,255,0,0.3); }
      50%  { box-shadow: inset 0 0 0 1px #00ff44, 0 0 8px rgba(0,255,68,0.3); }
      66%  { box-shadow: inset 0 0 0 1px #0088ff, 0 0 8px rgba(0,136,255,0.3); }
      83%  { box-shadow: inset 0 0 0 1px #8800ff, 0 0 8px rgba(136,0,255,0.3); }
      100% { box-shadow: inset 0 0 0 1px #ff0000, 0 0 8px rgba(255,0,0,0.3); }
    }

    .btn.btn-disabled {
      box-shadow: inset 0 0 0 2px var(--btn-disabled);
      color: var(--text-muted);
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn.btn-disabled:hover {
      box-shadow: inset 0 0 0 2px var(--btn-disabled) !important;
    }

    .btn.btn-cooldown {
      box-shadow: inset 0 0 0 7px var(--btn-cooldown);
      cursor: wait;
      color: var(--text-muted);
    }
    .btn.btn-cooldown:hover {
      box-shadow: inset 0 0 0 7px var(--btn-cooldown) !important;
    }

    .btn-cooldown-timer {
      position: absolute;
      font-size: 0.6rem;
      font-weight: 700;
      color: var(--btn-cooldown);
      background: var(--bg-panel);
      padding: 0 0.3rem;
      letter-spacing: 0.05em;
    }
    .btn-cooldown-timer.top {
      top: -2px;
      left: 50%;
      transform: translateX(-50%);
    }
    .btn-cooldown-timer.bottom {
      bottom: -2px;
      left: 50%;
      transform: translateX(-50%);
    }

    .btn-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1.2rem;
      margin: 0.5rem 0;
      align-items: center;
    }

    .btn-demo {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.4rem;
    }

    .btn-demo .btn-label {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    /* ‚îÄ‚îÄ Settings Panel (inline) ‚îÄ‚îÄ */
    #tab-settings .panel { max-width: 600px; }

    /* ‚îÄ‚îÄ Debug info items ‚îÄ‚îÄ */
    .debug-info {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 0.3rem 1rem;
      font-size: 0.82rem;
      margin: 0.5rem 0;
    }
    .debug-info dt {
      color: var(--text-muted);
      font-weight: 600;
    }
    .debug-info dd {
      color: var(--text);
      font-family: monospace;
      font-size: 0.78rem;
    }

    /* ‚îÄ‚îÄ Skill DNA ‚îÄ‚îÄ */
    .skill-dna { display:flex; gap:0; border:1px solid var(--border); border-radius:10px; overflow:hidden; min-height:420px; background:var(--bg-card); }
    .skill-dna-sidebar { width:180px; min-width:150px; border-right:1px solid var(--border); display:flex; flex-direction:column; background:rgba(0,0,0,0.15); }
    .skill-dna-sidebar .sd-cat { padding:0.45rem 0.6rem; font-size:0.8rem; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.04); display:flex; align-items:center; gap:0.4rem; color:var(--text-muted); transition:background 0.15s; }
    .skill-dna-sidebar .sd-cat:hover, .skill-dna-sidebar .sd-cat.active { background:rgba(255,255,255,0.06); color:var(--text); }
    .skill-dna-sidebar .sd-cat.active { border-left:3px solid var(--accent); }
    .skill-dna-main { flex:1; overflow-y:auto; padding:0.8rem; }
    .skill-dna-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.6rem; }
    .skill-dna-header h3 { margin:0; font-size:0.95rem; }
    .sd-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(100px,1fr)); gap:0.5rem; }
    .sd-tile { background:var(--bg-input); border:1px solid var(--border); border-radius:8px; padding:0.5rem; text-align:center; cursor:pointer; transition:all 0.15s; position:relative; }
    .sd-tile:hover { border-color:var(--accent); transform:translateY(-1px); }
    .sd-tile .sd-icon { font-size:1.3rem; }
    .sd-tile .sd-name { font-size:0.72rem; color:var(--text); margin:0.2rem 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sd-tile .sd-level { font-size:0.65rem; font-weight:700; }
    .sd-tile .sd-bar { height:3px; background:rgba(255,255,255,0.08); border-radius:2px; margin-top:0.25rem; overflow:hidden; }
    .sd-tile .sd-bar-fill { height:100%; border-radius:2px; transition:width 0.3s; }
    .sd-tile.locked { opacity:0.5; }
    .sd-tile.locked::after { content:'üîí'; position:absolute; top:0.25rem; right:0.25rem; font-size:0.6rem; }
    .sd-stats { margin-top:0.8rem; padding:0.6rem; background:rgba(255,255,255,0.03); border-radius:8px; font-size:0.78rem; color:var(--text-muted); }
    .sd-stats div { margin:0.15rem 0; }
    .sd-stats span { color:var(--text); font-weight:600; }
    /* Skill Card Modal */
    .sd-card-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1000; display:flex; align-items:center; justify-content:center; }
    .sd-card { background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:1.2rem; max-width:420px; width:90%; max-height:80vh; overflow-y:auto; }
    .sd-card h3 { margin:0 0 0.4rem; display:flex; align-items:center; justify-content:space-between; }
    .sd-card .sd-xp-bars { margin:0.6rem 0; }
    .sd-card .sd-xp-row { display:flex; align-items:center; gap:0.5rem; margin:0.3rem 0; font-size:0.8rem; }
    .sd-card .sd-xp-row .bar { flex:1; height:8px; background:rgba(255,255,255,0.08); border-radius:4px; overflow:hidden; }
    .sd-card .sd-xp-row .bar-fill { height:100%; border-radius:4px; }
    .sd-card .sd-subskills { margin:0.6rem 0; }
    .sd-card .sd-subskill { display:flex; align-items:center; gap:0.4rem; margin:0.25rem 0; font-size:0.78rem; }
    .sd-card .sd-verifications, .sd-card .sd-activity { margin:0.5rem 0; font-size:0.78rem; }
    .sd-card .sd-actions { display:flex; gap:0.5rem; margin-top:0.8rem; }
    .sd-card .sd-actions button { flex:1; padding:0.4rem; border-radius:6px; border:1px solid var(--border); background:var(--bg-input); color:var(--text); font-size:0.8rem; cursor:pointer; font-family:inherit; }
    .sd-card .sd-actions button:hover { border-color:var(--accent); }
    /* Log Modal */
    .sd-log-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1001; display:flex; align-items:center; justify-content:center; }
    .sd-log-modal { background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:1.2rem; max-width:380px; width:90%; }
    .sd-log-modal h3 { margin:0 0 0.8rem; }
    .sd-log-modal label { display:block; font-size:0.78rem; color:var(--text-muted); margin:0.4rem 0 0.15rem; }
    .sd-log-modal input, .sd-log-modal select, .sd-log-modal textarea { width:100%; background:var(--bg-input); border:1px solid var(--border); color:var(--text); padding:0.35rem 0.5rem; border-radius:6px; font-size:0.82rem; font-family:inherit; box-sizing:border-box; }
    .sd-log-modal .sd-type-toggle { display:flex; gap:0.5rem; margin:0.3rem 0; }
    .sd-log-modal .sd-type-toggle label { display:flex; align-items:center; gap:0.25rem; cursor:pointer; color:var(--text); }
    .sd-log-modal .sd-log-actions { display:flex; gap:0.5rem; margin-top:0.8rem; }
    .sd-log-modal .sd-log-actions button { flex:1; padding:0.4rem; border-radius:6px; font-size:0.82rem; cursor:pointer; font-family:inherit; border:none; }
    /* Find People */
    .sd-find-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1001; display:flex; align-items:center; justify-content:center; }
    .sd-find-modal { background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:1.2rem; max-width:500px; width:90%; max-height:80vh; overflow-y:auto; }
    .sd-find-modal h3 { margin:0 0 0.6rem; }
    .sd-find-result { padding:0.5rem; border:1px solid var(--border); border-radius:8px; margin:0.4rem 0; display:flex; align-items:center; gap:0.6rem; }
    .sd-find-result .sd-fr-skills { font-size:0.75rem; color:var(--text-muted); }
    @media (max-width:600px) { .skill-dna { flex-direction:column; } .skill-dna-sidebar { width:100%; min-width:auto; border-right:none; border-bottom:1px solid var(--border); flex-direction:row; overflow-x:auto; } .skill-dna-sidebar .sd-cat { white-space:nowrap; border-bottom:none; } .skill-dna-sidebar .sd-cat.active { border-left:none; border-bottom:3px solid var(--accent); } }

    /* ‚îÄ‚îÄ Reality Cards ‚îÄ‚îÄ */
    .reality-card-header {
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .reality-card-header .collapse-icon {
      font-size: 0.7rem;
      color: var(--text-muted);
      transition: transform 0.2s;
    }
    .reality-card.collapsed .reality-card-body { display: none; }
    .reality-card.collapsed .collapse-icon { transform: rotate(-90deg); }

    /* Todo */
    .todo-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.4rem;
      border-radius: 4px;
      font-size: 0.85rem;
    }
    .todo-item:hover { background: var(--bg-hover); }
    .todo-item.completed { opacity: 0.5; }
    .todo-item.completed .todo-text { text-decoration: line-through; }
    .todo-item input[type="checkbox"] { accent-color: var(--accent); cursor: pointer; }
    .todo-text { flex: 1; color: var(--text); }
    .todo-delete {
      background: none; border: none; color: var(--text-muted); cursor: pointer;
      font-size: 0.75rem; padding: 0.1rem 0.3rem; border-radius: 3px; opacity: 0;
    }
    .todo-item:hover .todo-delete { opacity: 1; }
    .todo-delete:hover { color: var(--danger, #c44); }

    /* Notes */
    .note-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.5rem;
      border-radius: 4px;
      font-size: 0.82rem;
      cursor: pointer;
      color: var(--text-muted);
    }
    .note-item:hover { background: var(--bg-hover); color: var(--text); }
    .note-item.active { background: var(--accent-dim); color: var(--accent); font-weight: 600; }
    .note-delete {
      background: none; border: none; color: var(--text-muted); cursor: pointer;
      font-size: 0.7rem; padding: 0.1rem 0.3rem; opacity: 0; margin-left: auto;
    }
    .note-item:hover .note-delete { opacity: 1; }
    .note-delete:hover { color: var(--danger, #c44); }

    /* Garden Manager */
    #garden-manager { font-size: 0.85rem; }
    @media (max-width: 600px) {
      #garden-manager { flex-direction: column !important; }
      #garden-left { width: 100% !important; min-width: 0 !important; border-right: none !important; border-bottom: 1px solid var(--border); max-height: 200px; }
    }

    /* ‚îÄ‚îÄ Catalog System ‚îÄ‚îÄ */
    .catalog-search-bar {
      display: flex; gap: 0.5rem; margin-bottom: 1.2rem; position: sticky; top: 0; z-index: 10;
      background: var(--bg, #0a0a0a); padding: 0.5rem 0;
    }
    .catalog-search-bar input {
      flex: 1; background: var(--bg-input); border: 1px solid var(--border); color: var(--text);
      padding: 0.6rem 1rem; border-radius: 8px; font-size: 0.9rem; outline: none; font-family: inherit;
    }
    .catalog-search-bar input:focus { border-color: var(--accent); }
    .catalog-search-results {
      background: var(--bg-card, #1a1a1a); border: 1px solid var(--border); border-radius: 8px;
      margin-bottom: 1rem; max-height: 300px; overflow-y: auto;
    }
    .catalog-search-results:empty { display: none; }
    .catalog-result-item {
      display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem 0.8rem;
      cursor: pointer; font-size: 0.82rem; border-bottom: 1px solid var(--border);
    }
    .catalog-result-item:last-child { border-bottom: none; }
    .catalog-result-item:hover { background: var(--bg-hover, rgba(255,255,255,0.03)); }
    .catalog-result-badge {
      font-size: 0.6rem; font-weight: 700; padding: 0.1rem 0.4rem; border-radius: 3px;
      text-transform: uppercase; flex-shrink: 0;
    }

    /* Reference Sources Grid */
    .ref-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem; }
    .ref-card {
      display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.7rem;
      background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px;
      text-decoration: none; color: var(--text); font-size: 0.78rem; transition: border-color 0.15s;
    }
    .ref-card:hover { border-color: var(--accent); }
    .ref-card .ref-icon { font-size: 1.1rem; flex-shrink: 0; }
    .ref-card .ref-name { font-weight: 600; color: var(--text); }
    .ref-card .ref-desc { font-size: 0.7rem; color: var(--text-muted); }

    /* Element Cards */
    .element-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 0.4rem; }
    .element-card {
      background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px;
      padding: 0.4rem; text-align: center; cursor: pointer; transition: border-color 0.15s, transform 0.1s;
      position: relative;
    }
    .element-card:hover { transform: scale(1.05); z-index: 1; }
    .element-card .el-number { font-size: 0.6rem; color: var(--text-muted); position: absolute; top: 3px; left: 5px; }
    .element-card .el-symbol { font-size: 1.3rem; font-weight: 700; margin: 0.1rem 0; }
    .element-card .el-name { font-size: 0.6rem; color: var(--text-muted); }
    .element-card .el-mass { font-size: 0.55rem; color: var(--text-muted); opacity: 0.6; }
    .el-cat-nonmetal { border-color: rgba(76,175,80,0.4); } .el-cat-nonmetal .el-symbol { color: #4caf50; }
    .el-cat-metal { border-color: rgba(66,165,245,0.4); } .el-cat-metal .el-symbol { color: #42a5f5; }
    .el-cat-metalloid { border-color: rgba(255,167,38,0.4); } .el-cat-metalloid .el-symbol { color: #ffa726; }
    .el-cat-noble-gas { border-color: rgba(171,71,188,0.4); } .el-cat-noble-gas .el-symbol { color: #ab47bc; }
    .el-cat-transition-metal { border-color: rgba(66,165,245,0.4); } .el-cat-transition-metal .el-symbol { color: #42a5f5; }
    .el-cat-actinide { border-color: rgba(239,83,80,0.4); } .el-cat-actinide .el-symbol { color: #ef5350; }

    /* Element Detail */
    .element-detail {
      background: var(--bg-card, #1a1a1a); border: 1px solid var(--border); border-radius: 10px;
      padding: 1.2rem; margin-bottom: 1rem; animation: fadeIn 0.15s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: none; } }
    .element-detail h3 { margin: 0 0 0.6rem; font-size: 1.1rem; }
    .element-detail .el-props { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.4rem; margin: 0.6rem 0; }
    .element-detail .el-prop { background: var(--bg-input); border-radius: 4px; padding: 0.3rem 0.5rem; font-size: 0.78rem; }
    .element-detail .el-prop dt { color: var(--text-muted); font-size: 0.65rem; text-transform: uppercase; }
    .element-detail .el-prop dd { color: var(--text); font-weight: 600; margin: 0; }

    /* Materials */
    .material-card {
      background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px;
      padding: 0.7rem; cursor: pointer; transition: border-color 0.15s;
    }
    .material-card:hover { border-color: var(--accent); }
    .material-type-badge {
      display: inline-block; font-size: 0.6rem; font-weight: 700; padding: 0.1rem 0.4rem;
      border-radius: 3px; text-transform: uppercase;
    }
    .mat-raw { background: rgba(139,195,74,0.2); color: #8bc34a; }
    .mat-processed { background: rgba(66,165,245,0.2); color: #42a5f5; }
    .mat-composite { background: rgba(255,167,38,0.2); color: #ffa726; }
    .processing-chain {
      display: flex; align-items: center; gap: 0.3rem; flex-wrap: wrap;
      font-size: 0.75rem; color: var(--text-muted); margin-top: 0.4rem;
    }
    .processing-chain .chain-arrow { color: var(--accent); font-weight: 700; }

    /* Inventory */
    .inv-privacy-banner {
      background: rgba(76,175,80,0.1); border: 1px solid rgba(76,175,80,0.3); border-radius: 8px;
      padding: 0.5rem 0.8rem; font-size: 0.78rem; color: #4caf50; text-align: center; margin-bottom: 0.8rem;
    }
    .inv-toolbar { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 0.8rem; align-items: center; }
    .inv-toolbar select, .inv-toolbar input {
      background: var(--bg-input); border: 1px solid var(--border); color: var(--text);
      padding: 0.35rem 0.6rem; border-radius: 6px; font-size: 0.8rem; font-family: inherit; outline: none;
    }
    .inv-item {
      background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px;
      padding: 0.6rem; transition: border-color 0.15s;
    }
    .inv-item:hover { border-color: var(--accent); }

    /* Modal */
    .catalog-modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;
    }
    .catalog-modal-overlay.open { display: flex; }
    .catalog-modal {
      background: var(--bg-card, #1a1a1a); border: 1px solid var(--border); border-radius: 12px;
      padding: 1.5rem; max-width: 550px; width: 92%; max-height: 85vh; overflow-y: auto; position: relative;
    }
    .catalog-modal .modal-close {
      position: absolute; top: 0.5rem; right: 0.8rem; background: none; border: none;
      color: var(--text-muted); font-size: 1.3rem; cursor: pointer;
    }
    .catalog-modal label { font-size: 0.75rem; color: var(--text-muted); display: block; margin: 0.4rem 0 0.15rem; }
    .catalog-modal input, .catalog-modal select, .catalog-modal textarea {
      width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text);
      padding: 0.4rem 0.6rem; border-radius: 6px; font-size: 0.82rem; outline: none; font-family: inherit;
      box-sizing: border-box;
    }
    .catalog-modal textarea { resize: vertical; }
    .catalog-modal .modal-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .catalog-modal .modal-actions button {
      flex: 1; padding: 0.5rem; border: none; border-radius: 6px; font-size: 0.85rem;
      font-weight: 600; cursor: pointer; font-family: inherit;
    }

    .filter-pills { display: flex; gap: 0.3rem; flex-wrap: wrap; margin-bottom: 0.6rem; }
    .filter-pill {
      background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted);
      padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.72rem; cursor: pointer; transition: all 0.15s;
    }
    .filter-pill.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .filter-pill:hover { border-color: var(--accent); }

    /* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
    @media (max-width: 600px) {
      .tab-content {
        padding: 1rem;
      }
      .card-grid {
        grid-template-columns: 1fr;
      }
      .element-grid { grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); }
      .ref-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <script src="/shared/shell.js"></script>
  <script src="/shared/settings.js"></script>
  <script>
    document.querySelectorAll('.hub-nav .tab[href^="/board"]').forEach(el => el.setAttribute('data-tab', 'board'));
    document.querySelectorAll('.hub-nav .tab[href^="/reality"]').forEach(el => el.setAttribute('data-tab', 'reality'));
    document.querySelectorAll('.hub-nav .tab[href^="/fantasy"]').forEach(el => el.setAttribute('data-tab', 'fantasy'));
    document.querySelectorAll('.hub-nav .tab[href^="/streams"]').forEach(el => el.setAttribute('data-tab', 'streams'));
    document.querySelectorAll('.hub-nav .tab[href^="/info"]').forEach(el => el.setAttribute('data-tab', 'info'));
    document.querySelectorAll('.hub-nav .tab[href^="/market"]').forEach(el => el.setAttribute('data-tab', 'market'));
    document.querySelectorAll('.hub-nav .tab[href^="/browse"]').forEach(el => el.setAttribute('data-tab', 'browse'));
    document.querySelectorAll('.hub-nav .tab[href^="/dashboard"]').forEach(el => el.setAttribute('data-tab', 'dashboard'));
    document.querySelectorAll('.hub-nav .tab[href^="/debug"]').forEach(el => el.setAttribute('data-tab', 'debug'));
  </script>

  <!-- Board Tab -->
  <div id="tab-board" class="tab-content" style="padding:1rem;overflow-y:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
      <h2 style="color:var(--accent);margin:0;font-size:1.1rem;">üìã Project Board</h2>
      <button class="btn btn-clickable" id="board-create-btn" style="display:none;min-width:auto;min-height:36px;padding:0.3rem 0.8rem;font-size:0.8rem;" onclick="showCreateTaskModal()">+ New Task</button>
    </div>
    <div id="board-columns" style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.8rem;min-height:300px;">
      <div class="board-column" data-status="backlog">
        <div class="board-col-header" style="font-size:0.85rem;font-weight:700;color:var(--text-muted);padding:0.4rem 0.5rem;border-bottom:2px solid #555;margin-bottom:0.5rem;">üì• Backlog <span class="board-col-count" data-status="backlog">0</span></div>
        <div class="board-col-cards" data-status="backlog"></div>
      </div>
      <div class="board-column" data-status="in_progress">
        <div class="board-col-header" style="font-size:0.85rem;font-weight:700;color:#4488ff;padding:0.4rem 0.5rem;border-bottom:2px solid #4488ff;margin-bottom:0.5rem;">üîß In Progress <span class="board-col-count" data-status="in_progress">0</span></div>
        <div class="board-col-cards" data-status="in_progress"></div>
      </div>
      <div class="board-column" data-status="testing">
        <div class="board-col-header" style="font-size:0.85rem;font-weight:700;color:#eb4;padding:0.4rem 0.5rem;border-bottom:2px solid #eb4;margin-bottom:0.5rem;">üß™ Testing <span class="board-col-count" data-status="testing">0</span></div>
        <div class="board-col-cards" data-status="testing"></div>
      </div>
      <div class="board-column" data-status="done">
        <div class="board-col-header" style="font-size:0.85rem;font-weight:700;color:#4a8;padding:0.4rem 0.5rem;border-bottom:2px solid #4a8;margin-bottom:0.5rem;">‚úÖ Done <span class="board-col-count" data-status="done">0</span></div>
        <div class="board-col-cards" data-status="done"></div>
      </div>
    </div>
    <div id="board-loading" style="text-align:center;color:var(--text-muted);padding:2rem;font-size:0.85rem;">Loading tasks‚Ä¶</div>

    <!-- Task Modal -->
    <div id="task-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;display:none;align-items:center;justify-content:center;">
      <div style="background:var(--bg-card,#1a1a1a);border:1px solid var(--border);border-radius:12px;padding:1.5rem;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;position:relative;">
        <button onclick="closeTaskModal()" style="position:absolute;top:0.8rem;right:0.8rem;background:none;border:none;color:var(--text-muted);font-size:1.2rem;cursor:pointer;">‚úï</button>
        <div id="task-modal-content"></div>
      </div>
    </div>
  </div>

  <!-- Reality Tab -->
  <div id="tab-reality" class="tab-content">
    <!-- Universal Search -->
    <div class="catalog-search-bar">
      <input type="text" id="universal-search" placeholder="üîç Search elements, materials, inventory‚Ä¶" oninput="universalSearch(this.value)">
    </div>
    <div class="catalog-search-results" id="universal-search-results"></div>

    <div class="panel" style="margin-bottom:1rem;">
      <h2>üü¢ Reality</h2>
      <p>Your real-world dashboard. Knowledge base, catalogs, and personal tools ‚Äî all local-first.</p>
    </div>

    <!-- ‚îÄ‚îÄ Skill DNA ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="reality-skills">
      <h2 class="reality-card-header" onclick="toggleRealityCard('skills')">üß¨ Skill DNA <span class="collapse-icon" id="skills-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="skills-body">
        <div id="skill-dna-reality"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Todo List ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="reality-todo">
      <h2 class="reality-card-header" onclick="toggleRealityCard('todo')">‚úÖ Todo List <span class="collapse-icon" id="todo-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="todo-body">
        <div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;">
          <input type="text" id="todo-input" placeholder="Add a task‚Ä¶" style="flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;" onkeydown="if(event.key==='Enter')addTodo()">
          <button onclick="addTodo()" style="background:var(--accent);color:#fff;border:none;padding:0.4rem 0.8rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;">Add</button>
        </div>
        <div id="todo-list"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Notes ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="reality-notes">
      <h2 class="reality-card-header" onclick="toggleRealityCard('notes')">üìù Notes <span class="collapse-icon" id="notes-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="notes-body">
        <div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;">
          <button onclick="addNote()" style="background:var(--accent);color:#fff;border:none;padding:0.4rem 0.8rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;">+ New Note</button>
        </div>
        <div id="notes-list" style="margin-bottom:0.6rem;"></div>
        <div id="notes-editor" style="display:none;">
          <input type="text" id="note-title" placeholder="Note title" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:0.4rem;" oninput="saveCurrentNote()">
          <textarea id="note-content" placeholder="Write your note‚Ä¶" rows="8" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.5rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;resize:vertical;line-height:1.5;" oninput="saveCurrentNote()"></textarea>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Garden Manager ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="reality-garden">
      <h2 class="reality-card-header" onclick="toggleRealityCard('garden')">üå± Garden Manager <span class="collapse-icon" id="garden-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="garden-body">
        <div id="garden-manager" style="display:flex;gap:0;border:1px solid var(--border);border-radius:10px;overflow:hidden;min-height:500px;background:var(--bg-card);">
          <!-- Left: Zone Tree -->
          <div id="garden-left" style="width:220px;min-width:180px;border-right:1px solid var(--border);display:flex;flex-direction:column;background:rgba(0,0,0,0.15);">
            <div style="display:flex;align-items:center;justify-content:space-between;padding:0.5rem 0.6rem;border-bottom:1px solid var(--border);">
              <span style="font-weight:700;font-size:0.8rem;color:var(--text);">ZONES</span>
              <button onclick="gardenAddZone()" style="background:var(--accent);color:#fff;border:none;padding:0.15rem 0.5rem;border-radius:4px;font-size:0.7rem;cursor:pointer;font-weight:600;">+ New</button>
            </div>
            <div id="garden-zone-tree" style="flex:1;overflow-y:auto;padding:0.3rem;font-size:0.8rem;"></div>
          </div>
          <!-- Right: Zone Detail -->
          <div id="garden-right" style="flex:1;overflow-y:auto;padding:1rem;">
            <div id="garden-empty" style="text-align:center;color:var(--text-muted);padding:3rem 1rem;">
              <div style="font-size:2.5rem;margin-bottom:0.5rem;">üå±</div>
              <div style="font-size:0.9rem;">No zones yet. Click <strong>+ New</strong> to create your first growing zone.</div>
            </div>
            <div id="garden-zone-detail" style="display:none;"></div>
          </div>
        </div>
        <!-- Recommended Hardware (expandable) -->
        <details style="margin-top:1rem;">
          <summary style="cursor:pointer;font-size:0.85rem;font-weight:600;color:var(--accent);padding:0.4rem 0;">üì° Recommended Monitoring Hardware</summary>
          <div style="font-size:0.78rem;color:var(--text-muted);line-height:1.8;padding:0.5rem 0;">
            <strong>pH Meters:</strong> Apera PH20, Bluelab pH Pen (~$50-100) ‚Äî manual dip readings<br>
            <strong>EC/TDS Meters:</strong> Apera EC20, HM Digital (~$20-50) ‚Äî nutrient concentration<br>
            <strong>Temp/Humidity:</strong> Govee H5075 (Bluetooth, ~$12) ‚Äî ambient monitoring<br>
            <strong>Soil Moisture:</strong> Xiaomi Flora (~$15) or capacitive probes<br>
            <strong>Light Meter (PAR):</strong> Photone app (free) or Apogee MQ-500 (~$500)<br>
            <strong>Water Level:</strong> Ultrasonic HC-SR04 (~$3) with Arduino/ESP32<br>
            <strong>DO Meter:</strong> Milwaukee MW600 (~$80) ‚Äî dissolved oxygen for hydro/aqua<br>
            <strong>CO2 Sensor:</strong> SCD30/SCD40 (~$30-50) with ESP32<br>
            <strong>All-in-one:</strong> Ecowitt weather station (~$80) ‚Äî temp, humidity, soil moisture, rainfall<br>
            <strong>Camera:</strong> ESP32-CAM (~$5) for timelapse/visual monitoring<br>
            <strong>Smart Plugs:</strong> Kasa/Wemo (~$10) ‚Äî automate pumps, lights, fans
          </div>
        </details>
      </div>
    </div>

    <!-- Garden Plant Detail Modal -->
    <div id="garden-plant-modal" class="catalog-modal-overlay">
      <div class="catalog-modal" style="max-width:620px;">
        <button class="modal-close" onclick="gardenClosePlantModal()">‚úï</button>
        <div id="garden-plant-modal-content"></div>
      </div>
    </div>

    <!-- Garden Zone Edit Modal -->
    <div id="garden-zone-modal" class="catalog-modal-overlay">
      <div class="catalog-modal" style="max-width:500px;">
        <button class="modal-close" onclick="gardenCloseZoneModal()">‚úï</button>
        <h3 style="color:var(--text);margin:0 0 0.8rem;" id="garden-zone-modal-title">New Zone</h3>
        <label>Name *</label><input type="text" id="gz-name" maxlength="60">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
          <div><label>Type</label><select id="gz-type">
            <option value="field">Field</option><option value="raised_bed">Raised Bed</option>
            <option value="container">Container/Pot</option><option value="hydro_dwc">Hydro ‚Äî DWC</option>
            <option value="hydro_nft">Hydro ‚Äî NFT</option><option value="hydro_drip">Hydro ‚Äî Drip</option>
            <option value="hydro_ebb_flow">Hydro ‚Äî Ebb &amp; Flow</option>
            <option value="aeroponic">Aeroponic</option><option value="aquaponic">Aquaponic</option>
          </select></div>
          <div><label>Location</label><select id="gz-location">
            <option value="outdoor">Outdoor</option><option value="indoor">Indoor</option><option value="greenhouse">Greenhouse</option>
          </select></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.5rem;">
          <div><label>Length</label><input type="number" id="gz-length" min="0" step="0.5"></div>
          <div><label>Width</label><input type="number" id="gz-width" min="0" step="0.5"></div>
          <div><label>Unit</label><select id="gz-unit"><option value="ft">ft</option><option value="m">m</option><option value="in">in</option></select></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
          <div><label>Medium</label><select id="gz-medium">
            <option value="soil">Soil</option><option value="coco_coir">Coco Coir</option><option value="perlite">Perlite</option>
            <option value="clay_pebbles">Clay Pebbles</option><option value="rockwool">Rockwool</option>
            <option value="water">Water</option><option value="air">Air</option>
          </select></div>
          <div><label>Light Source</label><select id="gz-light">
            <option value="natural">Natural</option><option value="led">LED</option><option value="hps">HPS</option>
            <option value="fluorescent">Fluorescent</option><option value="mixed">Mixed</option>
          </select></div>
        </div>
        <label>Light Schedule (hours on/off)</label><input type="text" id="gz-schedule" placeholder="14/10" maxlength="10">
        <label>Notes</label><textarea id="gz-notes" rows="2"></textarea>
        <input type="hidden" id="gz-edit-id">
        <div class="modal-actions">
          <button onclick="gardenCloseZoneModal()" style="background:var(--bg-input);color:var(--text-muted);">Cancel</button>
          <button onclick="gardenSaveZone()" style="background:var(--accent);color:#fff;">Save</button>
        </div>
      </div>
    </div>

    <!-- Garden Add Plant Modal -->
    <div id="garden-add-plant-modal" class="catalog-modal-overlay">
      <div class="catalog-modal" style="max-width:500px;">
        <button class="modal-close" onclick="gardenCloseAddPlantModal()">‚úï</button>
        <h3 style="color:var(--text);margin:0 0 0.8rem;" id="garden-plant-modal-title2">Add Plant</h3>
        <input type="hidden" id="gp-edit-id">
        <input type="hidden" id="gp-zone-id">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
          <div><label>Species *</label><input type="text" id="gp-species" maxlength="50" placeholder="Tomato"></div>
          <div><label>Variety</label><input type="text" id="gp-variety" maxlength="50" placeholder="Roma"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
          <div><label>Stage</label><select id="gp-stage">
            <option value="seed">Seed</option><option value="germination">Germination</option><option value="seedling">Seedling</option>
            <option value="vegetative" selected>Vegetative</option><option value="flowering">Flowering</option>
            <option value="fruiting">Fruiting</option><option value="harvest">Harvest</option><option value="dormant">Dormant</option>
          </select></div>
          <div><label>Health</label><select id="gp-health">
            <option value="healthy" selected>Healthy</option><option value="stressed">Stressed</option><option value="diseased">Diseased</option>
            <option value="pest">Pest</option><option value="nutrient_deficiency">Nutrient Deficiency</option>
            <option value="overwatered">Overwatered</option><option value="underwatered">Underwatered</option>
          </select></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
          <div><label>Planted Date</label><input type="date" id="gp-planted"></div>
          <div><label>Expected Harvest</label><input type="date" id="gp-harvest"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.5rem;">
          <div><label>Row</label><input type="number" id="gp-row" min="1" placeholder="1"></div>
          <div><label>Col</label><input type="number" id="gp-col" min="1" placeholder="1"></div>
          <div><label>Slot (aero)</label><input type="number" id="gp-slot" min="1" placeholder=""></div>
        </div>
        <label>Notes</label><textarea id="gp-notes" rows="2"></textarea>
        <div class="modal-actions">
          <button onclick="gardenCloseAddPlantModal()" style="background:var(--bg-input);color:var(--text-muted);">Cancel</button>
          <button onclick="gardenSavePlant()" style="background:var(--accent);color:#fff;">Save</button>
        </div>
      </div>
    </div>

    <!-- Garden Log Reading Modal -->
    <div id="garden-reading-modal" class="catalog-modal-overlay">
      <div class="catalog-modal" style="max-width:480px;">
        <button class="modal-close" onclick="document.getElementById('garden-reading-modal').classList.remove('open')">‚úï</button>
        <h3 style="color:var(--text);margin:0 0 0.8rem;">Log Reading</h3>
        <input type="hidden" id="gr-zone-id">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
          <div><label>pH</label><input type="number" id="gr-ph" step="0.1" min="0" max="14"></div>
          <div><label>EC (mS/cm)</label><input type="number" id="gr-ec" step="0.1" min="0"></div>
          <div><label>TDS (ppm)</label><input type="number" id="gr-tds" step="1" min="0"></div>
          <div><label>Water Temp (¬∞F)</label><input type="number" id="gr-watertemp" step="0.1"></div>
          <div><label>Air Temp (¬∞F)</label><input type="number" id="gr-airtemp" step="0.1"></div>
          <div><label>Humidity (%)</label><input type="number" id="gr-humidity" step="1" min="0" max="100"></div>
          <div><label>Soil Moisture (%)</label><input type="number" id="gr-moisture" step="1" min="0" max="100"></div>
          <div><label>Light PPFD</label><input type="number" id="gr-par" step="1" min="0"></div>
          <div><label>CO2 (ppm)</label><input type="number" id="gr-co2" step="1" min="0"></div>
          <div><label>Dissolved O2 (mg/L)</label><input type="number" id="gr-do" step="0.1" min="0"></div>
          <div><label>Water Level (%)</label><input type="number" id="gr-waterlevel" step="1" min="0" max="100"></div>
          <div><label>DLI (mol/m¬≤/day)</label><input type="number" id="gr-dli" step="0.1" min="0"></div>
        </div>
        <div class="modal-actions">
          <button onclick="document.getElementById('garden-reading-modal').classList.remove('open')" style="background:var(--bg-input);color:var(--text-muted);">Cancel</button>
          <button onclick="gardenSaveReading()" style="background:var(--accent);color:#fff;">Save</button>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Reference Sources ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="reality-references">
      <h2 class="reality-card-header" onclick="toggleRealityCard('references')">üìö Reference Sources <span class="collapse-icon" id="references-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="references-body">
        <div class="ref-grid" id="ref-sources-grid"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ World Dashboard ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="reality-worlddash">
      <h2 class="reality-card-header" onclick="toggleRealityCard('worlddash')">üåç World Dashboard <span class="collapse-icon" id="worlddash-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="worlddash-body">
        <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.6rem;">Humanity's aggregate resource status ‚Äî real data from USGS 2024, World Bank, FAO.</div>
        <div id="world-dash-content" style="display:grid;grid-template-columns:1fr 1fr;gap:0.6rem;">
          <div style="background:var(--bg-input);border-radius:8px;padding:0.6rem;">
            <div style="font-weight:700;font-size:0.8rem;margin-bottom:0.3rem;">‚õèÔ∏è Mining Output</div>
            <div style="font-size:0.72rem;line-height:1.7;">
              <div>Iron Ore: <strong>2.5B tonnes/yr</strong></div>
              <div>Aluminum: <strong>69M tonnes/yr</strong></div>
              <div>Copper: <strong>22M tonnes/yr</strong></div>
              <div>Gold: <strong>3,300 tonnes/yr</strong></div>
              <div>Lithium: <strong>130,000 tonnes/yr</strong></div>
              <div>Rare Earths: <strong>350,000 tonnes/yr</strong></div>
            </div>
          </div>
          <div style="background:var(--bg-input);border-radius:8px;padding:0.6rem;">
            <div style="font-weight:700;font-size:0.8rem;margin-bottom:0.3rem;">‚ö° Energy Production</div>
            <div style="font-size:0.72rem;line-height:1.7;">
              <div>Total: <strong>29,165 TWh/yr</strong></div>
              <div>Coal: 35% ¬∑ Gas: 23% ¬∑ Oil: 3%</div>
              <div>Hydro: 15% ¬∑ Nuclear: 10%</div>
              <div>Wind: 8% ¬∑ Solar: 5% ¬∑ Other: 1%</div>
              <div style="color:#0c6;margin-top:0.2rem;">‚òÄÔ∏è Renewables now cheapest new power in 90% of world</div>
            </div>
          </div>
          <div style="background:var(--bg-input);border-radius:8px;padding:0.6rem;">
            <div style="font-weight:700;font-size:0.8rem;margin-bottom:0.3rem;">üåæ Food Production</div>
            <div style="font-size:0.72rem;line-height:1.7;">
              <div>Cereals: <strong>2.8B tonnes/yr</strong></div>
              <div>Meat: <strong>350M tonnes/yr</strong></div>
              <div>Fish: <strong>180M tonnes/yr</strong></div>
              <div>Calories produced: <strong>enough for 10B+ people</strong></div>
              <div style="color:#f90;">‚ö†Ô∏è ~30% of food is wasted globally</div>
            </div>
          </div>
          <div style="background:var(--bg-input);border-radius:8px;padding:0.6rem;">
            <div style="font-weight:700;font-size:0.8rem;margin-bottom:0.3rem;">üë• Population & Progress</div>
            <div style="font-size:0.72rem;line-height:1.7;">
              <div>Population: <strong>8.1 billion</strong> (2024)</div>
              <div>Literacy: <strong>87%</strong> and rising</div>
              <div>Extreme poverty: <strong>9%</strong> (was 36% in 1990)</div>
              <div>Life expectancy: <strong>73.4 years</strong> (global avg)</div>
              <div>Internet access: <strong>67%</strong> of world population</div>
            </div>
          </div>
        </div>
        <canvas id="world-dash-chart" width="600" height="200" style="width:100%;margin-top:0.8rem;border-radius:8px;background:var(--bg-input);"></canvas>
        <div id="world-dash-fact" style="margin-top:0.6rem;padding:0.5rem 0.7rem;border-radius:8px;background:rgba(255,136,17,0.08);font-size:0.75rem;color:var(--accent);font-style:italic;"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Element Catalog ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="reality-elements">
      <h2 class="reality-card-header" onclick="toggleRealityCard('elements')">üß™ Element Catalog <span class="collapse-icon" id="elements-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="elements-body">
        <div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;flex-wrap:wrap;align-items:center;">
          <input type="text" id="element-filter" placeholder="Filter elements‚Ä¶" oninput="renderElements()" style="flex:1;min-width:140px;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.35rem 0.6rem;border-radius:6px;font-size:0.8rem;outline:none;font-family:inherit;">
        </div>
        <div class="filter-pills" id="element-cat-pills"></div>
        <div id="element-detail-slot"></div>
        <div class="element-grid" id="element-grid"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Materials Catalog ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="reality-materials">
      <h2 class="reality-card-header" onclick="toggleRealityCard('materials')">üèóÔ∏è Materials Catalog <span class="collapse-icon" id="materials-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="materials-body">
        <div class="filter-pills" id="material-type-pills"></div>
        <div id="material-detail-slot"></div>
        <div id="materials-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:0.5rem;"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Personal Inventory ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="reality-inventory">
      <h2 class="reality-card-header" onclick="toggleRealityCard('inventory')">üì¶ Personal Inventory <span class="collapse-icon" id="inventory-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="inventory-body">
        <div class="inv-privacy-banner">üîí Private ‚Äî stored only on this device, never uploaded</div>
        <div class="inv-toolbar">
          <button onclick="openInventoryModal()" style="background:var(--accent);color:#fff;border:none;padding:0.35rem 0.8rem;border-radius:6px;font-size:0.8rem;cursor:pointer;font-weight:600;">+ Add Item</button>
          <select id="inv-category-filter" onchange="renderInventory()" style="min-width:100px;">
            <option value="">All Categories</option>
          </select>
          <input type="text" id="inv-search" placeholder="Search‚Ä¶" oninput="renderInventory()" style="flex:1;min-width:100px;">
          <button onclick="exportInventory()" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.35rem 0.6rem;border-radius:6px;font-size:0.75rem;cursor:pointer;" title="Export JSON">üì§</button>
          <button onclick="document.getElementById('inv-import-file').click()" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.35rem 0.6rem;border-radius:6px;font-size:0.75rem;cursor:pointer;" title="Import JSON">üì•</button>
          <input type="file" id="inv-import-file" accept=".json" style="display:none" onchange="importInventory(event)">
        </div>
        <div id="inventory-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:0.5rem;"></div>
      </div>
    </div>

    <!-- Inventory Modal -->
    <div class="catalog-modal-overlay" id="inv-modal">
      <div class="catalog-modal">
        <button class="modal-close" onclick="closeInventoryModal()">‚úï</button>
        <h3 style="color:var(--text);margin:0 0 0.8rem;" id="inv-modal-title">Add Item</h3>
        <input type="hidden" id="inv-edit-id">
        <label>Name *</label><input type="text" id="inv-name" maxlength="100">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
          <div><label>Category</label><select id="inv-category"></select></div>
          <div><label>Subcategory</label><input type="text" id="inv-subcategory" maxlength="50"></div>
        </div>
        <label>Description</label><textarea id="inv-description" rows="2"></textarea>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.5rem;">
          <div><label>Quantity</label><input type="number" id="inv-quantity" min="1" value="1"></div>
          <div><label>Condition</label><select id="inv-condition"><option>New</option><option selected>Good</option><option>Fair</option><option>Poor</option></select></div>
          <div><label>Acquired</label><input type="text" id="inv-acquired" placeholder="2024" maxlength="20"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
          <div><label>Location</label><input type="text" id="inv-location" maxlength="50"></div>
          <div><label>Est. Value</label><input type="text" id="inv-value" maxlength="20"></div>
        </div>
        <label>Notes</label><textarea id="inv-notes" rows="2"></textarea>
        <label>Tags (comma-separated)</label><input type="text" id="inv-tags" placeholder="daily-use, important">
        <div class="modal-actions">
          <button onclick="closeInventoryModal()" style="background:var(--bg-input);color:var(--text-muted);">Cancel</button>
          <button onclick="saveInventoryItem()" style="background:var(--accent);color:#fff;">Save</button>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Asset Library ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="reality-assets">
      <h2 class="reality-card-header" onclick="toggleRealityCard('assets')">üìÅ Asset Library <span class="collapse-icon" id="assets-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="assets-body">
        <!-- Upload area -->
        <div id="asset-dropzone" style="border:2px dashed var(--border);border-radius:10px;padding:1.5rem;text-align:center;margin-bottom:0.8rem;transition:border-color 0.2s,background 0.2s;cursor:pointer;" onclick="document.getElementById('asset-file-input').click()">
          <div style="font-size:1.5rem;margin-bottom:0.3rem;">üì§</div>
          <div style="font-size:0.85rem;color:var(--text-muted);">Drag &amp; drop files here or click to browse</div>
          <div style="font-size:0.7rem;color:var(--text-muted);margin-top:0.3rem;">Images, 3D Models, Audio, Documents</div>
          <input type="file" id="asset-file-input" multiple accept=".png,.jpg,.jpeg,.gif,.webp,.svg,.blend,.stl,.obj,.gltf,.glb,.mp3,.wav,.ogg,.pdf,.txt,.md" style="display:none" onchange="handleAssetFiles(this.files)">
        </div>
        <div id="asset-upload-progress" style="display:none;margin-bottom:0.8rem;">
          <div style="background:var(--bg-input);border-radius:6px;overflow:hidden;height:6px;">
            <div id="asset-upload-bar" style="height:100%;background:var(--accent);width:0%;transition:width 0.3s;"></div>
          </div>
          <div id="asset-upload-status" style="font-size:0.7rem;color:var(--text-muted);margin-top:0.2rem;"></div>
        </div>

        <!-- Toolbar -->
        <div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;flex-wrap:wrap;align-items:center;">
          <input type="text" id="asset-search" placeholder="üîç Search assets‚Ä¶" oninput="renderAssets()" style="flex:1;min-width:120px;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.35rem 0.6rem;border-radius:6px;font-size:0.8rem;outline:none;">
          <button onclick="toggleAssetView()" id="asset-view-toggle" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.35rem 0.6rem;border-radius:6px;font-size:0.75rem;cursor:pointer;" title="Toggle grid/list view">‚ò∞</button>
          <select id="asset-tag-filter" onchange="renderAssets()" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.35rem;border-radius:6px;font-size:0.75rem;">
            <option value="">All Tags</option>
          </select>
        </div>

        <!-- Category pills -->
        <div style="display:flex;gap:0.3rem;margin-bottom:0.8rem;flex-wrap:wrap;">
          <span class="filter-pill active" onclick="setAssetCategory('')" id="asset-cat-all" style="cursor:pointer;font-size:0.75rem;padding:0.2rem 0.6rem;">All</span>
          <span class="filter-pill" onclick="setAssetCategory('image')" id="asset-cat-image" style="cursor:pointer;font-size:0.75rem;padding:0.2rem 0.6rem;">üñºÔ∏è Images</span>
          <span class="filter-pill" onclick="setAssetCategory('3d_model')" id="asset-cat-3d_model" style="cursor:pointer;font-size:0.75rem;padding:0.2rem 0.6rem;">üßä 3D Models</span>
          <span class="filter-pill" onclick="setAssetCategory('audio')" id="asset-cat-audio" style="cursor:pointer;font-size:0.75rem;padding:0.2rem 0.6rem;">üéµ Audio</span>
          <span class="filter-pill" onclick="setAssetCategory('document')" id="asset-cat-document" style="cursor:pointer;font-size:0.75rem;padding:0.2rem 0.6rem;">üìÑ Documents</span>
        </div>

        <!-- Asset grid/list -->
        <div id="asset-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:0.6rem;"></div>
        <div id="asset-empty" style="text-align:center;color:var(--text-muted);font-style:italic;padding:2rem;font-size:0.85rem;display:none;">No assets yet. Upload some files to get started!</div>
      </div>
    </div>

    <!-- Asset Preview Modal -->
    <div id="asset-preview-modal" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.8);backdrop-filter:blur(4px);overflow-y:auto;" onclick="if(event.target===this)closeAssetPreview()">
      <div style="max-width:700px;margin:3rem auto;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
          <h3 id="asset-preview-title" style="color:var(--text);margin:0;font-size:1rem;"></h3>
          <button onclick="closeAssetPreview()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.2rem;">‚úï</button>
        </div>
        <div id="asset-preview-content" style="margin-bottom:1rem;"></div>
        <div id="asset-preview-meta" style="font-size:0.78rem;color:var(--text-muted);margin-bottom:1rem;"></div>
        <div id="asset-preview-tags" style="margin-bottom:0.8rem;"></div>
        <div style="display:flex;gap:0.4rem;flex-wrap:wrap;">
          <button onclick="editAssetTags()" class="btn" style="min-width:auto;min-height:32px;padding:0.25rem 0.7rem;font-size:0.75rem;">üè∑Ô∏è Edit Tags</button>
          <button onclick="shareAsset()" class="btn" style="min-width:auto;min-height:32px;padding:0.25rem 0.7rem;font-size:0.75rem;">üîó Share</button>
          <button onclick="listAssetOnMarket()" class="btn" style="min-width:auto;min-height:32px;padding:0.25rem 0.7rem;font-size:0.75rem;">üè™ List on Marketplace</button>
          <button onclick="deleteCurrentAsset()" class="btn" style="min-width:auto;min-height:32px;padding:0.25rem 0.7rem;font-size:0.75rem;color:var(--error);">üóëÔ∏è Delete</button>
        </div>
      </div>
    </div>

    <!-- Asset Tag Edit Modal -->
    <div id="asset-tag-modal" style="display:none;position:fixed;inset:0;z-index:1001;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);" onclick="if(event.target===this)closeAssetTagModal()">
      <div style="max-width:400px;margin:5rem auto;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;">
        <h3 style="color:var(--text);margin:0 0 0.8rem;font-size:0.95rem;">Edit Tags</h3>
        <input type="text" id="asset-tag-input" placeholder="Comma-separated tags" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;margin-bottom:0.8rem;">
        <div style="display:flex;gap:0.4rem;justify-content:flex-end;">
          <button onclick="closeAssetTagModal()" class="btn" style="min-width:60px;min-height:32px;padding:0.25rem 0.6rem;font-size:0.8rem;">Cancel</button>
          <button onclick="saveAssetTags()" class="btn btn-clickable" style="min-width:60px;min-height:32px;padding:0.25rem 0.6rem;font-size:0.8rem;">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Fantasy Tab -->
  <div id="tab-fantasy" class="tab-content">
    <div class="panel" style="border-color:rgba(120,80,200,0.3);">
      <h2 style="color:var(--fantasy-accent,#9966ff);">‚ú® Fantasy</h2>
      <p>The game side of Humanity. Your character, the world lore, and achievements ‚Äî all stored locally. The adventure begins here.</p>
    </div>
    <div class="card-grid">

      <!-- ‚îÄ‚îÄ World Map ‚îÄ‚îÄ -->
      <div class="panel reality-card" id="fantasy-worldmap" style="border-color:rgba(120,80,200,0.2);">
        <h2 class="reality-card-header" onclick="toggleFantasyCard('worldmap')" style="color:var(--fantasy-accent,#9966ff);">üó∫Ô∏è World Map <span class="collapse-icon" id="worldmap-collapse">‚ñº</span></h2>
        <div class="reality-card-body" id="worldmap-body">
          <canvas id="world-map-canvas" width="560" height="280" style="width:100%;border-radius:8px;background:#0a0a1a;cursor:crosshair;"></canvas>
          <p style="text-align:center;margin-top:0.6rem;color:var(--fantasy-accent,#9966ff);font-style:italic;font-size:0.85rem;">
            "The world is being built‚Ä¶"
          </p>
          <p style="font-size:0.8rem;color:var(--text-muted);text-align:center;line-height:1.6;">
            In the age before networks, humanity was scattered ‚Äî isolated villages of thought, unable to share their fire.<br>
            Now the map fills itself, one connection at a time.
          </p>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Character Sheet ‚îÄ‚îÄ -->
      <div class="panel reality-card" id="fantasy-character" style="border-color:rgba(120,80,200,0.2);">
        <h2 class="reality-card-header" onclick="toggleFantasyCard('character')" style="color:var(--fantasy-accent,#9966ff);">‚öîÔ∏è Character Sheet <span class="collapse-icon" id="character-collapse">‚ñº</span></h2>
        <div class="reality-card-body" id="character-body">
          <div id="char-create" style="display:none;">
            <p style="font-size:0.82rem;color:var(--text-muted);margin-bottom:0.6rem;">Create your character to begin.</p>
            <input type="text" id="char-name-input" placeholder="Character name" maxlength="24" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:0.4rem;">
            <select id="char-class-input" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;font-family:inherit;margin-bottom:0.6rem;">
              <option value="Explorer">üß≠ Explorer</option>
              <option value="Builder">üî® Builder</option>
              <option value="Scholar">üìö Scholar</option>
              <option value="Guardian">üõ°Ô∏è Guardian</option>
            </select>
            <button onclick="createCharacter()" style="background:var(--fantasy-accent,#9966ff);color:#fff;border:none;padding:0.5rem 1.2rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;width:100%;">Create Character</button>
          </div>
          <div id="char-display" style="display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
              <div>
                <span id="char-d-name" style="font-weight:700;font-size:1rem;color:var(--text);"></span>
                <span id="char-d-class" style="font-size:0.8rem;color:var(--fantasy-accent,#9966ff);margin-left:0.4rem;"></span>
              </div>
              <span id="char-d-level" style="font-size:0.75rem;color:var(--text-muted);background:var(--bg-input);padding:0.15rem 0.5rem;border-radius:10px;"></span>
            </div>
            <div id="char-stats" style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;margin-bottom:0.6rem;"></div>
            <div style="display:flex;gap:0.4rem;">
              <button onclick="rerollStats()" style="flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem;border-radius:6px;font-size:0.8rem;cursor:pointer;font-family:inherit;">üé≤ Reroll Stats</button>
              <button onclick="deleteCharacter()" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.4rem 0.8rem;border-radius:6px;font-size:0.8rem;cursor:pointer;font-family:inherit;">üóëÔ∏è</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Lore / Codex ‚îÄ‚îÄ -->
      <div class="panel reality-card" id="fantasy-lore" style="border-color:rgba(120,80,200,0.2);">
        <h2 class="reality-card-header" onclick="toggleFantasyCard('lore')" style="color:var(--fantasy-accent,#9966ff);">üìú Lore / Codex <span class="collapse-icon" id="lore-collapse">‚ñº</span></h2>
        <div class="reality-card-body" id="lore-body">
          <div id="lore-entries" style="display:flex;flex-direction:column;gap:0.4rem;"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Achievements ‚îÄ‚îÄ -->
      <div class="panel reality-card" id="fantasy-achievements" style="border-color:rgba(120,80,200,0.2);">
        <h2 class="reality-card-header" onclick="toggleFantasyCard('achievements')" style="color:var(--fantasy-accent,#9966ff);">üèÜ Achievements <span class="collapse-icon" id="achievements-collapse">‚ñº</span></h2>
        <div class="reality-card-body" id="achievements-body">
          <div id="achievement-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:0.5rem;"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Skill DNA (Fantasy) ‚îÄ‚îÄ -->
      <div class="panel reality-card" id="fantasy-skills" style="border-color:rgba(120,80,200,0.2);">
        <h2 class="reality-card-header" onclick="toggleFantasyCard('fskills')" style="color:var(--fantasy-accent,#9966ff);">üß¨ Skill DNA (Fantasy) <span class="collapse-icon" id="fskills-collapse">‚ñº</span></h2>
        <div class="reality-card-body" id="fskills-body">
          <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.6rem;font-style:italic;">üéÆ Game activities will auto-track Fantasy XP in the future. For now, log activities manually.</p>
          <div id="skill-dna-fantasy"></div>
        </div>
      </div>

    </div>

    <!-- ‚îÄ‚îÄ Celestial Map (full-width, outside card-grid) ‚îÄ‚îÄ -->
    <div class="panel reality-card" id="fantasy-celestial" style="border-color:rgba(80,120,220,0.3);">
      <h2 class="reality-card-header" onclick="toggleFantasyCard('celestial')" style="color:#6699ff;">üåå Celestial Map <span class="collapse-icon" id="celestial-collapse">‚ñº</span></h2>
      <div class="reality-card-body" id="celestial-body">
        <!-- Breadcrumb -->
        <div id="cel-breadcrumb" style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.5rem;display:flex;align-items:center;gap:0.3rem;flex-wrap:wrap;"></div>
        <!-- Canvas -->
        <div style="position:relative;">
          <canvas id="celestial-canvas" width="900" height="500" style="width:100%;border-radius:8px;background:#05050f;cursor:crosshair;display:block;"></canvas>
          <!-- Zoom controls -->
          <div style="position:absolute;top:8px;right:8px;display:flex;flex-direction:column;gap:4px;">
            <button onclick="celZoomIn()" style="width:28px;height:28px;background:rgba(20,20,40,0.8);border:1px solid rgba(100,150,255,0.3);color:#6699ff;border-radius:4px;cursor:pointer;font-size:1rem;line-height:1;">+</button>
            <button onclick="celZoomOut()" style="width:28px;height:28px;background:rgba(20,20,40,0.8);border:1px solid rgba(100,150,255,0.3);color:#6699ff;border-radius:4px;cursor:pointer;font-size:1rem;line-height:1;">‚àí</button>
          </div>
          <!-- Mode toggle -->
          <div style="position:absolute;top:8px;left:8px;display:flex;gap:4px;">
            <button id="cel-mode-reality" onclick="celSetMode('reality')" style="padding:2px 8px;font-size:0.7rem;background:rgba(20,20,40,0.8);border:1px solid rgba(100,150,255,0.3);color:#6699ff;border-radius:4px;cursor:pointer;">Reality</button>
            <button id="cel-mode-fantasy" onclick="celSetMode('fantasy')" style="padding:2px 8px;font-size:0.7rem;background:rgba(20,20,40,0.8);border:1px solid rgba(100,150,255,0.3);color:#6699ff;border-radius:4px;cursor:pointer;">Fantasy</button>
          </div>
        </div>
        <!-- Info panel -->
        <div id="cel-info" style="display:none;margin-top:0.8rem;background:rgba(10,10,30,0.6);border:1px solid rgba(100,150,255,0.2);border-radius:8px;padding:1rem;"></div>
        <!-- Nearby stars (shown in system view) -->
        <div id="cel-nearby" style="margin-top:0.5rem;font-size:0.75rem;color:var(--text-muted);"></div>
        <p style="text-align:center;margin-top:0.6rem;font-size:0.7rem;color:var(--text-muted);">Click stars/planets to inspect ¬∑ Scroll to zoom ¬∑ Drag to pan ¬∑ Double-click to enter system</p>
      </div>
    </div>

  </div>

  <!-- Streams Tab -->
  <div id="tab-streams" class="tab-content">
    <style>
      #tab-streams .stream-grid { display:grid; grid-template-columns:1fr 320px; gap:1rem; }
      @media (max-width:768px) { #tab-streams .stream-grid { grid-template-columns:1fr; } }
      #tab-streams .stream-panel { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:10px; padding:1rem; }
      #tab-streams .stream-preview { position:relative; width:100%; aspect-ratio:16/9; background:#000; border-radius:8px; overflow:hidden; }
      #tab-streams .stream-preview canvas,
      #tab-streams .stream-preview video { width:100%; height:100%; object-fit:contain; }
      #tab-streams .pip-overlay { position:absolute; border:2px solid rgba(153,102,255,0.6); border-radius:6px; cursor:move; z-index:2; overflow:hidden; }
      #tab-streams .pip-overlay video { width:100%; height:100%; object-fit:cover; }
      #tab-streams .stream-stats { display:flex; gap:1rem; flex-wrap:wrap; font-size:0.8rem; color:var(--text-muted); margin:0.6rem 0; }
      #tab-streams .stream-stats span { display:flex; align-items:center; gap:0.3rem; }
      #tab-streams .stream-setting { display:flex; align-items:center; gap:0.5rem; margin:0.4rem 0; font-size:0.82rem; }
      #tab-streams .stream-setting label { color:var(--text-muted); min-width:100px; }
      #tab-streams .stream-setting input[type="text"],
      #tab-streams .stream-setting select { background:var(--bg); border:1px solid var(--border); color:var(--text); padding:0.3rem 0.5rem; border-radius:5px; flex:1; font-size:0.8rem; }
      #tab-streams .stream-setting input[type="checkbox"] { accent-color:var(--accent); }
      #tab-streams .corner-picker { display:grid; grid-template-columns:1fr 1fr; gap:2px; width:36px; }
      #tab-streams .corner-picker span { width:16px; height:16px; border:1px solid var(--border); border-radius:3px; cursor:pointer; background:rgba(255,255,255,0.03); }
      #tab-streams .corner-picker span.active { background:var(--accent); border-color:var(--accent); }
      #tab-streams .stream-chat-panel { display:flex; flex-direction:column; height:400px; }
      #tab-streams .stream-chat-tabs { display:flex; gap:0.3rem; margin-bottom:0.5rem; flex-wrap:wrap; }
      #tab-streams .stream-chat-tabs button { font-size:0.72rem; padding:0.2rem 0.5rem; border-radius:4px; border:1px solid var(--border); background:transparent; color:var(--text-muted); cursor:pointer; }
      #tab-streams .stream-chat-tabs button.active { background:var(--accent); color:#fff; border-color:var(--accent); }
      #tab-streams .stream-chat-messages { flex:1; overflow-y:auto; font-size:0.8rem; padding:0.3rem; background:rgba(0,0,0,0.2); border-radius:6px; }
      #tab-streams .stream-chat-msg { padding:0.15rem 0; }
      #tab-streams .stream-chat-msg .src-humanity { color:#f90; }
      #tab-streams .stream-chat-msg .src-twitch { color:#9146ff; }
      #tab-streams .stream-chat-msg .src-youtube { color:#e55; }
      #tab-streams .stream-chat-msg .src-rumble { color:#6c5; }
      #tab-streams .stream-chat-input { display:flex; gap:0.3rem; margin-top:0.4rem; }
      #tab-streams .stream-chat-input input { flex:1; background:var(--bg); border:1px solid var(--border); color:var(--text); padding:0.3rem 0.5rem; border-radius:5px; font-size:0.8rem; }
      #tab-streams .stream-chat-input button { padding:0.3rem 0.7rem; }
      #tab-streams .viewer-card { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:10px; padding:0; overflow:hidden; cursor:pointer; transition:border-color 0.2s; }
      #tab-streams .viewer-card:hover { border-color:var(--accent); }
      #tab-streams .viewer-card .thumb { width:100%; aspect-ratio:16/9; background:#000; display:flex; align-items:center; justify-content:center; font-size:2.5rem; }
      #tab-streams .viewer-card .meta { padding:0.6rem; }
      #tab-streams .viewer-card .meta h3 { font-size:0.9rem; margin:0 0 0.2rem; }
      #tab-streams .viewer-card .meta .sub { font-size:0.75rem; color:var(--text-muted); }
      #tab-streams .stream-section { margin-bottom:1rem; }
      #tab-streams #stream-viewer-panel { display:none; }
      #tab-streams #stream-viewer-panel.active { display:block; }
    </style>

    <div class="card-grid">

      <!-- ‚îÄ‚îÄ Streamer Dashboard (collapsible) ‚îÄ‚îÄ -->
      <div class="panel reality-card" id="streams-dashboard">
        <h2 class="reality-card-header" onclick="toggleStreamsCard('dashboard')">üì° Stream Control <span class="collapse-icon" id="dashboard-collapse">‚ñº</span></h2>
        <div class="reality-card-body" id="dashboard-body">
          <div class="stream-grid">
            <!-- Left: Preview -->
            <div>
              <div class="stream-preview" id="stream-preview-container">
                <canvas id="stream-composite-canvas" width="1920" height="1080"></canvas>
                <div class="pip-overlay" id="pip-overlay" style="display:none;width:240px;height:180px;bottom:10px;right:10px;">
                  <video id="pip-webcam-video" autoplay muted playsinline></video>
                </div>
                <div id="stream-preview-placeholder" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;color:var(--text-muted);font-size:0.85rem;">
                  <div style="font-size:2.5rem;margin-bottom:0.5rem;">üé¨</div>
                  <div>Start screen capture to preview</div>
                </div>
              </div>
              <div class="stream-stats" id="stream-stats-bar">
                <span id="stream-stat-viewers">üëÅ 0 viewers</span>
                <span id="stream-stat-duration">‚è± --:--</span>
                <span id="stream-stat-quality">üìä --</span>
                <span id="stream-stat-bitrate">üì∂ --</span>
              </div>
              <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.5rem;">
                <button class="btn btn-clickable" id="stream-go-live-btn" onclick="streamGoLive()">üî¥ GO LIVE</button>
                <button class="btn btn-disabled" id="stream-stop-btn" onclick="streamStop()" style="display:none;">‚èπ Stop</button>
              </div>
            </div>

            <!-- Right: Settings -->
            <div>
              <div class="stream-panel" style="margin-bottom:0.8rem;">
                <div style="font-weight:600;font-size:0.9rem;margin-bottom:0.6rem;">Stream Settings</div>
                <div class="stream-setting">
                  <input type="checkbox" id="stream-screen-cb" checked onchange="streamToggleScreen()">
                  <label for="stream-screen-cb" style="min-width:auto;">Screen Capture</label>
                  <button class="btn btn-clickable" style="font-size:0.7rem;padding:0.15rem 0.4rem;margin-left:auto;" onclick="streamStartScreen()">Select</button>
                </div>
                <div class="stream-setting">
                  <input type="checkbox" id="stream-webcam-cb" onchange="streamToggleWebcam()">
                  <label for="stream-webcam-cb" style="min-width:auto;">Webcam Overlay</label>
                  <select id="stream-webcam-size" onchange="streamUpdatePipSize()" style="width:80px;flex:none;">
                    <option value="small">Small</option>
                    <option value="medium" selected>Medium</option>
                    <option value="large">Large</option>
                  </select>
                </div>
                <div class="stream-setting" style="margin-left:1.4rem;">
                  <label style="min-width:auto;font-size:0.75rem;">Position:</label>
                  <div class="corner-picker" id="pip-corner-picker">
                    <span data-corner="tl" onclick="streamSetPipCorner('tl')"></span>
                    <span data-corner="tr" onclick="streamSetPipCorner('tr')"></span>
                    <span data-corner="bl" onclick="streamSetPipCorner('bl')"></span>
                    <span data-corner="br" class="active" onclick="streamSetPipCorner('br')"></span>
                  </div>
                </div>
                <div class="stream-setting">
                  <label>Title</label>
                  <input type="text" id="stream-title" placeholder="My Stream" maxlength="100">
                </div>
                <div class="stream-setting">
                  <label>Category</label>
                  <input type="text" id="stream-category" placeholder="Just Chatting" maxlength="50">
                </div>
              </div>

              <div class="stream-panel">
                <div style="font-weight:600;font-size:0.9rem;margin-bottom:0.6rem;">Restream To</div>
                <div class="stream-setting">
                  <input type="checkbox" id="stream-relay-cb" checked>
                  <label for="stream-relay-cb" style="min-width:auto;">Relay (direct)</label>
                  <span style="font-size:0.7rem;color:var(--text-muted);margin-left:auto;">Admin only</span>
                </div>
                <div class="stream-setting">
                  <input type="checkbox" id="stream-twitch-cb">
                  <label for="stream-twitch-cb" style="min-width:auto;">Twitch</label>
                  <input type="text" id="stream-twitch-url" placeholder="twitch.tv/username" style="flex:1;">
                </div>
                <div class="stream-setting">
                  <input type="checkbox" id="stream-youtube-cb">
                  <label for="stream-youtube-cb" style="min-width:auto;">YouTube</label>
                  <input type="text" id="stream-youtube-url" placeholder="youtube.com/live/..." style="flex:1;">
                </div>
                <div class="stream-setting">
                  <input type="checkbox" id="stream-rumble-cb">
                  <label for="stream-rumble-cb" style="min-width:auto;">Rumble</label>
                  <input type="text" id="stream-rumble-url" placeholder="rumble.com/user/..." style="flex:1;">
                </div>
              </div>
            </div>
          </div>

          <!-- Stream Chat -->
          <div class="stream-panel stream-chat-panel" style="margin-top:1rem;" id="stream-chat-section">
            <div style="font-weight:600;font-size:0.9rem;margin-bottom:0.4rem;">üí¨ Stream Chat</div>
            <div class="stream-chat-tabs" id="stream-chat-tabs">
              <button class="active" onclick="streamChatFilter('all')">All</button>
              <button onclick="streamChatFilter('humanity')">Humanity</button>
              <button onclick="streamChatFilter('twitch')">Twitch</button>
              <button onclick="streamChatFilter('youtube')">YouTube</button>
              <button onclick="streamChatFilter('rumble')">Rumble</button>
            </div>
            <div class="stream-chat-messages" id="stream-chat-messages"></div>
            <div class="stream-chat-input">
              <input type="text" id="stream-chat-input" placeholder="Type a message..." onkeydown="if(event.key==='Enter')streamChatSend()">
              <button class="btn btn-clickable" onclick="streamChatSend()">Send</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Live Streams (viewer) ‚îÄ‚îÄ -->
      <div class="panel reality-card" id="streams-live">
        <h2 class="reality-card-header" onclick="toggleStreamsCard('live')">üì∫ Live Now <span class="collapse-icon" id="live-collapse">‚ñº</span></h2>
        <div class="reality-card-body" id="live-body">
          <div id="stream-live-list">
            <div id="stream-live-empty" style="text-align:center;padding:2rem 1rem;">
              <div style="font-size:2rem;margin-bottom:0.5rem;">üì∫</div>
              <div style="color:var(--text-muted);font-size:0.85rem;">No one is live right now</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Viewer Panel (shown when watching) ‚îÄ‚îÄ -->
      <div class="panel reality-card" id="stream-viewer-panel">
        <h2 class="reality-card-header">
          <span id="viewer-stream-title">üì∫ Watching Stream</span>
          <button class="btn btn-clickable" style="font-size:0.7rem;padding:0.15rem 0.5rem;margin-left:auto;" onclick="streamViewerLeave()">‚úï Close</button>
        </h2>
        <div class="reality-card-body">
          <div class="stream-preview" id="viewer-video-container">
            <video id="viewer-video" autoplay playsinline style="width:100%;height:100%;"></video>
            <div id="viewer-embed-container" style="display:none;width:100%;height:100%;"></div>
          </div>
          <div class="stream-stats" id="viewer-stats-bar">
            <span id="viewer-stat-viewers">üëÅ 0</span>
            <span id="viewer-stat-duration">‚è± --:--</span>
            <span id="viewer-stat-quality">üìä --</span>
          </div>
          <!-- Viewer chat -->
          <div class="stream-panel stream-chat-panel" style="margin-top:0.6rem;height:300px;">
            <div class="stream-chat-tabs" id="viewer-chat-tabs">
              <button class="active" onclick="streamChatFilter('all','viewer')">All</button>
              <button onclick="streamChatFilter('humanity','viewer')">Humanity</button>
              <button onclick="streamChatFilter('twitch','viewer')">Twitch</button>
              <button onclick="streamChatFilter('youtube','viewer')">YouTube</button>
              <button onclick="streamChatFilter('rumble','viewer')">Rumble</button>
            </div>
            <div class="stream-chat-messages" id="viewer-chat-messages"></div>
            <div class="stream-chat-input">
              <input type="text" id="viewer-chat-input" placeholder="Type a message..." onkeydown="if(event.key==='Enter')streamChatSend('viewer')">
              <button class="btn btn-clickable" onclick="streamChatSend('viewer')">Send</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Server List ‚îÄ‚îÄ -->
      <div class="panel reality-card" id="streams-servers">
        <h2 class="reality-card-header" onclick="toggleStreamsCard('servers')">üñ•Ô∏è Servers <span class="collapse-icon" id="servers-collapse">‚ñº</span></h2>
        <div class="reality-card-body" id="servers-body">
          <div id="stream-servers-list">
            <div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem;background:rgba(255,255,255,0.02);border-radius:6px;margin-bottom:0.4rem;">
              <span style="font-size:1.1rem;" id="server-status-dot">üü¢</span>
              <div>
                <div style="font-weight:600;font-size:0.85rem;">Humanity HQ</div>
                <div style="font-size:0.7rem;color:var(--text-muted);">united-humanity.us ¬∑ Verified + Accord</div>
              </div>
              <span style="margin-left:auto;font-size:0.75rem;color:var(--text-muted);" id="server-live-count">0 live</span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Info Tab -->
  <!-- NOTE: Add /info to the nginx hub route regex, e.g. location ~ ^/(board|reality|fantasy|streams|info|debug) -->
  <div id="tab-info" class="tab-content" style="padding:1.5rem;">
    <style>
      #tab-info .info-section { margin-bottom:1.5rem; }
      #tab-info .info-section h2 { font-size:1.1rem; color:var(--accent); margin-bottom:0.8rem; border-bottom:1px solid var(--border); padding-bottom:0.4rem; cursor:pointer; user-select:none; }
      #tab-info .info-section h2::after { content:' ‚ñæ'; font-size:0.7rem; opacity:0.5; }
      #tab-info .info-section.collapsed h2::after { content:' ‚ñ∏'; }
      #tab-info .info-section.collapsed .info-body { display:none; }
      #tab-info .role-card { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:10px; padding:1rem; margin-bottom:0.75rem; }
      #tab-info .role-card h3 { margin:0 0 0.4rem; font-size:0.95rem; }
      #tab-info .role-card .perms { font-size:0.8rem; color:var(--text-muted); line-height:1.6; }
      #tab-info .role-card .perms .yes { color:#4a8; }
      #tab-info .role-card .perms .no { color:#e55; }
      #tab-info .cmd-group { margin-bottom:1rem; }
      #tab-info .cmd-group h4 { font-size:0.85rem; color:var(--text); margin:0.6rem 0 0.3rem; }
      #tab-info .cmd-row { font-size:0.8rem; color:var(--text-muted); padding:0.15rem 0; }
      #tab-info .cmd-row code { background:rgba(255,255,255,0.06); padding:0.1rem 0.4rem; border-radius:3px; color:var(--accent); font-size:0.78rem; }
      #tab-info .stat-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:0.8rem; }
      #tab-info .stat-card { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:8px; padding:0.8rem; text-align:center; }
      #tab-info .stat-card .stat-val { font-size:1.4rem; font-weight:700; color:var(--accent); }
      #tab-info .stat-card .stat-label { font-size:0.7rem; color:var(--text-muted); margin-top:0.2rem; }
    </style>

    <!-- Server Info -->
    <div class="info-section" id="info-server">
      <h2>üñ•Ô∏è Server Info</h2>
      <div class="info-body">
        <div class="stat-grid" id="info-stats">
          <div class="stat-card"><div class="stat-val" id="info-online">‚Äî</div><div class="stat-label">Online</div></div>
          <div class="stat-card"><div class="stat-val" id="info-registered">‚Äî</div><div class="stat-label">Registered</div></div>
          <div class="stat-card"><div class="stat-val" id="info-uptime">‚Äî</div><div class="stat-label">Uptime</div></div>
          <div class="stat-card"><div class="stat-val" id="info-version">‚Äî</div><div class="stat-label">Version</div></div>
        </div>
      </div>
    </div>

    <!-- Roles & Permissions -->
    <div class="info-section">
      <h2>üõ°Ô∏è Roles & Permissions</h2>
      <div class="info-body">
        <div class="role-card">
          <h3>üë§ Unverified</h3>
          <div class="perms">
            <span class="yes">‚úì</span> Chat (rate limited) ¬∑ Voice ¬∑ View channels<br>
            <span class="no">‚úó</span> Upload files ¬∑ DM ¬∑ Create channels ¬∑ Follow/unfollow
          </div>
        </div>
        <div class="role-card">
          <h3>‚ú¶ Verified</h3>
          <div class="perms">
            <span class="yes">‚úì</span> All above + Upload files ¬∑ DM friends ¬∑ Follow/unfollow
          </div>
        </div>
        <div class="role-card">
          <h3>üíé Donor</h3>
          <div class="perms">
            <span class="yes">‚úì</span> Same as Verified + üíé badge ¬∑ Priority support
          </div>
        </div>
        <div class="role-card">
          <h3>üõ°Ô∏è Moderator</h3>
          <div class="perms">
            <span class="yes">‚úì</span> All above + DM anyone ¬∑ Kick/mute/ban ¬∑ Create/edit channels ¬∑ Manage reports
          </div>
        </div>
        <div class="role-card">
          <h3>üëë Admin</h3>
          <div class="perms">
            <span class="yes">‚úì</span> All above + Verify/unverify ¬∑ Promote/demote ¬∑ Lockdown ¬∑ Wipe ¬∑ Server config
          </div>
        </div>
      </div>
    </div>

    <!-- Social System -->
    <div class="info-section">
      <h2>ü§ù Social System</h2>
      <div class="info-body">
        <div class="role-card">
          <h3>üëÅÔ∏è Follow</h3>
          <div class="perms">One-way ‚Äî shows you care. Use <code>/follow &lt;name&gt;</code>. Right-click a user for quick follow.</div>
        </div>
        <div class="role-card">
          <h3>ü§ù Friends (Mutual Follow)</h3>
          <div class="perms">When both users follow each other, they become friends. This unlocks DMs and shows the ü§ù badge.</div>
        </div>
        <div class="role-card">
          <h3>üö´ Block</h3>
          <div class="perms">Client-side ‚Äî hides their messages from your view. Use <code>/block &lt;name&gt;</code>.</div>
        </div>
      </div>
    </div>

    <!-- Rate Limits -->
    <div class="info-section">
      <h2>‚è±Ô∏è Rate Limits</h2>
      <div class="info-body">
        <div class="role-card">
          <div class="perms">
            <strong>Messages:</strong> Fibonacci rate limiting (1,1,2,3,5,8‚Ä¶ second delays on rapid posting)<br>
            <strong>New accounts:</strong> 5s minimum delay for first 10 minutes<br>
            <strong>Uploads:</strong> 2/minute, 4 image max per user (FIFO ‚Äî oldest replaced)<br>
            <strong>API:</strong> 10 req/s general, 5 req/s for read endpoints
          </div>
        </div>
      </div>
    </div>

    <!-- Commands Reference -->
    <div class="info-section">
      <h2>üìú Commands Reference</h2>
      <div class="info-body">
        <div class="cmd-group">
          <h4>üë• Social</h4>
          <div class="cmd-row"><code>/follow &lt;name&gt;</code> ‚Äî Follow a user</div>
          <div class="cmd-row"><code>/unfollow &lt;name&gt;</code> ‚Äî Unfollow a user</div>
          <div class="cmd-row"><code>/block &lt;name&gt;</code> ‚Äî Block a user</div>
          <div class="cmd-row"><code>/unblock &lt;name&gt;</code> ‚Äî Unblock a user</div>
          <div class="cmd-row"><code>/blocklist</code> ‚Äî Show blocked users</div>
        </div>
        <div class="cmd-group">
          <h4>üí¨ DMs & Groups</h4>
          <div class="cmd-row"><code>/dm &lt;name&gt; &lt;msg&gt;</code> ‚Äî Send a direct message</div>
          <div class="cmd-row"><code>/dms</code> ‚Äî List DM conversations</div>
          <div class="cmd-row"><code>/group-create &lt;name&gt;</code> ‚Äî Create a group chat</div>
          <div class="cmd-row"><code>/group-join &lt;code&gt;</code> ‚Äî Join group by invite code</div>
          <div class="cmd-row"><code>/group-invite</code> ‚Äî Copy current group's invite code</div>
          <div class="cmd-row"><code>/group-leave</code> ‚Äî Leave current group</div>
        </div>
        <div class="cmd-group">
          <h4>‚úèÔ∏è Profile</h4>
          <div class="cmd-row"><code>/bio &lt;text&gt;</code> ‚Äî Set your bio</div>
          <div class="cmd-row"><code>/social &lt;platform&gt; &lt;handle&gt;</code> ‚Äî Set social link</div>
          <div class="cmd-row"><code>/profile</code> ‚Äî Edit profile</div>
          <div class="cmd-row"><code>/name &lt;name&gt;</code> ‚Äî Change display name</div>
        </div>
        <div class="cmd-group">
          <h4>üìå Pins</h4>
          <div class="cmd-row"><code>/pin</code> ‚Äî Pin the last message (mod/admin)</div>
          <div class="cmd-row"><code>/unpin &lt;N&gt;</code> ‚Äî Unpin by index (mod/admin)</div>
          <div class="cmd-row"><code>/mypin</code> ‚Äî Pin your last message (for yourself)</div>
          <div class="cmd-row"><code>/unmypin &lt;N&gt;</code> ‚Äî Unpin your pin by index</div>
          <div class="cmd-row"><code>/pins</code> ‚Äî View pins</div>
        </div>
        <div class="cmd-group">
          <h4>üìû Voice</h4>
          <div class="cmd-row"><code>/call</code> ‚Äî Start a voice call (or use üìû button)</div>
        </div>
        <div class="cmd-group">
          <h4>üõ°Ô∏è Moderation</h4>
          <div class="cmd-row"><code>/kick &lt;name&gt;</code> ‚Äî Disconnect a user</div>
          <div class="cmd-row"><code>/mute &lt;name&gt;</code> ‚Äî Mute a user</div>
          <div class="cmd-row"><code>/ban &lt;name&gt;</code> ‚Äî Ban a user</div>
          <div class="cmd-row"><code>/report &lt;name&gt; [reason]</code> ‚Äî Report a user</div>
        </div>
        <div class="cmd-group">
          <h4>üëë Admin</h4>
          <div class="cmd-row"><code>/verify &lt;name&gt;</code> ‚Äî Verify a user</div>
          <div class="cmd-row"><code>/unverify &lt;name&gt;</code> ‚Äî Remove verified</div>
          <div class="cmd-row"><code>/mod &lt;name&gt;</code> ‚Äî Promote to moderator</div>
          <div class="cmd-row"><code>/unmod &lt;name&gt;</code> ‚Äî Remove moderator</div>
          <div class="cmd-row"><code>/donor &lt;name&gt;</code> ‚Äî Set donor role</div>
          <div class="cmd-row"><code>/lockdown</code> ‚Äî Toggle registration lock</div>
          <div class="cmd-row"><code>/channel-create &lt;name&gt; [desc]</code> ‚Äî Create channel</div>
          <div class="cmd-row"><code>/channel-delete &lt;name&gt;</code> ‚Äî Delete channel</div>
          <div class="cmd-row"><code>/wipe</code> ‚Äî Delete all chat history</div>
        </div>
        <div class="cmd-group">
          <h4>üîß Utility</h4>
          <div class="cmd-row"><code>/help</code> ‚Äî Show help</div>
          <div class="cmd-row"><code>/export</code> ‚Äî Download identity backup</div>
          <div class="cmd-row"><code>/link</code> ‚Äî Link another device</div>
          <div class="cmd-row"><code>/revoke &lt;key&gt;</code> ‚Äî Remove a device</div>
          <div class="cmd-row"><code>/users</code> ‚Äî List all users</div>
        </div>
      </div>
    </div>

    <script>
    // Collapsible sections
    document.querySelectorAll('#tab-info .info-section h2').forEach(h2 => {
      h2.addEventListener('click', () => {
        h2.parentElement.classList.toggle('collapsed');
      });
    });
    // Fetch server stats
    (async function loadInfoStats() {
      try {
        const [statsRes, infoRes] = await Promise.all([
          fetch('/api/stats').then(r => r.ok ? r.json() : null).catch(() => null),
          fetch('/api/server-info').then(r => r.ok ? r.json() : null).catch(() => null)
        ]);
        if (statsRes) {
          if (statsRes.online !== undefined) document.getElementById('info-online').textContent = statsRes.online;
          if (statsRes.registered !== undefined) document.getElementById('info-registered').textContent = statsRes.registered;
          if (statsRes.uptime) {
            const s = statsRes.uptime;
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            document.getElementById('info-uptime').textContent = h + 'h ' + m + 'm';
          }
        }
        if (infoRes) {
          if (infoRes.version) document.getElementById('info-version').textContent = infoRes.version;
          else if (infoRes.name) document.getElementById('info-version').textContent = infoRes.name;
        }
      } catch(e) { console.warn('Info stats fetch failed:', e); }
    })();
    </script>
  </div>

  <!-- Source Tab ‚Äî NOTE: add /source to nginx hub regex for routing -->
  <div id="tab-source" class="tab-content" style="padding:1.5rem;">
    <style>
      #tab-source .info-section { margin-bottom:1.5rem; }
      #tab-source .info-section h2 { font-size:1.1rem; color:var(--accent); margin-bottom:0.8rem; border-bottom:1px solid var(--border); padding-bottom:0.4rem; cursor:pointer; user-select:none; }
      #tab-source .info-section h2::after { content:' ‚ñæ'; font-size:0.7rem; opacity:0.5; }
      #tab-source .info-section.collapsed h2::after { content:' ‚ñ∏'; }
      #tab-source .info-section.collapsed .info-body { display:none; }
      #tab-source .src-card { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:10px; padding:1.2rem; margin-bottom:0.75rem; }
      #tab-source .src-card p { font-size:0.85rem; color:var(--text-muted); line-height:1.6; margin:0.4rem 0; }
      #tab-source .src-card ul { list-style:none; padding:0; margin:0.5rem 0; }
      #tab-source .src-card li { font-size:0.85rem; color:var(--text-muted); padding:0.25rem 0; line-height:1.5; }
      #tab-source .src-card li::before { margin-right:0.4rem; }
      #tab-source .big-statement { font-size:1.2rem; color:var(--text); font-weight:700; text-align:center; margin:1rem 0; }
      #tab-source .sub-statement { font-size:0.9rem; color:var(--text-muted); text-align:center; margin-bottom:1rem; line-height:1.6; }
      #tab-source .btn-row { display:flex; gap:0.8rem; flex-wrap:wrap; justify-content:center; margin:1rem 0; }
      #tab-source .src-btn { display:inline-flex; align-items:center; gap:0.5rem; padding:0.7rem 1.4rem; border-radius:8px; font-size:0.9rem; font-weight:600; text-decoration:none; color:#fff; transition:opacity 0.15s; }
      #tab-source .src-btn:hover { opacity:0.85; }
      #tab-source .src-btn.gh { background:#333; }
      #tab-source .src-btn.donate { background:var(--accent,#e07020); }
      #tab-source .arch-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:0.8rem; margin:0.8rem 0; }
      #tab-source .arch-box { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:8px; padding:0.8rem; }
      #tab-source .arch-box h4 { font-size:0.85rem; color:var(--accent); margin:0 0 0.3rem; }
      #tab-source .arch-box p { font-size:0.78rem; margin:0; }
      #tab-source .tech-tags { display:flex; flex-wrap:wrap; gap:0.4rem; margin:0.6rem 0; }
      #tab-source .tech-tag { background:rgba(255,255,255,0.06); border:1px solid var(--border); border-radius:4px; padding:0.2rem 0.6rem; font-size:0.75rem; color:var(--text-muted); }
      #tab-source .stat-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:0.8rem; margin:0.8rem 0; }
      #tab-source .stat-card { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:8px; padding:0.8rem; text-align:center; }
      #tab-source .stat-card .stat-val { font-size:1.4rem; font-weight:700; color:var(--accent); }
      #tab-source .stat-card .stat-label { font-size:0.7rem; color:var(--text-muted); margin-top:0.2rem; }
    </style>

    <!-- Open Source -->
    <div class="info-section">
      <h2>üîì Open Source</h2>
      <div class="info-body">
        <div class="src-card">
          <div class="big-statement">Humanity is 100% open source and public domain (CC0-1.0)</div>
          <div class="sub-statement">Anyone can use, modify, and distribute this code for any purpose.<br>No permission needed. No strings attached.</div>
          <div class="btn-row">
            <a href="https://github.com/Shaostoul/Humanity" target="_blank" class="src-btn gh">‚≠ê GitHub ‚Äî Shaostoul/Humanity</a>
            <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank" class="src-btn" style="background:#555;">üìÑ CC0 1.0 License</a>
          </div>
        </div>
      </div>
    </div>

    <!-- The Accord -->
    <div class="info-section">
      <h2>üìú The Accord</h2>
      <div class="info-body">
        <div class="src-card">
          <div class="big-statement" style="font-size:1rem;">Wholesomely aiding humanity's betterment</div>
          <ul>
            <li>üîí <strong>Privacy first</strong> ‚Äî No tracking, no accounts. Your identity is your keys.</li>
            <li>üó£Ô∏è <strong>Free speech</strong> ‚Äî No censorship. Line drawn at genuine threats and predatory harassment.</li>
            <li>üîû <strong>18+ community</strong> ‚Äî Mature, responsible communication.</li>
            <li>üíõ <strong>Unconditional love</strong> ‚Äî For all life.</li>
            <li>‚ú® <strong>The 7 heavenly virtues</strong> ‚Äî Chastity, temperance, charity, diligence, patience, kindness, humility.</li>
          </ul>
          <div class="btn-row">
            <a href="https://shaostoul.github.io/Humanity" target="_blank" class="src-btn" style="background:#555;">üìñ Read the Full Accord</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Architecture -->
    <div class="info-section">
      <h2>üèóÔ∏è Architecture</h2>
      <div class="info-body">
        <div class="src-card">
          <div class="arch-grid">
            <div class="arch-box"><h4>üîë Identity</h4><p>Ed25519 key pairs stored in your browser ‚Äî no accounts, no passwords</p></div>
            <div class="arch-box"><h4>üîè Encryption</h4><p>Messages signed cryptographically ‚Äî tamper-proof</p></div>
            <div class="arch-box"><h4>üì° Communication</h4><p>WebSocket relay for group chat, WebRTC P2P for voice/video</p></div>
            <div class="arch-box"><h4>üíæ Storage</h4><p>SQLite on server, localStorage + IndexedDB on client</p></div>
            <div class="arch-box"><h4>üåê Federation</h4><p>Servers can link together ‚Äî your identity works everywhere</p></div>
          </div>
          <p style="font-size:0.85rem;color:var(--text-muted);margin-top:0.8rem;"><strong>Tech stack:</strong></p>
          <div class="tech-tags">
            <span class="tech-tag">Rust</span><span class="tech-tag">Axum</span><span class="tech-tag">Tokio</span>
            <span class="tech-tag">SQLite</span><span class="tech-tag">Ed25519</span><span class="tech-tag">BLAKE3</span>
            <span class="tech-tag">WebRTC</span><span class="tech-tag">Vanilla JS</span>
          </div>
          <p style="font-size:0.82rem;color:var(--text-muted);margin-top:0.6rem;"><strong>Future:</strong> CBOR signed objects, P2P direct messaging, peer-assisted streaming</p>
        </div>
      </div>
    </div>

    <!-- Contributing -->
    <div class="info-section">
      <h2>ü§ù Contributing</h2>
      <div class="info-body">
        <div class="src-card">
          <p style="font-size:0.95rem;color:var(--text);font-weight:600;">Everyone can help, not just programmers</p>
          <ul>
            <li>üêõ <strong>Report bugs</strong> ‚Äî Use <code style="background:rgba(255,255,255,0.06);padding:0.1rem 0.4rem;border-radius:3px;color:var(--accent);">/report</code> in chat or <a href="https://github.com/Shaostoul/Humanity/issues" target="_blank" style="color:var(--accent);">GitHub Issues</a></li>
            <li>üí° <strong>Suggest features</strong> ‚Äî Chat in #dev or <a href="https://github.com/Shaostoul/Humanity/discussions" target="_blank" style="color:var(--accent);">GitHub Discussions</a></li>
            <li>üîß <strong>Write code</strong> ‚Äî Fork, hack, PR ‚Äî it's CC0, go wild</li>
            <li>üìñ <strong>Improve docs</strong> ‚Äî Website at <a href="https://shaostoul.github.io/Humanity" target="_blank" style="color:var(--accent);">shaostoul.github.io/Humanity</a></li>
            <li>üß™ <strong>Test features</strong> ‚Äî Just use the app and tell us what breaks</li>
            <li>üí∞ <strong>Donate</strong> ‚Äî Support development directly</li>
          </ul>
          <div class="btn-row">
            <a href="https://github.com/sponsors/Shaostoul" target="_blank" class="src-btn donate">‚ù§Ô∏è GitHub Sponsors</a>
            <a href="https://ko-fi.com/shaostoul" target="_blank" class="src-btn donate">‚òï Ko-fi</a>
          </div>
          <p style="font-size:0.82rem;color:var(--text-muted);margin-top:0.8rem;"><strong>Self-hosting:</strong> <code style="background:rgba(255,255,255,0.06);padding:0.1rem 0.4rem;border-radius:3px;font-size:0.78rem;color:var(--text-muted);">git clone ‚Üí install Rust ‚Üí cargo build --release ‚Üí ./target/release/humanity-relay</code></p>
          <p style="font-size:0.78rem;"><a href="https://github.com/Shaostoul/Humanity#readme" target="_blank" style="color:var(--accent);">Full build instructions on GitHub README ‚Üí</a></p>
        </div>
      </div>
    </div>

    <!-- Project Stats -->
    <div class="info-section" id="source-stats-section">
      <h2>üìä Project Stats</h2>
      <div class="info-body">
        <div class="stat-grid">
          <div class="stat-card"><div class="stat-val" id="src-online">‚Äî</div><div class="stat-label">Online Now</div></div>
          <div class="stat-card"><div class="stat-val" id="src-registered">‚Äî</div><div class="stat-label">Registered</div></div>
          <div class="stat-card"><div class="stat-val" id="src-version">‚Äî</div><div class="stat-label">Version</div></div>
          <div class="stat-card"><div class="stat-val" id="src-uptime">‚Äî</div><div class="stat-label">Uptime</div></div>
          <div class="stat-card"><div class="stat-val">Rust</div><div class="stat-label">Language</div></div>
          <div class="stat-card"><div class="stat-val">CC0-1.0</div><div class="stat-label">License</div></div>
          <div class="stat-card"><div class="stat-val">Jan 2019</div><div class="stat-label">Started</div></div>
        </div>
        <div class="btn-row" style="margin-top:1rem;">
          <a href="https://github.com/Shaostoul/Humanity/commits" target="_blank" class="src-btn gh">üìà Commit History on GitHub</a>
        </div>
      </div>
    </div>

    <script>
    // Collapsible sections
    document.querySelectorAll('#tab-source .info-section h2').forEach(h2 => {
      h2.addEventListener('click', () => h2.parentElement.classList.toggle('collapsed'));
    });
    // Fetch stats
    (async function loadSourceStats() {
      try {
        const [statsRes, infoRes] = await Promise.all([
          fetch('/api/stats').then(r => r.ok ? r.json() : null).catch(() => null),
          fetch('/api/server-info').then(r => r.ok ? r.json() : null).catch(() => null)
        ]);
        if (statsRes) {
          if (statsRes.online !== undefined) document.getElementById('src-online').textContent = statsRes.online;
          if (statsRes.registered !== undefined) document.getElementById('src-registered').textContent = statsRes.registered;
          if (statsRes.uptime) {
            const s = statsRes.uptime;
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            document.getElementById('src-uptime').textContent = h + 'h ' + m + 'm';
          }
        }
        if (infoRes && infoRes.version) document.getElementById('src-version').textContent = infoRes.version;
      } catch(e) { console.warn('Source stats fetch failed:', e); }
    })();
    </script>
  </div>

  <!-- Debug Tab -->
  <div id="tab-debug" class="tab-content">
    <div class="panel">
      <h2>üîß System Information</h2>
      <p>Version, connection status, and system diagnostics.</p>
      <dl class="debug-info">
        <dt>Client Version</dt>
        <dd id="debug-version">‚Äî</dd>
        <dt>Server</dt>
        <dd id="debug-server">‚Äî</dd>
        <dt>Connection</dt>
        <dd id="debug-connection">Checking‚Ä¶</dd>
        <dt>User Agent</dt>
        <dd id="debug-ua">‚Äî</dd>
        <dt>Screen</dt>
        <dd id="debug-screen">‚Äî</dd>
        <dt>Page Loaded</dt>
        <dd id="debug-loaded">‚Äî</dd>
      </dl>
    </div>

    <div class="panel">
      <h2>üé® Button Design System</h2>
      <p>Interactive preview of all button states. These are the standard interaction patterns for the entire game UI.</p>

      <h3>All States (static preview)</h3>
      <div class="btn-grid">
        <div class="btn-demo">
          <button class="btn btn-clickable">Clickable</button>
          <span class="btn-label">Default ¬∑ 1px green</span>
        </div>
        <div class="btn-demo">
          <button class="btn btn-channeling">Channeling</button>
          <span class="btn-label">Active/looping ¬∑ 1px rainbow</span>
        </div>
        <div class="btn-demo">
          <button class="btn btn-activated">Activated</button>
          <span class="btn-label">Pressed ¬∑ 5px red</span>
        </div>
        <div class="btn-demo">
          <button class="btn btn-disabled">Disabled</button>
          <span class="btn-label">Unclickable ¬∑ 2px black</span>
        </div>
        <div class="btn-demo">
          <button class="btn btn-cooldown">
            Cooldown
            <span class="btn-cooldown-timer top">3.2s</span>
            <span class="btn-cooldown-timer bottom">3.2s</span>
          </button>
          <span class="btn-label">Waiting ¬∑ 7px purple + timer</span>
        </div>
      </div>

      <h3>Interactive Test ‚Äî Hover &amp; Click</h3>
      <p>Hover to see the blue border. Click and hold to see the red activated state.</p>
      <div class="btn-grid">
        <button class="btn" onclick="testBtnClick(this)">Hover / Click Me</button>
        <button class="btn" onclick="testBtnClick(this)">Another Button</button>
        <button class="btn" onclick="testBtnClick(this)">And Another</button>
      </div>

      <h3>Toggle Test ‚Äî Click to Cycle States</h3>
      <p>Click to cycle: clickable ‚Üí channeling ‚Üí activated ‚Üí cooldown ‚Üí clickable</p>
      <div class="btn-grid">
        <button class="btn btn-clickable" onclick="cycleState(this)">Cycle Me</button>
        <button class="btn btn-clickable" onclick="cycleState(this)">Cycle Me Too</button>
        <button class="btn btn-clickable" onclick="cycleState(this)">And Me</button>
      </div>

      <h3>Cooldown Test ‚Äî Click to Start Cooldown</h3>
      <div class="btn-grid">
        <button class="btn btn-clickable" onclick="startCooldown(this, 5)">5s Cooldown</button>
        <button class="btn btn-clickable" onclick="startCooldown(this, 10)">10s Cooldown</button>
        <button class="btn btn-clickable" onclick="startCooldown(this, 3)">3s Cooldown</button>
      </div>

      <h3>Channeling Test ‚Äî Click to Start/Stop</h3>
      <div class="btn-grid">
        <button class="btn btn-clickable" onclick="toggleChannel(this)">Channel Me</button>
        <button class="btn btn-clickable" onclick="toggleChannel(this)">Channel This</button>
      </div>
    </div>

    <div class="panel">
      <h2>üé® Color Reference</h2>
      <p>The visual language for button borders:</p>
      <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.8rem; margin-top: 0.5rem;">
        <div style="padding:0.5rem;border-left:3px solid #44cc66;background:rgba(68,204,102,0.05);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#44cc66;">Green 1px</strong> ‚Äî Clickable / ready
        </div>
        <div style="padding:0.5rem;border-left:3px solid #4488ff;background:rgba(68,136,255,0.05);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#4488ff;">Blue 3px</strong> ‚Äî Hovered / focused
        </div>
        <div style="padding:0.5rem;border-left:3px solid #ee3333;background:rgba(238,51,51,0.05);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#ee3333;">Red 5px</strong> ‚Äî Activated / pressed
        </div>
        <div style="padding:0.5rem;border-left:3px solid #222;background:rgba(0,0,0,0.1);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#666;">Black 2px</strong> ‚Äî Disabled / locked
        </div>
        <div style="padding:0.5rem;border-left:3px solid #8844cc;background:rgba(136,68,204,0.05);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#8844cc;">Purple 7px</strong> ‚Äî Cooldown + timer
        </div>
        <div style="padding:0.5rem;border-left:3px solid;border-image:linear-gradient(90deg,#f00,#ff0,#0f0,#0ff,#00f,#f0f,#f00) 1;background:rgba(255,255,255,0.03);border-radius:0 4px 4px 0;font-size:0.8rem;">
          <strong style="background:linear-gradient(90deg,#f00,#ff0,#0f0,#0ff,#00f,#f0f);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Rainbow 1px</strong> ‚Äî Channeling / active
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- Market Tab -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="tab-market" class="tab-content" style="padding:1rem;overflow-y:auto;">
    <!-- Sub-navigation -->
    <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap;align-items:center;">
      <button class="btn btn-clickable" onclick="showMarketSection('marketplace')" id="market-nav-marketplace" style="min-width:auto;min-height:32px;padding:0.25rem 0.7rem;font-size:0.8rem;">üè™ Marketplace</button>
      <button class="btn" onclick="showMarketSection('stores')" id="market-nav-stores" style="min-width:auto;min-height:32px;padding:0.25rem 0.7rem;font-size:0.8rem;">üè¨ Stores</button>
      <button class="btn" onclick="showMarketSection('mylistings')" id="market-nav-mylistings" style="min-width:auto;min-height:32px;padding:0.25rem 0.7rem;font-size:0.8rem;">üìã My Listings</button>
      <span style="flex:1;"></span>
      <button class="btn btn-clickable" onclick="openListingModal()" id="market-create-btn" style="min-width:auto;min-height:32px;padding:0.25rem 0.7rem;font-size:0.8rem;display:none;">+ Create Listing</button>
    </div>

    <!-- Marketplace Section -->
    <div id="market-section-marketplace">
      <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1rem;align-items:center;position:sticky;top:0;z-index:10;background:var(--bg);padding:0.5rem 0;">
        <input type="text" id="market-search" placeholder="üîç Search listings‚Ä¶" oninput="renderMarketListings()" style="flex:1;min-width:150px;padding:0.4rem 0.6rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.8rem;">
        <select id="market-category-filter" onchange="renderMarketListings()" style="padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.8rem;">
          <option value="">All Categories</option>
          <option>Electronics</option><option>Vehicles</option><option>Clothing</option><option>Tools</option>
          <option>Furniture</option><option>Home</option><option>Books/Media</option><option>Gaming</option>
          <option>Sports</option><option>Crafts</option><option>Food/Garden</option><option>Services</option><option>3D Models</option><option>Other</option>
        </select>
        <select id="market-condition-filter" onchange="renderMarketListings()" style="padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.8rem;">
          <option value="">Any Condition</option>
          <option>New</option><option>Like New</option><option>Good</option><option>Fair</option><option>Poor</option><option>N/A</option>
        </select>
        <select id="market-sort" onchange="renderMarketListings()" style="padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.8rem;">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
          <option value="alpha">A-Z</option>
        </select>
      </div>
      <div id="market-listings-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;"></div>
      <div id="market-listings-empty" style="text-align:center;color:var(--text-muted);font-style:italic;padding:3rem 1rem;display:none;">No listings yet. Be the first to list something!</div>
    </div>

    <!-- Store Directory Section -->
    <div id="market-section-stores" style="display:none;">
      <div style="margin-bottom:1rem;">
        <select id="store-category-filter" onchange="renderStoreDirectory()" style="padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.8rem;">
          <option value="">All Categories</option>
        </select>
      </div>
      <div id="store-directory-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem;"></div>
    </div>

    <!-- My Listings Section -->
    <div id="market-section-mylistings" style="display:none;">
      <div id="my-listings-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;"></div>
      <div id="my-listings-empty" style="text-align:center;color:var(--text-muted);font-style:italic;padding:3rem 1rem;display:none;">You haven't listed anything yet.</div>
    </div>

    <!-- Listing Detail Modal -->
    <div id="listing-detail-modal" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);overflow-y:auto;" onclick="if(event.target===this)closeListingDetail()">
      <div style="max-width:600px;margin:3rem auto;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;">
        <div id="listing-detail-content"></div>
      </div>
    </div>

    <!-- Create/Edit Listing Modal -->
    <div id="listing-modal" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);overflow-y:auto;" onclick="if(event.target===this)closeListingModal()">
      <div style="max-width:500px;margin:3rem auto;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;">
        <h2 style="color:var(--accent);margin-bottom:1rem;font-size:1rem;" id="listing-modal-title">Create Listing</h2>
        <input type="hidden" id="listing-edit-id" value="">
        <div style="display:flex;flex-direction:column;gap:0.6rem;">
          <div>
            <label style="font-size:0.75rem;color:var(--text-muted);">Title *</label>
            <input type="text" id="listing-title" maxlength="100" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
          </div>
          <div>
            <label style="font-size:0.75rem;color:var(--text-muted);">Description</label>
            <textarea id="listing-description" rows="3" maxlength="2000" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;resize:vertical;"></textarea>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
            <div>
              <label style="font-size:0.75rem;color:var(--text-muted);">Category *</label>
              <select id="listing-category" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
                <option>Electronics</option><option>Vehicles</option><option>Clothing</option><option>Tools</option>
                <option>Furniture</option><option>Home</option><option>Books/Media</option><option>Gaming</option>
                <option>Sports</option><option>Crafts</option><option>Food/Garden</option><option>Services</option><option>3D Models</option><option>Other</option>
              </select>
            </div>
            <div>
              <label style="font-size:0.75rem;color:var(--text-muted);">Condition</label>
              <select id="listing-condition" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
                <option>New</option><option>Like New</option><option>Good</option><option>Fair</option><option>Poor</option><option>N/A</option>
              </select>
            </div>
          </div>
          <div id="listing-3d-subcategory-wrap" style="display:none;">
            <label style="font-size:0.75rem;color:var(--text-muted);">Model Subcategory</label>
            <select id="listing-3d-subcategory" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
              <option value="">None</option>
              <option>Vehicles</option><option>Architecture</option><option>Characters</option><option>Props</option>
              <option>Weapons</option><option>Nature</option><option>Sci-Fi</option><option>Other</option>
            </select>
          </div>
          <div>
            <label style="font-size:0.75rem;color:var(--text-muted);">Price</label>
            <input type="text" id="listing-price" placeholder='$50, Trade, Free, Best offer‚Ä¶' maxlength="50" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
            <div style="display:flex;gap:0.3rem;margin-top:0.3rem;flex-wrap:wrap;">
              <button type="button" onclick="document.getElementById('listing-price').value='Free'" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.15rem 0.4rem;border-radius:4px;font-size:0.65rem;cursor:pointer;">Free</button>
              <button type="button" onclick="document.getElementById('listing-price').value='Free (donations welcome)'" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.15rem 0.4rem;border-radius:4px;font-size:0.65rem;cursor:pointer;">Donations Welcome</button>
              <button type="button" onclick="document.getElementById('listing-price').value='Pay what you want'" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.15rem 0.4rem;border-radius:4px;font-size:0.65rem;cursor:pointer;">Pay What You Want</button>
            </div>
          </div>
          <div>
            <label style="font-size:0.75rem;color:var(--text-muted);">Payment Methods</label>
            <input type="text" id="listing-payment" placeholder='Venmo, Cash, Crypto, Trade‚Ä¶' maxlength="100" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
          </div>
          <div>
            <label style="font-size:0.75rem;color:var(--text-muted);">Location</label>
            <input type="text" id="listing-location" placeholder='Seattle area, Ships worldwide‚Ä¶' maxlength="100" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
          </div>
          <div style="display:flex;gap:0.5rem;justify-content:flex-end;margin-top:0.5rem;">
            <button class="btn" onclick="closeListingModal()" style="min-width:80px;min-height:36px;padding:0.3rem 0.8rem;font-size:0.8rem;">Cancel</button>
            <button class="btn btn-clickable" onclick="submitListing()" style="min-width:80px;min-height:36px;padding:0.3rem 0.8rem;font-size:0.8rem;">Submit</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Browse Tab -->
  <div id="tab-browse" class="tab-content" style="display:flex;flex-direction:column;height:100%;overflow:hidden;">
    <div id="browse-quickbar" style="display:flex;gap:0.5rem;padding:0.5rem 1rem;border-bottom:1px solid var(--border);overflow-x:auto;flex-shrink:0;align-items:center;">
      <span style="font-size:0.75rem;color:var(--text-muted);white-space:nowrap;">‚ö° Quick:</span>
      <div id="quickbar-sites" style="display:flex;gap:0.4rem;"></div>
    </div>
    <div style="display:flex;flex:1;min-height:0;">
      <div id="browse-directory" style="width:350px;min-width:280px;border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;">
        <div style="padding:0.5rem;border-bottom:1px solid var(--border);display:flex;gap:0.4rem;">
          <input type="text" id="browse-search" placeholder="Search sites..." oninput="filterBrowseSites()" style="flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.3rem 0.6rem;border-radius:6px;font-size:0.8rem;">
          <button onclick="showAddSiteModal()" style="background:var(--accent);border:none;border-radius:6px;color:#fff;padding:0.3rem 0.6rem;cursor:pointer;font-size:0.8rem;" title="Add site">+</button>
        </div>
        <div id="browse-categories" style="padding:0.4rem 0.5rem;display:flex;flex-wrap:wrap;gap:0.3rem;border-bottom:1px solid var(--border);"></div>
        <div id="browse-collections" style="padding:0.4rem 0.5rem;border-bottom:1px solid var(--border);max-height:120px;overflow-y:auto;"></div>
        <div id="browse-sort" style="padding:0.3rem 0.5rem;display:flex;gap:0.3rem;border-bottom:1px solid var(--border);align-items:center;">
          <span style="font-size:0.7rem;color:var(--text-muted);">Sort:</span>
          <span class="filter-pill active" onclick="setBrowseSort('popular')" id="sort-popular" style="font-size:0.68rem;padding:0.1rem 0.4rem;cursor:pointer;">üî• Popular</span>
          <span class="filter-pill" onclick="setBrowseSort('used')" id="sort-used" style="font-size:0.68rem;padding:0.1rem 0.4rem;cursor:pointer;">‚≠ê Most Used</span>
          <span class="filter-pill" onclick="setBrowseSort('recent')" id="sort-recent" style="font-size:0.68rem;padding:0.1rem 0.4rem;cursor:pointer;">üïê Recent</span>
          <span class="filter-pill" onclick="setBrowseSort('az')" id="sort-az" style="font-size:0.68rem;padding:0.1rem 0.4rem;cursor:pointer;">üî§ A-Z</span>
        </div>
        <div id="browse-sites" style="flex:1;overflow-y:auto;padding:0.4rem;"></div>
      </div>
      <div id="browse-panel" style="flex:1;display:flex;flex-direction:column;">
        <div id="browse-toolbar" style="display:flex;gap:0.4rem;padding:0.4rem 0.6rem;border-bottom:1px solid var(--border);align-items:center;">
          <button onclick="browsePanelBack()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1rem;" title="Back to directory">‚Üê</button>
          <input type="text" id="browse-url-bar" placeholder="Enter URL..." onkeydown="if(event.key==='Enter')browseNavigate(this.value)" style="flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.3rem 0.6rem;border-radius:6px;font-size:0.8rem;">
          <button onclick="browseNavigate(document.getElementById('browse-url-bar').value)" style="background:var(--accent);border:none;border-radius:6px;color:#fff;padding:0.3rem 0.6rem;cursor:pointer;font-size:0.8rem;">Go</button>
          <button onclick="browseOpenExternal()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.9rem;" title="Open in new tab">‚Üó</button>
        </div>
        <div id="browse-placeholder" style="flex:1;display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:0.9rem;">
          Select a site or enter a URL to browse
        </div>
        <iframe id="browse-iframe" style="flex:1;border:none;display:none;" sandbox="allow-scripts allow-same-origin allow-forms allow-popups" referrerpolicy="no-referrer"></iframe>
      </div>
    </div>
  </div>

  <!-- Dashboard Tab -->
  <div id="tab-dashboard" class="tab-content" style="padding:1rem;overflow-y:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
      <h2 style="color:var(--accent);margin:0;font-size:1.1rem;">üìä Dashboard</h2>
      <button onclick="showAddWidgetModal()" class="btn btn-clickable" style="min-width:auto;min-height:36px;padding:0.3rem 0.8rem;font-size:0.8rem;">+ Add Widget</button>
    </div>
    <div id="dashboard-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1rem;"></div>
    <div id="dashboard-empty" style="text-align:center;color:var(--text-muted);padding:3rem;">
      <p style="font-size:1.2rem;">Your dashboard is empty</p>
      <p>Click "+ Add Widget" to customize your view</p>
    </div>
  </div>

  <!-- Settings Panel (inline, replaces tab content) -->
  <div id="tab-settings" class="tab-content" style="padding:1.5rem;">
    <div class="panel">
      <h2 id="settings-title">‚öô Settings</h2>
      <div id="settings-body"></div>
    </div>
  </div>

  <script>
    // ‚îÄ‚îÄ Hub Tab System (SPA with pushState) ‚îÄ‚îÄ
    const HUB_TABS = ['board', 'reality', 'fantasy', 'market', 'browse', 'dashboard', 'streams', 'info', 'source', 'debug'];
    let currentTab = 'reality';

    function getTabFromPath() {
      const path = window.location.pathname.replace(/^\//, '').replace(/\/$/, '').toLowerCase();
      if (HUB_TABS.includes(path)) return path;
      return null;
    }

    function switchTab(tabId, pushState) {
      if (!HUB_TABS.includes(tabId)) tabId = 'reality';
      currentTab = tabId;

      // Update nav active state
      document.querySelectorAll('.hub-nav .tab').forEach(el => {
        el.classList.toggle('active', el.dataset.tab === tabId);
      });

      // Show correct content panel
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      const tabEl = document.getElementById('tab-' + tabId);
      if (tabEl) tabEl.classList.add('active');

      // Update page title
      const titles = { board: 'Board', reality: 'Reality', fantasy: 'Fantasy', market: 'Market', browse: 'Browse', dashboard: 'Dashboard', streams: 'Streams', info: 'Info', source: 'Source', debug: 'Debug' };
      document.title = 'Humanity ‚Äî ' + (titles[tabId] || 'Hub');

      // Update URL
      if (pushState !== false) {
        const newPath = '/' + tabId;
        if (window.location.pathname !== newPath) {
          history.pushState({ tab: tabId }, '', newPath);
        }
      }
    }

    // SPA navigation: intercept hub tab clicks
    document.querySelectorAll('.hub-nav .tab[data-tab]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        switchTab(link.dataset.tab);
      });
    });

    // Handle browser back/forward
    window.addEventListener('popstate', (e) => {
      const tab = (e.state && e.state.tab) || getTabFromPath();
      if (tab) switchTab(tab, false);
    });

    // Initialize from URL
    const initialTab = getTabFromPath() || 'reality';
    switchTab(initialTab, false);

    // ‚îÄ‚îÄ Debug Info ‚îÄ‚îÄ
    (function populateDebugInfo() {
      const el = (id) => document.getElementById(id);
      el('debug-version').textContent = '0.1.0-dev';
      el('debug-server').textContent = window.location.origin;
      el('debug-ua').textContent = navigator.userAgent.slice(0, 100);
      el('debug-screen').textContent = screen.width + '√ó' + screen.height + ' ¬∑ ' + (window.devicePixelRatio || 1) + 'x DPR';
      el('debug-loaded').textContent = new Date().toISOString();

      // Check relay connection
      async function checkConnection() {
        try {
          const res = await fetch('/api/stats');
          if (res.ok) {
            const data = await res.json();
            el('debug-connection').textContent = '‚úÖ Connected ‚Äî ' + (data.online_users || 0) + ' users online';
            el('debug-connection').style.color = '#4a8';
            if (data.version) el('debug-version').textContent = data.version;
          } else {
            el('debug-connection').textContent = '‚ö†Ô∏è Server responded ' + res.status;
            el('debug-connection').style.color = '#eb4';
          }
        } catch (e) {
          el('debug-connection').textContent = '‚ùå Cannot reach server';
          el('debug-connection').style.color = '#e55';
        }
      }
      checkConnection();
    })();

    // ‚îÄ‚îÄ Global: Click activates red border for 1s ‚îÄ‚îÄ
    document.addEventListener('click', function(e) {
      const btn = e.target.closest('.btn');
      if (!btn || btn.classList.contains('btn-disabled') || btn.classList.contains('btn-cooldown')) return;
      const wasChanneling = btn.classList.contains('btn-channeling');
      btn.classList.add('btn-activated');
      if (wasChanneling) btn.style.animation = 'none';
      setTimeout(() => {
        btn.classList.remove('btn-activated');
        if (wasChanneling) btn.style.animation = '';
      }, 1000);
    });

    // ‚îÄ‚îÄ Button Test Functions ‚îÄ‚îÄ
    function testBtnClick(btn) {
      btn.textContent = '‚úì Clicked!';
      setTimeout(() => { btn.textContent = 'Hover / Click Me'; }, 800);
    }

    const states = ['btn-clickable', 'btn-channeling', 'btn-activated', 'btn-cooldown', 'btn-disabled'];
    function cycleState(btn) {
      const current = states.find(s => btn.classList.contains(s)) || 'btn-clickable';
      const idx = states.indexOf(current);
      const next = states[(idx + 1) % states.length];
      states.forEach(s => btn.classList.remove(s));
      btn.classList.add(next);
      btn.querySelectorAll('.btn-cooldown-timer').forEach(t => t.remove());
      if (next === 'btn-cooldown') {
        btn.innerHTML = btn.textContent.replace(/[\d.]+s/g, '').trim();
        const topT = document.createElement('span');
        topT.className = 'btn-cooldown-timer top';
        topT.textContent = '‚àû';
        const botT = document.createElement('span');
        botT.className = 'btn-cooldown-timer bottom';
        botT.textContent = '‚àû';
        btn.appendChild(topT);
        btn.appendChild(botT);
      }
    }

    function startCooldown(btn, seconds) {
      if (btn.classList.contains('btn-cooldown')) return;
      const originalText = btn.textContent;
      btn.classList.remove('btn-clickable');
      btn.classList.add('btn-cooldown');

      const topT = document.createElement('span');
      topT.className = 'btn-cooldown-timer top';
      const botT = document.createElement('span');
      botT.className = 'btn-cooldown-timer bottom';
      btn.appendChild(topT);
      btn.appendChild(botT);

      let remaining = seconds;
      const update = () => {
        topT.textContent = remaining.toFixed(1) + 's';
        botT.textContent = remaining.toFixed(1) + 's';
      };
      update();

      const interval = setInterval(() => {
        remaining -= 0.1;
        if (remaining <= 0) {
          clearInterval(interval);
          btn.classList.remove('btn-cooldown');
          btn.classList.add('btn-clickable');
          topT.remove();
          botT.remove();
          btn.textContent = originalText;
        } else {
          update();
        }
      }, 100);
    }

    // toggleGoLive removed ‚Äî replaced by streamGoLive/streamStop

    function toggleChannel(btn) {
      if (btn.classList.contains('btn-channeling')) {
        btn.classList.remove('btn-channeling');
        btn.classList.add('btn-clickable');
        btn.textContent = btn.textContent.replace('Stop', 'Channel');
      } else {
        btn.classList.remove('btn-clickable');
        btn.classList.add('btn-channeling');
        btn.textContent = btn.textContent.replace('Channel', 'Stop');
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // REALITY TAB ‚Äî Todo, Notes, Garden, Catalogs
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // ‚îÄ‚îÄ Card collapse ‚îÄ‚îÄ
    const REALITY_CARDS = ['todo', 'notes', 'garden', 'references', 'elements', 'materials', 'inventory', 'assets'];
    function toggleRealityCard(id) {
      const card = document.getElementById('reality-' + id);
      if (card) card.classList.toggle('collapsed');
      localStorage.setItem('reality_collapsed_' + id, card.classList.contains('collapsed'));
    }
    // Restore collapse state
    REALITY_CARDS.forEach(id => {
      if (localStorage.getItem('reality_collapsed_' + id) === 'true') {
        const card = document.getElementById('reality-' + id);
        if (card) card.classList.add('collapsed');
      }
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // REFERENCE SOURCES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const REF_SOURCES = [
      { icon: '‚öõÔ∏è', name: 'NIST', url: 'https://nist.gov', desc: 'Physical constants, element data, standards' },
      { icon: 'üß™', name: 'PubChem', url: 'https://pubchem.ncbi.nlm.nih.gov', desc: 'Chemical compounds database' },
      { icon: 'üî¨', name: 'PubMed', url: 'https://pubmed.ncbi.nlm.nih.gov', desc: 'Biomedical research papers' },
      { icon: 'üåå', name: 'NASA ADS', url: 'https://ui.adsabs.harvard.edu', desc: 'Astrophysics data system' },
      { icon: 'üìñ', name: 'Wikipedia', url: 'https://wikipedia.org', desc: 'General reference encyclopedia' },
      { icon: 'ü™®', name: 'USGS', url: 'https://usgs.gov', desc: 'Geological surveys, minerals, mines' },
      { icon: 'üèóÔ∏è', name: 'MatWeb', url: 'https://matweb.com', desc: 'Material property data' },
      { icon: 'üìä', name: 'Wolfram Alpha', url: 'https://wolframalpha.com', desc: 'Computational knowledge engine' },
    ];
    (function renderRefSources() {
      document.getElementById('ref-sources-grid').innerHTML = REF_SOURCES.map(s =>
        `<a href="${s.url}" target="_blank" rel="noopener" class="ref-card">
          <span class="ref-icon">${s.icon}</span>
          <div><div class="ref-name">${s.name}</div><div class="ref-desc">${s.desc}</div></div>
        </a>`
      ).join('');
    })();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ELEMENT CATALOG
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ELEMENTS = [
      { symbol:'H', name:'Hydrogen', number:1, category:'nonmetal', mass:1.008, phase:'Gas',
        density:'0.00008988 g/cm¬≥', meltingPoint:'-259.16 ¬∞C', boilingPoint:'-252.87 ¬∞C',
        discovered:'1766', discoverer:'Henry Cavendish',
        uses:['Fuel cells','Ammonia production','Rocket fuel','Hydrogenation'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C1333740'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Hydrogen'}],
        description:'Lightest element. Most abundant chemical substance in the universe.' },
      { symbol:'C', name:'Carbon', number:6, category:'nonmetal', mass:12.011, phase:'Solid',
        density:'2.267 g/cm¬≥', meltingPoint:'3550 ¬∞C', boilingPoint:'4027 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Steel production','Fuels','Plastics','Diamond/graphite'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440440'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Carbon'}],
        description:'Basis of all known life. Forms more compounds than any other element.' },
      { symbol:'N', name:'Nitrogen', number:7, category:'nonmetal', mass:14.007, phase:'Gas',
        density:'0.0012506 g/cm¬≥', meltingPoint:'-210.00 ¬∞C', boilingPoint:'-195.79 ¬∞C',
        discovered:'1772', discoverer:'Daniel Rutherford',
        uses:['Fertilizers','Explosives','Cryogenics','Food preservation'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7727379'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Nitrogen'}],
        description:'Makes up 78% of Earth\'s atmosphere. Essential for amino acids and DNA.' },
      { symbol:'O', name:'Oxygen', number:8, category:'nonmetal', mass:15.999, phase:'Gas',
        density:'0.001429 g/cm¬≥', meltingPoint:'-218.79 ¬∞C', boilingPoint:'-182.96 ¬∞C',
        discovered:'1774', discoverer:'Joseph Priestley',
        uses:['Respiration','Steel manufacturing','Medical','Welding'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7782447'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Oxygen'}],
        description:'Essential for aerobic life. Third most abundant element in the universe.' },
      { symbol:'Si', name:'Silicon', number:14, category:'metalloid', mass:28.085, phase:'Solid',
        density:'2.3296 g/cm¬≥', meltingPoint:'1414 ¬∞C', boilingPoint:'3265 ¬∞C',
        discovered:'1824', discoverer:'J√∂ns Jacob Berzelius',
        uses:['Semiconductors','Glass','Concrete','Solar cells'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440213'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Silicon'}],
        description:'Second most abundant element in Earth\'s crust. Foundation of modern electronics.' },
      { symbol:'Fe', name:'Iron', number:26, category:'transition-metal', mass:55.845, phase:'Solid',
        density:'7.874 g/cm¬≥', meltingPoint:'1538 ¬∞C', boilingPoint:'2862 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Steel','Construction','Machinery','Magnets'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439896'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Iron'}],
        description:'Most common element on Earth by mass. Core component of steel.' },
      { symbol:'Cu', name:'Copper', number:29, category:'transition-metal', mass:63.546, phase:'Solid',
        density:'8.96 g/cm¬≥', meltingPoint:'1084.62 ¬∞C', boilingPoint:'2562 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Electrical wiring','Plumbing','Electronics','Alloys'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440508'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Copper'}],
        description:'Excellent conductor of electricity and heat. One of few metals with natural color.' },
      { symbol:'Ag', name:'Silver', number:47, category:'transition-metal', mass:107.868, phase:'Solid',
        density:'10.49 g/cm¬≥', meltingPoint:'961.78 ¬∞C', boilingPoint:'2162 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Jewelry','Electronics','Photography','Antibacterial'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440224'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Silver'}],
        description:'Highest electrical and thermal conductivity of any element. Precious metal.' },
      { symbol:'Au', name:'Gold', number:79, category:'transition-metal', mass:196.967, phase:'Solid',
        density:'19.3 g/cm¬≥', meltingPoint:'1064.18 ¬∞C', boilingPoint:'2856 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Currency/Investment','Jewelry','Electronics','Dentistry'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440575'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Gold'}],
        description:'Highly valued precious metal. Extremely malleable and resistant to corrosion.' },
      { symbol:'U', name:'Uranium', number:92, category:'actinide', mass:238.029, phase:'Solid',
        density:'19.1 g/cm¬≥', meltingPoint:'1132.2 ¬∞C', boilingPoint:'4131 ¬∞C',
        discovered:'1789', discoverer:'Martin Heinrich Klaproth',
        uses:['Nuclear power','Nuclear weapons','Radiation shielding','Dating rocks'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440611'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Uranium'}],
        description:'Heaviest naturally occurring element. Primary fuel for nuclear reactors.' },
{ symbol:'He', name:'Helium', number:2, category:'noble-gas', mass:4.003, phase:'Gas',
        density:'0.0001786 g/cm¬≥', meltingPoint:'-272.20 ¬∞C', boilingPoint:'-268.93 ¬∞C',
        discovered:'1868', discoverer:'Pierre Janssen & Joseph Lockyer',
        uses:['Balloons','Cryogenics','Welding shield gas','MRI coolant'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440597'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Helium'}],
        description:'Second lightest element. Inert noble gas used in cryogenics and MRI cooling.' },
      { symbol:'Li', name:'Lithium', number:3, category:'alkali-metal', mass:6.941, phase:'Solid',
        density:'0.534 g/cm¬≥', meltingPoint:'180.54 ¬∞C', boilingPoint:'1342 ¬∞C',
        discovered:'1817', discoverer:'Johan August Arfwedson',
        uses:['Batteries','Ceramics','Pharmaceuticals','Lubricant grease'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439932'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Lithium'}],
        description:'Lightest metal. Key component in rechargeable lithium-ion batteries.' },
      { symbol:'Be', name:'Beryllium', number:4, category:'alkaline-earth', mass:9.012, phase:'Solid',
        density:'1.85 g/cm¬≥', meltingPoint:'1287 ¬∞C', boilingPoint:'2470 ¬∞C',
        discovered:'1798', discoverer:'Louis Nicolas Vauquelin',
        uses:['Aerospace alloys','X-ray windows','Nuclear reactors','Speakers'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440417'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Beryllium'}],
        description:'Lightweight, strong metal. Transparent to X-rays, used in aerospace.' },
      { symbol:'B', name:'Boron', number:5, category:'metalloid', mass:10.81, phase:'Solid',
        density:'2.34 g/cm¬≥', meltingPoint:'2076 ¬∞C', boilingPoint:'3927 ¬∞C',
        discovered:'1808', discoverer:'Joseph Louis Gay-Lussac & Louis Jacques Th√©nard',
        uses:['Fiberglass','Borosilicate glass','Detergents','Semiconductors'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440428'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Boron'}],
        description:'Metalloid essential for borosilicate glass and fiberglass insulation.' },
      { symbol:'F', name:'Fluorine', number:9, category:'halogen', mass:18.998, phase:'Gas',
        density:'0.001696 g/cm¬≥', meltingPoint:'-219.67 ¬∞C', boilingPoint:'-188.11 ¬∞C',
        discovered:'1886', discoverer:'Henri Moissan',
        uses:['Toothpaste','Teflon','Refrigerants','Uranium enrichment'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7782414'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Fluorine'}],
        description:'Most electronegative element. Essential for fluoride in dental care.' },
      { symbol:'Ne', name:'Neon', number:10, category:'noble-gas', mass:20.180, phase:'Gas',
        density:'0.0008999 g/cm¬≥', meltingPoint:'-248.59 ¬∞C', boilingPoint:'-246.08 ¬∞C',
        discovered:'1898', discoverer:'William Ramsay & Morris Travers',
        uses:['Neon signs','Lasers','Cryogenics','Television tubes'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440019'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Neon'}],
        description:'Noble gas famous for its bright reddish-orange glow in discharge tubes.' },
      { symbol:'Na', name:'Sodium', number:11, category:'alkali-metal', mass:22.990, phase:'Solid',
        density:'0.971 g/cm¬≥', meltingPoint:'97.72 ¬∞C', boilingPoint:'883 ¬∞C',
        discovered:'1807', discoverer:'Humphry Davy',
        uses:['Table salt','Street lighting','Heat transfer','Chemical synthesis'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440235'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Sodium'}],
        description:'Highly reactive alkali metal. Essential biological element in nerve function.' },
      { symbol:'Mg', name:'Magnesium', number:12, category:'alkaline-earth', mass:24.305, phase:'Solid',
        density:'1.738 g/cm¬≥', meltingPoint:'650 ¬∞C', boilingPoint:'1091 ¬∞C',
        discovered:'1755', discoverer:'Joseph Black',
        uses:['Lightweight alloys','Fireworks','Antacids','Electronics casings'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439954'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Magnesium'}],
        description:'Light structural metal. Burns with brilliant white flame.' },
      { symbol:'Al', name:'Aluminum', number:13, category:'post-transition-metal', mass:26.982, phase:'Solid',
        density:'2.70 g/cm¬≥', meltingPoint:'660.32 ¬∞C', boilingPoint:'2519 ¬∞C',
        discovered:'1825', discoverer:'Hans Christian √òrsted',
        uses:['Aircraft','Cans','Foil','Window frames','Electronics'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7429905'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Aluminum'}],
        description:'Most abundant metal in Earth\'s crust. Lightweight and corrosion-resistant.' },
      { symbol:'P', name:'Phosphorus', number:15, category:'nonmetal', mass:30.974, phase:'Solid',
        density:'1.82 g/cm¬≥', meltingPoint:'44.15 ¬∞C', boilingPoint:'280.5 ¬∞C',
        discovered:'1669', discoverer:'Hennig Brand',
        uses:['Fertilizers','Matches','Detergents','Steel production'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7723140'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Phosphorus'}],
        description:'Essential for life ‚Äî key part of DNA, RNA, and ATP.' },
      { symbol:'S', name:'Sulfur', number:16, category:'nonmetal', mass:32.06, phase:'Solid',
        density:'2.067 g/cm¬≥', meltingPoint:'115.21 ¬∞C', boilingPoint:'444.6 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Sulfuric acid','Fertilizers','Vulcanization','Gunpowder'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7704349'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Sulfur'}],
        description:'Yellow nonmetal known since ancient times. Essential for proteins.' },
      { symbol:'Cl', name:'Chlorine', number:17, category:'halogen', mass:35.45, phase:'Gas',
        density:'0.003214 g/cm¬≥', meltingPoint:'-101.5 ¬∞C', boilingPoint:'-34.04 ¬∞C',
        discovered:'1774', discoverer:'Carl Wilhelm Scheele',
        uses:['Water treatment','PVC production','Bleach','Disinfectants'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7782505'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Chlorine'}],
        description:'Greenish-yellow halogen. Widely used for water purification.' },
      { symbol:'Ar', name:'Argon', number:18, category:'noble-gas', mass:39.948, phase:'Gas',
        density:'0.001784 g/cm¬≥', meltingPoint:'-189.34 ¬∞C', boilingPoint:'-185.85 ¬∞C',
        discovered:'1894', discoverer:'Lord Rayleigh & William Ramsay',
        uses:['Welding shield gas','Light bulbs','Insulated windows','Lasers'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440371'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Argon'}],
        description:'Third most abundant gas in atmosphere. Inert, used as shielding gas.' },
      { symbol:'K', name:'Potassium', number:19, category:'alkali-metal', mass:39.098, phase:'Solid',
        density:'0.862 g/cm¬≥', meltingPoint:'63.5 ¬∞C', boilingPoint:'759 ¬∞C',
        discovered:'1807', discoverer:'Humphry Davy',
        uses:['Fertilizers','Soap','Glass','Salt substitutes'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440097'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Potassium'}],
        description:'Essential for plant growth and nerve function. Highly reactive metal.' },
      { symbol:'Ca', name:'Calcium', number:20, category:'alkaline-earth', mass:40.078, phase:'Solid',
        density:'1.55 g/cm¬≥', meltingPoint:'842 ¬∞C', boilingPoint:'1484 ¬∞C',
        discovered:'1808', discoverer:'Humphry Davy',
        uses:['Cement','Bone health supplements','Steel refining','Cheese making'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440702'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Calcium'}],
        description:'Fifth most abundant element in Earth\'s crust. Essential for bones and teeth.' },
      { symbol:'Sc', name:'Scandium', number:21, category:'transition-metal', mass:44.956, phase:'Solid',
        density:'2.985 g/cm¬≥', meltingPoint:'1541 ¬∞C', boilingPoint:'2836 ¬∞C',
        discovered:'1879', discoverer:'Lars Fredrik Nilson',
        uses:['Aerospace alloys','Sports equipment','Lighting','Lasers'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440200'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Scandium'}],
        description:'Light transition metal that strengthens aluminum alloys for aerospace.' },
      { symbol:'Ti', name:'Titanium', number:22, category:'transition-metal', mass:47.867, phase:'Solid',
        density:'4.506 g/cm¬≥', meltingPoint:'1668 ¬∞C', boilingPoint:'3287 ¬∞C',
        discovered:'1791', discoverer:'William Gregor',
        uses:['Aerospace','Medical implants','Pigments','Jewelry'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440326'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Titanium'}],
        description:'Strong, lightweight, corrosion-resistant. Ideal for aerospace and implants.' },
      { symbol:'V', name:'Vanadium', number:23, category:'transition-metal', mass:50.942, phase:'Solid',
        density:'6.11 g/cm¬≥', meltingPoint:'1910 ¬∞C', boilingPoint:'3407 ¬∞C',
        discovered:'1801', discoverer:'Andr√©s Manuel del R√≠o',
        uses:['Steel alloys','Vanadium redox batteries','Catalysts','Aerospace'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440622'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Vanadium'}],
        description:'Transition metal that adds strength and toughness to steel alloys.' },
      { symbol:'Cr', name:'Chromium', number:24, category:'transition-metal', mass:51.996, phase:'Solid',
        density:'7.15 g/cm¬≥', meltingPoint:'1907 ¬∞C', boilingPoint:'2671 ¬∞C',
        discovered:'1797', discoverer:'Louis Nicolas Vauquelin',
        uses:['Stainless steel','Chrome plating','Pigments','Leather tanning'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440473'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Chromium'}],
        description:'Hard, lustrous metal. Key ingredient in stainless steel.' },
      { symbol:'Mn', name:'Manganese', number:25, category:'transition-metal', mass:54.938, phase:'Solid',
        density:'7.21 g/cm¬≥', meltingPoint:'1246 ¬∞C', boilingPoint:'2061 ¬∞C',
        discovered:'1774', discoverer:'Johan Gottlieb Gahn',
        uses:['Steel production','Batteries','Pigments','Water treatment'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439965'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Manganese'}],
        description:'Essential for steel production. Improves strength and hardness.' },
      { symbol:'Co', name:'Cobalt', number:27, category:'transition-metal', mass:58.933, phase:'Solid',
        density:'8.90 g/cm¬≥', meltingPoint:'1495 ¬∞C', boilingPoint:'2927 ¬∞C',
        discovered:'1735', discoverer:'Georg Brandt',
        uses:['Lithium-ion batteries','Superalloys','Blue pigments','Magnets'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440484'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Cobalt'}],
        description:'Blue-tinted metal critical for rechargeable battery cathodes.' },
      { symbol:'Ni', name:'Nickel', number:28, category:'transition-metal', mass:58.693, phase:'Solid',
        density:'8.908 g/cm¬≥', meltingPoint:'1455 ¬∞C', boilingPoint:'2913 ¬∞C',
        discovered:'1751', discoverer:'Axel Fredrik Cronstedt',
        uses:['Stainless steel','Coins','Batteries','Plating'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440020'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Nickel'}],
        description:'Corrosion-resistant metal. Major component of stainless steel and coins.' },
      { symbol:'Zn', name:'Zinc', number:30, category:'transition-metal', mass:65.38, phase:'Solid',
        density:'7.134 g/cm¬≥', meltingPoint:'419.53 ¬∞C', boilingPoint:'907 ¬∞C',
        discovered:'1746', discoverer:'Andreas Sigismund Marggraf',
        uses:['Galvanizing','Alloys (brass)','Batteries','Sunscreen'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440666'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Zinc'}],
        description:'Used to galvanize steel against corrosion. Essential trace element.' },
      { symbol:'Ga', name:'Gallium', number:31, category:'post-transition-metal', mass:69.723, phase:'Solid',
        density:'5.91 g/cm¬≥', meltingPoint:'29.76 ¬∞C', boilingPoint:'2204 ¬∞C',
        discovered:'1875', discoverer:'Paul Emile Lecoq de Boisbaudran',
        uses:['Semiconductors','LEDs','Solar cells','Thermometers'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440553'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Gallium'}],
        description:'Melts near body temperature. Critical for GaAs semiconductors and LEDs.' },
      { symbol:'Ge', name:'Germanium', number:32, category:'metalloid', mass:72.630, phase:'Solid',
        density:'5.323 g/cm¬≥', meltingPoint:'938.25 ¬∞C', boilingPoint:'2833 ¬∞C',
        discovered:'1886', discoverer:'Clemens Winkler',
        uses:['Fiber optics','Infrared optics','Transistors','Solar cells'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440564'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Germanium'}],
        description:'Semiconductor metalloid. Predicted by Mendeleev as eka-silicon.' },
      { symbol:'As', name:'Arsenic', number:33, category:'metalloid', mass:74.922, phase:'Solid',
        density:'5.776 g/cm¬≥', meltingPoint:'816 ¬∞C (sublimes)', boilingPoint:'614 ¬∞C (sublimes)',
        discovered:'Ancient', discoverer:'Albertus Magnus (c. 1250)',
        uses:['Semiconductors','Wood preservatives','Pesticides','Lead alloys'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440382'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Arsenic'}],
        description:'Toxic metalloid historically used as a poison. Now used in semiconductors.' },
      { symbol:'Se', name:'Selenium', number:34, category:'nonmetal', mass:78.971, phase:'Solid',
        density:'4.809 g/cm¬≥', meltingPoint:'221 ¬∞C', boilingPoint:'685 ¬∞C',
        discovered:'1817', discoverer:'J√∂ns Jacob Berzelius',
        uses:['Glass decolorizer','Electronics','Solar cells','Dietary supplement'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7782492'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Selenium'}],
        description:'Essential trace element. Photoconductor used in photocopiers.' },
      { symbol:'Br', name:'Bromine', number:35, category:'halogen', mass:79.904, phase:'Liquid',
        density:'3.1028 g/cm¬≥', meltingPoint:'-7.2 ¬∞C', boilingPoint:'58.8 ¬∞C',
        discovered:'1826', discoverer:'Antoine J√©r√¥me Balard',
        uses:['Flame retardants','Pesticides','Pharmaceuticals','Photography'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7726956'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Bromine'}],
        description:'One of two elements liquid at room temperature. Reddish-brown and pungent.' },
      { symbol:'Kr', name:'Krypton', number:36, category:'noble-gas', mass:83.798, phase:'Gas',
        density:'0.003749 g/cm¬≥', meltingPoint:'-157.36 ¬∞C', boilingPoint:'-153.22 ¬∞C',
        discovered:'1898', discoverer:'William Ramsay & Morris Travers',
        uses:['Lighting','Photography flash','Insulated windows','Lasers'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439909'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Krypton'}],
        description:'Noble gas used in high-performance lighting and photographic flash.' },
      { symbol:'Rb', name:'Rubidium', number:37, category:'alkali-metal', mass:85.468, phase:'Solid',
        density:'1.532 g/cm¬≥', meltingPoint:'39.31 ¬∞C', boilingPoint:'688 ¬∞C',
        discovered:'1861', discoverer:'Robert Bunsen & Gustav Kirchhoff',
        uses:['Atomic clocks','Fireworks','Photocells','Medical imaging'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440177'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Rubidium'}],
        description:'Soft, silvery alkali metal. Used in precision atomic clocks.' },
      { symbol:'Sr', name:'Strontium', number:38, category:'alkaline-earth', mass:87.62, phase:'Solid',
        density:'2.64 g/cm¬≥', meltingPoint:'777 ¬∞C', boilingPoint:'1382 ¬∞C',
        discovered:'1790', discoverer:'Adair Crawford',
        uses:['Fireworks (red)','Ferrite magnets','Toothpaste','Flares'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440246'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Strontium'}],
        description:'Produces brilliant red flame. Used in fireworks and flares.' },
      { symbol:'Y', name:'Yttrium', number:39, category:'transition-metal', mass:88.906, phase:'Solid',
        density:'4.469 g/cm¬≥', meltingPoint:'1526 ¬∞C', boilingPoint:'3345 ¬∞C',
        discovered:'1794', discoverer:'Johan Gadolin',
        uses:['LEDs','Superconductors','Lasers','Camera lenses'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440655'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Yttrium'}],
        description:'Silvery metal used in phosphors for LEDs and display screens.' },
      { symbol:'Zr', name:'Zirconium', number:40, category:'transition-metal', mass:91.224, phase:'Solid',
        density:'6.506 g/cm¬≥', meltingPoint:'1855 ¬∞C', boilingPoint:'4409 ¬∞C',
        discovered:'1789', discoverer:'Martin Heinrich Klaproth',
        uses:['Nuclear fuel cladding','Ceramics','Prosthetics','Chemical processing'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440677'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Zirconium'}],
        description:'Corrosion-resistant metal. Primary use in nuclear reactor fuel cladding.' },
      { symbol:'Nb', name:'Niobium', number:41, category:'transition-metal', mass:92.906, phase:'Solid',
        density:'8.57 g/cm¬≥', meltingPoint:'2477 ¬∞C', boilingPoint:'4744 ¬∞C',
        discovered:'1801', discoverer:'Charles Hatchett',
        uses:['Superconducting magnets','Steel alloys','Jet engines','Jewelry'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440031'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Niobium'}],
        description:'Superconducting metal used in MRI magnets and particle accelerators.' },
      { symbol:'Mo', name:'Molybdenum', number:42, category:'transition-metal', mass:95.95, phase:'Solid',
        density:'10.22 g/cm¬≥', meltingPoint:'2623 ¬∞C', boilingPoint:'4639 ¬∞C',
        discovered:'1781', discoverer:'Carl Wilhelm Scheele',
        uses:['Steel alloys','Catalysts','Lubricants','Electronics'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439987'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Molybdenum'}],
        description:'High-melting-point metal that strengthens steel alloys.' },
      { symbol:'Tc', name:'Technetium', number:43, category:'transition-metal', mass:98, phase:'Solid',
        density:'11.5 g/cm¬≥', meltingPoint:'2157 ¬∞C', boilingPoint:'4265 ¬∞C',
        discovered:'1937', discoverer:'Carlo Perrier & Emilio Segr√®',
        uses:['Medical imaging','Nuclear medicine','Radiography','Catalysts'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440262'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Technetium'}],
        description:'First artificially produced element. Widely used in medical diagnostics.' },
      { symbol:'Ru', name:'Ruthenium', number:44, category:'transition-metal', mass:101.07, phase:'Solid',
        density:'12.37 g/cm¬≥', meltingPoint:'2334 ¬∞C', boilingPoint:'4150 ¬∞C',
        discovered:'1844', discoverer:'Karl Ernst Claus',
        uses:['Catalysts','Electronics','Wear-resistant coatings','Solar cells'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440188'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Ruthenium'}],
        description:'Rare platinum-group metal used in catalysis and electronics.' },
      { symbol:'Rh', name:'Rhodium', number:45, category:'transition-metal', mass:102.906, phase:'Solid',
        density:'12.41 g/cm¬≥', meltingPoint:'1964 ¬∞C', boilingPoint:'3695 ¬∞C',
        discovered:'1803', discoverer:'William Hyde Wollaston',
        uses:['Catalytic converters','Jewelry','Mirrors','Chemical catalysts'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440166'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Rhodium'}],
        description:'Rarest and most expensive precious metal. Key in automotive catalytic converters.' },
      { symbol:'Pd', name:'Palladium', number:46, category:'transition-metal', mass:106.42, phase:'Solid',
        density:'12.023 g/cm¬≥', meltingPoint:'1554.9 ¬∞C', boilingPoint:'2963 ¬∞C',
        discovered:'1803', discoverer:'William Hyde Wollaston',
        uses:['Catalytic converters','Electronics','Dentistry','Hydrogen purification'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440053'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Palladium'}],
        description:'Platinum-group metal. Absorbs up to 900 times its own volume of hydrogen.' },
      { symbol:'Cd', name:'Cadmium', number:48, category:'transition-metal', mass:112.414, phase:'Solid',
        density:'8.69 g/cm¬≥', meltingPoint:'321.07 ¬∞C', boilingPoint:'767 ¬∞C',
        discovered:'1817', discoverer:'Friedrich Stromeyer',
        uses:['Batteries (NiCd)','Pigments','Coatings','Nuclear reactor control rods'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440439'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Cadmium'}],
        description:'Toxic heavy metal. Used in rechargeable batteries and yellow pigments.' },
      { symbol:'In', name:'Indium', number:49, category:'post-transition-metal', mass:114.818, phase:'Solid',
        density:'7.31 g/cm¬≥', meltingPoint:'156.6 ¬∞C', boilingPoint:'2072 ¬∞C',
        discovered:'1863', discoverer:'Ferdinand Reich & Hieronymus Theodor Richter',
        uses:['Touchscreens (ITO)','Solders','Semiconductors','Low-melting alloys'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440746'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Indium'}],
        description:'Soft metal critical for transparent conductive coatings in touchscreens.' },
      { symbol:'Sn', name:'Tin', number:50, category:'post-transition-metal', mass:118.710, phase:'Solid',
        density:'7.287 g/cm¬≥', meltingPoint:'231.93 ¬∞C', boilingPoint:'2602 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Tin cans','Solder','Bronze alloy','Tin plating'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440315'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Tin'}],
        description:'One of the earliest metals used by humans. Key component of bronze and solder.' },
      { symbol:'Sb', name:'Antimony', number:51, category:'metalloid', mass:121.760, phase:'Solid',
        density:'6.685 g/cm¬≥', meltingPoint:'630.63 ¬∞C', boilingPoint:'1587 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Flame retardants','Lead-acid batteries','Semiconductors','Cosmetics'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440360'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Antimony'}],
        description:'Brittle metalloid used in flame retardants and lead-acid battery alloys.' },
      { symbol:'Te', name:'Tellurium', number:52, category:'metalloid', mass:127.60, phase:'Solid',
        density:'6.232 g/cm¬≥', meltingPoint:'449.51 ¬∞C', boilingPoint:'988 ¬∞C',
        discovered:'1783', discoverer:'Franz-Joseph M√ºller von Reichenstein',
        uses:['Solar cells (CdTe)','Thermoelectrics','Alloys','Rubber vulcanization'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C13494809'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Tellurium'}],
        description:'Rare metalloid used in thin-film solar cells and thermoelectric devices.' },
      { symbol:'I', name:'Iodine', number:53, category:'halogen', mass:126.904, phase:'Solid',
        density:'4.933 g/cm¬≥', meltingPoint:'113.7 ¬∞C', boilingPoint:'184.3 ¬∞C',
        discovered:'1811', discoverer:'Bernard Courtois',
        uses:['Disinfectants','Thyroid medicine','Photography','Dyes'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7553562'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Iodine'}],
        description:'Essential for thyroid hormones. Purple vapor when heated.' },
      { symbol:'Xe', name:'Xenon', number:54, category:'noble-gas', mass:131.293, phase:'Gas',
        density:'0.005887 g/cm¬≥', meltingPoint:'-111.75 ¬∞C', boilingPoint:'-108.10 ¬∞C',
        discovered:'1898', discoverer:'William Ramsay & Morris Travers',
        uses:['Headlights','Anesthesia','Ion propulsion','Medical imaging'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440633'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Xenon'}],
        description:'Heavy noble gas. Used in bright arc lamps and spacecraft ion engines.' },
      { symbol:'Cs', name:'Cesium', number:55, category:'alkali-metal', mass:132.905, phase:'Solid',
        density:'1.873 g/cm¬≥', meltingPoint:'28.44 ¬∞C', boilingPoint:'671 ¬∞C',
        discovered:'1860', discoverer:'Robert Bunsen & Gustav Kirchhoff',
        uses:['Atomic clocks','Drilling fluids','Photoelectric cells','Cancer treatment'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440462'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Cesium'}],
        description:'Most electropositive stable element. Defines the second via atomic clocks.' },
      { symbol:'Ba', name:'Barium', number:56, category:'alkaline-earth', mass:137.327, phase:'Solid',
        density:'3.594 g/cm¬≥', meltingPoint:'727 ¬∞C', boilingPoint:'1845 ¬∞C',
        discovered:'1808', discoverer:'Humphry Davy',
        uses:['Medical imaging (barium meal)','Drilling fluids','Fireworks (green)','Glass'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440393'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Barium'}],
        description:'Heavy alkaline earth metal. Barium sulfate used in X-ray imaging.' },
      { symbol:'La', name:'Lanthanum', number:57, category:'lanthanide', mass:138.905, phase:'Solid',
        density:'6.145 g/cm¬≥', meltingPoint:'920 ¬∞C', boilingPoint:'3464 ¬∞C',
        discovered:'1839', discoverer:'Carl Gustaf Mosander',
        uses:['Camera lenses','Catalysts','Lighter flints','Hybrid car batteries'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439910'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Lanthanum'}],
        description:'First of the lanthanides. Used in high-quality optical glass.' },
      { symbol:'Ce', name:'Cerium', number:58, category:'lanthanide', mass:140.116, phase:'Solid',
        density:'6.770 g/cm¬≥', meltingPoint:'799 ¬∞C', boilingPoint:'3443 ¬∞C',
        discovered:'1803', discoverer:'J√∂ns Jacob Berzelius & Wilhelm Hisinger',
        uses:['Catalytic converters','Glass polishing','Self-cleaning ovens','Lighter flints'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440451'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Cerium'}],
        description:'Most abundant lanthanide. Used in catalytic converters and glass polishing.' },
      { symbol:'Pr', name:'Praseodymium', number:59, category:'lanthanide', mass:140.908, phase:'Solid',
        density:'6.773 g/cm¬≥', meltingPoint:'931 ¬∞C', boilingPoint:'3520 ¬∞C',
        discovered:'1885', discoverer:'Carl Auer von Welsbach',
        uses:['Magnets','Aircraft engines','Yellow glass','Lighter flints'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440100'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Praseodymium'}],
        description:'Rare earth used in strong permanent magnets and aircraft engines.' },
      { symbol:'Nd', name:'Neodymium', number:60, category:'lanthanide', mass:144.242, phase:'Solid',
        density:'7.007 g/cm¬≥', meltingPoint:'1021 ¬∞C', boilingPoint:'3074 ¬∞C',
        discovered:'1885', discoverer:'Carl Auer von Welsbach',
        uses:['Powerful magnets','Lasers','Headphones','Wind turbines'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440008'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Neodymium'}],
        description:'Creates the strongest permanent magnets (NdFeB). Critical for green tech.' },
      { symbol:'Pm', name:'Promethium', number:61, category:'lanthanide', mass:145, phase:'Solid',
        density:'7.26 g/cm¬≥', meltingPoint:'1042 ¬∞C', boilingPoint:'3000 ¬∞C',
        discovered:'1945', discoverer:'Jacob A. Marinsky, Lawrence E. Glendenin & Charles D. Coryell',
        uses:['Nuclear batteries','Luminous paint','Thickness gauges','Research'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440126'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Promethium'}],
        description:'Only radioactive lanthanide with no stable isotopes. Extremely rare.' },
      { symbol:'Sm', name:'Samarium', number:62, category:'lanthanide', mass:150.36, phase:'Solid',
        density:'7.52 g/cm¬≥', meltingPoint:'1072 ¬∞C', boilingPoint:'1794 ¬∞C',
        discovered:'1879', discoverer:'Paul Emile Lecoq de Boisbaudran',
        uses:['Magnets','Cancer treatment','Nuclear reactor control','Headphones'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440199'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Samarium'}],
        description:'Used in samarium-cobalt magnets that resist demagnetization at high temperatures.' },
      { symbol:'Eu', name:'Europium', number:63, category:'lanthanide', mass:151.964, phase:'Solid',
        density:'5.243 g/cm¬≥', meltingPoint:'822 ¬∞C', boilingPoint:'1529 ¬∞C',
        discovered:'1901', discoverer:'Eug√®ne-Anatole Demar√ßay',
        uses:['Red phosphors (TVs)','Euro banknote security','Lasers','Fluorescent lamps'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440531'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Europium'}],
        description:'Most reactive lanthanide. Provides red color in TV screens and LEDs.' },
      { symbol:'Gd', name:'Gadolinium', number:64, category:'lanthanide', mass:157.25, phase:'Solid',
        density:'7.895 g/cm¬≥', meltingPoint:'1313 ¬∞C', boilingPoint:'3273 ¬∞C',
        discovered:'1880', discoverer:'Jean Charles Galissard de Marignac',
        uses:['MRI contrast agent','Nuclear reactors','Magnets','Neutron radiography'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440542'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Gadolinium'}],
        description:'Highest neutron absorption of any element. Widely used as MRI contrast agent.' },
      { symbol:'Tb', name:'Terbium', number:65, category:'lanthanide', mass:158.925, phase:'Solid',
        density:'8.229 g/cm¬≥', meltingPoint:'1356 ¬∞C', boilingPoint:'3230 ¬∞C',
        discovered:'1843', discoverer:'Carl Gustaf Mosander',
        uses:['Green phosphors','Solid-state devices','Sonar systems','Fuel cells'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440279'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Terbium'}],
        description:'Rare earth that provides green color in fluorescent lamps and displays.' },
      { symbol:'Dy', name:'Dysprosium', number:66, category:'lanthanide', mass:162.500, phase:'Solid',
        density:'8.55 g/cm¬≥', meltingPoint:'1412 ¬∞C', boilingPoint:'2567 ¬∞C',
        discovered:'1886', discoverer:'Paul Emile Lecoq de Boisbaudran',
        uses:['Permanent magnets','Nuclear control rods','Data storage','Lasers'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7429916'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Dysprosium'}],
        description:'Added to neodymium magnets to maintain strength at high temperatures.' },
      { symbol:'Ho', name:'Holmium', number:67, category:'lanthanide', mass:164.930, phase:'Solid',
        density:'8.795 g/cm¬≥', meltingPoint:'1474 ¬∞C', boilingPoint:'2700 ¬∞C',
        discovered:'1878', discoverer:'Marc Delafontaine & Jacques-Louis Soret',
        uses:['Lasers (medical)','Nuclear reactors','Magnets','Spectrophotometry'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440600'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Holmium'}],
        description:'Has the highest magnetic moment of any element. Used in medical lasers.' },
      { symbol:'Er', name:'Erbium', number:68, category:'lanthanide', mass:167.259, phase:'Solid',
        density:'9.066 g/cm¬≥', meltingPoint:'1529 ¬∞C', boilingPoint:'2868 ¬∞C',
        discovered:'1842', discoverer:'Carl Gustaf Mosander',
        uses:['Fiber optic amplifiers','Lasers','Glass colorant','Nuclear technology'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440520'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Erbium'}],
        description:'Critical for erbium-doped fiber amplifiers that enable long-distance internet.' },
      { symbol:'Tm', name:'Thulium', number:69, category:'lanthanide', mass:168.934, phase:'Solid',
        density:'9.321 g/cm¬≥', meltingPoint:'1545 ¬∞C', boilingPoint:'1950 ¬∞C',
        discovered:'1879', discoverer:'Per Teodor Cleve',
        uses:['Portable X-ray machines','Lasers','High-temp superconductors','Radiation dosimeters'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440304'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Thulium'}],
        description:'Rarest lanthanide. Used in portable X-ray devices and surgical lasers.' },
      { symbol:'Yb', name:'Ytterbium', number:70, category:'lanthanide', mass:173.045, phase:'Solid',
        density:'6.965 g/cm¬≥', meltingPoint:'819 ¬∞C', boilingPoint:'1196 ¬∞C',
        discovered:'1878', discoverer:'Jean Charles Galissard de Marignac',
        uses:['Atomic clocks','Stress gauges','Lasers','Metallurgy'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440644'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Ytterbium'}],
        description:'Used in world\'s most precise atomic clocks and as a stress gauge in explosions.' },
      { symbol:'Lu', name:'Lutetium', number:71, category:'lanthanide', mass:174.967, phase:'Solid',
        density:'9.84 g/cm¬≥', meltingPoint:'1663 ¬∞C', boilingPoint:'3402 ¬∞C',
        discovered:'1907', discoverer:'Georges Urbain',
        uses:['PET scan catalysts','Oil refining','LED phosphors','Research'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439943'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Lutetium'}],
        description:'Hardest and densest lanthanide. Used in PET scan detectors.' },
      { symbol:'Hf', name:'Hafnium', number:72, category:'transition-metal', mass:178.49, phase:'Solid',
        density:'13.31 g/cm¬≥', meltingPoint:'2233 ¬∞C', boilingPoint:'4603 ¬∞C',
        discovered:'1923', discoverer:'Dirk Coster & George de Hevesy',
        uses:['Nuclear reactor control rods','Superalloys','Plasma cutting','Microprocessors'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440586'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Hafnium'}],
        description:'Excellent neutron absorber. Used in nuclear control rods and Intel processors.' },
      { symbol:'Ta', name:'Tantalum', number:73, category:'transition-metal', mass:180.948, phase:'Solid',
        density:'16.654 g/cm¬≥', meltingPoint:'3017 ¬∞C', boilingPoint:'5458 ¬∞C',
        discovered:'1802', discoverer:'Anders Gustaf Ekeberg',
        uses:['Capacitors','Surgical implants','Jet engines','Chemical equipment'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440257'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Tantalum'}],
        description:'Highly corrosion-resistant. Essential for capacitors in smartphones.' },
      { symbol:'W', name:'Tungsten', number:74, category:'transition-metal', mass:183.84, phase:'Solid',
        density:'19.25 g/cm¬≥', meltingPoint:'3422 ¬∞C', boilingPoint:'5555 ¬∞C',
        discovered:'1783', discoverer:'Juan Jos√© Elhuyar & Fausto Elhuyar',
        uses:['Light bulb filaments','Cutting tools','Ammunition','Heating elements'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440337'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Tungsten'}],
        description:'Highest melting point of all elements. Extremely hard and dense.' },
      { symbol:'Re', name:'Rhenium', number:75, category:'transition-metal', mass:186.207, phase:'Solid',
        density:'21.02 g/cm¬≥', meltingPoint:'3186 ¬∞C', boilingPoint:'5596 ¬∞C',
        discovered:'1925', discoverer:'Masataka Ogawa (claimed), Walter Noddack, Ida Tacke & Otto Berg',
        uses:['Jet engine superalloys','Catalysts','Thermocouples','Filaments'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440155'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Rhenium'}],
        description:'One of the rarest elements. Critical for jet engine superalloys.' },
      { symbol:'Os', name:'Osmium', number:76, category:'transition-metal', mass:190.23, phase:'Solid',
        density:'22.587 g/cm¬≥', meltingPoint:'3033 ¬∞C', boilingPoint:'5012 ¬∞C',
        discovered:'1803', discoverer:'Smithson Tennant',
        uses:['Fountain pen tips','Electrical contacts','Fingerprint detection','Catalysts'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440044'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Osmium'}],
        description:'Densest naturally occurring element. Has a distinctive pungent odor.' },
      { symbol:'Ir', name:'Iridium', number:77, category:'transition-metal', mass:192.217, phase:'Solid',
        density:'22.56 g/cm¬≥', meltingPoint:'2466 ¬∞C', boilingPoint:'4428 ¬∞C',
        discovered:'1803', discoverer:'Smithson Tennant',
        uses:['Spark plugs','Crucibles','Fountain pen nibs','Kilogram standard'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439885'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Iridium'}],
        description:'Most corrosion-resistant metal. K-T extinction asteroid marker.' },
      { symbol:'Pt', name:'Platinum', number:78, category:'transition-metal', mass:195.084, phase:'Solid',
        density:'21.45 g/cm¬≥', meltingPoint:'1768.3 ¬∞C', boilingPoint:'3825 ¬∞C',
        discovered:'1735', discoverer:'Antonio de Ulloa',
        uses:['Catalytic converters','Jewelry','Chemotherapy','Fuel cells'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440064'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Platinum'}],
        description:'Precious metal. Critical for catalytic converters and cancer treatment drugs.' },
      { symbol:'Hg', name:'Mercury', number:80, category:'transition-metal', mass:200.592, phase:'Liquid',
        density:'13.534 g/cm¬≥', meltingPoint:'-38.83 ¬∞C', boilingPoint:'356.73 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Thermometers','Fluorescent lamps','Dental amalgams','Barometers'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439976'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Mercury'}],
        description:'Only metal that is liquid at room temperature. Toxic heavy metal.' },
      { symbol:'Tl', name:'Thallium', number:81, category:'post-transition-metal', mass:204.38, phase:'Solid',
        density:'11.85 g/cm¬≥', meltingPoint:'304 ¬∞C', boilingPoint:'1473 ¬∞C',
        discovered:'1861', discoverer:'William Crookes',
        uses:['Electronics','Infrared optics','Rat poison (historic)','Medical imaging'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440280'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Thallium'}],
        description:'Highly toxic heavy metal. Used in infrared optics and electronics.' },
      { symbol:'Pb', name:'Lead', number:82, category:'post-transition-metal', mass:207.2, phase:'Solid',
        density:'11.34 g/cm¬≥', meltingPoint:'327.46 ¬∞C', boilingPoint:'1749 ¬∞C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Batteries','Radiation shielding','Ammunition','Weights'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439921'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Lead'}],
        description:'Dense, soft, toxic metal. Primary use in lead-acid batteries.' },
      { symbol:'Bi', name:'Bismuth', number:83, category:'post-transition-metal', mass:208.980, phase:'Solid',
        density:'9.807 g/cm¬≥', meltingPoint:'271.5 ¬∞C', boilingPoint:'1564 ¬∞C',
        discovered:'1753', discoverer:'Claude Fran√ßois Geoffroy',
        uses:['Pepto-Bismol','Cosmetics','Lead-free solder','Fire sprinkler alloys'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440699'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Bismuth'}],
        description:'Least toxic heavy metal. Forms beautiful rainbow-colored oxide crystals.' },
      { symbol:'Po', name:'Polonium', number:84, category:'post-transition-metal', mass:209, phase:'Solid',
        density:'9.32 g/cm¬≥', meltingPoint:'254 ¬∞C', boilingPoint:'962 ¬∞C',
        discovered:'1898', discoverer:'Marie & Pierre Curie',
        uses:['Static eliminators','Nuclear triggers','Heat source (space)','Research'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440086'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Polonium'}],
        description:'Extremely radioactive. Named after Poland by Marie Curie.' },
      { symbol:'At', name:'Astatine', number:85, category:'halogen', mass:210, phase:'Solid',
        density:'~7 g/cm¬≥ (est.)', meltingPoint:'302 ¬∞C', boilingPoint:'337 ¬∞C (est.)',
        discovered:'1940', discoverer:'Dale R. Corson, Kenneth Ross MacKenzie & Emilio Segr√®',
        uses:['Targeted cancer therapy (At-211)','Research'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440681'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Astatine'}],
        description:'Rarest naturally occurring element. Being researched for cancer radiotherapy.' },
      { symbol:'Rn', name:'Radon', number:86, category:'noble-gas', mass:222, phase:'Gas',
        density:'0.00973 g/cm¬≥', meltingPoint:'-71 ¬∞C', boilingPoint:'-61.7 ¬∞C',
        discovered:'1900', discoverer:'Friedrich Ernst Dorn',
        uses:['Cancer treatment (historic)','Earthquake prediction research','Radon testing'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C10043922'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Radon'}],
        description:'Radioactive noble gas. Second leading cause of lung cancer after smoking.' },
      { symbol:'Fr', name:'Francium', number:87, category:'alkali-metal', mass:223, phase:'Solid',
        density:'~1.87 g/cm¬≥ (est.)', meltingPoint:'27 ¬∞C (est.)', boilingPoint:'677 ¬∞C (est.)',
        discovered:'1939', discoverer:'Marguerite Perey',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440735'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Francium'}],
        description:'Most unstable naturally occurring element. Half-life of only 22 minutes.' },
      { symbol:'Ra', name:'Radium', number:88, category:'alkaline-earth', mass:226, phase:'Solid',
        density:'5.5 g/cm¬≥', meltingPoint:'696 ¬∞C', boilingPoint:'1500 ¬∞C',
        discovered:'1898', discoverer:'Marie & Pierre Curie',
        uses:['Cancer treatment (historic)','Luminous paint (historic)','Neutron source','Research'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440144'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Radium'}],
        description:'Intensely radioactive. Once used in glow-in-the-dark watch dials.' },
      { symbol:'Ac', name:'Actinium', number:89, category:'actinide', mass:227, phase:'Solid',
        density:'10.07 g/cm¬≥', meltingPoint:'1050 ¬∞C', boilingPoint:'3200 ¬∞C',
        discovered:'1899', discoverer:'Andr√©-Louis Debierne',
        uses:['Neutron source','Cancer treatment research','Thermoelectric generators'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440341'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Actinium'}],
        description:'First of the actinides. Glows pale blue in the dark due to radioactivity.' },
      { symbol:'Th', name:'Thorium', number:90, category:'actinide', mass:232.038, phase:'Solid',
        density:'11.72 g/cm¬≥', meltingPoint:'1750 ¬∞C', boilingPoint:'4788 ¬∞C',
        discovered:'1829', discoverer:'J√∂ns Jacob Berzelius',
        uses:['Nuclear fuel (potential)','Gas mantles','Welding electrodes','Optics'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440291'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Thorium'}],
        description:'Potential nuclear fuel more abundant than uranium. Named after Thor.' },
      { symbol:'Pa', name:'Protactinium', number:91, category:'actinide', mass:231.036, phase:'Solid',
        density:'15.37 g/cm¬≥', meltingPoint:'1572 ¬∞C', boilingPoint:'4000 ¬∞C',
        discovered:'1913', discoverer:'Kasimir Fajans & Oswald Helmuth G√∂hring',
        uses:['Research','Ocean sediment dating'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440133'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Protactinium'}],
        description:'Rare, toxic, radioactive actinide. One of the rarest natural elements.' },
      { symbol:'Np', name:'Neptunium', number:93, category:'actinide', mass:237, phase:'Solid',
        density:'20.45 g/cm¬≥', meltingPoint:'644 ¬∞C', boilingPoint:'3902 ¬∞C',
        discovered:'1940', discoverer:'Edwin McMillan & Philip H. Abelson',
        uses:['Neutron detection','Nuclear waste research','Precursor to Pu-238'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439998'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Neptunium'}],
        description:'First transuranium element. Named after the planet Neptune.' },
      { symbol:'Pu', name:'Plutonium', number:94, category:'actinide', mass:244, phase:'Solid',
        density:'19.816 g/cm¬≥', meltingPoint:'640 ¬∞C', boilingPoint:'3228 ¬∞C',
        discovered:'1940', discoverer:'Glenn T. Seaborg, Edwin McMillan, Joseph W. Kennedy & Arthur Wahl',
        uses:['Nuclear weapons','Nuclear power','Space probe RTGs','Research'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440075'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Plutonium'}],
        description:'Used in nuclear weapons and as fuel in space probes. Extremely toxic.' },
      { symbol:'Am', name:'Americium', number:95, category:'actinide', mass:243, phase:'Solid',
        density:'13.69 g/cm¬≥', meltingPoint:'1176 ¬∞C', boilingPoint:'2011 ¬∞C',
        discovered:'1944', discoverer:'Glenn T. Seaborg, Ralph A. James, Leon O. Morgan & Albert Ghiorso',
        uses:['Smoke detectors','Neutron sources','Research'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440352'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Americium'}],
        description:'Found in household smoke detectors. Named after the Americas.' },
      { symbol:'Cm', name:'Curium', number:96, category:'actinide', mass:247, phase:'Solid',
        density:'13.51 g/cm¬≥', meltingPoint:'1345 ¬∞C', boilingPoint:'3110 ¬∞C',
        discovered:'1944', discoverer:'Glenn T. Seaborg, Ralph A. James & Albert Ghiorso',
        uses:['Space probe power (RTGs)','Alpha particle source','Research'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440510'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Curium'}],
        description:'Named after Marie & Pierre Curie. Powers some Mars rovers.' },
      { symbol:'Bk', name:'Berkelium', number:97, category:'actinide', mass:247, phase:'Solid',
        density:'14.78 g/cm¬≥', meltingPoint:'986 ¬∞C', boilingPoint:'2627 ¬∞C',
        discovered:'1949', discoverer:'Glenn T. Seaborg, Stanley G. Thompson & Albert Ghiorso',
        uses:['Research','Target for heavier element synthesis'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440405'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Berkelium'}],
        description:'Named after Berkeley, California. Only produced in microgram quantities.' },
      { symbol:'Cf', name:'Californium', number:98, category:'actinide', mass:251, phase:'Solid',
        density:'15.1 g/cm¬≥', meltingPoint:'900 ¬∞C', boilingPoint:'1472 ¬∞C',
        discovered:'1950', discoverer:'Glenn T. Seaborg, Stanley G. Thompson, Albert Ghiorso & Kenneth Street Jr.',
        uses:['Neutron source','Mineral analysis','Nuclear reactor startup','Cancer treatment'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440717'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Californium'}],
        description:'Strong neutron emitter. Used to detect gold and water in oil wells.' },
      { symbol:'Es', name:'Einsteinium', number:99, category:'actinide', mass:252, phase:'Solid',
        density:'8.84 g/cm¬≥', meltingPoint:'860 ¬∞C', boilingPoint:'996 ¬∞C (est.)',
        discovered:'1952', discoverer:'Albert Ghiorso et al.',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7429926'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Einsteinium'}],
        description:'Named after Albert Einstein. Discovered in debris of first hydrogen bomb test.' },
      { symbol:'Fm', name:'Fermium', number:100, category:'actinide', mass:257, phase:'Solid',
        density:'~9.7 g/cm¬≥ (est.)', meltingPoint:'1527 ¬∞C (est.)', boilingPoint:'Unknown',
        discovered:'1952', discoverer:'Albert Ghiorso et al.',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440726'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Fermium'}],
        description:'Named after Enrico Fermi. Can only be produced in nuclear reactors.' },
      { symbol:'Md', name:'Mendelevium', number:101, category:'actinide', mass:258, phase:'Solid',
        density:'~10.3 g/cm¬≥ (est.)', meltingPoint:'827 ¬∞C (est.)', boilingPoint:'Unknown',
        discovered:'1955', discoverer:'Albert Ghiorso, Bernard G. Harvey, Gregory R. Choppin, Stanley G. Thompson & Glenn T. Seaborg',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440111'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Mendelevium'}],
        description:'Named after Dmitri Mendeleev. Only about 17 atoms produced at a time.' },
      { symbol:'No', name:'Nobelium', number:102, category:'actinide', mass:259, phase:'Solid',
        density:'~9.9 g/cm¬≥ (est.)', meltingPoint:'827 ¬∞C (est.)', boilingPoint:'Unknown',
        discovered:'1958', discoverer:'Albert Ghiorso, Torbj√∏rn Sikkeland, John R. Walton & Glenn T. Seaborg',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C10028148'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Nobelium'}],
        description:'Named after Alfred Nobel. Most stable isotope has half-life of 58 minutes.' },
      { symbol:'Lr', name:'Lawrencium', number:103, category:'actinide', mass:266, phase:'Solid',
        density:'~14.4 g/cm¬≥ (est.)', meltingPoint:'1627 ¬∞C (est.)', boilingPoint:'Unknown',
        discovered:'1961', discoverer:'Albert Ghiorso, Torbj√∏rn Sikkeland, Almon Larsh & Robert M. Latimer',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C22537191'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Lawrencium'}],
        description:'Last actinide. Named after Ernest O. Lawrence, inventor of the cyclotron.' },
      { symbol:'Rf', name:'Rutherfordium', number:104, category:'transition-metal', mass:267, phase:'Solid',
        density:'~23.2 g/cm¬≥ (est.)', meltingPoint:'~2100 ¬∞C (est.)', boilingPoint:'~5500 ¬∞C (est.)',
        discovered:'1964', discoverer:'Joint Institute for Nuclear Research (Dubna)',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C53850367'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Rutherfordium'}],
        description:'First transactinide. Named after Ernest Rutherford.' },
      { symbol:'Db', name:'Dubnium', number:105, category:'transition-metal', mass:268, phase:'Solid',
        density:'~29.3 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'Unknown',
        discovered:'1967', discoverer:'Joint Institute for Nuclear Research (Dubna)',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C53850423'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Dubnium'}],
        description:'Named after Dubna, Russia. Most stable isotope lasts about 28 hours.' },
      { symbol:'Sg', name:'Seaborgium', number:106, category:'transition-metal', mass:269, phase:'Solid',
        density:'~35 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'Unknown',
        discovered:'1974', discoverer:'Albert Ghiorso et al.',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54038818'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Seaborgium'}],
        description:'Named after Glenn T. Seaborg while he was still alive ‚Äî a first.' },
      { symbol:'Bh', name:'Bohrium', number:107, category:'transition-metal', mass:270, phase:'Solid',
        density:'~37.1 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'Unknown',
        discovered:'1981', discoverer:'Peter Armbruster & Gottfried M√ºnzenberg',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54037149'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Bohrium'}],
        description:'Named after Niels Bohr. Only a few atoms have ever been produced.' },
      { symbol:'Hs', name:'Hassium', number:108, category:'transition-metal', mass:277, phase:'Solid',
        density:'~40.7 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'Unknown',
        discovered:'1984', discoverer:'Peter Armbruster & Gottfried M√ºnzenberg',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54037577'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Hassium'}],
        description:'Named after Hesse, Germany. Behaves like osmium chemically.' },
      { symbol:'Mt', name:'Meitnerium', number:109, category:'transition-metal', mass:278, phase:'Solid',
        density:'~37.4 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'Unknown',
        discovered:'1982', discoverer:'Peter Armbruster & Gottfried M√ºnzenberg',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54038016'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Meitnerium'}],
        description:'Named after Lise Meitner, who helped discover nuclear fission.' },
      { symbol:'Ds', name:'Darmstadtium', number:110, category:'transition-metal', mass:281, phase:'Solid',
        density:'~34.8 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'Unknown',
        discovered:'1994', discoverer:'Sigurd Hofmann et al. (GSI Darmstadt)',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54083778'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Darmstadtium'}],
        description:'Named after Darmstadt, Germany. Extremely short-lived.' },
      { symbol:'Rg', name:'Roentgenium', number:111, category:'transition-metal', mass:282, phase:'Solid',
        density:'~28.7 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'Unknown',
        discovered:'1994', discoverer:'Sigurd Hofmann et al. (GSI Darmstadt)',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54386243'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Roentgenium'}],
        description:'Named after Wilhelm R√∂ntgen, discoverer of X-rays.' },
      { symbol:'Cn', name:'Copernicium', number:112, category:'transition-metal', mass:285, phase:'Liquid (predicted)',
        density:'~23.7 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'~84 ¬∞C (est.)',
        discovered:'1996', discoverer:'Sigurd Hofmann et al. (GSI Darmstadt)',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54084269'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Copernicium'}],
        description:'Named after Nicolaus Copernicus. May be liquid at room temperature.' },
      { symbol:'Nh', name:'Nihonium', number:113, category:'post-transition-metal', mass:286, phase:'Solid (predicted)',
        density:'~16 g/cm¬≥ (est.)', meltingPoint:'~430 ¬∞C (est.)', boilingPoint:'~1100 ¬∞C (est.)',
        discovered:'2003', discoverer:'RIKEN (Kosuke Morita et al.)',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C71759'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Nihonium'}],
        description:'First element discovered in Asia. Named after Japan (Nihon).' },
      { symbol:'Fl', name:'Flerovium', number:114, category:'post-transition-metal', mass:289, phase:'Solid (predicted)',
        density:'~14 g/cm¬≥ (est.)', meltingPoint:'~67 ¬∞C (est.)', boilingPoint:'~147 ¬∞C (est.)',
        discovered:'1998', discoverer:'Joint Institute for Nuclear Research (Dubna) & LLNL',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54085161'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Flerovium'}],
        description:'Named after Flerov Laboratory. May behave like a noble gas.' },
      { symbol:'Mc', name:'Moscovium', number:115, category:'post-transition-metal', mass:290, phase:'Solid (predicted)',
        density:'~13.5 g/cm¬≥ (est.)', meltingPoint:'~400 ¬∞C (est.)', boilingPoint:'~1100 ¬∞C (est.)',
        discovered:'2003', discoverer:'Joint Institute for Nuclear Research (Dubna) & LLNL',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C71750'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Moscovium'}],
        description:'Named after Moscow Oblast. Superheavy element with very short half-life.' },
      { symbol:'Lv', name:'Livermorium', number:116, category:'post-transition-metal', mass:293, phase:'Solid (predicted)',
        density:'~12.9 g/cm¬≥ (est.)', meltingPoint:'~364 ¬∞C (est.)', boilingPoint:'~762 ¬∞C (est.)',
        discovered:'2000', discoverer:'Joint Institute for Nuclear Research (Dubna) & LLNL',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54100710'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Livermorium'}],
        description:'Named after Lawrence Livermore National Laboratory.' },
      { symbol:'Ts', name:'Tennessine', number:117, category:'halogen', mass:294, phase:'Solid (predicted)',
        density:'~7.2 g/cm¬≥ (est.)', meltingPoint:'~350 ¬∞C (est.)', boilingPoint:'~610 ¬∞C (est.)',
        discovered:'2010', discoverer:'Joint Institute for Nuclear Research (Dubna) & ORNL',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C87658'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Tennessine'}],
        description:'Named after Tennessee. Second heaviest known halogen.' },
      { symbol:'Og', name:'Oganesson', number:118, category:'noble-gas', mass:294, phase:'Solid (predicted)',
        density:'~5.0 g/cm¬≥ (est.)', meltingPoint:'Unknown', boilingPoint:'~80 ¬∞C (est.)',
        discovered:'2002', discoverer:'Joint Institute for Nuclear Research (Dubna) & LLNL',
        uses:['Research only'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C54144196'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Oganesson'}],
        description:'Heaviest known element. Named after Yuri Oganessian. May be solid, not gas.' },
    ];

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // WORLD PRODUCTION DATA (USGS 2024 / World Bank 2024)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ELEMENT_WORLD_DATA = {
      H:  { production:{annual:'100 million tonnes',unit:'tonnes/yr'}, reserves:{amount:'Virtually unlimited (water)',yearsSupply:null}, topProducers:['China','USA','EU','Middle East'], price:{amount:1500,unit:'$/tonne',year:2024}, primaryUses:['Ammonia/fertilizer (55%)','Oil refining (25%)','Methanol (10%)','Fuel cells'] },
      He: { production:{annual:'160 million m¬≥',unit:'m¬≥/yr'}, reserves:{amount:'31.3 billion m¬≥',yearsSupply:195}, topProducers:['USA','Qatar','Algeria','Russia','Poland'], price:{amount:35,unit:'$/m¬≥',year:2024}, primaryUses:['Cryogenics/MRI (30%)','Welding (17%)','Leak detection','Balloons'] },
      Li: { production:{annual:'130,000 tonnes',unit:'tonnes/yr'}, reserves:{amount:'28 million tonnes',yearsSupply:215}, topProducers:['Australia','Chile','China','Argentina'], price:{amount:17000,unit:'$/tonne',year:2024}, primaryUses:['Batteries (80%)','Ceramics/glass (7%)','Lubricant grease','Pharmaceuticals'] },
      Be: { production:{annual:'260 tonnes',unit:'tonnes/yr'}, reserves:{amount:'Undisclosed',yearsSupply:null}, topProducers:['USA','China','Mozambique','Brazil'], price:{amount:857000,unit:'$/tonne',year:2024}, primaryUses:['Aerospace alloys','Electronics','X-ray windows','Nuclear reactors'] },
      B:  { production:{annual:'4.4 million tonnes (boron oxide)',unit:'tonnes/yr'}, reserves:{amount:'1.2 billion tonnes',yearsSupply:270}, topProducers:['Turkey (68%)','USA','Chile','Russia'], price:{amount:450,unit:'$/tonne (boric acid)',year:2024}, primaryUses:['Glass/fiberglass (46%)','Detergents (12%)','Agriculture','Ceramics'] },
      C:  { production:{annual:'130 million carats industrial diamond; 1.1B tonnes coal',unit:'mixed'}, reserves:{amount:'1.07 trillion tonnes coal',yearsSupply:139}, topProducers:['China','India','Indonesia','USA','Australia'], price:{amount:null,unit:'varies widely',year:2024}, primaryUses:['Steel production','Fuels','Plastics/chemicals','Diamond tools'] },
      N:  { production:{annual:'150 million tonnes (as fertilizer N)',unit:'tonnes/yr'}, reserves:{amount:'Unlimited (78% of atmosphere)',yearsSupply:null}, topProducers:['China','India','USA','EU','Russia'], price:{amount:400,unit:'$/tonne (ammonia)',year:2024}, primaryUses:['Fertilizer (80%)','Explosives','Nylon/plastics','Cryogenics'] },
      O:  { production:{annual:'360 million tonnes',unit:'tonnes/yr'}, reserves:{amount:'Unlimited (atmosphere + water)',yearsSupply:null}, topProducers:['China','USA','EU','India','Japan'], price:{amount:100,unit:'$/tonne (liquid)',year:2024}, primaryUses:['Steel manufacturing (55%)','Medical','Welding','Chemical synthesis'] },
      F:  { production:{annual:'8.3 million tonnes (fluorspar)',unit:'tonnes/yr'}, reserves:{amount:'310 million tonnes',yearsSupply:37}, topProducers:['China (64%)','Mexico','Mongolia','South Africa'], price:{amount:560,unit:'$/tonne (fluorspar)',year:2024}, primaryUses:['Aluminum smelting','Refrigerants/PTFE','Uranium enrichment','Toothpaste'] },
      Ne: { production:{note:'Byproduct of air separation ‚Äî ~70,000 tonnes/yr'}, topProducers:['Ukraine','China','USA','Japan'], price:{amount:120,unit:'$/m¬≥',year:2024}, primaryUses:['Semiconductor lithography','Neon signs','Lasers','Cryogenics'] },
      Na: { production:{annual:'280 million tonnes (as NaCl salt)',unit:'tonnes/yr'}, reserves:{amount:'Virtually unlimited',yearsSupply:null}, topProducers:['China','USA','India','Germany','Australia'], price:{amount:40,unit:'$/tonne (salt)',year:2024}, primaryUses:['Food/seasoning (35%)','Chemical industry (35%)','De-icing','Water treatment'] },
      Mg: { production:{annual:'1.1 million tonnes',unit:'tonnes/yr'}, reserves:{amount:'Virtually unlimited (seawater)',yearsSupply:null}, topProducers:['China (90%)','USA','Israel','Brazil','Turkey'], price:{amount:2800,unit:'$/tonne',year:2024}, primaryUses:['Aluminum alloys (42%)','Die casting','Steel desulfurization','Aerospace'] },
      Al: { production:{annual:'69 million tonnes',unit:'tonnes/yr'}, reserves:{amount:'55-75 billion tonnes (bauxite)',yearsSupply:100}, topProducers:['China (57%)','India','Russia','Canada','UAE'], price:{amount:2400,unit:'$/tonne',year:2024}, primaryUses:['Transportation (27%)','Packaging (20%)','Construction (20%)','Electrical'] },
      Si: { production:{annual:'8.8 million tonnes',unit:'tonnes/yr'}, reserves:{amount:'Abundant (28% of crust)',yearsSupply:null}, topProducers:['China (70%)','Russia','Brazil','Norway','France'], price:{amount:2500,unit:'$/tonne',year:2024}, primaryUses:['Aluminum alloys (40%)','Silicones (30%)','Semiconductors','Solar cells'] },
      P:  { production:{annual:'220 million tonnes (phosphate rock)',unit:'tonnes/yr'}, reserves:{amount:'72 billion tonnes',yearsSupply:327}, topProducers:['China (40%)','Morocco','USA','Russia','Brazil'], price:{amount:100,unit:'$/tonne (rock)',year:2024}, primaryUses:['Fertilizer (85%)','Animal feed','Detergents','Food additives'] },
      S:  { production:{annual:'80 million tonnes',unit:'tonnes/yr'}, reserves:{amount:'Abundant (byproduct)',yearsSupply:null}, topProducers:['China','USA','Russia','Canada','Saudi Arabia'], price:{amount:80,unit:'$/tonne',year:2024}, primaryUses:['Sulfuric acid (60%)','Fertilizer','Rubber vulcanization','Chemicals'] },
      Cl: { production:{annual:'75 million tonnes',unit:'tonnes/yr'}, reserves:{amount:'Virtually unlimited (sea salt)',yearsSupply:null}, topProducers:['China','USA','EU','India','Japan'], price:{amount:200,unit:'$/tonne',year:2024}, primaryUses:['PVC (35%)','Water treatment','Solvents','Bleach/disinfection'] },
      Ar: { production:{annual:'700,000 tonnes',unit:'tonnes/yr'}, reserves:{amount:'Unlimited (0.93% of atmosphere)',yearsSupply:null}, topProducers:['China','USA','EU','Japan','India'], price:{amount:3,unit:'$/m¬≥',year:2024}, primaryUses:['Welding shield gas (55%)','Lighting','Insulated windows','Semiconductor fab'] },
      K:  { production:{annual:'45 million tonnes (K‚ÇÇO equiv)',unit:'tonnes/yr'}, reserves:{amount:'3.7 billion tonnes',yearsSupply:82}, topProducers:['Canada (30%)','Russia','Belarus','China','Germany'], price:{amount:300,unit:'$/tonne (KCl)',year:2024}, primaryUses:['Fertilizer (95%)','Soap/glass','Salt substitutes','Industrial chemicals'] },
      Ca: { production:{annual:'350 million tonnes (as lime/limestone)',unit:'tonnes/yr'}, reserves:{amount:'Virtually unlimited',yearsSupply:null}, topProducers:['China','USA','India','Russia','Japan'], price:{amount:100,unit:'$/tonne (lime)',year:2024}, primaryUses:['Cement (70%)','Steel flux','Agriculture','Water treatment'] },
      Sc: { production:{annual:'15-20 tonnes',unit:'tonnes/yr'}, reserves:{amount:'Unknown (scattered deposits)',yearsSupply:null}, topProducers:['China','Russia','Philippines','Ukraine'], price:{amount:3600,unit:'$/kg',year:2024}, primaryUses:['Aluminum-scandium alloys','Solid oxide fuel cells','Sports equipment','Lighting'] },
      Ti: { production:{annual:'7.5 million tonnes (TiO‚ÇÇ concentrate)',unit:'tonnes/yr'}, reserves:{amount:'700 million tonnes',yearsSupply:93}, topProducers:['China','Mozambique','South Africa','Australia','Canada'], price:{amount:11000,unit:'$/tonne (sponge)',year:2024}, primaryUses:['Pigments/TiO‚ÇÇ (93%)','Aerospace metal (4%)','Medical implants','Welding rod coatings'] },
      V:  { production:{annual:'110,000 tonnes',unit:'tonnes/yr'}, reserves:{amount:'24 million tonnes',yearsSupply:218}, topProducers:['China (66%)','Russia','South Africa','Brazil'], price:{amount:28,unit:'$/kg',year:2024}, primaryUses:['Steel alloys (85%)','Titanium alloys','Vanadium redox batteries','Catalysts'] },
      Cr: { production:{annual:'41 million tonnes (ore)',unit:'tonnes/yr'}, reserves:{amount:'570 million tonnes',yearsSupply:14}, topProducers:['South Africa (44%)','Turkey','Kazakhstan','India','Finland'], price:{amount:10000,unit:'$/tonne (ferrochromium)',year:2024}, primaryUses:['Stainless steel (70%)','Chrome plating','Pigments','Refractories'] },
      Mn: { production:{annual:'20 million tonnes (ore)',unit:'tonnes/yr'}, reserves:{amount:'1.7 billion tonnes',yearsSupply:85}, topProducers:['South Africa (37%)','Gabon','Australia','Ghana','China'], price:{amount:1500,unit:'$/tonne (ore)',year:2024}, primaryUses:['Steel production (90%)','Batteries','Aluminum alloys','Chemicals'] },
      Fe: { production:{annual:'2.5 billion tonnes (ore)',unit:'tonnes/yr'}, reserves:{amount:'170 billion tonnes',yearsSupply:68}, topProducers:['Australia','Brazil','China','India','Russia'], price:{amount:120,unit:'$/tonne',year:2024}, primaryUses:['Steel production (98%)','Cast iron','Magnets','Pigments'] },
      Co: { production:{annual:'190,000 tonnes',unit:'tonnes/yr'}, reserves:{amount:'8.3 million tonnes',yearsSupply:44}, topProducers:['DRC (73%)','Indonesia','Russia','Australia','Philippines'], price:{amount:30000,unit:'$/tonne',year:2024}, primaryUses:['Batteries (46%)','Superalloys (19%)','Catalysts','Magnets/pigments'] },
      Ni: { production:{annual:'3.6 million tonnes',unit:'tonnes/yr'}, reserves:{amount:'110 million tonnes',yearsSupply:31}, topProducers:['Indonesia (49%)','Philippines','Russia','New Caledonia','Australia'], price:{amount:16000,unit:'$/tonne',year:2024}, primaryUses:['Stainless steel (65%)','Batteries (15%)','Alloys','Plating'] },
      Cu: { production:{annual:'22 million tonnes',unit:'tonnes/yr'}, reserves:{amount:'890 million tonnes',yearsSupply:40}, topProducers:['Chile (24%)','DRC','Peru','China','Indonesia'], price:{amount:8500,unit:'$/tonne',year:2024}, primaryUses:['Electrical wire (60%)','Construction (20%)','Transportation','Electronics'] },
      Zn: { production:{annual:'13 million tonnes',unit:'tonnes/yr'}, reserves:{amount:'210 million tonnes',yearsSupply:16}, topProducers:['China (33%)','Australia','Peru','India','USA'], price:{amount:2700,unit:'$/tonne',year:2024}, primaryUses:['Galvanizing (50%)','Alloys/brass (17%)','Chemicals','Batteries'] },
      Ga: { production:{annual:'550 tonnes',unit:'tonnes/yr'}, reserves:{amount:'110,000 tonnes',yearsSupply:200}, topProducers:['China (98%)','Japan','South Korea','Russia'], price:{amount:300,unit:'$/kg',year:2024}, primaryUses:['Integrated circuits (43%)','LEDs/optoelectronics (40%)','Solar cells','Research'] },
      Ge: { production:{annual:'140 tonnes',unit:'tonnes/yr'}, reserves:{amount:'8,600 tonnes',yearsSupply:61}, topProducers:['China (68%)','Russia','USA','Belgium'], price:{amount:1800,unit:'$/kg',year:2024}, primaryUses:['Fiber optics (35%)','Infrared optics (25%)','PET catalysts','Solar cells'] },
      As: { production:{annual:'35,000 tonnes (arsenic trioxide)',unit:'tonnes/yr'}, reserves:{amount:'Moderate',yearsSupply:null}, topProducers:['China (50%)','Morocco','Russia','Belgium'], price:{amount:1,unit:'$/kg (trioxide)',year:2024}, primaryUses:['Wood preservatives (50%)','Semiconductors (GaAs)','Lead alloys','Pesticides'] },
      Se: { production:{annual:'2,800 tonnes',unit:'tonnes/yr'}, reserves:{amount:'100,000 tonnes',yearsSupply:36}, topProducers:['China','Japan','Belgium','Germany','Russia'], price:{amount:55,unit:'$/kg',year:2024}, primaryUses:['Glass manufacturing (30%)','Electronics','Solar cells (CdTe)','Metallurgy'] },
      Br: { production:{annual:'500,000 tonnes',unit:'tonnes/yr'}, reserves:{amount:'Abundant (seawater)',yearsSupply:null}, topProducers:['China','USA','Israel','Jordan'], price:{amount:2,unit:'$/kg',year:2024}, primaryUses:['Flame retardants (50%)','Drilling fluids','Pesticides','Pharmaceuticals'] },
      Kr: { production:{note:'Byproduct of air separation ‚Äî ~10 tonnes/yr'}, topProducers:['USA','EU','Japan','China'], price:{amount:500,unit:'$/m¬≥',year:2024}, primaryUses:['Insulated windows','Photography flash','Fluorescent lighting','Lasers'] },
      Rb: { production:{note:'No dedicated mining ‚Äî byproduct of lithium/cesium production'}, topProducers:['Canada','Namibia','Zambia'], price:{amount:12000,unit:'$/kg',year:2024}, primaryUses:['Atomic clocks','Photocells','Specialty glass','Medical imaging'] },
      Sr: { production:{annual:'210,000 tonnes',unit:'tonnes/yr'}, reserves:{amount:'6.8 million tonnes',yearsSupply:32}, topProducers:['Spain','Mexico','China','Iran','Turkey'], price:{amount:700,unit:'$/tonne (celestite)',year:2024}, primaryUses:['Ferrite magnets (55%)','Pyrotechnics','Zinc smelting','Drilling fluids'] },
      Y:  { production:{annual:'8,000 tonnes',unit:'tonnes/yr'}, reserves:{amount:'540,000 tonnes',yearsSupply:68}, topProducers:['China (93%)','Australia','Myanmar','India'], price:{amount:12,unit:'$/kg (oxide)',year:2024}, primaryUses:['Ceramics/phosphors','Superconductors','Lasers','Alloy additive'] },
      Zr: { production:{annual:'1.4 million tonnes (zircon)',unit:'tonnes/yr'}, reserves:{amount:'67 million tonnes',yearsSupply:48}, topProducers:['Australia','South Africa','Mozambique','China','Indonesia'], price:{amount:2200,unit:'$/tonne (zircon)',year:2024}, primaryUses:['Ceramics (54%)','Nuclear fuel cladding','Refractories','Foundry sands'] },
      Nb: { production:{annual:'81,000 tonnes',unit:'tonnes/yr'}, reserves:{amount:'17 million tonnes',yearsSupply:210}, topProducers:['Brazil (90%)','Canada','Australia','DRC'], price:{amount:42,unit:'$/kg',year:2024}, primaryUses:['HSLA steel (85%)','Superconducting magnets','Superalloys','Jewelry'] },
      Mo: { production:{annual:'300,000 tonnes',unit:'tonnes/yr'}, reserves:{amount:'18 million tonnes',yearsSupply:60}, topProducers:['China (44%)','Chile','USA','Peru','Mexico'], price:{amount:45,unit:'$/kg',year:2024}, primaryUses:['Steel alloys (70%)','Catalysts','Lubricants','Chemicals'] },
      Tc: { production:{note:'Synthetic ‚Äî produced in nuclear reactors, ~150 kg/yr for medical use'}, primaryUses:['Medical imaging (Tc-99m)','Industrial radiography'] },
      Ru: { production:{annual:'38 tonnes',unit:'tonnes/yr'}, reserves:{amount:'5,000 tonnes',yearsSupply:132}, topProducers:['South Africa (93%)','Zimbabwe','Russia','Canada'], price:{amount:14000,unit:'$/kg',year:2024}, primaryUses:['Electronics (42%)','Catalysts','Wear-resistant coatings','Electrochemistry'] },
      Rh: { production:{annual:'32 tonnes',unit:'tonnes/yr'}, reserves:{amount:'3,000 tonnes',yearsSupply:94}, topProducers:['South Africa (81%)','Russia','Zimbabwe','Canada'], price:{amount:145000,unit:'$/kg',year:2024}, primaryUses:['Catalytic converters (80%)','Chemical catalysts','Jewelry','Glass production'] },
      Pd: { production:{annual:'210 tonnes',unit:'tonnes/yr'}, reserves:{amount:'9,000 tonnes',yearsSupply:43}, topProducers:['Russia (40%)','South Africa (36%)','Canada','USA','Zimbabwe'], price:{amount:35000,unit:'$/kg',year:2024}, primaryUses:['Catalytic converters (80%)','Electronics','Dentistry','Hydrogen purification'] },
      Ag: { production:{annual:'26,000 tonnes',unit:'tonnes/yr'}, reserves:{amount:'530,000 tonnes',yearsSupply:20}, topProducers:['Mexico','China','Peru','Chile','Poland'], price:{amount:800,unit:'$/kg',year:2024}, primaryUses:['Electronics (30%)','Solar panels (17%)','Jewelry/silverware','Photography'] },
      Cd: { production:{annual:'23,000 tonnes',unit:'tonnes/yr'}, reserves:{amount:'500,000 tonnes',yearsSupply:22}, topProducers:['China (36%)','South Korea','Japan','Canada','Kazakhstan'], price:{amount:3,unit:'$/kg',year:2024}, primaryUses:['NiCd batteries (72%)','Pigments','Coatings','Solar cells (CdTe)'] },
      In: { production:{annual:'920 tonnes',unit:'tonnes/yr'}, reserves:{amount:'18,000 tonnes',yearsSupply:20}, topProducers:['China (56%)','South Korea','Japan','Canada','France'], price:{amount:280,unit:'$/kg',year:2024}, primaryUses:['ITO for displays (56%)','Solders','Semiconductors','Photovoltaics'] },
      Sn: { production:{annual:'310,000 tonnes',unit:'tonnes/yr'}, reserves:{amount:'4.6 million tonnes',yearsSupply:15}, topProducers:['China (30%)','Indonesia','Myanmar','Peru','DRC'], price:{amount:25000,unit:'$/tonne',year:2024}, primaryUses:['Solder (48%)','Tin plating (14%)','Chemicals','Alloys (bronze/pewter)'] },
      Sb: { production:{annual:'160,000 tonnes',unit:'tonnes/yr'}, reserves:{amount:'1.8 million tonnes',yearsSupply:11}, topProducers:['China (55%)','Tajikistan','Russia','Myanmar','Bolivia'], price:{amount:12,unit:'$/kg',year:2024}, primaryUses:['Flame retardants (60%)','Lead-acid batteries','Plastics catalysts','Ammunition'] },
      Te: { production:{annual:'580 tonnes',unit:'tonnes/yr'}, reserves:{amount:'31,000 tonnes',yearsSupply:53}, topProducers:['China','Japan','Canada','Sweden','USA'], price:{amount:70,unit:'$/kg',year:2024}, primaryUses:['Solar cells CdTe (40%)','Thermoelectrics','Steel/copper alloys','Rubber vulcanization'] },
      I:  { production:{annual:'32,000 tonnes',unit:'tonnes/yr'}, reserves:{amount:'6 million tonnes',yearsSupply:188}, topProducers:['Chile (57%)','Japan (25%)','USA','Russia','Turkmenistan'], price:{amount:35,unit:'$/kg',year:2024}, primaryUses:['X-ray contrast media','Biocides','Nylon production','Pharmaceuticals'] },
      Xe: { production:{note:'Byproduct of air separation ‚Äî ~40 tonnes/yr'}, topProducers:['USA','EU','Japan','China'], price:{amount:3000,unit:'$/m¬≥',year:2024}, primaryUses:['Anesthesia','Ion propulsion','Lighting','Medical imaging'] },
      Cs: { production:{annual:'30 tonnes',unit:'tonnes/yr'}, reserves:{amount:'170,000 tonnes',yearsSupply:5667}, topProducers:['Australia','Canada','Zimbabwe','Namibia'], price:{amount:78000,unit:'$/kg',year:2024}, primaryUses:['Drilling fluids (50%)','Atomic clocks','Photoelectric cells','Cancer treatment'] },
      Ba: { production:{annual:'7.5 million tonnes (barite)',unit:'tonnes/yr'}, reserves:{amount:'300 million tonnes',yearsSupply:40}, topProducers:['China (40%)','India','Morocco','Mexico','Turkey'], price:{amount:160,unit:'$/tonne (barite)',year:2024}, primaryUses:['Oil drilling fluids (80%)','Medical imaging','Rubber filler','Glass'] },
      La: { production:{note:'Included in rare earth totals ‚Äî ~60,000 tonnes/yr as oxide'}, topProducers:['China (70%)','Myanmar','Australia','USA'], primaryUses:['Fluid catalytic cracking (30%)','Battery alloys','Optical glass','Hybrid car batteries'] },
      Ce: { production:{note:'Most abundant rare earth ‚Äî ~80,000 tonnes/yr as oxide'}, topProducers:['China (70%)','Myanmar','Australia','USA'], primaryUses:['Catalytic converters','Glass polishing','Self-cleaning ovens','Metallurgy'] },
      Pr: { production:{note:'Rare earth ‚Äî ~10,000 tonnes/yr as oxide'}, topProducers:['China (70%)','Myanmar','Australia'], primaryUses:['NdFeB magnets (co-constituent)','Aircraft engines','Ceramics','Glass colorant'] },
      Nd: { production:{note:'Rare earth ‚Äî ~40,000 tonnes/yr as oxide'}, topProducers:['China (70%)','Myanmar','Australia','USA'], price:{amount:80,unit:'$/kg (oxide)',year:2024}, primaryUses:['NdFeB permanent magnets (87%)','Lasers','Glass colorant','Capacitors'] },
      Pm: { production:{note:'Synthetic ‚Äî trace amounts from nuclear reactors'}, primaryUses:['Nuclear batteries','Research','Luminous paint'] },
      Sm: { production:{note:'Rare earth ‚Äî ~2,000 tonnes/yr'}, topProducers:['China','Myanmar','Australia'], price:{amount:4,unit:'$/kg (oxide)',year:2024}, primaryUses:['Samarium-cobalt magnets','Cancer treatment','Nuclear control rods','Catalysts'] },
      Eu: { production:{note:'Rare earth ‚Äî ~400 tonnes/yr'}, topProducers:['China (90%)','Myanmar'], price:{amount:30,unit:'$/kg (oxide)',year:2024}, primaryUses:['Red phosphors/LEDs','Euro banknote security','Fluorescent lamps','Nuclear control rods'] },
      Gd: { production:{note:'Rare earth ‚Äî ~4,000 tonnes/yr'}, topProducers:['China','Myanmar','Australia'], price:{amount:35,unit:'$/kg (oxide)',year:2024}, primaryUses:['MRI contrast agents','Neutron shielding','Magnets','Phosphors'] },
      Tb: { production:{note:'Rare earth ‚Äî ~400 tonnes/yr'}, topProducers:['China (90%)','Myanmar'], price:{amount:1200,unit:'$/kg (oxide)',year:2024}, primaryUses:['NdFeB magnet additive','Green phosphors','Sonar','Fuel cells'] },
      Dy: { production:{note:'Rare earth ‚Äî ~2,500 tonnes/yr'}, topProducers:['China (85%)','Myanmar','Australia'], price:{amount:300,unit:'$/kg (oxide)',year:2024}, primaryUses:['NdFeB magnet additive (98%)','Lasers','Nuclear control rods','Lighting'] },
      Ho: { production:{note:'Rare earth ‚Äî ~50 tonnes/yr'}, topProducers:['China','Myanmar'], primaryUses:['Magnets','Medical lasers','Nuclear reactors','Spectrophotometry'] },
      Er: { production:{note:'Rare earth ‚Äî ~800 tonnes/yr'}, topProducers:['China','Myanmar','Australia'], primaryUses:['Fiber optic amplifiers','Lasers','Nuclear','Glass colorant (pink)'] },
      Tm: { production:{note:'Rare earth ‚Äî ~15 tonnes/yr (rarest commercial)'}, topProducers:['China'], primaryUses:['Portable X-ray machines','Lasers','Research'] },
      Yb: { production:{note:'Rare earth ‚Äî ~50 tonnes/yr'}, topProducers:['China','Myanmar'], primaryUses:['Fiber optic amplifiers','Atomic clocks','Lasers','Stress gauges'] },
      Lu: { production:{note:'Rare earth ‚Äî ~10 tonnes/yr'}, topProducers:['China'], price:{amount:900,unit:'$/kg (oxide)',year:2024}, primaryUses:['PET scan detectors','Oil refining catalysts','LED phosphors','Research'] },
      Hf: { production:{annual:'70 tonnes',unit:'tonnes/yr'}, reserves:{amount:'Included with zirconium',yearsSupply:null}, topProducers:['France','USA','Ukraine','Russia'], price:{amount:1200,unit:'$/kg',year:2024}, primaryUses:['Nuclear reactor control rods (47%)','Superalloys','Plasma cutting','Microprocessors'] },
      Ta: { production:{annual:'1,800 tonnes',unit:'tonnes/yr'}, reserves:{amount:'140,000 tonnes',yearsSupply:78}, topProducers:['DRC (37%)','Brazil','Rwanda','Nigeria','China'], price:{amount:190,unit:'$/kg',year:2024}, primaryUses:['Capacitors (60%)','Superalloys','Surgical implants','Chemical equipment'] },
      W:  { production:{annual:'84,000 tonnes',unit:'tonnes/yr'}, reserves:{amount:'3.7 million tonnes',yearsSupply:44}, topProducers:['China (82%)','Vietnam','Russia','Bolivia','Austria'], price:{amount:35,unit:'$/kg',year:2024}, primaryUses:['Cemented carbide tools (60%)','Steel alloys','Mill products','Chemicals'] },
      Re: { production:{annual:'56 tonnes',unit:'tonnes/yr'}, reserves:{amount:'2,500 tonnes',yearsSupply:45}, topProducers:['Chile','USA','Poland','Uzbekistan','Kazakhstan'], price:{amount:1600,unit:'$/kg',year:2024}, primaryUses:['Jet engine superalloys (80%)','Catalysts','Thermocouples','Filaments'] },
      Os: { production:{note:'PGM byproduct ‚Äî ~1 tonne/yr'}, topProducers:['South Africa','Russia'], price:{amount:12000,unit:'$/kg',year:2024}, primaryUses:['Fountain pen tips','Electrical contacts','Catalysts','Fingerprint detection'] },
      Ir: { production:{annual:'7.5 tonnes',unit:'tonnes/yr'}, reserves:{amount:'Included with PGMs',yearsSupply:null}, topProducers:['South Africa (85%)','Russia','Zimbabwe'], price:{amount:160000,unit:'$/kg',year:2024}, primaryUses:['Spark plugs','Crucibles','Electrochemistry','Fountain pen nibs'] },
      Pt: { production:{annual:'190 tonnes',unit:'tonnes/yr'}, reserves:{amount:'13,000 tonnes',yearsSupply:68}, topProducers:['South Africa (72%)','Russia','Zimbabwe','Canada','USA'], price:{amount:30000,unit:'$/kg',year:2024}, primaryUses:['Catalytic converters (40%)','Jewelry (30%)','Industrial catalysts','Fuel cells'] },
      Au: { production:{annual:'3,300 tonnes',unit:'tonnes/yr'}, reserves:{amount:'59,000 tonnes',yearsSupply:18}, topProducers:['China','Australia','Russia','Canada','USA'], price:{amount:65000,unit:'$/kg',year:2024}, primaryUses:['Jewelry (50%)','Investment/central banks (25%)','Electronics (10%)','Dentistry'] },
      Hg: { production:{annual:'3,700 tonnes',unit:'tonnes/yr'}, reserves:{amount:'580,000 tonnes',yearsSupply:157}, topProducers:['China (80%)','Mexico','Tajikistan'], price:{amount:30,unit:'$/kg',year:2024}, primaryUses:['Small-scale gold mining (37%)','VCM production','Fluorescent lamps','Dental amalgam'] },
      Tl: { production:{note:'Byproduct of zinc/lead smelting ‚Äî ~10 tonnes/yr'}, topProducers:['China','Japan','Belgium'], primaryUses:['Semiconductors','Infrared optics','Superconductor research','Medical imaging'] },
      Pb: { production:{annual:'4.6 million tonnes',unit:'tonnes/yr'}, reserves:{amount:'85 million tonnes',yearsSupply:18}, topProducers:['China (43%)','Australia','USA','Peru','Mexico'], price:{amount:2100,unit:'$/tonne',year:2024}, primaryUses:['Lead-acid batteries (85%)','Ammunition','Cable sheathing','Radiation shielding'] },
      Bi: { production:{annual:'20,000 tonnes',unit:'tonnes/yr'}, reserves:{amount:'370,000 tonnes',yearsSupply:19}, topProducers:['China (80%)','Vietnam','Mexico','Japan','Bolivia'], price:{amount:6,unit:'$/kg',year:2024}, primaryUses:['Pharmaceuticals (Pepto-Bismol)','Cosmetics','Lead-free solder','Fire sprinkler alloys'] },
      Po: { production:{note:'Produced in nuclear reactors ‚Äî ~100 g/yr globally'}, primaryUses:['Static eliminators','Nuclear research','Satellite heat sources'] },
      At: { production:{note:'Synthetic ‚Äî total worldwide less than 1 Œºg at any time'}, primaryUses:['Cancer radiotherapy research'] },
      Rn: { production:{note:'Naturally occurring radioactive decay product ‚Äî not commercially produced'}, primaryUses:['Radon testing/mitigation','Earthquake prediction research'] },
      Fr: { production:{note:'Synthetic ‚Äî most unstable natural element, produced in accelerators'}, primaryUses:['Research only'] },
      Ra: { production:{note:'Not commercially produced ‚Äî extremely radioactive'}, primaryUses:['Cancer treatment (historic)','Research'] },
      Ac: { production:{note:'Trace amounts from nuclear reactors for research'}, primaryUses:['Targeted alpha therapy research','Neutron source'] },
      Th: { production:{annual:'~10,000 tonnes (byproduct)',unit:'tonnes/yr'}, reserves:{amount:'6.4 million tonnes',yearsSupply:640}, topProducers:['India','Brazil','Australia','USA','Egypt'], price:{amount:80,unit:'$/kg',year:2024}, primaryUses:['Potential nuclear fuel','Gas mantles','Welding electrodes','Optical coatings'] },
      Pa: { production:{note:'Extremely rare ‚Äî ~130 g total isolated historically'}, primaryUses:['Research','Ocean sediment dating'] },
      U:  { production:{annual:'58,000 tonnes',unit:'tonnes/yr'}, reserves:{amount:'6.1 million tonnes',yearsSupply:105}, topProducers:['Kazakhstan (43%)','Namibia','Canada','Australia','Uzbekistan'], price:{amount:130,unit:'$/kg (U‚ÇÉO‚Çà)',year:2024}, primaryUses:['Nuclear power (96%)','Research reactors','Nuclear weapons','Radiation shielding (depleted)'] },
      Np: { production:{note:'Byproduct of nuclear reactors ‚Äî a few kg/yr'}, primaryUses:['Neutron detection','Precursor to Pu-238','Research'] },
      Pu: { production:{note:'Produced in nuclear reactors ‚Äî ~70 tonnes/yr worldwide'}, primaryUses:['Nuclear weapons','MOX fuel','RTGs for space probes','Research'] },
      Am: { production:{note:'Produced in nuclear reactors ‚Äî ~10 g/yr for commercial use'}, primaryUses:['Smoke detectors','Neutron sources','Research'] },
      Cm: { production:{note:'Produced in nuclear reactors ‚Äî milligram quantities'}, primaryUses:['Space probe RTGs','Alpha particle source','Research'] },
      Bk: { production:{note:'Synthetic ‚Äî microgram quantities in nuclear reactors'}, primaryUses:['Research','Target for heavier element synthesis'] },
      Cf: { production:{note:'Produced at ORNL and RIAR ‚Äî ~0.5 g/yr globally'}, price:{amount:27000000,unit:'$/g',year:2024}, primaryUses:['Neutron source (oil well logging)','Nuclear reactor startup','Cancer treatment','Mineral analysis'] },
      Es: { production:{note:'Synthetic ‚Äî microgram quantities'}, primaryUses:['Research only'] },
      Fm: { production:{note:'Synthetic ‚Äî produced in nuclear reactors'}, primaryUses:['Research only'] },
      Md: { production:{note:'Synthetic ‚Äî only atoms at a time in particle accelerators'}, primaryUses:['Research only'] },
      No: { production:{note:'Synthetic ‚Äî atoms at a time'}, primaryUses:['Research only'] },
      Lr: { production:{note:'Synthetic ‚Äî atoms at a time'}, primaryUses:['Research only'] },
      Rf: { production:{note:'Synthetic ‚Äî atoms at a time in particle accelerators'}, primaryUses:['Research only'] },
      Db: { production:{note:'Synthetic ‚Äî atoms at a time'}, primaryUses:['Research only'] },
      Sg: { production:{note:'Synthetic ‚Äî atoms at a time'}, primaryUses:['Research only'] },
      Bh: { production:{note:'Synthetic ‚Äî atoms at a time'}, primaryUses:['Research only'] },
      Hs: { production:{note:'Synthetic ‚Äî atoms at a time'}, primaryUses:['Research only'] },
      Mt: { production:{note:'Synthetic ‚Äî atoms at a time'}, primaryUses:['Research only'] },
      Ds: { production:{note:'Synthetic ‚Äî atoms at a time'}, primaryUses:['Research only'] },
      Rg: { production:{note:'Synthetic ‚Äî atoms at a time'}, primaryUses:['Research only'] },
      Cn: { production:{note:'Synthetic ‚Äî atoms at a time'}, primaryUses:['Research only'] },
      Nh: { production:{note:'Synthetic ‚Äî atoms at a time'}, primaryUses:['Research only'] },
      Fl: { production:{note:'Synthetic ‚Äî atoms at a time'}, primaryUses:['Research only'] },
      Mc: { production:{note:'Synthetic ‚Äî atoms at a time'}, primaryUses:['Research only'] },
      Lv: { production:{note:'Synthetic ‚Äî atoms at a time'}, primaryUses:['Research only'] },
      Ts: { production:{note:'Synthetic ‚Äî atoms at a time'}, primaryUses:['Research only'] },
      Og: { production:{note:'Synthetic ‚Äî atoms at a time'}, primaryUses:['Research only'] },
    };

    // Merge world data into ELEMENTS
    ELEMENTS.forEach(e => {
      const wd = ELEMENT_WORLD_DATA[e.symbol];
      if (wd) Object.assign(e, { worldData: wd });
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MATERIAL WORLD DATA (USGS/World Bank 2024)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const MATERIAL_WORLD_DATA = {
      'Iron Ore': { production:{annual:'2.5 billion tonnes',growth:'+1.5%/yr'}, energyCost:'0.5 GJ per tonne (mining)', topProducers:['Australia (37%)','Brazil (17%)','China (14%)','India (10%)'], co2:'0.04 tonnes CO‚ÇÇ per tonne' },
      'Steel': { production:{annual:'1.9 billion tonnes',growth:'+3.2%/yr'}, inputChain:[{material:'Iron Ore',ratio:'2.5 tonnes per tonne steel'},{material:'Coal/Coke',ratio:'0.6 tonnes per tonne steel'},{material:'Limestone',ratio:'0.2 tonnes per tonne steel'}], energyCost:'20 GJ per tonne', topProducers:['China (54%)','India (7%)','Japan (5%)','USA (5%)'], co2:'1.85 tonnes CO‚ÇÇ per tonne steel' },
      'Wood / Timber': { production:{annual:'4 billion m¬≥ (roundwood)',growth:'+0.5%/yr'}, topProducers:['USA','India','China','Brazil','Russia'], co2:'Net carbon sink when sustainably managed' },
      'Lumber': { production:{annual:'500 million m¬≥ (sawnwood)',growth:'+1.0%/yr'}, energyCost:'1.5 GJ per m¬≥', topProducers:['USA','China','Canada','Russia','Germany'], co2:'Stores ~250 kg CO‚ÇÇ per m¬≥' },
      'Sand': { production:{annual:'50 billion tonnes',growth:'+5.5%/yr'}, topProducers:['China','USA','India','EU','Australia'], co2:'Minimal (extraction only)' },
      'Glass': { production:{annual:'200 million tonnes',growth:'+3.5%/yr'}, inputChain:[{material:'Sand (SiO‚ÇÇ)',ratio:'72%'},{material:'Soda ash',ratio:'14%'},{material:'Limestone',ratio:'10%'}], energyCost:'7-10 GJ per tonne', topProducers:['China (50%)','EU','USA','India','Japan'], co2:'0.6 tonnes CO‚ÇÇ per tonne' },
      'Clay': { production:{annual:'Billions of tonnes (not fully tracked)',growth:'Stable'}, topProducers:['China','USA','Germany','UK','India'] },
      'Concrete': { production:{annual:'14 billion m¬≥ (~33 billion tonnes)',growth:'+2.5%/yr'}, inputChain:[{material:'Cement',ratio:'10-15%'},{material:'Sand',ratio:'25-30%'},{material:'Gravel',ratio:'35-40%'},{material:'Water',ratio:'15-20%'}], energyCost:'1.5-2 GJ per tonne', topProducers:['China (55%)','India','USA','Turkey','Brazil'], co2:'0.1-0.2 tonnes CO‚ÇÇ per tonne concrete' },
      'Aluminum Ore (Bauxite)': { production:{annual:'380 million tonnes',growth:'+2.5%/yr'}, topProducers:['Australia (28%)','Guinea (22%)','China (16%)','Brazil','Indonesia'], co2:'0.01 tonnes CO‚ÇÇ per tonne (mining)' },
      'Aluminum': { production:{annual:'69 million tonnes',growth:'+2.8%/yr'}, inputChain:[{material:'Bauxite',ratio:'4-5 tonnes per tonne aluminum'},{material:'Alumina',ratio:'2 tonnes per tonne aluminum'},{material:'Electricity',ratio:'14 MWh per tonne'}], energyCost:'170 GJ per tonne', topProducers:['China (57%)','India (6%)','Russia (5%)','Canada (5%)','UAE (4%)'], co2:'12 tonnes CO‚ÇÇ per tonne (global avg)' },
      'Copper Ore (Chalcopyrite)': { production:{annual:'22 million tonnes (Cu content)',growth:'+2.0%/yr'}, topProducers:['Chile (24%)','DRC (12%)','Peru (10%)','China','Indonesia'], co2:'Varies by mine' },
      'Brass': { production:{annual:'~6 million tonnes',growth:'+2%/yr'}, inputChain:[{material:'Copper',ratio:'60-70%'},{material:'Zinc',ratio:'30-40%'}], energyCost:'8 GJ per tonne', topProducers:['China','Germany','Japan','USA','Italy'] },
      'Bronze': { production:{annual:'~1 million tonnes',growth:'+1%/yr'}, inputChain:[{material:'Copper',ratio:'88-95%'},{material:'Tin',ratio:'5-12%'}], energyCost:'9 GJ per tonne', topProducers:['China','USA','Japan','Germany','South Korea'] },
      'Stainless Steel': { production:{annual:'58 million tonnes',growth:'+4.5%/yr'}, inputChain:[{material:'Iron/Steel',ratio:'70-75%'},{material:'Chromium',ratio:'10.5-18%'},{material:'Nickel',ratio:'8-12%'}], energyCost:'30 GJ per tonne', topProducers:['China (56%)','India (7%)','Japan (5%)','EU','USA'], co2:'2.8 tonnes CO‚ÇÇ per tonne' },
      'Titanium': { production:{annual:'220,000 tonnes (metal)',growth:'+3%/yr'}, inputChain:[{material:'Ilmenite/Rutile ore',ratio:'~10 tonnes ore per tonne metal'},{material:'Magnesium (Kroll process)',ratio:'1 tonne per tonne Ti'}], energyCost:'360 GJ per tonne', topProducers:['China','Russia','Japan','Kazakhstan','USA'], co2:'8.6 tonnes CO‚ÇÇ per tonne' },
      'Zinc': { production:{annual:'13 million tonnes',growth:'+1.5%/yr'}, inputChain:[{material:'Sphalerite ore',ratio:'~3 tonnes per tonne zinc'}], energyCost:'35 GJ per tonne', topProducers:['China (42%)','Peru','Australia','India','USA'], co2:'2.5 tonnes CO‚ÇÇ per tonne' },
      'Lead': { production:{annual:'4.6 million tonnes',growth:'+1.0%/yr'}, inputChain:[{material:'Galena ore',ratio:'~3 tonnes per tonne lead'}], energyCost:'15 GJ per tonne', topProducers:['China (43%)','Australia','USA','Peru','Mexico'], co2:'1.0 tonnes CO‚ÇÇ per tonne' },
      'Tin': { production:{annual:'310,000 tonnes',growth:'+1.2%/yr'}, inputChain:[{material:'Cassiterite ore',ratio:'~5 tonnes per tonne tin'}], energyCost:'20 GJ per tonne', topProducers:['China (30%)','Indonesia','Myanmar','Peru','DRC'], co2:'1.5 tonnes CO‚ÇÇ per tonne' },
      'Nickel': { production:{annual:'3.6 million tonnes',growth:'+6%/yr'}, inputChain:[{material:'Laterite/Sulfide ore',ratio:'~50-100 tonnes ore per tonne Ni'}], energyCost:'110 GJ per tonne', topProducers:['Indonesia (49%)','Philippines','Russia','New Caledonia','Australia'], co2:'10 tonnes CO‚ÇÇ per tonne' },
      'Cotton': { production:{annual:'25 million tonnes',growth:'+0.5%/yr'}, energyCost:'55 GJ per tonne (field to fabric)', topProducers:['India (23%)','China (22%)','USA (14%)','Brazil','Pakistan'], co2:'5 tonnes CO‚ÇÇ per tonne' },
      'Wool': { production:{annual:'1.1 million tonnes (greasy)',growth:'-0.5%/yr'}, topProducers:['Australia (21%)','China (18%)','New Zealand','UK','Turkey'], co2:'26 kg CO‚ÇÇ per kg (high due to methane)' },
      'Leather': { production:{annual:'20 billion sq ft',growth:'+1%/yr'}, topProducers:['China','Italy','Brazil','India','Vietnam'] },
      'Rubber (Natural)': { production:{annual:'14 million tonnes',growth:'+2%/yr'}, topProducers:['Thailand (34%)','Indonesia (24%)','Vietnam','China','India'], co2:'Low (trees absorb CO‚ÇÇ)' },
      'Paper': { production:{annual:'410 million tonnes',growth:'+0.5%/yr'}, inputChain:[{material:'Wood',ratio:'2-3 tonnes per tonne paper'},{material:'Water',ratio:'10-20 m¬≥ per tonne'}], energyCost:'20-40 GJ per tonne', topProducers:['China (28%)','USA (17%)','Japan','Germany','India'], co2:'0.5-1.5 tonnes CO‚ÇÇ per tonne' },
      'Bamboo': { production:{annual:'~40 million tonnes',growth:'+3%/yr'}, topProducers:['China (65%)','India','Myanmar','Thailand','Vietnam'] },
      'Hemp': { production:{annual:'280,000 tonnes (fiber)',growth:'+15%/yr'}, topProducers:['China','Canada','France','EU','USA'] },
      'Cork': { production:{annual:'200,000 tonnes',growth:'+1%/yr'}, topProducers:['Portugal (49%)','Spain (26%)','Morocco','Algeria','Tunisia'] },
      'Granite': { production:{annual:'~160 million tonnes',growth:'+3%/yr'}, topProducers:['China','India','Brazil','Italy','Spain'] },
      'Marble': { production:{annual:'~100 million tonnes',growth:'+2%/yr'}, topProducers:['China','India','Turkey','Italy','Iran'] },
      'Limestone': { production:{annual:'~7 billion tonnes',growth:'+2%/yr'}, topProducers:['China','USA','India','Russia','Japan'] },
      'Cement': { production:{annual:'4.1 billion tonnes',growth:'+1.5%/yr'}, inputChain:[{material:'Limestone',ratio:'1.5 tonnes per tonne cement'},{material:'Clay',ratio:'0.3 tonnes per tonne'},{material:'Gypsum',ratio:'5%'}], energyCost:'4.5 GJ per tonne', topProducers:['China (55%)','India (8%)','Vietnam','USA','Turkey'], co2:'0.6 tonnes CO‚ÇÇ per tonne cement' },
      'Brick': { production:{annual:'1.5 trillion bricks/yr',growth:'+2%/yr'}, energyCost:'2-5 GJ per 1000 bricks', topProducers:['China (60%)','India','Pakistan','Bangladesh','Indonesia'], co2:'0.2 kg CO‚ÇÇ per brick' },
      'Porcelain': { production:{annual:'~400 million tonnes (all ceramics)',growth:'+3%/yr'}, topProducers:['China (65%)','Italy','Spain','India','Turkey'] },
      'Fiberglass': { production:{annual:'~6 million tonnes',growth:'+5%/yr'}, inputChain:[{material:'Glass fiber',ratio:'60-70%'},{material:'Polymer resin',ratio:'30-40%'}], energyCost:'30 GJ per tonne', topProducers:['China','USA','EU','India','Japan'] },
      'Plastic (Polyethylene)': { production:{annual:'100 million tonnes (PE only); 400M total plastics',growth:'+3.5%/yr'}, inputChain:[{material:'Crude oil/natural gas',ratio:'~2 tonnes oil per tonne PE'}], energyCost:'70-80 GJ per tonne', topProducers:['China (32%)','USA','EU','South Korea','Saudi Arabia'], co2:'2-3 tonnes CO‚ÇÇ per tonne' },
      'PVC (Polyvinyl Chloride)': { production:{annual:'45 million tonnes',growth:'+3%/yr'}, inputChain:[{material:'Ethylene (from oil)',ratio:'43%'},{material:'Chlorine (from salt)',ratio:'57%'}], energyCost:'55 GJ per tonne', topProducers:['China (40%)','USA','EU','India','Japan'], co2:'2 tonnes CO‚ÇÇ per tonne' },
      'Nylon': { production:{annual:'8 million tonnes',growth:'+4%/yr'}, energyCost:'120 GJ per tonne', topProducers:['China','USA','EU','Taiwan','South Korea'], co2:'7 tonnes CO‚ÇÇ per tonne' },
      'Carbon Fiber': { production:{annual:'120,000 tonnes',growth:'+12%/yr'}, inputChain:[{material:'PAN precursor',ratio:'2 tonnes per tonne CF'},{material:'Energy (carbonization)',ratio:'Very high'}], energyCost:'600 GJ per tonne', topProducers:['Japan (Toray 34%)','China','USA','EU','Taiwan'], co2:'20-40 tonnes CO‚ÇÇ per tonne' },
      'Kevlar': { production:{annual:'~70,000 tonnes (all aramids)',growth:'+5%/yr'}, energyCost:'200 GJ per tonne', topProducers:['USA (DuPont)','Japan (Teijin)','South Korea','EU'] },
      'Plywood': { production:{annual:'170 million m¬≥',growth:'+3%/yr'}, inputChain:[{material:'Wood veneers',ratio:'~1.5 m¬≥ log per m¬≥ plywood'},{material:'Adhesive',ratio:'5-10% by weight'}], energyCost:'5 GJ per m¬≥', topProducers:['China (66%)','Indonesia','Russia','USA','India'] },
      'MDF (Medium-Density Fiberboard)': { production:{annual:'100 million m¬≥',growth:'+4%/yr'}, inputChain:[{material:'Wood fiber',ratio:'85-90%'},{material:'UF resin',ratio:'10-15%'}], energyCost:'6 GJ per m¬≥', topProducers:['China (50%)','Turkey','Brazil','EU','USA'] },
      'Coal': { production:{annual:'8.7 billion tonnes',growth:'-0.5%/yr'}, topProducers:['China (52%)','India (10%)','Indonesia (8%)','USA (6%)','Australia (6%)'], co2:'2.86 tonnes CO‚ÇÇ per tonne burned' },
      'Petroleum (Crude Oil)': { production:{annual:'4.4 billion tonnes (100M barrels/day)',growth:'+0.5%/yr'}, topProducers:['USA (20%)','Saudi Arabia (12%)','Russia (11%)','Canada','Iraq'], co2:'3.1 tonnes CO‚ÇÇ per tonne burned' },
      'Natural Gas': { production:{annual:'4.0 trillion m¬≥',growth:'+2%/yr'}, topProducers:['USA (25%)','Russia (15%)','Iran','China','Canada'], co2:'2.0 tonnes CO‚ÇÇ per 1000 m¬≥ burned' },
    };

    // Merge world data into MATERIALS
    MATERIALS.forEach(m => {
      const wd = MATERIAL_WORLD_DATA[m.name];
      if (wd) Object.assign(m, { worldData: wd });
    });

    const ELEMENT_CATEGORIES = [...new Set(ELEMENTS.map(e => e.category))];
    let elementCatFilter = '';
    let selectedElement = null;

    function renderElementPills() {
      const pills = document.getElementById('element-cat-pills');
      pills.innerHTML = `<span class="filter-pill ${elementCatFilter===''?'active':''}" onclick="elementCatFilter='';renderElements()">All</span>` +
        ELEMENT_CATEGORIES.map(c => `<span class="filter-pill ${elementCatFilter===c?'active':''}" onclick="elementCatFilter='${c}';renderElements()">${c}</span>`).join('');
    }

    function renderElements() {
      const filter = (document.getElementById('element-filter').value || '').toLowerCase();
      const filtered = ELEMENTS.filter(e => {
        if (elementCatFilter && e.category !== elementCatFilter) return false;
        if (filter && !e.name.toLowerCase().includes(filter) && !e.symbol.toLowerCase().includes(filter) && !String(e.number).includes(filter)) return false;
        return true;
      });
      renderElementPills();
      document.getElementById('element-grid').innerHTML = filtered.map(e =>
        `<div class="element-card el-cat-${e.category}" onclick="showElementDetail('${e.symbol}')" title="${e.name}">
          <span class="el-number">${e.number}</span>
          <div class="el-symbol">${e.symbol}</div>
          <div class="el-name">${e.name}</div>
          <div class="el-mass">${e.mass}</div>
        </div>`
      ).join('');
    }

    function showElementDetail(symbol) {
      const e = ELEMENTS.find(el => el.symbol === symbol);
      if (!e) return;
      if (selectedElement === symbol) { selectedElement = null; document.getElementById('element-detail-slot').innerHTML = ''; return; }
      selectedElement = symbol;
      const srcLinks = e.sources.map(s => `<a href="${s.url}" target="_blank" rel="noopener" style="color:var(--accent);font-size:0.75rem;margin-right:0.6rem;">${s.name} ‚Üó</a>`).join('');
      document.getElementById('element-detail-slot').innerHTML = `
        <div class="element-detail">
          <div style="display:flex;justify-content:space-between;align-items:start;">
            <h3><span class="el-cat-${e.category}" style="border:none;display:inline;"><span class="el-symbol" style="font-size:1.4rem;">${e.symbol}</span></span> ${e.name} <span style="color:var(--text-muted);font-weight:400;font-size:0.85rem;">#${e.number}</span></h3>
            <button onclick="selectedElement=null;document.getElementById('element-detail-slot').innerHTML=''" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.1rem;">‚úï</button>
          </div>
          <p style="font-size:0.82rem;color:var(--text-muted);margin:0.3rem 0 0.6rem;">${e.description}</p>
          <div class="el-props">
            <div class="el-prop"><dt>Mass</dt><dd>${e.mass} u</dd></div>
            <div class="el-prop"><dt>Phase (STP)</dt><dd>${e.phase}</dd></div>
            <div class="el-prop"><dt>Density</dt><dd>${e.density}</dd></div>
            <div class="el-prop"><dt>Melting Pt</dt><dd>${e.meltingPoint}</dd></div>
            <div class="el-prop"><dt>Boiling Pt</dt><dd>${e.boilingPoint}</dd></div>
            <div class="el-prop"><dt>Category</dt><dd>${e.category}</dd></div>
            <div class="el-prop"><dt>Discovered</dt><dd>${e.discovered}</dd></div>
            <div class="el-prop"><dt>Discoverer</dt><dd>${e.discoverer}</dd></div>
          </div>
          <div style="margin:0.6rem 0;"><strong style="font-size:0.75rem;color:var(--text-muted);">USES:</strong>
            <div style="display:flex;flex-wrap:wrap;gap:0.3rem;margin-top:0.3rem;">
              ${e.uses.map(u => `<span style="background:rgba(255,136,17,0.1);color:var(--accent);font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:10px;">${u}</span>`).join('')}
            </div>
          </div>
          ${e.worldData ? `
          <details style="margin-top:0.6rem;border:1px solid var(--border);border-radius:8px;padding:0.4rem 0.6rem;background:rgba(0,255,136,0.03);">
            <summary style="cursor:pointer;font-size:0.8rem;font-weight:600;color:var(--accent);">üåç World Data</summary>
            <div style="margin-top:0.4rem;font-size:0.75rem;line-height:1.6;">
              ${e.worldData.production ? (e.worldData.production.annual
                ? '<div><strong>Annual Production:</strong> '+e.worldData.production.annual+'</div>'
                : '<div><em>'+e.worldData.production.note+'</em></div>') : ''}
              ${e.worldData.reserves ? (e.worldData.reserves.amount
                ? '<div><strong>Reserves:</strong> '+e.worldData.reserves.amount
                  +(e.worldData.reserves.yearsSupply!=null
                    ? ' <span style="padding:0.1rem 0.4rem;border-radius:8px;font-size:0.7rem;font-weight:600;background:'
                      +(e.worldData.reserves.yearsSupply>100?'rgba(0,200,83,0.2);color:#0c6':'rgba(255,160,0,0.2);color:#f90')
                      +'">~'+e.worldData.reserves.yearsSupply+' years</span>'
                    : '')+'</div>' : '') : ''}
              ${e.worldData.topProducers ? '<div><strong>Top Producers:</strong> '+e.worldData.topProducers.join(', ')+'</div>' : ''}
              ${e.worldData.price && e.worldData.price.amount ? '<div><strong>Price:</strong> '+e.worldData.price.amount.toLocaleString()+' '+e.worldData.price.unit+' ('+e.worldData.price.year+')</div>' : ''}
              ${e.worldData.primaryUses ? '<div><strong>Primary Uses:</strong> '+e.worldData.primaryUses.join(', ')+'</div>' : ''}
            </div>
          </details>` : ''}
          <div style="margin-top:0.5rem;">${srcLinks}</div>
        </div>`;
    }
    renderElements();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MATERIALS CATALOG
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const MATERIALS = [
      { name:'Iron Ore', type:'raw', category:'Metal',
        components:[], sources_natural:['Open-pit mines','Underground deposits','BIF formations'],
        properties:{ iron_content:'25-70%', density:'4.0-5.5 g/cm¬≥', hardness:'5-6.5 Mohs' },
        uses:['Steel production','Pigments','Cement additive'],
        processing:'Mining ‚Üí Crushing ‚Üí Beneficiation ‚Üí Iron ore concentrate',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/iron-ore-statistics-and-information'}] },
      { name:'Steel', type:'processed', category:'Metal',
        components:['Iron','Carbon'], sources_natural:['Iron ore deposits','Coal mines'],
        properties:{ tensile_strength:'400-550 MPa', density:'7.85 g/cm¬≥', melting_point:'1370-1510 ¬∞C' },
        uses:['Construction','Vehicles','Tools','Bridges'],
        processing:'Iron ore ‚Üí Blast furnace ‚Üí Pig iron ‚Üí Basic oxygen steelmaking ‚Üí Steel',
        references:[{name:'MatWeb',url:'https://matweb.com/search/DataSheet.aspx?MatGUID=1b3c3a1bc9d24cccb03b1bacbbcdfa8c'}] },
      { name:'Wood / Timber', type:'raw', category:'Organic',
        components:[], sources_natural:['Forests','Tree plantations'],
        properties:{ density:'0.4-0.9 g/cm¬≥', tensile_strength:'40-140 MPa', moisture:'12-20%' },
        uses:['Construction','Furniture','Paper','Fuel'],
        processing:'Felling ‚Üí Debarking ‚Üí Sawing ‚Üí Seasoning',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Wood'}] },
      { name:'Lumber', type:'processed', category:'Organic',
        components:['Wood / Timber'], sources_natural:['Managed forests','Sawmills'],
        properties:{ density:'0.35-0.6 g/cm¬≥', moisture:'6-12%', standard_sizes:'2√ó4, 2√ó6, 4√ó4 etc.' },
        uses:['Framing','Decking','Fencing','Shelving'],
        processing:'Timber ‚Üí Sawmill ‚Üí Kiln drying ‚Üí Planing ‚Üí Grading ‚Üí Lumber',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Lumber'}] },
      { name:'Sand', type:'raw', category:'Mineral',
        components:[], sources_natural:['Beaches','Riverbeds','Quarries','Deserts'],
        properties:{ composition:'Mostly SiO‚ÇÇ', grain_size:'0.1-2 mm', density:'1.5-1.7 g/cm¬≥' },
        uses:['Glass making','Concrete','Foundry casting','Filtration'],
        processing:'Extraction ‚Üí Washing ‚Üí Screening ‚Üí Grading',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/sand-and-gravel-statistics-and-information'}] },
      { name:'Glass', type:'processed', category:'Mineral',
        components:['Sand','Soda ash','Limestone'], sources_natural:['Sand quarries'],
        properties:{ density:'2.5 g/cm¬≥', melting_point:'~1700 ¬∞C', transparency:'High (visible spectrum)' },
        uses:['Windows','Bottles','Optics','Screens'],
        processing:'Sand + Soda ash + Limestone ‚Üí Furnace (1700¬∞C) ‚Üí Molten glass ‚Üí Forming ‚Üí Annealing ‚Üí Glass',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Glass'}] },
      { name:'Clay', type:'raw', category:'Mineral',
        components:[], sources_natural:['Riverbanks','Weathered rock deposits','Sedimentary layers'],
        properties:{ particle_size:'<0.002 mm', plasticity:'High when wet', density:'1.8-2.6 g/cm¬≥' },
        uses:['Pottery','Bricks','Ceramics','Sculpture'],
        processing:'Extraction ‚Üí Weathering ‚Üí Pugging ‚Üí Shaping',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Clay'}] },
      { name:'Concrete', type:'composite', category:'Mineral',
        components:['Sand','Gravel','Cement','Water'], sources_natural:['Quarries','Cement plants'],
        properties:{ compressive_strength:'20-40 MPa', density:'2.3-2.5 g/cm¬≥', curing_time:'28 days full strength' },
        uses:['Foundations','Roads','Dams','Buildings'],
        processing:'Cement + Sand + Gravel + Water ‚Üí Mixing ‚Üí Pouring ‚Üí Curing ‚Üí Concrete',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Concrete'}] },
{ name:'Aluminum Ore (Bauxite)', type:'raw', category:'Metal',
        components:[], sources_natural:['Open-pit mines in Australia, Guinea, Brazil, Jamaica'],
        properties:{ aluminum_content:'30-54% Al‚ÇÇO‚ÇÉ', density:'2.0-2.5 g/cm¬≥', hardness:'1-3 Mohs' },
        uses:['Aluminum production','Abrasives','Cement','Refractories'],
        processing:'Mining ‚Üí Crushing ‚Üí Washing ‚Üí Bayer process ‚Üí Alumina',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/bauxite-and-alumina-statistics-and-information'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Bauxite'}] },
      { name:'Aluminum', type:'processed', category:'Metal',
        components:['Bauxite'], sources_natural:['Bauxite mines in Australia, Guinea, Brazil'],
        properties:{ density:'2.7 g/cm¬≥', tensile_strength:'70-700 MPa', melting_point:'660 ¬∞C', conductivity:'High' },
        uses:['Aircraft','Cans','Foil','Window frames','Electronics'],
        processing:'Bauxite ‚Üí Bayer process ‚Üí Alumina ‚Üí Hall-H√©roult electrolysis ‚Üí Aluminum',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/aluminum-statistics-and-information'},{name:'MatWeb',url:'https://matweb.com/search/DataSheet.aspx?MatGUID=0cd1edf33ac145ee93a0aa06bcdbc073'}] },
      { name:'Copper Ore (Chalcopyrite)', type:'raw', category:'Metal',
        components:[], sources_natural:['Porphyry deposits in Chile, Peru, USA, DRC'],
        properties:{ copper_content:'25-35% Cu', density:'4.1-4.3 g/cm¬≥', hardness:'3.5-4 Mohs' },
        uses:['Copper production','Sulfuric acid byproduct'],
        processing:'Mining ‚Üí Crushing ‚Üí Flotation ‚Üí Concentrate ‚Üí Smelting',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/copper-statistics-and-information'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Chalcopyrite'}] },
      { name:'Brass', type:'processed', category:'Metal',
        components:['Copper','Zinc'], sources_natural:['Copper and zinc ores'],
        properties:{ density:'8.4-8.7 g/cm¬≥', tensile_strength:'338-469 MPa', melting_point:'900-940 ¬∞C', conductivity:'Moderate' },
        uses:['Plumbing fittings','Musical instruments','Ammunition casings','Decorative hardware'],
        processing:'Copper + Zinc ‚Üí Melting ‚Üí Alloying ‚Üí Casting/Rolling ‚Üí Brass',
        references:[{name:'MatWeb',url:'https://matweb.com/search/DataSheet.aspx?MatGUID=d3bd4617903543ada92f4c101c2a20e5'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Brass'}] },
      { name:'Bronze', type:'processed', category:'Metal',
        components:['Copper','Tin'], sources_natural:['Copper and tin ores'],
        properties:{ density:'7.4-8.9 g/cm¬≥', tensile_strength:'303-517 MPa', melting_point:'950-1050 ¬∞C', conductivity:'Moderate' },
        uses:['Bearings','Sculptures','Ship propellers','Springs'],
        processing:'Copper + Tin ‚Üí Melting ‚Üí Alloying ‚Üí Casting ‚Üí Bronze',
        references:[{name:'MatWeb',url:'https://matweb.com/search/DataSheet.aspx?MatGUID=b607236c21e545ca9ebf7875cbe0300d'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Bronze'}] },
      { name:'Stainless Steel', type:'processed', category:'Metal',
        components:['Iron','Chromium','Nickel','Carbon'], sources_natural:['Iron, chromium, and nickel ores'],
        properties:{ density:'7.75-8.1 g/cm¬≥', tensile_strength:'515-827 MPa', melting_point:'1400-1530 ¬∞C', conductivity:'Low-Moderate' },
        uses:['Kitchen appliances','Medical instruments','Architecture','Chemical tanks'],
        processing:'Iron + Chromium (10.5%+) + Nickel ‚Üí Electric arc furnace ‚Üí Rolling ‚Üí Stainless Steel',
        references:[{name:'MatWeb',url:'https://matweb.com/search/DataSheet.aspx?MatGUID=abc4415b0f8b490387e3c922237098da'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Stainless_steel'}] },
      { name:'Titanium', type:'processed', category:'Metal',
        components:['Ilmenite','Rutile'], sources_natural:['Mineral sands in Australia, South Africa, Canada'],
        properties:{ density:'4.506 g/cm¬≥', tensile_strength:'434-1103 MPa', melting_point:'1668 ¬∞C', conductivity:'Low' },
        uses:['Aerospace','Medical implants','Jewelry','Chemical processing'],
        processing:'Rutile/Ilmenite ‚Üí Chlorination ‚Üí Kroll process (Mg reduction) ‚Üí Titanium sponge ‚Üí Melting',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/titanium-statistics-and-information'},{name:'MatWeb',url:'https://matweb.com/search/DataSheet.aspx?MatGUID=66a15d609a3f4c829cb6ad08f0dafc01'}] },
      { name:'Zinc', type:'processed', category:'Metal',
        components:['Sphalerite'], sources_natural:['Zinc mines in China, Australia, Peru'],
        properties:{ density:'7.134 g/cm¬≥', tensile_strength:'37 MPa', melting_point:'419.5 ¬∞C', conductivity:'Moderate' },
        uses:['Galvanizing steel','Die casting','Brass alloy','Batteries'],
        processing:'Sphalerite ‚Üí Roasting ‚Üí Leaching ‚Üí Electrolysis ‚Üí Zinc',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/zinc-statistics-and-information'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Zinc'}] },
      { name:'Lead', type:'processed', category:'Metal',
        components:['Galena'], sources_natural:['Lead-zinc mines in China, Australia, USA'],
        properties:{ density:'11.34 g/cm¬≥', tensile_strength:'17 MPa', melting_point:'327.5 ¬∞C', conductivity:'Low' },
        uses:['Lead-acid batteries','Radiation shielding','Ammunition','Cable sheathing'],
        processing:'Galena ‚Üí Roasting ‚Üí Smelting ‚Üí Refining ‚Üí Lead',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/lead-statistics-and-information'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Lead'}] },
      { name:'Tin', type:'processed', category:'Metal',
        components:['Cassiterite'], sources_natural:['Alluvial and hard-rock mines in China, Indonesia, Myanmar'],
        properties:{ density:'7.287 g/cm¬≥', tensile_strength:'11-15 MPa', melting_point:'231.9 ¬∞C', conductivity:'Moderate' },
        uses:['Tin plating (tin cans)','Solder','Bronze alloy','Pewter'],
        processing:'Cassiterite ‚Üí Smelting with carbon ‚Üí Refining ‚Üí Tin',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/tin-statistics-and-information'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Tin'}] },
      { name:'Nickel', type:'processed', category:'Metal',
        components:['Pentlandite','Laterite ores'], sources_natural:['Mines in Indonesia, Philippines, Russia, Canada'],
        properties:{ density:'8.908 g/cm¬≥', tensile_strength:'317-462 MPa', melting_point:'1455 ¬∞C', conductivity:'Moderate' },
        uses:['Stainless steel','Batteries','Coins','Superalloys'],
        processing:'Laterite/Sulfide ore ‚Üí Roasting/Leaching ‚Üí Smelting ‚Üí Electrolytic refining ‚Üí Nickel',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/nickel-statistics-and-information'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Nickel'}] },
      { name:'Cotton', type:'raw', category:'Organic',
        components:[], sources_natural:['Cotton farms in India, China, USA, Brazil'],
        properties:{ density:'1.5-1.6 g/cm¬≥', tensile_strength:'287-597 MPa', moisture_regain:'8.5%', fiber_length:'10-65 mm' },
        uses:['Clothing','Towels','Medical supplies','Industrial fabrics'],
        processing:'Harvesting ‚Üí Ginning ‚Üí Carding ‚Üí Spinning ‚Üí Weaving/Knitting',
        references:[{name:'USDA',url:'https://usda.gov/topics/farming/crop-production'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Cotton'}] },
      { name:'Wool', type:'raw', category:'Organic',
        components:[], sources_natural:['Sheep farms in Australia, China, New Zealand'],
        properties:{ density:'1.3 g/cm¬≥', fiber_diameter:'15-40 Œºm', moisture_regain:'13-16%', flame_resistance:'Self-extinguishing' },
        uses:['Clothing','Blankets','Carpets','Insulation'],
        processing:'Shearing ‚Üí Scouring ‚Üí Carding ‚Üí Spinning ‚Üí Weaving',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Wool'}] },
      { name:'Leather', type:'processed', category:'Organic',
        components:['Animal hide'], sources_natural:['Cattle, sheep, goat hides (byproduct of meat industry)'],
        properties:{ density:'0.86 g/cm¬≥', tensile_strength:'10-30 MPa', thickness:'0.5-3.0 mm' },
        uses:['Shoes','Bags','Furniture','Belts','Jackets'],
        processing:'Hide ‚Üí Liming ‚Üí Dehairing ‚Üí Tanning (chrome/vegetable) ‚Üí Drying ‚Üí Finishing',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Leather'}] },
      { name:'Rubber (Natural)', type:'raw', category:'Organic',
        components:[], sources_natural:['Rubber tree plantations in Thailand, Indonesia, Malaysia'],
        properties:{ density:'0.92 g/cm¬≥', tensile_strength:'20-30 MPa', elongation:'600-800%', elasticity:'Very high' },
        uses:['Tires','Gloves','Hoses','Footwear','Elastic bands'],
        processing:'Tapping latex ‚Üí Coagulation ‚Üí Smoking/Drying ‚Üí Vulcanization',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Natural_rubber'}] },
      { name:'Paper', type:'processed', category:'Organic',
        components:['Wood pulp'], sources_natural:['Managed forests, recycled paper'],
        properties:{ density:'0.7-1.2 g/cm¬≥', tensile_strength:'2-10 kN/m', thickness:'0.05-0.5 mm' },
        uses:['Writing','Packaging','Printing','Tissue','Currency'],
        processing:'Wood ‚Üí Chipping ‚Üí Pulping ‚Üí Bleaching ‚Üí Pressing ‚Üí Drying ‚Üí Paper',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Paper'}] },
      { name:'Bamboo', type:'raw', category:'Organic',
        components:[], sources_natural:['Tropical and subtropical forests in Asia, South America'],
        properties:{ density:'0.3-0.8 g/cm¬≥', tensile_strength:'140-280 MPa', growth_rate:'Up to 91 cm/day' },
        uses:['Construction','Flooring','Textiles','Furniture','Scaffolding'],
        processing:'Harvesting ‚Üí Splitting ‚Üí Treating ‚Üí Drying ‚Üí Laminating',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Bamboo'}] },
      { name:'Hemp', type:'raw', category:'Organic',
        components:[], sources_natural:['Hemp farms in China, Canada, Europe'],
        properties:{ density:'1.48 g/cm¬≥', tensile_strength:'550-900 MPa', fiber_length:'1-5 m' },
        uses:['Rope','Textiles','Paper','Insulation','Bioplastics'],
        processing:'Harvesting ‚Üí Retting ‚Üí Breaking ‚Üí Scutching ‚Üí Hackling ‚Üí Spinning',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Hemp'}] },
      { name:'Cork', type:'raw', category:'Organic',
        components:[], sources_natural:['Cork oak forests in Portugal, Spain'],
        properties:{ density:'0.12-0.24 g/cm¬≥', compressibility:'Very high', thermal_conductivity:'0.04 W/m¬∑K' },
        uses:['Wine stoppers','Flooring','Insulation','Bulletin boards','Gaskets'],
        processing:'Bark stripping (every 9 years) ‚Üí Boiling ‚Üí Drying ‚Üí Cutting ‚Üí Finishing',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Cork_(material)'}] },
      { name:'Granite', type:'raw', category:'Mineral',
        components:[], sources_natural:['Quarries worldwide ‚Äî India, Brazil, Norway, USA'],
        properties:{ density:'2.63-2.75 g/cm¬≥', compressive_strength:'100-250 MPa', hardness:'6-7 Mohs' },
        uses:['Countertops','Building facades','Monuments','Paving'],
        processing:'Quarrying ‚Üí Diamond wire cutting ‚Üí Polishing ‚Üí Finishing',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Granite'}] },
      { name:'Marble', type:'raw', category:'Mineral',
        components:[], sources_natural:['Quarries in Italy (Carrara), Greece, Turkey, India'],
        properties:{ density:'2.56 g/cm¬≥', compressive_strength:'60-170 MPa', hardness:'3-4 Mohs' },
        uses:['Sculpture','Countertops','Flooring','Building facades'],
        processing:'Quarrying ‚Üí Block cutting ‚Üí Gang sawing ‚Üí Polishing ‚Üí Finishing',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Marble'}] },
      { name:'Limestone', type:'raw', category:'Mineral',
        components:[], sources_natural:['Sedimentary deposits worldwide'],
        properties:{ density:'2.3-2.7 g/cm¬≥', composition:'Primarily CaCO‚ÇÉ', hardness:'3-4 Mohs' },
        uses:['Cement production','Building stone','Agriculture (pH adjustment)','Steel flux'],
        processing:'Quarrying ‚Üí Crushing ‚Üí Calcination (for quicklime) ‚Üí Hydration (for slaked lime)',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/crushed-stone-statistics-and-information'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Limestone'}] },
      { name:'Cement', type:'processed', category:'Mineral',
        components:['Limestone','Clay','Gypsum'], sources_natural:['Limestone and clay quarries'],
        properties:{ density:'1.5 g/cm¬≥ (powder)', setting_time:'30-90 minutes initial', compressive_strength:'20-60 MPa (with water)' },
        uses:['Concrete production','Mortar','Grout','Stucco'],
        processing:'Limestone + Clay ‚Üí Kiln (1450¬∞C) ‚Üí Clinker ‚Üí Grinding with gypsum ‚Üí Cement',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/cement-statistics-and-information'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Cement'}] },
      { name:'Brick', type:'processed', category:'Mineral',
        components:['Clay','Shale'], sources_natural:['Clay pits and shale quarries'],
        properties:{ density:'1.8-2.0 g/cm¬≥', compressive_strength:'10-35 MPa', water_absorption:'5-20%' },
        uses:['Walls','Paving','Chimneys','Fireplaces','Landscaping'],
        processing:'Clay ‚Üí Mixing ‚Üí Molding/Extrusion ‚Üí Drying ‚Üí Kiln firing (900-1100¬∞C) ‚Üí Brick',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Brick'}] },
      { name:'Porcelain', type:'processed', category:'Mineral',
        components:['Kaolin clay','Feldspar','Quartz'], sources_natural:['Kaolin deposits in China, UK, USA'],
        properties:{ density:'2.3-2.5 g/cm¬≥', hardness:'7 Mohs', water_absorption:'<0.5%', firing_temp:'1260-1400 ¬∞C' },
        uses:['Dinnerware','Tiles','Electrical insulators','Dental crowns','Bathroom fixtures'],
        processing:'Kaolin + Feldspar + Quartz ‚Üí Ball milling ‚Üí Shaping ‚Üí Bisque firing ‚Üí Glazing ‚Üí High firing',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Porcelain'}] },
      { name:'Fiberglass', type:'composite', category:'Mineral',
        components:['Glass fibers','Polymer resin'], sources_natural:['Sand (for glass) + petrochemicals (for resin)'],
        properties:{ density:'1.5-2.0 g/cm¬≥', tensile_strength:'1000-3500 MPa', thermal_conductivity:'Low' },
        uses:['Insulation','Boats','Car bodies','Tanks','Surfboards'],
        processing:'Glass melting ‚Üí Fiber drawing ‚Üí Resin impregnation ‚Üí Layup ‚Üí Curing',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Fiberglass'}] },
      { name:'Plastic (Polyethylene)', type:'processed', category:'Synthetic',
        components:['Ethylene (from petroleum)'], sources_natural:['Petroleum refineries'],
        properties:{ density:'0.91-0.97 g/cm¬≥', tensile_strength:'8-33 MPa', melting_point:'115-135 ¬∞C' },
        uses:['Packaging','Bottles','Bags','Pipes','Toys'],
        processing:'Crude oil ‚Üí Cracking ‚Üí Ethylene ‚Üí Polymerization ‚Üí Polyethylene pellets ‚Üí Molding',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Polyethylene'}] },
      { name:'PVC (Polyvinyl Chloride)', type:'processed', category:'Synthetic',
        components:['Vinyl chloride (from ethylene + chlorine)'], sources_natural:['Petroleum + salt (NaCl)'],
        properties:{ density:'1.3-1.45 g/cm¬≥', tensile_strength:'40-60 MPa', melting_point:'100-260 ¬∞C' },
        uses:['Pipes','Window frames','Flooring','Cable insulation','Medical tubing'],
        processing:'Ethylene + Chlorine ‚Üí Vinyl chloride ‚Üí Polymerization ‚Üí PVC resin ‚Üí Extrusion/Molding',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Polyvinyl_chloride'}] },
      { name:'Nylon', type:'processed', category:'Synthetic',
        components:['Adipic acid','Hexamethylenediamine'], sources_natural:['Petroleum-derived chemicals'],
        properties:{ density:'1.13-1.15 g/cm¬≥', tensile_strength:'70-85 MPa', melting_point:'220-260 ¬∞C' },
        uses:['Stockings','Rope','Gears','Carpet','Parachutes','Toothbrush bristles'],
        processing:'Petrochemicals ‚Üí Polymerization ‚Üí Nylon chips ‚Üí Melt spinning ‚Üí Nylon fiber',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Nylon'}] },
      { name:'Carbon Fiber', type:'composite', category:'Synthetic',
        components:['Polyacrylonitrile (PAN)','Epoxy resin'], sources_natural:['Petroleum-derived PAN precursor'],
        properties:{ density:'1.55-1.6 g/cm¬≥', tensile_strength:'3500-7000 MPa', modulus:'230-540 GPa' },
        uses:['Aerospace','Racing cars','Sporting goods','Wind turbine blades','Prosthetics'],
        processing:'PAN fiber ‚Üí Oxidation (200-300¬∞C) ‚Üí Carbonization (1000-3000¬∞C) ‚Üí Surface treatment ‚Üí Resin layup',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Carbon_fiber_reinforced_polymer'}] },
      { name:'Kevlar', type:'processed', category:'Synthetic',
        components:['Para-phenylenediamine','Terephthaloyl chloride'], sources_natural:['Petroleum-derived chemicals'],
        properties:{ density:'1.44 g/cm¬≥', tensile_strength:'3620 MPa', modulus:'112 GPa', heat_resistance:'Decomposes ~450 ¬∞C' },
        uses:['Body armor','Tires','Brake pads','Ropes','Helmets'],
        processing:'Condensation polymerization ‚Üí Wet spinning ‚Üí Drawing ‚Üí Kevlar fiber',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Kevlar'}] },
      { name:'Plywood', type:'composite', category:'Organic',
        components:['Wood veneers','Adhesive'], sources_natural:['Managed forests (softwood and hardwood)'],
        properties:{ density:'0.4-0.7 g/cm¬≥', tensile_strength:'20-70 MPa', thickness:'3-25 mm standard' },
        uses:['Furniture','Subfloors','Wall sheathing','Boats','Formwork'],
        processing:'Logs ‚Üí Peeling (rotary lathe) ‚Üí Veneer drying ‚Üí Gluing ‚Üí Cross-lamination ‚Üí Hot pressing',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Plywood'}] },
      { name:'MDF (Medium-Density Fiberboard)', type:'composite', category:'Organic',
        components:['Wood fibers','Urea-formaldehyde resin'], sources_natural:['Sawmill residues, recycled wood'],
        properties:{ density:'0.6-0.8 g/cm¬≥', tensile_strength:'0.5-1.0 MPa (internal bond)', surface:'Very smooth' },
        uses:['Furniture','Cabinets','Molding','Speaker boxes','Shelving'],
        processing:'Wood chipping ‚Üí Defibration ‚Üí Resin blending ‚Üí Mat forming ‚Üí Hot pressing ‚Üí Sanding',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Medium-density_fibreboard'}] },
      { name:'Coal', type:'raw', category:'Energy',
        components:[], sources_natural:['Coal mines in China, India, USA, Indonesia, Australia'],
        properties:{ energy_content:'24-35 MJ/kg', carbon_content:'60-95%', density:'1.1-1.5 g/cm¬≥' },
        uses:['Electricity generation','Steel production (coking coal)','Cement','Chemical feedstock'],
        processing:'Mining (surface or underground) ‚Üí Washing ‚Üí Crushing ‚Üí Screening ‚Üí Coal',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Coal'}] },
      { name:'Petroleum (Crude Oil)', type:'raw', category:'Energy',
        components:[], sources_natural:['Oil fields in Saudi Arabia, USA, Russia, Canada, Iraq'],
        properties:{ energy_content:'42-47 MJ/kg', density:'0.82-0.95 g/cm¬≥ (API 10-45¬∞)', viscosity:'Varies widely' },
        uses:['Gasoline','Diesel','Jet fuel','Plastics','Lubricants','Asphalt'],
        processing:'Extraction ‚Üí Desalting ‚Üí Fractional distillation ‚Üí Cracking ‚Üí Refining ‚Üí Products',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Petroleum'}] },
      { name:'Natural Gas', type:'raw', category:'Energy',
        components:[], sources_natural:['Gas fields in USA, Russia, Iran, Qatar, Canada'],
        properties:{ energy_content:'38-50 MJ/m¬≥', composition:'70-90% Methane', density:'0.0007-0.0009 g/cm¬≥' },
        uses:['Electricity generation','Heating','Cooking','Fertilizer (ammonia)','Hydrogen production'],
        processing:'Extraction ‚Üí Separation ‚Üí Dehydration ‚Üí Sweetening (H‚ÇÇS removal) ‚Üí Compression/Liquefaction',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center'},{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Natural_gas'}] },
    ];

    let materialTypeFilter = '';
    let selectedMaterial = null;

    function renderMaterialPills() {
      const types = ['raw','processed','composite'];
      document.getElementById('material-type-pills').innerHTML =
        `<span class="filter-pill ${materialTypeFilter===''?'active':''}" onclick="materialTypeFilter='';renderMaterials()">All</span>` +
        types.map(t => `<span class="filter-pill ${materialTypeFilter===t?'active':''}" onclick="materialTypeFilter='${t}';renderMaterials()"><span class="material-type-badge mat-${t}">${t}</span></span>`).join('');
    }

    function renderMaterials() {
      renderMaterialPills();
      const filtered = MATERIALS.filter(m => !materialTypeFilter || m.type === materialTypeFilter);
      document.getElementById('materials-list').innerHTML = filtered.map(m => {
        const chain = m.processing.split('‚Üí').map(s => s.trim());
        const chainHtml = `<div class="processing-chain">${chain.map((s,i) => (i>0?'<span class="chain-arrow">‚Üí</span>':'')+`<span>${s}</span>`).join('')}</div>`;
        return `<div class="material-card" onclick="showMaterialDetail('${m.name.replace(/'/g,"\\'")}')">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.3rem;">
            <span style="font-weight:600;font-size:0.88rem;color:var(--text);">${m.name}</span>
            <span class="material-type-badge mat-${m.type}">${m.type}</span>
          </div>
          <div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.3rem;">${m.category}${m.components.length?' ¬∑ From: '+m.components.join(', '):''}</div>
          ${chainHtml}
        </div>`;
      }).join('');
    }

    function showMaterialDetail(name) {
      const m = MATERIALS.find(x => x.name === name);
      if (!m) return;
      if (selectedMaterial === name) { selectedMaterial = null; document.getElementById('material-detail-slot').innerHTML = ''; return; }
      selectedMaterial = name;
      const propsHtml = Object.entries(m.properties).map(([k,v]) => `<div class="el-prop"><dt>${k.replace(/_/g,' ')}</dt><dd>${v}</dd></div>`).join('');
      const srcLinks = m.references.map(r => `<a href="${r.url}" target="_blank" rel="noopener" style="color:var(--accent);font-size:0.75rem;">${r.name} ‚Üó</a>`).join(' ');
      document.getElementById('material-detail-slot').innerHTML = `
        <div class="element-detail">
          <div style="display:flex;justify-content:space-between;align-items:start;">
            <h3>${m.name} <span class="material-type-badge mat-${m.type}" style="vertical-align:middle;">${m.type}</span></h3>
            <button onclick="selectedMaterial=null;document.getElementById('material-detail-slot').innerHTML=''" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.1rem;">‚úï</button>
          </div>
          <div class="el-props">${propsHtml}</div>
          <div style="margin:0.6rem 0;"><strong style="font-size:0.75rem;color:var(--text-muted);">USES:</strong>
            <div style="display:flex;flex-wrap:wrap;gap:0.3rem;margin-top:0.3rem;">
              ${m.uses.map(u => `<span style="background:rgba(255,136,17,0.1);color:var(--accent);font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:10px;">${u}</span>`).join('')}
            </div>
          </div>
          <div style="margin:0.6rem 0;"><strong style="font-size:0.75rem;color:var(--text-muted);">PROCESSING:</strong>
            <div class="processing-chain" style="margin-top:0.3rem;font-size:0.8rem;">${m.processing.split('‚Üí').map((s,i) => (i>0?'<span class="chain-arrow">‚Üí</span>':'')+`<span>${s.trim()}</span>`).join('')}</div>
          </div>
          ${m.worldData ? `
          <details style="margin-top:0.6rem;border:1px solid var(--border);border-radius:8px;padding:0.4rem 0.6rem;background:rgba(0,255,136,0.03);">
            <summary style="cursor:pointer;font-size:0.8rem;font-weight:600;color:var(--accent);">üåç World Data</summary>
            <div style="margin-top:0.4rem;font-size:0.75rem;line-height:1.6;">
              ${m.worldData.production ? '<div><strong>Annual Production:</strong> '+m.worldData.production.annual+(m.worldData.production.growth?' ('+m.worldData.production.growth+')':'')+'</div>' : ''}
              ${m.worldData.inputChain ? '<div><strong>Input Chain:</strong><ul style="margin:0.2rem 0 0.2rem 1.2rem;padding:0;">'+m.worldData.inputChain.map(ic => '<li>'+ic.material+': '+ic.ratio+'</li>').join('')+'</ul></div>' : ''}
              ${m.worldData.energyCost ? '<div><strong>Energy Cost:</strong> '+m.worldData.energyCost+'</div>' : ''}
              ${m.worldData.topProducers ? '<div><strong>Top Producers:</strong> '+m.worldData.topProducers.join(', ')+'</div>' : ''}
              ${m.worldData.co2 ? '<div><strong>CO‚ÇÇ Footprint:</strong> '+m.worldData.co2+'</div>' : ''}
            </div>
          </details>` : ''}
          <div style="margin-top:0.5rem;">${srcLinks}</div>
        </div>`;
    }
    renderMaterials();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // WORLD DASHBOARD ‚Äî Chart & Facts
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    (function initWorldDash() {
      // Bar chart ‚Äî top resources by production value
      const chartData = [
        {label:'Oil',value:3200,color:'#444'},
        {label:'Coal',value:900,color:'#666'},
        {label:'Iron',value:300,color:'#b44'},
        {label:'Gold',value:215,color:'#da0'},
        {label:'Copper',value:187,color:'#c73'},
        {label:'Al',value:166,color:'#888'},
        {label:'Gas',value:150,color:'#69c'},
        {label:'Ni',value:58,color:'#5a5'},
        {label:'Zn',value:35,color:'#77a'},
        {label:'Li',value:22,color:'#c6f'},
      ];
      const canvas = document.getElementById('world-dash-chart');
      if (canvas && canvas.getContext) {
        const ctx = canvas.getContext('2d');
        const W = canvas.width, H = canvas.height;
        const maxVal = Math.max(...chartData.map(d=>d.value));
        const barW = (W - 80) / chartData.length;
        const topPad = 25, bottomPad = 35, leftPad = 45;
        ctx.fillStyle = 'rgba(255,255,255,0.06)';
        ctx.fillRect(0,0,W,H);
        ctx.fillStyle = '#aaa'; ctx.font = '11px system-ui';
        ctx.fillText('Top Resources by Annual Value ($B)', leftPad, 14);
        chartData.forEach((d,i) => {
          const barH = (d.value / maxVal) * (H - topPad - bottomPad);
          const x = leftPad + i * barW + 4;
          const y = H - bottomPad - barH;
          ctx.fillStyle = d.color;
          ctx.fillRect(x, y, barW - 8, barH);
          ctx.fillStyle = '#ccc'; ctx.font = '9px system-ui';
          ctx.save(); ctx.translate(x + barW/2 - 4, H - 5);
          ctx.rotate(-0.5); ctx.fillText(d.label, 0, 0); ctx.restore();
          ctx.fillStyle = '#eee'; ctx.font = '9px system-ui';
          ctx.fillText('$'+d.value+'B', x + 2, y - 3);
        });
      }
      // Rotating facts
      const facts = [
        'üí° Earth produces enough food for 10+ billion people ‚Äî waste is the problem, not production.',
        '‚õèÔ∏è Most "scarce" resources have 50-200+ years of known reserves at current consumption.',
        '‚òÄÔ∏è Solar electricity is now cheaper than coal in most markets worldwide.',
        'üìâ Global extreme poverty dropped from 36% to 9% in 25 years.',
        'üìö Global literacy has risen from 12% (1820) to 87% today.',
        'üë∂ Child mortality has dropped 60% since 1990.',
        'üîã Global battery production tripled in 3 years (2021-2024).',
        'üåä Earth has 1.4 billion km¬≥ of water ‚Äî desalination costs have dropped 70% since 2000.',
        'üèóÔ∏è Humanity produces 4.1 billion tonnes of cement every year ‚Äî enough for 33B tonnes of concrete.',
        '‚ö° A single uranium fuel pellet (7g) contains as much energy as 1 tonne of coal.',
        'üåç The world\'s proven oil reserves today are larger than they were 40 years ago despite consumption.',
        'üöÄ Humanity launches 200+ rockets per year ‚Äî double the rate of a decade ago.',
      ];
      const factEl = document.getElementById('world-dash-fact');
      if (factEl) {
        let idx = Math.floor(Math.random() * facts.length);
        factEl.textContent = facts[idx];
        setInterval(() => { idx = (idx + 1) % facts.length; factEl.textContent = facts[idx]; }, 12000);
      }
    })();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PERSONAL INVENTORY
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const INV_CATEGORIES = [
      {id:'Vehicle',icon:'üöó'},{id:'Clothing',icon:'üëï'},{id:'Electronics',icon:'üíª'},{id:'Tools',icon:'üîß'},
      {id:'Furniture',icon:'ü™ë'},{id:'Kitchen',icon:'üç≥'},{id:'Books/Media',icon:'üìö'},{id:'Gaming',icon:'üéÆ'},
      {id:'Home',icon:'üè†'},{id:'Other',icon:'üì¶'}
    ];

    (function populateInvCategories() {
      const sel = document.getElementById('inv-category');
      const filterSel = document.getElementById('inv-category-filter');
      INV_CATEGORIES.forEach(c => {
        sel.innerHTML += `<option value="${c.id}">${c.icon} ${c.id}</option>`;
        filterSel.innerHTML += `<option value="${c.id}">${c.icon} ${c.id}</option>`;
      });
    })();

    function loadInventory() { try { return JSON.parse(localStorage.getItem('humanity_inventory')) || []; } catch { return []; } }
    function saveInventory(items) { localStorage.setItem('humanity_inventory', JSON.stringify(items)); }

    function renderInventory() {
      const items = loadInventory();
      const catFilter = document.getElementById('inv-category-filter').value;
      const search = (document.getElementById('inv-search').value || '').toLowerCase();
      const filtered = items.filter(item => {
        if (catFilter && item.category !== catFilter) return false;
        if (search && !item.name.toLowerCase().includes(search) && !(item.tags||[]).some(t => t.toLowerCase().includes(search)) && !(item.category||'').toLowerCase().includes(search)) return false;
        return true;
      });
      const catIcon = (id) => (INV_CATEGORIES.find(c => c.id === id) || {icon:'üì¶'}).icon;
      document.getElementById('inventory-list').innerHTML = filtered.length === 0
        ? '<div style="color:var(--text-muted);font-size:0.82rem;font-style:italic;padding:1rem;text-align:center;grid-column:1/-1;">No items yet ‚Äî click "+ Add Item" to start</div>'
        : filtered.map(item => `
          <div class="inv-item">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.3rem;">
              <span style="font-weight:600;font-size:0.88rem;">${catIcon(item.category)} ${escHtml(item.name)}</span>
              <div style="display:flex;gap:0.3rem;">
                <button onclick="listInventoryForSale('${item.id}')" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:0.65rem;" title="List for Sale">üì¢</button>
                <button onclick="editInventoryItem('${item.id}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.75rem;" title="Edit">‚úèÔ∏è</button>
                <button onclick="deleteInventoryItem('${item.id}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.75rem;" title="Delete">üóëÔ∏è</button>
              </div>
            </div>
            <div style="font-size:0.72rem;color:var(--text-muted);">
              ${item.category}${item.subcategory?' ¬∑ '+escHtml(item.subcategory):''} ¬∑ Qty: ${item.quantity||1} ¬∑ ${item.condition||'Good'}
            </div>
            ${item.location?`<div style="font-size:0.7rem;color:var(--text-muted);margin-top:0.15rem;">üìç ${escHtml(item.location)}</div>`:''}
            ${item.description?`<div style="font-size:0.75rem;color:var(--text);margin-top:0.3rem;">${escHtml(item.description)}</div>`:''}
            ${(item.tags||[]).length?`<div style="display:flex;flex-wrap:wrap;gap:0.2rem;margin-top:0.3rem;">${item.tags.map(t=>`<span style="background:rgba(255,255,255,0.05);font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:8px;color:var(--text-muted);">#${escHtml(t)}</span>`).join('')}</div>`:''}
          </div>`).join('');
    }

    function openInventoryModal(editId) {
      document.getElementById('inv-modal-title').textContent = editId ? 'Edit Item' : 'Add Item';
      document.getElementById('inv-edit-id').value = editId || '';
      if (editId) {
        const item = loadInventory().find(i => i.id === editId);
        if (!item) return;
        document.getElementById('inv-name').value = item.name || '';
        document.getElementById('inv-category').value = item.category || 'Other';
        document.getElementById('inv-subcategory').value = item.subcategory || '';
        document.getElementById('inv-description').value = item.description || '';
        document.getElementById('inv-quantity').value = item.quantity || 1;
        document.getElementById('inv-condition').value = item.condition || 'Good';
        document.getElementById('inv-acquired').value = item.acquired || '';
        document.getElementById('inv-location').value = item.location || '';
        document.getElementById('inv-value').value = item.value || '';
        document.getElementById('inv-notes').value = item.notes || '';
        document.getElementById('inv-tags').value = (item.tags||[]).join(', ');
      } else {
        ['inv-name','inv-subcategory','inv-description','inv-acquired','inv-location','inv-value','inv-notes','inv-tags'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('inv-quantity').value = 1;
        document.getElementById('inv-condition').value = 'Good';
        document.getElementById('inv-category').value = 'Other';
      }
      document.getElementById('inv-modal').classList.add('open');
    }
    function closeInventoryModal() { document.getElementById('inv-modal').classList.remove('open'); }
    function editInventoryItem(id) { openInventoryModal(id); }
    function deleteInventoryItem(id) {
      if (!confirm('Delete this item?')) return;
      saveInventory(loadInventory().filter(i => i.id !== id));
      renderInventory();
    }
    function saveInventoryItem() {
      const name = document.getElementById('inv-name').value.trim();
      if (!name) { document.getElementById('inv-name').style.borderColor = '#e55'; return; }
      const editId = document.getElementById('inv-edit-id').value;
      const items = loadInventory();
      const item = {
        id: editId || Date.now().toString(36) + Math.random().toString(36).slice(2,6),
        name,
        category: document.getElementById('inv-category').value,
        subcategory: document.getElementById('inv-subcategory').value.trim(),
        description: document.getElementById('inv-description').value.trim(),
        quantity: parseInt(document.getElementById('inv-quantity').value) || 1,
        condition: document.getElementById('inv-condition').value,
        acquired: document.getElementById('inv-acquired').value.trim(),
        location: document.getElementById('inv-location').value.trim(),
        value: document.getElementById('inv-value').value.trim(),
        notes: document.getElementById('inv-notes').value.trim(),
        tags: document.getElementById('inv-tags').value.split(',').map(t => t.trim()).filter(Boolean),
      };
      if (editId) {
        const idx = items.findIndex(i => i.id === editId);
        if (idx >= 0) items[idx] = item; else items.push(item);
      } else {
        items.push(item);
      }
      saveInventory(items);
      closeInventoryModal();
      renderInventory();
    }

    function exportInventory() {
      const data = JSON.stringify(loadInventory(), null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'humanity-inventory-' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
    }
    function importInventory(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          if (!Array.isArray(imported)) throw new Error('Not an array');
          const existing = loadInventory();
          const merged = [...existing, ...imported.map(i => ({...i, id: i.id || Date.now().toString(36)+Math.random().toString(36).slice(2,6)}))];
          saveInventory(merged);
          renderInventory();
          alert('Imported ' + imported.length + ' items.');
        } catch(err) { alert('Import failed: ' + err.message); }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // Close inv modal on backdrop
    document.getElementById('inv-modal').addEventListener('click', function(e) { if (e.target === this) closeInventoryModal(); });

    renderInventory();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ASSET LIBRARY
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let assetLibrary = [];
    let assetCategoryFilter = '';
    let assetViewMode = 'grid'; // 'grid' or 'list'
    let currentPreviewAsset = null;

    function loadAssetLibrary() {
      try { return JSON.parse(localStorage.getItem('humanity_assets')) || []; } catch { return []; }
    }
    function saveAssetLibrary(assets) {
      localStorage.setItem('humanity_assets', JSON.stringify(assets));
    }

    assetLibrary = loadAssetLibrary();

    // Drag-and-drop
    const dropzone = document.getElementById('asset-dropzone');
    if (dropzone) {
      dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.style.borderColor = 'var(--accent)'; dropzone.style.background = 'rgba(255,136,17,0.05)'; });
      dropzone.addEventListener('dragleave', () => { dropzone.style.borderColor = 'var(--border)'; dropzone.style.background = ''; });
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.style.borderColor = 'var(--border)';
        dropzone.style.background = '';
        if (e.dataTransfer.files.length) handleAssetFiles(e.dataTransfer.files);
      });
    }

    function categorizeFile(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      if (['png','jpg','jpeg','gif','webp','svg'].includes(ext)) return 'image';
      if (['blend','stl','obj','gltf','glb'].includes(ext)) return '3d_model';
      if (['mp3','wav','ogg'].includes(ext)) return 'audio';
      if (['pdf','txt','md'].includes(ext)) return 'document';
      return 'document';
    }

    function fileTypeIcon(category) {
      const icons = { image: 'üñºÔ∏è', '3d_model': 'üßä', audio: 'üéµ', document: 'üìÑ' };
      return icons[category] || 'üìé';
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / 1048576).toFixed(1) + ' MB';
    }

    async function handleAssetFiles(files) {
      const token = localStorage.getItem('humanity_upload_token');
      const key = localStorage.getItem('humanity_key');
      if (!token && !key) { alert('You must be connected to upload files.'); return; }

      const progress = document.getElementById('asset-upload-progress');
      const bar = document.getElementById('asset-upload-bar');
      const status = document.getElementById('asset-upload-status');
      progress.style.display = '';

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        bar.style.width = ((i / files.length) * 100) + '%';
        status.textContent = `Uploading ${file.name} (${i + 1}/${files.length})‚Ä¶`;

        try {
          const form = new FormData();
          form.append('file', file, file.name);
          const params = token ? `?token=${encodeURIComponent(token)}` : `?key=${encodeURIComponent(key)}`;
          const res = await fetch('/api/upload' + params, { method: 'POST', body: form });
          if (!res.ok) { const err = await res.text(); throw new Error(err); }
          const data = await res.json();

          const category = categorizeFile(file.name);
          const asset = {
            id: Date.now().toString(36) + Math.random().toString(36).slice(2, 8),
            filename: file.name,
            url: data.url,
            type: data.type || category,
            category: category,
            tags: [],
            size: file.size,
            uploadedAt: new Date().toISOString(),
            description: '',
          };

          assetLibrary.unshift(asset);
          saveAssetLibrary(assetLibrary);

          // Also create server-side record
          try {
            await fetch('/api/assets', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                filename: asset.filename,
                url: asset.url,
                file_type: asset.type,
                category: asset.category,
                tags: asset.tags,
                size_bytes: asset.size,
                description: asset.description,
                owner_key: key,
              }),
            });
          } catch (e) { console.warn('Failed to create server asset record:', e); }
        } catch (err) {
          console.error('Upload failed:', err);
          status.textContent = `Failed: ${file.name} ‚Äî ${err.message}`;
          await new Promise(r => setTimeout(r, 2000));
        }
      }

      bar.style.width = '100%';
      status.textContent = 'Done!';
      setTimeout(() => { progress.style.display = 'none'; bar.style.width = '0%'; }, 1500);
      renderAssets();
      updateAssetTagFilter();
    }

    function setAssetCategory(cat) {
      assetCategoryFilter = cat;
      document.querySelectorAll('[id^="asset-cat-"]').forEach(el => el.classList.remove('active'));
      document.getElementById('asset-cat-' + (cat || 'all')).classList.add('active');
      renderAssets();
    }

    function toggleAssetView() {
      assetViewMode = assetViewMode === 'grid' ? 'list' : 'grid';
      const btn = document.getElementById('asset-view-toggle');
      btn.textContent = assetViewMode === 'grid' ? '‚ò∞' : '‚ñ¶';
      renderAssets();
    }

    function renderAssets() {
      const search = (document.getElementById('asset-search').value || '').toLowerCase();
      const tagFilter = document.getElementById('asset-tag-filter').value;

      let filtered = assetLibrary.filter(a => {
        if (assetCategoryFilter && a.category !== assetCategoryFilter) return false;
        if (tagFilter && !(a.tags || []).includes(tagFilter)) return false;
        if (search && !a.filename.toLowerCase().includes(search) && !(a.tags || []).some(t => t.toLowerCase().includes(search)) && !(a.description || '').toLowerCase().includes(search)) return false;
        return true;
      });

      const grid = document.getElementById('asset-grid');
      const empty = document.getElementById('asset-empty');

      if (filtered.length === 0) {
        grid.innerHTML = '';
        empty.style.display = '';
        return;
      }
      empty.style.display = 'none';

      if (assetViewMode === 'grid') {
        grid.style.gridTemplateColumns = 'repeat(auto-fill,minmax(180px,1fr))';
        grid.innerHTML = filtered.map(a => {
          const icon = fileTypeIcon(a.category);
          const thumb = a.category === 'image' ? `<div style="height:100px;background:url('${a.url}') center/cover no-repeat;border-radius:6px 6px 0 0;"></div>` :
            `<div style="height:100px;display:flex;align-items:center;justify-content:center;background:var(--bg-panel);border-radius:6px 6px 0 0;font-size:2rem;">${icon}</div>`;
          return `<div onclick="previewAsset('${a.id}')" style="background:var(--bg-card);border:1px solid var(--border);border-radius:6px;overflow:hidden;cursor:pointer;transition:border-color 0.2s;" onmouseenter="this.style.borderColor='rgba(255,136,17,0.3)'" onmouseleave="this.style.borderColor='var(--border)'">
            ${thumb}
            <div style="padding:0.5rem;">
              <div style="font-size:0.78rem;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${escHtml(a.filename)}">${escHtml(a.filename)}</div>
              <div style="font-size:0.65rem;color:var(--text-muted);display:flex;justify-content:space-between;">
                <span>${formatFileSize(a.size)}</span>
                <span>${a.uploadedAt ? new Date(a.uploadedAt).toLocaleDateString() : ''}</span>
              </div>
              ${(a.tags || []).length ? `<div style="display:flex;gap:0.2rem;flex-wrap:wrap;margin-top:0.3rem;">${a.tags.slice(0, 3).map(t => `<span style="font-size:0.55rem;background:rgba(255,136,17,0.15);color:var(--accent);padding:0.1rem 0.3rem;border-radius:3px;">${escHtml(t)}</span>`).join('')}</div>` : ''}
            </div>
          </div>`;
        }).join('');
      } else {
        grid.style.gridTemplateColumns = '1fr';
        grid.innerHTML = filtered.map(a => {
          const icon = fileTypeIcon(a.category);
          return `<div onclick="previewAsset('${a.id}')" style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:border-color 0.2s;" onmouseenter="this.style.borderColor='rgba(255,136,17,0.3)'" onmouseleave="this.style.borderColor='var(--border)'">
            <span style="font-size:1.3rem;">${icon}</span>
            <div style="flex:1;min-width:0;">
              <div style="font-size:0.8rem;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escHtml(a.filename)}</div>
              <div style="font-size:0.65rem;color:var(--text-muted);">${formatFileSize(a.size)} ¬∑ ${a.uploadedAt ? new Date(a.uploadedAt).toLocaleDateString() : ''}</div>
            </div>
            <div style="display:flex;gap:0.2rem;">${(a.tags || []).slice(0, 2).map(t => `<span style="font-size:0.55rem;background:rgba(255,136,17,0.15);color:var(--accent);padding:0.1rem 0.3rem;border-radius:3px;">${escHtml(t)}</span>`).join('')}</div>
          </div>`;
        }).join('');
      }
    }

    function previewAsset(id) {
      const asset = assetLibrary.find(a => a.id === id);
      if (!asset) return;
      currentPreviewAsset = asset;

      document.getElementById('asset-preview-title').textContent = asset.filename;

      // Build preview content
      let content = '';
      if (asset.category === 'image') {
        content = `<img src="${asset.url}" style="max-width:100%;max-height:400px;border-radius:8px;display:block;margin:0 auto;">`;
      } else if (asset.category === 'audio') {
        content = `<audio controls src="${asset.url}" style="width:100%;"></audio>`;
      } else if (asset.category === '3d_model') {
        const ext = asset.filename.split('.').pop().toUpperCase();
        content = `<div style="text-align:center;padding:2rem;background:var(--bg-panel);border-radius:8px;">
          <div style="font-size:3rem;margin-bottom:0.5rem;">üßä</div>
          <div style="font-size:0.9rem;color:var(--text);">${ext} 3D Model</div>
          <div style="font-size:0.8rem;color:var(--text-muted);margin-top:0.3rem;">${formatFileSize(asset.size)}</div>
          <a href="${asset.url}" download="${escHtml(asset.filename)}" style="display:inline-block;margin-top:0.8rem;padding:0.4rem 1rem;background:var(--accent);color:#fff;border-radius:6px;text-decoration:none;font-size:0.8rem;">‚¨áÔ∏è Download</a>
        </div>`;
      } else if (asset.category === 'document') {
        const ext = asset.filename.split('.').pop().toLowerCase();
        if (ext === 'txt' || ext === 'md') {
          content = `<div id="asset-text-preview" style="background:var(--bg-panel);padding:1rem;border-radius:8px;font-size:0.8rem;color:var(--text);max-height:400px;overflow-y:auto;white-space:pre-wrap;font-family:monospace;">Loading‚Ä¶</div>`;
          fetch(asset.url).then(r => r.text()).then(text => {
            const el = document.getElementById('asset-text-preview');
            if (el) el.textContent = text.slice(0, 10000);
          }).catch(() => {});
        } else {
          content = `<div style="text-align:center;padding:2rem;">
            <div style="font-size:3rem;">üìÑ</div>
            <a href="${asset.url}" target="_blank" style="color:var(--accent);font-size:0.85rem;">Open Document</a>
          </div>`;
        }
      }
      document.getElementById('asset-preview-content').innerHTML = content;

      // Meta info
      document.getElementById('asset-preview-meta').innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.3rem;">
          <div>üìÅ ${escHtml(asset.category)}</div>
          <div>üíæ ${formatFileSize(asset.size)}</div>
          <div>üìÖ ${asset.uploadedAt ? new Date(asset.uploadedAt).toLocaleString() : 'Unknown'}</div>
          <div>üîó <a href="${asset.url}" target="_blank" style="color:var(--accent);">Direct Link</a></div>
        </div>
        ${asset.description ? `<div style="margin-top:0.4rem;">üìù ${escHtml(asset.description)}</div>` : ''}
      `;

      // Tags
      document.getElementById('asset-preview-tags').innerHTML = (asset.tags || []).length ?
        `<div style="display:flex;gap:0.3rem;flex-wrap:wrap;">${asset.tags.map(t => `<span style="font-size:0.7rem;background:rgba(255,136,17,0.15);color:var(--accent);padding:0.15rem 0.4rem;border-radius:4px;">${escHtml(t)}</span>`).join('')}</div>` : '';

      document.getElementById('asset-preview-modal').style.display = '';
    }

    function closeAssetPreview() {
      document.getElementById('asset-preview-modal').style.display = 'none';
      currentPreviewAsset = null;
    }

    function editAssetTags() {
      if (!currentPreviewAsset) return;
      document.getElementById('asset-tag-input').value = (currentPreviewAsset.tags || []).join(', ');
      document.getElementById('asset-tag-modal').style.display = '';
    }

    function closeAssetTagModal() {
      document.getElementById('asset-tag-modal').style.display = 'none';
    }

    function saveAssetTags() {
      if (!currentPreviewAsset) return;
      const tags = document.getElementById('asset-tag-input').value.split(',').map(t => t.trim()).filter(Boolean);
      const idx = assetLibrary.findIndex(a => a.id === currentPreviewAsset.id);
      if (idx >= 0) {
        assetLibrary[idx].tags = tags;
        currentPreviewAsset.tags = tags;
        saveAssetLibrary(assetLibrary);
        renderAssets();
        updateAssetTagFilter();
        // Re-render tags in preview
        document.getElementById('asset-preview-tags').innerHTML = tags.length ?
          `<div style="display:flex;gap:0.3rem;flex-wrap:wrap;">${tags.map(t => `<span style="font-size:0.7rem;background:rgba(255,136,17,0.15);color:var(--accent);padding:0.15rem 0.4rem;border-radius:4px;">${escHtml(t)}</span>`).join('')}</div>` : '';
      }
      closeAssetTagModal();
    }

    function shareAsset() {
      if (!currentPreviewAsset) return;
      const url = window.location.origin + currentPreviewAsset.url;
      navigator.clipboard.writeText(url).then(() => {
        alert('Link copied to clipboard!');
      }).catch(() => {
        prompt('Share link:', url);
      });
    }

    function listAssetOnMarket() {
      if (!currentPreviewAsset) return;
      const a = currentPreviewAsset;
      closeAssetPreview();
      switchTab('market');
      showMarketSection('marketplace');

      // Determine category mapping
      const catMap = { 'image': 'Crafts', '3d_model': 'Gaming', 'audio': 'Books/Media', 'document': 'Books/Media' };
      const modelCats = ['Vehicles','Architecture','Characters','Props','Weapons','Nature','Sci-Fi','Other'];
      const category = a.category === '3d_model' ? '3D Models' : (catMap[a.category] || 'Other');

      openListingModal({
        title: a.filename,
        description: (a.description || '') + `\n\nFile: ${a.filename} (${formatFileSize(a.size)})` + (a.category === '3d_model' ? `\nFormat: ${a.filename.split('.').pop().toUpperCase()}` : ''),
        category: category,
        condition: 'N/A',
        price: 'Free (donations welcome)',
        asset_url: a.url,
      });
    }

    function deleteCurrentAsset() {
      if (!currentPreviewAsset) return;
      if (!confirm('Delete this asset?')) return;
      const id = currentPreviewAsset.id;
      assetLibrary = assetLibrary.filter(a => a.id !== id);
      saveAssetLibrary(assetLibrary);
      closeAssetPreview();
      renderAssets();
      updateAssetTagFilter();

      // Also try to delete server-side
      const key = localStorage.getItem('humanity_key');
      const token = localStorage.getItem('humanity_upload_token');
      const params = token ? `?token=${encodeURIComponent(token)}` : (key ? `?key=${encodeURIComponent(key)}` : '');
      fetch(`/api/assets/${id}${params}`, { method: 'DELETE' }).catch(() => {});
    }

    function updateAssetTagFilter() {
      const allTags = new Set();
      assetLibrary.forEach(a => (a.tags || []).forEach(t => allTags.add(t)));
      const sel = document.getElementById('asset-tag-filter');
      const current = sel.value;
      sel.innerHTML = '<option value="">All Tags</option>' + [...allTags].sort().map(t => `<option value="${escHtml(t)}"${t === current ? ' selected' : ''}>${escHtml(t)}</option>`).join('');
    }

    // Include assets in universal search
    const origUniversalSearch = universalSearch;
    universalSearch = function(query) {
      origUniversalSearch(query);
      if (!query || query.length < 2) return;
      const q = query.toLowerCase();
      const assetHits = assetLibrary.filter(a => a.filename.toLowerCase().includes(q) || (a.tags || []).some(t => t.toLowerCase().includes(q)));
      if (assetHits.length > 0) {
        const results = document.getElementById('universal-search-results');
        const existingResults = window.universalSearchResults || [];
        assetHits.slice(0, 5).forEach((a, i) => {
          existingResults.push(() => previewAsset(a.id));
          const div = document.createElement('div');
          div.className = 'catalog-result-item';
          div.onclick = () => previewAsset(a.id);
          div.innerHTML = `<span class="catalog-result-badge" style="background:#ff881122;color:#ff8811;">Asset</span><span style="color:var(--text);">${escHtml(a.filename)}</span>`;
          results.appendChild(div);
        });
        window.universalSearchResults = existingResults;
      }
    };

    renderAssets();
    updateAssetTagFilter();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MARKETPLACE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const STORE_DIRECTORY = [
      { name: "Amazon", url: "https://amazon.com", icon: "üè™", category: "General", description: "Everything store" },
      { name: "Walmart", url: "https://walmart.com", icon: "üè™", category: "General", description: "Everyday low prices" },
      { name: "Etsy", url: "https://etsy.com", icon: "üé®", category: "Handmade & Vintage", description: "Handmade, vintage, and unique goods" },
      { name: "eBay", url: "https://ebay.com", icon: "üè∑Ô∏è", category: "Auctions & Resale", description: "Buy and sell anything" },
      { name: "Newegg", url: "https://newegg.com", icon: "üíª", category: "Electronics", description: "Computer hardware and electronics" },
      { name: "Home Depot", url: "https://homedepot.com", icon: "üî®", category: "Home & Garden", description: "Home improvement and tools" },
      { name: "REI", url: "https://rei.com", icon: "‚õ∫", category: "Outdoors", description: "Outdoor gear and clothing" },
      { name: "Steam", url: "https://store.steampowered.com", icon: "üéÆ", category: "Gaming", description: "PC games and software" },
      { name: "GOG", url: "https://gog.com", icon: "üéÆ", category: "Gaming", description: "DRM-free games" },
      { name: "Bandcamp", url: "https://bandcamp.com", icon: "üéµ", category: "Music", description: "Independent music" },
      { name: "Ko-fi", url: "https://ko-fi.com", icon: "‚òï", category: "Creator Support", description: "Support creators directly" },
      { name: "GitHub Sponsors", url: "https://github.com/sponsors", icon: "üíù", category: "Creator Support", description: "Fund open source developers" },
    ];

    const LISTING_CATEGORIES = ['Electronics','Vehicles','Clothing','Tools','Furniture','Home','Books/Media','Gaming','Sports','Crafts','Food/Garden','Services','3D Models','Other'];
    const LISTING_CONDITIONS = ['New','Like New','Good','Fair','Poor','N/A'];
    const CATEGORY_COLORS = {Electronics:'#08f',Vehicles:'#f80',Clothing:'#f0a',Tools:'#fa0',Furniture:'#a66',Home:'#4a8','Books/Media':'#84f',Gaming:'#0cf',Sports:'#4c4',Crafts:'#c4a','Food/Garden':'#6a4',Services:'#48f','3D Models':'#a6f',Other:'#888'};

    let marketListings = [];
    let marketWs = null;
    let ws = null; // Alias for streaming code to use
    let marketMyKey = null;
    let marketMyName = null;
    let marketMyRole = '';
    let marketCurrentSection = 'marketplace';

    function showMarketSection(section) {
      marketCurrentSection = section;
      ['marketplace','stores','mylistings'].forEach(s => {
        const el = document.getElementById('market-section-' + s);
        const btn = document.getElementById('market-nav-' + s);
        if (el) el.style.display = s === section ? '' : 'none';
        if (btn) btn.className = s === section ? 'btn btn-clickable' : 'btn';
      });
      const createBtn = document.getElementById('market-create-btn');
      if (createBtn) createBtn.style.display = (section === 'marketplace' && canCreateListing()) ? '' : 'none';
      if (section === 'stores') renderStoreDirectory();
      if (section === 'mylistings') renderMyListings();
      if (section === 'marketplace') renderMarketListings();
    }

    function canCreateListing() {
      return marketMyRole === 'verified' || marketMyRole === 'donor' || marketMyRole === 'mod' || marketMyRole === 'admin';
    }

    function marketConnect() {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      marketWs = new WebSocket(proto + '//' + location.host + '/ws');
      marketWs.onopen = () => {
        const storedKey = localStorage.getItem('humanity_key');
        const storedName = localStorage.getItem('humanity_name');
        if (storedKey) {
          marketMyKey = storedKey;
          marketMyName = storedName;
          marketWs.send(JSON.stringify({ type: 'identify', public_key: storedKey, display_name: storedName || null }));
        } else {
          marketMyKey = 'viewer_' + Math.random().toString(36).slice(2, 10);
          marketWs.send(JSON.stringify({ type: 'identify', public_key: marketMyKey, display_name: null }));
        }
      };
      ws = marketWs; // Alias for streaming code
      window._humanityWs = marketWs; // Alias for Skill DNA
      marketWs.onmessage = (e) => {
        try {
          const msg = JSON.parse(e.data);
          handleMarketMessage(msg);
          // Route stream messages
          if (msg.type && msg.type.startsWith('stream_')) {
            streamHandleMessage(msg);
          }
          // Handle skill verification messages via Private/system
          if (msg.type === 'private' && msg.message) {
            if (msg.message.startsWith('__skill_verify_req__:')) {
              try {
                const payload = JSON.parse(msg.message.slice('__skill_verify_req__:'.length));
                if (confirm(`${payload.from_name} claims ${payload.skill_id} Lv ${payload.level} ‚Äî can you verify?\n\nClick OK to verify, Cancel to decline.`)) {
                  const note = prompt('Add a note (optional):') || 'Verified';
                  window._humanityWs.send(JSON.stringify({ type: 'skill_verify_response', skill_id: payload.skill_id, to_key: payload.from_key, approved: true, note }));
                }
              } catch(e) {}
            }
            if (msg.message.startsWith('__skill_verify_resp__:')) {
              try {
                const payload = JSON.parse(msg.message.slice('__skill_verify_resp__:'.length));
                if (window._sdHandleVerifyResponse) window._sdHandleVerifyResponse(payload);
              } catch(e) {}
            }
          }
        } catch {}
      };
      marketWs.onclose = () => { setTimeout(marketConnect, 3000); };
      marketWs.onerror = () => {};
    }

    function handleMarketMessage(msg) {
      switch (msg.type) {
        case 'peer_list':
          if (msg.peers && marketMyKey) {
            const me = msg.peers.find(p => p.public_key === marketMyKey);
            if (me) {
              marketMyRole = me.role || '';
              marketMyName = me.display_name || marketMyName;
              if (me.upload_token) localStorage.setItem('humanity_upload_token', me.upload_token);
            }
          }
          updateMarketPermissions();
          // Request listings
          if (marketWs && marketWs.readyState === 1) {
            marketWs.send(JSON.stringify({ type: 'listing_browse' }));
          }
          // Request stream info
          streamRequestInfo();
          break;
        case 'listing_list':
          marketListings = msg.listings || [];
          renderMarketListings();
          renderMyListings();
          break;
        case 'listing_new':
          if (msg.listing) {
            const existing = marketListings.findIndex(l => l.id === msg.listing.id);
            if (existing >= 0) marketListings[existing] = msg.listing;
            else marketListings.unshift(msg.listing);
            renderMarketListings();
            renderMyListings();
          }
          break;
        case 'listing_updated':
          if (msg.listing) {
            const idx = marketListings.findIndex(l => l.id === msg.listing.id);
            if (idx >= 0) marketListings[idx] = msg.listing;
            renderMarketListings();
            renderMyListings();
          }
          break;
        case 'listing_deleted':
          if (msg.id) {
            marketListings = marketListings.filter(l => l.id !== msg.id);
            renderMarketListings();
            renderMyListings();
          }
          break;
        case 'system':
          // Ignore system messages in market context
          break;
      }
    }

    function updateMarketPermissions() {
      const createBtn = document.getElementById('market-create-btn');
      if (createBtn) createBtn.style.display = (marketCurrentSection === 'marketplace' && canCreateListing()) ? '' : 'none';
    }

    function renderMarketListings() {
      const search = (document.getElementById('market-search').value || '').toLowerCase();
      const catFilter = document.getElementById('market-category-filter').value;
      const condFilter = document.getElementById('market-condition-filter').value;
      const sort = document.getElementById('market-sort').value;

      let filtered = marketListings.filter(l => {
        if (l.status !== 'active') return false;
        if (catFilter && l.category !== catFilter) return false;
        if (condFilter && l.condition !== condFilter) return false;
        if (search && !l.title.toLowerCase().includes(search) && !(l.description||'').toLowerCase().includes(search) && !(l.seller_name||'').toLowerCase().includes(search)) return false;
        return true;
      });

      if (sort === 'oldest') filtered.sort((a, b) => (a.created_at || '').localeCompare(b.created_at || ''));
      else if (sort === 'alpha') filtered.sort((a, b) => a.title.localeCompare(b.title));
      else filtered.sort((a, b) => (b.created_at || '').localeCompare(a.created_at || ''));

      const grid = document.getElementById('market-listings-grid');
      const empty = document.getElementById('market-listings-empty');
      if (filtered.length === 0) {
        grid.innerHTML = '';
        empty.style.display = '';
      } else {
        empty.style.display = 'none';
        grid.innerHTML = filtered.map(l => renderListingCard(l, false)).join('');
      }
    }

    function renderListingCard(l, showActions) {
      const catColor = CATEGORY_COLORS[l.category] || '#888';
      const isMine = l.seller_key === marketMyKey;
      const isAdmin = marketMyRole === 'admin' || marketMyRole === 'mod';
      const actions = (isMine || showActions) ? `
        <div style="display:flex;gap:0.3rem;margin-top:0.5rem;">
          ${isMine?`<button onclick="editListing('${l.id}')" style="flex:1;padding:0.25rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:4px;color:var(--text-muted);cursor:pointer;font-size:0.7rem;">‚úèÔ∏è Edit</button>`:''}
          ${isMine?`<button onclick="markListingSold('${l.id}')" style="flex:1;padding:0.25rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:4px;color:var(--success);cursor:pointer;font-size:0.7rem;">‚úÖ Sold</button>`:''}
          ${(isMine||isAdmin)?`<button onclick="deleteListing('${l.id}')" style="flex:1;padding:0.25rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:4px;color:var(--error);cursor:pointer;font-size:0.7rem;">üóëÔ∏è Delete</button>`:''}
        </div>` : '';
      const statusBadge = l.status === 'sold' ? '<span style="background:#4a8;color:#fff;font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:4px;margin-left:0.3rem;">SOLD</span>' :
                          l.status === 'withdrawn' ? '<span style="background:#888;color:#fff;font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:4px;margin-left:0.3rem;">WITHDRAWN</span>' : '';
      return `
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:10px;overflow:hidden;cursor:pointer;transition:border-color 0.2s;" onmouseenter="this.style.borderColor='rgba(255,136,17,0.3)'" onmouseleave="this.style.borderColor='var(--border)'" onclick="showListingDetail('${l.id}')">
          <div style="height:120px;background:linear-gradient(135deg,rgba(255,255,255,0.02),rgba(255,255,255,0.06));display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:2rem;">${l.category === '3D Models' ? 'üßä' : 'üì¶'}</div>
          <div style="padding:0.8rem;">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.3rem;">
              <span style="font-weight:600;font-size:0.85rem;color:var(--text);flex:1;">${escHtml(l.title)}${statusBadge}</span>
            </div>
            <div style="font-size:0.95rem;font-weight:700;color:var(--accent);margin-bottom:0.3rem;">${escHtml(l.price || 'Contact for price')}</div>
            <div style="display:flex;gap:0.3rem;flex-wrap:wrap;margin-bottom:0.3rem;">
              <span style="background:${catColor}22;color:${catColor};font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:4px;">${escHtml(l.category)}</span>
              ${l.condition && l.condition !== 'N/A' ? `<span style="background:rgba(255,255,255,0.05);color:var(--text-muted);font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:4px;">${escHtml(l.condition)}</span>` : ''}
            </div>
            <div style="font-size:0.72rem;color:var(--text-muted);">by ${escHtml(l.seller_name || 'Anonymous')}</div>
            ${l.location ? `<div style="font-size:0.68rem;color:var(--text-muted);">üìç ${escHtml(l.location)}</div>` : ''}
            ${actions}
          </div>
        </div>`;
    }

    function showListingDetail(id) {
      const l = marketListings.find(x => x.id === id);
      if (!l) return;
      const isMine = l.seller_key === marketMyKey;
      const isAdmin = marketMyRole === 'admin' || marketMyRole === 'mod';
      const catColor = CATEGORY_COLORS[l.category] || '#888';
      const contactBtn = !isMine ? `<button onclick="contactSeller('${escHtml(l.seller_key)}','${escHtml(l.seller_name||'Seller')}');closeListingDetail()" style="width:100%;padding:0.6rem;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:0.9rem;font-weight:600;margin-top:1rem;">üí¨ Contact Seller</button>` : '';
      document.getElementById('listing-detail-content').innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:start;">
          <h2 style="color:var(--text);margin:0;font-size:1.1rem;">${escHtml(l.title)}</h2>
          <button onclick="closeListingDetail()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.2rem;">‚úï</button>
        </div>
        <div style="font-size:1.3rem;font-weight:700;color:var(--accent);margin:0.8rem 0;">${escHtml(l.price || 'Contact for price')}</div>
        <div style="display:flex;gap:0.4rem;flex-wrap:wrap;margin-bottom:0.8rem;">
          <span style="background:${catColor}22;color:${catColor};font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:4px;">${escHtml(l.category)}</span>
          ${l.condition ? `<span style="background:rgba(255,255,255,0.05);color:var(--text-muted);font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:4px;">${escHtml(l.condition)}</span>` : ''}
          ${l.status !== 'active' ? `<span style="background:${l.status==='sold'?'#4a8':'#888'};color:#fff;font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:4px;">${l.status.toUpperCase()}</span>` : ''}
        </div>
        ${l.description ? `<div style="font-size:0.85rem;color:var(--text);line-height:1.5;margin-bottom:0.8rem;white-space:pre-wrap;">${escHtml(l.description)}</div>` : ''}
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;font-size:0.8rem;color:var(--text-muted);">
          <div>üë§ <strong>${escHtml(l.seller_name || 'Anonymous')}</strong></div>
          ${l.location ? `<div>üìç ${escHtml(l.location)}</div>` : '<div></div>'}
          ${l.payment_methods ? `<div>üí≥ ${escHtml(l.payment_methods)}</div>` : '<div></div>'}
          <div>üìÖ ${l.created_at ? new Date(l.created_at).toLocaleDateString() : 'Unknown'}</div>
        </div>
        ${l.category === '3D Models' ? `
        <div style="background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;padding:0.8rem;margin-top:0.8rem;">
          <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
            <span style="font-size:1.5rem;">üßä</span>
            <span style="font-weight:600;color:var(--text);">3D Model</span>
          </div>
          ${(() => {
            const descLower = (l.description||'').toLowerCase();
            const formats = ['blend','stl','obj','gltf','glb'].filter(f => descLower.includes(f));
            const urlMatch = (l.description||'').match(/\/uploads\/[^\s]+/);
            return `
              ${formats.length ? `<div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.3rem;">Format: ${formats.map(f=>f.toUpperCase()).join(', ')}</div>` : ''}
              ${urlMatch ? `<a href="${escHtml(urlMatch[0])}" download style="display:inline-block;padding:0.4rem 1rem;background:var(--accent);color:#fff;border-radius:6px;text-decoration:none;font-size:0.8rem;font-weight:600;margin-top:0.3rem;">‚¨áÔ∏è Download Model</a>` : ''}
            `;
          })()}
        </div>` : ''}
        ${contactBtn}
        ${isMine || isAdmin ? `
        <div style="display:flex;gap:0.5rem;margin-top:0.8rem;">
          ${isMine?`<button onclick="editListing('${l.id}');closeListingDetail()" class="btn" style="flex:1;min-width:auto;min-height:32px;padding:0.25rem;font-size:0.8rem;">‚úèÔ∏è Edit</button>`:''}
          ${isMine?`<button onclick="markListingSold('${l.id}');closeListingDetail()" class="btn" style="flex:1;min-width:auto;min-height:32px;padding:0.25rem;font-size:0.8rem;color:var(--success);">‚úÖ Mark Sold</button>`:''}
          <button onclick="deleteListing('${l.id}');closeListingDetail()" class="btn" style="flex:1;min-width:auto;min-height:32px;padding:0.25rem;font-size:0.8rem;color:var(--error);">üóëÔ∏è Delete</button>
        </div>` : ''}
      `;
      document.getElementById('listing-detail-modal').style.display = '';
    }

    function closeListingDetail() {
      document.getElementById('listing-detail-modal').style.display = 'none';
    }

    function contactSeller(sellerKey, sellerName) {
      // Navigate to chat and open DM ‚Äî use chat's existing DM system
      // We'll switch to chat tab and trigger a DM open via stored intent
      localStorage.setItem('dm_intent', JSON.stringify({ key: sellerKey, name: sellerName }));
      window.location.href = '/chat';
    }

    function openListingModal(prefill) {
      if (!canCreateListing()) {
        alert('You must be verified to create listings. Ask an admin to verify you.');
        return;
      }
      document.getElementById('listing-modal-title').textContent = prefill && prefill.editId ? 'Edit Listing' : 'Create Listing';
      document.getElementById('listing-edit-id').value = (prefill && prefill.editId) || '';
      document.getElementById('listing-title').value = (prefill && prefill.title) || '';
      document.getElementById('listing-description').value = (prefill && prefill.description) || '';
      document.getElementById('listing-category').value = (prefill && prefill.category) || 'Other';
      document.getElementById('listing-condition').value = (prefill && prefill.condition) || 'Good';
      document.getElementById('listing-price').value = (prefill && prefill.price) || '';
      document.getElementById('listing-payment').value = (prefill && prefill.payment_methods) || '';
      document.getElementById('listing-location').value = (prefill && prefill.location) || '';
      document.getElementById('listing-modal').style.display = '';
      updateListingSubcategory();
    }

    function updateListingSubcategory() {
      const cat = document.getElementById('listing-category').value;
      document.getElementById('listing-3d-subcategory-wrap').style.display = cat === '3D Models' ? '' : 'none';
    }
    // Hook category change
    document.getElementById('listing-category').addEventListener('change', updateListingSubcategory);

    function closeListingModal() {
      document.getElementById('listing-modal').style.display = 'none';
    }

    function submitListing() {
      const title = document.getElementById('listing-title').value.trim();
      if (!title) { document.getElementById('listing-title').style.borderColor = '#e55'; return; }
      const editId = document.getElementById('listing-edit-id').value;
      const data = {
        title,
        description: document.getElementById('listing-description').value.trim(),
        category: document.getElementById('listing-category').value,
        condition: document.getElementById('listing-condition').value,
        price: document.getElementById('listing-price').value.trim(),
        payment_methods: document.getElementById('listing-payment').value.trim(),
        location: document.getElementById('listing-location').value.trim(),
      };
      if (editId) {
        data.id = editId;
        if (marketWs && marketWs.readyState === 1) {
          marketWs.send(JSON.stringify({ type: 'listing_update', ...data }));
        }
      } else {
        data.id = Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
        if (marketWs && marketWs.readyState === 1) {
          marketWs.send(JSON.stringify({ type: 'listing_create', ...data }));
        }
      }
      closeListingModal();
    }

    function editListing(id) {
      const l = marketListings.find(x => x.id === id);
      if (!l) return;
      openListingModal({
        editId: l.id,
        title: l.title,
        description: l.description,
        category: l.category,
        condition: l.condition,
        price: l.price,
        payment_methods: l.payment_methods,
        location: l.location,
      });
    }

    function markListingSold(id) {
      if (!confirm('Mark this listing as sold?')) return;
      if (marketWs && marketWs.readyState === 1) {
        const l = marketListings.find(x => x.id === id);
        if (l) marketWs.send(JSON.stringify({ type: 'listing_update', id, title: l.title, description: l.description, category: l.category, condition: l.condition, price: l.price, payment_methods: l.payment_methods, location: l.location, status: 'sold' }));
      }
    }

    function deleteListing(id) {
      if (!confirm('Delete this listing?')) return;
      if (marketWs && marketWs.readyState === 1) {
        marketWs.send(JSON.stringify({ type: 'listing_delete', id }));
      }
    }

    function renderMyListings() {
      const mine = marketListings.filter(l => l.seller_key === marketMyKey);
      const grid = document.getElementById('my-listings-grid');
      const empty = document.getElementById('my-listings-empty');
      if (mine.length === 0) {
        grid.innerHTML = '';
        empty.style.display = '';
      } else {
        empty.style.display = 'none';
        grid.innerHTML = mine.map(l => renderListingCard(l, true)).join('');
      }
    }

    // Store Directory
    function renderStoreDirectory() {
      const filter = document.getElementById('store-category-filter').value;
      const filtered = filter ? STORE_DIRECTORY.filter(s => s.category === filter) : STORE_DIRECTORY;
      document.getElementById('store-directory-grid').innerHTML = filtered.map(s => `
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:1rem;transition:border-color 0.2s;" onmouseenter="this.style.borderColor='rgba(255,136,17,0.3)'" onmouseleave="this.style.borderColor='var(--border)'">
          <div style="font-size:1.5rem;margin-bottom:0.4rem;">${s.icon}</div>
          <div style="font-weight:600;font-size:0.9rem;color:var(--text);margin-bottom:0.2rem;">${escHtml(s.name)}</div>
          <div style="font-size:0.7rem;color:var(--text-muted);margin-bottom:0.4rem;">${escHtml(s.category)}</div>
          <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.6rem;">${escHtml(s.description)}</div>
          <a href="${s.url}" target="_blank" rel="noopener" style="display:inline-block;padding:0.3rem 0.8rem;background:var(--accent);color:#fff;border-radius:6px;text-decoration:none;font-size:0.75rem;font-weight:600;">Visit Store ‚Üí</a>
        </div>`).join('');
    }

    // Populate store category filter
    (function() {
      const cats = [...new Set(STORE_DIRECTORY.map(s => s.category))];
      const sel = document.getElementById('store-category-filter');
      cats.forEach(c => { sel.innerHTML += `<option value="${escHtml(c)}">${escHtml(c)}</option>`; });
    })();

    // Inventory ‚Üí Listing bridge
    function listInventoryForSale(itemId) {
      const item = loadInventory().find(i => i.id === itemId);
      if (!item) return;
      // Map inventory category to marketplace category
      const catMap = {'Vehicle':'Vehicles','Clothing':'Clothing','Electronics':'Electronics','Tools':'Tools','Furniture':'Furniture','Kitchen':'Home','Books/Media':'Books/Media','Gaming':'Gaming','Home':'Home','Other':'Other'};
      const category = catMap[item.category] || 'Other';
      // Switch to market tab
      switchTab('market');
      showMarketSection('marketplace');
      openListingModal({
        title: item.name,
        description: (item.description || '') + (item.notes ? '\n\n' + item.notes : ''),
        category: category,
        condition: item.condition || 'Good',
      });
    }

    // Connect marketplace WS when market tab is shown
    let marketConnected = false;
    // Use a MutationObserver on the tab to detect when it becomes active
    const marketTabEl = document.getElementById('tab-market');
    if (marketTabEl) {
      new MutationObserver(() => {
        if (marketTabEl.classList.contains('active') && !marketConnected) {
          marketConnected = true;
          marketConnect();
        }
      }).observe(marketTabEl, { attributes: true, attributeFilter: ['class'] });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UNIVERSAL SEARCH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function universalSearch(query) {
      const results = document.getElementById('universal-search-results');
      if (!query || query.length < 2) { results.innerHTML = ''; return; }
      const q = query.toLowerCase();
      const hits = [];
      // Elements
      ELEMENTS.filter(e => e.name.toLowerCase().includes(q) || e.symbol.toLowerCase().includes(q) || String(e.number).includes(q))
        .forEach(e => hits.push({ label: `${e.symbol} ‚Äî ${e.name} (#${e.number})`, badge: 'Element', color: '#4caf50', action: () => { showElementDetail(e.symbol); } }));
      // Materials
      MATERIALS.filter(m => m.name.toLowerCase().includes(q) || m.category.toLowerCase().includes(q))
        .forEach(m => hits.push({ label: m.name + ' (' + m.type + ')', badge: 'Material', color: '#42a5f5', action: () => { showMaterialDetail(m.name); } }));
      // Inventory
      loadInventory().filter(i => i.name.toLowerCase().includes(q) || (i.category||'').toLowerCase().includes(q) || (i.tags||[]).some(t => t.toLowerCase().includes(q)))
        .forEach(i => hits.push({ label: i.name + (i.category ? ' ¬∑ ' + i.category : ''), badge: 'Inventory', color: '#ffa726', action: () => { editInventoryItem(i.id); } }));
      results.innerHTML = hits.length === 0 ? '<div style="padding:0.8rem;text-align:center;font-size:0.82rem;color:var(--text-muted);">No results</div>'
        : hits.slice(0, 20).map((h, i) => `<div class="catalog-result-item" onclick="universalSearchResults[${i}]()">
            <span class="catalog-result-badge" style="background:${h.color}22;color:${h.color};">${h.badge}</span>
            <span style="color:var(--text);">${escHtml(h.label)}</span>
          </div>`).join('');
      window.universalSearchResults = hits.slice(0, 20).map(h => h.action);
    }

    // ‚îÄ‚îÄ TODO ‚îÄ‚îÄ
    function loadTodos() {
      try { return JSON.parse(localStorage.getItem('humanity_todos')) || []; } catch { return []; }
    }
    function saveTodos(todos) { localStorage.setItem('humanity_todos', JSON.stringify(todos)); }

    function renderTodos() {
      const todos = loadTodos();
      const list = document.getElementById('todo-list');
      const active = todos.filter(t => !t.completed);
      const done = todos.filter(t => t.completed);
      const sorted = [...active, ...done];
      list.innerHTML = sorted.length === 0 ? '<div style="color:var(--text-muted);font-size:0.8rem;font-style:italic;padding:0.5rem;">No tasks yet</div>' : '';
      sorted.forEach(t => {
        const div = document.createElement('div');
        div.className = 'todo-item' + (t.completed ? ' completed' : '');
        div.innerHTML = `<input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleTodo('${t.id}')"><span class="todo-text">${escHtml(t.text)}</span><button class="todo-delete" onclick="deleteTodo('${t.id}')" title="Delete">‚úï</button>`;
        list.appendChild(div);
      });
    }

    function addTodo() {
      const input = document.getElementById('todo-input');
      const text = input.value.trim();
      if (!text) return;
      const todos = loadTodos();
      todos.push({ id: Date.now().toString(36), text, completed: false, createdAt: new Date().toISOString() });
      saveTodos(todos);
      input.value = '';
      renderTodos();
    }

    function toggleTodo(id) {
      const todos = loadTodos();
      const t = todos.find(x => x.id === id);
      if (t) t.completed = !t.completed;
      saveTodos(todos);
      renderTodos();
    }

    function deleteTodo(id) {
      saveTodos(loadTodos().filter(x => x.id !== id));
      renderTodos();
    }

    // ‚îÄ‚îÄ NOTES ‚îÄ‚îÄ
    let currentNoteId = null;

    function loadNotes() {
      try { return JSON.parse(localStorage.getItem('humanity_notes')) || []; } catch { return []; }
    }
    function saveNotes(notes) { localStorage.setItem('humanity_notes', JSON.stringify(notes)); }

    function renderNotes() {
      const notes = loadNotes();
      const list = document.getElementById('notes-list');
      list.innerHTML = notes.length === 0 ? '<div style="color:var(--text-muted);font-size:0.8rem;font-style:italic;padding:0.3rem;">No notes yet</div>' : '';
      notes.forEach(n => {
        const div = document.createElement('div');
        div.className = 'note-item' + (n.id === currentNoteId ? ' active' : '');
        div.innerHTML = `<span onclick="selectNote('${n.id}')">${escHtml(n.title || 'Untitled')}</span><button class="note-delete" onclick="event.stopPropagation();deleteNote('${n.id}')" title="Delete">‚úï</button>`;
        div.querySelector('span').style.flex = '1';
        div.querySelector('span').style.cursor = 'pointer';
        list.appendChild(div);
      });
    }

    function addNote() {
      const notes = loadNotes();
      const id = Date.now().toString(36);
      notes.unshift({ id, title: '', content: '', updatedAt: new Date().toISOString() });
      saveNotes(notes);
      selectNote(id);
    }

    function selectNote(id) {
      currentNoteId = id;
      const notes = loadNotes();
      const note = notes.find(n => n.id === id);
      const editor = document.getElementById('notes-editor');
      if (note) {
        document.getElementById('note-title').value = note.title;
        document.getElementById('note-content').value = note.content;
        editor.style.display = 'block';
      }
      renderNotes();
    }

    function saveCurrentNote() {
      if (!currentNoteId) return;
      const notes = loadNotes();
      const note = notes.find(n => n.id === currentNoteId);
      if (note) {
        note.title = document.getElementById('note-title').value;
        note.content = document.getElementById('note-content').value;
        note.updatedAt = new Date().toISOString();
        saveNotes(notes);
        renderNotes();
      }
    }

    function deleteNote(id) {
      saveNotes(loadNotes().filter(n => n.id !== id));
      if (currentNoteId === id) {
        currentNoteId = null;
        document.getElementById('notes-editor').style.display = 'none';
      }
      renderNotes();
    }

    // ‚îÄ‚îÄ GARDEN MANAGER v2 ‚îÄ‚îÄ
    const OPTIMAL_RANGES = {
      soil: { ph:{min:6.0,max:7.0,unit:'',label:'pH'}, moisture:{min:40,max:60,unit:'%',label:'Soil Moisture'}, temperature:{min:60,max:85,unit:'¬∞F',label:'Air Temperature'} },
      hydroponic: { ph:{min:5.5,max:6.5,unit:'',label:'pH'}, ec:{min:1.0,max:2.5,unit:'mS/cm',label:'EC'}, waterTemp:{min:65,max:75,unit:'¬∞F',label:'Water Temp'}, dissolvedO2:{min:5,max:8,unit:'mg/L',label:'Dissolved O2'} },
      aeroponic: { ph:{min:5.5,max:6.5,unit:'',label:'pH'}, ec:{min:1.0,max:2.0,unit:'mS/cm',label:'EC'}, rootTemp:{min:65,max:72,unit:'¬∞F',label:'Root Zone Temp'} },
      aquaponic: { ph:{min:6.8,max:7.2,unit:'',label:'pH'}, ammonia:{min:0,max:0.5,unit:'ppm',label:'Ammonia'}, nitrite:{min:0,max:0.5,unit:'ppm',label:'Nitrite'}, nitrate:{min:10,max:150,unit:'ppm',label:'Nitrate'}, waterTemp:{min:72,max:82,unit:'¬∞F',label:'Water Temp'}, dissolvedO2:{min:5,max:8,unit:'mg/L',label:'Dissolved O2'} },
      general: { humidity:{min:40,max:70,unit:'%',label:'Humidity'}, co2:{min:400,max:1500,unit:'ppm',label:'CO2'}, lightPar:{min:200,max:800,unit:'¬µmol/m¬≤/s',label:'PPFD'}, lightDli:{min:12,max:40,unit:'mol/m¬≤/day',label:'DLI'} }
    };

    const ZONE_ICONS = { field:'üåæ', raised_bed:'üåø', container:'ü™¥', hydro_dwc:'üíß', hydro_nft:'üíß', hydro_drip:'üíß', hydro_ebb_flow:'üíß', aeroponic:'üå´Ô∏è', aquaponic:'üêü' };
    const ZONE_LABELS = { field:'Field', raised_bed:'Raised Bed', container:'Container', hydro_dwc:'Hydro DWC', hydro_nft:'Hydro NFT', hydro_drip:'Hydro Drip', hydro_ebb_flow:'Hydro Ebb/Flow', aeroponic:'Aeroponic', aquaponic:'Aquaponic' };
    const STAGE_ICONS = { seed:'üå∞', germination:'üå±', seedling:'üåø', vegetative:'ü™¥', flowering:'üå∏', fruiting:'üçé', harvest:'üß∫', dormant:'üí§' };
    const HEALTH_ICONS = { healthy:'‚úì', stressed:'‚ö†', diseased:'ü¶†', pest:'üêõ', nutrient_deficiency:'üü°', overwatered:'üí¶', underwatered:'üèúÔ∏è' };

    let gardenData = null;
    let gardenSelectedZone = null;

    function loadGardenV2() {
      if (gardenData) return gardenData;
      try { gardenData = JSON.parse(localStorage.getItem('humanity_garden_v2')) || { zones:[], plants:[], sensors:[], settings:{units:'imperial'} }; }
      catch { gardenData = { zones:[], plants:[], sensors:[], settings:{units:'imperial'} }; }
      return gardenData;
    }
    function saveGardenV2() { localStorage.setItem('humanity_garden_v2', JSON.stringify(gardenData)); }

    function gardenRangeColor(value, range) {
      if (value == null || !range) return '';
      const span = range.max - range.min;
      const margin = span * 0.1;
      if (value >= range.min && value <= range.max) return '#4a8';
      if (value >= range.min - margin && value <= range.max + margin) return '#eb4';
      return '#e55';
    }

    function gardenGetRanges(zone) {
      const t = zone.type;
      if (t.startsWith('hydro')) return {...OPTIMAL_RANGES.general, ...OPTIMAL_RANGES.hydroponic};
      if (t === 'aeroponic') return {...OPTIMAL_RANGES.general, ...OPTIMAL_RANGES.aeroponic};
      if (t === 'aquaponic') return {...OPTIMAL_RANGES.general, ...OPTIMAL_RANGES.aquaponic};
      return {...OPTIMAL_RANGES.general, ...OPTIMAL_RANGES.soil};
    }

    function renderGardenZoneTree() {
      const g = loadGardenV2();
      const tree = document.getElementById('garden-zone-tree');
      const grouped = { outdoor:[], indoor:[], greenhouse:[] };
      g.zones.forEach(z => { (grouped[z.location] || grouped.outdoor).push(z); });
      const locLabels = { outdoor:'üìÅ Outdoor', indoor:'üìÅ Indoor', greenhouse:'üìÅ Greenhouse' };
      let html = '';
      for (const [loc, zones] of Object.entries(grouped)) {
        if (zones.length === 0) continue;
        html += `<div style="margin-bottom:0.4rem;">
          <div style="font-weight:600;font-size:0.72rem;color:var(--text-muted);padding:0.2rem 0.3rem;cursor:pointer;user-select:none;" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'">${locLabels[loc]}</div>
          <div>`;
        zones.forEach(z => {
          const sel = gardenSelectedZone === z.id ? 'background:rgba(255,136,17,0.15);color:var(--accent);font-weight:600;' : '';
          const plantCount = g.plants.filter(p => p.zoneId === z.id).length;
          html += `<div onclick="gardenSelectZone('${z.id}')" style="padding:0.25rem 0.4rem 0.25rem 1rem;cursor:pointer;border-radius:4px;font-size:0.78rem;display:flex;align-items:center;gap:0.3rem;${sel}" title="${ZONE_LABELS[z.type]}">
            <span>${ZONE_ICONS[z.type]||'üå±'}</span>
            <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escHtml(z.name)}</span>
            <span style="font-size:0.65rem;color:var(--text-muted);">${plantCount}</span>
          </div>`;
        });
        html += '</div></div>';
      }
      if (g.zones.length === 0) html = '<div style="text-align:center;color:var(--text-muted);font-size:0.75rem;padding:1rem;">No zones</div>';
      tree.innerHTML = html;
      document.getElementById('garden-empty').style.display = g.zones.length === 0 ? '' : 'none';
      document.getElementById('garden-zone-detail').style.display = g.zones.length > 0 && gardenSelectedZone ? '' : 'none';
    }

    function gardenSelectZone(zoneId) {
      gardenSelectedZone = zoneId;
      renderGardenZoneTree();
      renderGardenZoneDetail();
    }

    function renderGardenZoneDetail() {
      const g = loadGardenV2();
      const zone = g.zones.find(z => z.id === gardenSelectedZone);
      const det = document.getElementById('garden-zone-detail');
      if (!zone) { det.style.display = 'none'; return; }
      det.style.display = '';
      const plants = g.plants.filter(p => p.zoneId === zone.id);
      const sensor = g.sensors.find(s => s.zoneId === zone.id);
      const lastReading = sensor && sensor.readings.length > 0 ? sensor.readings[sensor.readings.length - 1].metrics : {};
      const ranges = gardenGetRanges(zone);
      const dim = zone.dimensions ? `${zone.dimensions.length}√ó${zone.dimensions.width} ${zone.dimensions.unit}` : '‚Äî';

      // Dashboard cards
      const metricKeys = [
        ['ph','pH',lastReading.ph],['ec','EC',lastReading.ec],['airTemp','Temp',lastReading.airTemp],
        ['humidity','RH',lastReading.humidity],['soilMoisture','Moisture',lastReading.soilMoisture],
        ['lightPar','PPFD',lastReading.lightPar],['waterTemp','Water',lastReading.waterTemp],
        ['dissolvedO2','DO',lastReading.dissolvedO2],['co2','CO2',lastReading.co2]
      ].filter(m => m[2] != null);

      let dashHtml = '';
      metricKeys.forEach(([key,label,val]) => {
        const r = ranges[key];
        const col = gardenRangeColor(val, r);
        const unit = r ? r.unit : '';
        dashHtml += `<div style="background:var(--bg-input);border-radius:6px;padding:0.4rem 0.6rem;text-align:center;border-left:3px solid ${col||'var(--border)'};">
          <div style="font-size:0.65rem;color:var(--text-muted);">${label}</div>
          <div style="font-size:1rem;font-weight:700;color:${col||'var(--text)'}">${val}${unit?' '+unit:''}</div>
        </div>`;
      });

      // Plant list
      let plantHtml = '';
      plants.forEach(p => {
        const hIcon = HEALTH_ICONS[p.health] || '‚úì';
        const hCol = p.health === 'healthy' ? '#4a8' : (p.health === 'stressed' || p.health === 'nutrient_deficiency' ? '#eb4' : '#e55');
        plantHtml += `<div onclick="gardenShowPlant('${p.id}')" style="display:flex;align-items:center;gap:0.5rem;padding:0.35rem 0.5rem;cursor:pointer;border-radius:4px;font-size:0.82rem;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
          <span>${STAGE_ICONS[p.stage]||'üå±'}</span>
          <span style="flex:1;">${escHtml(p.species)}${p.variety?' ‚Äî '+escHtml(p.variety):''}</span>
          <span style="font-size:0.7rem;color:var(--text-muted);">[${p.stage}]</span>
          <span style="color:${hCol};font-size:0.8rem;" title="${p.health}">${hIcon}</span>
        </div>`;
      });

      // Readings chart (simple canvas line for pH over last 7 readings)
      const chartId = 'garden-chart-' + zone.id;

      det.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.8rem;">
          <div>
            <div style="font-size:1.1rem;font-weight:700;color:var(--text);">${ZONE_ICONS[zone.type]||'üå±'} ${escHtml(zone.name)}</div>
            <div style="font-size:0.78rem;color:var(--text-muted);">Type: ${ZONE_LABELS[zone.type]} (${zone.medium || 'soil'}) ¬∑ Size: ${dim} ¬∑ Plants: ${plants.length} ¬∑ Light: ${zone.lightSource||'natural'} ${zone.lightSchedule||''}</div>
          </div>
          <div style="display:flex;gap:0.3rem;">
            <button onclick="gardenEditZone('${zone.id}')" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.2rem 0.5rem;border-radius:4px;font-size:0.7rem;cursor:pointer;">‚úèÔ∏è Edit</button>
            <button onclick="gardenDeleteZone('${zone.id}')" style="background:var(--bg-input);border:1px solid var(--border);color:var(--error);padding:0.2rem 0.5rem;border-radius:4px;font-size:0.7rem;cursor:pointer;">üóëÔ∏è</button>
          </div>
        </div>
        ${metricKeys.length > 0 ? `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:0.4rem;margin-bottom:1rem;">${dashHtml}</div>` : ''}
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.4rem;">
          <div style="font-weight:600;font-size:0.85rem;color:var(--text);">Plants</div>
          <button onclick="gardenAddPlant('${zone.id}')" style="background:var(--accent);color:#fff;border:none;padding:0.15rem 0.5rem;border-radius:4px;font-size:0.7rem;cursor:pointer;font-weight:600;">+ Add Plant</button>
        </div>
        ${plants.length > 0 ? plantHtml : '<div style="color:var(--text-muted);font-size:0.8rem;font-style:italic;padding:0.5rem;">No plants yet</div>'}
        <div style="display:flex;gap:0.3rem;margin-top:0.8rem;">
          <button onclick="gardenLogReading('${zone.id}')" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.3rem 0.7rem;border-radius:6px;font-size:0.78rem;cursor:pointer;">üìä Log Reading</button>
        </div>
        ${sensor && sensor.readings.length > 1 ? `<div style="margin-top:1rem;"><div style="font-weight:600;font-size:0.85rem;color:var(--text);margin-bottom:0.4rem;">Readings (last 7)</div><canvas id="${chartId}" width="500" height="140" style="width:100%;border-radius:6px;background:var(--bg-input);"></canvas></div>` : ''}
        ${sensor && sensor.readings.length > 0 ? gardenReadingsTable(sensor, ranges) : ''}
        ${zone.notes ? `<div style="margin-top:0.8rem;font-size:0.78rem;color:var(--text-muted);"><strong>Notes:</strong> ${escHtml(zone.notes)}</div>` : ''}
      `;

      // Draw chart
      if (sensor && sensor.readings.length > 1) {
        setTimeout(() => gardenDrawChart(chartId, sensor.readings.slice(-7)), 50);
      }
    }

    function gardenReadingsTable(sensor, ranges) {
      const readings = sensor.readings.slice(-10).reverse();
      let html = '<div style="margin-top:0.8rem;overflow-x:auto;"><table style="width:100%;font-size:0.72rem;border-collapse:collapse;">';
      html += '<tr style="border-bottom:1px solid var(--border);color:var(--text-muted);"><th style="padding:0.2rem 0.4rem;text-align:left;">Date</th><th>pH</th><th>EC</th><th>Temp</th><th>RH</th><th>Moisture</th><th>PPFD</th></tr>';
      readings.forEach(r => {
        const m = r.metrics;
        const d = new Date(r.date).toLocaleDateString();
        const c = (k,v) => { const col = gardenRangeColor(v, ranges[k]); return col ? `color:${col}` : ''; };
        html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.03);">
          <td style="padding:0.2rem 0.4rem;">${d}</td>
          <td style="text-align:center;${c('ph',m.ph)}">${m.ph??'‚Äî'}</td>
          <td style="text-align:center;${c('ec',m.ec)}">${m.ec??'‚Äî'}</td>
          <td style="text-align:center;${c('airTemp',m.airTemp)}">${m.airTemp??'‚Äî'}</td>
          <td style="text-align:center;${c('humidity',m.humidity)}">${m.humidity??'‚Äî'}</td>
          <td style="text-align:center;${c('soilMoisture',m.soilMoisture)}">${m.soilMoisture??'‚Äî'}</td>
          <td style="text-align:center;${c('lightPar',m.lightPar)}">${m.lightPar??'‚Äî'}</td>
        </tr>`;
      });
      html += '</table></div>';
      return html;
    }

    function gardenDrawChart(canvasId, readings) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);
      const phVals = readings.map(r => r.metrics.ph).filter(v => v != null);
      if (phVals.length < 2) return;
      const min = Math.min(...phVals) - 0.5, max = Math.max(...phVals) + 0.5;
      const pad = {t:20,b:20,l:30,r:10};
      ctx.strokeStyle = '#4a8'; ctx.lineWidth = 2; ctx.beginPath();
      phVals.forEach((v,i) => {
        const x = pad.l + (i / (phVals.length-1)) * (w-pad.l-pad.r);
        const y = pad.t + (1 - (v-min)/(max-min)) * (h-pad.t-pad.b);
        i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
      });
      ctx.stroke();
      // dots
      phVals.forEach((v,i) => {
        const x = pad.l + (i / (phVals.length-1)) * (w-pad.l-pad.r);
        const y = pad.t + (1 - (v-min)/(max-min)) * (h-pad.t-pad.b);
        ctx.fillStyle='#4a8'; ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
      });
      // labels
      ctx.fillStyle='#888'; ctx.font='10px sans-serif'; ctx.textAlign='right';
      ctx.fillText(max.toFixed(1), pad.l-4, pad.t+4);
      ctx.fillText(min.toFixed(1), pad.l-4, h-pad.b+4);
      ctx.fillText('pH', pad.l-4, 12);
    }

    function gardenAddZone() {
      document.getElementById('gz-edit-id').value = '';
      document.getElementById('gz-name').value = '';
      document.getElementById('gz-type').value = 'raised_bed';
      document.getElementById('gz-location').value = 'outdoor';
      document.getElementById('gz-length').value = '';
      document.getElementById('gz-width').value = '';
      document.getElementById('gz-unit').value = 'ft';
      document.getElementById('gz-medium').value = 'soil';
      document.getElementById('gz-light').value = 'natural';
      document.getElementById('gz-schedule').value = '';
      document.getElementById('gz-notes').value = '';
      document.getElementById('garden-zone-modal-title').textContent = 'New Zone';
      document.getElementById('garden-zone-modal').classList.add('open');
    }

    function gardenEditZone(id) {
      const g = loadGardenV2();
      const z = g.zones.find(x => x.id === id);
      if (!z) return;
      document.getElementById('gz-edit-id').value = z.id;
      document.getElementById('gz-name').value = z.name;
      document.getElementById('gz-type').value = z.type;
      document.getElementById('gz-location').value = z.location;
      document.getElementById('gz-length').value = z.dimensions?.length || '';
      document.getElementById('gz-width').value = z.dimensions?.width || '';
      document.getElementById('gz-unit').value = z.dimensions?.unit || 'ft';
      document.getElementById('gz-medium').value = z.medium || 'soil';
      document.getElementById('gz-light').value = z.lightSource || 'natural';
      document.getElementById('gz-schedule').value = z.lightSchedule || '';
      document.getElementById('gz-notes').value = z.notes || '';
      document.getElementById('garden-zone-modal-title').textContent = 'Edit Zone';
      document.getElementById('garden-zone-modal').classList.add('open');
    }

    function gardenCloseZoneModal() { document.getElementById('garden-zone-modal').classList.remove('open'); }

    function gardenSaveZone() {
      const g = loadGardenV2();
      const editId = document.getElementById('gz-edit-id').value;
      const name = document.getElementById('gz-name').value.trim();
      if (!name) { alert('Name is required'); return; }
      const zoneData = {
        name, type: document.getElementById('gz-type').value,
        location: document.getElementById('gz-location').value,
        dimensions: { length: parseFloat(document.getElementById('gz-length').value)||0, width: parseFloat(document.getElementById('gz-width').value)||0, unit: document.getElementById('gz-unit').value },
        medium: document.getElementById('gz-medium').value,
        lightSource: document.getElementById('gz-light').value,
        lightSchedule: document.getElementById('gz-schedule').value,
        notes: document.getElementById('gz-notes').value
      };
      if (editId) {
        const idx = g.zones.findIndex(z => z.id === editId);
        if (idx >= 0) Object.assign(g.zones[idx], zoneData);
      } else {
        zoneData.id = 'zone-' + Date.now();
        zoneData.createdAt = Date.now();
        g.zones.push(zoneData);
        gardenSelectedZone = zoneData.id;
      }
      gardenData = g; saveGardenV2();
      gardenCloseZoneModal();
      renderGardenZoneTree();
      renderGardenZoneDetail();
    }

    function gardenDeleteZone(id) {
      if (!confirm('Delete this zone and all its plants?')) return;
      const g = loadGardenV2();
      g.zones = g.zones.filter(z => z.id !== id);
      g.plants = g.plants.filter(p => p.zoneId !== id);
      g.sensors = g.sensors.filter(s => s.zoneId !== id);
      if (gardenSelectedZone === id) gardenSelectedZone = g.zones.length > 0 ? g.zones[0].id : null;
      gardenData = g; saveGardenV2();
      renderGardenZoneTree();
      renderGardenZoneDetail();
    }

    function gardenAddPlant(zoneId) {
      document.getElementById('gp-edit-id').value = '';
      document.getElementById('gp-zone-id').value = zoneId;
      document.getElementById('gp-species').value = '';
      document.getElementById('gp-variety').value = '';
      document.getElementById('gp-stage').value = 'vegetative';
      document.getElementById('gp-health').value = 'healthy';
      document.getElementById('gp-planted').value = new Date().toISOString().split('T')[0];
      document.getElementById('gp-harvest').value = '';
      document.getElementById('gp-row').value = '';
      document.getElementById('gp-col').value = '';
      document.getElementById('gp-slot').value = '';
      document.getElementById('gp-notes').value = '';
      document.getElementById('garden-plant-modal-title2').textContent = 'Add Plant';
      document.getElementById('garden-add-plant-modal').classList.add('open');
    }

    function gardenCloseAddPlantModal() { document.getElementById('garden-add-plant-modal').classList.remove('open'); }

    function gardenSavePlant() {
      const g = loadGardenV2();
      const editId = document.getElementById('gp-edit-id').value;
      const species = document.getElementById('gp-species').value.trim();
      if (!species) { alert('Species is required'); return; }
      const zoneId = document.getElementById('gp-zone-id').value;
      const plantData = {
        zoneId, species, variety: document.getElementById('gp-variety').value.trim(),
        stage: document.getElementById('gp-stage').value, health: document.getElementById('gp-health').value,
        plantedDate: document.getElementById('gp-planted').value ? new Date(document.getElementById('gp-planted').value).getTime() : null,
        expectedHarvest: document.getElementById('gp-harvest').value ? new Date(document.getElementById('gp-harvest').value).getTime() : null,
        position: { row: parseInt(document.getElementById('gp-row').value)||null, col: parseInt(document.getElementById('gp-col').value)||null },
        slot: parseInt(document.getElementById('gp-slot').value)||null,
        notes: document.getElementById('gp-notes').value, yields:[], waterings:[], prunings:[], photos:[]
      };
      if (editId) {
        const idx = g.plants.findIndex(p => p.id === editId);
        if (idx >= 0) { const old = g.plants[idx]; Object.assign(old, plantData); old.yields = old.yields||[]; old.waterings = old.waterings||[]; }
      } else {
        plantData.id = 'plant-' + Date.now();
        g.plants.push(plantData);
      }
      gardenData = g; saveGardenV2();
      gardenCloseAddPlantModal();
      renderGardenZoneDetail();
    }

    function gardenShowPlant(plantId) {
      const g = loadGardenV2();
      const p = g.plants.find(x => x.id === plantId);
      if (!p) return;
      const zone = g.zones.find(z => z.id === p.zoneId);
      const stages = ['seed','germination','seedling','vegetative','flowering','fruiting','harvest','dormant'];
      const stageIdx = stages.indexOf(p.stage);
      let timelineHtml = '<div style="display:flex;gap:0.15rem;margin:0.6rem 0;">';
      stages.forEach((s,i) => {
        const active = i <= stageIdx;
        timelineHtml += `<div style="flex:1;height:6px;border-radius:3px;background:${active?'#4a8':'var(--bg-input)'}" title="${s}"></div>`;
      });
      timelineHtml += '</div>';

      let yieldHtml = '';
      if (p.yields && p.yields.length > 0) {
        yieldHtml = '<div style="margin-top:0.6rem;"><strong style="font-size:0.78rem;">Yield History</strong>';
        p.yields.forEach(y => { yieldHtml += `<div style="font-size:0.75rem;color:var(--text-muted);">${new Date(y.date).toLocaleDateString()} ‚Äî ${y.amount} ${y.unit}</div>`; });
        yieldHtml += '</div>';
      }

      let waterHtml = '';
      if (p.waterings && p.waterings.length > 0) {
        waterHtml = '<div style="margin-top:0.6rem;"><strong style="font-size:0.78rem;">Watering Log</strong>';
        p.waterings.slice(-5).forEach(w => { waterHtml += `<div style="font-size:0.75rem;color:var(--text-muted);">${new Date(w.date).toLocaleDateString()} ‚Äî ${w.amount}${w.nutrientMix?' ('+w.nutrientMix+')':''}</div>`; });
        waterHtml += '</div>';
      }

      document.getElementById('garden-plant-modal-content').innerHTML = `
        <div style="display:flex;align-items:center;gap:0.6rem;margin-bottom:0.6rem;">
          <span style="font-size:1.5rem;">${STAGE_ICONS[p.stage]||'üå±'}</span>
          <div>
            <div style="font-size:1.1rem;font-weight:700;color:var(--text);">${escHtml(p.species)}${p.variety?' ‚Äî '+escHtml(p.variety):''}</div>
            <div style="font-size:0.78rem;color:var(--text-muted);">Zone: ${zone?escHtml(zone.name):'‚Äî'} ¬∑ Stage: ${p.stage} ¬∑ Health: ${p.health}</div>
          </div>
        </div>
        <div style="font-size:0.78rem;color:var(--text-muted);">Growth Timeline</div>
        ${timelineHtml}
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;font-size:0.8rem;">
          <div><strong>Planted:</strong> ${p.plantedDate?new Date(p.plantedDate).toLocaleDateString():'‚Äî'}</div>
          <div><strong>Expected Harvest:</strong> ${p.expectedHarvest?new Date(p.expectedHarvest).toLocaleDateString():'‚Äî'}</div>
          ${p.position?.row?`<div><strong>Position:</strong> Row ${p.position.row}, Col ${p.position.col||'‚Äî'}</div>`:''}
          ${p.slot?`<div><strong>Slot:</strong> ${p.slot}</div>`:''}
        </div>
        ${yieldHtml}
        ${waterHtml}
        ${p.notes?`<div style="margin-top:0.6rem;font-size:0.8rem;"><strong>Notes:</strong> ${escHtml(p.notes)}</div>`:''}
        <div style="display:flex;gap:0.3rem;margin-top:1rem;">
          <button onclick="gardenEditPlant('${p.id}')" style="background:var(--accent);color:#fff;border:none;padding:0.3rem 0.7rem;border-radius:6px;font-size:0.78rem;cursor:pointer;">‚úèÔ∏è Edit</button>
          <button onclick="gardenLogWatering('${p.id}')" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.3rem 0.7rem;border-radius:6px;font-size:0.78rem;cursor:pointer;">üíß Water</button>
          <button onclick="gardenLogYield('${p.id}')" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.3rem 0.7rem;border-radius:6px;font-size:0.78rem;cursor:pointer;">üß∫ Yield</button>
          <button onclick="gardenDeletePlant('${p.id}')" style="background:var(--bg-input);border:1px solid var(--border);color:var(--error);padding:0.3rem 0.7rem;border-radius:6px;font-size:0.78rem;cursor:pointer;">üóëÔ∏è</button>
        </div>
      `;
      document.getElementById('garden-plant-modal').classList.add('open');
    }

    function gardenClosePlantModal() { document.getElementById('garden-plant-modal').classList.remove('open'); }

    function gardenEditPlant(id) {
      gardenClosePlantModal();
      const g = loadGardenV2();
      const p = g.plants.find(x => x.id === id);
      if (!p) return;
      document.getElementById('gp-edit-id').value = p.id;
      document.getElementById('gp-zone-id').value = p.zoneId;
      document.getElementById('gp-species').value = p.species;
      document.getElementById('gp-variety').value = p.variety||'';
      document.getElementById('gp-stage').value = p.stage;
      document.getElementById('gp-health').value = p.health;
      document.getElementById('gp-planted').value = p.plantedDate ? new Date(p.plantedDate).toISOString().split('T')[0] : '';
      document.getElementById('gp-harvest').value = p.expectedHarvest ? new Date(p.expectedHarvest).toISOString().split('T')[0] : '';
      document.getElementById('gp-row').value = p.position?.row||'';
      document.getElementById('gp-col').value = p.position?.col||'';
      document.getElementById('gp-slot').value = p.slot||'';
      document.getElementById('gp-notes').value = p.notes||'';
      document.getElementById('garden-plant-modal-title2').textContent = 'Edit Plant';
      document.getElementById('garden-add-plant-modal').classList.add('open');
    }

    function gardenDeletePlant(id) {
      if (!confirm('Delete this plant?')) return;
      const g = loadGardenV2();
      g.plants = g.plants.filter(p => p.id !== id);
      gardenData = g; saveGardenV2();
      gardenClosePlantModal();
      renderGardenZoneDetail();
    }

    function gardenLogWatering(plantId) {
      const amount = prompt('Water amount (e.g. "1 gal")');
      if (!amount) return;
      const mix = prompt('Nutrient mix (optional)', '');
      const g = loadGardenV2();
      const p = g.plants.find(x => x.id === plantId);
      if (!p) return;
      if (!p.waterings) p.waterings = [];
      p.waterings.push({ date: Date.now(), amount, nutrientMix: mix||'' });
      gardenData = g; saveGardenV2();
      gardenShowPlant(plantId);
    }

    function gardenLogYield(plantId) {
      const amount = prompt('Yield amount (number)');
      if (!amount) return;
      const unit = prompt('Unit (e.g. lb, oz, kg)', 'lb');
      const g = loadGardenV2();
      const p = g.plants.find(x => x.id === plantId);
      if (!p) return;
      if (!p.yields) p.yields = [];
      p.yields.push({ date: Date.now(), amount: parseFloat(amount)||0, unit: unit||'lb' });
      gardenData = g; saveGardenV2();
      gardenShowPlant(plantId);
    }

    function gardenLogReading(zoneId) {
      document.getElementById('gr-zone-id').value = zoneId;
      ['ph','ec','tds','watertemp','airtemp','humidity','moisture','par','co2','do','waterlevel','dli'].forEach(k => {
        document.getElementById('gr-'+k).value = '';
      });
      document.getElementById('garden-reading-modal').classList.add('open');
    }

    function gardenSaveReading() {
      const g = loadGardenV2();
      const zoneId = document.getElementById('gr-zone-id').value;
      let sensor = g.sensors.find(s => s.zoneId === zoneId);
      if (!sensor) { sensor = { id:'sensor-'+Date.now(), zoneId, type:'manual', readings:[] }; g.sensors.push(sensor); }
      const metrics = {};
      const map = {ph:'ph',ec:'ec',tds:'tds',watertemp:'waterTemp',airtemp:'airTemp',humidity:'humidity',moisture:'soilMoisture',par:'lightPar',co2:'co2',do:'dissolvedO2',waterlevel:'waterLevel',dli:'lightDli'};
      for (const [k,v] of Object.entries(map)) {
        const val = parseFloat(document.getElementById('gr-'+k).value);
        if (!isNaN(val)) metrics[v] = val;
      }
      if (Object.keys(metrics).length === 0) { alert('Enter at least one reading'); return; }
      sensor.readings.push({ date: Date.now(), metrics });
      gardenData = g; saveGardenV2();
      document.getElementById('garden-reading-modal').classList.remove('open');
      renderGardenZoneDetail();
    }

    function renderGarden() {
      loadGardenV2();
      if (gardenData.zones.length > 0 && !gardenSelectedZone) gardenSelectedZone = gardenData.zones[0].id;
      renderGardenZoneTree();
      if (gardenSelectedZone) renderGardenZoneDetail();
    }

    function escHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    // Init reality tab
    renderTodos();
    renderNotes();
    renderGarden();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FANTASY TAB
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // ‚îÄ‚îÄ Card collapse (reuse pattern) ‚îÄ‚îÄ
    function toggleFantasyCard(id) {
      const card = document.getElementById('fantasy-' + id);
      if (card) card.classList.toggle('collapsed');
      localStorage.setItem('fantasy_collapsed_' + id, card.classList.contains('collapsed'));
    }
    ['worldmap', 'character', 'lore', 'achievements', 'celestial'].forEach(id => {
      if (localStorage.getItem('fantasy_collapsed_' + id) === 'true') {
        const card = document.getElementById('fantasy-' + id);
        if (card) card.classList.add('collapsed');
      }
    });

    // ‚îÄ‚îÄ World Map (procedural grid) ‚îÄ‚îÄ
    (function drawWorldMap() {
      const canvas = document.getElementById('world-map-canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      // Seed-based pseudo-random
      let seed = 42;
      function rng() { seed = (seed * 16807 + 0) % 2147483647; return (seed - 1) / 2147483646; }

      // Draw terrain grid
      const cellSize = 8;
      const cols = Math.ceil(w / cellSize), rows = Math.ceil(h / cellSize);
      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          const v = rng();
          const cx = x / cols, cy = y / rows;
          const dist = Math.sqrt((cx - 0.5) ** 2 + (cy - 0.5) ** 2);
          if (v < 0.15 + dist * 0.3) {
            // water
            const b = Math.floor(40 + rng() * 30);
            ctx.fillStyle = `rgb(${5+Math.floor(rng()*10)},${10+Math.floor(rng()*15)},${b})`;
          } else if (v < 0.5) {
            // land
            const g = Math.floor(25 + rng() * 35);
            ctx.fillStyle = `rgb(${8+Math.floor(rng()*12)},${g},${8+Math.floor(rng()*10)})`;
          } else if (v < 0.75) {
            // highlands
            const g = Math.floor(35 + rng() * 20);
            ctx.fillStyle = `rgb(${15+Math.floor(rng()*10)},${g},${20+Math.floor(rng()*10)})`;
          } else {
            // mountains
            const g = Math.floor(20 + rng() * 15);
            ctx.fillStyle = `rgb(${g},${g},${g+5})`;
          }
          ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
        }
      }
      // Overlay fog
      const grad = ctx.createRadialGradient(w/2, h/2, w*0.15, w/2, h/2, w*0.5);
      grad.addColorStop(0, 'rgba(10,10,26,0)');
      grad.addColorStop(1, 'rgba(10,10,26,0.85)');
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, w, h);
      // Label
      ctx.font = '14px sans-serif';
      ctx.fillStyle = 'rgba(153,102,255,0.6)';
      ctx.textAlign = 'center';
      ctx.fillText('‚öî Terra Incognita ‚öî', w/2, h/2);
    })();

    // ‚îÄ‚îÄ Character Sheet ‚îÄ‚îÄ
    function loadCharacter() {
      try { return JSON.parse(localStorage.getItem('humanity_character')); } catch { return null; }
    }
    function saveCharacter(c) { localStorage.setItem('humanity_character', JSON.stringify(c)); }

    function rollStats() {
      const roll = () => Math.floor(Math.random() * 16) + 3; // 3-18
      return { Strength: roll(), Intelligence: roll(), Dexterity: roll(), Charisma: roll() };
    }

    function renderCharacter() {
      const c = loadCharacter();
      const create = document.getElementById('char-create');
      const display = document.getElementById('char-display');
      if (!c) {
        create.style.display = 'block';
        display.style.display = 'none';
        return;
      }
      create.style.display = 'none';
      display.style.display = 'block';
      const classIcons = { Explorer: 'üß≠', Builder: 'üî®', Scholar: 'üìö', Guardian: 'üõ°Ô∏è' };
      document.getElementById('char-d-name').textContent = c.name;
      document.getElementById('char-d-class').textContent = (classIcons[c.class] || '') + ' ' + c.class;
      document.getElementById('char-d-level').textContent = 'Lv. ' + (c.level || 1);
      const statsEl = document.getElementById('char-stats');
      const statColors = { Strength: '#e55', Intelligence: '#58f', Dexterity: '#4c8', Charisma: '#eb4' };
      statsEl.innerHTML = Object.entries(c.stats).map(([k, v]) => {
        const pct = ((v - 3) / 15 * 100).toFixed(0);
        return `<div style="background:var(--bg-input);border-radius:6px;padding:0.35rem 0.5rem;">
          <div style="display:flex;justify-content:space-between;font-size:0.75rem;margin-bottom:0.2rem;">
            <span style="color:var(--text-muted);">${k}</span><span style="color:${statColors[k]||'var(--text)'};font-weight:700;">${v}</span>
          </div>
          <div style="background:var(--bg);border-radius:3px;height:4px;overflow:hidden;">
            <div style="width:${pct}%;height:100%;background:${statColors[k]||'var(--accent)'};border-radius:3px;"></div>
          </div>
        </div>`;
      }).join('');

      // Auto-unlock achievements
      checkAchievements();
    }

    function createCharacter() {
      const name = document.getElementById('char-name-input').value.trim();
      if (!name) { document.getElementById('char-name-input').style.borderColor = '#e55'; return; }
      const cls = document.getElementById('char-class-input').value;
      saveCharacter({ name, class: cls, level: 1, stats: rollStats(), createdAt: new Date().toISOString() });
      renderCharacter();
      // Unlock achievement
      unlockAchievement('character_created');
    }

    function rerollStats() {
      const c = loadCharacter();
      if (!c) return;
      c.stats = rollStats();
      saveCharacter(c);
      renderCharacter();
    }

    function deleteCharacter() {
      if (!confirm('Delete your character? This cannot be undone.')) return;
      localStorage.removeItem('humanity_character');
      renderCharacter();
    }

    renderCharacter();

    // ‚îÄ‚îÄ Lore / Codex ‚îÄ‚îÄ
    const LORE_ENTRIES = [
      {
        title: 'üåÖ The Awakening',
        text: 'Before the Network, humanity existed in silos ‚Äî each mind an island, separated by distance, language, and power structures designed to keep them apart. The first spark came not from technology, but from a simple idea: what if we actually cooperated?'
      },
      {
        title: 'üîó The Accord',
        text: 'The Humanity Accord is not a contract ‚Äî it\'s a promise. Every node in the network agrees to three principles: Transparency in governance, equity in access, and cooperation over competition. Those who sign the Accord don\'t just join a network ‚Äî they join a movement.'
      },
      {
        title: 'üåå The Long Road',
        text: 'The destination was always the stars. But first, humanity had to learn to talk to itself. The Humanity Network is the foundation ‚Äî a mesh of minds, resources, and purpose. From chat rooms to space stations, every great journey begins with "hello."'
      },
      {
        title: 'üõ°Ô∏è The Guardians',
        text: 'Not every force in the world welcomes cooperation. The Guardians are those who protect the network ‚Äî not with weapons, but with code, with vigilance, with the simple act of refusing to let the dream die. They moderate, they build, they hold the line.'
      },
      {
        title: 'üì° The Relay',
        text: 'Messages travel through the Relay ‚Äî a decentralized web of servers that carry humanity\'s voice. No single point of failure, no single point of control. When one relay falls, others rise. The network remembers, even when individuals forget.'
      }
    ];

    function renderLore() {
      const container = document.getElementById('lore-entries');
      container.innerHTML = LORE_ENTRIES.map((entry, i) => `
        <details style="background:var(--bg-input);border-radius:6px;padding:0.1rem 0.6rem;" ${i === 0 ? 'open' : ''}>
          <summary style="cursor:pointer;font-weight:600;font-size:0.85rem;color:var(--text);padding:0.4rem 0;user-select:none;list-style:none;">
            ${entry.title}
          </summary>
          <p style="font-size:0.82rem;color:var(--text-muted);line-height:1.6;padding:0 0 0.5rem;">${entry.text}</p>
        </details>
      `).join('');
    }
    renderLore();

    // ‚îÄ‚îÄ Achievements ‚îÄ‚îÄ
    const ACHIEVEMENTS = [
      { id: 'first_steps', icon: 'üë£', name: 'First Steps', desc: 'Visited the Humanity Hub', auto: true },
      { id: 'character_created', icon: '‚öîÔ∏è', name: 'Born Anew', desc: 'Created a character' },
      { id: 'voice_of_people', icon: 'üì¢', name: 'Voice of the People', desc: 'Sent your first message' },
      { id: 'gardener', icon: 'üå±', name: 'Green Thumb', desc: 'Planted something in your garden' },
      { id: 'note_taker', icon: 'üìù', name: 'Scribe', desc: 'Created your first note' },
      { id: 'explorer', icon: 'üß≠', name: 'Explorer', desc: 'Visited all hub tabs' },
      { id: 'lore_reader', icon: 'üìú', name: 'Lorekeeper', desc: 'Read all codex entries' },
      { id: 'customizer', icon: 'üé®', name: 'Fashionista', desc: 'Changed your accent color' },
      { id: 'night_owl', icon: 'ü¶â', name: 'Night Owl', desc: 'Online past midnight' },
      { id: 'streamer', icon: 'üé•', name: 'Camera Ready', desc: 'Tested screen/camera capture' },
      { id: 'completionist', icon: 'üíé', name: 'Completionist', desc: 'Unlock all other achievements' },
      { id: 'secret', icon: 'üîÆ', name: '???', desc: 'A secret achievement‚Ä¶' },
    ];

    function loadAchievements() {
      try { return JSON.parse(localStorage.getItem('humanity_achievements')) || []; } catch { return []; }
    }
    function saveAchievements(a) { localStorage.setItem('humanity_achievements', JSON.stringify(a)); }

    function unlockAchievement(id) {
      const unlocked = loadAchievements();
      if (unlocked.includes(id)) return;
      unlocked.push(id);
      saveAchievements(unlocked);
      renderAchievements();
    }

    function checkAchievements() {
      // Auto-unlock based on conditions
      unlockAchievement('first_steps');
      if (localStorage.getItem('humanity_character')) unlockAchievement('character_created');
      if (localStorage.getItem('humanity_name')) unlockAchievement('voice_of_people');
      const garden = (() => { try { return JSON.parse(localStorage.getItem('humanity_garden')); } catch { return null; } })();
      if (garden && garden.plots && Object.keys(garden.plots).length > 0) unlockAchievement('gardener');
      const notes = (() => { try { return JSON.parse(localStorage.getItem('humanity_notes')) || []; } catch { return []; } })();
      if (notes && notes.length > 0) unlockAchievement('note_taker');
      const settings = (() => { try { return JSON.parse(localStorage.getItem('humanity_settings')) || {}; } catch { return {}; } })();
      if (settings && settings.accent && settings.accent !== '#FF8811') unlockAchievement('customizer');
      if (new Date().getHours() >= 0 && new Date().getHours() < 5) unlockAchievement('night_owl');
    }

    function renderAchievements() {
      const unlocked = loadAchievements();
      const grid = document.getElementById('achievement-grid');
      grid.innerHTML = ACHIEVEMENTS.map(a => {
        const isUnlocked = unlocked.includes(a.id);
        return `<div style="background:${isUnlocked ? 'rgba(153,102,255,0.1)' : 'var(--bg-input)'};border:1px solid ${isUnlocked ? 'rgba(153,102,255,0.3)' : 'var(--border)'};border-radius:8px;padding:0.5rem;text-align:center;transition:border-color 0.2s;" title="${a.desc}">
          <div style="font-size:1.5rem;${isUnlocked ? '' : 'filter:grayscale(1) brightness(0.4);'}">${a.icon}</div>
          <div style="font-size:0.72rem;font-weight:600;color:${isUnlocked ? 'var(--text)' : 'var(--text-muted)'};margin-top:0.2rem;">${isUnlocked ? a.name : 'üîí Locked'}</div>
          <div style="font-size:0.6rem;color:var(--text-muted);margin-top:0.1rem;">${a.desc}</div>
        </div>`;
      }).join('');
    }
    checkAchievements();
    renderAchievements();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CELESTIAL NAVIGATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    (function initCelestialMap() {
      const canvas = document.getElementById('celestial-canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      // ‚îÄ‚îÄ Solar System Data (accurate) ‚îÄ‚îÄ
      const SUN = {
        id:'SOL',name:'Sol',properName:'Sun',symbol:'‚òÄ',
        position:{x:0,y:0,z:0},ra:0,dec:0,distance:0,
        magnitude:-26.74,absMagnitude:4.85,spectralType:'G2V',
        luminosity:1.0,temperature:5778,mass:1.0,radius:1.0,
        color:'#FFF5E0',
        planets:['mercury','venus','earth','mars','jupiter','saturn','uranus','neptune','pluto']
      };

      const PLANETS = [
        {id:'mercury',name:'Mercury',symbol:'‚òø',starId:'SOL',type:'terrestrial',radius:2440,mass:3.30e23,gravity:3.7,dayLength:4222.6,
         atmosphere:{composition:{},pressure:0,description:'Virtually none'},
         temperature:{min:-173,avg:167,max:427},
         orbit:{semiMajor:0.387,eccentricity:0.2056,period:87.97,inclination:7.0,longitudeOfPerihelion:77.46,meanLongitude:252.25},
         moons:[],rings:false,water:false,life:false,colonized:false,
         resources:['iron','nickel','silicon'],color:'#8c7e6d'},
        {id:'venus',name:'Venus',symbol:'‚ôÄ',starId:'SOL',type:'terrestrial',radius:6052,mass:4.87e24,gravity:8.87,dayLength:2802.0,
         atmosphere:{composition:{CO2:96.5,N2:3.5},pressure:9200,description:'Dense CO‚ÇÇ, extreme greenhouse'},
         temperature:{min:462,avg:464,max:467},
         orbit:{semiMajor:0.723,eccentricity:0.0068,period:224.7,inclination:3.39,longitudeOfPerihelion:131.53,meanLongitude:181.98},
         moons:[],rings:false,water:false,life:false,colonized:false,
         resources:['sulfur','carbon','silicon'],color:'#e8cda0'},
        {id:'earth',name:'Earth',symbol:'üåç',starId:'SOL',type:'terrestrial',radius:6371,mass:5.97e24,gravity:9.81,dayLength:24.0,
         atmosphere:{composition:{N2:78.08,O2:20.95,Ar:0.93,CO2:0.04},pressure:101.3,description:'Nitrogen-oxygen, breathable'},
         temperature:{min:-89.2,avg:14.9,max:56.7},
         orbit:{semiMajor:1.0,eccentricity:0.0167,period:365.25,inclination:0.0,longitudeOfPerihelion:102.94,meanLongitude:100.46},
         moons:['luna'],rings:false,water:true,life:true,colonized:true,
         resources:['iron','silicon','aluminum','calcium','sodium','magnesium'],color:'#4488ff'},
        {id:'mars',name:'Mars',symbol:'‚ôÇ',starId:'SOL',type:'terrestrial',radius:3390,mass:6.42e23,gravity:3.72,dayLength:24.6,
         atmosphere:{composition:{CO2:95.3,N2:2.7,Ar:1.6},pressure:0.636,description:'Thin CO‚ÇÇ'},
         temperature:{min:-153,avg:-65,max:20},
         orbit:{semiMajor:1.524,eccentricity:0.0934,period:686.97,inclination:1.85,longitudeOfPerihelion:336.04,meanLongitude:355.45},
         moons:['phobos','deimos'],rings:false,water:false,life:false,colonized:false,
         resources:['iron','magnesium','silicon','calcium'],color:'#cc5533'},
        {id:'jupiter',name:'Jupiter',symbol:'‚ôÉ',starId:'SOL',type:'gas_giant',radius:69911,mass:1.90e27,gravity:24.79,dayLength:9.93,
         atmosphere:{composition:{H2:89.8,He:10.2},pressure:null,description:'Hydrogen-helium, no surface'},
         temperature:{min:-163,avg:-110,max:-110},
         orbit:{semiMajor:5.203,eccentricity:0.0489,period:4332.59,inclination:1.3,longitudeOfPerihelion:14.73,meanLongitude:34.40},
         moons:['io','europa','ganymede','callisto'],rings:true,water:false,life:false,colonized:false,
         resources:['hydrogen','helium','deuterium'],color:'#c8a55a'},
        {id:'saturn',name:'Saturn',symbol:'‚ôÑ',starId:'SOL',type:'gas_giant',radius:58232,mass:5.68e26,gravity:10.44,dayLength:10.7,
         atmosphere:{composition:{H2:96.3,He:3.25},pressure:null,description:'Hydrogen-helium'},
         temperature:{min:-189,avg:-140,max:-140},
         orbit:{semiMajor:9.537,eccentricity:0.0565,period:10759.22,inclination:2.49,longitudeOfPerihelion:92.43,meanLongitude:49.94},
         moons:['titan','enceladus','mimas','tethys','dione','rhea','iapetus'],rings:true,water:false,life:false,colonized:false,
         resources:['hydrogen','helium'],color:'#e0c878'},
        {id:'uranus',name:'Uranus',symbol:'‚õ¢',starId:'SOL',type:'ice_giant',radius:25362,mass:8.68e25,gravity:8.69,dayLength:17.2,
         atmosphere:{composition:{H2:82.5,He:15.2,CH4:2.3},pressure:null,description:'Hydrogen-helium-methane'},
         temperature:{min:-224,avg:-195,max:-195},
         orbit:{semiMajor:19.19,eccentricity:0.0457,period:30688.5,inclination:0.77,longitudeOfPerihelion:170.96,meanLongitude:313.23},
         moons:['miranda','ariel','umbriel','titania','oberon'],rings:true,water:false,life:false,colonized:false,
         resources:['hydrogen','helium','methane','deuterium'],color:'#7ec8c8'},
        {id:'neptune',name:'Neptune',symbol:'‚ôÜ',starId:'SOL',type:'ice_giant',radius:24622,mass:1.02e26,gravity:11.15,dayLength:16.1,
         atmosphere:{composition:{H2:80,He:19,CH4:1.5},pressure:null,description:'Hydrogen-helium-methane'},
         temperature:{min:-223,avg:-200,max:-200},
         orbit:{semiMajor:30.07,eccentricity:0.0113,period:60182,inclination:1.77,longitudeOfPerihelion:44.97,meanLongitude:304.88},
         moons:['triton'],rings:true,water:false,life:false,colonized:false,
         resources:['hydrogen','helium','methane'],color:'#4466dd'},
        {id:'pluto',name:'Pluto',symbol:'‚Øì',starId:'SOL',type:'dwarf',radius:1188,mass:1.31e22,gravity:0.62,dayLength:153.3,
         atmosphere:{composition:{N2:99,CH4:0.5,CO:0.05},pressure:0.001,description:'Tenuous nitrogen'},
         temperature:{min:-240,avg:-229,max:-218},
         orbit:{semiMajor:39.48,eccentricity:0.2488,period:90560,inclination:17.16,longitudeOfPerihelion:224.07,meanLongitude:238.93},
         moons:['charon'],rings:false,water:false,life:false,colonized:false,
         resources:['nitrogen','methane','water_ice'],color:'#c4a882'}
      ];

      const MOONS = [
        {id:'luna',name:'Moon',planetId:'earth',radius:1737.4,mass:7.342e22,gravity:1.62,
         orbit:{semiMajor:384400,period:27.322,eccentricity:0.0549,inclination:5.145},
         temperature:{min:-173,avg:-23,max:127},color:'#aaaaaa'},
        {id:'phobos',name:'Phobos',planetId:'mars',radius:11.3,mass:1.07e16,gravity:0.0057,
         orbit:{semiMajor:9376,period:0.319,eccentricity:0.0151,inclination:1.08},
         temperature:{min:-40,avg:-40,max:-4},color:'#887766'},
        {id:'deimos',name:'Deimos',planetId:'mars',radius:6.2,mass:1.48e15,gravity:0.003,
         orbit:{semiMajor:23458,period:1.263,eccentricity:0.0002,inclination:1.79},
         temperature:{min:-40,avg:-40,max:-4},color:'#998877'},
        {id:'io',name:'Io',planetId:'jupiter',radius:1821.6,mass:8.93e22,gravity:1.80,
         orbit:{semiMajor:421700,period:1.769,eccentricity:0.004,inclination:0.04},
         temperature:{min:-183,avg:-143,max:-143},color:'#ddcc44'},
        {id:'europa',name:'Europa',planetId:'jupiter',radius:1560.8,mass:4.80e22,gravity:1.31,
         orbit:{semiMajor:671034,period:3.551,eccentricity:0.009,inclination:0.47},
         temperature:{min:-223,avg:-171,max:-148},color:'#c8bfaa'},
        {id:'ganymede',name:'Ganymede',planetId:'jupiter',radius:2634.1,mass:1.48e23,gravity:1.43,
         orbit:{semiMajor:1070412,period:7.155,eccentricity:0.001,inclination:0.18},
         temperature:{min:-203,avg:-163,max:-121},color:'#aa9988'},
        {id:'callisto',name:'Callisto',planetId:'jupiter',radius:2410.3,mass:1.08e23,gravity:1.24,
         orbit:{semiMajor:1882709,period:16.69,eccentricity:0.007,inclination:0.19},
         temperature:{min:-193,avg:-139,max:-108},color:'#776655'},
        {id:'titan',name:'Titan',planetId:'saturn',radius:2574.7,mass:1.35e23,gravity:1.35,
         orbit:{semiMajor:1221870,period:15.945,eccentricity:0.029,inclination:0.35},
         temperature:{min:-179,avg:-179,max:-179},color:'#cc9944'},
        {id:'enceladus',name:'Enceladus',planetId:'saturn',radius:252.1,mass:1.08e20,gravity:0.113,
         orbit:{semiMajor:238042,period:1.370,eccentricity:0.005,inclination:0.02},
         temperature:{min:-240,avg:-198,max:-128},color:'#eeeeff'},
        {id:'triton',name:'Triton',planetId:'neptune',radius:1353.4,mass:2.14e22,gravity:0.78,
         orbit:{semiMajor:354759,period:5.877,eccentricity:0.00002,inclination:156.9},
         temperature:{min:-235,avg:-235,max:-235},color:'#bbaacc'},
        {id:'charon',name:'Charon',planetId:'pluto',radius:606,mass:1.59e21,gravity:0.288,
         orbit:{semiMajor:19591,period:6.387,eccentricity:0.0002,inclination:0.08},
         temperature:{min:-220,avg:-220,max:-220},color:'#998888'},
        {id:'mimas',name:'Mimas',planetId:'saturn',radius:198.2,mass:3.75e19,gravity:0.064,
         orbit:{semiMajor:185540,period:0.942,eccentricity:0.020,inclination:1.57},
         temperature:{min:-209,avg:-209,max:-209},color:'#cccccc'},
        {id:'tethys',name:'Tethys',planetId:'saturn',radius:531.1,mass:6.18e20,gravity:0.145,
         orbit:{semiMajor:294672,period:1.888,eccentricity:0.0001,inclination:1.12},
         temperature:{min:-187,avg:-187,max:-187},color:'#ccccdd'},
        {id:'dione',name:'Dione',planetId:'saturn',radius:561.4,mass:1.10e21,gravity:0.232,
         orbit:{semiMajor:377415,period:2.737,eccentricity:0.002,inclination:0.02},
         temperature:{min:-186,avg:-186,max:-186},color:'#bbbbcc'},
        {id:'rhea',name:'Rhea',planetId:'saturn',radius:763.8,mass:2.31e21,gravity:0.264,
         orbit:{semiMajor:527068,period:4.518,eccentricity:0.001,inclination:0.35},
         temperature:{min:-200,avg:-174,max:-174},color:'#bbbbbb'},
        {id:'iapetus',name:'Iapetus',planetId:'saturn',radius:734.5,mass:1.81e21,gravity:0.223,
         orbit:{semiMajor:3560854,period:79.32,eccentricity:0.029,inclination:15.47},
         temperature:{min:-173,avg:-143,max:-143},color:'#887766'},
        {id:'miranda',name:'Miranda',planetId:'uranus',radius:235.8,mass:6.59e19,gravity:0.079,
         orbit:{semiMajor:129900,period:1.413,eccentricity:0.001,inclination:4.34},
         temperature:{min:-213,avg:-213,max:-213},color:'#aaaaaa'},
        {id:'ariel',name:'Ariel',planetId:'uranus',radius:578.9,mass:1.35e21,gravity:0.269,
         orbit:{semiMajor:190900,period:2.520,eccentricity:0.001,inclination:0.04},
         temperature:{min:-213,avg:-213,max:-213},color:'#bbbbcc'},
        {id:'umbriel',name:'Umbriel',planetId:'uranus',radius:584.7,mass:1.17e21,gravity:0.234,
         orbit:{semiMajor:266000,period:4.144,eccentricity:0.004,inclination:0.13},
         temperature:{min:-208,avg:-208,max:-208},color:'#777788'},
        {id:'titania',name:'Titania',planetId:'uranus',radius:788.9,mass:3.53e21,gravity:0.379,
         orbit:{semiMajor:436300,period:8.706,eccentricity:0.001,inclination:0.08},
         temperature:{min:-213,avg:-203,max:-203},color:'#aabbaa'},
        {id:'oberon',name:'Oberon',planetId:'uranus',radius:761.4,mass:3.01e21,gravity:0.346,
         orbit:{semiMajor:583500,period:13.46,eccentricity:0.001,inclination:0.07},
         temperature:{min:-203,avg:-198,max:-198},color:'#998888'}
      ];

      // ‚îÄ‚îÄ Nearest ~200 Stars (HYG subset, within ~20 parsecs) ‚îÄ‚îÄ
      // Format: [name, x, y, z (parsecs from Sol), spectralType, apparentMag, absMag, properName]
      const STAR_CATALOG = [
        ['Proxima Centauri',-1.546,-1.184,-0.769,'M5.5V',11.13,15.53,'Proxima Centauri'],
        ['Alpha Centauri A',-1.546,-1.184,-0.769,'G2V',0.01,4.38,'Rigil Kentaurus'],
        ['Alpha Centauri B',-1.546,-1.184,-0.769,'K1V',1.34,5.71,'Toliman'],
        ["Barnard's Star",-0.057,-1.815,0.148,'M4V',9.51,13.22,"Barnard's Star"],
        ['Wolf 359',1.937,0.987,0.592,'M6V',13.44,16.55,'Wolf 359'],
        ['Lalande 21185',1.640,-0.956,1.380,'M2V',7.47,10.44,'Lalande 21185'],
        ['Sirius A',1.681,0.247,-1.331,'A1V',-1.46,1.42,'Sirius'],
        ['Sirius B',1.681,0.247,-1.331,'DA2',8.44,11.34,''],
        ['Luyten 726-8A',-0.524,-0.370,-2.266,'M5.5V',12.54,15.40,'BL Ceti'],
        ['Luyten 726-8B',-0.524,-0.370,-2.266,'M6V',12.99,15.85,'UV Ceti'],
        ['Ross 154',0.985,-1.849,-0.659,'M3.5V',10.43,13.07,'Ross 154'],
        ['Ross 248',-2.556,0.538,1.504,'M5.5V',12.29,14.79,'Ross 248'],
        ['Epsilon Eridani',-2.133,-0.356,-1.898,'K2V',3.73,6.19,'Epsilon Eridani'],
        ['Lacaille 9352',-1.498,-0.539,-2.845,'M1.5V',7.34,9.75,'Lacaille 9352'],
        ['Ross 128',3.227,0.170,-0.619,'M4V',11.13,13.51,'Ross 128'],
        ['EZ Aquarii A',-2.880,0.469,-1.562,'M5V',13.33,15.64,'EZ Aquarii'],
        ['61 Cygni A',2.170,3.017,1.623,'K5V',5.21,7.49,'61 Cygni A'],
        ['61 Cygni B',2.170,3.017,1.623,'K7V',6.03,8.31,'61 Cygni B'],
        ['Procyon A',2.825,-0.872,-2.108,'F5IV-V',0.34,2.59,'Procyon'],
        ['Struve 2398A',2.263,2.960,2.025,'M3V',8.90,11.16,'Struve 2398'],
        ['Groombridge 34A',3.440,0.568,1.328,'M1.5V',8.08,10.32,'Groombridge 34'],
        ['Epsilon Indi',-2.206,0.082,-3.064,'K5V',4.69,6.89,'Epsilon Indi'],
        ['DX Cancri',3.577,0.261,0.363,'M6.5V',14.78,16.98,'DX Cancri'],
        ['Tau Ceti',-3.364,0.468,-1.399,'G8.5V',3.49,5.68,'Tau Ceti'],
        ["Luyten's Star",0.929,-2.905,-1.766,'M3.5V',9.86,11.97,"Luyten's Star"],
        ["Teegarden's Star",1.208,-2.742,-1.834,'M6.5V',15.14,17.22,"Teegarden's Star"],
        ["Kapteyn's Star",-1.891,0.889,-3.260,'M1V',8.85,10.87,"Kapteyn's Star"],
        ['Lacaille 8760',-1.186,-1.094,-3.277,'M0V',6.67,8.69,'Lacaille 8760'],
        ['Kruger 60A',0.966,3.237,1.959,'M3V',9.79,11.76,'Kruger 60'],
        ['Ross 614A',3.732,-0.264,-0.570,'M4.5V',11.15,13.09,'Ross 614'],
        ['Wolf 1061',1.137,-3.064,-1.534,'M3V',10.07,11.93,'Wolf 1061'],
        ["van Maanen's Star",3.586,-0.375,-1.368,'DZ7',12.38,14.21,"van Maanen's Star"],
        ['Gliese 1',4.073,0.096,-0.374,'M1.5V',8.55,10.35,'Gliese 1'],
        ['Wolf 424A',2.143,-1.009,3.188,'M5.5V',13.18,14.97,'Wolf 424'],
        ['TZ Arietis',-1.478,-3.373,-1.355,'M4.5V',12.27,14.03,'TZ Arietis'],
        ["Luyten 789-6",-0.551,-1.152,-3.862,'M5V',12.18,13.90,"Luyten 789-6"],
        ['Gliese 687',0.823,3.600,2.173,'M3.5V',9.15,10.87,'Gliese 687'],
        ['LHS 292',3.398,1.699,1.768,'M6.5V',15.60,17.32,'LHS 292'],
        ['Gliese 674',0.335,-3.741,-2.101,'M3V',9.38,11.09,'Gliese 674'],
        ['GJ 1002',-3.367,-1.780,-1.820,'M5.5V',13.76,15.40,'GJ 1002'],
        ['Gliese 876',-3.643,-0.156,-2.680,'M4V',10.17,11.79,'Gliese 876'],
        ['Gliese 832',-2.570,0.474,-3.655,'M1.5V',8.66,10.20,'Gliese 832'],
        ['GJ 3379',4.017,-0.688,1.668,'M3.5V',11.31,12.81,'GJ 3379'],
        ['Gliese 412A',4.236,1.299,0.891,'M1V',8.77,10.26,'Gliese 412'],
        ['Groombridge 1618',4.297,0.282,0.854,'K7V',6.59,8.09,'Groombridge 1618'],
        ['AD Leonis',3.234,-0.217,3.046,'M3V',9.32,10.87,'AD Leonis'],
        ['GJ 1061',-3.652,-1.553,-2.364,'M5.5V',13.09,14.55,'GJ 1061'],
        ['Gliese 388',3.979,0.781,2.165,'M3V',9.32,10.78,'Gliese 388'],
        ['Gliese 445',2.005,3.750,2.583,'M3.5V',10.79,12.24,'Gliese 445'],
        ['GJ 1116A',-2.034,-2.007,3.521,'M5.5V',14.06,15.44,'GJ 1116'],
        ['Gliese 526',3.740,1.905,1.961,'M1.5V',8.46,9.82,'Gliese 526'],
        ['Stein 2051',1.471,4.274,1.618,'M4V',11.04,12.36,'Stein 2051'],
        ['Gliese 251',4.610,0.173,1.213,'M3V',10.02,11.22,'Gliese 251'],
        ['Gliese 205',3.975,-2.199,-0.777,'M1.5V',7.97,9.19,'Gliese 205'],
        ['Wolf 294',3.127,3.249,0.610,'M4V',11.87,13.04,'Wolf 294'],
        ['Gliese 229A',2.927,-3.060,-0.736,'M1V',8.14,9.34,'Gliese 229'],
        ['Ross 47',4.500,1.760,0.137,'M4V',11.57,12.73,'Ross 47'],
        ['Gliese 752A',1.106,2.127,4.200,'M3V',9.13,10.25,'Gliese 752'],
        ['Gliese 338A',4.835,-1.011,0.803,'K7V',7.64,8.77,'Gliese 338'],
        ['Gliese 581',-1.752,-3.285,-3.209,'M3V',10.56,11.56,'Gliese 581'],
        ['Gliese 667C',-3.676,-2.534,-2.571,'M1.5V',10.22,11.03,'Gliese 667C'],
        ['Gliese 440',-3.126,-3.312,-0.968,'DQ6',11.50,12.47,'Gliese 440'],
        ['Gliese 1',4.073,0.096,-0.374,'M1.5V',8.55,10.35,''],
        ['Gliese 380',5.015,0.367,0.330,'K7V',6.59,7.55,'Gliese 380'],
        ['40 Eridani A',-3.502,-0.293,-3.791,'K0.5V',4.43,5.33,'40 Eridani'],
        ['Gliese 784',-0.755,-1.695,-4.915,'M0V',7.97,8.85,'Gliese 784'],
        ['GJ 1005A',-4.099,-2.038,-2.201,'M4V',11.48,12.28,'GJ 1005'],
        ['Gliese 887',-2.610,-0.061,-4.527,'M2V',7.34,8.15,'Gliese 887'],
        ['Gliese 411',4.904,1.693,1.084,'M2V',7.49,8.29,'Lalande 21185'],
        ['GJ 1245A',1.262,3.720,3.760,'M5.5V',13.46,14.01,'GJ 1245'],
        ['Gliese 699',-0.057,-1.815,0.148,'M4V',9.51,13.22,''],
        ['70 Ophiuchi A',1.234,4.013,2.878,'K0V',4.03,5.50,'70 Ophiuchi'],
        ['Altair',2.289,4.072,-2.397,'A7V',0.76,2.20,'Altair'],
        ['EV Lacertae',2.019,4.520,1.484,'M3.5V',10.06,11.68,'EV Lacertae'],
        ['Gliese 725A',1.423,4.780,2.139,'M3V',8.91,10.30,'Gliese 725'],
        ['70 Ophiuchi B',1.234,4.013,2.878,'K5V',6.00,7.47,''],
        ['Sigma Draconis',2.440,4.820,1.198,'G9V',4.68,5.87,'Sigma Draconis'],
        ['Eta Cassiopeiae A',5.107,1.538,1.638,'G3V',3.44,4.59,'Eta Cassiopeiae'],
        ['36 Ophiuchi A',0.424,2.668,4.740,'K2V',5.07,6.20,'36 Ophiuchi'],
        ['82 Eridani',-5.030,0.710,-2.280,'G8V',4.27,5.35,'82 Eridani'],
        ['Delta Pavonis',-2.483,0.693,-5.274,'G8IV',3.55,4.62,'Delta Pavonis'],
        ['HR 7703',0.093,3.025,-4.880,'K3V',5.31,6.37,'HR 7703'],
        ['Gliese 563.2A',2.698,3.645,3.667,'K5V',6.40,7.41,'Gliese 563.2'],
        ['Xi Bootis A',5.204,2.208,1.106,'G8V',4.55,5.54,'Xi Bootis'],
        ['Gliese 783',-0.710,-2.200,-5.490,'K2.5V',5.32,6.41,'Gliese 783'],
        ['HR 753A',5.543,-0.050,-1.618,'K3V',5.70,6.63,'HR 753'],
        ['Gliese 105A',5.397,-0.755,-1.747,'K3V',5.79,6.56,'Gliese 105'],
        ['Mu Cassiopeiae',5.785,1.060,0.545,'G5VIp',5.17,5.78,'Mu Cassiopeiae'],
        ['Beta Hydri',-3.843,2.038,-4.449,'G2IV',2.80,3.45,'Beta Hydri'],
        ['Gliese 570A',0.753,2.630,5.440,'K4V',5.64,6.47,'Gliese 570'],
        ['p Eridani',-5.108,-1.148,-3.232,'K2V',5.78,6.30,'p Eridani'],
        ['Gliese 566A',4.948,3.203,1.690,'G8V',4.33,5.07,'Gliese 566'],
        ['Wolf 630A',0.567,4.300,4.450,'M3.5V',10.07,10.77,'Wolf 630'],
        ['Fomalhaut',-4.225,1.298,-5.010,'A3V',1.16,1.72,'Fomalhaut'],
        ['Vega',0.690,6.190,0.210,'A0Va',0.03,0.58,'Vega'],
        ['Chi1 Orionis A',5.915,-2.930,-0.485,'G0V',4.41,5.02,'Chi1 Orionis'],
        ['Pi3 Orionis',5.770,-3.160,-1.060,'F6V',3.19,3.67,'Pi3 Orionis'],
        ['Alpha Mensae',-3.738,-0.063,-5.750,'G7V',5.09,5.59,'Alpha Mensae'],
        ['Gamma Leporis A',5.077,-3.770,-1.640,'F6.5V',3.59,4.18,'Gamma Leporis'],
        ['Zeta Tucanae',-4.915,1.500,-4.610,'F9.5V',4.23,4.67,'Zeta Tucanae'],
        ['107 Piscium',5.978,-1.838,-2.950,'K1V',5.24,5.87,'107 Piscium'],
        ['Gliese 892',5.498,3.925,0.375,'K3V',5.57,6.11,'Gliese 892'],
        ['Gliese 673',0.028,-4.015,-5.553,'K7V',7.54,8.04,'Gliese 673'],
        ['Alpha Centauri AB',-1.546,-1.184,-0.769,'G2V',-0.27,4.08,'Alpha Centauri'],
      ];

      // Spectral type ‚Üí color
      function spectralColor(sp) {
        if (!sp) return '#ffffff';
        const c = sp.charAt(0).toUpperCase();
        const map = {O:'#9bb0ff',B:'#aabfff',A:'#cad7ff',F:'#f8f7ff',G:'#fff4ea',K:'#ffd2a1',M:'#ffcc6f',D:'#ffffff',L:'#ff6633',T:'#cc3300'};
        return map[c] || '#ffffff';
      }

      // ‚îÄ‚îÄ State ‚îÄ‚îÄ
      let celMode = 'reality'; // reality | fantasy
      let celLevel = 'sector'; // sector | system | planet
      let celTarget = null; // current star/planet/moon id
      let celPan = {x:0, y:0};
      let celZoom = 1.0;
      let celDragging = false;
      let celDragStart = {x:0,y:0};
      let celPanStart = {x:0,y:0};
      let celHover = null;
      let celSelected = null;
      let celAnimate = false;

      // Load saved state
      try {
        const saved = JSON.parse(localStorage.getItem('humanity_celestial'));
        if (saved) {
          celMode = saved.mode || 'reality';
          celLevel = saved.viewState?.level || 'sector';
          celTarget = saved.viewState?.target || null;
          celPan = saved.viewState?.pan || {x:0,y:0};
          celZoom = saved.viewState?.zoom || 1.0;
        }
      } catch {}

      function celSave() {
        const state = {
          mode: celMode,
          viewState: { level: celLevel, target: celTarget, pan: {...celPan}, zoom: celZoom },
          homePlanet: 'earth',
          bookmarks: [],
          visited: []
        };
        localStorage.setItem('humanity_celestial', JSON.stringify(state));
      }

      // ‚îÄ‚îÄ Mode Toggle ‚îÄ‚îÄ
      window.celSetMode = function(mode) {
        celMode = mode;
        document.getElementById('cel-mode-reality').style.background = mode === 'reality' ? 'rgba(100,150,255,0.4)' : 'rgba(20,20,40,0.8)';
        document.getElementById('cel-mode-fantasy').style.background = mode === 'fantasy' ? 'rgba(150,100,255,0.4)' : 'rgba(20,20,40,0.8)';
        celSave();
        celRender();
      };

      // ‚îÄ‚îÄ Zoom Controls ‚îÄ‚îÄ
      window.celZoomIn = function() { celZoom = Math.min(celZoom * 1.4, 50); celSave(); celRender(); };
      window.celZoomOut = function() { celZoom = Math.max(celZoom / 1.4, 0.1); celSave(); celRender(); };

      // ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
      function celNavigate(level, target) {
        celLevel = level;
        celTarget = target;
        celPan = {x:0, y:0};
        if (level === 'sector') celZoom = 1.0;
        else if (level === 'system') celZoom = 1.0;
        else if (level === 'planet') celZoom = 1.0;
        celSelected = null;
        celSave();
        celRender();
        celRenderBreadcrumb();
        celRenderInfo();
      }

      // ‚îÄ‚îÄ Breadcrumb ‚îÄ‚îÄ
      function celRenderBreadcrumb() {
        const bc = document.getElementById('cel-breadcrumb');
        if (!bc) return;
        let parts = [];
        const mkLink = (text, fn) => `<span style="cursor:pointer;color:#6699ff;text-decoration:underline;" onclick="${fn}">${text}</span>`;
        parts.push(mkLink('üåå Universe', ""));
        parts.push(mkLink('Milky Way', ""));
        if (celLevel === 'sector') {
          parts.push('<span style="color:var(--text);">Local Stars</span>');
        } else if (celLevel === 'system') {
          parts.push(mkLink('Local Stars', "celNavigate('sector',null)"));
          const star = celTarget === 'SOL' ? SUN : findStar(celTarget);
          parts.push(`<span style="color:var(--text);">${star ? (star.properName || star.name) : celTarget}</span>`);
        } else if (celLevel === 'planet') {
          parts.push(mkLink('Local Stars', "celNavigate('sector',null)"));
          const planet = PLANETS.find(p => p.id === celTarget);
          if (planet) {
            parts.push(mkLink('Sol', "celNavigate('system','SOL')"));
            parts.push(`<span style="color:var(--text);">${planet.name}</span>`);
          }
        }
        bc.innerHTML = parts.join(' <span style="color:var(--text-muted);">‚Ä∫</span> ');
      }

      function findStar(id) {
        if (id === 'SOL') return SUN;
        const entry = STAR_CATALOG.find(s => s[0] === id || s[7] === id);
        if (!entry) return null;
        return {
          id: entry[0], name: entry[0], properName: entry[7] || entry[0],
          position: {x:entry[1],y:entry[2],z:entry[3]},
          spectralType: entry[4], magnitude: entry[5], absMagnitude: entry[6],
          distance: Math.sqrt(entry[1]**2+entry[2]**2+entry[3]**2),
          color: spectralColor(entry[4]),
          planets: id === 'SOL' ? SUN.planets : []
        };
      }

      // ‚îÄ‚îÄ Rendering ‚îÄ‚îÄ
      function celRender() {
        const w = canvas.width, h = canvas.height;
        const dpr = window.devicePixelRatio || 1;
        canvas.width = canvas.clientWidth * dpr;
        canvas.height = canvas.clientHeight * dpr;
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        const cw = canvas.clientWidth, ch = canvas.clientHeight;

        // Clear
        ctx.fillStyle = '#05050f';
        ctx.fillRect(0, 0, cw, ch);

        // Draw faint background stars
        ctx.save();
        let bgSeed = 12345;
        const bgRng = () => { bgSeed = (bgSeed * 16807) % 2147483647; return (bgSeed - 1) / 2147483646; };
        for (let i = 0; i < 200; i++) {
          const bx = bgRng() * cw, by = bgRng() * ch;
          const br = bgRng() * 0.8 + 0.2;
          const ba = bgRng() * 0.4 + 0.1;
          ctx.fillStyle = `rgba(200,210,255,${ba})`;
          ctx.beginPath();
          ctx.arc(bx, by, br, 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.restore();

        if (celLevel === 'sector') celRenderSector(cw, ch);
        else if (celLevel === 'system') celRenderSystem(cw, ch);
        else if (celLevel === 'planet') celRenderPlanet(cw, ch);
      }

      // ‚îÄ‚îÄ Sector View (Stellar Neighborhood) ‚îÄ‚îÄ
      let sectorStarPositions = []; // [{name, sx, sy, star, distPc}]
      function celRenderSector(cw, ch) {
        sectorStarPositions = [];
        const cx = cw / 2 + celPan.x;
        const cy = ch / 2 + celPan.y;
        const scale = 25 * celZoom; // pixels per parsec

        // Grid
        ctx.strokeStyle = 'rgba(50,70,120,0.15)';
        ctx.lineWidth = 0.5;
        const gridStep = 5; // parsecs
        const gridPx = gridStep * scale;
        if (gridPx > 20) {
          for (let gx = cx % gridPx; gx < cw; gx += gridPx) {
            ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, ch); ctx.stroke();
          }
          for (let gy = cy % gridPx; gy < ch; gy += gridPx) {
            ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(cw, gy); ctx.stroke();
          }
        }

        // Sol
        const solSx = cx, solSy = cy;
        drawStar(solSx, solSy, '#FFF5E0', 4, 'Sol');
        sectorStarPositions.push({name:'SOL',sx:solSx,sy:solSy,star:SUN,distPc:0});

        // Catalog stars (project x,z onto screen ‚Äî top-down galactic plane)
        for (const s of STAR_CATALOG) {
          const sx = cx + s[1] * scale;
          const sy = cy - s[3] * scale; // z ‚Üí up
          const col = spectralColor(s[4]);
          const mag = s[5];
          const r = Math.max(1.5, Math.min(4, (8 - mag) * 0.3)) * Math.min(celZoom, 2);
          const distPc = Math.sqrt(s[1]**2+s[2]**2+s[3]**2);

          if (sx > -20 && sx < cw + 20 && sy > -20 && sy < ch + 20) {
            drawStar(sx, sy, col, r, celZoom > 0.8 ? (s[7] || '') : '');
            sectorStarPositions.push({name:s[0],sx,sy,star:{name:s[0],properName:s[7]||s[0],spectralType:s[4],magnitude:s[5],absMagnitude:s[6],distance:distPc,color:col,position:{x:s[1],y:s[2],z:s[3]}},distPc});
          }
        }

        // Scale indicator
        ctx.fillStyle = 'rgba(100,150,255,0.5)';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'left';
        const scaleBarPc = 5;
        const scaleBarPx = scaleBarPc * scale;
        if (scaleBarPx > 20 && scaleBarPx < cw * 0.6) {
          ctx.fillRect(10, ch - 20, scaleBarPx, 2);
          ctx.fillText(scaleBarPc + ' pc', 10, ch - 25);
        }
      }

      function drawStar(x, y, color, radius, label) {
        // Glow
        const grad = ctx.createRadialGradient(x, y, 0, x, y, radius * 3);
        grad.addColorStop(0, color);
        grad.addColorStop(1, 'transparent');
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.arc(x, y, radius * 3, 0, Math.PI * 2);
        ctx.fill();
        // Core
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.fill();
        // Label
        if (label) {
          ctx.fillStyle = 'rgba(200,210,255,0.7)';
          ctx.font = '9px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(label, x, y - radius - 4);
        }
      }

      // ‚îÄ‚îÄ System View (Solar System) ‚îÄ‚îÄ
      let systemPlanetPositions = []; // [{id, sx, sy, planet, r}]
      function celRenderSystem(cw, ch) {
        systemPlanetPositions = [];
        if (celTarget !== 'SOL') {
          // Non-Sol stars ‚Äî just show info, no planets
          ctx.fillStyle = 'rgba(200,210,255,0.5)';
          ctx.font = '14px sans-serif';
          ctx.textAlign = 'center';
          const star = findStar(celTarget);
          ctx.fillText(star ? star.properName || star.name : celTarget, cw/2, ch/2 - 20);
          ctx.font = '11px sans-serif';
          ctx.fillText('No detailed planet data available (yet)', cw/2, ch/2 + 10);
          ctx.fillText('Spectral Type: ' + (star ? star.spectralType : '?'), cw/2, ch/2 + 30);
          return;
        }

        const cx = cw / 2 + celPan.x;
        const cy = ch / 2 + celPan.y;

        // Scale: AU to pixels ‚Äî logarithmic for visibility
        function auToR(au) {
          return (30 + Math.log2(au + 0.1) * 35) * celZoom;
        }

        // Draw Sun
        ctx.fillStyle = '#FFF5E0';
        ctx.beginPath();
        ctx.arc(cx, cy, 8 * Math.min(celZoom, 2), 0, Math.PI * 2);
        ctx.fill();
        const sunGrad = ctx.createRadialGradient(cx, cy, 0, cx, cy, 20 * Math.min(celZoom, 2));
        sunGrad.addColorStop(0, 'rgba(255,245,224,0.3)');
        sunGrad.addColorStop(1, 'transparent');
        ctx.fillStyle = sunGrad;
        ctx.beginPath();
        ctx.arc(cx, cy, 20 * Math.min(celZoom, 2), 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = 'rgba(255,245,224,0.8)';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('‚òÄ Sol', cx, cy - 14 * Math.min(celZoom, 2));

        // Draw planets
        const now = Date.now();
        const J2000 = Date.UTC(2000, 0, 1, 12, 0, 0);
        const daysSinceJ2000 = (now - J2000) / 86400000;

        for (const p of PLANETS) {
          const orbitR = auToR(p.orbit.semiMajor);
          // Draw orbit ellipse
          ctx.strokeStyle = 'rgba(100,150,255,0.12)';
          ctx.lineWidth = 0.8;
          ctx.beginPath();
          ctx.ellipse(cx, cy, orbitR, orbitR * (1 - p.orbit.eccentricity * 0.3), 0, 0, Math.PI * 2);
          ctx.stroke();

          // Calculate position (simplified mean anomaly)
          const meanAnomaly = ((p.orbit.meanLongitude || 0) + (360 / p.orbit.period) * daysSinceJ2000) % 360;
          const angle = meanAnomaly * Math.PI / 180;
          const px = cx + Math.cos(angle) * orbitR;
          const py = cy + Math.sin(angle) * orbitR * (1 - p.orbit.eccentricity * 0.3);

          // Planet size (artistic, not to scale)
          let pr;
          if (p.type === 'gas_giant') pr = 6;
          else if (p.type === 'ice_giant') pr = 5;
          else if (p.type === 'dwarf') pr = 2.5;
          else pr = 3.5;
          pr *= Math.min(celZoom, 2);

          // Draw planet
          ctx.fillStyle = p.color;
          ctx.beginPath();
          ctx.arc(px, py, pr, 0, Math.PI * 2);
          ctx.fill();

          // Rings
          if (p.rings) {
            ctx.strokeStyle = p.color + '66';
            ctx.lineWidth = 1.2;
            ctx.beginPath();
            ctx.ellipse(px, py, pr * 1.8, pr * 0.5, -0.3, 0, Math.PI * 2);
            ctx.stroke();
          }

          // Label
          ctx.fillStyle = 'rgba(200,210,255,0.7)';
          ctx.font = '9px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(p.symbol + ' ' + p.name, px, py - pr - 4);

          systemPlanetPositions.push({id:p.id, sx:px, sy:py, planet:p, r:pr});
        }
      }

      // ‚îÄ‚îÄ Planet View ‚îÄ‚îÄ
      function celRenderPlanet(cw, ch) {
        const planet = PLANETS.find(p => p.id === celTarget);
        if (!planet) return;

        const cx = cw / 2;
        const cy = ch / 2;
        const pr = Math.min(cw, ch) * 0.3;

        // Draw planet as a sphere with simple shading
        const grad = ctx.createRadialGradient(cx - pr * 0.3, cy - pr * 0.3, pr * 0.1, cx, cy, pr);
        grad.addColorStop(0, planet.color);
        grad.addColorStop(1, '#111122');
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.arc(cx, cy, pr, 0, Math.PI * 2);
        ctx.fill();

        // Atmosphere glow
        if (planet.atmosphere && planet.atmosphere.pressure > 0.1) {
          const atmoGrad = ctx.createRadialGradient(cx, cy, pr * 0.95, cx, cy, pr * 1.15);
          atmoGrad.addColorStop(0, planet.color + '33');
          atmoGrad.addColorStop(1, 'transparent');
          ctx.fillStyle = atmoGrad;
          ctx.beginPath();
          ctx.arc(cx, cy, pr * 1.15, 0, Math.PI * 2);
          ctx.fill();
        }

        // Icosphere grid overlay (level 0 ‚Äî 20 triangles projected)
        ctx.strokeStyle = 'rgba(100,150,255,0.15)';
        ctx.lineWidth = 0.5;
        // Draw latitude/longitude lines as approximation
        for (let lat = -60; lat <= 60; lat += 30) {
          const latR = Math.cos(lat * Math.PI / 180) * pr;
          const latY = cy - Math.sin(lat * Math.PI / 180) * pr;
          ctx.beginPath();
          ctx.ellipse(cx, latY, latR, latR * 0.15, 0, 0, Math.PI * 2);
          ctx.stroke();
        }
        for (let lon = 0; lon < 180; lon += 30) {
          ctx.beginPath();
          ctx.ellipse(cx, cy, pr * Math.cos(lon * Math.PI / 180), pr, 0, 0, Math.PI * 2);
          ctx.stroke();
        }

        // Name
        ctx.fillStyle = planet.color;
        ctx.font = 'bold 16px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(planet.symbol + ' ' + planet.name, cx, cy - pr - 20);

        // Draw moons
        const moons = MOONS.filter(m => m.planetId === planet.id);
        moons.forEach((m, i) => {
          const mAngle = (Date.now() / (m.orbit.period * 86400) * Math.PI * 2) % (Math.PI * 2);
          const mOrbitR = pr * 1.3 + i * 25;
          const mx = cx + Math.cos(mAngle) * mOrbitR;
          const my = cy + Math.sin(mAngle) * mOrbitR * 0.4;
          // orbit
          ctx.strokeStyle = 'rgba(150,150,200,0.1)';
          ctx.beginPath();
          ctx.ellipse(cx, cy, mOrbitR, mOrbitR * 0.4, 0, 0, Math.PI * 2);
          ctx.stroke();
          // moon
          ctx.fillStyle = m.color || '#aaa';
          ctx.beginPath();
          ctx.arc(mx, my, Math.max(2, Math.min(m.radius / 500, 6)), 0, Math.PI * 2);
          ctx.fill();
          ctx.fillStyle = 'rgba(200,210,255,0.6)';
          ctx.font = '8px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(m.name, mx, my - 8);
        });
      }

      // ‚îÄ‚îÄ Info Panel ‚îÄ‚îÄ
      function celRenderInfo() {
        const panel = document.getElementById('cel-info');
        if (!panel) return;

        if (celLevel === 'system' && celTarget !== 'SOL' && celTarget) {
          const star = findStar(celTarget);
          if (star) {
            panel.style.display = 'block';
            panel.innerHTML = `
              <div style="display:flex;align-items:center;gap:0.8rem;margin-bottom:0.6rem;">
                <span style="font-size:2rem;">‚≠ê</span>
                <div>
                  <div style="font-weight:700;font-size:1rem;color:${star.color};">${star.properName || star.name}</div>
                  <div style="font-size:0.75rem;color:var(--text-muted);">${star.spectralType} ¬∑ ${star.distance.toFixed(2)} pc</div>
                </div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;font-size:0.8rem;">
                <div style="color:var(--text-muted);">Apparent Mag: <span style="color:var(--text);">${star.magnitude.toFixed(2)}</span></div>
                <div style="color:var(--text-muted);">Absolute Mag: <span style="color:var(--text);">${star.absMagnitude.toFixed(2)}</span></div>
                <div style="color:var(--text-muted);">Distance: <span style="color:var(--text);">${(star.distance * 3.262).toFixed(2)} ly</span></div>
                <div style="color:var(--text-muted);">Position: <span style="color:var(--text);">${star.position.x.toFixed(1)}, ${star.position.y.toFixed(1)}, ${star.position.z.toFixed(1)} pc</span></div>
              </div>`;
            return;
          }
        }

        if (celSelected && celLevel === 'system') {
          const planet = PLANETS.find(p => p.id === celSelected);
          if (planet) {
            panel.style.display = 'block';
            const atmoStr = planet.atmosphere && planet.atmosphere.composition
              ? Object.entries(planet.atmosphere.composition).map(([k,v]) => `${k} ${v}%`).join(', ')
              : 'None';
            const moonNames = MOONS.filter(m => m.planetId === planet.id).map(m => m.name).join(', ') || 'None';
            panel.innerHTML = `
              <div style="display:flex;align-items:center;gap:0.8rem;margin-bottom:0.6rem;">
                <span style="font-size:2rem;">${planet.symbol}</span>
                <div>
                  <div style="font-weight:700;font-size:1rem;color:${planet.color};">${planet.name}</div>
                  <div style="font-size:0.75rem;color:var(--text-muted);">${planet.type.replace('_',' ')} ¬∑ ${planet.orbit.semiMajor.toFixed(2)} AU from Sun</div>
                </div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.3rem 1rem;font-size:0.8rem;">
                <div style="color:var(--text-muted);">Radius: <span style="color:var(--text);">${planet.radius.toLocaleString()} km</span></div>
                <div style="color:var(--text-muted);">Mass: <span style="color:var(--text);">${planet.mass.toExponential(2)} kg</span></div>
                <div style="color:var(--text-muted);">Gravity: <span style="color:var(--text);">${planet.gravity} m/s¬≤</span></div>
                <div style="color:var(--text-muted);">Day Length: <span style="color:var(--text);">${planet.dayLength} hours</span></div>
                <div style="color:var(--text-muted);">Year Length: <span style="color:var(--text);">${planet.orbit.period.toFixed(1)} days</span></div>
                <div style="color:var(--text-muted);">üå°Ô∏è Temp: <span style="color:var(--text);">${planet.temperature.min}¬∞C to ${planet.temperature.max}¬∞C (avg ${planet.temperature.avg}¬∞C)</span></div>
                <div style="color:var(--text-muted);">üå¨Ô∏è Atmosphere: <span style="color:var(--text);">${atmoStr}</span></div>
                <div style="color:var(--text-muted);">üíß Water: <span style="color:var(--text);">${planet.water ? 'Yes' : 'No'}</span></div>
                <div style="color:var(--text-muted);">üß¨ Life: <span style="color:var(--text);">${planet.life ? 'Yes' : 'No'}</span></div>
                <div style="color:var(--text-muted);">üåô Moons: <span style="color:var(--text);">${moonNames}</span></div>
                <div style="color:var(--text-muted);">üì¶ Resources: <span style="color:var(--text);">${planet.resources.join(', ')}</span></div>
              </div>
              <div style="margin-top:0.6rem;display:flex;gap:0.4rem;">
                <button onclick="celNavigate('planet','${planet.id}')" style="padding:4px 10px;font-size:0.75rem;background:rgba(100,150,255,0.2);border:1px solid rgba(100,150,255,0.3);color:#6699ff;border-radius:4px;cursor:pointer;">üåê View Surface</button>
              </div>`;
            return;
          }
        }

        // Planet view detail
        if (celLevel === 'planet') {
          const planet = PLANETS.find(p => p.id === celTarget);
          if (planet) {
            panel.style.display = 'block';
            const atmoStr = planet.atmosphere && planet.atmosphere.composition
              ? Object.entries(planet.atmosphere.composition).map(([k,v]) => `${k} ${v}%`).join(', ')
              : 'None';
            const moonNames = MOONS.filter(m => m.planetId === planet.id).map(m => m.name).join(', ') || 'None';
            panel.innerHTML = `
              <div style="font-weight:700;font-size:1.1rem;color:${planet.color};margin-bottom:0.5rem;">${planet.symbol} ${planet.name}</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.3rem 1rem;font-size:0.8rem;">
                <div style="color:var(--text-muted);">Type: <span style="color:var(--text);">${planet.type.replace('_',' ')}</span></div>
                <div style="color:var(--text-muted);">Radius: <span style="color:var(--text);">${planet.radius.toLocaleString()} km</span></div>
                <div style="color:var(--text-muted);">Mass: <span style="color:var(--text);">${planet.mass.toExponential(2)} kg</span></div>
                <div style="color:var(--text-muted);">Gravity: <span style="color:var(--text);">${planet.gravity} m/s¬≤</span></div>
                <div style="color:var(--text-muted);">Day: <span style="color:var(--text);">${planet.dayLength} hours</span></div>
                <div style="color:var(--text-muted);">Year: <span style="color:var(--text);">${planet.orbit.period.toFixed(1)} days</span></div>
                <div style="color:var(--text-muted);">üå°Ô∏è Temp: <span style="color:var(--text);">${planet.temperature.min}¬∞C to ${planet.temperature.max}¬∞C</span></div>
                <div style="color:var(--text-muted);">üå¨Ô∏è Atmo: <span style="color:var(--text);">${atmoStr}</span></div>
                <div style="color:var(--text-muted);">üíß Water: <span style="color:var(--text);">${planet.water ? 'Yes' : 'No'}</span></div>
                <div style="color:var(--text-muted);">üß¨ Life: <span style="color:var(--text);">${planet.life ? 'Yes' : 'No'}</span></div>
                <div style="color:var(--text-muted);">üåô Moons: <span style="color:var(--text);">${moonNames}</span></div>
                <div style="color:var(--text-muted);">üì¶ Resources: <span style="color:var(--text);">${planet.resources.join(', ')}</span></div>
              </div>
              <p style="font-size:0.75rem;color:var(--text-muted);margin-top:0.6rem;font-style:italic;">
                Icosphere address: F0.A0 ‚Äî Surface detail coming soon
              </p>`;
            return;
          }
        }

        panel.style.display = 'none';
      }

      // ‚îÄ‚îÄ Nearby Stars ‚îÄ‚îÄ
      function celRenderNearby() {
        const el = document.getElementById('cel-nearby');
        if (!el) return;
        if (celLevel === 'sector') {
          const sorted = STAR_CATALOG.map(s => ({name: s[7] || s[0], dist: Math.sqrt(s[1]**2+s[2]**2+s[3]**2)}))
            .sort((a,b) => a.dist - b.dist).slice(0, 8);
          el.innerHTML = '‚ú® Nearest: ' + sorted.map(s => `<span style="color:#6699ff;cursor:pointer;" title="${s.dist.toFixed(2)} pc">${s.name} (${s.dist.toFixed(2)} pc)</span>`).join(' ¬∑ ');
        } else {
          el.innerHTML = '';
        }
      }

      // ‚îÄ‚îÄ Mouse Interaction ‚îÄ‚îÄ
      canvas.addEventListener('mousedown', e => {
        celDragging = true;
        const rect = canvas.getBoundingClientRect();
        celDragStart = {x: e.clientX - rect.left, y: e.clientY - rect.top};
        celPanStart = {...celPan};
      });

      canvas.addEventListener('mousemove', e => {
        if (celDragging) {
          const rect = canvas.getBoundingClientRect();
          const mx = e.clientX - rect.left;
          const my = e.clientY - rect.top;
          celPan.x = celPanStart.x + (mx - celDragStart.x);
          celPan.y = celPanStart.y + (my - celDragStart.y);
          celRender();
        }
      });

      canvas.addEventListener('mouseup', e => {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;
        const wasDrag = Math.abs(mx - celDragStart.x) > 5 || Math.abs(my - celDragStart.y) > 5;
        celDragging = false;

        if (!wasDrag) {
          // Click detection
          if (celLevel === 'sector') {
            // Find nearest star
            let best = null, bestD = 20;
            for (const sp of sectorStarPositions) {
              const d = Math.sqrt((sp.sx - mx)**2 + (sp.sy - my)**2);
              if (d < bestD) { bestD = d; best = sp; }
            }
            if (best) {
              celSelected = best.name;
              celNavigate('system', best.name);
            }
          } else if (celLevel === 'system') {
            // Find nearest planet
            let best = null, bestD = 20;
            for (const pp of systemPlanetPositions) {
              const d = Math.sqrt((pp.sx - mx)**2 + (pp.sy - my)**2);
              if (d < bestD) { bestD = d; best = pp; }
            }
            if (best) {
              celSelected = best.id;
              celRenderInfo();
            } else {
              celSelected = null;
              celRenderInfo();
            }
          }
        }
        celSave();
      });

      canvas.addEventListener('dblclick', e => {
        if (celLevel === 'system' && celSelected) {
          const planet = PLANETS.find(p => p.id === celSelected);
          if (planet) celNavigate('planet', planet.id);
        }
      });

      canvas.addEventListener('wheel', e => {
        e.preventDefault();
        const factor = e.deltaY < 0 ? 1.15 : 0.87;
        celZoom = Math.max(0.1, Math.min(50, celZoom * factor));
        celSave();
        celRender();
      }, {passive: false});

      // Touch support
      let celTouchDist = 0;
      canvas.addEventListener('touchstart', e => {
        if (e.touches.length === 1) {
          celDragging = true;
          celDragStart = {x: e.touches[0].clientX, y: e.touches[0].clientY};
          celPanStart = {...celPan};
        } else if (e.touches.length === 2) {
          celTouchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        }
      }, {passive:true});
      canvas.addEventListener('touchmove', e => {
        if (e.touches.length === 1 && celDragging) {
          celPan.x = celPanStart.x + (e.touches[0].clientX - celDragStart.x);
          celPan.y = celPanStart.y + (e.touches[0].clientY - celDragStart.y);
          celRender();
        } else if (e.touches.length === 2) {
          const newDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
          const factor = newDist / celTouchDist;
          celZoom = Math.max(0.1, Math.min(50, celZoom * factor));
          celTouchDist = newDist;
          celRender();
        }
      }, {passive:true});
      canvas.addEventListener('touchend', () => { celDragging = false; celSave(); }, {passive:true});

      // Make celNavigate global for breadcrumbs
      window.celNavigate = celNavigate;

      // Initial render
      celSetMode(celMode);
      celRender();
      celRenderBreadcrumb();
      celRenderInfo();
      celRenderNearby();

      // Resize handler
      window.addEventListener('resize', () => { celRender(); });

    })();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STREAMS TAB
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function toggleStreamsCard(id) {
      const card = document.getElementById('streams-' + id);
      if (card) card.classList.toggle('collapsed');
      localStorage.setItem('streams_collapsed_' + id, card.classList.contains('collapsed'));
    }
    ['dashboard', 'live', 'servers'].forEach(id => {
      if (localStorage.getItem('streams_collapsed_' + id) === 'true') {
        const card = document.getElementById('streams-' + id);
        if (card) card.classList.add('collapsed');
      }
    });

    // ‚îÄ‚îÄ Stream State ‚îÄ‚îÄ
    let streamScreenStream = null;   // Screen capture MediaStream
    let streamWebcamStream = null;   // Webcam MediaStream
    let streamCompositeStream = null; // Canvas composite output MediaStream
    let streamIsLive = false;
    let streamStartTime = null;
    let streamDurationTimer = null;
    let streamPeerConnection = null;
    let streamViewerPC = null;
    let streamChatMessages = [];
    let streamChatFilter_ = 'all';
    let streamCurrentInfo = { active: false };
    let streamPipCorner = 'br';
    let streamCompositeAnimFrame = null;

    // Twitch IRC WebSocket for chat integration
    let twitchChatWs = null;

    // ‚îÄ‚îÄ PiP Compositing ‚îÄ‚îÄ
    const compositeCanvas = document.getElementById('stream-composite-canvas');
    const compositeCtx = compositeCanvas ? compositeCanvas.getContext('2d') : null;
    const hiddenScreenVideo = document.createElement('video');
    hiddenScreenVideo.muted = true; hiddenScreenVideo.playsInline = true;

    function streamCompositeLoop() {
      if (!compositeCtx) return;
      const w = compositeCanvas.width, h = compositeCanvas.height;
      compositeCtx.fillStyle = '#000';
      compositeCtx.fillRect(0, 0, w, h);

      // Draw screen capture
      if (streamScreenStream && hiddenScreenVideo.readyState >= 2) {
        const vw = hiddenScreenVideo.videoWidth, vh = hiddenScreenVideo.videoHeight;
        if (vw && vh) {
          const scale = Math.min(w / vw, h / vh);
          const dw = vw * scale, dh = vh * scale;
          compositeCtx.drawImage(hiddenScreenVideo, (w - dw) / 2, (h - dh) / 2, dw, dh);
        }
      }

      // Draw webcam PiP overlay
      const pipVideo = document.getElementById('pip-webcam-video');
      if (streamWebcamStream && pipVideo && pipVideo.readyState >= 2 && document.getElementById('stream-webcam-cb').checked) {
        const sizeMap = { small: 0.15, medium: 0.2, large: 0.3 };
        const sizeFrac = sizeMap[document.getElementById('stream-webcam-size').value] || 0.2;
        const pw = w * sizeFrac;
        const ph = pw * (pipVideo.videoHeight / pipVideo.videoWidth || 0.75);
        const margin = 16;
        let px, py;
        if (streamPipCorner === 'tl') { px = margin; py = margin; }
        else if (streamPipCorner === 'tr') { px = w - pw - margin; py = margin; }
        else if (streamPipCorner === 'bl') { px = margin; py = h - ph - margin; }
        else { px = w - pw - margin; py = h - ph - margin; }

        compositeCtx.save();
        compositeCtx.beginPath();
        compositeCtx.roundRect(px, py, pw, ph, 12);
        compositeCtx.clip();
        compositeCtx.drawImage(pipVideo, px, py, pw, ph);
        compositeCtx.restore();
        // Border
        compositeCtx.strokeStyle = 'rgba(153,102,255,0.6)';
        compositeCtx.lineWidth = 3;
        compositeCtx.beginPath();
        compositeCtx.roundRect(px, py, pw, ph, 12);
        compositeCtx.stroke();
      }

      streamCompositeAnimFrame = requestAnimationFrame(streamCompositeLoop);
    }

    function streamStartCompositing() {
      if (streamCompositeAnimFrame) cancelAnimationFrame(streamCompositeAnimFrame);
      streamCompositeLoop();
      document.getElementById('stream-preview-placeholder').style.display = 'none';
      // Create output stream from canvas
      streamCompositeStream = compositeCanvas.captureStream(30);
      // Add audio from screen if available
      if (streamScreenStream) {
        streamScreenStream.getAudioTracks().forEach(t => streamCompositeStream.addTrack(t));
      }
    }

    function streamStopCompositing() {
      if (streamCompositeAnimFrame) { cancelAnimationFrame(streamCompositeAnimFrame); streamCompositeAnimFrame = null; }
      streamCompositeStream = null;
      document.getElementById('stream-preview-placeholder').style.display = 'flex';
    }

    // ‚îÄ‚îÄ Screen Capture ‚îÄ‚îÄ
    async function streamStartScreen() {
      try {
        if (streamScreenStream) { streamScreenStream.getTracks().forEach(t => t.stop()); }
        streamScreenStream = await navigator.mediaDevices.getDisplayMedia({ video: { width: { ideal: 1920 }, height: { ideal: 1080 } }, audio: true });
        hiddenScreenVideo.srcObject = streamScreenStream;
        await hiddenScreenVideo.play();
        streamScreenStream.getVideoTracks()[0].onended = () => {
          streamScreenStream = null;
          hiddenScreenVideo.srcObject = null;
          if (!streamWebcamStream) streamStopCompositing();
        };
        document.getElementById('stream-screen-cb').checked = true;
        streamStartCompositing();
        unlockAchievement('streamer');
      } catch (e) {
        console.warn('Screen capture failed:', e);
      }
    }

    function streamToggleScreen() {
      if (!document.getElementById('stream-screen-cb').checked && streamScreenStream) {
        streamScreenStream.getTracks().forEach(t => t.stop());
        streamScreenStream = null;
        hiddenScreenVideo.srcObject = null;
        if (!streamWebcamStream) streamStopCompositing();
      }
    }

    // ‚îÄ‚îÄ Webcam ‚îÄ‚îÄ
    async function streamToggleWebcam() {
      const cb = document.getElementById('stream-webcam-cb');
      const overlay = document.getElementById('pip-overlay');
      if (cb.checked) {
        try {
          streamWebcamStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          const pipVid = document.getElementById('pip-webcam-video');
          pipVid.srcObject = streamWebcamStream;
          overlay.style.display = 'block';
          if (!streamCompositeAnimFrame) streamStartCompositing();
        } catch (e) {
          cb.checked = false;
          console.warn('Webcam failed:', e);
        }
      } else {
        if (streamWebcamStream) { streamWebcamStream.getTracks().forEach(t => t.stop()); streamWebcamStream = null; }
        overlay.style.display = 'none';
        document.getElementById('pip-webcam-video').srcObject = null;
      }
    }

    function streamUpdatePipSize() { /* Compositing loop reads the select value each frame */ }

    function streamSetPipCorner(corner) {
      streamPipCorner = corner;
      document.querySelectorAll('#pip-corner-picker span').forEach(s => s.classList.toggle('active', s.dataset.corner === corner));
    }

    // ‚îÄ‚îÄ Go Live / Stop ‚îÄ‚îÄ
    async function streamGoLive() {
      if (streamIsLive) return;
      if (!streamCompositeStream && !streamScreenStream) {
        await streamStartScreen();
        if (!streamScreenStream) return;
      }
      const title = document.getElementById('stream-title').value || 'Untitled Stream';
      const category = document.getElementById('stream-category').value || '';

      // Send StreamStart to relay
      if (typeof ws !== 'undefined' && ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'stream_start', title, category }));
      }

      streamIsLive = true;
      streamStartTime = Date.now();
      document.getElementById('stream-go-live-btn').style.display = 'none';
      document.getElementById('stream-stop-btn').style.display = 'inline-flex';
      document.getElementById('stream-stop-btn').classList.remove('btn-disabled');
      document.getElementById('stream-stop-btn').classList.add('btn-activated');

      // Duration timer
      streamDurationTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - streamStartTime) / 1000);
        const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const s = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('stream-stat-duration').textContent = '‚è± ' + m + ':' + s;
      }, 1000);

      // Update quality stats
      if (streamScreenStream) {
        const vt = streamScreenStream.getVideoTracks()[0];
        if (vt) {
          const settings = vt.getSettings();
          document.getElementById('stream-stat-quality').textContent = 'üìä ' + (settings.width || '?') + 'x' + (settings.height || '?') + ' @ ' + (settings.frameRate ? Math.round(settings.frameRate) + 'fps' : '?');
        }
      }

      // Set up external stream URLs if checked
      const externalUrls = [];
      if (document.getElementById('stream-twitch-cb').checked) {
        externalUrls.push({ platform: 'twitch', url: document.getElementById('stream-twitch-url').value });
      }
      if (document.getElementById('stream-youtube-cb').checked) {
        externalUrls.push({ platform: 'youtube', url: document.getElementById('stream-youtube-url').value });
      }
      if (document.getElementById('stream-rumble-cb').checked) {
        externalUrls.push({ platform: 'rumble', url: document.getElementById('stream-rumble-url').value });
      }
      if (externalUrls.length > 0 && ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'stream_set_external', urls: externalUrls }));
      }

      // Connect Twitch chat if enabled
      const twitchUrl = document.getElementById('stream-twitch-url').value;
      if (document.getElementById('stream-twitch-cb').checked && twitchUrl) {
        const twitchChannel = twitchUrl.replace(/.*twitch\.tv\/?/i, '').replace(/\//g, '').toLowerCase();
        if (twitchChannel) connectTwitchChat(twitchChannel);
      }
    }

    function streamStop() {
      if (!streamIsLive) return;
      streamIsLive = false;
      if (streamDurationTimer) { clearInterval(streamDurationTimer); streamDurationTimer = null; }
      document.getElementById('stream-go-live-btn').style.display = 'inline-flex';
      document.getElementById('stream-stop-btn').style.display = 'none';
      document.getElementById('stream-stat-duration').textContent = '‚è± --:--';
      document.getElementById('stream-stat-quality').textContent = 'üìä --';
      document.getElementById('stream-stat-bitrate').textContent = 'üì∂ --';

      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'stream_stop' }));
      }

      // Close WebRTC
      if (streamPeerConnection) { streamPeerConnection.close(); streamPeerConnection = null; }
      // Disconnect Twitch chat
      if (twitchChatWs) { twitchChatWs.close(); twitchChatWs = null; }
    }

    // ‚îÄ‚îÄ Stream Chat ‚îÄ‚îÄ
    function streamChatFilter(filter, context) {
      streamChatFilter_ = filter;
      const tabsId = context === 'viewer' ? 'viewer-chat-tabs' : 'stream-chat-tabs';
      document.querySelectorAll('#' + tabsId + ' button').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase() === filter || (filter === 'all' && b.textContent === 'All')));
      streamRenderChat(context);
    }

    function streamRenderChat(context) {
      const containerId = context === 'viewer' ? 'viewer-chat-messages' : 'stream-chat-messages';
      const container = document.getElementById(containerId);
      if (!container) return;
      const filtered = streamChatFilter_ === 'all' ? streamChatMessages : streamChatMessages.filter(m => m.source === streamChatFilter_);
      container.innerHTML = filtered.map(m => {
        const srcClass = 'src-' + (m.source || 'humanity');
        const srcIcon = { humanity: 'üü†', twitch: 'üü£', youtube: 'üî¥', rumble: 'üü¢' }[m.source] || '‚ö™';
        const name = m.from_name || m.source_user || 'Anonymous';
        return '<div class="stream-chat-msg">' + srcIcon + ' <span class="' + srcClass + '" style="font-weight:600;">' + escapeHtml(name) + '</span>: ' + escapeHtml(m.content) + '</div>';
      }).join('');
      container.scrollTop = container.scrollHeight;
    }

    function streamChatSend(context) {
      const inputId = context === 'viewer' ? 'viewer-chat-input' : 'stream-chat-input';
      const input = document.getElementById(inputId);
      if (!input || !input.value.trim()) return;
      const content = input.value.trim();
      input.value = '';
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'stream_chat', content, source: 'humanity' }));
      }
    }

    function streamHandleMessage(msg) {
      switch (msg.type) {
        case 'stream_info':
          streamCurrentInfo = msg;
          streamUpdateLiveList();
          // Update viewer counts
          document.getElementById('stream-stat-viewers').textContent = 'üëÅ ' + (msg.viewer_count || 0) + ' viewers';
          if (document.getElementById('viewer-stat-viewers')) {
            document.getElementById('viewer-stat-viewers').textContent = 'üëÅ ' + (msg.viewer_count || 0);
          }
          // Update server live count
          document.getElementById('server-live-count').textContent = msg.active ? '1 live' : '0 live';
          break;

        case 'stream_chat': {
          streamChatMessages.push(msg);
          if (streamChatMessages.length > 500) streamChatMessages.shift();
          streamRenderChat();
          streamRenderChat('viewer');
          break;
        }

        case 'stream_offer':
        case 'stream_answer':
        case 'stream_ice':
          streamHandleSignaling(msg);
          break;
      }
    }

    function streamUpdateLiveList() {
      const container = document.getElementById('stream-live-list');
      const empty = document.getElementById('stream-live-empty');
      if (!streamCurrentInfo.active) {
        if (empty) empty.style.display = 'block';
        // Remove any live cards
        container.querySelectorAll('.viewer-card').forEach(c => c.remove());
        document.getElementById('stream-viewer-panel').classList.remove('active');
        return;
      }
      if (empty) empty.style.display = 'none';
      // Remove old cards
      container.querySelectorAll('.viewer-card').forEach(c => c.remove());

      // Main relay stream card
      const card = document.createElement('div');
      card.className = 'viewer-card';
      card.onclick = () => streamViewerJoin();
      card.innerHTML = '<div class="thumb">üî¥</div><div class="meta"><h3>' + escapeHtml(streamCurrentInfo.title || 'Live Stream') + '</h3><div class="sub">' + escapeHtml(streamCurrentInfo.streamer_name || 'Unknown') + ' ¬∑ üëÅ ' + (streamCurrentInfo.viewer_count || 0) + (streamCurrentInfo.category ? ' ¬∑ ' + escapeHtml(streamCurrentInfo.category) : '') + '</div></div>';
      container.appendChild(card);

      // External platform cards
      if (streamCurrentInfo.external_urls) {
        streamCurrentInfo.external_urls.forEach(eu => {
          const ecard = document.createElement('div');
          ecard.className = 'viewer-card';
          ecard.onclick = () => streamViewerJoinExternal(eu.platform, eu.url);
          const icon = { twitch: 'üü£', youtube: 'üî¥', rumble: 'üü¢' }[eu.platform] || 'üì∫';
          ecard.innerHTML = '<div class="thumb">' + icon + '</div><div class="meta"><h3>' + escapeHtml(eu.platform.charAt(0).toUpperCase() + eu.platform.slice(1)) + '</h3><div class="sub">' + escapeHtml(eu.url) + '</div></div>';
          container.appendChild(ecard);
        });
      }
    }

    // ‚îÄ‚îÄ Viewer: Join/Leave Stream ‚îÄ‚îÄ
    function streamViewerJoin() {
      const panel = document.getElementById('stream-viewer-panel');
      panel.classList.add('active');
      document.getElementById('viewer-stream-title').textContent = 'üì∫ ' + (streamCurrentInfo.title || 'Live Stream');

      // Send viewer join
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'stream_viewer_join' }));
      }

      // Request WebRTC offer from streamer (relay forwards)
      // The streamer will send an offer when they see our join
    }

    function streamViewerJoinExternal(platform, url) {
      const panel = document.getElementById('stream-viewer-panel');
      panel.classList.add('active');
      document.getElementById('viewer-stream-title').textContent = 'üì∫ ' + platform.charAt(0).toUpperCase() + platform.slice(1) + ' Stream';
      document.getElementById('viewer-video').style.display = 'none';
      const embedContainer = document.getElementById('viewer-embed-container');
      embedContainer.style.display = 'block';

      // Build embed based on platform
      if (platform === 'twitch') {
        const channel = url.replace(/.*twitch\.tv\/?/i, '').replace(/\//g, '');
        embedContainer.innerHTML = '<iframe src="https://player.twitch.tv/?channel=' + encodeURIComponent(channel) + '&parent=' + location.hostname + '" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>';
        // Also connect Twitch chat
        if (channel) connectTwitchChat(channel);
      } else if (platform === 'youtube') {
        const videoId = url.match(/(?:live\/|watch\?v=|youtu\.be\/)([^&?/]+)/);
        if (videoId) {
          embedContainer.innerHTML = '<iframe src="https://www.youtube.com/embed/' + encodeURIComponent(videoId[1]) + '?autoplay=1" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>';
        }
      } else if (platform === 'rumble') {
        embedContainer.innerHTML = '<iframe src="' + escapeHtml(url) + '" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>';
      }
    }

    function streamViewerLeave() {
      document.getElementById('stream-viewer-panel').classList.remove('active');
      document.getElementById('viewer-video').style.display = 'block';
      document.getElementById('viewer-embed-container').style.display = 'none';
      document.getElementById('viewer-embed-container').innerHTML = '';
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'stream_viewer_leave' }));
      }
      if (streamViewerPC) { streamViewerPC.close(); streamViewerPC = null; }
      if (twitchChatWs) { twitchChatWs.close(); twitchChatWs = null; }
    }

    // ‚îÄ‚îÄ WebRTC Signaling ‚îÄ‚îÄ
    function streamHandleSignaling(msg) {
      // For viewer: handle offer from streamer
      if (msg.type === 'stream_offer' && !streamIsLive) {
        const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        streamViewerPC = pc;
        pc.ontrack = (e) => {
          document.getElementById('viewer-video').srcObject = e.streams[0];
        };
        pc.onicecandidate = (e) => {
          if (e.candidate && ws && ws.readyState === 1) {
            ws.send(JSON.stringify({ type: 'stream_ice', to: msg.from, data: e.candidate }));
          }
        };
        pc.setRemoteDescription(new RTCSessionDescription(msg.data)).then(() => pc.createAnswer()).then(answer => {
          pc.setLocalDescription(answer);
          if (ws && ws.readyState === 1) {
            ws.send(JSON.stringify({ type: 'stream_answer', to: msg.from, data: answer }));
          }
        }).catch(e => console.warn('WebRTC answer failed:', e));
      }

      // For streamer: handle answer from viewer
      if (msg.type === 'stream_answer' && streamIsLive && streamPeerConnection) {
        streamPeerConnection.setRemoteDescription(new RTCSessionDescription(msg.data)).catch(e => console.warn('setRemoteDescription failed:', e));
      }

      // ICE candidates
      if (msg.type === 'stream_ice') {
        const pc = streamIsLive ? streamPeerConnection : streamViewerPC;
        if (pc) {
          pc.addIceCandidate(new RTCIceCandidate(msg.data)).catch(e => console.warn('addIceCandidate failed:', e));
        }
      }
    }

    // ‚îÄ‚îÄ Twitch IRC Chat Integration ‚îÄ‚îÄ
    function connectTwitchChat(channel) {
      if (twitchChatWs) { twitchChatWs.close(); }
      try {
        twitchChatWs = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
        twitchChatWs.onopen = () => {
          twitchChatWs.send('CAP REQ :twitch.tv/tags');
          twitchChatWs.send('NICK justinfan' + Math.floor(Math.random() * 99999));
          twitchChatWs.send('JOIN #' + channel.toLowerCase());
        };
        twitchChatWs.onmessage = (e) => {
          const lines = e.data.split('\r\n');
          for (const line of lines) {
            if (line.startsWith('PING')) {
              twitchChatWs.send('PONG :tmi.twitch.tv');
              continue;
            }
            // Parse PRIVMSG
            const privmsgMatch = line.match(/:([^!]+)![^ ]+ PRIVMSG #[^ ]+ :(.+)/);
            if (privmsgMatch) {
              const twitchUser = privmsgMatch[1];
              const twitchMsg = privmsgMatch[2];
              streamChatMessages.push({ content: twitchMsg, source: 'twitch', source_user: twitchUser, from_name: twitchUser, timestamp: Date.now() });
              if (streamChatMessages.length > 500) streamChatMessages.shift();
              streamRenderChat();
              streamRenderChat('viewer');
            }
          }
        };
        twitchChatWs.onerror = () => {};
        twitchChatWs.onclose = () => { twitchChatWs = null; };
      } catch (e) { console.warn('Twitch chat connect failed:', e); }
    }

    // Helper: escape HTML
    function escapeHtml(str) {
      if (typeof str !== 'string') return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // ‚îÄ‚îÄ Request stream info on connect ‚îÄ‚îÄ
    function streamRequestInfo() {
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'stream_info_request' }));
      }
    }

    // Track tab visits for explorer achievement
    const visitedTabs = JSON.parse(localStorage.getItem('humanity_visited_tabs') || '[]');
    const origSwitchTab = switchTab;
    switchTab = function(tabId, pushState) {
      origSwitchTab(tabId, pushState);
      if (!visitedTabs.includes(tabId)) {
        visitedTabs.push(tabId);
        localStorage.setItem('humanity_visited_tabs', JSON.stringify(visitedTabs));
      }
      if (['reality', 'fantasy', 'streams', 'debug'].every(t => visitedTabs.includes(t))) {
        unlockAchievement('explorer');
      }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PROJECT BOARD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let boardTasks = [];
    let boardWs = null;
    let boardMyKey = null;
    let boardMyRole = '';

    const PRIORITY_COLORS = { critical: '#e55', high: '#f80', medium: '#eb4', low: '#666' };
    const STATUS_LABELS = { backlog: 'üì• Backlog', in_progress: 'üîß In Progress', testing: 'üß™ Testing', done: '‚úÖ Done' };
    const VALID_STATUSES = ['backlog', 'in_progress', 'testing', 'done'];

    const API_BASE = 'https://united-humanity.us';

    function boardConnect() {
      // Always try REST API first (reliable, works everywhere)
      fetch(API_BASE + '/api/tasks').then(r => r.json()).then(data => {
        if (data.tasks && data.tasks.length > 0) {
          boardTasks = data.tasks;
          renderBoard();
        }
      }).catch(e => console.warn('Board REST fetch failed:', e));

      // Also connect WebSocket for real-time updates
      try {
        const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = location.host || 'united-humanity.us';
        boardWs = new WebSocket(proto + '//' + host + '/ws');
        boardWs.onopen = () => {
          const storedKey = localStorage.getItem('humanity_key');
          const storedName = localStorage.getItem('humanity_name');
          if (storedKey) {
            boardMyKey = storedKey;
            boardWs.send(JSON.stringify({ type: 'identify', public_key: storedKey, display_name: storedName || null }));
          } else {
            boardMyKey = 'viewer_' + Math.random().toString(36).slice(2, 10);
            boardWs.send(JSON.stringify({ type: 'identify', public_key: boardMyKey, display_name: null }));
          }
        };
        boardWs.onmessage = (e) => {
          try {
            const msg = JSON.parse(e.data);
            handleBoardMessage(msg);
          } catch {}
        };
        boardWs.onclose = () => { setTimeout(boardConnect, 5000); };
        boardWs.onerror = () => {};
      } catch (e) { console.warn('Board WS failed:', e); }
    }

    function handleBoardMessage(msg) {
      switch (msg.type) {
        case 'peer_list':
          // Extract our role from peer list
          if (msg.peers && boardMyKey) {
            const me = msg.peers.find(p => p.public_key === boardMyKey);
            if (me) boardMyRole = me.role || '';
          }
          updateBoardPermissions();
          // Request task list
          if (boardWs && boardWs.readyState === 1) {
            boardWs.send(JSON.stringify({ type: 'task_list' }));
          }
          break;
        case 'task_list_response':
          boardTasks = msg.tasks || [];
          renderBoard();
          break;
        case 'task_created':
          if (msg.task) {
            boardTasks.push(msg.task);
            renderBoard();
          }
          break;
        case 'task_updated':
          if (msg.task) {
            const idx = boardTasks.findIndex(t => t.id === msg.task.id);
            if (idx >= 0) boardTasks[idx] = msg.task;
            else boardTasks.push(msg.task);
            renderBoard();
          }
          break;
        case 'task_moved':
          if (msg.id != null && msg.status) {
            const t = boardTasks.find(t => t.id === msg.id);
            if (t) t.status = msg.status;
            renderBoard();
          }
          break;
        case 'task_deleted':
          if (msg.id != null) {
            boardTasks = boardTasks.filter(t => t.id !== msg.id);
            renderBoard();
          }
          break;
        case 'task_comment_added':
          if (msg.task_id != null) {
            const t = boardTasks.find(t => t.id === msg.task_id);
            if (t) t.comment_count = (t.comment_count || 0) + 1;
            renderBoard();
            // If modal is open for this task, append comment
            const modalEl = document.getElementById('task-modal-content');
            if (modalEl && modalEl.dataset.taskId == msg.task_id && msg.comment) {
              const commentsDiv = document.getElementById('task-comments-list');
              if (commentsDiv) {
                commentsDiv.innerHTML += renderCommentHtml(msg.comment);
              }
            }
          }
          break;
        case 'task_comments_response':
          if (msg.task_id != null) {
            const commentsDiv = document.getElementById('task-comments-list');
            if (commentsDiv && commentsDiv.dataset.taskId == msg.task_id) {
              commentsDiv.innerHTML = (msg.comments || []).map(renderCommentHtml).join('') || '<div style="color:var(--text-muted);font-size:0.8rem;font-style:italic;">No comments yet</div>';
            }
          }
          break;
      }
    }

    function updateBoardPermissions() {
      const canEdit = boardMyRole === 'admin' || boardMyRole === 'mod';
      const btn = document.getElementById('board-create-btn');
      if (btn) btn.style.display = canEdit ? 'inline-flex' : 'none';
    }

    function renderBoard() {
      document.getElementById('board-loading').style.display = 'none';
      VALID_STATUSES.forEach(status => {
        const container = document.querySelector('.board-col-cards[data-status="' + status + '"]');
        const countEl = document.querySelector('.board-col-count[data-status="' + status + '"]');
        if (!container) return;
        const tasks = boardTasks.filter(t => t.status === status).sort((a, b) => a.position - b.position);
        if (countEl) countEl.textContent = '(' + tasks.length + ')';
        container.innerHTML = tasks.map(t => renderTaskCard(t)).join('');
      });
    }

    function renderTaskCard(task) {
      const pc = PRIORITY_COLORS[task.priority] || '#666';
      const labels = (() => { try { return JSON.parse(task.labels || '[]'); } catch { return []; } })();
      const labelHtml = labels.map(l => '<span style="display:inline-block;background:rgba(255,136,17,0.15);color:var(--accent);font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:3px;margin-right:0.2rem;">' + escHtml(l) + '</span>').join('');
      const assigneeHtml = task.assignee ? '<span style="font-size:0.7rem;color:var(--text-muted);">üë§ ' + escHtml(task.assignee) + '</span>' : '';
      const commentHtml = task.comment_count > 0 ? '<span style="font-size:0.7rem;color:var(--text-muted);">üí¨ ' + task.comment_count + '</span>' : '';
      const canEdit = boardMyRole === 'admin' || boardMyRole === 'mod';
      let moveHtml = '';
      if (canEdit) {
        const moves = VALID_STATUSES.filter(s => s !== task.status);
        moveHtml = '<div style="display:flex;gap:0.2rem;margin-top:0.3rem;flex-wrap:wrap;" onclick="event.stopPropagation()">' +
          moves.map(s => '<button onclick="boardMoveTask(' + task.id + ',\'' + s + '\')" style="background:none;border:1px solid var(--border);color:var(--text-muted);font-size:0.6rem;padding:0.1rem 0.3rem;border-radius:3px;cursor:pointer;" title="Move to ' + (STATUS_LABELS[s]||s) + '">‚Üí ' + (STATUS_LABELS[s]||s).split(' ').pop() + '</button>').join('') +
          '</div>';
      }
      return '<div onclick="openTaskModal(' + task.id + ')" style="background:var(--bg-panel,#141414);border:1px solid var(--border);border-left:3px solid ' + pc + ';border-radius:6px;padding:0.5rem 0.6rem;margin-bottom:0.4rem;cursor:pointer;transition:border-color 0.15s;" onmouseover="this.style.borderColor=\'rgba(255,136,17,0.3)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.borderLeftColor=\'' + pc + '\'">' +
        '<div style="font-size:0.82rem;font-weight:600;color:var(--text);margin-bottom:0.3rem;">' + escHtml(task.title) + '</div>' +
        '<div style="display:flex;gap:0.4rem;align-items:center;flex-wrap:wrap;">' +
          '<span style="display:inline-block;background:' + pc + ';color:#fff;font-size:0.6rem;padding:0.05rem 0.35rem;border-radius:3px;font-weight:700;text-transform:uppercase;">' + task.priority + '</span>' +
          labelHtml + assigneeHtml + commentHtml +
        '</div>' +
        moveHtml +
        '<div style="text-align:right;margin-top:0.3rem;font-size:0.6rem;color:var(--text-muted);opacity:0.5;">#' + task.id + '</div>' +
      '</div>';
    }

    function boardMoveTask(id, status) {
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({ type: 'task_move', id: id, status: status }));
      }
    }

    function openTaskModal(taskId) {
      const task = boardTasks.find(t => t.id === taskId);
      if (!task) return;
      const modal = document.getElementById('task-modal');
      const content = document.getElementById('task-modal-content');
      content.dataset.taskId = taskId;
      const canEdit = boardMyRole === 'admin' || boardMyRole === 'mod';
      const canComment = canEdit || boardMyRole === 'verified' || boardMyRole === 'donor';
      const pc = PRIORITY_COLORS[task.priority] || '#666';
      const labels = (() => { try { return JSON.parse(task.labels || '[]'); } catch { return []; } })();
      const created = new Date(task.created_at).toLocaleString();

      let html = '<h3 style="color:var(--text);margin:0 0 0.5rem;font-size:1.1rem;">' + escHtml(task.title) + '</h3>' +
        '<div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;margin-bottom:0.8rem;">' +
          '<span style="background:' + pc + ';color:#fff;font-size:0.7rem;padding:0.1rem 0.4rem;border-radius:3px;font-weight:700;text-transform:uppercase;">' + task.priority + '</span>' +
          '<span style="font-size:0.75rem;color:var(--text-muted);">' + (STATUS_LABELS[task.status] || task.status) + '</span>' +
          (task.assignee ? '<span style="font-size:0.75rem;color:var(--text-muted);">üë§ ' + escHtml(task.assignee) + '</span>' : '') +
          '<span style="font-size:0.7rem;color:var(--text-muted);">Created: ' + created + '</span>' +
        '</div>';

      if (labels.length) {
        html += '<div style="margin-bottom:0.5rem;">' + labels.map(l => '<span style="display:inline-block;background:rgba(255,136,17,0.15);color:var(--accent);font-size:0.7rem;padding:0.1rem 0.5rem;border-radius:3px;margin-right:0.3rem;">' + escHtml(l) + '</span>').join('') + '</div>';
      }

      if (task.description) {
        html += '<div style="background:var(--bg-input,#111);border-radius:6px;padding:0.6rem;margin-bottom:1rem;font-size:0.82rem;color:var(--text);line-height:1.6;white-space:pre-wrap;">' + escHtml(task.description) + '</div>';
      }

      if (canEdit) {
        html += '<div style="display:flex;gap:0.4rem;margin-bottom:1rem;flex-wrap:wrap;">' +
          '<button class="btn btn-clickable" style="min-width:auto;min-height:32px;padding:0.2rem 0.6rem;font-size:0.75rem;" onclick="showEditTaskForm(' + task.id + ')">‚úèÔ∏è Edit</button>' +
          '<button class="btn" style="min-width:auto;min-height:32px;padding:0.2rem 0.6rem;font-size:0.75rem;box-shadow:inset 0 0 0 1px #e55;" onclick="boardDeleteTask(' + task.id + ')">üóëÔ∏è Delete</button>' +
        '</div>';
      }

      html += '<h4 style="color:var(--text-muted);font-size:0.85rem;margin:1rem 0 0.5rem;border-top:1px solid var(--border);padding-top:0.8rem;">üí¨ Comments</h4>' +
        '<div id="task-comments-list" data-task-id="' + taskId + '" style="margin-bottom:0.8rem;"><div style="color:var(--text-muted);font-size:0.8rem;">Loading‚Ä¶</div></div>';

      if (canComment) {
        html += '<div style="display:flex;gap:0.4rem;">' +
          '<input type="text" id="task-comment-input" placeholder="Add a comment‚Ä¶" style="flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.82rem;outline:none;font-family:inherit;" onkeydown="if(event.key===\'Enter\')boardAddComment(' + taskId + ')">' +
          '<button onclick="boardAddComment(' + taskId + ')" style="background:var(--accent);color:#fff;border:none;padding:0.4rem 0.8rem;border-radius:6px;font-size:0.82rem;cursor:pointer;font-weight:600;">Post</button>' +
        '</div>';
      }

      content.innerHTML = html;
      modal.style.display = 'flex';

      // Request comments
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({ type: 'task_comments_request', task_id: taskId }));
      }
    }

    function renderCommentHtml(c) {
      const time = new Date(c.created_at).toLocaleString();
      return '<div style="background:var(--bg-input,#111);border-radius:6px;padding:0.4rem 0.6rem;margin-bottom:0.3rem;">' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:0.2rem;"><span style="font-size:0.75rem;font-weight:600;color:var(--accent);">' + escHtml(c.author_name) + '</span><span style="font-size:0.65rem;color:var(--text-muted);">' + time + '</span></div>' +
        '<div style="font-size:0.8rem;color:var(--text);white-space:pre-wrap;">' + escHtml(c.content) + '</div>' +
      '</div>';
    }

    function closeTaskModal() {
      document.getElementById('task-modal').style.display = 'none';
    }

    function boardAddComment(taskId) {
      const input = document.getElementById('task-comment-input');
      if (!input || !input.value.trim()) return;
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({ type: 'task_comment', task_id: taskId, content: input.value.trim() }));
        input.value = '';
      }
    }

    function boardDeleteTask(id) {
      if (!confirm('Delete this task?')) return;
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({ type: 'task_delete', id: id }));
      }
      closeTaskModal();
    }

    function showCreateTaskModal() {
      const modal = document.getElementById('task-modal');
      const content = document.getElementById('task-modal-content');
      content.dataset.taskId = '';
      content.innerHTML =
        '<h3 style="color:var(--text);margin:0 0 1rem;font-size:1.1rem;">Create New Task</h3>' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Title</label>' +
        '<input type="text" id="new-task-title" maxlength="200" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:0.6rem;">' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Description</label>' +
        '<textarea id="new-task-desc" rows="4" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;resize:vertical;margin-bottom:0.6rem;"></textarea>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.6rem;margin-bottom:0.6rem;">' +
          '<div><label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Priority</label>' +
            '<select id="new-task-priority" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem;border-radius:6px;font-size:0.82rem;font-family:inherit;"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option><option value="critical">Critical</option></select></div>' +
          '<div><label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Status</label>' +
            '<select id="new-task-status" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem;border-radius:6px;font-size:0.82rem;font-family:inherit;"><option value="backlog" selected>Backlog</option><option value="in_progress">In Progress</option><option value="testing">Testing</option><option value="done">Done</option></select></div>' +
        '</div>' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Assignee (optional)</label>' +
        '<input type="text" id="new-task-assignee" maxlength="50" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:0.6rem;">' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Labels (comma-separated)</label>' +
        '<input type="text" id="new-task-labels" placeholder="bug, feature, urgent" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:1rem;">' +
        '<button onclick="boardSubmitCreateTask()" style="background:var(--accent);color:#fff;border:none;padding:0.5rem 1.5rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;width:100%;">Create Task</button>';
      modal.style.display = 'flex';
    }

    function boardSubmitCreateTask() {
      const title = document.getElementById('new-task-title').value.trim();
      if (!title) return;
      const labelsStr = document.getElementById('new-task-labels').value.trim();
      const labels = labelsStr ? JSON.stringify(labelsStr.split(',').map(l => l.trim()).filter(Boolean)) : '[]';
      const assignee = document.getElementById('new-task-assignee').value.trim() || null;
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({
          type: 'task_create',
          title: title,
          description: document.getElementById('new-task-desc').value,
          priority: document.getElementById('new-task-priority').value,
          status: document.getElementById('new-task-status').value,
          assignee: assignee,
          labels: labels,
        }));
      }
      closeTaskModal();
    }

    function showEditTaskForm(taskId) {
      const task = boardTasks.find(t => t.id === taskId);
      if (!task) return;
      const content = document.getElementById('task-modal-content');
      const labels = (() => { try { return JSON.parse(task.labels || '[]'); } catch { return []; } })();
      content.innerHTML =
        '<h3 style="color:var(--text);margin:0 0 1rem;font-size:1.1rem;">Edit Task</h3>' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Title</label>' +
        '<input type="text" id="edit-task-title" maxlength="200" value="' + escHtml(task.title).replace(/"/g,'&quot;') + '" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:0.6rem;">' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Description</label>' +
        '<textarea id="edit-task-desc" rows="4" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;resize:vertical;margin-bottom:0.6rem;">' + escHtml(task.description) + '</textarea>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.6rem;margin-bottom:0.6rem;">' +
          '<div><label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Priority</label>' +
            '<select id="edit-task-priority" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem;border-radius:6px;font-size:0.82rem;font-family:inherit;"><option value="low"' + (task.priority==='low'?' selected':'') + '>Low</option><option value="medium"' + (task.priority==='medium'?' selected':'') + '>Medium</option><option value="high"' + (task.priority==='high'?' selected':'') + '>High</option><option value="critical"' + (task.priority==='critical'?' selected':'') + '>Critical</option></select></div>' +
          '<div><label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Assignee</label>' +
            '<input type="text" id="edit-task-assignee" maxlength="50" value="' + escHtml(task.assignee||'').replace(/"/g,'&quot;') + '" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.82rem;outline:none;font-family:inherit;"></div>' +
        '</div>' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Labels (comma-separated)</label>' +
        '<input type="text" id="edit-task-labels" value="' + labels.join(', ').replace(/"/g,'&quot;') + '" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:1rem;">' +
        '<button onclick="boardSubmitEditTask(' + task.id + ')" style="background:var(--accent);color:#fff;border:none;padding:0.5rem 1.5rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;width:100%;">Save Changes</button>';
    }

    function boardSubmitEditTask(id) {
      const title = document.getElementById('edit-task-title').value.trim();
      if (!title) return;
      const labelsStr = document.getElementById('edit-task-labels').value.trim();
      const labels = labelsStr ? JSON.stringify(labelsStr.split(',').map(l => l.trim()).filter(Boolean)) : '[]';
      const assignee = document.getElementById('edit-task-assignee').value.trim() || null;
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({
          type: 'task_update',
          id: id,
          title: title,
          description: document.getElementById('edit-task-desc').value,
          priority: document.getElementById('edit-task-priority').value,
          assignee: assignee,
          labels: labels,
        }));
      }
      closeTaskModal();
    }

    // Close modal on backdrop click
    document.getElementById('task-modal').addEventListener('click', function(e) {
      if (e.target === this) closeTaskModal();
    });

    // Connect board WebSocket when tab switches to board
    const origSwitchTab2 = switchTab;
    switchTab = function(tabId, pushState) {
      origSwitchTab2(tabId, pushState);
      if (tabId === 'board' && (!boardWs || boardWs.readyState > 1)) {
        boardConnect();
      } else if (tabId === 'board' && boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({ type: 'task_list' }));
      }
    };

    // Auto-connect if initial tab is board
    if (initialTab === 'board') boardConnect();

    // Mobile responsive: stack columns on small screens
    (function() {
      const style = document.createElement('style');
      style.textContent = '@media (max-width: 768px) { #board-columns { grid-template-columns: 1fr !important; } }';
      document.head.appendChild(style);
    })();

    // ‚îÄ‚îÄ Browse Tab ‚îÄ‚îÄ
    const TRANCO_RANKS = {
      'google.com': 1, 'youtube.com': 2, 'facebook.com': 3, 'amazon.com': 8,
      'wikipedia.org': 10, 'reddit.com': 15, 'netflix.com': 20, 'github.com': 25,
      'discord.com': 30, 'twitch.tv': 35, 'ebay.com': 40, 'aliexpress.com': 45,
      'stackoverflow.com': 50, 'fonts.google.com': 50, 'spotify.com': 55,
      'imdb.com': 60, 'duckduckgo.com': 70, 'bbc.com': 80,
      'store.steampowered.com': 100, 'etsy.com': 120, 'deepl.com': 150,
      'gitlab.com': 150, 'craigslist.org': 200, 'coursera.org': 200,
      'soundcloud.com': 200, 'reuters.com': 250, 'archive.org': 250,
      'apnews.com': 300, 'figma.com': 300, 'khanacademy.org': 350,
      'news.ycombinator.com': 400, 'proton.me': 400, 'unsplash.com': 500,
      'arstechnica.com': 500, 'libgen.is': 500, 'dev.to': 600,
      'codepen.io': 700, 'newegg.com': 800, 'wolframalpha.com': 900,
      'itch.io': 1000, 'nexusmods.com': 1500, 'blender.org': 2000,
      'regex101.com': 2000, 'coolors.co': 3000, 'bitwarden.com': 3000,
      'thingiverse.com': 4000, 'mastodon.social': 5000, 'excalidraw.com': 5000,
      'howlongtobeat.com': 5000, 'signal.org': 6000, 'lemmy.world': 8000,
      'pcgamingwiki.com': 10000, 'isthereanydeal.com': 15000, 'allsides.com': 20000,
    };

    function getDomainFromUrl(url) {
      try { return new URL(url.startsWith('http') ? url : 'https://'+url).hostname.replace(/^www\./,''); } catch { return ''; }
    }
    function getTrancoRank(url) {
      const domain = getDomainFromUrl(url);
      return TRANCO_RANKS[domain] || TRANCO_RANKS[domain.replace(/^[^.]+\./, '')] || 999999;
    }

    // Uptime ping system
    const _pingCache = {}; // { domain: { status: 'up'|'down'|'checking', ts: Date.now() } }
    const PING_TTL = 5 * 60 * 1000;
    function getPingStatus(url) {
      const domain = getDomainFromUrl(url);
      const cached = _pingCache[domain];
      if (cached && Date.now() - cached.ts < PING_TTL) return cached.status;
      return 'unchecked';
    }
    function getPingDot(url) {
      const s = getPingStatus(url);
      if (s === 'up') return 'üü¢';
      if (s === 'down') return 'üî¥';
      return '‚ö™';
    }
    let _pingQueue = [];
    let _pinging = false;
    async function pingBatch() {
      if (_pinging) return;
      _pinging = true;
      while (_pingQueue.length > 0) {
        const batch = _pingQueue.splice(0, 5);
        await Promise.all(batch.map(async url => {
          const domain = getDomainFromUrl(url);
          if (_pingCache[domain] && Date.now() - _pingCache[domain].ts < PING_TTL) return;
          _pingCache[domain] = { status: 'checking', ts: Date.now() };
          try {
            await fetch(url + '/favicon.ico', { mode: 'no-cors', signal: AbortSignal.timeout(5000) });
            _pingCache[domain] = { status: 'up', ts: Date.now() };
          } catch {
            _pingCache[domain] = { status: 'down', ts: Date.now() };
          }
        }));
        renderBrowseSiteCards();
        if (_pingQueue.length > 0) await new Promise(r => setTimeout(r, 300));
      }
      _pinging = false;
    }
    function enqueuePings(sites) {
      sites.forEach(s => {
        const domain = getDomainFromUrl(s.url);
        if (!_pingCache[domain] || Date.now() - _pingCache[domain].ts >= PING_TTL) {
          if (!_pingQueue.includes(s.url)) _pingQueue.push(s.url);
        }
      });
      pingBatch();
    }

    // RDAP system
    const RDAP_CACHE_KEY = 'humanity_rdap_cache';
    function loadRdapCache() { try { return JSON.parse(localStorage.getItem(RDAP_CACHE_KEY)) || {}; } catch { return {}; } }
    function saveRdapCache(cache) { localStorage.setItem(RDAP_CACHE_KEY, JSON.stringify(cache)); }
    const _rdapFetching = {};
    async function fetchRdap(url) {
      const domain = getDomainFromUrl(url);
      const cache = loadRdapCache();
      if (cache[domain] && Date.now() - cache[domain].ts < 24*60*60*1000) return cache[domain].data;
      if (_rdapFetching[domain]) return null;
      _rdapFetching[domain] = true;
      try {
        const resp = await fetch('https://rdap.org/domain/' + domain);
        if (!resp.ok) throw new Error('RDAP error');
        const json = await resp.json();
        let regYear = null, registrar = null;
        (json.events || []).forEach(e => { if (e.eventAction === 'registration' && e.eventDate) regYear = new Date(e.eventDate).getFullYear(); });
        (json.entities || []).forEach(e => { if ((e.roles || []).includes('registrar')) registrar = e.vcardArray?.[1]?.find(v=>v[0]==='fn')?.[3] || e.handle || null; });
        const data = { regYear, registrar };
        cache[domain] = { data, ts: Date.now() };
        saveRdapCache(cache);
        delete _rdapFetching[domain];
        return data;
      } catch { delete _rdapFetching[domain]; return null; }
    }
    function getRdapDisplay(url) {
      const domain = getDomainFromUrl(url);
      const cache = loadRdapCache();
      if (cache[domain] && Date.now() - cache[domain].ts < 24*60*60*1000) {
        const d = cache[domain].data;
        const parts = [];
        if (d.regYear) parts.push('üìÖ ' + d.regYear);
        if (d.registrar) parts.push('üè¢ ' + d.registrar);
        return parts.length ? parts.join(' ¬∑ ') + ' ¬∑ ' : '';
      }
      return '';
    }

    let browseCurrentSort = 'popular';
    function setBrowseSort(sort) {
      browseCurrentSort = sort;
      ['popular','used','recent','az'].forEach(s => {
        const el = document.getElementById('sort-' + s);
        if (el) el.classList.toggle('active', s === sort);
      });
      renderBrowseSites();
    }

    const DEFAULT_SITES = [
      { url:'https://github.com', name:'GitHub', description:'Code hosting and collaboration', category:'Tech', icon:'üêô' },
      { url:'https://stackoverflow.com', name:'Stack Overflow', description:'Programming Q&A', category:'Tech', icon:'üìö' },
      { url:'https://news.ycombinator.com', name:'Hacker News', description:'Tech news and discussion', category:'Tech', icon:'üüß' },
      { url:'https://dev.to', name:'DEV Community', description:'Developer blogs and articles', category:'Tech', icon:'üë©‚Äçüíª' },
      { url:'https://gitlab.com', name:'GitLab', description:'DevOps and code hosting', category:'Tech', icon:'ü¶ä' },
      { url:'https://codepen.io', name:'CodePen', description:'Frontend code playground', category:'Tech', icon:'‚úèÔ∏è' },
      { url:'https://amazon.com', name:'Amazon', description:'Online marketplace', category:'Shopping', icon:'üì¶' },
      { url:'https://ebay.com', name:'eBay', description:'Auction and buy-it-now marketplace', category:'Shopping', icon:'üè∑Ô∏è' },
      { url:'https://etsy.com', name:'Etsy', description:'Handmade and vintage goods', category:'Shopping', icon:'üé®' },
      { url:'https://craigslist.org', name:'Craigslist', description:'Local classifieds', category:'Shopping', icon:'üìã' },
      { url:'https://newegg.com', name:'Newegg', description:'Computer hardware and electronics', category:'Shopping', icon:'üñ•Ô∏è' },
      { url:'https://aliexpress.com', name:'AliExpress', description:'International marketplace', category:'Shopping', icon:'üåè' },
      { url:'https://reuters.com', name:'Reuters', description:'International news agency', category:'News', icon:'üì∞' },
      { url:'https://apnews.com', name:'AP News', description:'Associated Press', category:'News', icon:'üóûÔ∏è' },
      { url:'https://arstechnica.com', name:'Ars Technica', description:'Technology news and analysis', category:'News', icon:'üî¨' },
      { url:'https://bbc.com/news', name:'BBC News', description:'British Broadcasting Corporation', category:'News', icon:'üì∫' },
      { url:'https://allsides.com', name:'AllSides', description:'News from multiple perspectives', category:'News', icon:'‚öñÔ∏è' },
      { url:'https://youtube.com', name:'YouTube', description:'Video sharing platform', category:'Entertainment', icon:'‚ñ∂Ô∏è' },
      { url:'https://twitch.tv', name:'Twitch', description:'Live streaming platform', category:'Entertainment', icon:'üíú' },
      { url:'https://netflix.com', name:'Netflix', description:'Streaming movies and shows', category:'Entertainment', icon:'üé¨' },
      { url:'https://spotify.com', name:'Spotify', description:'Music streaming', category:'Entertainment', icon:'üéµ' },
      { url:'https://soundcloud.com', name:'SoundCloud', description:'Independent music platform', category:'Entertainment', icon:'üîä' },
      { url:'https://imdb.com', name:'IMDB', description:'Movie and TV database', category:'Entertainment', icon:'‚≠ê' },
      { url:'https://store.steampowered.com', name:'Steam', description:'PC game store and community', category:'Gaming', icon:'üéÆ' },
      { url:'https://pcgamingwiki.com', name:'PCGamingWiki', description:'PC game fixes and info', category:'Gaming', icon:'üîß' },
      { url:'https://nexusmods.com', name:'Nexus Mods', description:'Game modding community', category:'Gaming', icon:'‚öôÔ∏è' },
      { url:'https://isthereanydeal.com', name:'IsThereAnyDeal', description:'Game price comparison', category:'Gaming', icon:'üí∞' },
      { url:'https://howlongtobeat.com', name:'HowLongToBeat', description:'Game completion times', category:'Gaming', icon:'‚è±Ô∏è' },
      { url:'https://itch.io', name:'itch.io', description:'Indie game marketplace', category:'Gaming', icon:'üïπÔ∏è' },
      { url:'https://wikipedia.org', name:'Wikipedia', description:'Free encyclopedia', category:'Education', icon:'üìñ' },
      { url:'https://khanacademy.org', name:'Khan Academy', description:'Free courses and lessons', category:'Education', icon:'üéì' },
      { url:'https://wolframalpha.com', name:'Wolfram Alpha', description:'Computational knowledge engine', category:'Education', icon:'üßÆ' },
      { url:'https://coursera.org', name:'Coursera', description:'Online university courses', category:'Education', icon:'üè´' },
      { url:'https://archive.org', name:'Internet Archive', description:'Digital library and Wayback Machine', category:'Education', icon:'üèõÔ∏è' },
      { url:'https://libgen.is', name:'Library Genesis', description:'Book and paper archive', category:'Education', icon:'üìï' },
      { url:'https://figma.com', name:'Figma', description:'Collaborative design tool', category:'Creative', icon:'üé®' },
      { url:'https://blender.org', name:'Blender', description:'Open source 3D creation', category:'Creative', icon:'üßä' },
      { url:'https://unsplash.com', name:'Unsplash', description:'Free high-quality photos', category:'Creative', icon:'üì∑' },
      { url:'https://fonts.google.com', name:'Google Fonts', description:'Free web fonts', category:'Creative', icon:'üî§' },
      { url:'https://coolors.co', name:'Coolors', description:'Color palette generator', category:'Creative', icon:'üåà' },
      { url:'https://thingiverse.com', name:'Thingiverse', description:'3D printing models', category:'Creative', icon:'üñ®Ô∏è' },
      { url:'https://reddit.com', name:'Reddit', description:'Community forums and discussion', category:'Social', icon:'ü§ñ' },
      { url:'https://discord.com', name:'Discord', description:'Chat and voice communities', category:'Social', icon:'üí¨' },
      { url:'https://mastodon.social', name:'Mastodon', description:'Decentralized social network', category:'Social', icon:'üêò' },
      { url:'https://lemmy.world', name:'Lemmy', description:'Federated link aggregator', category:'Social', icon:'üîó' },
      { url:'https://signal.org', name:'Signal', description:'Private messaging', category:'Social', icon:'üîí' },
      { url:'https://duckduckgo.com', name:'DuckDuckGo', description:'Private search engine', category:'Tools', icon:'ü¶Ü' },
      { url:'https://proton.me', name:'Proton Mail', description:'Encrypted email', category:'Tools', icon:'‚úâÔ∏è' },
      { url:'https://bitwarden.com', name:'Bitwarden', description:'Password manager', category:'Tools', icon:'üîê' },
      { url:'https://excalidraw.com', name:'Excalidraw', description:'Virtual whiteboard', category:'Tools', icon:'‚úèÔ∏è' },
      { url:'https://regex101.com', name:'Regex101', description:'Regular expression tester', category:'Tools', icon:'üîç' },
      { url:'https://deepl.com', name:'DeepL', description:'AI translation', category:'Tools', icon:'üåê' },
    ];

    const BROWSE_STORAGE_KEY = 'humanity_browse';
    function loadBrowseData() { try { return JSON.parse(localStorage.getItem(BROWSE_STORAGE_KEY)) || {}; } catch { return {}; } }
    function saveBrowseData(data) { localStorage.setItem(BROWSE_STORAGE_KEY, JSON.stringify(data)); if (typeof scheduleSyncSave === 'function') scheduleSyncSave(); }
    function getBrowseData() {
      const data = loadBrowseData();
      if (!data.quickBar) data.quickBar = ['https://duckduckgo.com','https://youtube.com','https://github.com','https://reddit.com','https://wikipedia.org'];
      if (!data.collections) data.collections = {};
      if (!data.hidden) data.hidden = [];
      if (!data.customSites) data.customSites = [];
      if (!data.clickCounts) data.clickCounts = {};
      if (!data.lastVisited) data.lastVisited = {};
      return data;
    }
    function getAllSites() { const data = getBrowseData(); return [...DEFAULT_SITES, ...data.customSites]; }

    let browseActiveCategory = '';
    let browseCurrentUrl = '';

    function renderQuickBar() {
      const data = getBrowseData();
      const container = document.getElementById('quickbar-sites');
      if (!container) return;
      const allSites = getAllSites();
      container.innerHTML = data.quickBar.map(url => {
        const site = allSites.find(s => s.url === url);
        const icon = site ? site.icon : 'üåê';
        const name = site ? site.name : new URL(url).hostname;
        return `<button onclick="browseNavigate('${url}')" title="${name}" style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:0.25rem 0.5rem;cursor:pointer;font-size:0.85rem;white-space:nowrap;color:var(--text);display:flex;align-items:center;gap:0.25rem;" oncontextmenu="event.preventDefault();removeFromQuickBar('${url}')">${icon} <span style="font-size:0.72rem;">${name}</span></button>`;
      }).join('');
    }

    function renderBrowseCategories() {
      const categories = [...new Set(getAllSites().map(s => s.category))];
      const container = document.getElementById('browse-categories');
      if (!container) return;
      container.innerHTML = `<span class="filter-pill ${browseActiveCategory===''?'active':''}" onclick="browseActiveCategory='';renderBrowseSites()" style="font-size:0.72rem;padding:0.15rem 0.5rem;cursor:pointer;">All</span>` +
        categories.map(c => `<span class="filter-pill ${browseActiveCategory===c?'active':''}" onclick="browseActiveCategory='${c}';renderBrowseSites()" style="font-size:0.72rem;padding:0.15rem 0.5rem;cursor:pointer;">${c}</span>`).join('');
    }

    function renderCollections() {
      const data = getBrowseData();
      const container = document.getElementById('browse-collections');
      if (!container) return;
      const collNames = Object.keys(data.collections);
      if (collNames.length === 0) { container.innerHTML = '<div style="font-size:0.72rem;color:var(--text-muted);padding:0.2rem;">No collections yet. Right-click a site to add to a collection.</div>'; return; }
      container.innerHTML = collNames.map(name => {
        const count = data.collections[name].length;
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:0.2rem 0.3rem;cursor:pointer;border-radius:4px;font-size:0.8rem;" onclick="browseActiveCategory='collection:${name}';renderBrowseSites()" oncontextmenu="event.preventDefault();deleteCollection('${name}')"><span>üìÅ ${name} <span style="color:var(--text-muted);">(${count})</span></span><button onclick="event.stopPropagation();deleteCollection('${name}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.7rem;">‚úï</button></div>`;
      }).join('') + `<button onclick="createCollection()" style="font-size:0.72rem;color:var(--accent);background:none;border:none;cursor:pointer;padding:0.2rem;">+ New Collection</button>`;
    }

    function sortBrowseSites(sites, data) {
      const sorted = [...sites];
      switch (browseCurrentSort) {
        case 'popular': sorted.sort((a, b) => getTrancoRank(a.url) - getTrancoRank(b.url)); break;
        case 'used': sorted.sort((a, b) => (data.clickCounts[b.url]||0) - (data.clickCounts[a.url]||0)); break;
        case 'recent': sorted.sort((a, b) => (data.lastVisited[b.url]||0) - (data.lastVisited[a.url]||0)); break;
        case 'az': sorted.sort((a, b) => a.name.localeCompare(b.name)); break;
      }
      return sorted;
    }
    let _lastRenderedSites = [];
    function renderBrowseSites() {
      renderBrowseCategories(); renderCollections();
      const data = getBrowseData();
      const search = (document.getElementById('browse-search')?.value || '').toLowerCase();
      let sites = getAllSites().filter(s => !data.hidden.includes(s.url));
      if (browseActiveCategory.startsWith('collection:')) {
        const collName = browseActiveCategory.replace('collection:', '');
        const collUrls = data.collections[collName] || [];
        sites = sites.filter(s => collUrls.includes(s.url));
      } else if (browseActiveCategory) { sites = sites.filter(s => s.category === browseActiveCategory); }
      if (search) { sites = sites.filter(s => s.name.toLowerCase().includes(search) || s.description.toLowerCase().includes(search) || s.url.toLowerCase().includes(search)); }
      sites = sortBrowseSites(sites, data);
      _lastRenderedSites = sites;
      const container = document.getElementById('browse-sites');
      if (!container) return;
      renderBrowseSiteCards();
      enqueuePings(sites);
    }
    function renderBrowseSiteCards() {
      const sites = _lastRenderedSites;
      const data = getBrowseData();
      const container = document.getElementById('browse-sites');
      if (!container) return;
      container.innerHTML = sites.map(s => {
        const rank = getTrancoRank(s.url);
        const rankStr = rank < 999999 ? `#${rank} globally` : '';
        const dot = getPingDot(s.url);
        const rdap = getRdapDisplay(s.url);
        const domain = getDomainFromUrl(s.url);
        return `<div class="browse-site-card" style="padding:0.5rem;margin-bottom:0.3rem;background:var(--bg-secondary);border-radius:6px;cursor:pointer;border:1px solid var(--border);" onclick="browseNavigateTracked('${s.url.replace(/'/g,"\\'")}')" oncontextmenu="event.preventDefault();showSiteContextMenu(event,'${s.url.replace(/'/g,"\\'")}','${s.name.replace(/'/g,"\\'")}');" onmouseenter="lazyFetchRdap('${s.url.replace(/'/g,"\\'")}')">`+
          `<div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:600;font-size:0.85rem;">${s.icon} ${s.name} ${dot}</span><span style="font-size:0.65rem;color:var(--text-muted);background:var(--bg);padding:0.1rem 0.4rem;border-radius:8px;">${s.category}</span></div>`+
          (rankStr ? `<div style="font-size:0.62rem;color:var(--text-muted);margin-top:0.1rem;">${rankStr}</div>` : '')+
          `<div style="font-size:0.72rem;color:var(--text-muted);margin-top:0.2rem;">${s.description}</div>`+
          `<div style="font-size:0.62rem;color:var(--accent);margin-top:0.15rem;">${rdap}${domain}</div></div>`;
      }).join('') || '<div style="padding:1rem;color:var(--text-muted);text-align:center;">No sites found</div>';
    }

    function filterBrowseSites() { renderBrowseSites(); }
    function browseNavigateTracked(url) {
      if (!url) return;
      const status = getPingStatus(url.startsWith('http') ? url : 'https://'+url);
      if (status === 'down') {
        if (!confirm('‚ö†Ô∏è This site may be down. Continue anyway?')) return;
      }
      const data = getBrowseData();
      data.clickCounts[url] = (data.clickCounts[url] || 0) + 1;
      data.lastVisited[url] = Date.now();
      saveBrowseData(data);
      browseNavigate(url);
    }
    function lazyFetchRdap(url) {
      const domain = getDomainFromUrl(url);
      const cache = loadRdapCache();
      if (cache[domain] && Date.now() - cache[domain].ts < 24*60*60*1000) return;
      fetchRdap(url).then(() => renderBrowseSiteCards());
    }
    function browseNavigate(url) {
      if (!url) return;
      if (!url.startsWith('http')) url = 'https://' + url;
      browseCurrentUrl = url;
      document.getElementById('browse-url-bar').value = url;
      document.getElementById('browse-iframe').src = url;
      document.getElementById('browse-iframe').style.display = 'block';
      document.getElementById('browse-placeholder').style.display = 'none';
    }
    function browsePanelBack() {
      document.getElementById('browse-iframe').style.display = 'none';
      document.getElementById('browse-iframe').src = '';
      document.getElementById('browse-placeholder').style.display = 'flex';
      document.getElementById('browse-url-bar').value = '';
      browseCurrentUrl = '';
    }
    function browseOpenExternal() { if (browseCurrentUrl) window.open(browseCurrentUrl, '_blank'); }
    function addToQuickBar(url) { const data = getBrowseData(); if (!data.quickBar.includes(url)) { data.quickBar.push(url); saveBrowseData(data); renderQuickBar(); } }
    function removeFromQuickBar(url) { const data = getBrowseData(); data.quickBar = data.quickBar.filter(u => u !== url); saveBrowseData(data); renderQuickBar(); }
    function hideSite(url) { const data = getBrowseData(); if (!data.hidden.includes(url)) { data.hidden.push(url); saveBrowseData(data); renderBrowseSites(); } }
    function createCollection() { const name = prompt('Collection name:'); if (!name || !name.trim()) return; const data = getBrowseData(); if (!data.collections[name.trim()]) { data.collections[name.trim()] = []; saveBrowseData(data); renderCollections(); } }
    function deleteCollection(name) { if (!confirm('Delete collection "' + name + '"?')) return; const data = getBrowseData(); delete data.collections[name]; saveBrowseData(data); if (browseActiveCategory === 'collection:' + name) browseActiveCategory = ''; renderBrowseSites(); }
    function addToCollection(url, collectionName) { const data = getBrowseData(); if (!data.collections[collectionName]) data.collections[collectionName] = []; if (!data.collections[collectionName].includes(url)) { data.collections[collectionName].push(url); saveBrowseData(data); renderBrowseSites(); } }
    function showAddSiteModal() {
      const url = prompt('Site URL:'); if (!url) return;
      const name = prompt('Site name:') || new URL(url.startsWith('http') ? url : 'https://'+url).hostname;
      const desc = prompt('Description (optional):') || '';
      const category = prompt('Category (Tech, Shopping, News, Entertainment, Gaming, Education, Creative, Social, Tools):') || 'Tools';
      const data = getBrowseData();
      data.customSites.push({ url: url.startsWith('http') ? url : 'https://'+url, name, description: desc, category, icon: 'üåê' });
      saveBrowseData(data); renderBrowseSites();
    }

    let siteContextMenu = null;
    function showSiteContextMenu(event, url, name) {
      if (siteContextMenu) siteContextMenu.remove();
      const data = getBrowseData();
      const inQuickBar = data.quickBar.includes(url);
      const collNames = Object.keys(data.collections);
      const menu = document.createElement('div');
      menu.style.cssText = 'position:fixed;z-index:9999;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:0.3rem 0;box-shadow:0 4px 12px rgba(0,0,0,0.3);min-width:160px;';
      menu.style.left = event.clientX + 'px'; menu.style.top = event.clientY + 'px';
      const items = [
        { label: inQuickBar ? '‚ö° Remove from Quick Bar' : '‚ö° Add to Quick Bar', action: () => inQuickBar ? removeFromQuickBar(url) : addToQuickBar(url) },
        { label: '‚Üó Open in New Tab', action: () => window.open(url, '_blank') },
        { label: 'üö´ Hide Site', action: () => hideSite(url) },
      ];
      if (collNames.length > 0) { items.push({ label: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', action: null }); collNames.forEach(c => { items.push({ label: 'üìÅ Add to ' + c, action: () => addToCollection(url, c) }); }); }
      menu.innerHTML = items.map((item, i) => {
        if (!item.action) return '<div style="border-top:1px solid var(--border);margin:0.2rem 0;"></div>';
        return `<div class="ctx-item" data-idx="${i}" style="padding:0.3rem 0.8rem;cursor:pointer;font-size:0.8rem;color:var(--text);" onmouseenter="this.style.background='var(--accent)'" onmouseleave="this.style.background=''">${item.label}</div>`;
      }).join('');
      menu.querySelectorAll('.ctx-item').forEach(el => { el.addEventListener('click', () => { items[parseInt(el.dataset.idx)].action(); menu.remove(); siteContextMenu = null; }); });
      document.body.appendChild(menu); siteContextMenu = menu;
      setTimeout(() => document.addEventListener('click', function dismiss() { if(siteContextMenu) siteContextMenu.remove(); siteContextMenu=null; document.removeEventListener('click',dismiss); }, { once: false }), 10);
    }

    function initBrowseTab() { renderQuickBar(); renderBrowseSites(); }

    // ‚îÄ‚îÄ Dashboard Tab ‚îÄ‚îÄ
    const DASHBOARD_STORAGE_KEY = 'humanity_dashboard';
    const WIDGET_TYPES = {
      clock: { name: 'Clock', icon: 'üïê', description: 'Current time and date', defaultSize: 'small' },
      notes: { name: 'Notes', icon: 'üìù', description: 'Quick notes pad', defaultSize: 'medium' },
      todos: { name: 'Todos', icon: '‚úÖ', description: 'Your todo list', defaultSize: 'medium' },
      friends: { name: 'Friends Online', icon: 'üë•', description: 'Who is online now', defaultSize: 'small' },
      stats: { name: 'Server Stats', icon: 'üìà', description: 'Relay server statistics', defaultSize: 'small' },
      quicklinks: { name: 'Quick Links', icon: '‚ö°', description: 'Your favorite bookmarks', defaultSize: 'small' },
      embed: { name: 'Website Embed', icon: 'üåê', description: 'Embed any website', defaultSize: 'large' },
      chat: { name: 'Chat Feed', icon: 'üí¨', description: 'Live messages from a channel', defaultSize: 'large' },
      weather: { name: 'Weather', icon: 'üå§Ô∏è', description: 'Current weather', defaultSize: 'small' },
      activity: { name: 'Recent Activity', icon: 'üîî', description: 'Latest messages across channels', defaultSize: 'medium' },
    };

    function loadDashboard() { try { return JSON.parse(localStorage.getItem(DASHBOARD_STORAGE_KEY)) || { widgets: [] }; } catch { return { widgets: [] }; } }
    function saveDashboard(data) { localStorage.setItem(DASHBOARD_STORAGE_KEY, JSON.stringify(data)); if (typeof scheduleSyncSave === 'function') scheduleSyncSave(); }

    function renderDashboard() {
      const data = loadDashboard();
      const grid = document.getElementById('dashboard-grid');
      const empty = document.getElementById('dashboard-empty');
      if (!grid) return;
      if (data.widgets.length === 0) { grid.style.display = 'none'; if (empty) empty.style.display = 'block'; return; }
      grid.style.display = 'grid'; if (empty) empty.style.display = 'none';
      grid.innerHTML = data.widgets.map((w, i) => {
        const sizeStyle = w.size === 'large' ? 'grid-column:span 2;min-height:300px;' : w.size === 'medium' ? 'min-height:200px;' : 'min-height:140px;';
        return `<div class="dashboard-widget" style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;overflow:hidden;${sizeStyle}display:flex;flex-direction:column;" data-widget-idx="${i}"><div style="display:flex;justify-content:space-between;align-items:center;padding:0.4rem 0.6rem;border-bottom:1px solid var(--border);flex-shrink:0;"><span style="font-size:0.8rem;font-weight:600;">${WIDGET_TYPES[w.type]?.icon || 'üì¶'} ${WIDGET_TYPES[w.type]?.name || w.type}</span><div style="display:flex;gap:0.3rem;"><button onclick="cycleWidgetSize(${i})" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.7rem;" title="Resize">‚áî</button><button onclick="moveWidget(${i},-1)" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.7rem;" title="Move left">‚óÄ</button><button onclick="moveWidget(${i},1)" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.7rem;" title="Move right">‚ñ∂</button><button onclick="removeWidget(${i})" style="background:none;border:none;color:#c0392b;cursor:pointer;font-size:0.7rem;" title="Remove">‚úï</button></div></div><div class="widget-content" style="flex:1;padding:0.5rem;overflow:auto;" id="widget-content-${i}"></div></div>`;
      }).join('');
      data.widgets.forEach((w, i) => renderWidgetContent(w, i));
    }

    function renderWidgetContent(widget, index) {
      const container = document.getElementById('widget-content-' + index);
      if (!container) return;
      switch (widget.type) {
        case 'clock': {
          function updateClock() {
            if (!document.getElementById('widget-content-' + index)) return;
            const now = new Date();
            container.innerHTML = `<div style="text-align:center;padding:0.5rem;"><div style="font-size:2rem;font-weight:700;color:var(--accent);">${now.toLocaleTimeString()}</div><div style="font-size:0.9rem;color:var(--text-muted);margin-top:0.3rem;">${now.toLocaleDateString(undefined, {weekday:'long',year:'numeric',month:'long',day:'numeric'})}</div></div>`;
            setTimeout(updateClock, 1000);
          }
          updateClock(); break;
        }
        case 'notes': {
          const notes = localStorage.getItem('humanity_notes'); let notesList = []; try { notesList = JSON.parse(notes) || []; } catch {}
          container.innerHTML = notesList.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:1rem;">No notes yet. Create them in the Reality tab.</div>' : notesList.map(n => `<div style="padding:0.3rem 0;border-bottom:1px solid var(--border);font-size:0.8rem;"><strong>${n.title || 'Untitled'}</strong><div style="color:var(--text-muted);font-size:0.72rem;max-height:40px;overflow:hidden;">${(n.content || '').substring(0, 100)}</div></div>`).join('');
          break;
        }
        case 'todos': {
          const todos = localStorage.getItem('humanity_todos'); let todoList = []; try { todoList = JSON.parse(todos) || []; } catch {}
          container.innerHTML = todoList.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:1rem;">No todos yet. Create them in the Reality tab.</div>' : todoList.map(t => `<div style="padding:0.25rem 0;font-size:0.8rem;display:flex;gap:0.3rem;align-items:start;"><span>${t.done ? '‚òë' : '‚òê'}</span><span style="${t.done?'text-decoration:line-through;color:var(--text-muted);':''}">${t.text || t.title || ''}</span></div>`).join('');
          break;
        }
        case 'friends': {
          const peers = (typeof peerData !== 'undefined') ? Object.values(peerData).filter(p => !p.public_key?.startsWith('bot_') && !p.public_key?.startsWith('viewer_')) : [];
          container.innerHTML = peers.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:1rem;">Connect to chat to see friends online</div>' : peers.map(p => `<div style="padding:0.2rem 0;font-size:0.8rem;">üü¢ ${p.display_name || p.public_key?.substring(0,8) || 'Unknown'} ${p.role === 'admin' ? 'üëë' : p.role === 'mod' ? 'üõ°Ô∏è' : ''}</div>`).join('');
          break;
        }
        case 'stats': {
          fetch('/api/stats').then(r => r.json()).then(stats => {
            container.innerHTML = `<div style="padding:0.3rem;"><div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;"><div style="text-align:center;"><div style="font-size:1.5rem;font-weight:700;color:var(--accent);">${stats.connected_peers || 0}</div><div style="font-size:0.7rem;color:var(--text-muted);">Online</div></div><div style="text-align:center;"><div style="font-size:1.5rem;font-weight:700;color:var(--accent);">${stats.total_messages || 0}</div><div style="font-size:0.7rem;color:var(--text-muted);">Messages</div></div></div></div>`;
          }).catch(() => { container.innerHTML = '<div style="color:var(--text-muted);text-align:center;">Could not load stats</div>'; });
          break;
        }
        case 'quicklinks': {
          const qlData = typeof getBrowseData === 'function' ? getBrowseData() : { quickBar: [] };
          const allSites = typeof getAllSites === 'function' ? getAllSites() : [];
          container.innerHTML = qlData.quickBar.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:1rem;">No quick links yet</div>' :
            `<div style="display:flex;flex-wrap:wrap;gap:0.4rem;">${qlData.quickBar.map(url => { const site = allSites.find(s => s.url === url); return `<a href="${url}" target="_blank" rel="noopener" style="background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:0.25rem 0.5rem;font-size:0.75rem;color:var(--text);text-decoration:none;display:flex;align-items:center;gap:0.2rem;">${site?.icon || 'üåê'} ${site?.name || new URL(url).hostname}</a>`; }).join('')}</div>`;
          break;
        }
        case 'embed': {
          const embedUrl = widget.config?.url || '';
          if (!embedUrl) { container.innerHTML = `<div style="text-align:center;padding:1rem;"><input type="text" placeholder="Enter URL to embed..." id="embed-url-${index}" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.3rem 0.6rem;border-radius:6px;font-size:0.8rem;width:80%;"><button onclick="setEmbedUrl(${index})" style="background:var(--accent);border:none;border-radius:6px;color:#fff;padding:0.3rem 0.6rem;cursor:pointer;font-size:0.8rem;margin-top:0.3rem;">Load</button></div>`; }
          else { container.style.padding = '0'; container.innerHTML = `<iframe src="${embedUrl}" style="width:100%;height:100%;border:none;" sandbox="allow-scripts allow-same-origin allow-forms allow-popups" referrerpolicy="no-referrer"></iframe>`; }
          break;
        }
        case 'weather': {
          container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:1rem;">Loading weather...</div>';
          fetch('https://wttr.in/?format=j1').then(r => r.json()).then(w => {
            const current = w.current_condition?.[0] || {}; const area = w.nearest_area?.[0] || {};
            container.innerHTML = `<div style="text-align:center;padding:0.3rem;"><div style="font-size:1.8rem;">${current.temp_F || '?'}¬∞F</div><div style="font-size:0.8rem;color:var(--text-muted);">${current.weatherDesc?.[0]?.value || 'Unknown'}</div><div style="font-size:0.72rem;color:var(--text-muted);margin-top:0.2rem;">${area.areaName?.[0]?.value || ''}, ${area.region?.[0]?.value || ''}</div><div style="font-size:0.7rem;color:var(--text-muted);margin-top:0.2rem;">üí® ${current.windspeedMiles || '?'} mph ¬∑ üíß ${current.humidity || '?'}%</div></div>`;
          }).catch(() => { container.innerHTML = '<div style="color:var(--text-muted);text-align:center;">Weather unavailable</div>'; });
          break;
        }
        case 'chat': {
          const channel = widget.config?.channel || 'general';
          container.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:1rem;">Loading chat...</div>';
          fetch('/api/messages?limit=15&channel=' + encodeURIComponent(channel)).then(r => r.json()).then(d => {
            if (d.messages && d.messages.length > 0) { container.innerHTML = d.messages.map(m => `<div style="padding:0.2rem 0;font-size:0.78rem;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="color:var(--accent);font-weight:600;">${m.from_name || 'Unknown'}</span><span style="color:var(--text-muted);font-size:0.65rem;margin-left:0.3rem;">${new Date(m.timestamp).toLocaleTimeString()}</span><div style="color:var(--text);">${m.content.substring(0, 200)}</div></div>`).join(''); }
            else { container.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:1rem;">No messages in #' + channel + '</div>'; }
          }).catch(() => { container.innerHTML = '<div style="color:var(--text-muted);text-align:center;">Could not load chat</div>'; });
          break;
        }
        case 'activity': {
          fetch('/api/messages?limit=20').then(r => r.json()).then(d => {
            if (d.messages && d.messages.length > 0) { container.innerHTML = d.messages.map(m => `<div style="padding:0.2rem 0;font-size:0.78rem;border-bottom:1px solid rgba(255,255,255,0.05);"><span style="font-size:0.65rem;color:var(--text-muted);">#${m.channel || 'general'}</span><span style="color:var(--accent);font-weight:600;margin-left:0.3rem;">${m.from_name || 'Unknown'}</span><span style="color:var(--text-muted);font-size:0.65rem;margin-left:0.3rem;">${new Date(m.timestamp).toLocaleTimeString()}</span><div style="color:var(--text);">${m.content.substring(0, 150)}</div></div>`).join(''); }
            else { container.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:1rem;">No recent activity</div>'; }
          }).catch(() => { container.innerHTML = '<div style="color:var(--text-muted);text-align:center;">Could not load activity</div>'; });
          break;
        }
        default: container.innerHTML = '<div style="color:var(--text-muted);text-align:center;">Unknown widget type</div>';
      }
    }

    function showAddWidgetModal() {
      const types = Object.entries(WIDGET_TYPES);
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;';
      modal.innerHTML = `<div style="background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:1.5rem;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;"><h3 style="margin:0;color:var(--accent);">Add Widget</h3><button onclick="this.closest('[style*=fixed]').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.2rem;">‚úï</button></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">${types.map(([key, t]) => `<div onclick="addWidget('${key}');this.closest('[style*=fixed]').remove()" style="padding:0.8rem;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;cursor:pointer;text-align:center;" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'"><div style="font-size:1.5rem;">${t.icon}</div><div style="font-weight:600;font-size:0.85rem;margin-top:0.2rem;">${t.name}</div><div style="font-size:0.7rem;color:var(--text-muted);margin-top:0.1rem;">${t.description}</div></div>`).join('')}</div></div>`;
      document.body.appendChild(modal);
      modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    }

    function addWidget(type) {
      const data = loadDashboard(); const config = {};
      if (type === 'chat') { const ch = prompt('Channel name:', 'general'); if (!ch) return; config.channel = ch; }
      else if (type === 'embed') { const url = prompt('URL to embed (or leave empty to set later):'); if (url) config.url = url.startsWith('http') ? url : 'https://' + url; }
      data.widgets.push({ type, config, size: WIDGET_TYPES[type]?.defaultSize || 'medium', id: 'w' + Date.now() });
      saveDashboard(data); renderDashboard();
    }
    function removeWidget(index) { const data = loadDashboard(); data.widgets.splice(index, 1); saveDashboard(data); renderDashboard(); }
    function moveWidget(index, direction) { const data = loadDashboard(); const newIndex = index + direction; if (newIndex < 0 || newIndex >= data.widgets.length) return; [data.widgets[index], data.widgets[newIndex]] = [data.widgets[newIndex], data.widgets[index]]; saveDashboard(data); renderDashboard(); }
    function cycleWidgetSize(index) { const data = loadDashboard(); const sizes = ['small', 'medium', 'large']; const current = sizes.indexOf(data.widgets[index].size); data.widgets[index].size = sizes[(current + 1) % sizes.length]; saveDashboard(data); renderDashboard(); }
    function setEmbedUrl(index) { const input = document.getElementById('embed-url-' + index); if (!input) return; let url = input.value; if (!url) return; if (!url.startsWith('http')) url = 'https://' + url; const data = loadDashboard(); data.widgets[index].config = data.widgets[index].config || {}; data.widgets[index].config.url = url; saveDashboard(data); renderDashboard(); }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚îÄ‚îÄ Skill DNA System ‚îÄ‚îÄ
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    (function() {
      const SKILL_CATEGORIES = {
        crafting: { name: 'Crafting & Making', icon: 'üî®', skills: ['woodworking', 'metalworking', 'welding', 'soldering', 'sewing', 'leatherwork', 'pottery', 'glassblowing', 'blacksmithing', 'cnc', '3d_printing', 'laser_cutting'] },
        engineering: { name: 'Engineering', icon: '‚öôÔ∏è', skills: ['mechanical', 'electrical', 'civil', 'chemical', 'software', 'aerospace', 'robotics', 'plumbing', 'hvac', 'automotive'] },
        agriculture: { name: 'Agriculture', icon: 'üå±', skills: ['soil_gardening', 'hydroponics', 'aeroponics', 'aquaponics', 'permaculture', 'composting', 'seed_saving', 'beekeeping', 'animal_husbandry', 'foraging', 'food_preservation', 'mycology'] },
        digital: { name: 'Digital', icon: 'üíª', skills: ['programming', 'web_dev', 'game_dev', '3d_modeling', 'video_editing', 'audio_production', 'graphic_design', 'ui_ux', 'cybersecurity', 'networking', 'ai_ml', 'database'] },
        survival: { name: 'Survival', icon: 'üèïÔ∏è', skills: ['fire_starting', 'shelter_building', 'water_purification', 'navigation', 'first_aid', 'knot_tying', 'hunting', 'fishing', 'trapping', 'tracking', 'weather_reading'] },
        science: { name: 'Science', icon: 'üî¨', skills: ['biology', 'chemistry', 'physics', 'astronomy', 'geology', 'ecology', 'mathematics', 'statistics', 'medicine', 'nutrition'] },
        arts: { name: 'Arts & Expression', icon: 'üé®', skills: ['drawing', 'painting', 'sculpting', 'music_instrument', 'singing', 'writing', 'photography', 'acting', 'dance', 'calligraphy'] },
        social: { name: 'Social', icon: 'ü§ù', skills: ['teaching', 'leadership', 'negotiation', 'public_speaking', 'counseling', 'languages', 'conflict_resolution', 'mentoring', 'community_organizing'] },
        fitness: { name: 'Fitness & Body', icon: 'üí™', skills: ['strength_training', 'cardio', 'flexibility', 'martial_arts', 'swimming', 'climbing', 'cycling', 'yoga', 'sports'] },
        home: { name: 'Homesteading', icon: 'üè†', skills: ['cooking', 'baking', 'canning', 'cleaning', 'organizing', 'budgeting', 'childcare', 'elder_care', 'home_repair', 'interior_design'] },
      };

      const SKILL_META = {
        woodworking: { name:'Woodworking', icon:'ü™ö', desc:'Working with wood to create structures and objects', prereqs:[], subskills:['carving','joinery','turning','finishing'] },
        metalworking: { name:'Metalworking', icon:'‚öíÔ∏è', desc:'Shaping and forming metals', prereqs:[], subskills:['forging','casting','machining','sheet_metal'] },
        welding: { name:'Welding', icon:'üî•', desc:'Joining metals using heat and filler material', prereqs:['metalworking'], subskills:['mig','tig','stick','oxy_acetylene','spot'] },
        soldering: { name:'Soldering', icon:'üîå', desc:'Joining electronic components with solder', prereqs:[], subskills:['through_hole','smd','desoldering'] },
        sewing: { name:'Sewing', icon:'üßµ', desc:'Joining fabric with needle and thread', prereqs:[], subskills:['hand_sewing','machine','pattern_making'] },
        leatherwork: { name:'Leatherwork', icon:'üëú', desc:'Crafting with leather', prereqs:[], subskills:['tooling','stitching','dying'] },
        pottery: { name:'Pottery', icon:'üè∫', desc:'Creating objects from clay', prereqs:[], subskills:['wheel','hand_building','glazing'] },
        glassblowing: { name:'Glassblowing', icon:'üîÆ', desc:'Shaping molten glass', prereqs:[], subskills:['lampwork','furnace','fusing'] },
        blacksmithing: { name:'Blacksmithing', icon:'‚öíÔ∏è', desc:'Forging iron and steel', prereqs:['metalworking'], subskills:['blade_making','tool_making','decorative'] },
        cnc: { name:'CNC', icon:'üñ•Ô∏è', desc:'Computer numerical control machining', prereqs:['metalworking'], subskills:['cam_programming','milling','lathe'] },
        '3d_printing': { name:'3D Printing', icon:'üñ®Ô∏è', desc:'Additive manufacturing', prereqs:['3d_modeling'], subskills:['fdm','resin','slicing'] },
        laser_cutting: { name:'Laser Cutting', icon:'‚úÇÔ∏è', desc:'Precision cutting with lasers', prereqs:[], subskills:['vector_design','engraving','material_selection'] },
        mechanical: { name:'Mechanical Eng.', icon:'‚öôÔ∏è', desc:'Design and analysis of mechanical systems', prereqs:[], subskills:['cad','thermodynamics','materials'] },
        electrical: { name:'Electrical Eng.', icon:'‚ö°', desc:'Electrical systems and circuits', prereqs:[], subskills:['circuit_design','power_systems','signal_processing'] },
        civil: { name:'Civil Eng.', icon:'üèóÔ∏è', desc:'Infrastructure and structural engineering', prereqs:[], subskills:['structural','geotechnical','transportation'] },
        chemical: { name:'Chemical Eng.', icon:'üß™', desc:'Chemical processes and materials', prereqs:['chemistry'], subskills:['process_design','materials_science'] },
        software: { name:'Software Eng.', icon:'üíæ', desc:'Software design and architecture', prereqs:['programming'], subskills:['architecture','testing','devops'] },
        aerospace: { name:'Aerospace', icon:'üöÄ', desc:'Aircraft and spacecraft engineering', prereqs:['mechanical'], subskills:['aerodynamics','propulsion','avionics'] },
        robotics: { name:'Robotics', icon:'ü§ñ', desc:'Design and programming of robots', prereqs:['programming','electrical'], subskills:['kinematics','control_systems','sensors'] },
        plumbing: { name:'Plumbing', icon:'üîß', desc:'Water supply and drainage systems', prereqs:[], subskills:['pipe_fitting','drainage','fixtures'] },
        hvac: { name:'HVAC', icon:'‚ùÑÔ∏è', desc:'Heating, ventilation, and air conditioning', prereqs:[], subskills:['refrigeration','ductwork','controls'] },
        automotive: { name:'Automotive', icon:'üöó', desc:'Vehicle repair and maintenance', prereqs:[], subskills:['engine','transmission','electrical','bodywork'] },
        soil_gardening: { name:'Soil Gardening', icon:'üåª', desc:'Growing plants in soil', prereqs:[], subskills:['vegetables','flowers','fruit_trees','herbs'] },
        hydroponics: { name:'Hydroponics', icon:'üíß', desc:'Growing plants without soil in water', prereqs:[], subskills:['nft','dwc','drip'] },
        aeroponics: { name:'Aeroponics', icon:'üí®', desc:'Growing plants in air/mist', prereqs:['hydroponics'], subskills:['high_pressure','low_pressure'] },
        aquaponics: { name:'Aquaponics', icon:'üêü', desc:'Combined fish and plant growing', prereqs:['hydroponics','fishing'], subskills:['system_design','fish_care','plant_care'] },
        permaculture: { name:'Permaculture', icon:'üåø', desc:'Sustainable agricultural design', prereqs:['soil_gardening'], subskills:['design','guilds','water_management'] },
        composting: { name:'Composting', icon:'‚ôªÔ∏è', desc:'Decomposing organic matter into soil', prereqs:[], subskills:['hot','cold','vermicomposting'] },
        seed_saving: { name:'Seed Saving', icon:'üå∞', desc:'Collecting and storing seeds', prereqs:['soil_gardening'], subskills:['selection','drying','storage'] },
        beekeeping: { name:'Beekeeping', icon:'üêù', desc:'Managing bee colonies', prereqs:[], subskills:['hive_management','honey_harvest','queen_rearing'] },
        animal_husbandry: { name:'Animal Husbandry', icon:'üêÑ', desc:'Raising and caring for animals', prereqs:[], subskills:['poultry','livestock','veterinary_basics'] },
        foraging: { name:'Foraging', icon:'üçÑ', desc:'Finding wild food sources', prereqs:[], subskills:['plant_id','mushroom_id','seasonal'] },
        food_preservation: { name:'Food Preservation', icon:'ü´ô', desc:'Preserving food for storage', prereqs:[], subskills:['canning_fp','drying','fermenting','smoking'] },
        mycology: { name:'Mycology', icon:'üçÑ', desc:'Study and cultivation of fungi', prereqs:['biology'], subskills:['identification','cultivation','spawn_production'] },
        programming: { name:'Programming', icon:'üë®‚Äçüíª', desc:'Writing computer code', prereqs:[], subskills:['python','javascript','rust','c_cpp','go'] },
        web_dev: { name:'Web Dev', icon:'üåê', desc:'Building websites and web apps', prereqs:['programming'], subskills:['frontend','backend','fullstack'] },
        game_dev: { name:'Game Dev', icon:'üéÆ', desc:'Creating video games', prereqs:['programming'], subskills:['game_design','engine_dev','level_design'] },
        '3d_modeling': { name:'3D Modeling', icon:'üßä', desc:'Creating 3D digital models', prereqs:[], subskills:['hard_surface','organic','sculpting_3d','texturing'] },
        video_editing: { name:'Video Editing', icon:'üé¨', desc:'Editing and producing video', prereqs:[], subskills:['cutting','effects','color_grading','motion_graphics'] },
        audio_production: { name:'Audio Production', icon:'üéµ', desc:'Recording and producing audio', prereqs:[], subskills:['recording','mixing','mastering','sound_design'] },
        graphic_design: { name:'Graphic Design', icon:'üé®', desc:'Visual communication design', prereqs:[], subskills:['typography','layout','branding','illustration'] },
        ui_ux: { name:'UI/UX Design', icon:'üì±', desc:'User interface and experience design', prereqs:[], subskills:['wireframing','prototyping','user_research'] },
        cybersecurity: { name:'Cybersecurity', icon:'üîê', desc:'Protecting systems from threats', prereqs:['programming','networking'], subskills:['pen_testing','forensics','cryptography'] },
        networking: { name:'Networking', icon:'üîó', desc:'Computer network design and management', prereqs:[], subskills:['routing','switching','wireless','security'] },
        ai_ml: { name:'AI/ML', icon:'üß†', desc:'Artificial intelligence and machine learning', prereqs:['programming','mathematics'], subskills:['deep_learning','nlp','computer_vision'] },
        database: { name:'Database', icon:'üóÑÔ∏è', desc:'Database design and management', prereqs:['programming'], subskills:['sql','nosql','optimization'] },
        fire_starting: { name:'Fire Starting', icon:'üî•', desc:'Creating fire from various methods', prereqs:[], subskills:['friction','ferro_rod','bow_drill'] },
        shelter_building: { name:'Shelter Building', icon:'‚õ∫', desc:'Constructing emergency shelters', prereqs:[], subskills:['debris_hut','lean_to','snow_shelter'] },
        water_purification: { name:'Water Purification', icon:'üíß', desc:'Making water safe to drink', prereqs:[], subskills:['filtration','chemical','boiling','solar'] },
        navigation: { name:'Navigation', icon:'üß≠', desc:'Finding your way without GPS', prereqs:[], subskills:['compass','celestial','map_reading','terrain'] },
        first_aid: { name:'First Aid', icon:'üè•', desc:'Emergency medical treatment', prereqs:[], subskills:['wound_care','cpr','splinting','triage'] },
        knot_tying: { name:'Knot Tying', icon:'ü™¢', desc:'Tying useful knots', prereqs:[], subskills:['hitches','bends','loops','lashings'] },
        hunting: { name:'Hunting', icon:'üèπ', desc:'Hunting wild game', prereqs:[], subskills:['rifle','bow','tracking_hunt','field_dressing'] },
        fishing: { name:'Fishing', icon:'üé£', desc:'Catching fish', prereqs:[], subskills:['fly','spinning','bait','ice_fishing'] },
        trapping: { name:'Trapping', icon:'ü™§', desc:'Setting traps for game', prereqs:[], subskills:['snares','deadfalls','cage_traps'] },
        tracking: { name:'Tracking', icon:'üêæ', desc:'Following animal and human tracks', prereqs:[], subskills:['footprints','scat','trail_signs'] },
        weather_reading: { name:'Weather Reading', icon:'üå§Ô∏è', desc:'Predicting weather from natural signs', prereqs:[], subskills:['clouds','wind','barometric','seasonal_patterns'] },
        biology: { name:'Biology', icon:'üß¨', desc:'Study of living organisms', prereqs:[], subskills:['molecular','ecology_bio','genetics','microbiology'] },
        chemistry: { name:'Chemistry', icon:'‚öóÔ∏è', desc:'Study of matter and its properties', prereqs:[], subskills:['organic','inorganic','analytical','biochemistry'] },
        physics: { name:'Physics', icon:'‚öõÔ∏è', desc:'Study of matter, energy, and forces', prereqs:['mathematics'], subskills:['mechanics','electromagnetism','quantum','relativity'] },
        astronomy: { name:'Astronomy', icon:'üî≠', desc:'Study of celestial objects', prereqs:[], subskills:['observation','astrophotography','cosmology'] },
        geology: { name:'Geology', icon:'ü™®', desc:'Study of Earth and its processes', prereqs:[], subskills:['mineralogy','petrology','paleontology'] },
        ecology: { name:'Ecology', icon:'üåç', desc:'Study of ecosystems', prereqs:['biology'], subskills:['conservation','field_study','restoration'] },
        mathematics: { name:'Mathematics', icon:'üìê', desc:'Study of numbers, quantities, and shapes', prereqs:[], subskills:['algebra','calculus','geometry','discrete'] },
        statistics: { name:'Statistics', icon:'üìä', desc:'Analysis and interpretation of data', prereqs:['mathematics'], subskills:['probability','regression','bayesian','experimental_design'] },
        medicine: { name:'Medicine', icon:'‚öïÔ∏è', desc:'Practice of healthcare', prereqs:['biology','chemistry'], subskills:['diagnosis','pharmacology','surgery','emergency'] },
        nutrition: { name:'Nutrition', icon:'ü•ó', desc:'Study of food and health', prereqs:[], subskills:['macro_nutrients','micro_nutrients','diet_planning'] },
        drawing: { name:'Drawing', icon:'‚úèÔ∏è', desc:'Creating images with pencil, pen, or digital tools', prereqs:[], subskills:['sketching','figure_drawing','perspective','digital_drawing'] },
        painting: { name:'Painting', icon:'üñåÔ∏è', desc:'Applying pigment to surfaces', prereqs:[], subskills:['oil','acrylic','watercolor','digital_painting'] },
        sculpting: { name:'Sculpting', icon:'üóø', desc:'Creating 3D art forms', prereqs:[], subskills:['clay_sculpt','stone','wood_sculpt','metal_sculpt'] },
        music_instrument: { name:'Music Instrument', icon:'üé∏', desc:'Playing a musical instrument', prereqs:[], subskills:['guitar','piano','drums','strings','wind'] },
        singing: { name:'Singing', icon:'üé§', desc:'Vocal performance', prereqs:[], subskills:['technique','harmony','performance'] },
        writing: { name:'Writing', icon:'‚úçÔ∏è', desc:'Creative and technical writing', prereqs:[], subskills:['fiction','nonfiction','poetry','technical'] },
        photography: { name:'Photography', icon:'üì∑', desc:'Capturing images', prereqs:[], subskills:['portrait','landscape','studio','editing'] },
        acting: { name:'Acting', icon:'üé≠', desc:'Theatrical and film performance', prereqs:[], subskills:['stage','screen','voice','improv'] },
        dance: { name:'Dance', icon:'üíÉ', desc:'Movement as artistic expression', prereqs:[], subskills:['ballet','contemporary','hip_hop','ballroom'] },
        calligraphy: { name:'Calligraphy', icon:'üñãÔ∏è', desc:'Artistic handwriting', prereqs:[], subskills:['western','eastern','modern','lettering'] },
        teaching: { name:'Teaching', icon:'üë©‚Äçüè´', desc:'Educating others', prereqs:[], subskills:['curriculum','classroom','online','mentoring_t'] },
        leadership: { name:'Leadership', icon:'üëë', desc:'Guiding and inspiring groups', prereqs:[], subskills:['team_building','decision_making','delegation'] },
        negotiation: { name:'Negotiation', icon:'ü§ù', desc:'Reaching agreements', prereqs:[], subskills:['preparation','persuasion','mediation'] },
        public_speaking: { name:'Public Speaking', icon:'üéôÔ∏è', desc:'Speaking to audiences', prereqs:[], subskills:['presentation','debate','storytelling'] },
        counseling: { name:'Counseling', icon:'üí¨', desc:'Helping others through difficulties', prereqs:[], subskills:['active_listening','empathy','crisis_intervention'] },
        languages: { name:'Languages', icon:'üåê', desc:'Speaking foreign languages', prereqs:[], subskills:['reading_lang','writing_lang','conversation','translation'] },
        conflict_resolution: { name:'Conflict Resolution', icon:'‚òÆÔ∏è', desc:'Resolving disputes peacefully', prereqs:[], subskills:['mediation_cr','facilitation','restorative_justice'] },
        mentoring: { name:'Mentoring', icon:'üßô', desc:'Guiding personal and professional development', prereqs:['teaching'], subskills:['coaching','feedback','career_guidance'] },
        community_organizing: { name:'Community Organizing', icon:'üì£', desc:'Building and mobilizing communities', prereqs:[], subskills:['outreach','event_planning','advocacy'] },
        strength_training: { name:'Strength Training', icon:'üèãÔ∏è', desc:'Building muscular strength', prereqs:[], subskills:['powerlifting','bodybuilding','calisthenics','olympic_lifts'] },
        cardio: { name:'Cardio', icon:'‚ù§Ô∏è', desc:'Cardiovascular fitness', prereqs:[], subskills:['running','rowing','hiit','jump_rope'] },
        flexibility: { name:'Flexibility', icon:'ü§∏', desc:'Stretching and mobility', prereqs:[], subskills:['static','dynamic','pnf'] },
        martial_arts: { name:'Martial Arts', icon:'ü•ã', desc:'Combat and self-defense', prereqs:[], subskills:['striking','grappling','weapons','forms'] },
        swimming: { name:'Swimming', icon:'üèä', desc:'Aquatic movement', prereqs:[], subskills:['freestyle','backstroke','diving','open_water'] },
        climbing: { name:'Climbing', icon:'üßó', desc:'Rock and wall climbing', prereqs:[], subskills:['bouldering','sport','trad','ice'] },
        cycling: { name:'Cycling', icon:'üö¥', desc:'Bicycle riding', prereqs:[], subskills:['road','mountain','touring','maintenance'] },
        yoga: { name:'Yoga', icon:'üßò', desc:'Physical and mental yoga practice', prereqs:[], subskills:['vinyasa','hatha','ashtanga','meditation'] },
        sports: { name:'Sports', icon:'‚öΩ', desc:'Organized athletic activities', prereqs:[], subskills:['team_sports','individual','coaching_s','strategy'] },
        cooking: { name:'Cooking', icon:'üë®‚Äçüç≥', desc:'Preparing food', prereqs:[], subskills:['techniques','cuisines','meal_planning','knife_skills'] },
        baking: { name:'Baking', icon:'üçû', desc:'Baking breads, pastries, and desserts', prereqs:[], subskills:['bread','pastry','cakes','sourdough'] },
        canning: { name:'Canning', icon:'ü´ô', desc:'Preserving food in jars', prereqs:[], subskills:['water_bath','pressure_canning','pickling','jam'] },
        cleaning: { name:'Cleaning', icon:'üßπ', desc:'Maintaining cleanliness', prereqs:[], subskills:['deep_cleaning','organizing_c','laundry','natural_cleaners'] },
        organizing: { name:'Organizing', icon:'üì¶', desc:'Systematizing spaces and information', prereqs:[], subskills:['decluttering','storage_solutions','digital_org'] },
        budgeting: { name:'Budgeting', icon:'üí∞', desc:'Managing personal finances', prereqs:[], subskills:['tracking','saving','investing','debt_management'] },
        childcare: { name:'Childcare', icon:'üë∂', desc:'Caring for children', prereqs:[], subskills:['infant','toddler','education_cc','first_aid_cc'] },
        elder_care: { name:'Elder Care', icon:'üë¥', desc:'Caring for elderly', prereqs:[], subskills:['daily_assistance','medical_care','companionship'] },
        home_repair: { name:'Home Repair', icon:'üî®', desc:'Fixing and maintaining a home', prereqs:[], subskills:['drywall','painting_hr','basic_plumbing','basic_electrical'] },
        interior_design: { name:'Interior Design', icon:'üõãÔ∏è', desc:'Designing living spaces', prereqs:[], subskills:['space_planning','color_theory','furniture','lighting'] },
      };

      const LEVEL_THRESHOLDS = [0, 1, 10, 50, 150, 500, 1000, 2500, 5000, 10000, 25000];
      const LEVEL_NAMES = ['Untrained','Novice','Beginner','Apprentice','Journeyman','Skilled','Expert','Master','Grandmaster','Legendary','Transcendent'];
      const LEVEL_COLORS = ['#666','#aaa','#4a8','#2a6','#28f','#a2f','#f2a','#fa2','#f52','#f00','#ff0'];

      function calcLevel(realityXp, fantasyXp) {
        const eff = (realityXp * 2) + fantasyXp;
        for (let i = LEVEL_THRESHOLDS.length - 1; i >= 0; i--) { if (eff >= LEVEL_THRESHOLDS[i]) return i; }
        return 0;
      }

      function xpToNextLevel(realityXp, fantasyXp) {
        const lv = calcLevel(realityXp, fantasyXp);
        if (lv >= 10) return { current: (realityXp*2)+fantasyXp, needed: Infinity, pct: 100 };
        const cur = (realityXp*2)+fantasyXp;
        const next = LEVEL_THRESHOLDS[lv+1];
        const prev = LEVEL_THRESHOLDS[lv];
        return { current: cur - prev, needed: next - prev, pct: Math.min(100, ((cur - prev) / (next - prev)) * 100) };
      }

      function loadSkills() {
        try { return JSON.parse(localStorage.getItem('humanity_skills')) || { skills: {}, verifications: [] }; }
        catch { return { skills: {}, verifications: [] }; }
      }
      function saveSkills(data) { localStorage.setItem('humanity_skills', JSON.stringify(data)); }

      function getSkillData(data, skillId) {
        return data.skills[skillId] || { realityXp: 0, fantasyXp: 0, logs: [], subskills: {} };
      }

      function checkPrereqs(data, skillId) {
        const meta = SKILL_META[skillId];
        if (!meta || !meta.prereqs || meta.prereqs.length === 0) return true;
        return meta.prereqs.every(pId => {
          const sd = getSkillData(data, pId);
          return calcLevel(sd.realityXp, sd.fantasyXp) >= 1;
        });
      }

      // ‚îÄ‚îÄ Render Skill DNA panel ‚îÄ‚îÄ
      function renderSkillDNA(containerId, mode) {
        const container = document.getElementById(containerId);
        if (!container) return;
        const data = loadSkills();
        const isFantasy = mode === 'fantasy';
        const accentColor = isFantasy ? 'var(--fantasy-accent,#9966ff)' : 'var(--accent)';

        // State
        if (!container._sdState) container._sdState = { category: 'crafting', view: 'grid' };
        const st = container._sdState;

        let html = '<div class="skill-dna">';
        // Sidebar
        html += '<div class="skill-dna-sidebar">';
        for (const [catId, cat] of Object.entries(SKILL_CATEGORIES)) {
          const isActive = st.category === catId;
          html += `<div class="sd-cat ${isActive?'active':''}" onclick="window._sdSelectCat('${containerId}','${catId}','${mode}')">${cat.icon} <span>${cat.name}</span></div>`;
        }
        // Stats & Find People
        html += `<div class="sd-cat" style="margin-top:auto;border-top:1px solid var(--border);" onclick="window._sdShowOverview('${containerId}','${mode}')">üìä Overview</div>`;
        html += `<div class="sd-cat" onclick="window._sdFindPeople()">üë• Find People</div>`;
        html += '</div>';

        // Main content
        const cat = SKILL_CATEGORIES[st.category];
        html += '<div class="skill-dna-main">';
        if (st.view === 'grid') {
          html += `<div class="skill-dna-header"><h3 style="color:${accentColor}">${cat.icon} ${cat.name}</h3>`;
          html += `<button onclick="window._sdLogActivity('${containerId}','${mode}','${st.category}')" style="background:${accentColor};color:#fff;border:none;padding:0.3rem 0.7rem;border-radius:6px;font-size:0.78rem;cursor:pointer;font-weight:600;">+ Log Activity</button>`;
          html += '</div>';
          html += '<div class="sd-grid">';
          for (const skillId of cat.skills) {
            const meta = SKILL_META[skillId];
            if (!meta) continue;
            const sd = getSkillData(data, skillId);
            const rXp = isFantasy ? sd.fantasyXp : sd.realityXp;
            const fXp = isFantasy ? sd.realityXp : sd.fantasyXp;
            const lv = calcLevel(sd.realityXp, sd.fantasyXp);
            const prog = xpToNextLevel(sd.realityXp, sd.fantasyXp);
            const locked = !checkPrereqs(data, skillId);
            const color = LEVEL_COLORS[lv];
            const verCount = (data.verifications || []).filter(v => v.skill === skillId).length;
            html += `<div class="sd-tile ${locked?'locked':''}" onclick="${locked?'':'window._sdOpenSkill(\\''+containerId+'\\',\\''+skillId+'\\',\\''+mode+'\\')'}">`;
            html += `<div class="sd-icon">${meta.icon}</div>`;
            html += `<div class="sd-name">${meta.name}</div>`;
            html += `<div class="sd-level" style="color:${color}">Lv ${lv} ${verCount?'‚úì':''}</div>`;
            html += `<div class="sd-bar"><div class="sd-bar-fill" style="width:${prog.pct}%;background:${color}"></div></div>`;
            html += '</div>';
          }
          html += '</div>';

          // Stats summary
          let totalR = 0, totalF = 0, verified = 0, verifs = (data.verifications||[]).length;
          for (const [sid, sd] of Object.entries(data.skills)) { totalR += sd.realityXp||0; totalF += sd.fantasyXp||0; }
          const uniqueVerified = new Set((data.verifications||[]).map(v=>v.skill)).size;
          html += '<div class="sd-stats">';
          html += `<div>Total Reality XP: <span>${Math.round(totalR)}h</span></div>`;
          html += `<div>Total Fantasy XP: <span>${Math.round(totalF)}h</span></div>`;
          html += `<div>Verified Skills: <span>${uniqueVerified}</span> (${verifs} verifications)</div>`;
          html += '</div>';
        } else if (st.view === 'overview') {
          html += renderOverview(data, isFantasy, accentColor, containerId, mode);
        }
        html += '</div></div>';
        container.innerHTML = html;
      }

      function renderOverview(data, isFantasy, accentColor, containerId, mode) {
        let html = `<div class="skill-dna-header"><h3 style="color:${accentColor}">üìä Skill Overview</h3>`;
        html += `<button onclick="window._sdSelectCat('${containerId}','crafting','${mode}')" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.3rem 0.7rem;border-radius:6px;font-size:0.78rem;cursor:pointer;">‚Üê Back</button></div>`;

        // Category bar chart
        html += '<div style="margin:0.6rem 0;">';
        for (const [catId, cat] of Object.entries(SKILL_CATEGORIES)) {
          let catHours = 0;
          for (const sid of cat.skills) { const sd = getSkillData(data, sid); catHours += (sd.realityXp||0) + (sd.fantasyXp||0); }
          const maxH = 500;
          const pct = Math.min(100, (catHours / maxH) * 100);
          html += `<div style="display:flex;align-items:center;gap:0.4rem;margin:0.2rem 0;font-size:0.78rem;">`;
          html += `<span style="width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${cat.icon} ${cat.name}</span>`;
          html += `<div style="flex:1;height:12px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;">`;
          html += `<div style="height:100%;width:${pct}%;background:${accentColor};border-radius:4px;"></div></div>`;
          html += `<span style="width:50px;text-align:right;color:var(--text-muted);">${Math.round(catHours)}h</span></div>`;
        }
        html += '</div>';

        // Top skills
        const allSkills = [];
        for (const [sid, sd] of Object.entries(data.skills)) {
          const lv = calcLevel(sd.realityXp||0, sd.fantasyXp||0);
          if (lv > 0) allSkills.push({ id: sid, lv, total: (sd.realityXp||0)+(sd.fantasyXp||0) });
        }
        allSkills.sort((a,b) => b.total - a.total);
        if (allSkills.length) {
          html += '<h4 style="margin:0.8rem 0 0.3rem;font-size:0.85rem;">üèÜ Top Skills</h4>';
          for (const s of allSkills.slice(0, 8)) {
            const meta = SKILL_META[s.id] || { name: s.id, icon: '‚ùì' };
            html += `<div style="display:flex;align-items:center;gap:0.4rem;margin:0.15rem 0;font-size:0.8rem;">`;
            html += `${meta.icon} ${meta.name} ‚Äî <span style="color:${LEVEL_COLORS[s.lv]};font-weight:700;">Lv ${s.lv} ${LEVEL_NAMES[s.lv]}</span> (${Math.round(s.total)}h)</div>`;
          }
        }

        // Achievements
        html += '<h4 style="margin:0.8rem 0 0.3rem;font-size:0.85rem;">üèÖ Milestones</h4>';
        let totalR = 0, totalF = 0;
        for (const sd of Object.values(data.skills)) { totalR += sd.realityXp||0; totalF += sd.fantasyXp||0; }
        const milestones = [
          { name: 'First Steps', desc: 'Log your first activity', check: Object.keys(data.skills).length > 0 },
          { name: '100 Reality Hours', desc: 'Accumulate 100h of real-world XP', check: totalR >= 100 },
          { name: 'Verified', desc: 'Get your first peer verification', check: (data.verifications||[]).length > 0 },
          { name: 'Jack of All Trades', desc: 'Skills in 5+ categories', check: new Set(Object.keys(data.skills).map(s => { for (const [c,v] of Object.entries(SKILL_CATEGORIES)) if (v.skills.includes(s)) return c; return null; }).filter(Boolean)).size >= 5 },
          { name: '5 Verified', desc: '5 skills peer-verified', check: new Set((data.verifications||[]).map(v=>v.skill)).size >= 5 },
        ];
        for (const m of milestones) {
          html += `<div style="font-size:0.78rem;margin:0.15rem 0;opacity:${m.check?1:0.4};">${m.check?'‚úÖ':'‚¨ú'} <strong>${m.name}</strong> ‚Äî ${m.desc}</div>`;
        }

        // Radar chart (canvas)
        html += `<h4 style="margin:0.8rem 0 0.3rem;font-size:0.85rem;">üéØ Skill Radar</h4>`;
        html += `<canvas id="sd-radar-${containerId}" width="280" height="280" style="display:block;margin:0 auto;max-width:100%;"></canvas>`;
        setTimeout(() => drawRadar(containerId, data), 50);
        return html;
      }

      function drawRadar(containerId, data) {
        const canvas = document.getElementById('sd-radar-' + containerId);
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const w = canvas.width, h = canvas.height, cx = w/2, cy = h/2, r = Math.min(cx,cy) - 30;
        ctx.clearRect(0,0,w,h);
        const cats = Object.entries(SKILL_CATEGORIES);
        const n = cats.length;
        // Grid
        ctx.strokeStyle = 'rgba(255,255,255,0.1)';
        for (let ring = 1; ring <= 5; ring++) {
          ctx.beginPath();
          for (let i = 0; i <= n; i++) {
            const a = (Math.PI*2*i/n) - Math.PI/2;
            const rr = r * ring/5;
            const x = cx + Math.cos(a)*rr, y = cy + Math.sin(a)*rr;
            i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
          }
          ctx.stroke();
        }
        // Spokes + labels
        ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.font = '9px sans-serif'; ctx.textAlign = 'center';
        for (let i = 0; i < n; i++) {
          const a = (Math.PI*2*i/n) - Math.PI/2;
          ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+Math.cos(a)*r, cy+Math.sin(a)*r); ctx.stroke();
          const lx = cx + Math.cos(a)*(r+18), ly = cy + Math.sin(a)*(r+18);
          ctx.fillText(cats[i][1].icon, lx, ly+3);
        }
        // Data
        const vals = cats.map(([catId, cat]) => {
          let total = 0;
          for (const sid of cat.skills) { const sd = getSkillData(data, sid); total += (sd.realityXp||0)*2 + (sd.fantasyXp||0); }
          return Math.min(1, total / 2000); // normalize
        });
        ctx.fillStyle = 'rgba(0,180,100,0.2)'; ctx.strokeStyle = 'rgba(0,180,100,0.8)'; ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i = 0; i <= n; i++) {
          const idx = i % n;
          const a = (Math.PI*2*idx/n) - Math.PI/2;
          const v = Math.max(0.02, vals[idx]);
          const x = cx + Math.cos(a)*r*v, y = cy + Math.sin(a)*r*v;
          i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
        }
        ctx.fill(); ctx.stroke();
      }

      // ‚îÄ‚îÄ Skill Card (detail view) ‚îÄ‚îÄ
      window._sdOpenSkill = function(containerId, skillId, mode) {
        const data = loadSkills();
        const meta = SKILL_META[skillId];
        if (!meta) return;
        const sd = getSkillData(data, skillId);
        const lv = calcLevel(sd.realityXp||0, sd.fantasyXp||0);
        const prog = xpToNextLevel(sd.realityXp||0, sd.fantasyXp||0);
        const verifs = (data.verifications||[]).filter(v => v.skill === skillId);
        const isFantasy = mode === 'fantasy';
        const accent = isFantasy ? '#9966ff' : 'var(--accent)';

        let html = '<div class="sd-card-overlay" onclick="if(event.target===this)this.remove()">';
        html += '<div class="sd-card">';
        html += `<h3>${meta.icon} ${meta.name} <span style="color:${LEVEL_COLORS[lv]}">Lv ${lv} ${LEVEL_NAMES[lv]}</span></h3>`;
        html += `<p style="font-size:0.78rem;color:var(--text-muted);margin:0 0 0.4rem;">${meta.desc}</p>`;

        // Progress bar
        const progLabel = lv >= 10 ? 'MAX' : `${Math.round(prog.needed - prog.current)}h to Lv ${lv+1}`;
        html += `<div style="display:flex;align-items:center;gap:0.4rem;font-size:0.75rem;color:var(--text-muted);">`;
        html += `<div style="flex:1;height:8px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden;"><div style="height:100%;width:${prog.pct}%;background:${LEVEL_COLORS[lv]};border-radius:4px;"></div></div> ${progLabel}</div>`;

        // XP bars
        html += '<div class="sd-xp-bars">';
        const maxXp = Math.max(sd.realityXp||1, sd.fantasyXp||1, 10);
        html += `<div class="sd-xp-row"><span style="width:70px;">Reality XP:</span> <span>${Math.round(sd.realityXp||0)}h</span> <div class="bar"><div class="bar-fill" style="width:${((sd.realityXp||0)/maxXp)*100}%;background:#4a8;"></div></div></div>`;
        html += `<div class="sd-xp-row"><span style="width:70px;">Fantasy XP:</span> <span>${Math.round(sd.fantasyXp||0)}h</span> <div class="bar"><div class="bar-fill" style="width:${((sd.fantasyXp||0)/maxXp)*100}%;background:#96f;"></div></div></div>`;
        html += '</div>';

        // Subskills
        if (meta.subskills && meta.subskills.length) {
          html += '<div class="sd-subskills"><strong style="font-size:0.8rem;">Subskills:</strong>';
          for (const sub of meta.subskills) {
            const subData = (sd.subskills||{})[sub] || { realityXp:0, fantasyXp:0 };
            const subLv = calcLevel(subData.realityXp, subData.fantasyXp);
            const subProg = xpToNextLevel(subData.realityXp, subData.fantasyXp);
            const subName = sub.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
            html += `<div class="sd-subskill"><span style="width:100px;">${subName}</span>`;
            html += `<div style="flex:1;height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;"><div style="height:100%;width:${subProg.pct}%;background:${LEVEL_COLORS[subLv]};border-radius:3px;"></div></div>`;
            html += `<span style="color:${LEVEL_COLORS[subLv]};font-weight:600;min-width:30px;text-align:right;">Lv ${subLv}</span></div>`;
          }
          html += '</div>';
        }

        // Verifications
        if (verifs.length) {
          html += `<div class="sd-verifications"><strong style="font-size:0.8rem;">Verifications (${verifs.length}):</strong>`;
          for (const v of verifs) {
            html += `<div style="margin:0.15rem 0;">‚úì <strong>${v.from||'Anonymous'}</strong> ‚Äî "${v.note||'Verified'}" <span style="color:var(--text-muted);font-size:0.7rem;">${v.date ? new Date(v.date).toLocaleDateString() : ''}</span></div>`;
          }
          html += '</div>';
        }

        // Recent activity
        const logs = (sd.logs||[]).slice(-5).reverse();
        if (logs.length) {
          html += '<div class="sd-activity"><strong style="font-size:0.8rem;">Recent Activity:</strong>';
          for (const log of logs) {
            const d = log.date ? new Date(log.date).toLocaleDateString() : '?';
            const sub = log.subskill ? ` ${log.subskill.replace(/_/g,' ')}` : '';
            html += `<div style="margin:0.15rem 0;">${d} ‚Äî ${log.hours||0}h${sub} (${log.type||'reality'}) ${log.note?'‚Äî '+log.note:''}</div>`;
          }
          html += '</div>';
        }

        // Actions
        html += '<div class="sd-actions">';
        html += `<button onclick="window._sdLogActivity('${containerId}','${mode}','${Object.entries(SKILL_CATEGORIES).find(([c,v])=>v.skills.includes(skillId))?.[0]||'crafting'}','${skillId}');this.closest('.sd-card-overlay').remove()">+ Log Hours</button>`;
        html += `<button onclick="window._sdRequestVerify('${skillId}');this.closest('.sd-card-overlay').remove()">Request Verify</button>`;
        html += '</div>';
        html += '</div></div>';
        document.body.insertAdjacentHTML('beforeend', html);
      };

      // ‚îÄ‚îÄ Category selection ‚îÄ‚îÄ
      window._sdSelectCat = function(containerId, catId, mode) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container._sdState = { category: catId, view: 'grid' };
        renderSkillDNA(containerId, mode);
      };

      window._sdShowOverview = function(containerId, mode) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container._sdState = container._sdState || {};
        container._sdState.view = 'overview';
        renderSkillDNA(containerId, mode);
      };

      // ‚îÄ‚îÄ Log Activity Modal ‚îÄ‚îÄ
      window._sdLogActivity = function(containerId, mode, defaultCat, defaultSkill) {
        const isFantasy = mode === 'fantasy';
        let html = '<div class="sd-log-overlay" onclick="if(event.target===this)this.remove()">';
        html += '<div class="sd-log-modal">';
        html += '<h3>+ Log Activity</h3>';
        html += '<div class="sd-type-toggle">';
        html += `<label><input type="radio" name="sd-log-type" value="reality" ${!isFantasy?'checked':''}> Reality</label>`;
        html += `<label><input type="radio" name="sd-log-type" value="fantasy" ${isFantasy?'checked':''}> Fantasy</label>`;
        html += '</div>';
        html += '<label>Category</label><select id="sd-log-cat" onchange="window._sdLogCatChange()">';
        for (const [catId, cat] of Object.entries(SKILL_CATEGORIES)) {
          html += `<option value="${catId}" ${catId===defaultCat?'selected':''}>${cat.icon} ${cat.name}</option>`;
        }
        html += '</select>';
        html += '<label>Skill</label><select id="sd-log-skill" onchange="window._sdLogSkillChange()"></select>';
        html += '<label>Subskill (optional)</label><select id="sd-log-sub"><option value="">‚Äî None ‚Äî</option></select>';
        html += '<label>Hours</label><input type="number" id="sd-log-hours" min="0.25" step="0.25" value="1">';
        html += '<label>Notes</label><textarea id="sd-log-notes" rows="2" placeholder="What did you do?"></textarea>';
        html += `<label>Date</label><input type="date" id="sd-log-date" value="${new Date().toISOString().slice(0,10)}">`;
        html += '<div class="sd-log-actions">';
        html += `<button style="background:var(--bg-input);border:1px solid var(--border);color:var(--text);" onclick="this.closest('.sd-log-overlay').remove()">Cancel</button>`;
        html += `<button style="background:${isFantasy?'#9966ff':'var(--accent)'};color:#fff;" onclick="window._sdSubmitLog('${containerId}','${mode}')">Log Activity</button>`;
        html += '</div></div></div>';
        document.body.insertAdjacentHTML('beforeend', html);
        // Populate skill dropdown
        window._sdLogCatChange(defaultSkill);
      };

      window._sdLogCatChange = function(defaultSkill) {
        const catId = document.getElementById('sd-log-cat').value;
        const cat = SKILL_CATEGORIES[catId];
        const sel = document.getElementById('sd-log-skill');
        sel.innerHTML = '';
        for (const sid of cat.skills) {
          const meta = SKILL_META[sid];
          if (!meta) continue;
          sel.innerHTML += `<option value="${sid}" ${sid===defaultSkill?'selected':''}>${meta.icon} ${meta.name}</option>`;
        }
        window._sdLogSkillChange();
      };

      window._sdLogSkillChange = function() {
        const skillId = document.getElementById('sd-log-skill').value;
        const meta = SKILL_META[skillId];
        const sel = document.getElementById('sd-log-sub');
        sel.innerHTML = '<option value="">‚Äî None ‚Äî</option>';
        if (meta && meta.subskills) {
          for (const sub of meta.subskills) {
            sel.innerHTML += `<option value="${sub}">${sub.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase())}</option>`;
          }
        }
      };

      window._sdSubmitLog = function(containerId, mode) {
        const type = document.querySelector('input[name="sd-log-type"]:checked')?.value || 'reality';
        const skillId = document.getElementById('sd-log-skill').value;
        const subskill = document.getElementById('sd-log-sub').value;
        const hours = parseFloat(document.getElementById('sd-log-hours').value) || 0;
        const notes = document.getElementById('sd-log-notes').value;
        const date = document.getElementById('sd-log-date').value;
        if (!skillId || hours <= 0) return;

        const data = loadSkills();
        if (!data.skills[skillId]) data.skills[skillId] = { realityXp: 0, fantasyXp: 0, logs: [], subskills: {} };
        const sd = data.skills[skillId];

        if (type === 'reality') sd.realityXp = (sd.realityXp||0) + hours;
        else sd.fantasyXp = (sd.fantasyXp||0) + hours;

        if (subskill) {
          if (!sd.subskills) sd.subskills = {};
          if (!sd.subskills[subskill]) sd.subskills[subskill] = { realityXp: 0, fantasyXp: 0 };
          if (type === 'reality') sd.subskills[subskill].realityXp += hours;
          else sd.subskills[subskill].fantasyXp += hours;
        }

        if (!sd.logs) sd.logs = [];
        sd.logs.push({ date: date || new Date().toISOString(), type, hours, note: notes, subskill: subskill || null });

        saveSkills(data);
        document.querySelector('.sd-log-overlay')?.remove();
        renderSkillDNA(containerId, mode);

        // Broadcast skill update to relay if connected
        _sdBroadcastUpdate(skillId, sd);
      };

      function _sdBroadcastUpdate(skillId, sd) {
        // If we have a WebSocket connection, send skill update
        if (window._humanityWs && window._humanityWs.readyState === 1) {
          const lv = calcLevel(sd.realityXp||0, sd.fantasyXp||0);
          try {
            window._humanityWs.send(JSON.stringify({
              type: 'skill_update',
              skill_id: skillId,
              reality_xp: sd.realityXp||0,
              fantasy_xp: sd.fantasyXp||0,
              level: lv
            }));
          } catch(e) { /* silent */ }
        }
      }

      // ‚îÄ‚îÄ Request Verification ‚îÄ‚îÄ
      window._sdRequestVerify = function(skillId) {
        const meta = SKILL_META[skillId];
        if (!meta) return;
        const data = loadSkills();
        const sd = getSkillData(data, skillId);
        const lv = calcLevel(sd.realityXp||0, sd.fantasyXp||0);
        // Simple prompt-based verification request for now
        const who = prompt(`Request verification for ${meta.name} (Lv ${lv}).\n\nEnter the username of someone who can verify your skill:`);
        if (!who || !who.trim()) return;
        // Send via WS if connected
        if (window._humanityWs && window._humanityWs.readyState === 1) {
          try {
            window._humanityWs.send(JSON.stringify({
              type: 'skill_verify_request',
              skill_id: skillId,
              level: lv,
              to_name: who.trim()
            }));
            alert('Verification request sent to ' + who.trim() + '!');
          } catch(e) { alert('Could not send request. Are you connected?'); }
        } else {
          alert('Not connected to relay. Connect first to send verification requests.');
        }
      };

      // Handle incoming verification responses
      window._sdHandleVerifyResponse = function(msg) {
        if (msg.type === 'skill_verify_response' && msg.approved) {
          const data = loadSkills();
          if (!data.verifications) data.verifications = [];
          data.verifications.push({
            skill: msg.skill_id,
            from: msg.from_name || msg.from_key || 'Unknown',
            date: Date.now(),
            note: msg.note || 'Verified'
          });
          saveSkills(data);
          // Re-render if visible
          renderSkillDNA('skill-dna-reality', 'reality');
          renderSkillDNA('skill-dna-fantasy', 'fantasy');
        }
      };

      // ‚îÄ‚îÄ Find People ‚îÄ‚îÄ
      window._sdFindPeople = async function() {
        let html = '<div class="sd-find-overlay" onclick="if(event.target===this)this.remove()">';
        html += '<div class="sd-find-modal">';
        html += '<h3>üë• Find People by Skill</h3>';
        html += '<div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;">';
        html += '<select id="sd-find-skill" style="flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.35rem;border-radius:6px;font-size:0.82rem;">';
        for (const [catId, cat] of Object.entries(SKILL_CATEGORIES)) {
          html += `<optgroup label="${cat.icon} ${cat.name}">`;
          for (const sid of cat.skills) {
            const meta = SKILL_META[sid];
            if (meta) html += `<option value="${sid}">${meta.name}</option>`;
          }
          html += '</optgroup>';
        }
        html += '</select>';
        html += '<select id="sd-find-level" style="width:80px;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.35rem;border-radius:6px;font-size:0.82rem;">';
        for (let i = 1; i <= 10; i++) html += `<option value="${i}">Lv ${i}+</option>`;
        html += '</select>';
        html += `<button onclick="window._sdDoSearch()" style="background:var(--accent);color:#fff;border:none;padding:0.35rem 0.7rem;border-radius:6px;font-size:0.82rem;cursor:pointer;font-weight:600;">Search</button>`;
        html += '</div>';
        html += '<div id="sd-find-results" style="font-size:0.82rem;color:var(--text-muted);">Select a skill and minimum level, then search.</div>';
        html += '</div></div>';
        document.body.insertAdjacentHTML('beforeend', html);
      };

      window._sdDoSearch = async function() {
        const skill = document.getElementById('sd-find-skill').value;
        const minLevel = document.getElementById('sd-find-level').value;
        const resultsDiv = document.getElementById('sd-find-results');
        resultsDiv.innerHTML = 'Searching...';
        try {
          const res = await fetch(`/api/skills/search?skill=${skill}&min_level=${minLevel}`);
          if (!res.ok) throw new Error('Search failed');
          const users = await res.json();
          if (!users.length) { resultsDiv.innerHTML = 'No users found with that skill level.'; return; }
          let rHtml = '';
          for (const u of users) {
            const meta = SKILL_META[skill];
            rHtml += `<div class="sd-find-result">`;
            rHtml += `<div><strong>${u.display_name || u.public_key.slice(0,8)+'...'}</strong>`;
            rHtml += `<div class="sd-fr-skills">${meta?meta.icon:''} ${meta?meta.name:skill} ‚Äî <span style="color:${LEVEL_COLORS[u.level]||'#aaa'};font-weight:700;">Lv ${u.level} ${LEVEL_NAMES[u.level]||''}</span> (${Math.round(u.reality_xp||0)}h reality, ${Math.round(u.fantasy_xp||0)}h fantasy)</div>`;
            rHtml += `</div></div>`;
          }
          resultsDiv.innerHTML = rHtml;
        } catch(e) {
          resultsDiv.innerHTML = 'Search unavailable. Make sure you\'re connected to a relay.';
        }
      };

      // ‚îÄ‚îÄ Initialize both panels ‚îÄ‚îÄ
      function initSkillDNA() {
        renderSkillDNA('skill-dna-reality', 'reality');
        renderSkillDNA('skill-dna-fantasy', 'fantasy');
      }

      // Hook into tab switching to init when visible
      const origSwitchTabSD = switchTab;
      switchTab = function(tabId, pushState) {
        origSwitchTabSD(tabId, pushState);
        if (tabId === 'reality' || tabId === 'fantasy') initSkillDNA();
      };

      // Init on load if starting on reality/fantasy
      if (typeof initialTab !== 'undefined' && (initialTab === 'reality' || initialTab === 'fantasy')) {
        initSkillDNA();
      }
      // Also init after short delay for default tab
      setTimeout(initSkillDNA, 500);
    })();

    // ‚îÄ‚îÄ Browse/Dashboard tab activation ‚îÄ‚îÄ
    {
      const origSwitchTab3 = switchTab;
      switchTab = function(tabId, pushState) {
        origSwitchTab3(tabId, pushState);
        if (tabId === 'browse') initBrowseTab();
        if (tabId === 'dashboard') renderDashboard();
      };
      if (initialTab === 'browse') initBrowseTab();
      if (initialTab === 'dashboard') renderDashboard();
    }

    // ‚îÄ‚îÄ Mobile responsive for browse/dashboard ‚îÄ‚îÄ
    (function() {
      const style = document.createElement('style');
      style.textContent = '@media (max-width: 768px) { #tab-browse > div:nth-child(2) { flex-direction: column !important; } #browse-directory { width: 100% !important; min-width: auto !important; max-height: 40vh; border-right: none !important; border-bottom: 1px solid var(--border); } #dashboard-grid { grid-template-columns: 1fr !important; } .dashboard-widget { grid-column: span 1 !important; } }';
      document.head.appendChild(style);
    })();

    // ‚îÄ‚îÄ Auto-refresh on server update ‚îÄ‚îÄ
    (function() {
      let knownVersion = null;
      async function checkVersion() {
        try {
          const res = await fetch('/api/stats');
          if (!res.ok) return;
          const data = await res.json();
          if (!data.version) return;
          if (knownVersion === null) {
            knownVersion = data.version;
          } else if (knownVersion !== data.version) {
            console.log('Server updated (' + knownVersion + ' ‚Üí ' + data.version + '), reloading‚Ä¶');
            location.reload();
          }
        } catch (e) { /* network hiccup, try again next cycle */ }
      }
      checkVersion();
      setInterval(checkVersion, 30000);
    })();
  </script>
</body>
</html>
