<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Humanity</title>
  <link rel="manifest" href="/shared/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Humanity">
  <link rel="apple-touch-icon" href="/shared/icons/icon-192.png">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%231a1a2e'/%3E%3Ctext x='32' y='46' font-family='Arial,Helvetica,sans-serif' font-weight='bold' font-size='42' fill='%23FF8811' text-anchor='middle'%3EH%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="/shared/theme.css">
  <style>
    :root {
      --bg-panel: #141414;
      --border: #2a2a2a;
      --success: #4a8;
      --error: #e55;
      --warning: #eb4;

      /* Button state colors */
      --btn-clickable: #44cc66;
      --btn-hover: #4488ff;
      --btn-activated: #ee3333;
      --btn-disabled: #222222;
      --btn-cooldown: #8844cc;
    }

    body {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â”€â”€ Tab Content â”€â”€ */
    .tab-content {
      flex: 1;
      display: none;
      padding: 1.5rem;
      padding-bottom: 80px;
      overflow-y: auto;
    }
    .tab-content.active { display: block; }

    .panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .panel h2 {
      font-size: 1.1rem;
      color: var(--accent);
      margin-bottom: 0.8rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.4rem;
    }

    .panel h3 {
      font-size: 0.9rem;
      color: var(--text);
      margin: 1rem 0 0.5rem;
    }

    .panel p {
      font-size: 0.85rem;
      color: var(--text-muted);
      line-height: 1.6;
      margin-bottom: 0.5rem;
    }

    .placeholder-text {
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.9rem;
      text-align: center;
      padding: 2rem 1rem;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }

    .card-grid .panel {
      transition: border-color 0.2s;
    }
    .card-grid .panel:hover {
      border-color: rgba(255, 136, 17, 0.3);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BUTTON DESIGN SYSTEM
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 120px;
      min-height: 44px;
      padding: 0.5rem 1.2rem;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      background: var(--bg-panel);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: box-shadow 0.15s ease;
      position: relative;
      user-select: none;
      font-family: inherit;
      box-shadow: inset 0 0 0 1px var(--btn-clickable);
    }

    .btn.btn-clickable,
    .btn:not(.btn-disabled):not(.btn-cooldown):not(.btn-channeling):not(.btn-activated) {
      box-shadow: inset 0 0 0 1px var(--btn-clickable);
    }

    .btn:not(.btn-disabled):not(.btn-cooldown):not(.btn-activated):hover {
      box-shadow: inset 0 0 0 3px var(--btn-hover), 0 0 12px rgba(68, 136, 255, 0.4) !important;
      animation: none;
    }

    .btn.btn-activated {
      box-shadow: inset 0 0 0 5px var(--btn-activated), 0 0 12px rgba(238, 51, 51, 0.4) !important;
      animation: none;
    }

    .btn.btn-channeling {
      animation: rainbow-shadow 3s linear infinite;
    }

    @keyframes rainbow-shadow {
      0%   { box-shadow: inset 0 0 0 1px #ff0000, 0 0 8px rgba(255,0,0,0.3); }
      16%  { box-shadow: inset 0 0 0 1px #ff8800, 0 0 8px rgba(255,136,0,0.3); }
      33%  { box-shadow: inset 0 0 0 1px #ffff00, 0 0 8px rgba(255,255,0,0.3); }
      50%  { box-shadow: inset 0 0 0 1px #00ff44, 0 0 8px rgba(0,255,68,0.3); }
      66%  { box-shadow: inset 0 0 0 1px #0088ff, 0 0 8px rgba(0,136,255,0.3); }
      83%  { box-shadow: inset 0 0 0 1px #8800ff, 0 0 8px rgba(136,0,255,0.3); }
      100% { box-shadow: inset 0 0 0 1px #ff0000, 0 0 8px rgba(255,0,0,0.3); }
    }

    .btn.btn-disabled {
      box-shadow: inset 0 0 0 2px var(--btn-disabled);
      color: var(--text-muted);
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn.btn-disabled:hover {
      box-shadow: inset 0 0 0 2px var(--btn-disabled) !important;
    }

    .btn.btn-cooldown {
      box-shadow: inset 0 0 0 7px var(--btn-cooldown);
      cursor: wait;
      color: var(--text-muted);
    }
    .btn.btn-cooldown:hover {
      box-shadow: inset 0 0 0 7px var(--btn-cooldown) !important;
    }

    .btn-cooldown-timer {
      position: absolute;
      font-size: 0.6rem;
      font-weight: 700;
      color: var(--btn-cooldown);
      background: var(--bg-panel);
      padding: 0 0.3rem;
      letter-spacing: 0.05em;
    }
    .btn-cooldown-timer.top {
      top: -2px;
      left: 50%;
      transform: translateX(-50%);
    }
    .btn-cooldown-timer.bottom {
      bottom: -2px;
      left: 50%;
      transform: translateX(-50%);
    }

    .btn-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1.2rem;
      margin: 0.5rem 0;
      align-items: center;
    }

    .btn-demo {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.4rem;
    }

    .btn-demo .btn-label {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    /* â”€â”€ Settings Panel (inline) â”€â”€ */
    #tab-settings .panel { max-width: 600px; }

    /* â”€â”€ Debug info items â”€â”€ */
    .debug-info {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 0.3rem 1rem;
      font-size: 0.82rem;
      margin: 0.5rem 0;
    }
    .debug-info dt {
      color: var(--text-muted);
      font-weight: 600;
    }
    .debug-info dd {
      color: var(--text);
      font-family: monospace;
      font-size: 0.78rem;
    }

    /* â”€â”€ Reality Cards â”€â”€ */
    .reality-card-header {
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .reality-card-header .collapse-icon {
      font-size: 0.7rem;
      color: var(--text-muted);
      transition: transform 0.2s;
    }
    .reality-card.collapsed .reality-card-body { display: none; }
    .reality-card.collapsed .collapse-icon { transform: rotate(-90deg); }

    /* Todo */
    .todo-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.4rem;
      border-radius: 4px;
      font-size: 0.85rem;
    }
    .todo-item:hover { background: var(--bg-hover); }
    .todo-item.completed { opacity: 0.5; }
    .todo-item.completed .todo-text { text-decoration: line-through; }
    .todo-item input[type="checkbox"] { accent-color: var(--accent); cursor: pointer; }
    .todo-text { flex: 1; color: var(--text); }
    .todo-delete {
      background: none; border: none; color: var(--text-muted); cursor: pointer;
      font-size: 0.75rem; padding: 0.1rem 0.3rem; border-radius: 3px; opacity: 0;
    }
    .todo-item:hover .todo-delete { opacity: 1; }
    .todo-delete:hover { color: var(--danger, #c44); }

    /* Notes */
    .note-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.5rem;
      border-radius: 4px;
      font-size: 0.82rem;
      cursor: pointer;
      color: var(--text-muted);
    }
    .note-item:hover { background: var(--bg-hover); color: var(--text); }
    .note-item.active { background: var(--accent-dim); color: var(--accent); font-weight: 600; }
    .note-delete {
      background: none; border: none; color: var(--text-muted); cursor: pointer;
      font-size: 0.7rem; padding: 0.1rem 0.3rem; opacity: 0; margin-left: auto;
    }
    .note-item:hover .note-delete { opacity: 1; }
    .note-delete:hover { color: var(--danger, #c44); }

    /* Garden */
    #garden-grid {
      display: grid;
      gap: 4px;
    }
    .garden-plot {
      aspect-ratio: 1;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: var(--text-muted);
      cursor: pointer;
      text-align: center;
      padding: 2px;
      word-break: break-word;
      transition: border-color 0.15s;
    }
    .garden-plot:hover { border-color: var(--accent); }
    .garden-plot.planted {
      background: rgba(68,170,68,0.1);
      border-color: rgba(68,170,68,0.3);
      color: var(--text);
      font-weight: 600;
    }

    /* â”€â”€ Catalog System â”€â”€ */
    .catalog-search-bar {
      display: flex; gap: 0.5rem; margin-bottom: 1.2rem; position: sticky; top: 0; z-index: 10;
      background: var(--bg, #0a0a0a); padding: 0.5rem 0;
    }
    .catalog-search-bar input {
      flex: 1; background: var(--bg-input); border: 1px solid var(--border); color: var(--text);
      padding: 0.6rem 1rem; border-radius: 8px; font-size: 0.9rem; outline: none; font-family: inherit;
    }
    .catalog-search-bar input:focus { border-color: var(--accent); }
    .catalog-search-results {
      background: var(--bg-card, #1a1a1a); border: 1px solid var(--border); border-radius: 8px;
      margin-bottom: 1rem; max-height: 300px; overflow-y: auto;
    }
    .catalog-search-results:empty { display: none; }
    .catalog-result-item {
      display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem 0.8rem;
      cursor: pointer; font-size: 0.82rem; border-bottom: 1px solid var(--border);
    }
    .catalog-result-item:last-child { border-bottom: none; }
    .catalog-result-item:hover { background: var(--bg-hover, rgba(255,255,255,0.03)); }
    .catalog-result-badge {
      font-size: 0.6rem; font-weight: 700; padding: 0.1rem 0.4rem; border-radius: 3px;
      text-transform: uppercase; flex-shrink: 0;
    }

    /* Reference Sources Grid */
    .ref-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem; }
    .ref-card {
      display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.7rem;
      background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px;
      text-decoration: none; color: var(--text); font-size: 0.78rem; transition: border-color 0.15s;
    }
    .ref-card:hover { border-color: var(--accent); }
    .ref-card .ref-icon { font-size: 1.1rem; flex-shrink: 0; }
    .ref-card .ref-name { font-weight: 600; color: var(--text); }
    .ref-card .ref-desc { font-size: 0.7rem; color: var(--text-muted); }

    /* Element Cards */
    .element-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 0.4rem; }
    .element-card {
      background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px;
      padding: 0.4rem; text-align: center; cursor: pointer; transition: border-color 0.15s, transform 0.1s;
      position: relative;
    }
    .element-card:hover { transform: scale(1.05); z-index: 1; }
    .element-card .el-number { font-size: 0.6rem; color: var(--text-muted); position: absolute; top: 3px; left: 5px; }
    .element-card .el-symbol { font-size: 1.3rem; font-weight: 700; margin: 0.1rem 0; }
    .element-card .el-name { font-size: 0.6rem; color: var(--text-muted); }
    .element-card .el-mass { font-size: 0.55rem; color: var(--text-muted); opacity: 0.6; }
    .el-cat-nonmetal { border-color: rgba(76,175,80,0.4); } .el-cat-nonmetal .el-symbol { color: #4caf50; }
    .el-cat-metal { border-color: rgba(66,165,245,0.4); } .el-cat-metal .el-symbol { color: #42a5f5; }
    .el-cat-metalloid { border-color: rgba(255,167,38,0.4); } .el-cat-metalloid .el-symbol { color: #ffa726; }
    .el-cat-noble-gas { border-color: rgba(171,71,188,0.4); } .el-cat-noble-gas .el-symbol { color: #ab47bc; }
    .el-cat-transition-metal { border-color: rgba(66,165,245,0.4); } .el-cat-transition-metal .el-symbol { color: #42a5f5; }
    .el-cat-actinide { border-color: rgba(239,83,80,0.4); } .el-cat-actinide .el-symbol { color: #ef5350; }

    /* Element Detail */
    .element-detail {
      background: var(--bg-card, #1a1a1a); border: 1px solid var(--border); border-radius: 10px;
      padding: 1.2rem; margin-bottom: 1rem; animation: fadeIn 0.15s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: none; } }
    .element-detail h3 { margin: 0 0 0.6rem; font-size: 1.1rem; }
    .element-detail .el-props { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.4rem; margin: 0.6rem 0; }
    .element-detail .el-prop { background: var(--bg-input); border-radius: 4px; padding: 0.3rem 0.5rem; font-size: 0.78rem; }
    .element-detail .el-prop dt { color: var(--text-muted); font-size: 0.65rem; text-transform: uppercase; }
    .element-detail .el-prop dd { color: var(--text); font-weight: 600; margin: 0; }

    /* Materials */
    .material-card {
      background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px;
      padding: 0.7rem; cursor: pointer; transition: border-color 0.15s;
    }
    .material-card:hover { border-color: var(--accent); }
    .material-type-badge {
      display: inline-block; font-size: 0.6rem; font-weight: 700; padding: 0.1rem 0.4rem;
      border-radius: 3px; text-transform: uppercase;
    }
    .mat-raw { background: rgba(139,195,74,0.2); color: #8bc34a; }
    .mat-processed { background: rgba(66,165,245,0.2); color: #42a5f5; }
    .mat-composite { background: rgba(255,167,38,0.2); color: #ffa726; }
    .processing-chain {
      display: flex; align-items: center; gap: 0.3rem; flex-wrap: wrap;
      font-size: 0.75rem; color: var(--text-muted); margin-top: 0.4rem;
    }
    .processing-chain .chain-arrow { color: var(--accent); font-weight: 700; }

    /* Inventory */
    .inv-privacy-banner {
      background: rgba(76,175,80,0.1); border: 1px solid rgba(76,175,80,0.3); border-radius: 8px;
      padding: 0.5rem 0.8rem; font-size: 0.78rem; color: #4caf50; text-align: center; margin-bottom: 0.8rem;
    }
    .inv-toolbar { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 0.8rem; align-items: center; }
    .inv-toolbar select, .inv-toolbar input {
      background: var(--bg-input); border: 1px solid var(--border); color: var(--text);
      padding: 0.35rem 0.6rem; border-radius: 6px; font-size: 0.8rem; font-family: inherit; outline: none;
    }
    .inv-item {
      background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px;
      padding: 0.6rem; transition: border-color 0.15s;
    }
    .inv-item:hover { border-color: var(--accent); }

    /* Modal */
    .catalog-modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;
    }
    .catalog-modal-overlay.open { display: flex; }
    .catalog-modal {
      background: var(--bg-card, #1a1a1a); border: 1px solid var(--border); border-radius: 12px;
      padding: 1.5rem; max-width: 550px; width: 92%; max-height: 85vh; overflow-y: auto; position: relative;
    }
    .catalog-modal .modal-close {
      position: absolute; top: 0.5rem; right: 0.8rem; background: none; border: none;
      color: var(--text-muted); font-size: 1.3rem; cursor: pointer;
    }
    .catalog-modal label { font-size: 0.75rem; color: var(--text-muted); display: block; margin: 0.4rem 0 0.15rem; }
    .catalog-modal input, .catalog-modal select, .catalog-modal textarea {
      width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text);
      padding: 0.4rem 0.6rem; border-radius: 6px; font-size: 0.82rem; outline: none; font-family: inherit;
      box-sizing: border-box;
    }
    .catalog-modal textarea { resize: vertical; }
    .catalog-modal .modal-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .catalog-modal .modal-actions button {
      flex: 1; padding: 0.5rem; border: none; border-radius: 6px; font-size: 0.85rem;
      font-weight: 600; cursor: pointer; font-family: inherit;
    }

    .filter-pills { display: flex; gap: 0.3rem; flex-wrap: wrap; margin-bottom: 0.6rem; }
    .filter-pill {
      background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted);
      padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.72rem; cursor: pointer; transition: all 0.15s;
    }
    .filter-pill.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .filter-pill:hover { border-color: var(--accent); }

    /* â”€â”€ Mobile â”€â”€ */
    @media (max-width: 600px) {
      .tab-content {
        padding: 1rem;
      }
      .card-grid {
        grid-template-columns: 1fr;
      }
      .element-grid { grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); }
      .ref-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <script src="/shared/shell.js"></script>
  <script src="/shared/settings.js"></script>
  <script>
    document.querySelectorAll('.hub-nav .tab[href^="/board"]').forEach(el => el.setAttribute('data-tab', 'board'));
    document.querySelectorAll('.hub-nav .tab[href^="/reality"]').forEach(el => el.setAttribute('data-tab', 'reality'));
    document.querySelectorAll('.hub-nav .tab[href^="/fantasy"]').forEach(el => el.setAttribute('data-tab', 'fantasy'));
    document.querySelectorAll('.hub-nav .tab[href^="/streams"]').forEach(el => el.setAttribute('data-tab', 'streams'));
    document.querySelectorAll('.hub-nav .tab[href^="/info"]').forEach(el => el.setAttribute('data-tab', 'info'));
    document.querySelectorAll('.hub-nav .tab[href^="/market"]').forEach(el => el.setAttribute('data-tab', 'market'));
    document.querySelectorAll('.hub-nav .tab[href^="/debug"]').forEach(el => el.setAttribute('data-tab', 'debug'));
  </script>

  <!-- Board Tab -->
  <div id="tab-board" class="tab-content" style="padding:1rem;overflow-y:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
      <h2 style="color:var(--accent);margin:0;font-size:1.1rem;">ğŸ“‹ Project Board</h2>
      <button class="btn btn-clickable" id="board-create-btn" style="display:none;min-width:auto;min-height:36px;padding:0.3rem 0.8rem;font-size:0.8rem;" onclick="showCreateTaskModal()">+ New Task</button>
    </div>
    <div id="board-columns" style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.8rem;min-height:300px;">
      <div class="board-column" data-status="backlog">
        <div class="board-col-header" style="font-size:0.85rem;font-weight:700;color:var(--text-muted);padding:0.4rem 0.5rem;border-bottom:2px solid #555;margin-bottom:0.5rem;">ğŸ“¥ Backlog <span class="board-col-count" data-status="backlog">0</span></div>
        <div class="board-col-cards" data-status="backlog"></div>
      </div>
      <div class="board-column" data-status="in_progress">
        <div class="board-col-header" style="font-size:0.85rem;font-weight:700;color:#4488ff;padding:0.4rem 0.5rem;border-bottom:2px solid #4488ff;margin-bottom:0.5rem;">ğŸ”§ In Progress <span class="board-col-count" data-status="in_progress">0</span></div>
        <div class="board-col-cards" data-status="in_progress"></div>
      </div>
      <div class="board-column" data-status="testing">
        <div class="board-col-header" style="font-size:0.85rem;font-weight:700;color:#eb4;padding:0.4rem 0.5rem;border-bottom:2px solid #eb4;margin-bottom:0.5rem;">ğŸ§ª Testing <span class="board-col-count" data-status="testing">0</span></div>
        <div class="board-col-cards" data-status="testing"></div>
      </div>
      <div class="board-column" data-status="done">
        <div class="board-col-header" style="font-size:0.85rem;font-weight:700;color:#4a8;padding:0.4rem 0.5rem;border-bottom:2px solid #4a8;margin-bottom:0.5rem;">âœ… Done <span class="board-col-count" data-status="done">0</span></div>
        <div class="board-col-cards" data-status="done"></div>
      </div>
    </div>
    <div id="board-loading" style="text-align:center;color:var(--text-muted);padding:2rem;font-size:0.85rem;">Loading tasksâ€¦</div>

    <!-- Task Modal -->
    <div id="task-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;display:none;align-items:center;justify-content:center;">
      <div style="background:var(--bg-card,#1a1a1a);border:1px solid var(--border);border-radius:12px;padding:1.5rem;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;position:relative;">
        <button onclick="closeTaskModal()" style="position:absolute;top:0.8rem;right:0.8rem;background:none;border:none;color:var(--text-muted);font-size:1.2rem;cursor:pointer;">âœ•</button>
        <div id="task-modal-content"></div>
      </div>
    </div>
  </div>

  <!-- Reality Tab -->
  <div id="tab-reality" class="tab-content">
    <!-- Universal Search -->
    <div class="catalog-search-bar">
      <input type="text" id="universal-search" placeholder="ğŸ” Search elements, materials, inventoryâ€¦" oninput="universalSearch(this.value)">
    </div>
    <div class="catalog-search-results" id="universal-search-results"></div>

    <div class="panel" style="margin-bottom:1rem;">
      <h2>ğŸŸ¢ Reality</h2>
      <p>Your real-world dashboard. Knowledge base, catalogs, and personal tools â€” all local-first.</p>
    </div>

    <!-- â”€â”€ Todo List â”€â”€ -->
    <div class="panel reality-card" id="reality-todo">
      <h2 class="reality-card-header" onclick="toggleRealityCard('todo')">âœ… Todo List <span class="collapse-icon" id="todo-collapse">â–¼</span></h2>
      <div class="reality-card-body" id="todo-body">
        <div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;">
          <input type="text" id="todo-input" placeholder="Add a taskâ€¦" style="flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;" onkeydown="if(event.key==='Enter')addTodo()">
          <button onclick="addTodo()" style="background:var(--accent);color:#fff;border:none;padding:0.4rem 0.8rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;">Add</button>
        </div>
        <div id="todo-list"></div>
      </div>
    </div>

    <!-- â”€â”€ Notes â”€â”€ -->
    <div class="panel reality-card" id="reality-notes">
      <h2 class="reality-card-header" onclick="toggleRealityCard('notes')">ğŸ“ Notes <span class="collapse-icon" id="notes-collapse">â–¼</span></h2>
      <div class="reality-card-body" id="notes-body">
        <div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;">
          <button onclick="addNote()" style="background:var(--accent);color:#fff;border:none;padding:0.4rem 0.8rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;">+ New Note</button>
        </div>
        <div id="notes-list" style="margin-bottom:0.6rem;"></div>
        <div id="notes-editor" style="display:none;">
          <input type="text" id="note-title" placeholder="Note title" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:0.4rem;" oninput="saveCurrentNote()">
          <textarea id="note-content" placeholder="Write your noteâ€¦" rows="8" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.5rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;resize:vertical;line-height:1.5;" oninput="saveCurrentNote()"></textarea>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Garden Tracker â”€â”€ -->
    <div class="panel reality-card" id="reality-garden">
      <h2 class="reality-card-header" onclick="toggleRealityCard('garden')">ğŸŒ± Garden Tracker <span class="collapse-icon" id="garden-collapse">â–¼</span></h2>
      <div class="reality-card-body" id="garden-body">
        <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.6rem;">Click a plot to set what's planted. Your garden, your data.</p>
        <div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;align-items:center;">
          <label style="font-size:0.8rem;color:var(--text-muted);">Grid:</label>
          <select id="garden-size" onchange="resizeGarden()" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.3rem 0.5rem;border-radius:4px;font-size:0.8rem;">
            <option value="3">3Ã—3</option>
            <option value="4" selected>4Ã—4</option>
            <option value="5">5Ã—5</option>
            <option value="6">6Ã—6</option>
          </select>
        </div>
        <div id="garden-grid"></div>
      </div>
    </div>

    <!-- â”€â”€ Reference Sources â”€â”€ -->
    <div class="panel reality-card" id="reality-references">
      <h2 class="reality-card-header" onclick="toggleRealityCard('references')">ğŸ“š Reference Sources <span class="collapse-icon" id="references-collapse">â–¼</span></h2>
      <div class="reality-card-body" id="references-body">
        <div class="ref-grid" id="ref-sources-grid"></div>
      </div>
    </div>

    <!-- â”€â”€ Element Catalog â”€â”€ -->
    <div class="panel reality-card" id="reality-elements">
      <h2 class="reality-card-header" onclick="toggleRealityCard('elements')">ğŸ§ª Element Catalog <span class="collapse-icon" id="elements-collapse">â–¼</span></h2>
      <div class="reality-card-body" id="elements-body">
        <div style="display:flex;gap:0.4rem;margin-bottom:0.6rem;flex-wrap:wrap;align-items:center;">
          <input type="text" id="element-filter" placeholder="Filter elementsâ€¦" oninput="renderElements()" style="flex:1;min-width:140px;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.35rem 0.6rem;border-radius:6px;font-size:0.8rem;outline:none;font-family:inherit;">
        </div>
        <div class="filter-pills" id="element-cat-pills"></div>
        <div id="element-detail-slot"></div>
        <div class="element-grid" id="element-grid"></div>
      </div>
    </div>

    <!-- â”€â”€ Materials Catalog â”€â”€ -->
    <div class="panel reality-card" id="reality-materials">
      <h2 class="reality-card-header" onclick="toggleRealityCard('materials')">ğŸ—ï¸ Materials Catalog <span class="collapse-icon" id="materials-collapse">â–¼</span></h2>
      <div class="reality-card-body" id="materials-body">
        <div class="filter-pills" id="material-type-pills"></div>
        <div id="material-detail-slot"></div>
        <div id="materials-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:0.5rem;"></div>
      </div>
    </div>

    <!-- â”€â”€ Personal Inventory â”€â”€ -->
    <div class="panel reality-card" id="reality-inventory">
      <h2 class="reality-card-header" onclick="toggleRealityCard('inventory')">ğŸ“¦ Personal Inventory <span class="collapse-icon" id="inventory-collapse">â–¼</span></h2>
      <div class="reality-card-body" id="inventory-body">
        <div class="inv-privacy-banner">ğŸ”’ Private â€” stored only on this device, never uploaded</div>
        <div class="inv-toolbar">
          <button onclick="openInventoryModal()" style="background:var(--accent);color:#fff;border:none;padding:0.35rem 0.8rem;border-radius:6px;font-size:0.8rem;cursor:pointer;font-weight:600;">+ Add Item</button>
          <select id="inv-category-filter" onchange="renderInventory()" style="min-width:100px;">
            <option value="">All Categories</option>
          </select>
          <input type="text" id="inv-search" placeholder="Searchâ€¦" oninput="renderInventory()" style="flex:1;min-width:100px;">
          <button onclick="exportInventory()" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.35rem 0.6rem;border-radius:6px;font-size:0.75rem;cursor:pointer;" title="Export JSON">ğŸ“¤</button>
          <button onclick="document.getElementById('inv-import-file').click()" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.35rem 0.6rem;border-radius:6px;font-size:0.75rem;cursor:pointer;" title="Import JSON">ğŸ“¥</button>
          <input type="file" id="inv-import-file" accept=".json" style="display:none" onchange="importInventory(event)">
        </div>
        <div id="inventory-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:0.5rem;"></div>
      </div>
    </div>

    <!-- Inventory Modal -->
    <div class="catalog-modal-overlay" id="inv-modal">
      <div class="catalog-modal">
        <button class="modal-close" onclick="closeInventoryModal()">âœ•</button>
        <h3 style="color:var(--text);margin:0 0 0.8rem;" id="inv-modal-title">Add Item</h3>
        <input type="hidden" id="inv-edit-id">
        <label>Name *</label><input type="text" id="inv-name" maxlength="100">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
          <div><label>Category</label><select id="inv-category"></select></div>
          <div><label>Subcategory</label><input type="text" id="inv-subcategory" maxlength="50"></div>
        </div>
        <label>Description</label><textarea id="inv-description" rows="2"></textarea>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.5rem;">
          <div><label>Quantity</label><input type="number" id="inv-quantity" min="1" value="1"></div>
          <div><label>Condition</label><select id="inv-condition"><option>New</option><option selected>Good</option><option>Fair</option><option>Poor</option></select></div>
          <div><label>Acquired</label><input type="text" id="inv-acquired" placeholder="2024" maxlength="20"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
          <div><label>Location</label><input type="text" id="inv-location" maxlength="50"></div>
          <div><label>Est. Value</label><input type="text" id="inv-value" maxlength="20"></div>
        </div>
        <label>Notes</label><textarea id="inv-notes" rows="2"></textarea>
        <label>Tags (comma-separated)</label><input type="text" id="inv-tags" placeholder="daily-use, important">
        <div class="modal-actions">
          <button onclick="closeInventoryModal()" style="background:var(--bg-input);color:var(--text-muted);">Cancel</button>
          <button onclick="saveInventoryItem()" style="background:var(--accent);color:#fff;">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Fantasy Tab -->
  <div id="tab-fantasy" class="tab-content">
    <div class="panel" style="border-color:rgba(120,80,200,0.3);">
      <h2 style="color:var(--fantasy-accent,#9966ff);">âœ¨ Fantasy</h2>
      <p>The game side of Humanity. Your character, the world lore, and achievements â€” all stored locally. The adventure begins here.</p>
    </div>
    <div class="card-grid">

      <!-- â”€â”€ World Map â”€â”€ -->
      <div class="panel reality-card" id="fantasy-worldmap" style="border-color:rgba(120,80,200,0.2);">
        <h2 class="reality-card-header" onclick="toggleFantasyCard('worldmap')" style="color:var(--fantasy-accent,#9966ff);">ğŸ—ºï¸ World Map <span class="collapse-icon" id="worldmap-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="worldmap-body">
          <canvas id="world-map-canvas" width="560" height="280" style="width:100%;border-radius:8px;background:#0a0a1a;cursor:crosshair;"></canvas>
          <p style="text-align:center;margin-top:0.6rem;color:var(--fantasy-accent,#9966ff);font-style:italic;font-size:0.85rem;">
            "The world is being builtâ€¦"
          </p>
          <p style="font-size:0.8rem;color:var(--text-muted);text-align:center;line-height:1.6;">
            In the age before networks, humanity was scattered â€” isolated villages of thought, unable to share their fire.<br>
            Now the map fills itself, one connection at a time.
          </p>
        </div>
      </div>

      <!-- â”€â”€ Character Sheet â”€â”€ -->
      <div class="panel reality-card" id="fantasy-character" style="border-color:rgba(120,80,200,0.2);">
        <h2 class="reality-card-header" onclick="toggleFantasyCard('character')" style="color:var(--fantasy-accent,#9966ff);">âš”ï¸ Character Sheet <span class="collapse-icon" id="character-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="character-body">
          <div id="char-create" style="display:none;">
            <p style="font-size:0.82rem;color:var(--text-muted);margin-bottom:0.6rem;">Create your character to begin.</p>
            <input type="text" id="char-name-input" placeholder="Character name" maxlength="24" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:0.4rem;">
            <select id="char-class-input" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;font-family:inherit;margin-bottom:0.6rem;">
              <option value="Explorer">ğŸ§­ Explorer</option>
              <option value="Builder">ğŸ”¨ Builder</option>
              <option value="Scholar">ğŸ“š Scholar</option>
              <option value="Guardian">ğŸ›¡ï¸ Guardian</option>
            </select>
            <button onclick="createCharacter()" style="background:var(--fantasy-accent,#9966ff);color:#fff;border:none;padding:0.5rem 1.2rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;width:100%;">Create Character</button>
          </div>
          <div id="char-display" style="display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
              <div>
                <span id="char-d-name" style="font-weight:700;font-size:1rem;color:var(--text);"></span>
                <span id="char-d-class" style="font-size:0.8rem;color:var(--fantasy-accent,#9966ff);margin-left:0.4rem;"></span>
              </div>
              <span id="char-d-level" style="font-size:0.75rem;color:var(--text-muted);background:var(--bg-input);padding:0.15rem 0.5rem;border-radius:10px;"></span>
            </div>
            <div id="char-stats" style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;margin-bottom:0.6rem;"></div>
            <div style="display:flex;gap:0.4rem;">
              <button onclick="rerollStats()" style="flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem;border-radius:6px;font-size:0.8rem;cursor:pointer;font-family:inherit;">ğŸ² Reroll Stats</button>
              <button onclick="deleteCharacter()" style="background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.4rem 0.8rem;border-radius:6px;font-size:0.8rem;cursor:pointer;font-family:inherit;">ğŸ—‘ï¸</button>
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Lore / Codex â”€â”€ -->
      <div class="panel reality-card" id="fantasy-lore" style="border-color:rgba(120,80,200,0.2);">
        <h2 class="reality-card-header" onclick="toggleFantasyCard('lore')" style="color:var(--fantasy-accent,#9966ff);">ğŸ“œ Lore / Codex <span class="collapse-icon" id="lore-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="lore-body">
          <div id="lore-entries" style="display:flex;flex-direction:column;gap:0.4rem;"></div>
        </div>
      </div>

      <!-- â”€â”€ Achievements â”€â”€ -->
      <div class="panel reality-card" id="fantasy-achievements" style="border-color:rgba(120,80,200,0.2);">
        <h2 class="reality-card-header" onclick="toggleFantasyCard('achievements')" style="color:var(--fantasy-accent,#9966ff);">ğŸ† Achievements <span class="collapse-icon" id="achievements-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="achievements-body">
          <div id="achievement-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:0.5rem;"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Streams Tab -->
  <div id="tab-streams" class="tab-content">
    <div class="card-grid">

      <!-- â”€â”€ How It Works â”€â”€ -->
      <div class="panel reality-card" id="streams-howitworks">
        <h2 class="reality-card-header" onclick="toggleStreamsCard('howitworks')">ğŸ¬ How It Works <span class="collapse-icon" id="howitworks-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="howitworks-body">
          <p style="margin-bottom:0.8rem;">Peer-assisted streaming: the more viewers, the <em>better</em> it works.</p>
          <!-- Visual diagram -->
          <div style="display:flex;align-items:center;justify-content:center;gap:0.3rem;flex-wrap:wrap;margin:1rem 0;font-size:0.75rem;">
            <div style="text-align:center;padding:0.6rem;background:rgba(153,102,255,0.15);border:1px solid rgba(153,102,255,0.3);border-radius:8px;min-width:80px;">
              <div style="font-size:1.3rem;">ğŸ¥</div>
              <div style="color:var(--text);font-weight:600;">Creator</div>
              <div style="color:var(--text-muted);font-size:0.65rem;">Captures screen/cam</div>
            </div>
            <div style="color:var(--text-muted);font-size:1.2rem;">â†’</div>
            <div style="text-align:center;padding:0.6rem;background:rgba(68,136,255,0.15);border:1px solid rgba(68,136,255,0.3);border-radius:8px;min-width:80px;">
              <div style="font-size:1.3rem;">ğŸ–¥ï¸</div>
              <div style="color:var(--text);font-weight:600;">Relay</div>
              <div style="color:var(--text-muted);font-size:0.65rem;">Distributes to first viewers</div>
            </div>
            <div style="color:var(--text-muted);font-size:1.2rem;">â†’</div>
            <div style="text-align:center;padding:0.6rem;background:rgba(68,204,102,0.15);border:1px solid rgba(68,204,102,0.3);border-radius:8px;min-width:80px;">
              <div style="font-size:1.3rem;">ğŸ‘¥</div>
              <div style="color:var(--text);font-weight:600;">Viewers</div>
              <div style="color:var(--text-muted);font-size:0.65rem;">Seed to each other (mesh)</div>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:0.6rem;margin-top:0.8rem;">
            <div style="padding:0.5rem;background:rgba(255,255,255,0.02);border-radius:6px;font-size:0.8rem;">
              <strong style="color:var(--accent);">1. You stream</strong><br>Your camera/screen goes to the relay server.
            </div>
            <div style="padding:0.5rem;background:rgba(255,255,255,0.02);border-radius:6px;font-size:0.8rem;">
              <strong style="color:var(--accent);">2. Relay distributes</strong><br>Server sends to the first viewers.
            </div>
            <div style="padding:0.5rem;background:rgba(255,255,255,0.02);border-radius:6px;font-size:0.8rem;">
              <strong style="color:var(--accent);">3. Viewers seed</strong><br>Each viewer shares chunks with others. More = better.
            </div>
            <div style="padding:0.5rem;background:rgba(255,255,255,0.02);border-radius:6px;font-size:0.8rem;">
              <strong style="color:var(--accent);">4. You control BW</strong><br>Set your upload contribution. Gaming? Low. Idle? Crank it.
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Go Live â”€â”€ -->
      <div class="panel reality-card" id="streams-golive">
        <h2 class="reality-card-header" onclick="toggleStreamsCard('golive')">ğŸ“¡ Go Live <span class="collapse-icon" id="golive-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="golive-body">
          <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.6rem;">Streaming infrastructure coming soon â€” for now, test your camera/screen capture.</p>
          <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.8rem;">
            <button class="btn btn-clickable" id="capture-camera-btn" onclick="startCapture('camera')">ğŸ“· Camera</button>
            <button class="btn btn-clickable" id="capture-screen-btn" onclick="startCapture('screen')">ğŸ–¥ï¸ Screen</button>
            <button class="btn btn-disabled" id="capture-stop-btn" onclick="stopCapture()" style="display:none;">â¹ Stop</button>
          </div>
          <div id="capture-status" style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.5rem;"></div>
          <video id="capture-preview" autoplay muted playsinline style="display:none;width:100%;max-height:300px;border-radius:8px;background:#000;"></video>
        </div>
      </div>

      <!-- â”€â”€ Live Streams â”€â”€ -->
      <div class="panel reality-card" id="streams-live">
        <h2 class="reality-card-header" onclick="toggleStreamsCard('live')">ğŸ“º Live Streams <span class="collapse-icon" id="live-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="live-body">
          <div style="text-align:center;padding:2rem 1rem;">
            <div style="font-size:2rem;margin-bottom:0.5rem;">ğŸ“º</div>
            <div style="color:var(--text-muted);font-size:0.85rem;">No one is live right now</div>
            <div style="color:var(--text-muted);font-size:0.75rem;margin-top:0.3rem;">Be the first to test your capture above!</div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Server List â”€â”€ -->
      <div class="panel reality-card" id="streams-servers">
        <h2 class="reality-card-header" onclick="toggleStreamsCard('servers')">ğŸ–¥ï¸ Server List <span class="collapse-icon" id="servers-collapse">â–¼</span></h2>
        <div class="reality-card-body" id="servers-body">
          <div id="stream-servers-list">
            <div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem;background:rgba(255,255,255,0.02);border-radius:6px;margin-bottom:0.4rem;">
              <span style="font-size:1.1rem;" id="server-status-dot">ğŸŸ¢</span>
              <div>
                <div style="font-weight:600;font-size:0.85rem;">Humanity HQ</div>
                <div style="font-size:0.7rem;color:var(--text-muted);">united-humanity.us Â· Verified + Accord</div>
              </div>
              <span style="margin-left:auto;font-size:0.75rem;color:var(--text-muted);">0 live</span>
            </div>
          </div>
          <p style="font-size:0.75rem;color:var(--text-muted);margin-top:0.5rem;font-style:italic;">Federated server list coming soon.</p>
        </div>
      </div>

    </div>
  </div>

  <!-- Info Tab -->
  <!-- NOTE: Add /info to the nginx hub route regex, e.g. location ~ ^/(board|reality|fantasy|streams|info|debug) -->
  <div id="tab-info" class="tab-content" style="padding:1.5rem;">
    <style>
      #tab-info .info-section { margin-bottom:1.5rem; }
      #tab-info .info-section h2 { font-size:1.1rem; color:var(--accent); margin-bottom:0.8rem; border-bottom:1px solid var(--border); padding-bottom:0.4rem; cursor:pointer; user-select:none; }
      #tab-info .info-section h2::after { content:' â–¾'; font-size:0.7rem; opacity:0.5; }
      #tab-info .info-section.collapsed h2::after { content:' â–¸'; }
      #tab-info .info-section.collapsed .info-body { display:none; }
      #tab-info .role-card { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:10px; padding:1rem; margin-bottom:0.75rem; }
      #tab-info .role-card h3 { margin:0 0 0.4rem; font-size:0.95rem; }
      #tab-info .role-card .perms { font-size:0.8rem; color:var(--text-muted); line-height:1.6; }
      #tab-info .role-card .perms .yes { color:#4a8; }
      #tab-info .role-card .perms .no { color:#e55; }
      #tab-info .cmd-group { margin-bottom:1rem; }
      #tab-info .cmd-group h4 { font-size:0.85rem; color:var(--text); margin:0.6rem 0 0.3rem; }
      #tab-info .cmd-row { font-size:0.8rem; color:var(--text-muted); padding:0.15rem 0; }
      #tab-info .cmd-row code { background:rgba(255,255,255,0.06); padding:0.1rem 0.4rem; border-radius:3px; color:var(--accent); font-size:0.78rem; }
      #tab-info .stat-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:0.8rem; }
      #tab-info .stat-card { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:8px; padding:0.8rem; text-align:center; }
      #tab-info .stat-card .stat-val { font-size:1.4rem; font-weight:700; color:var(--accent); }
      #tab-info .stat-card .stat-label { font-size:0.7rem; color:var(--text-muted); margin-top:0.2rem; }
    </style>

    <!-- Server Info -->
    <div class="info-section" id="info-server">
      <h2>ğŸ–¥ï¸ Server Info</h2>
      <div class="info-body">
        <div class="stat-grid" id="info-stats">
          <div class="stat-card"><div class="stat-val" id="info-online">â€”</div><div class="stat-label">Online</div></div>
          <div class="stat-card"><div class="stat-val" id="info-registered">â€”</div><div class="stat-label">Registered</div></div>
          <div class="stat-card"><div class="stat-val" id="info-uptime">â€”</div><div class="stat-label">Uptime</div></div>
          <div class="stat-card"><div class="stat-val" id="info-version">â€”</div><div class="stat-label">Version</div></div>
        </div>
      </div>
    </div>

    <!-- Roles & Permissions -->
    <div class="info-section">
      <h2>ğŸ›¡ï¸ Roles & Permissions</h2>
      <div class="info-body">
        <div class="role-card">
          <h3>ğŸ‘¤ Unverified</h3>
          <div class="perms">
            <span class="yes">âœ“</span> Chat (rate limited) Â· Voice Â· View channels<br>
            <span class="no">âœ—</span> Upload files Â· DM Â· Create channels Â· Follow/unfollow
          </div>
        </div>
        <div class="role-card">
          <h3>âœ¦ Verified</h3>
          <div class="perms">
            <span class="yes">âœ“</span> All above + Upload files Â· DM friends Â· Follow/unfollow
          </div>
        </div>
        <div class="role-card">
          <h3>ğŸ’ Donor</h3>
          <div class="perms">
            <span class="yes">âœ“</span> Same as Verified + ğŸ’ badge Â· Priority support
          </div>
        </div>
        <div class="role-card">
          <h3>ğŸ›¡ï¸ Moderator</h3>
          <div class="perms">
            <span class="yes">âœ“</span> All above + DM anyone Â· Kick/mute/ban Â· Create/edit channels Â· Manage reports
          </div>
        </div>
        <div class="role-card">
          <h3>ğŸ‘‘ Admin</h3>
          <div class="perms">
            <span class="yes">âœ“</span> All above + Verify/unverify Â· Promote/demote Â· Lockdown Â· Wipe Â· Server config
          </div>
        </div>
      </div>
    </div>

    <!-- Social System -->
    <div class="info-section">
      <h2>ğŸ¤ Social System</h2>
      <div class="info-body">
        <div class="role-card">
          <h3>ğŸ‘ï¸ Follow</h3>
          <div class="perms">One-way â€” shows you care. Use <code>/follow &lt;name&gt;</code>. Right-click a user for quick follow.</div>
        </div>
        <div class="role-card">
          <h3>ğŸ¤ Friends (Mutual Follow)</h3>
          <div class="perms">When both users follow each other, they become friends. This unlocks DMs and shows the ğŸ¤ badge.</div>
        </div>
        <div class="role-card">
          <h3>ğŸš« Block</h3>
          <div class="perms">Client-side â€” hides their messages from your view. Use <code>/block &lt;name&gt;</code>.</div>
        </div>
      </div>
    </div>

    <!-- Rate Limits -->
    <div class="info-section">
      <h2>â±ï¸ Rate Limits</h2>
      <div class="info-body">
        <div class="role-card">
          <div class="perms">
            <strong>Messages:</strong> Fibonacci rate limiting (1,1,2,3,5,8â€¦ second delays on rapid posting)<br>
            <strong>New accounts:</strong> 5s minimum delay for first 10 minutes<br>
            <strong>Uploads:</strong> 2/minute, 4 image max per user (FIFO â€” oldest replaced)<br>
            <strong>API:</strong> 10 req/s general, 5 req/s for read endpoints
          </div>
        </div>
      </div>
    </div>

    <!-- Commands Reference -->
    <div class="info-section">
      <h2>ğŸ“œ Commands Reference</h2>
      <div class="info-body">
        <div class="cmd-group">
          <h4>ğŸ‘¥ Social</h4>
          <div class="cmd-row"><code>/follow &lt;name&gt;</code> â€” Follow a user</div>
          <div class="cmd-row"><code>/unfollow &lt;name&gt;</code> â€” Unfollow a user</div>
          <div class="cmd-row"><code>/block &lt;name&gt;</code> â€” Block a user</div>
          <div class="cmd-row"><code>/unblock &lt;name&gt;</code> â€” Unblock a user</div>
          <div class="cmd-row"><code>/blocklist</code> â€” Show blocked users</div>
        </div>
        <div class="cmd-group">
          <h4>ğŸ’¬ DMs & Groups</h4>
          <div class="cmd-row"><code>/dm &lt;name&gt; &lt;msg&gt;</code> â€” Send a direct message</div>
          <div class="cmd-row"><code>/dms</code> â€” List DM conversations</div>
          <div class="cmd-row"><code>/group-create &lt;name&gt;</code> â€” Create a group chat</div>
          <div class="cmd-row"><code>/group-join &lt;code&gt;</code> â€” Join group by invite code</div>
          <div class="cmd-row"><code>/group-invite</code> â€” Copy current group's invite code</div>
          <div class="cmd-row"><code>/group-leave</code> â€” Leave current group</div>
        </div>
        <div class="cmd-group">
          <h4>âœï¸ Profile</h4>
          <div class="cmd-row"><code>/bio &lt;text&gt;</code> â€” Set your bio</div>
          <div class="cmd-row"><code>/social &lt;platform&gt; &lt;handle&gt;</code> â€” Set social link</div>
          <div class="cmd-row"><code>/profile</code> â€” Edit profile</div>
          <div class="cmd-row"><code>/name &lt;name&gt;</code> â€” Change display name</div>
        </div>
        <div class="cmd-group">
          <h4>ğŸ“Œ Pins</h4>
          <div class="cmd-row"><code>/pin</code> â€” Pin the last message (mod/admin)</div>
          <div class="cmd-row"><code>/unpin &lt;N&gt;</code> â€” Unpin by index (mod/admin)</div>
          <div class="cmd-row"><code>/mypin</code> â€” Pin your last message (for yourself)</div>
          <div class="cmd-row"><code>/unmypin &lt;N&gt;</code> â€” Unpin your pin by index</div>
          <div class="cmd-row"><code>/pins</code> â€” View pins</div>
        </div>
        <div class="cmd-group">
          <h4>ğŸ“ Voice</h4>
          <div class="cmd-row"><code>/call</code> â€” Start a voice call (or use ğŸ“ button)</div>
        </div>
        <div class="cmd-group">
          <h4>ğŸ›¡ï¸ Moderation</h4>
          <div class="cmd-row"><code>/kick &lt;name&gt;</code> â€” Disconnect a user</div>
          <div class="cmd-row"><code>/mute &lt;name&gt;</code> â€” Mute a user</div>
          <div class="cmd-row"><code>/ban &lt;name&gt;</code> â€” Ban a user</div>
          <div class="cmd-row"><code>/report &lt;name&gt; [reason]</code> â€” Report a user</div>
        </div>
        <div class="cmd-group">
          <h4>ğŸ‘‘ Admin</h4>
          <div class="cmd-row"><code>/verify &lt;name&gt;</code> â€” Verify a user</div>
          <div class="cmd-row"><code>/unverify &lt;name&gt;</code> â€” Remove verified</div>
          <div class="cmd-row"><code>/mod &lt;name&gt;</code> â€” Promote to moderator</div>
          <div class="cmd-row"><code>/unmod &lt;name&gt;</code> â€” Remove moderator</div>
          <div class="cmd-row"><code>/donor &lt;name&gt;</code> â€” Set donor role</div>
          <div class="cmd-row"><code>/lockdown</code> â€” Toggle registration lock</div>
          <div class="cmd-row"><code>/channel-create &lt;name&gt; [desc]</code> â€” Create channel</div>
          <div class="cmd-row"><code>/channel-delete &lt;name&gt;</code> â€” Delete channel</div>
          <div class="cmd-row"><code>/wipe</code> â€” Delete all chat history</div>
        </div>
        <div class="cmd-group">
          <h4>ğŸ”§ Utility</h4>
          <div class="cmd-row"><code>/help</code> â€” Show help</div>
          <div class="cmd-row"><code>/export</code> â€” Download identity backup</div>
          <div class="cmd-row"><code>/link</code> â€” Link another device</div>
          <div class="cmd-row"><code>/revoke &lt;key&gt;</code> â€” Remove a device</div>
          <div class="cmd-row"><code>/users</code> â€” List all users</div>
        </div>
      </div>
    </div>

    <script>
    // Collapsible sections
    document.querySelectorAll('#tab-info .info-section h2').forEach(h2 => {
      h2.addEventListener('click', () => {
        h2.parentElement.classList.toggle('collapsed');
      });
    });
    // Fetch server stats
    (async function loadInfoStats() {
      try {
        const [statsRes, infoRes] = await Promise.all([
          fetch('/api/stats').then(r => r.ok ? r.json() : null).catch(() => null),
          fetch('/api/server-info').then(r => r.ok ? r.json() : null).catch(() => null)
        ]);
        if (statsRes) {
          if (statsRes.online !== undefined) document.getElementById('info-online').textContent = statsRes.online;
          if (statsRes.registered !== undefined) document.getElementById('info-registered').textContent = statsRes.registered;
          if (statsRes.uptime) {
            const s = statsRes.uptime;
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            document.getElementById('info-uptime').textContent = h + 'h ' + m + 'm';
          }
        }
        if (infoRes) {
          if (infoRes.version) document.getElementById('info-version').textContent = infoRes.version;
          else if (infoRes.name) document.getElementById('info-version').textContent = infoRes.name;
        }
      } catch(e) { console.warn('Info stats fetch failed:', e); }
    })();
    </script>
  </div>

  <!-- Source Tab â€” NOTE: add /source to nginx hub regex for routing -->
  <div id="tab-source" class="tab-content" style="padding:1.5rem;">
    <style>
      #tab-source .info-section { margin-bottom:1.5rem; }
      #tab-source .info-section h2 { font-size:1.1rem; color:var(--accent); margin-bottom:0.8rem; border-bottom:1px solid var(--border); padding-bottom:0.4rem; cursor:pointer; user-select:none; }
      #tab-source .info-section h2::after { content:' â–¾'; font-size:0.7rem; opacity:0.5; }
      #tab-source .info-section.collapsed h2::after { content:' â–¸'; }
      #tab-source .info-section.collapsed .info-body { display:none; }
      #tab-source .src-card { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:10px; padding:1.2rem; margin-bottom:0.75rem; }
      #tab-source .src-card p { font-size:0.85rem; color:var(--text-muted); line-height:1.6; margin:0.4rem 0; }
      #tab-source .src-card ul { list-style:none; padding:0; margin:0.5rem 0; }
      #tab-source .src-card li { font-size:0.85rem; color:var(--text-muted); padding:0.25rem 0; line-height:1.5; }
      #tab-source .src-card li::before { margin-right:0.4rem; }
      #tab-source .big-statement { font-size:1.2rem; color:var(--text); font-weight:700; text-align:center; margin:1rem 0; }
      #tab-source .sub-statement { font-size:0.9rem; color:var(--text-muted); text-align:center; margin-bottom:1rem; line-height:1.6; }
      #tab-source .btn-row { display:flex; gap:0.8rem; flex-wrap:wrap; justify-content:center; margin:1rem 0; }
      #tab-source .src-btn { display:inline-flex; align-items:center; gap:0.5rem; padding:0.7rem 1.4rem; border-radius:8px; font-size:0.9rem; font-weight:600; text-decoration:none; color:#fff; transition:opacity 0.15s; }
      #tab-source .src-btn:hover { opacity:0.85; }
      #tab-source .src-btn.gh { background:#333; }
      #tab-source .src-btn.donate { background:var(--accent,#e07020); }
      #tab-source .arch-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:0.8rem; margin:0.8rem 0; }
      #tab-source .arch-box { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:8px; padding:0.8rem; }
      #tab-source .arch-box h4 { font-size:0.85rem; color:var(--accent); margin:0 0 0.3rem; }
      #tab-source .arch-box p { font-size:0.78rem; margin:0; }
      #tab-source .tech-tags { display:flex; flex-wrap:wrap; gap:0.4rem; margin:0.6rem 0; }
      #tab-source .tech-tag { background:rgba(255,255,255,0.06); border:1px solid var(--border); border-radius:4px; padding:0.2rem 0.6rem; font-size:0.75rem; color:var(--text-muted); }
      #tab-source .stat-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:0.8rem; margin:0.8rem 0; }
      #tab-source .stat-card { background:var(--bg-card,#141414); border:1px solid var(--border); border-radius:8px; padding:0.8rem; text-align:center; }
      #tab-source .stat-card .stat-val { font-size:1.4rem; font-weight:700; color:var(--accent); }
      #tab-source .stat-card .stat-label { font-size:0.7rem; color:var(--text-muted); margin-top:0.2rem; }
    </style>

    <!-- Open Source -->
    <div class="info-section">
      <h2>ğŸ”“ Open Source</h2>
      <div class="info-body">
        <div class="src-card">
          <div class="big-statement">Humanity is 100% open source and public domain (CC0-1.0)</div>
          <div class="sub-statement">Anyone can use, modify, and distribute this code for any purpose.<br>No permission needed. No strings attached.</div>
          <div class="btn-row">
            <a href="https://github.com/Shaostoul/Humanity" target="_blank" class="src-btn gh">â­ GitHub â€” Shaostoul/Humanity</a>
            <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank" class="src-btn" style="background:#555;">ğŸ“„ CC0 1.0 License</a>
          </div>
        </div>
      </div>
    </div>

    <!-- The Accord -->
    <div class="info-section">
      <h2>ğŸ“œ The Accord</h2>
      <div class="info-body">
        <div class="src-card">
          <div class="big-statement" style="font-size:1rem;">Wholesomely aiding humanity's betterment</div>
          <ul>
            <li>ğŸ”’ <strong>Privacy first</strong> â€” No tracking, no accounts. Your identity is your keys.</li>
            <li>ğŸ—£ï¸ <strong>Free speech</strong> â€” No censorship. Line drawn at genuine threats and predatory harassment.</li>
            <li>ğŸ” <strong>18+ community</strong> â€” Mature, responsible communication.</li>
            <li>ğŸ’› <strong>Unconditional love</strong> â€” For all life.</li>
            <li>âœ¨ <strong>The 7 heavenly virtues</strong> â€” Chastity, temperance, charity, diligence, patience, kindness, humility.</li>
          </ul>
          <div class="btn-row">
            <a href="https://shaostoul.github.io/Humanity" target="_blank" class="src-btn" style="background:#555;">ğŸ“– Read the Full Accord</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Architecture -->
    <div class="info-section">
      <h2>ğŸ—ï¸ Architecture</h2>
      <div class="info-body">
        <div class="src-card">
          <div class="arch-grid">
            <div class="arch-box"><h4>ğŸ”‘ Identity</h4><p>Ed25519 key pairs stored in your browser â€” no accounts, no passwords</p></div>
            <div class="arch-box"><h4>ğŸ” Encryption</h4><p>Messages signed cryptographically â€” tamper-proof</p></div>
            <div class="arch-box"><h4>ğŸ“¡ Communication</h4><p>WebSocket relay for group chat, WebRTC P2P for voice/video</p></div>
            <div class="arch-box"><h4>ğŸ’¾ Storage</h4><p>SQLite on server, localStorage + IndexedDB on client</p></div>
            <div class="arch-box"><h4>ğŸŒ Federation</h4><p>Servers can link together â€” your identity works everywhere</p></div>
          </div>
          <p style="font-size:0.85rem;color:var(--text-muted);margin-top:0.8rem;"><strong>Tech stack:</strong></p>
          <div class="tech-tags">
            <span class="tech-tag">Rust</span><span class="tech-tag">Axum</span><span class="tech-tag">Tokio</span>
            <span class="tech-tag">SQLite</span><span class="tech-tag">Ed25519</span><span class="tech-tag">BLAKE3</span>
            <span class="tech-tag">WebRTC</span><span class="tech-tag">Vanilla JS</span>
          </div>
          <p style="font-size:0.82rem;color:var(--text-muted);margin-top:0.6rem;"><strong>Future:</strong> CBOR signed objects, P2P direct messaging, peer-assisted streaming</p>
        </div>
      </div>
    </div>

    <!-- Contributing -->
    <div class="info-section">
      <h2>ğŸ¤ Contributing</h2>
      <div class="info-body">
        <div class="src-card">
          <p style="font-size:0.95rem;color:var(--text);font-weight:600;">Everyone can help, not just programmers</p>
          <ul>
            <li>ğŸ› <strong>Report bugs</strong> â€” Use <code style="background:rgba(255,255,255,0.06);padding:0.1rem 0.4rem;border-radius:3px;color:var(--accent);">/report</code> in chat or <a href="https://github.com/Shaostoul/Humanity/issues" target="_blank" style="color:var(--accent);">GitHub Issues</a></li>
            <li>ğŸ’¡ <strong>Suggest features</strong> â€” Chat in #dev or <a href="https://github.com/Shaostoul/Humanity/discussions" target="_blank" style="color:var(--accent);">GitHub Discussions</a></li>
            <li>ğŸ”§ <strong>Write code</strong> â€” Fork, hack, PR â€” it's CC0, go wild</li>
            <li>ğŸ“– <strong>Improve docs</strong> â€” Website at <a href="https://shaostoul.github.io/Humanity" target="_blank" style="color:var(--accent);">shaostoul.github.io/Humanity</a></li>
            <li>ğŸ§ª <strong>Test features</strong> â€” Just use the app and tell us what breaks</li>
            <li>ğŸ’° <strong>Donate</strong> â€” Support development directly</li>
          </ul>
          <div class="btn-row">
            <a href="https://github.com/sponsors/Shaostoul" target="_blank" class="src-btn donate">â¤ï¸ GitHub Sponsors</a>
            <a href="https://ko-fi.com/shaostoul" target="_blank" class="src-btn donate">â˜• Ko-fi</a>
          </div>
          <p style="font-size:0.82rem;color:var(--text-muted);margin-top:0.8rem;"><strong>Self-hosting:</strong> <code style="background:rgba(255,255,255,0.06);padding:0.1rem 0.4rem;border-radius:3px;font-size:0.78rem;color:var(--text-muted);">git clone â†’ install Rust â†’ cargo build --release â†’ ./target/release/humanity-relay</code></p>
          <p style="font-size:0.78rem;"><a href="https://github.com/Shaostoul/Humanity#readme" target="_blank" style="color:var(--accent);">Full build instructions on GitHub README â†’</a></p>
        </div>
      </div>
    </div>

    <!-- Project Stats -->
    <div class="info-section" id="source-stats-section">
      <h2>ğŸ“Š Project Stats</h2>
      <div class="info-body">
        <div class="stat-grid">
          <div class="stat-card"><div class="stat-val" id="src-online">â€”</div><div class="stat-label">Online Now</div></div>
          <div class="stat-card"><div class="stat-val" id="src-registered">â€”</div><div class="stat-label">Registered</div></div>
          <div class="stat-card"><div class="stat-val" id="src-version">â€”</div><div class="stat-label">Version</div></div>
          <div class="stat-card"><div class="stat-val" id="src-uptime">â€”</div><div class="stat-label">Uptime</div></div>
          <div class="stat-card"><div class="stat-val">Rust</div><div class="stat-label">Language</div></div>
          <div class="stat-card"><div class="stat-val">CC0-1.0</div><div class="stat-label">License</div></div>
          <div class="stat-card"><div class="stat-val">Jan 2019</div><div class="stat-label">Started</div></div>
        </div>
        <div class="btn-row" style="margin-top:1rem;">
          <a href="https://github.com/Shaostoul/Humanity/commits" target="_blank" class="src-btn gh">ğŸ“ˆ Commit History on GitHub</a>
        </div>
      </div>
    </div>

    <script>
    // Collapsible sections
    document.querySelectorAll('#tab-source .info-section h2').forEach(h2 => {
      h2.addEventListener('click', () => h2.parentElement.classList.toggle('collapsed'));
    });
    // Fetch stats
    (async function loadSourceStats() {
      try {
        const [statsRes, infoRes] = await Promise.all([
          fetch('/api/stats').then(r => r.ok ? r.json() : null).catch(() => null),
          fetch('/api/server-info').then(r => r.ok ? r.json() : null).catch(() => null)
        ]);
        if (statsRes) {
          if (statsRes.online !== undefined) document.getElementById('src-online').textContent = statsRes.online;
          if (statsRes.registered !== undefined) document.getElementById('src-registered').textContent = statsRes.registered;
          if (statsRes.uptime) {
            const s = statsRes.uptime;
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            document.getElementById('src-uptime').textContent = h + 'h ' + m + 'm';
          }
        }
        if (infoRes && infoRes.version) document.getElementById('src-version').textContent = infoRes.version;
      } catch(e) { console.warn('Source stats fetch failed:', e); }
    })();
    </script>
  </div>

  <!-- Debug Tab -->
  <div id="tab-debug" class="tab-content">
    <div class="panel">
      <h2>ğŸ”§ System Information</h2>
      <p>Version, connection status, and system diagnostics.</p>
      <dl class="debug-info">
        <dt>Client Version</dt>
        <dd id="debug-version">â€”</dd>
        <dt>Server</dt>
        <dd id="debug-server">â€”</dd>
        <dt>Connection</dt>
        <dd id="debug-connection">Checkingâ€¦</dd>
        <dt>User Agent</dt>
        <dd id="debug-ua">â€”</dd>
        <dt>Screen</dt>
        <dd id="debug-screen">â€”</dd>
        <dt>Page Loaded</dt>
        <dd id="debug-loaded">â€”</dd>
      </dl>
    </div>

    <div class="panel">
      <h2>ğŸ¨ Button Design System</h2>
      <p>Interactive preview of all button states. These are the standard interaction patterns for the entire game UI.</p>

      <h3>All States (static preview)</h3>
      <div class="btn-grid">
        <div class="btn-demo">
          <button class="btn btn-clickable">Clickable</button>
          <span class="btn-label">Default Â· 1px green</span>
        </div>
        <div class="btn-demo">
          <button class="btn btn-channeling">Channeling</button>
          <span class="btn-label">Active/looping Â· 1px rainbow</span>
        </div>
        <div class="btn-demo">
          <button class="btn btn-activated">Activated</button>
          <span class="btn-label">Pressed Â· 5px red</span>
        </div>
        <div class="btn-demo">
          <button class="btn btn-disabled">Disabled</button>
          <span class="btn-label">Unclickable Â· 2px black</span>
        </div>
        <div class="btn-demo">
          <button class="btn btn-cooldown">
            Cooldown
            <span class="btn-cooldown-timer top">3.2s</span>
            <span class="btn-cooldown-timer bottom">3.2s</span>
          </button>
          <span class="btn-label">Waiting Â· 7px purple + timer</span>
        </div>
      </div>

      <h3>Interactive Test â€” Hover &amp; Click</h3>
      <p>Hover to see the blue border. Click and hold to see the red activated state.</p>
      <div class="btn-grid">
        <button class="btn" onclick="testBtnClick(this)">Hover / Click Me</button>
        <button class="btn" onclick="testBtnClick(this)">Another Button</button>
        <button class="btn" onclick="testBtnClick(this)">And Another</button>
      </div>

      <h3>Toggle Test â€” Click to Cycle States</h3>
      <p>Click to cycle: clickable â†’ channeling â†’ activated â†’ cooldown â†’ clickable</p>
      <div class="btn-grid">
        <button class="btn btn-clickable" onclick="cycleState(this)">Cycle Me</button>
        <button class="btn btn-clickable" onclick="cycleState(this)">Cycle Me Too</button>
        <button class="btn btn-clickable" onclick="cycleState(this)">And Me</button>
      </div>

      <h3>Cooldown Test â€” Click to Start Cooldown</h3>
      <div class="btn-grid">
        <button class="btn btn-clickable" onclick="startCooldown(this, 5)">5s Cooldown</button>
        <button class="btn btn-clickable" onclick="startCooldown(this, 10)">10s Cooldown</button>
        <button class="btn btn-clickable" onclick="startCooldown(this, 3)">3s Cooldown</button>
      </div>

      <h3>Channeling Test â€” Click to Start/Stop</h3>
      <div class="btn-grid">
        <button class="btn btn-clickable" onclick="toggleChannel(this)">Channel Me</button>
        <button class="btn btn-clickable" onclick="toggleChannel(this)">Channel This</button>
      </div>
    </div>

    <div class="panel">
      <h2>ğŸ¨ Color Reference</h2>
      <p>The visual language for button borders:</p>
      <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.8rem; margin-top: 0.5rem;">
        <div style="padding:0.5rem;border-left:3px solid #44cc66;background:rgba(68,204,102,0.05);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#44cc66;">Green 1px</strong> â€” Clickable / ready
        </div>
        <div style="padding:0.5rem;border-left:3px solid #4488ff;background:rgba(68,136,255,0.05);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#4488ff;">Blue 3px</strong> â€” Hovered / focused
        </div>
        <div style="padding:0.5rem;border-left:3px solid #ee3333;background:rgba(238,51,51,0.05);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#ee3333;">Red 5px</strong> â€” Activated / pressed
        </div>
        <div style="padding:0.5rem;border-left:3px solid #222;background:rgba(0,0,0,0.1);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#666;">Black 2px</strong> â€” Disabled / locked
        </div>
        <div style="padding:0.5rem;border-left:3px solid #8844cc;background:rgba(136,68,204,0.05);border-radius:4px;font-size:0.8rem;">
          <strong style="color:#8844cc;">Purple 7px</strong> â€” Cooldown + timer
        </div>
        <div style="padding:0.5rem;border-left:3px solid;border-image:linear-gradient(90deg,#f00,#ff0,#0f0,#0ff,#00f,#f0f,#f00) 1;background:rgba(255,255,255,0.03);border-radius:0 4px 4px 0;font-size:0.8rem;">
          <strong style="background:linear-gradient(90deg,#f00,#ff0,#0f0,#0ff,#00f,#f0f);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Rainbow 1px</strong> â€” Channeling / active
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- Market Tab -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-market" class="tab-content" style="padding:1rem;overflow-y:auto;">
    <!-- Sub-navigation -->
    <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap;align-items:center;">
      <button class="btn btn-clickable" onclick="showMarketSection('marketplace')" id="market-nav-marketplace" style="min-width:auto;min-height:32px;padding:0.25rem 0.7rem;font-size:0.8rem;">ğŸª Marketplace</button>
      <button class="btn" onclick="showMarketSection('stores')" id="market-nav-stores" style="min-width:auto;min-height:32px;padding:0.25rem 0.7rem;font-size:0.8rem;">ğŸ¬ Stores</button>
      <button class="btn" onclick="showMarketSection('mylistings')" id="market-nav-mylistings" style="min-width:auto;min-height:32px;padding:0.25rem 0.7rem;font-size:0.8rem;">ğŸ“‹ My Listings</button>
      <span style="flex:1;"></span>
      <button class="btn btn-clickable" onclick="openListingModal()" id="market-create-btn" style="min-width:auto;min-height:32px;padding:0.25rem 0.7rem;font-size:0.8rem;display:none;">+ Create Listing</button>
    </div>

    <!-- Marketplace Section -->
    <div id="market-section-marketplace">
      <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1rem;align-items:center;position:sticky;top:0;z-index:10;background:var(--bg);padding:0.5rem 0;">
        <input type="text" id="market-search" placeholder="ğŸ” Search listingsâ€¦" oninput="renderMarketListings()" style="flex:1;min-width:150px;padding:0.4rem 0.6rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.8rem;">
        <select id="market-category-filter" onchange="renderMarketListings()" style="padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.8rem;">
          <option value="">All Categories</option>
          <option>Electronics</option><option>Vehicles</option><option>Clothing</option><option>Tools</option>
          <option>Furniture</option><option>Home</option><option>Books/Media</option><option>Gaming</option>
          <option>Sports</option><option>Crafts</option><option>Food/Garden</option><option>Services</option><option>Other</option>
        </select>
        <select id="market-condition-filter" onchange="renderMarketListings()" style="padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.8rem;">
          <option value="">Any Condition</option>
          <option>New</option><option>Like New</option><option>Good</option><option>Fair</option><option>Poor</option><option>N/A</option>
        </select>
        <select id="market-sort" onchange="renderMarketListings()" style="padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.8rem;">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
          <option value="alpha">A-Z</option>
        </select>
      </div>
      <div id="market-listings-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;"></div>
      <div id="market-listings-empty" style="text-align:center;color:var(--text-muted);font-style:italic;padding:3rem 1rem;display:none;">No listings yet. Be the first to list something!</div>
    </div>

    <!-- Store Directory Section -->
    <div id="market-section-stores" style="display:none;">
      <div style="margin-bottom:1rem;">
        <select id="store-category-filter" onchange="renderStoreDirectory()" style="padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.8rem;">
          <option value="">All Categories</option>
        </select>
      </div>
      <div id="store-directory-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem;"></div>
    </div>

    <!-- My Listings Section -->
    <div id="market-section-mylistings" style="display:none;">
      <div id="my-listings-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;"></div>
      <div id="my-listings-empty" style="text-align:center;color:var(--text-muted);font-style:italic;padding:3rem 1rem;display:none;">You haven't listed anything yet.</div>
    </div>

    <!-- Listing Detail Modal -->
    <div id="listing-detail-modal" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);overflow-y:auto;" onclick="if(event.target===this)closeListingDetail()">
      <div style="max-width:600px;margin:3rem auto;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;">
        <div id="listing-detail-content"></div>
      </div>
    </div>

    <!-- Create/Edit Listing Modal -->
    <div id="listing-modal" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);overflow-y:auto;" onclick="if(event.target===this)closeListingModal()">
      <div style="max-width:500px;margin:3rem auto;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;">
        <h2 style="color:var(--accent);margin-bottom:1rem;font-size:1rem;" id="listing-modal-title">Create Listing</h2>
        <input type="hidden" id="listing-edit-id" value="">
        <div style="display:flex;flex-direction:column;gap:0.6rem;">
          <div>
            <label style="font-size:0.75rem;color:var(--text-muted);">Title *</label>
            <input type="text" id="listing-title" maxlength="100" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
          </div>
          <div>
            <label style="font-size:0.75rem;color:var(--text-muted);">Description</label>
            <textarea id="listing-description" rows="3" maxlength="2000" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;resize:vertical;"></textarea>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
            <div>
              <label style="font-size:0.75rem;color:var(--text-muted);">Category *</label>
              <select id="listing-category" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
                <option>Electronics</option><option>Vehicles</option><option>Clothing</option><option>Tools</option>
                <option>Furniture</option><option>Home</option><option>Books/Media</option><option>Gaming</option>
                <option>Sports</option><option>Crafts</option><option>Food/Garden</option><option>Services</option><option>Other</option>
              </select>
            </div>
            <div>
              <label style="font-size:0.75rem;color:var(--text-muted);">Condition</label>
              <select id="listing-condition" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
                <option>New</option><option>Like New</option><option>Good</option><option>Fair</option><option>Poor</option><option>N/A</option>
              </select>
            </div>
          </div>
          <div>
            <label style="font-size:0.75rem;color:var(--text-muted);">Price</label>
            <input type="text" id="listing-price" placeholder='$50, Trade, Free, Best offerâ€¦' maxlength="50" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
          </div>
          <div>
            <label style="font-size:0.75rem;color:var(--text-muted);">Payment Methods</label>
            <input type="text" id="listing-payment" placeholder='Venmo, Cash, Crypto, Tradeâ€¦' maxlength="100" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
          </div>
          <div>
            <label style="font-size:0.75rem;color:var(--text-muted);">Location</label>
            <input type="text" id="listing-location" placeholder='Seattle area, Ships worldwideâ€¦' maxlength="100" style="width:100%;padding:0.4rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
          </div>
          <div style="display:flex;gap:0.5rem;justify-content:flex-end;margin-top:0.5rem;">
            <button class="btn" onclick="closeListingModal()" style="min-width:80px;min-height:36px;padding:0.3rem 0.8rem;font-size:0.8rem;">Cancel</button>
            <button class="btn btn-clickable" onclick="submitListing()" style="min-width:80px;min-height:36px;padding:0.3rem 0.8rem;font-size:0.8rem;">Submit</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Panel (inline, replaces tab content) -->
  <div id="tab-settings" class="tab-content" style="padding:1.5rem;">
    <div class="panel">
      <h2 id="settings-title">âš™ Settings</h2>
      <div id="settings-body"></div>
    </div>
  </div>

  <script>
    // â”€â”€ Hub Tab System (SPA with pushState) â”€â”€
    const HUB_TABS = ['board', 'reality', 'fantasy', 'market', 'streams', 'info', 'source', 'debug'];
    let currentTab = 'reality';

    function getTabFromPath() {
      const path = window.location.pathname.replace(/^\//, '').replace(/\/$/, '').toLowerCase();
      if (HUB_TABS.includes(path)) return path;
      return null;
    }

    function switchTab(tabId, pushState) {
      if (!HUB_TABS.includes(tabId)) tabId = 'reality';
      currentTab = tabId;

      // Update nav active state
      document.querySelectorAll('.hub-nav .tab').forEach(el => {
        el.classList.toggle('active', el.dataset.tab === tabId);
      });

      // Show correct content panel
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      const tabEl = document.getElementById('tab-' + tabId);
      if (tabEl) tabEl.classList.add('active');

      // Update page title
      const titles = { board: 'Board', reality: 'Reality', fantasy: 'Fantasy', market: 'Market', streams: 'Streams', info: 'Info', source: 'Source', debug: 'Debug' };
      document.title = 'Humanity â€” ' + (titles[tabId] || 'Hub');

      // Update URL
      if (pushState !== false) {
        const newPath = '/' + tabId;
        if (window.location.pathname !== newPath) {
          history.pushState({ tab: tabId }, '', newPath);
        }
      }
    }

    // SPA navigation: intercept hub tab clicks
    document.querySelectorAll('.hub-nav .tab[data-tab]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        switchTab(link.dataset.tab);
      });
    });

    // Handle browser back/forward
    window.addEventListener('popstate', (e) => {
      const tab = (e.state && e.state.tab) || getTabFromPath();
      if (tab) switchTab(tab, false);
    });

    // Initialize from URL
    const initialTab = getTabFromPath() || 'reality';
    switchTab(initialTab, false);

    // â”€â”€ Debug Info â”€â”€
    (function populateDebugInfo() {
      const el = (id) => document.getElementById(id);
      el('debug-version').textContent = '0.1.0-dev';
      el('debug-server').textContent = window.location.origin;
      el('debug-ua').textContent = navigator.userAgent.slice(0, 100);
      el('debug-screen').textContent = screen.width + 'Ã—' + screen.height + ' Â· ' + (window.devicePixelRatio || 1) + 'x DPR';
      el('debug-loaded').textContent = new Date().toISOString();

      // Check relay connection
      async function checkConnection() {
        try {
          const res = await fetch('/api/stats');
          if (res.ok) {
            const data = await res.json();
            el('debug-connection').textContent = 'âœ… Connected â€” ' + (data.online_users || 0) + ' users online';
            el('debug-connection').style.color = '#4a8';
            if (data.version) el('debug-version').textContent = data.version;
          } else {
            el('debug-connection').textContent = 'âš ï¸ Server responded ' + res.status;
            el('debug-connection').style.color = '#eb4';
          }
        } catch (e) {
          el('debug-connection').textContent = 'âŒ Cannot reach server';
          el('debug-connection').style.color = '#e55';
        }
      }
      checkConnection();
    })();

    // â”€â”€ Global: Click activates red border for 1s â”€â”€
    document.addEventListener('click', function(e) {
      const btn = e.target.closest('.btn');
      if (!btn || btn.classList.contains('btn-disabled') || btn.classList.contains('btn-cooldown')) return;
      const wasChanneling = btn.classList.contains('btn-channeling');
      btn.classList.add('btn-activated');
      if (wasChanneling) btn.style.animation = 'none';
      setTimeout(() => {
        btn.classList.remove('btn-activated');
        if (wasChanneling) btn.style.animation = '';
      }, 1000);
    });

    // â”€â”€ Button Test Functions â”€â”€
    function testBtnClick(btn) {
      btn.textContent = 'âœ“ Clicked!';
      setTimeout(() => { btn.textContent = 'Hover / Click Me'; }, 800);
    }

    const states = ['btn-clickable', 'btn-channeling', 'btn-activated', 'btn-cooldown', 'btn-disabled'];
    function cycleState(btn) {
      const current = states.find(s => btn.classList.contains(s)) || 'btn-clickable';
      const idx = states.indexOf(current);
      const next = states[(idx + 1) % states.length];
      states.forEach(s => btn.classList.remove(s));
      btn.classList.add(next);
      btn.querySelectorAll('.btn-cooldown-timer').forEach(t => t.remove());
      if (next === 'btn-cooldown') {
        btn.innerHTML = btn.textContent.replace(/[\d.]+s/g, '').trim();
        const topT = document.createElement('span');
        topT.className = 'btn-cooldown-timer top';
        topT.textContent = 'âˆ';
        const botT = document.createElement('span');
        botT.className = 'btn-cooldown-timer bottom';
        botT.textContent = 'âˆ';
        btn.appendChild(topT);
        btn.appendChild(botT);
      }
    }

    function startCooldown(btn, seconds) {
      if (btn.classList.contains('btn-cooldown')) return;
      const originalText = btn.textContent;
      btn.classList.remove('btn-clickable');
      btn.classList.add('btn-cooldown');

      const topT = document.createElement('span');
      topT.className = 'btn-cooldown-timer top';
      const botT = document.createElement('span');
      botT.className = 'btn-cooldown-timer bottom';
      btn.appendChild(topT);
      btn.appendChild(botT);

      let remaining = seconds;
      const update = () => {
        topT.textContent = remaining.toFixed(1) + 's';
        botT.textContent = remaining.toFixed(1) + 's';
      };
      update();

      const interval = setInterval(() => {
        remaining -= 0.1;
        if (remaining <= 0) {
          clearInterval(interval);
          btn.classList.remove('btn-cooldown');
          btn.classList.add('btn-clickable');
          topT.remove();
          botT.remove();
          btn.textContent = originalText;
        } else {
          update();
        }
      }, 100);
    }

    function toggleGoLive(btn) {
      if (btn.classList.contains('btn-channeling')) {
        btn.classList.remove('btn-channeling');
        btn.classList.add('btn-clickable');
        btn.textContent = 'Start Stream';
        document.getElementById('stream-status').textContent = 'Not streaming';
        document.getElementById('stream-status').style.color = 'var(--text-muted)';
      } else {
        btn.classList.remove('btn-clickable');
        btn.classList.add('btn-channeling');
        btn.textContent = 'Stop Stream';
        document.getElementById('stream-status').innerHTML = '<span style="color:#e55;">â—</span> Streaming (demo mode)';
      }
    }

    function toggleChannel(btn) {
      if (btn.classList.contains('btn-channeling')) {
        btn.classList.remove('btn-channeling');
        btn.classList.add('btn-clickable');
        btn.textContent = btn.textContent.replace('Stop', 'Channel');
      } else {
        btn.classList.remove('btn-clickable');
        btn.classList.add('btn-channeling');
        btn.textContent = btn.textContent.replace('Channel', 'Stop');
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REALITY TAB â€” Todo, Notes, Garden, Catalogs
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â”€â”€ Card collapse â”€â”€
    const REALITY_CARDS = ['todo', 'notes', 'garden', 'references', 'elements', 'materials', 'inventory'];
    function toggleRealityCard(id) {
      const card = document.getElementById('reality-' + id);
      if (card) card.classList.toggle('collapsed');
      localStorage.setItem('reality_collapsed_' + id, card.classList.contains('collapsed'));
    }
    // Restore collapse state
    REALITY_CARDS.forEach(id => {
      if (localStorage.getItem('reality_collapsed_' + id) === 'true') {
        const card = document.getElementById('reality-' + id);
        if (card) card.classList.add('collapsed');
      }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REFERENCE SOURCES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const REF_SOURCES = [
      { icon: 'âš›ï¸', name: 'NIST', url: 'https://nist.gov', desc: 'Physical constants, element data, standards' },
      { icon: 'ğŸ§ª', name: 'PubChem', url: 'https://pubchem.ncbi.nlm.nih.gov', desc: 'Chemical compounds database' },
      { icon: 'ğŸ”¬', name: 'PubMed', url: 'https://pubmed.ncbi.nlm.nih.gov', desc: 'Biomedical research papers' },
      { icon: 'ğŸŒŒ', name: 'NASA ADS', url: 'https://ui.adsabs.harvard.edu', desc: 'Astrophysics data system' },
      { icon: 'ğŸ“–', name: 'Wikipedia', url: 'https://wikipedia.org', desc: 'General reference encyclopedia' },
      { icon: 'ğŸª¨', name: 'USGS', url: 'https://usgs.gov', desc: 'Geological surveys, minerals, mines' },
      { icon: 'ğŸ—ï¸', name: 'MatWeb', url: 'https://matweb.com', desc: 'Material property data' },
      { icon: 'ğŸ“Š', name: 'Wolfram Alpha', url: 'https://wolframalpha.com', desc: 'Computational knowledge engine' },
    ];
    (function renderRefSources() {
      document.getElementById('ref-sources-grid').innerHTML = REF_SOURCES.map(s =>
        `<a href="${s.url}" target="_blank" rel="noopener" class="ref-card">
          <span class="ref-icon">${s.icon}</span>
          <div><div class="ref-name">${s.name}</div><div class="ref-desc">${s.desc}</div></div>
        </a>`
      ).join('');
    })();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ELEMENT CATALOG
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const ELEMENTS = [
      { symbol:'H', name:'Hydrogen', number:1, category:'nonmetal', mass:1.008, phase:'Gas',
        density:'0.00008988 g/cmÂ³', meltingPoint:'-259.16 Â°C', boilingPoint:'-252.87 Â°C',
        discovered:'1766', discoverer:'Henry Cavendish',
        uses:['Fuel cells','Ammonia production','Rocket fuel','Hydrogenation'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C1333740'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Hydrogen'}],
        description:'Lightest element. Most abundant chemical substance in the universe.' },
      { symbol:'C', name:'Carbon', number:6, category:'nonmetal', mass:12.011, phase:'Solid',
        density:'2.267 g/cmÂ³', meltingPoint:'3550 Â°C', boilingPoint:'4027 Â°C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Steel production','Fuels','Plastics','Diamond/graphite'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440440'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Carbon'}],
        description:'Basis of all known life. Forms more compounds than any other element.' },
      { symbol:'N', name:'Nitrogen', number:7, category:'nonmetal', mass:14.007, phase:'Gas',
        density:'0.0012506 g/cmÂ³', meltingPoint:'-210.00 Â°C', boilingPoint:'-195.79 Â°C',
        discovered:'1772', discoverer:'Daniel Rutherford',
        uses:['Fertilizers','Explosives','Cryogenics','Food preservation'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7727379'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Nitrogen'}],
        description:'Makes up 78% of Earth\'s atmosphere. Essential for amino acids and DNA.' },
      { symbol:'O', name:'Oxygen', number:8, category:'nonmetal', mass:15.999, phase:'Gas',
        density:'0.001429 g/cmÂ³', meltingPoint:'-218.79 Â°C', boilingPoint:'-182.96 Â°C',
        discovered:'1774', discoverer:'Joseph Priestley',
        uses:['Respiration','Steel manufacturing','Medical','Welding'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7782447'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Oxygen'}],
        description:'Essential for aerobic life. Third most abundant element in the universe.' },
      { symbol:'Si', name:'Silicon', number:14, category:'metalloid', mass:28.085, phase:'Solid',
        density:'2.3296 g/cmÂ³', meltingPoint:'1414 Â°C', boilingPoint:'3265 Â°C',
        discovered:'1824', discoverer:'JÃ¶ns Jacob Berzelius',
        uses:['Semiconductors','Glass','Concrete','Solar cells'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440213'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Silicon'}],
        description:'Second most abundant element in Earth\'s crust. Foundation of modern electronics.' },
      { symbol:'Fe', name:'Iron', number:26, category:'transition-metal', mass:55.845, phase:'Solid',
        density:'7.874 g/cmÂ³', meltingPoint:'1538 Â°C', boilingPoint:'2862 Â°C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Steel','Construction','Machinery','Magnets'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7439896'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Iron'}],
        description:'Most common element on Earth by mass. Core component of steel.' },
      { symbol:'Cu', name:'Copper', number:29, category:'transition-metal', mass:63.546, phase:'Solid',
        density:'8.96 g/cmÂ³', meltingPoint:'1084.62 Â°C', boilingPoint:'2562 Â°C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Electrical wiring','Plumbing','Electronics','Alloys'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440508'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Copper'}],
        description:'Excellent conductor of electricity and heat. One of few metals with natural color.' },
      { symbol:'Ag', name:'Silver', number:47, category:'transition-metal', mass:107.868, phase:'Solid',
        density:'10.49 g/cmÂ³', meltingPoint:'961.78 Â°C', boilingPoint:'2162 Â°C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Jewelry','Electronics','Photography','Antibacterial'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440224'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Silver'}],
        description:'Highest electrical and thermal conductivity of any element. Precious metal.' },
      { symbol:'Au', name:'Gold', number:79, category:'transition-metal', mass:196.967, phase:'Solid',
        density:'19.3 g/cmÂ³', meltingPoint:'1064.18 Â°C', boilingPoint:'2856 Â°C',
        discovered:'Ancient', discoverer:'Known since antiquity',
        uses:['Currency/Investment','Jewelry','Electronics','Dentistry'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440575'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Gold'}],
        description:'Highly valued precious metal. Extremely malleable and resistant to corrosion.' },
      { symbol:'U', name:'Uranium', number:92, category:'actinide', mass:238.029, phase:'Solid',
        density:'19.1 g/cmÂ³', meltingPoint:'1132.2 Â°C', boilingPoint:'4131 Â°C',
        discovered:'1789', discoverer:'Martin Heinrich Klaproth',
        uses:['Nuclear power','Nuclear weapons','Radiation shielding','Dating rocks'],
        sources:[{name:'NIST',url:'https://webbook.nist.gov/cgi/cbook.cgi?ID=C7440611'},{name:'PubChem',url:'https://pubchem.ncbi.nlm.nih.gov/element/Uranium'}],
        description:'Heaviest naturally occurring element. Primary fuel for nuclear reactors.' },
    ];

    const ELEMENT_CATEGORIES = [...new Set(ELEMENTS.map(e => e.category))];
    let elementCatFilter = '';
    let selectedElement = null;

    function renderElementPills() {
      const pills = document.getElementById('element-cat-pills');
      pills.innerHTML = `<span class="filter-pill ${elementCatFilter===''?'active':''}" onclick="elementCatFilter='';renderElements()">All</span>` +
        ELEMENT_CATEGORIES.map(c => `<span class="filter-pill ${elementCatFilter===c?'active':''}" onclick="elementCatFilter='${c}';renderElements()">${c}</span>`).join('');
    }

    function renderElements() {
      const filter = (document.getElementById('element-filter').value || '').toLowerCase();
      const filtered = ELEMENTS.filter(e => {
        if (elementCatFilter && e.category !== elementCatFilter) return false;
        if (filter && !e.name.toLowerCase().includes(filter) && !e.symbol.toLowerCase().includes(filter) && !String(e.number).includes(filter)) return false;
        return true;
      });
      renderElementPills();
      document.getElementById('element-grid').innerHTML = filtered.map(e =>
        `<div class="element-card el-cat-${e.category}" onclick="showElementDetail('${e.symbol}')" title="${e.name}">
          <span class="el-number">${e.number}</span>
          <div class="el-symbol">${e.symbol}</div>
          <div class="el-name">${e.name}</div>
          <div class="el-mass">${e.mass}</div>
        </div>`
      ).join('');
    }

    function showElementDetail(symbol) {
      const e = ELEMENTS.find(el => el.symbol === symbol);
      if (!e) return;
      if (selectedElement === symbol) { selectedElement = null; document.getElementById('element-detail-slot').innerHTML = ''; return; }
      selectedElement = symbol;
      const srcLinks = e.sources.map(s => `<a href="${s.url}" target="_blank" rel="noopener" style="color:var(--accent);font-size:0.75rem;margin-right:0.6rem;">${s.name} â†—</a>`).join('');
      document.getElementById('element-detail-slot').innerHTML = `
        <div class="element-detail">
          <div style="display:flex;justify-content:space-between;align-items:start;">
            <h3><span class="el-cat-${e.category}" style="border:none;display:inline;"><span class="el-symbol" style="font-size:1.4rem;">${e.symbol}</span></span> ${e.name} <span style="color:var(--text-muted);font-weight:400;font-size:0.85rem;">#${e.number}</span></h3>
            <button onclick="selectedElement=null;document.getElementById('element-detail-slot').innerHTML=''" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.1rem;">âœ•</button>
          </div>
          <p style="font-size:0.82rem;color:var(--text-muted);margin:0.3rem 0 0.6rem;">${e.description}</p>
          <div class="el-props">
            <div class="el-prop"><dt>Mass</dt><dd>${e.mass} u</dd></div>
            <div class="el-prop"><dt>Phase (STP)</dt><dd>${e.phase}</dd></div>
            <div class="el-prop"><dt>Density</dt><dd>${e.density}</dd></div>
            <div class="el-prop"><dt>Melting Pt</dt><dd>${e.meltingPoint}</dd></div>
            <div class="el-prop"><dt>Boiling Pt</dt><dd>${e.boilingPoint}</dd></div>
            <div class="el-prop"><dt>Category</dt><dd>${e.category}</dd></div>
            <div class="el-prop"><dt>Discovered</dt><dd>${e.discovered}</dd></div>
            <div class="el-prop"><dt>Discoverer</dt><dd>${e.discoverer}</dd></div>
          </div>
          <div style="margin:0.6rem 0;"><strong style="font-size:0.75rem;color:var(--text-muted);">USES:</strong>
            <div style="display:flex;flex-wrap:wrap;gap:0.3rem;margin-top:0.3rem;">
              ${e.uses.map(u => `<span style="background:rgba(255,136,17,0.1);color:var(--accent);font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:10px;">${u}</span>`).join('')}
            </div>
          </div>
          <div style="margin-top:0.5rem;">${srcLinks}</div>
        </div>`;
    }
    renderElements();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MATERIALS CATALOG
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const MATERIALS = [
      { name:'Iron Ore', type:'raw', category:'Metal',
        components:[], sources_natural:['Open-pit mines','Underground deposits','BIF formations'],
        properties:{ iron_content:'25-70%', density:'4.0-5.5 g/cmÂ³', hardness:'5-6.5 Mohs' },
        uses:['Steel production','Pigments','Cement additive'],
        processing:'Mining â†’ Crushing â†’ Beneficiation â†’ Iron ore concentrate',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/iron-ore-statistics-and-information'}] },
      { name:'Steel', type:'processed', category:'Metal',
        components:['Iron','Carbon'], sources_natural:['Iron ore deposits','Coal mines'],
        properties:{ tensile_strength:'400-550 MPa', density:'7.85 g/cmÂ³', melting_point:'1370-1510 Â°C' },
        uses:['Construction','Vehicles','Tools','Bridges'],
        processing:'Iron ore â†’ Blast furnace â†’ Pig iron â†’ Basic oxygen steelmaking â†’ Steel',
        references:[{name:'MatWeb',url:'https://matweb.com/search/DataSheet.aspx?MatGUID=1b3c3a1bc9d24cccb03b1bacbbcdfa8c'}] },
      { name:'Wood / Timber', type:'raw', category:'Organic',
        components:[], sources_natural:['Forests','Tree plantations'],
        properties:{ density:'0.4-0.9 g/cmÂ³', tensile_strength:'40-140 MPa', moisture:'12-20%' },
        uses:['Construction','Furniture','Paper','Fuel'],
        processing:'Felling â†’ Debarking â†’ Sawing â†’ Seasoning',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Wood'}] },
      { name:'Lumber', type:'processed', category:'Organic',
        components:['Wood / Timber'], sources_natural:['Managed forests','Sawmills'],
        properties:{ density:'0.35-0.6 g/cmÂ³', moisture:'6-12%', standard_sizes:'2Ã—4, 2Ã—6, 4Ã—4 etc.' },
        uses:['Framing','Decking','Fencing','Shelving'],
        processing:'Timber â†’ Sawmill â†’ Kiln drying â†’ Planing â†’ Grading â†’ Lumber',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Lumber'}] },
      { name:'Sand', type:'raw', category:'Mineral',
        components:[], sources_natural:['Beaches','Riverbeds','Quarries','Deserts'],
        properties:{ composition:'Mostly SiOâ‚‚', grain_size:'0.1-2 mm', density:'1.5-1.7 g/cmÂ³' },
        uses:['Glass making','Concrete','Foundry casting','Filtration'],
        processing:'Extraction â†’ Washing â†’ Screening â†’ Grading',
        references:[{name:'USGS',url:'https://usgs.gov/centers/national-minerals-information-center/sand-and-gravel-statistics-and-information'}] },
      { name:'Glass', type:'processed', category:'Mineral',
        components:['Sand','Soda ash','Limestone'], sources_natural:['Sand quarries'],
        properties:{ density:'2.5 g/cmÂ³', melting_point:'~1700 Â°C', transparency:'High (visible spectrum)' },
        uses:['Windows','Bottles','Optics','Screens'],
        processing:'Sand + Soda ash + Limestone â†’ Furnace (1700Â°C) â†’ Molten glass â†’ Forming â†’ Annealing â†’ Glass',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Glass'}] },
      { name:'Clay', type:'raw', category:'Mineral',
        components:[], sources_natural:['Riverbanks','Weathered rock deposits','Sedimentary layers'],
        properties:{ particle_size:'<0.002 mm', plasticity:'High when wet', density:'1.8-2.6 g/cmÂ³' },
        uses:['Pottery','Bricks','Ceramics','Sculpture'],
        processing:'Extraction â†’ Weathering â†’ Pugging â†’ Shaping',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Clay'}] },
      { name:'Concrete', type:'composite', category:'Mineral',
        components:['Sand','Gravel','Cement','Water'], sources_natural:['Quarries','Cement plants'],
        properties:{ compressive_strength:'20-40 MPa', density:'2.3-2.5 g/cmÂ³', curing_time:'28 days full strength' },
        uses:['Foundations','Roads','Dams','Buildings'],
        processing:'Cement + Sand + Gravel + Water â†’ Mixing â†’ Pouring â†’ Curing â†’ Concrete',
        references:[{name:'Wikipedia',url:'https://en.wikipedia.org/wiki/Concrete'}] },
    ];

    let materialTypeFilter = '';
    let selectedMaterial = null;

    function renderMaterialPills() {
      const types = ['raw','processed','composite'];
      document.getElementById('material-type-pills').innerHTML =
        `<span class="filter-pill ${materialTypeFilter===''?'active':''}" onclick="materialTypeFilter='';renderMaterials()">All</span>` +
        types.map(t => `<span class="filter-pill ${materialTypeFilter===t?'active':''}" onclick="materialTypeFilter='${t}';renderMaterials()"><span class="material-type-badge mat-${t}">${t}</span></span>`).join('');
    }

    function renderMaterials() {
      renderMaterialPills();
      const filtered = MATERIALS.filter(m => !materialTypeFilter || m.type === materialTypeFilter);
      document.getElementById('materials-list').innerHTML = filtered.map(m => {
        const chain = m.processing.split('â†’').map(s => s.trim());
        const chainHtml = `<div class="processing-chain">${chain.map((s,i) => (i>0?'<span class="chain-arrow">â†’</span>':'')+`<span>${s}</span>`).join('')}</div>`;
        return `<div class="material-card" onclick="showMaterialDetail('${m.name.replace(/'/g,"\\'")}')">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.3rem;">
            <span style="font-weight:600;font-size:0.88rem;color:var(--text);">${m.name}</span>
            <span class="material-type-badge mat-${m.type}">${m.type}</span>
          </div>
          <div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.3rem;">${m.category}${m.components.length?' Â· From: '+m.components.join(', '):''}</div>
          ${chainHtml}
        </div>`;
      }).join('');
    }

    function showMaterialDetail(name) {
      const m = MATERIALS.find(x => x.name === name);
      if (!m) return;
      if (selectedMaterial === name) { selectedMaterial = null; document.getElementById('material-detail-slot').innerHTML = ''; return; }
      selectedMaterial = name;
      const propsHtml = Object.entries(m.properties).map(([k,v]) => `<div class="el-prop"><dt>${k.replace(/_/g,' ')}</dt><dd>${v}</dd></div>`).join('');
      const srcLinks = m.references.map(r => `<a href="${r.url}" target="_blank" rel="noopener" style="color:var(--accent);font-size:0.75rem;">${r.name} â†—</a>`).join(' ');
      document.getElementById('material-detail-slot').innerHTML = `
        <div class="element-detail">
          <div style="display:flex;justify-content:space-between;align-items:start;">
            <h3>${m.name} <span class="material-type-badge mat-${m.type}" style="vertical-align:middle;">${m.type}</span></h3>
            <button onclick="selectedMaterial=null;document.getElementById('material-detail-slot').innerHTML=''" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.1rem;">âœ•</button>
          </div>
          <div class="el-props">${propsHtml}</div>
          <div style="margin:0.6rem 0;"><strong style="font-size:0.75rem;color:var(--text-muted);">USES:</strong>
            <div style="display:flex;flex-wrap:wrap;gap:0.3rem;margin-top:0.3rem;">
              ${m.uses.map(u => `<span style="background:rgba(255,136,17,0.1);color:var(--accent);font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:10px;">${u}</span>`).join('')}
            </div>
          </div>
          <div style="margin:0.6rem 0;"><strong style="font-size:0.75rem;color:var(--text-muted);">PROCESSING:</strong>
            <div class="processing-chain" style="margin-top:0.3rem;font-size:0.8rem;">${m.processing.split('â†’').map((s,i) => (i>0?'<span class="chain-arrow">â†’</span>':'')+`<span>${s.trim()}</span>`).join('')}</div>
          </div>
          <div style="margin-top:0.5rem;">${srcLinks}</div>
        </div>`;
    }
    renderMaterials();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PERSONAL INVENTORY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const INV_CATEGORIES = [
      {id:'Vehicle',icon:'ğŸš—'},{id:'Clothing',icon:'ğŸ‘•'},{id:'Electronics',icon:'ğŸ’»'},{id:'Tools',icon:'ğŸ”§'},
      {id:'Furniture',icon:'ğŸª‘'},{id:'Kitchen',icon:'ğŸ³'},{id:'Books/Media',icon:'ğŸ“š'},{id:'Gaming',icon:'ğŸ®'},
      {id:'Home',icon:'ğŸ '},{id:'Other',icon:'ğŸ“¦'}
    ];

    (function populateInvCategories() {
      const sel = document.getElementById('inv-category');
      const filterSel = document.getElementById('inv-category-filter');
      INV_CATEGORIES.forEach(c => {
        sel.innerHTML += `<option value="${c.id}">${c.icon} ${c.id}</option>`;
        filterSel.innerHTML += `<option value="${c.id}">${c.icon} ${c.id}</option>`;
      });
    })();

    function loadInventory() { try { return JSON.parse(localStorage.getItem('humanity_inventory')) || []; } catch { return []; } }
    function saveInventory(items) { localStorage.setItem('humanity_inventory', JSON.stringify(items)); }

    function renderInventory() {
      const items = loadInventory();
      const catFilter = document.getElementById('inv-category-filter').value;
      const search = (document.getElementById('inv-search').value || '').toLowerCase();
      const filtered = items.filter(item => {
        if (catFilter && item.category !== catFilter) return false;
        if (search && !item.name.toLowerCase().includes(search) && !(item.tags||[]).some(t => t.toLowerCase().includes(search)) && !(item.category||'').toLowerCase().includes(search)) return false;
        return true;
      });
      const catIcon = (id) => (INV_CATEGORIES.find(c => c.id === id) || {icon:'ğŸ“¦'}).icon;
      document.getElementById('inventory-list').innerHTML = filtered.length === 0
        ? '<div style="color:var(--text-muted);font-size:0.82rem;font-style:italic;padding:1rem;text-align:center;grid-column:1/-1;">No items yet â€” click "+ Add Item" to start</div>'
        : filtered.map(item => `
          <div class="inv-item">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.3rem;">
              <span style="font-weight:600;font-size:0.88rem;">${catIcon(item.category)} ${escHtml(item.name)}</span>
              <div style="display:flex;gap:0.3rem;">
                <button onclick="listInventoryForSale('${item.id}')" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:0.65rem;" title="List for Sale">ğŸ“¢</button>
                <button onclick="editInventoryItem('${item.id}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.75rem;" title="Edit">âœï¸</button>
                <button onclick="deleteInventoryItem('${item.id}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.75rem;" title="Delete">ğŸ—‘ï¸</button>
              </div>
            </div>
            <div style="font-size:0.72rem;color:var(--text-muted);">
              ${item.category}${item.subcategory?' Â· '+escHtml(item.subcategory):''} Â· Qty: ${item.quantity||1} Â· ${item.condition||'Good'}
            </div>
            ${item.location?`<div style="font-size:0.7rem;color:var(--text-muted);margin-top:0.15rem;">ğŸ“ ${escHtml(item.location)}</div>`:''}
            ${item.description?`<div style="font-size:0.75rem;color:var(--text);margin-top:0.3rem;">${escHtml(item.description)}</div>`:''}
            ${(item.tags||[]).length?`<div style="display:flex;flex-wrap:wrap;gap:0.2rem;margin-top:0.3rem;">${item.tags.map(t=>`<span style="background:rgba(255,255,255,0.05);font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:8px;color:var(--text-muted);">#${escHtml(t)}</span>`).join('')}</div>`:''}
          </div>`).join('');
    }

    function openInventoryModal(editId) {
      document.getElementById('inv-modal-title').textContent = editId ? 'Edit Item' : 'Add Item';
      document.getElementById('inv-edit-id').value = editId || '';
      if (editId) {
        const item = loadInventory().find(i => i.id === editId);
        if (!item) return;
        document.getElementById('inv-name').value = item.name || '';
        document.getElementById('inv-category').value = item.category || 'Other';
        document.getElementById('inv-subcategory').value = item.subcategory || '';
        document.getElementById('inv-description').value = item.description || '';
        document.getElementById('inv-quantity').value = item.quantity || 1;
        document.getElementById('inv-condition').value = item.condition || 'Good';
        document.getElementById('inv-acquired').value = item.acquired || '';
        document.getElementById('inv-location').value = item.location || '';
        document.getElementById('inv-value').value = item.value || '';
        document.getElementById('inv-notes').value = item.notes || '';
        document.getElementById('inv-tags').value = (item.tags||[]).join(', ');
      } else {
        ['inv-name','inv-subcategory','inv-description','inv-acquired','inv-location','inv-value','inv-notes','inv-tags'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('inv-quantity').value = 1;
        document.getElementById('inv-condition').value = 'Good';
        document.getElementById('inv-category').value = 'Other';
      }
      document.getElementById('inv-modal').classList.add('open');
    }
    function closeInventoryModal() { document.getElementById('inv-modal').classList.remove('open'); }
    function editInventoryItem(id) { openInventoryModal(id); }
    function deleteInventoryItem(id) {
      if (!confirm('Delete this item?')) return;
      saveInventory(loadInventory().filter(i => i.id !== id));
      renderInventory();
    }
    function saveInventoryItem() {
      const name = document.getElementById('inv-name').value.trim();
      if (!name) { document.getElementById('inv-name').style.borderColor = '#e55'; return; }
      const editId = document.getElementById('inv-edit-id').value;
      const items = loadInventory();
      const item = {
        id: editId || Date.now().toString(36) + Math.random().toString(36).slice(2,6),
        name,
        category: document.getElementById('inv-category').value,
        subcategory: document.getElementById('inv-subcategory').value.trim(),
        description: document.getElementById('inv-description').value.trim(),
        quantity: parseInt(document.getElementById('inv-quantity').value) || 1,
        condition: document.getElementById('inv-condition').value,
        acquired: document.getElementById('inv-acquired').value.trim(),
        location: document.getElementById('inv-location').value.trim(),
        value: document.getElementById('inv-value').value.trim(),
        notes: document.getElementById('inv-notes').value.trim(),
        tags: document.getElementById('inv-tags').value.split(',').map(t => t.trim()).filter(Boolean),
      };
      if (editId) {
        const idx = items.findIndex(i => i.id === editId);
        if (idx >= 0) items[idx] = item; else items.push(item);
      } else {
        items.push(item);
      }
      saveInventory(items);
      closeInventoryModal();
      renderInventory();
    }

    function exportInventory() {
      const data = JSON.stringify(loadInventory(), null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'humanity-inventory-' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
    }
    function importInventory(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          if (!Array.isArray(imported)) throw new Error('Not an array');
          const existing = loadInventory();
          const merged = [...existing, ...imported.map(i => ({...i, id: i.id || Date.now().toString(36)+Math.random().toString(36).slice(2,6)}))];
          saveInventory(merged);
          renderInventory();
          alert('Imported ' + imported.length + ' items.');
        } catch(err) { alert('Import failed: ' + err.message); }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // Close inv modal on backdrop
    document.getElementById('inv-modal').addEventListener('click', function(e) { if (e.target === this) closeInventoryModal(); });

    renderInventory();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MARKETPLACE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const STORE_DIRECTORY = [
      { name: "Amazon", url: "https://amazon.com", icon: "ğŸª", category: "General", description: "Everything store" },
      { name: "Walmart", url: "https://walmart.com", icon: "ğŸª", category: "General", description: "Everyday low prices" },
      { name: "Etsy", url: "https://etsy.com", icon: "ğŸ¨", category: "Handmade & Vintage", description: "Handmade, vintage, and unique goods" },
      { name: "eBay", url: "https://ebay.com", icon: "ğŸ·ï¸", category: "Auctions & Resale", description: "Buy and sell anything" },
      { name: "Newegg", url: "https://newegg.com", icon: "ğŸ’»", category: "Electronics", description: "Computer hardware and electronics" },
      { name: "Home Depot", url: "https://homedepot.com", icon: "ğŸ”¨", category: "Home & Garden", description: "Home improvement and tools" },
      { name: "REI", url: "https://rei.com", icon: "â›º", category: "Outdoors", description: "Outdoor gear and clothing" },
      { name: "Steam", url: "https://store.steampowered.com", icon: "ğŸ®", category: "Gaming", description: "PC games and software" },
      { name: "GOG", url: "https://gog.com", icon: "ğŸ®", category: "Gaming", description: "DRM-free games" },
      { name: "Bandcamp", url: "https://bandcamp.com", icon: "ğŸµ", category: "Music", description: "Independent music" },
      { name: "Ko-fi", url: "https://ko-fi.com", icon: "â˜•", category: "Creator Support", description: "Support creators directly" },
      { name: "GitHub Sponsors", url: "https://github.com/sponsors", icon: "ğŸ’", category: "Creator Support", description: "Fund open source developers" },
    ];

    const LISTING_CATEGORIES = ['Electronics','Vehicles','Clothing','Tools','Furniture','Home','Books/Media','Gaming','Sports','Crafts','Food/Garden','Services','Other'];
    const LISTING_CONDITIONS = ['New','Like New','Good','Fair','Poor','N/A'];
    const CATEGORY_COLORS = {Electronics:'#08f',Vehicles:'#f80',Clothing:'#f0a',Tools:'#fa0',Furniture:'#a66',Home:'#4a8','Books/Media':'#84f',Gaming:'#0cf',Sports:'#4c4',Crafts:'#c4a','Food/Garden':'#6a4',Services:'#48f',Other:'#888'};

    let marketListings = [];
    let marketWs = null;
    let marketMyKey = null;
    let marketMyName = null;
    let marketMyRole = '';
    let marketCurrentSection = 'marketplace';

    function showMarketSection(section) {
      marketCurrentSection = section;
      ['marketplace','stores','mylistings'].forEach(s => {
        const el = document.getElementById('market-section-' + s);
        const btn = document.getElementById('market-nav-' + s);
        if (el) el.style.display = s === section ? '' : 'none';
        if (btn) btn.className = s === section ? 'btn btn-clickable' : 'btn';
      });
      const createBtn = document.getElementById('market-create-btn');
      if (createBtn) createBtn.style.display = (section === 'marketplace' && canCreateListing()) ? '' : 'none';
      if (section === 'stores') renderStoreDirectory();
      if (section === 'mylistings') renderMyListings();
      if (section === 'marketplace') renderMarketListings();
    }

    function canCreateListing() {
      return marketMyRole === 'verified' || marketMyRole === 'donor' || marketMyRole === 'mod' || marketMyRole === 'admin';
    }

    function marketConnect() {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      marketWs = new WebSocket(proto + '//' + location.host + '/ws');
      marketWs.onopen = () => {
        const storedKey = localStorage.getItem('humanity_key');
        const storedName = localStorage.getItem('humanity_name');
        if (storedKey) {
          marketMyKey = storedKey;
          marketMyName = storedName;
          marketWs.send(JSON.stringify({ type: 'identify', public_key: storedKey, display_name: storedName || null }));
        } else {
          marketMyKey = 'viewer_' + Math.random().toString(36).slice(2, 10);
          marketWs.send(JSON.stringify({ type: 'identify', public_key: marketMyKey, display_name: null }));
        }
      };
      marketWs.onmessage = (e) => {
        try {
          const msg = JSON.parse(e.data);
          handleMarketMessage(msg);
        } catch {}
      };
      marketWs.onclose = () => { setTimeout(marketConnect, 3000); };
      marketWs.onerror = () => {};
    }

    function handleMarketMessage(msg) {
      switch (msg.type) {
        case 'peer_list':
          if (msg.peers && marketMyKey) {
            const me = msg.peers.find(p => p.public_key === marketMyKey);
            if (me) {
              marketMyRole = me.role || '';
              marketMyName = me.display_name || marketMyName;
            }
          }
          updateMarketPermissions();
          // Request listings
          if (marketWs && marketWs.readyState === 1) {
            marketWs.send(JSON.stringify({ type: 'listing_browse' }));
          }
          break;
        case 'listing_list':
          marketListings = msg.listings || [];
          renderMarketListings();
          renderMyListings();
          break;
        case 'listing_new':
          if (msg.listing) {
            const existing = marketListings.findIndex(l => l.id === msg.listing.id);
            if (existing >= 0) marketListings[existing] = msg.listing;
            else marketListings.unshift(msg.listing);
            renderMarketListings();
            renderMyListings();
          }
          break;
        case 'listing_updated':
          if (msg.listing) {
            const idx = marketListings.findIndex(l => l.id === msg.listing.id);
            if (idx >= 0) marketListings[idx] = msg.listing;
            renderMarketListings();
            renderMyListings();
          }
          break;
        case 'listing_deleted':
          if (msg.id) {
            marketListings = marketListings.filter(l => l.id !== msg.id);
            renderMarketListings();
            renderMyListings();
          }
          break;
        case 'system':
          // Ignore system messages in market context
          break;
      }
    }

    function updateMarketPermissions() {
      const createBtn = document.getElementById('market-create-btn');
      if (createBtn) createBtn.style.display = (marketCurrentSection === 'marketplace' && canCreateListing()) ? '' : 'none';
    }

    function renderMarketListings() {
      const search = (document.getElementById('market-search').value || '').toLowerCase();
      const catFilter = document.getElementById('market-category-filter').value;
      const condFilter = document.getElementById('market-condition-filter').value;
      const sort = document.getElementById('market-sort').value;

      let filtered = marketListings.filter(l => {
        if (l.status !== 'active') return false;
        if (catFilter && l.category !== catFilter) return false;
        if (condFilter && l.condition !== condFilter) return false;
        if (search && !l.title.toLowerCase().includes(search) && !(l.description||'').toLowerCase().includes(search) && !(l.seller_name||'').toLowerCase().includes(search)) return false;
        return true;
      });

      if (sort === 'oldest') filtered.sort((a, b) => (a.created_at || '').localeCompare(b.created_at || ''));
      else if (sort === 'alpha') filtered.sort((a, b) => a.title.localeCompare(b.title));
      else filtered.sort((a, b) => (b.created_at || '').localeCompare(a.created_at || ''));

      const grid = document.getElementById('market-listings-grid');
      const empty = document.getElementById('market-listings-empty');
      if (filtered.length === 0) {
        grid.innerHTML = '';
        empty.style.display = '';
      } else {
        empty.style.display = 'none';
        grid.innerHTML = filtered.map(l => renderListingCard(l, false)).join('');
      }
    }

    function renderListingCard(l, showActions) {
      const catColor = CATEGORY_COLORS[l.category] || '#888';
      const isMine = l.seller_key === marketMyKey;
      const isAdmin = marketMyRole === 'admin' || marketMyRole === 'mod';
      const actions = (isMine || showActions) ? `
        <div style="display:flex;gap:0.3rem;margin-top:0.5rem;">
          ${isMine?`<button onclick="editListing('${l.id}')" style="flex:1;padding:0.25rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:4px;color:var(--text-muted);cursor:pointer;font-size:0.7rem;">âœï¸ Edit</button>`:''}
          ${isMine?`<button onclick="markListingSold('${l.id}')" style="flex:1;padding:0.25rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:4px;color:var(--success);cursor:pointer;font-size:0.7rem;">âœ… Sold</button>`:''}
          ${(isMine||isAdmin)?`<button onclick="deleteListing('${l.id}')" style="flex:1;padding:0.25rem;background:var(--bg-panel);border:1px solid var(--border);border-radius:4px;color:var(--error);cursor:pointer;font-size:0.7rem;">ğŸ—‘ï¸ Delete</button>`:''}
        </div>` : '';
      const statusBadge = l.status === 'sold' ? '<span style="background:#4a8;color:#fff;font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:4px;margin-left:0.3rem;">SOLD</span>' :
                          l.status === 'withdrawn' ? '<span style="background:#888;color:#fff;font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:4px;margin-left:0.3rem;">WITHDRAWN</span>' : '';
      return `
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:10px;overflow:hidden;cursor:pointer;transition:border-color 0.2s;" onmouseenter="this.style.borderColor='rgba(255,136,17,0.3)'" onmouseleave="this.style.borderColor='var(--border)'" onclick="showListingDetail('${l.id}')">
          <div style="height:120px;background:linear-gradient(135deg,rgba(255,255,255,0.02),rgba(255,255,255,0.06));display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:2rem;">ğŸ“¦</div>
          <div style="padding:0.8rem;">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.3rem;">
              <span style="font-weight:600;font-size:0.85rem;color:var(--text);flex:1;">${escHtml(l.title)}${statusBadge}</span>
            </div>
            <div style="font-size:0.95rem;font-weight:700;color:var(--accent);margin-bottom:0.3rem;">${escHtml(l.price || 'Contact for price')}</div>
            <div style="display:flex;gap:0.3rem;flex-wrap:wrap;margin-bottom:0.3rem;">
              <span style="background:${catColor}22;color:${catColor};font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:4px;">${escHtml(l.category)}</span>
              ${l.condition && l.condition !== 'N/A' ? `<span style="background:rgba(255,255,255,0.05);color:var(--text-muted);font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:4px;">${escHtml(l.condition)}</span>` : ''}
            </div>
            <div style="font-size:0.72rem;color:var(--text-muted);">by ${escHtml(l.seller_name || 'Anonymous')}</div>
            ${l.location ? `<div style="font-size:0.68rem;color:var(--text-muted);">ğŸ“ ${escHtml(l.location)}</div>` : ''}
            ${actions}
          </div>
        </div>`;
    }

    function showListingDetail(id) {
      const l = marketListings.find(x => x.id === id);
      if (!l) return;
      const isMine = l.seller_key === marketMyKey;
      const isAdmin = marketMyRole === 'admin' || marketMyRole === 'mod';
      const catColor = CATEGORY_COLORS[l.category] || '#888';
      const contactBtn = !isMine ? `<button onclick="contactSeller('${escHtml(l.seller_key)}','${escHtml(l.seller_name||'Seller')}');closeListingDetail()" style="width:100%;padding:0.6rem;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:0.9rem;font-weight:600;margin-top:1rem;">ğŸ’¬ Contact Seller</button>` : '';
      document.getElementById('listing-detail-content').innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:start;">
          <h2 style="color:var(--text);margin:0;font-size:1.1rem;">${escHtml(l.title)}</h2>
          <button onclick="closeListingDetail()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.2rem;">âœ•</button>
        </div>
        <div style="font-size:1.3rem;font-weight:700;color:var(--accent);margin:0.8rem 0;">${escHtml(l.price || 'Contact for price')}</div>
        <div style="display:flex;gap:0.4rem;flex-wrap:wrap;margin-bottom:0.8rem;">
          <span style="background:${catColor}22;color:${catColor};font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:4px;">${escHtml(l.category)}</span>
          ${l.condition ? `<span style="background:rgba(255,255,255,0.05);color:var(--text-muted);font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:4px;">${escHtml(l.condition)}</span>` : ''}
          ${l.status !== 'active' ? `<span style="background:${l.status==='sold'?'#4a8':'#888'};color:#fff;font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:4px;">${l.status.toUpperCase()}</span>` : ''}
        </div>
        ${l.description ? `<div style="font-size:0.85rem;color:var(--text);line-height:1.5;margin-bottom:0.8rem;white-space:pre-wrap;">${escHtml(l.description)}</div>` : ''}
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;font-size:0.8rem;color:var(--text-muted);">
          <div>ğŸ‘¤ <strong>${escHtml(l.seller_name || 'Anonymous')}</strong></div>
          ${l.location ? `<div>ğŸ“ ${escHtml(l.location)}</div>` : '<div></div>'}
          ${l.payment_methods ? `<div>ğŸ’³ ${escHtml(l.payment_methods)}</div>` : '<div></div>'}
          <div>ğŸ“… ${l.created_at ? new Date(l.created_at).toLocaleDateString() : 'Unknown'}</div>
        </div>
        ${contactBtn}
        ${isMine || isAdmin ? `
        <div style="display:flex;gap:0.5rem;margin-top:0.8rem;">
          ${isMine?`<button onclick="editListing('${l.id}');closeListingDetail()" class="btn" style="flex:1;min-width:auto;min-height:32px;padding:0.25rem;font-size:0.8rem;">âœï¸ Edit</button>`:''}
          ${isMine?`<button onclick="markListingSold('${l.id}');closeListingDetail()" class="btn" style="flex:1;min-width:auto;min-height:32px;padding:0.25rem;font-size:0.8rem;color:var(--success);">âœ… Mark Sold</button>`:''}
          <button onclick="deleteListing('${l.id}');closeListingDetail()" class="btn" style="flex:1;min-width:auto;min-height:32px;padding:0.25rem;font-size:0.8rem;color:var(--error);">ğŸ—‘ï¸ Delete</button>
        </div>` : ''}
      `;
      document.getElementById('listing-detail-modal').style.display = '';
    }

    function closeListingDetail() {
      document.getElementById('listing-detail-modal').style.display = 'none';
    }

    function contactSeller(sellerKey, sellerName) {
      // Navigate to chat and open DM â€” use chat's existing DM system
      // We'll switch to chat tab and trigger a DM open via stored intent
      localStorage.setItem('dm_intent', JSON.stringify({ key: sellerKey, name: sellerName }));
      window.location.href = '/chat';
    }

    function openListingModal(prefill) {
      if (!canCreateListing()) {
        alert('You must be verified to create listings. Ask an admin to verify you.');
        return;
      }
      document.getElementById('listing-modal-title').textContent = prefill && prefill.editId ? 'Edit Listing' : 'Create Listing';
      document.getElementById('listing-edit-id').value = (prefill && prefill.editId) || '';
      document.getElementById('listing-title').value = (prefill && prefill.title) || '';
      document.getElementById('listing-description').value = (prefill && prefill.description) || '';
      document.getElementById('listing-category').value = (prefill && prefill.category) || 'Other';
      document.getElementById('listing-condition').value = (prefill && prefill.condition) || 'Good';
      document.getElementById('listing-price').value = (prefill && prefill.price) || '';
      document.getElementById('listing-payment').value = (prefill && prefill.payment_methods) || '';
      document.getElementById('listing-location').value = (prefill && prefill.location) || '';
      document.getElementById('listing-modal').style.display = '';
    }

    function closeListingModal() {
      document.getElementById('listing-modal').style.display = 'none';
    }

    function submitListing() {
      const title = document.getElementById('listing-title').value.trim();
      if (!title) { document.getElementById('listing-title').style.borderColor = '#e55'; return; }
      const editId = document.getElementById('listing-edit-id').value;
      const data = {
        title,
        description: document.getElementById('listing-description').value.trim(),
        category: document.getElementById('listing-category').value,
        condition: document.getElementById('listing-condition').value,
        price: document.getElementById('listing-price').value.trim(),
        payment_methods: document.getElementById('listing-payment').value.trim(),
        location: document.getElementById('listing-location').value.trim(),
      };
      if (editId) {
        data.id = editId;
        if (marketWs && marketWs.readyState === 1) {
          marketWs.send(JSON.stringify({ type: 'listing_update', ...data }));
        }
      } else {
        data.id = Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
        if (marketWs && marketWs.readyState === 1) {
          marketWs.send(JSON.stringify({ type: 'listing_create', ...data }));
        }
      }
      closeListingModal();
    }

    function editListing(id) {
      const l = marketListings.find(x => x.id === id);
      if (!l) return;
      openListingModal({
        editId: l.id,
        title: l.title,
        description: l.description,
        category: l.category,
        condition: l.condition,
        price: l.price,
        payment_methods: l.payment_methods,
        location: l.location,
      });
    }

    function markListingSold(id) {
      if (!confirm('Mark this listing as sold?')) return;
      if (marketWs && marketWs.readyState === 1) {
        const l = marketListings.find(x => x.id === id);
        if (l) marketWs.send(JSON.stringify({ type: 'listing_update', id, title: l.title, description: l.description, category: l.category, condition: l.condition, price: l.price, payment_methods: l.payment_methods, location: l.location, status: 'sold' }));
      }
    }

    function deleteListing(id) {
      if (!confirm('Delete this listing?')) return;
      if (marketWs && marketWs.readyState === 1) {
        marketWs.send(JSON.stringify({ type: 'listing_delete', id }));
      }
    }

    function renderMyListings() {
      const mine = marketListings.filter(l => l.seller_key === marketMyKey);
      const grid = document.getElementById('my-listings-grid');
      const empty = document.getElementById('my-listings-empty');
      if (mine.length === 0) {
        grid.innerHTML = '';
        empty.style.display = '';
      } else {
        empty.style.display = 'none';
        grid.innerHTML = mine.map(l => renderListingCard(l, true)).join('');
      }
    }

    // Store Directory
    function renderStoreDirectory() {
      const filter = document.getElementById('store-category-filter').value;
      const filtered = filter ? STORE_DIRECTORY.filter(s => s.category === filter) : STORE_DIRECTORY;
      document.getElementById('store-directory-grid').innerHTML = filtered.map(s => `
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:1rem;transition:border-color 0.2s;" onmouseenter="this.style.borderColor='rgba(255,136,17,0.3)'" onmouseleave="this.style.borderColor='var(--border)'">
          <div style="font-size:1.5rem;margin-bottom:0.4rem;">${s.icon}</div>
          <div style="font-weight:600;font-size:0.9rem;color:var(--text);margin-bottom:0.2rem;">${escHtml(s.name)}</div>
          <div style="font-size:0.7rem;color:var(--text-muted);margin-bottom:0.4rem;">${escHtml(s.category)}</div>
          <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.6rem;">${escHtml(s.description)}</div>
          <a href="${s.url}" target="_blank" rel="noopener" style="display:inline-block;padding:0.3rem 0.8rem;background:var(--accent);color:#fff;border-radius:6px;text-decoration:none;font-size:0.75rem;font-weight:600;">Visit Store â†’</a>
        </div>`).join('');
    }

    // Populate store category filter
    (function() {
      const cats = [...new Set(STORE_DIRECTORY.map(s => s.category))];
      const sel = document.getElementById('store-category-filter');
      cats.forEach(c => { sel.innerHTML += `<option value="${escHtml(c)}">${escHtml(c)}</option>`; });
    })();

    // Inventory â†’ Listing bridge
    function listInventoryForSale(itemId) {
      const item = loadInventory().find(i => i.id === itemId);
      if (!item) return;
      // Map inventory category to marketplace category
      const catMap = {'Vehicle':'Vehicles','Clothing':'Clothing','Electronics':'Electronics','Tools':'Tools','Furniture':'Furniture','Kitchen':'Home','Books/Media':'Books/Media','Gaming':'Gaming','Home':'Home','Other':'Other'};
      const category = catMap[item.category] || 'Other';
      // Switch to market tab
      switchTab('market');
      showMarketSection('marketplace');
      openListingModal({
        title: item.name,
        description: (item.description || '') + (item.notes ? '\n\n' + item.notes : ''),
        category: category,
        condition: item.condition || 'Good',
      });
    }

    // Connect marketplace WS when market tab is shown
    let marketConnected = false;
    // Use a MutationObserver on the tab to detect when it becomes active
    const marketTabEl = document.getElementById('tab-market');
    if (marketTabEl) {
      new MutationObserver(() => {
        if (marketTabEl.classList.contains('active') && !marketConnected) {
          marketConnected = true;
          marketConnect();
        }
      }).observe(marketTabEl, { attributes: true, attributeFilter: ['class'] });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UNIVERSAL SEARCH
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function universalSearch(query) {
      const results = document.getElementById('universal-search-results');
      if (!query || query.length < 2) { results.innerHTML = ''; return; }
      const q = query.toLowerCase();
      const hits = [];
      // Elements
      ELEMENTS.filter(e => e.name.toLowerCase().includes(q) || e.symbol.toLowerCase().includes(q) || String(e.number).includes(q))
        .forEach(e => hits.push({ label: `${e.symbol} â€” ${e.name} (#${e.number})`, badge: 'Element', color: '#4caf50', action: () => { showElementDetail(e.symbol); } }));
      // Materials
      MATERIALS.filter(m => m.name.toLowerCase().includes(q) || m.category.toLowerCase().includes(q))
        .forEach(m => hits.push({ label: m.name + ' (' + m.type + ')', badge: 'Material', color: '#42a5f5', action: () => { showMaterialDetail(m.name); } }));
      // Inventory
      loadInventory().filter(i => i.name.toLowerCase().includes(q) || (i.category||'').toLowerCase().includes(q) || (i.tags||[]).some(t => t.toLowerCase().includes(q)))
        .forEach(i => hits.push({ label: i.name + (i.category ? ' Â· ' + i.category : ''), badge: 'Inventory', color: '#ffa726', action: () => { editInventoryItem(i.id); } }));
      results.innerHTML = hits.length === 0 ? '<div style="padding:0.8rem;text-align:center;font-size:0.82rem;color:var(--text-muted);">No results</div>'
        : hits.slice(0, 20).map((h, i) => `<div class="catalog-result-item" onclick="universalSearchResults[${i}]()">
            <span class="catalog-result-badge" style="background:${h.color}22;color:${h.color};">${h.badge}</span>
            <span style="color:var(--text);">${escHtml(h.label)}</span>
          </div>`).join('');
      window.universalSearchResults = hits.slice(0, 20).map(h => h.action);
    }

    // â”€â”€ TODO â”€â”€
    function loadTodos() {
      try { return JSON.parse(localStorage.getItem('humanity_todos')) || []; } catch { return []; }
    }
    function saveTodos(todos) { localStorage.setItem('humanity_todos', JSON.stringify(todos)); }

    function renderTodos() {
      const todos = loadTodos();
      const list = document.getElementById('todo-list');
      const active = todos.filter(t => !t.completed);
      const done = todos.filter(t => t.completed);
      const sorted = [...active, ...done];
      list.innerHTML = sorted.length === 0 ? '<div style="color:var(--text-muted);font-size:0.8rem;font-style:italic;padding:0.5rem;">No tasks yet</div>' : '';
      sorted.forEach(t => {
        const div = document.createElement('div');
        div.className = 'todo-item' + (t.completed ? ' completed' : '');
        div.innerHTML = `<input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleTodo('${t.id}')"><span class="todo-text">${escHtml(t.text)}</span><button class="todo-delete" onclick="deleteTodo('${t.id}')" title="Delete">âœ•</button>`;
        list.appendChild(div);
      });
    }

    function addTodo() {
      const input = document.getElementById('todo-input');
      const text = input.value.trim();
      if (!text) return;
      const todos = loadTodos();
      todos.push({ id: Date.now().toString(36), text, completed: false, createdAt: new Date().toISOString() });
      saveTodos(todos);
      input.value = '';
      renderTodos();
    }

    function toggleTodo(id) {
      const todos = loadTodos();
      const t = todos.find(x => x.id === id);
      if (t) t.completed = !t.completed;
      saveTodos(todos);
      renderTodos();
    }

    function deleteTodo(id) {
      saveTodos(loadTodos().filter(x => x.id !== id));
      renderTodos();
    }

    // â”€â”€ NOTES â”€â”€
    let currentNoteId = null;

    function loadNotes() {
      try { return JSON.parse(localStorage.getItem('humanity_notes')) || []; } catch { return []; }
    }
    function saveNotes(notes) { localStorage.setItem('humanity_notes', JSON.stringify(notes)); }

    function renderNotes() {
      const notes = loadNotes();
      const list = document.getElementById('notes-list');
      list.innerHTML = notes.length === 0 ? '<div style="color:var(--text-muted);font-size:0.8rem;font-style:italic;padding:0.3rem;">No notes yet</div>' : '';
      notes.forEach(n => {
        const div = document.createElement('div');
        div.className = 'note-item' + (n.id === currentNoteId ? ' active' : '');
        div.innerHTML = `<span onclick="selectNote('${n.id}')">${escHtml(n.title || 'Untitled')}</span><button class="note-delete" onclick="event.stopPropagation();deleteNote('${n.id}')" title="Delete">âœ•</button>`;
        div.querySelector('span').style.flex = '1';
        div.querySelector('span').style.cursor = 'pointer';
        list.appendChild(div);
      });
    }

    function addNote() {
      const notes = loadNotes();
      const id = Date.now().toString(36);
      notes.unshift({ id, title: '', content: '', updatedAt: new Date().toISOString() });
      saveNotes(notes);
      selectNote(id);
    }

    function selectNote(id) {
      currentNoteId = id;
      const notes = loadNotes();
      const note = notes.find(n => n.id === id);
      const editor = document.getElementById('notes-editor');
      if (note) {
        document.getElementById('note-title').value = note.title;
        document.getElementById('note-content').value = note.content;
        editor.style.display = 'block';
      }
      renderNotes();
    }

    function saveCurrentNote() {
      if (!currentNoteId) return;
      const notes = loadNotes();
      const note = notes.find(n => n.id === currentNoteId);
      if (note) {
        note.title = document.getElementById('note-title').value;
        note.content = document.getElementById('note-content').value;
        note.updatedAt = new Date().toISOString();
        saveNotes(notes);
        renderNotes();
      }
    }

    function deleteNote(id) {
      saveNotes(loadNotes().filter(n => n.id !== id));
      if (currentNoteId === id) {
        currentNoteId = null;
        document.getElementById('notes-editor').style.display = 'none';
      }
      renderNotes();
    }

    // â”€â”€ GARDEN â”€â”€
    function loadGarden() {
      try { return JSON.parse(localStorage.getItem('humanity_garden')) || { size: 4, plots: {} }; } catch { return { size: 4, plots: {} }; }
    }
    function saveGarden(g) { localStorage.setItem('humanity_garden', JSON.stringify(g)); }

    function renderGarden() {
      const g = loadGarden();
      const grid = document.getElementById('garden-grid');
      const sizeSelect = document.getElementById('garden-size');
      sizeSelect.value = g.size || 4;
      grid.style.gridTemplateColumns = `repeat(${g.size}, 1fr)`;
      grid.innerHTML = '';
      for (let i = 0; i < g.size * g.size; i++) {
        const plot = document.createElement('div');
        const data = g.plots[i];
        plot.className = 'garden-plot' + (data ? ' planted' : '');
        plot.textContent = data ? data.plant : 'ğŸŒ±';
        plot.title = data ? `${data.plant}${data.planted ? '\nPlanted: ' + data.planted : ''}` : 'Empty plot â€” click to plant';
        plot.onclick = () => editPlot(i);
        grid.appendChild(plot);
      }
    }

    function editPlot(index) {
      const g = loadGarden();
      const existing = g.plots[index];
      const plant = prompt('What is planted here?' + (existing ? ' (clear to remove)' : ''), existing ? existing.plant : '');
      if (plant === null) return;
      if (plant.trim() === '') {
        delete g.plots[index];
      } else {
        const planted = existing ? existing.planted : new Date().toISOString().split('T')[0];
        g.plots[index] = { plant: plant.trim(), planted };
      }
      saveGarden(g);
      renderGarden();
    }

    function resizeGarden() {
      const g = loadGarden();
      g.size = parseInt(document.getElementById('garden-size').value) || 4;
      saveGarden(g);
      renderGarden();
    }

    function escHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    // Init reality tab
    renderTodos();
    renderNotes();
    renderGarden();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FANTASY TAB
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â”€â”€ Card collapse (reuse pattern) â”€â”€
    function toggleFantasyCard(id) {
      const card = document.getElementById('fantasy-' + id);
      if (card) card.classList.toggle('collapsed');
      localStorage.setItem('fantasy_collapsed_' + id, card.classList.contains('collapsed'));
    }
    ['worldmap', 'character', 'lore', 'achievements'].forEach(id => {
      if (localStorage.getItem('fantasy_collapsed_' + id) === 'true') {
        const card = document.getElementById('fantasy-' + id);
        if (card) card.classList.add('collapsed');
      }
    });

    // â”€â”€ World Map (procedural grid) â”€â”€
    (function drawWorldMap() {
      const canvas = document.getElementById('world-map-canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      // Seed-based pseudo-random
      let seed = 42;
      function rng() { seed = (seed * 16807 + 0) % 2147483647; return (seed - 1) / 2147483646; }

      // Draw terrain grid
      const cellSize = 8;
      const cols = Math.ceil(w / cellSize), rows = Math.ceil(h / cellSize);
      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          const v = rng();
          const cx = x / cols, cy = y / rows;
          const dist = Math.sqrt((cx - 0.5) ** 2 + (cy - 0.5) ** 2);
          if (v < 0.15 + dist * 0.3) {
            // water
            const b = Math.floor(40 + rng() * 30);
            ctx.fillStyle = `rgb(${5+Math.floor(rng()*10)},${10+Math.floor(rng()*15)},${b})`;
          } else if (v < 0.5) {
            // land
            const g = Math.floor(25 + rng() * 35);
            ctx.fillStyle = `rgb(${8+Math.floor(rng()*12)},${g},${8+Math.floor(rng()*10)})`;
          } else if (v < 0.75) {
            // highlands
            const g = Math.floor(35 + rng() * 20);
            ctx.fillStyle = `rgb(${15+Math.floor(rng()*10)},${g},${20+Math.floor(rng()*10)})`;
          } else {
            // mountains
            const g = Math.floor(20 + rng() * 15);
            ctx.fillStyle = `rgb(${g},${g},${g+5})`;
          }
          ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
        }
      }
      // Overlay fog
      const grad = ctx.createRadialGradient(w/2, h/2, w*0.15, w/2, h/2, w*0.5);
      grad.addColorStop(0, 'rgba(10,10,26,0)');
      grad.addColorStop(1, 'rgba(10,10,26,0.85)');
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, w, h);
      // Label
      ctx.font = '14px sans-serif';
      ctx.fillStyle = 'rgba(153,102,255,0.6)';
      ctx.textAlign = 'center';
      ctx.fillText('âš” Terra Incognita âš”', w/2, h/2);
    })();

    // â”€â”€ Character Sheet â”€â”€
    function loadCharacter() {
      try { return JSON.parse(localStorage.getItem('humanity_character')); } catch { return null; }
    }
    function saveCharacter(c) { localStorage.setItem('humanity_character', JSON.stringify(c)); }

    function rollStats() {
      const roll = () => Math.floor(Math.random() * 16) + 3; // 3-18
      return { Strength: roll(), Intelligence: roll(), Dexterity: roll(), Charisma: roll() };
    }

    function renderCharacter() {
      const c = loadCharacter();
      const create = document.getElementById('char-create');
      const display = document.getElementById('char-display');
      if (!c) {
        create.style.display = 'block';
        display.style.display = 'none';
        return;
      }
      create.style.display = 'none';
      display.style.display = 'block';
      const classIcons = { Explorer: 'ğŸ§­', Builder: 'ğŸ”¨', Scholar: 'ğŸ“š', Guardian: 'ğŸ›¡ï¸' };
      document.getElementById('char-d-name').textContent = c.name;
      document.getElementById('char-d-class').textContent = (classIcons[c.class] || '') + ' ' + c.class;
      document.getElementById('char-d-level').textContent = 'Lv. ' + (c.level || 1);
      const statsEl = document.getElementById('char-stats');
      const statColors = { Strength: '#e55', Intelligence: '#58f', Dexterity: '#4c8', Charisma: '#eb4' };
      statsEl.innerHTML = Object.entries(c.stats).map(([k, v]) => {
        const pct = ((v - 3) / 15 * 100).toFixed(0);
        return `<div style="background:var(--bg-input);border-radius:6px;padding:0.35rem 0.5rem;">
          <div style="display:flex;justify-content:space-between;font-size:0.75rem;margin-bottom:0.2rem;">
            <span style="color:var(--text-muted);">${k}</span><span style="color:${statColors[k]||'var(--text)'};font-weight:700;">${v}</span>
          </div>
          <div style="background:var(--bg);border-radius:3px;height:4px;overflow:hidden;">
            <div style="width:${pct}%;height:100%;background:${statColors[k]||'var(--accent)'};border-radius:3px;"></div>
          </div>
        </div>`;
      }).join('');

      // Auto-unlock achievements
      checkAchievements();
    }

    function createCharacter() {
      const name = document.getElementById('char-name-input').value.trim();
      if (!name) { document.getElementById('char-name-input').style.borderColor = '#e55'; return; }
      const cls = document.getElementById('char-class-input').value;
      saveCharacter({ name, class: cls, level: 1, stats: rollStats(), createdAt: new Date().toISOString() });
      renderCharacter();
      // Unlock achievement
      unlockAchievement('character_created');
    }

    function rerollStats() {
      const c = loadCharacter();
      if (!c) return;
      c.stats = rollStats();
      saveCharacter(c);
      renderCharacter();
    }

    function deleteCharacter() {
      if (!confirm('Delete your character? This cannot be undone.')) return;
      localStorage.removeItem('humanity_character');
      renderCharacter();
    }

    renderCharacter();

    // â”€â”€ Lore / Codex â”€â”€
    const LORE_ENTRIES = [
      {
        title: 'ğŸŒ… The Awakening',
        text: 'Before the Network, humanity existed in silos â€” each mind an island, separated by distance, language, and power structures designed to keep them apart. The first spark came not from technology, but from a simple idea: what if we actually cooperated?'
      },
      {
        title: 'ğŸ”— The Accord',
        text: 'The Humanity Accord is not a contract â€” it\'s a promise. Every node in the network agrees to three principles: Transparency in governance, equity in access, and cooperation over competition. Those who sign the Accord don\'t just join a network â€” they join a movement.'
      },
      {
        title: 'ğŸŒŒ The Long Road',
        text: 'The destination was always the stars. But first, humanity had to learn to talk to itself. The Humanity Network is the foundation â€” a mesh of minds, resources, and purpose. From chat rooms to space stations, every great journey begins with "hello."'
      },
      {
        title: 'ğŸ›¡ï¸ The Guardians',
        text: 'Not every force in the world welcomes cooperation. The Guardians are those who protect the network â€” not with weapons, but with code, with vigilance, with the simple act of refusing to let the dream die. They moderate, they build, they hold the line.'
      },
      {
        title: 'ğŸ“¡ The Relay',
        text: 'Messages travel through the Relay â€” a decentralized web of servers that carry humanity\'s voice. No single point of failure, no single point of control. When one relay falls, others rise. The network remembers, even when individuals forget.'
      }
    ];

    function renderLore() {
      const container = document.getElementById('lore-entries');
      container.innerHTML = LORE_ENTRIES.map((entry, i) => `
        <details style="background:var(--bg-input);border-radius:6px;padding:0.1rem 0.6rem;" ${i === 0 ? 'open' : ''}>
          <summary style="cursor:pointer;font-weight:600;font-size:0.85rem;color:var(--text);padding:0.4rem 0;user-select:none;list-style:none;">
            ${entry.title}
          </summary>
          <p style="font-size:0.82rem;color:var(--text-muted);line-height:1.6;padding:0 0 0.5rem;">${entry.text}</p>
        </details>
      `).join('');
    }
    renderLore();

    // â”€â”€ Achievements â”€â”€
    const ACHIEVEMENTS = [
      { id: 'first_steps', icon: 'ğŸ‘£', name: 'First Steps', desc: 'Visited the Humanity Hub', auto: true },
      { id: 'character_created', icon: 'âš”ï¸', name: 'Born Anew', desc: 'Created a character' },
      { id: 'voice_of_people', icon: 'ğŸ“¢', name: 'Voice of the People', desc: 'Sent your first message' },
      { id: 'gardener', icon: 'ğŸŒ±', name: 'Green Thumb', desc: 'Planted something in your garden' },
      { id: 'note_taker', icon: 'ğŸ“', name: 'Scribe', desc: 'Created your first note' },
      { id: 'explorer', icon: 'ğŸ§­', name: 'Explorer', desc: 'Visited all hub tabs' },
      { id: 'lore_reader', icon: 'ğŸ“œ', name: 'Lorekeeper', desc: 'Read all codex entries' },
      { id: 'customizer', icon: 'ğŸ¨', name: 'Fashionista', desc: 'Changed your accent color' },
      { id: 'night_owl', icon: 'ğŸ¦‰', name: 'Night Owl', desc: 'Online past midnight' },
      { id: 'streamer', icon: 'ğŸ¥', name: 'Camera Ready', desc: 'Tested screen/camera capture' },
      { id: 'completionist', icon: 'ğŸ’', name: 'Completionist', desc: 'Unlock all other achievements' },
      { id: 'secret', icon: 'ğŸ”®', name: '???', desc: 'A secret achievementâ€¦' },
    ];

    function loadAchievements() {
      try { return JSON.parse(localStorage.getItem('humanity_achievements')) || []; } catch { return []; }
    }
    function saveAchievements(a) { localStorage.setItem('humanity_achievements', JSON.stringify(a)); }

    function unlockAchievement(id) {
      const unlocked = loadAchievements();
      if (unlocked.includes(id)) return;
      unlocked.push(id);
      saveAchievements(unlocked);
      renderAchievements();
    }

    function checkAchievements() {
      // Auto-unlock based on conditions
      unlockAchievement('first_steps');
      if (localStorage.getItem('humanity_character')) unlockAchievement('character_created');
      if (localStorage.getItem('humanity_name')) unlockAchievement('voice_of_people');
      const garden = (() => { try { return JSON.parse(localStorage.getItem('humanity_garden')); } catch { return null; } })();
      if (garden && garden.plots && Object.keys(garden.plots).length > 0) unlockAchievement('gardener');
      const notes = (() => { try { return JSON.parse(localStorage.getItem('humanity_notes')); } catch { return []; } })();
      if (notes.length > 0) unlockAchievement('note_taker');
      const settings = (() => { try { return JSON.parse(localStorage.getItem('humanity_settings')); } catch { return {}; } })();
      if (settings.accent && settings.accent !== '#FF8811') unlockAchievement('customizer');
      if (new Date().getHours() >= 0 && new Date().getHours() < 5) unlockAchievement('night_owl');
    }

    function renderAchievements() {
      const unlocked = loadAchievements();
      const grid = document.getElementById('achievement-grid');
      grid.innerHTML = ACHIEVEMENTS.map(a => {
        const isUnlocked = unlocked.includes(a.id);
        return `<div style="background:${isUnlocked ? 'rgba(153,102,255,0.1)' : 'var(--bg-input)'};border:1px solid ${isUnlocked ? 'rgba(153,102,255,0.3)' : 'var(--border)'};border-radius:8px;padding:0.5rem;text-align:center;transition:border-color 0.2s;" title="${a.desc}">
          <div style="font-size:1.5rem;${isUnlocked ? '' : 'filter:grayscale(1) brightness(0.4);'}">${a.icon}</div>
          <div style="font-size:0.72rem;font-weight:600;color:${isUnlocked ? 'var(--text)' : 'var(--text-muted)'};margin-top:0.2rem;">${isUnlocked ? a.name : 'ğŸ”’ Locked'}</div>
          <div style="font-size:0.6rem;color:var(--text-muted);margin-top:0.1rem;">${a.desc}</div>
        </div>`;
      }).join('');
    }
    checkAchievements();
    renderAchievements();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STREAMS TAB
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function toggleStreamsCard(id) {
      const card = document.getElementById('streams-' + id);
      if (card) card.classList.toggle('collapsed');
      localStorage.setItem('streams_collapsed_' + id, card.classList.contains('collapsed'));
    }
    ['howitworks', 'golive', 'live', 'servers'].forEach(id => {
      if (localStorage.getItem('streams_collapsed_' + id) === 'true') {
        const card = document.getElementById('streams-' + id);
        if (card) card.classList.add('collapsed');
      }
    });

    let captureStream = null;

    async function startCapture(type) {
      try {
        stopCapture();
        if (type === 'camera') {
          captureStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        } else {
          captureStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
        }
        const video = document.getElementById('capture-preview');
        video.srcObject = captureStream;
        video.style.display = 'block';
        document.getElementById('capture-status').innerHTML = '<span style="color:#4a8;">â— Capturing ' + type + '</span> â€” local preview only, not streaming anywhere.';
        document.getElementById('capture-stop-btn').style.display = 'inline-flex';
        document.getElementById('capture-stop-btn').classList.remove('btn-disabled');
        document.getElementById('capture-stop-btn').classList.add('btn-activated');

        // Track end
        captureStream.getTracks().forEach(t => t.onended = () => stopCapture());

        // Unlock achievement
        unlockAchievement('streamer');
      } catch (e) {
        document.getElementById('capture-status').innerHTML = '<span style="color:#e55;">âš  ' + (e.name === 'NotAllowedError' ? 'Permission denied' : e.message) + '</span>';
      }
    }

    function stopCapture() {
      if (captureStream) {
        captureStream.getTracks().forEach(t => t.stop());
        captureStream = null;
      }
      const video = document.getElementById('capture-preview');
      if (video) { video.srcObject = null; video.style.display = 'none'; }
      const status = document.getElementById('capture-status');
      if (status) status.textContent = '';
      const stopBtn = document.getElementById('capture-stop-btn');
      if (stopBtn) { stopBtn.style.display = 'none'; }
    }

    // Track tab visits for explorer achievement
    const visitedTabs = JSON.parse(localStorage.getItem('humanity_visited_tabs') || '[]');
    const origSwitchTab = switchTab;
    switchTab = function(tabId, pushState) {
      origSwitchTab(tabId, pushState);
      if (!visitedTabs.includes(tabId)) {
        visitedTabs.push(tabId);
        localStorage.setItem('humanity_visited_tabs', JSON.stringify(visitedTabs));
      }
      if (['reality', 'fantasy', 'streams', 'debug'].every(t => visitedTabs.includes(t))) {
        unlockAchievement('explorer');
      }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PROJECT BOARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let boardTasks = [];
    let boardWs = null;
    let boardMyKey = null;
    let boardMyRole = '';

    const PRIORITY_COLORS = { critical: '#e55', high: '#f80', medium: '#eb4', low: '#666' };
    const STATUS_LABELS = { backlog: 'ğŸ“¥ Backlog', in_progress: 'ğŸ”§ In Progress', testing: 'ğŸ§ª Testing', done: 'âœ… Done' };
    const VALID_STATUSES = ['backlog', 'in_progress', 'testing', 'done'];

    const API_BASE = 'https://united-humanity.us';

    function boardConnect() {
      // Always try REST API first (reliable, works everywhere)
      fetch(API_BASE + '/api/tasks').then(r => r.json()).then(data => {
        if (data.tasks && data.tasks.length > 0) {
          boardTasks = data.tasks;
          renderBoard();
        }
      }).catch(e => console.warn('Board REST fetch failed:', e));

      // Also connect WebSocket for real-time updates
      try {
        const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = location.host || 'united-humanity.us';
        boardWs = new WebSocket(proto + '//' + host + '/ws');
        boardWs.onopen = () => {
          const storedKey = localStorage.getItem('humanity_key');
          const storedName = localStorage.getItem('humanity_name');
          if (storedKey) {
            boardMyKey = storedKey;
            boardWs.send(JSON.stringify({ type: 'identify', public_key: storedKey, display_name: storedName || null }));
          } else {
            boardMyKey = 'viewer_' + Math.random().toString(36).slice(2, 10);
            boardWs.send(JSON.stringify({ type: 'identify', public_key: boardMyKey, display_name: null }));
          }
        };
        boardWs.onmessage = (e) => {
          try {
            const msg = JSON.parse(e.data);
            handleBoardMessage(msg);
          } catch {}
        };
        boardWs.onclose = () => { setTimeout(boardConnect, 5000); };
        boardWs.onerror = () => {};
      } catch (e) { console.warn('Board WS failed:', e); }
    }

    function handleBoardMessage(msg) {
      switch (msg.type) {
        case 'peer_list':
          // Extract our role from peer list
          if (msg.peers && boardMyKey) {
            const me = msg.peers.find(p => p.public_key === boardMyKey);
            if (me) boardMyRole = me.role || '';
          }
          updateBoardPermissions();
          // Request task list
          if (boardWs && boardWs.readyState === 1) {
            boardWs.send(JSON.stringify({ type: 'task_list' }));
          }
          break;
        case 'task_list_response':
          boardTasks = msg.tasks || [];
          renderBoard();
          break;
        case 'task_created':
          if (msg.task) {
            boardTasks.push(msg.task);
            renderBoard();
          }
          break;
        case 'task_updated':
          if (msg.task) {
            const idx = boardTasks.findIndex(t => t.id === msg.task.id);
            if (idx >= 0) boardTasks[idx] = msg.task;
            else boardTasks.push(msg.task);
            renderBoard();
          }
          break;
        case 'task_moved':
          if (msg.id != null && msg.status) {
            const t = boardTasks.find(t => t.id === msg.id);
            if (t) t.status = msg.status;
            renderBoard();
          }
          break;
        case 'task_deleted':
          if (msg.id != null) {
            boardTasks = boardTasks.filter(t => t.id !== msg.id);
            renderBoard();
          }
          break;
        case 'task_comment_added':
          if (msg.task_id != null) {
            const t = boardTasks.find(t => t.id === msg.task_id);
            if (t) t.comment_count = (t.comment_count || 0) + 1;
            renderBoard();
            // If modal is open for this task, append comment
            const modalEl = document.getElementById('task-modal-content');
            if (modalEl && modalEl.dataset.taskId == msg.task_id && msg.comment) {
              const commentsDiv = document.getElementById('task-comments-list');
              if (commentsDiv) {
                commentsDiv.innerHTML += renderCommentHtml(msg.comment);
              }
            }
          }
          break;
        case 'task_comments_response':
          if (msg.task_id != null) {
            const commentsDiv = document.getElementById('task-comments-list');
            if (commentsDiv && commentsDiv.dataset.taskId == msg.task_id) {
              commentsDiv.innerHTML = (msg.comments || []).map(renderCommentHtml).join('') || '<div style="color:var(--text-muted);font-size:0.8rem;font-style:italic;">No comments yet</div>';
            }
          }
          break;
      }
    }

    function updateBoardPermissions() {
      const canEdit = boardMyRole === 'admin' || boardMyRole === 'mod';
      const btn = document.getElementById('board-create-btn');
      if (btn) btn.style.display = canEdit ? 'inline-flex' : 'none';
    }

    function renderBoard() {
      document.getElementById('board-loading').style.display = 'none';
      VALID_STATUSES.forEach(status => {
        const container = document.querySelector('.board-col-cards[data-status="' + status + '"]');
        const countEl = document.querySelector('.board-col-count[data-status="' + status + '"]');
        if (!container) return;
        const tasks = boardTasks.filter(t => t.status === status).sort((a, b) => a.position - b.position);
        if (countEl) countEl.textContent = '(' + tasks.length + ')';
        container.innerHTML = tasks.map(t => renderTaskCard(t)).join('');
      });
    }

    function renderTaskCard(task) {
      const pc = PRIORITY_COLORS[task.priority] || '#666';
      const labels = (() => { try { return JSON.parse(task.labels || '[]'); } catch { return []; } })();
      const labelHtml = labels.map(l => '<span style="display:inline-block;background:rgba(255,136,17,0.15);color:var(--accent);font-size:0.6rem;padding:0.1rem 0.4rem;border-radius:3px;margin-right:0.2rem;">' + escHtml(l) + '</span>').join('');
      const assigneeHtml = task.assignee ? '<span style="font-size:0.7rem;color:var(--text-muted);">ğŸ‘¤ ' + escHtml(task.assignee) + '</span>' : '';
      const commentHtml = task.comment_count > 0 ? '<span style="font-size:0.7rem;color:var(--text-muted);">ğŸ’¬ ' + task.comment_count + '</span>' : '';
      const canEdit = boardMyRole === 'admin' || boardMyRole === 'mod';
      let moveHtml = '';
      if (canEdit) {
        const moves = VALID_STATUSES.filter(s => s !== task.status);
        moveHtml = '<div style="display:flex;gap:0.2rem;margin-top:0.3rem;flex-wrap:wrap;" onclick="event.stopPropagation()">' +
          moves.map(s => '<button onclick="boardMoveTask(' + task.id + ',\'' + s + '\')" style="background:none;border:1px solid var(--border);color:var(--text-muted);font-size:0.6rem;padding:0.1rem 0.3rem;border-radius:3px;cursor:pointer;" title="Move to ' + (STATUS_LABELS[s]||s) + '">â†’ ' + (STATUS_LABELS[s]||s).split(' ').pop() + '</button>').join('') +
          '</div>';
      }
      return '<div onclick="openTaskModal(' + task.id + ')" style="background:var(--bg-panel,#141414);border:1px solid var(--border);border-left:3px solid ' + pc + ';border-radius:6px;padding:0.5rem 0.6rem;margin-bottom:0.4rem;cursor:pointer;transition:border-color 0.15s;" onmouseover="this.style.borderColor=\'rgba(255,136,17,0.3)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.borderLeftColor=\'' + pc + '\'">' +
        '<div style="font-size:0.82rem;font-weight:600;color:var(--text);margin-bottom:0.3rem;">' + escHtml(task.title) + '</div>' +
        '<div style="display:flex;gap:0.4rem;align-items:center;flex-wrap:wrap;">' +
          '<span style="display:inline-block;background:' + pc + ';color:#fff;font-size:0.6rem;padding:0.05rem 0.35rem;border-radius:3px;font-weight:700;text-transform:uppercase;">' + task.priority + '</span>' +
          labelHtml + assigneeHtml + commentHtml +
        '</div>' +
        moveHtml +
      '</div>';
    }

    function boardMoveTask(id, status) {
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({ type: 'task_move', id: id, status: status }));
      }
    }

    function openTaskModal(taskId) {
      const task = boardTasks.find(t => t.id === taskId);
      if (!task) return;
      const modal = document.getElementById('task-modal');
      const content = document.getElementById('task-modal-content');
      content.dataset.taskId = taskId;
      const canEdit = boardMyRole === 'admin' || boardMyRole === 'mod';
      const canComment = canEdit || boardMyRole === 'verified' || boardMyRole === 'donor';
      const pc = PRIORITY_COLORS[task.priority] || '#666';
      const labels = (() => { try { return JSON.parse(task.labels || '[]'); } catch { return []; } })();
      const created = new Date(task.created_at).toLocaleString();

      let html = '<h3 style="color:var(--text);margin:0 0 0.5rem;font-size:1.1rem;">' + escHtml(task.title) + '</h3>' +
        '<div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;margin-bottom:0.8rem;">' +
          '<span style="background:' + pc + ';color:#fff;font-size:0.7rem;padding:0.1rem 0.4rem;border-radius:3px;font-weight:700;text-transform:uppercase;">' + task.priority + '</span>' +
          '<span style="font-size:0.75rem;color:var(--text-muted);">' + (STATUS_LABELS[task.status] || task.status) + '</span>' +
          (task.assignee ? '<span style="font-size:0.75rem;color:var(--text-muted);">ğŸ‘¤ ' + escHtml(task.assignee) + '</span>' : '') +
          '<span style="font-size:0.7rem;color:var(--text-muted);">Created: ' + created + '</span>' +
        '</div>';

      if (labels.length) {
        html += '<div style="margin-bottom:0.5rem;">' + labels.map(l => '<span style="display:inline-block;background:rgba(255,136,17,0.15);color:var(--accent);font-size:0.7rem;padding:0.1rem 0.5rem;border-radius:3px;margin-right:0.3rem;">' + escHtml(l) + '</span>').join('') + '</div>';
      }

      if (task.description) {
        html += '<div style="background:var(--bg-input,#111);border-radius:6px;padding:0.6rem;margin-bottom:1rem;font-size:0.82rem;color:var(--text);line-height:1.6;white-space:pre-wrap;">' + escHtml(task.description) + '</div>';
      }

      if (canEdit) {
        html += '<div style="display:flex;gap:0.4rem;margin-bottom:1rem;flex-wrap:wrap;">' +
          '<button class="btn btn-clickable" style="min-width:auto;min-height:32px;padding:0.2rem 0.6rem;font-size:0.75rem;" onclick="showEditTaskForm(' + task.id + ')">âœï¸ Edit</button>' +
          '<button class="btn" style="min-width:auto;min-height:32px;padding:0.2rem 0.6rem;font-size:0.75rem;box-shadow:inset 0 0 0 1px #e55;" onclick="boardDeleteTask(' + task.id + ')">ğŸ—‘ï¸ Delete</button>' +
        '</div>';
      }

      html += '<h4 style="color:var(--text-muted);font-size:0.85rem;margin:1rem 0 0.5rem;border-top:1px solid var(--border);padding-top:0.8rem;">ğŸ’¬ Comments</h4>' +
        '<div id="task-comments-list" data-task-id="' + taskId + '" style="margin-bottom:0.8rem;"><div style="color:var(--text-muted);font-size:0.8rem;">Loadingâ€¦</div></div>';

      if (canComment) {
        html += '<div style="display:flex;gap:0.4rem;">' +
          '<input type="text" id="task-comment-input" placeholder="Add a commentâ€¦" style="flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.82rem;outline:none;font-family:inherit;" onkeydown="if(event.key===\'Enter\')boardAddComment(' + taskId + ')">' +
          '<button onclick="boardAddComment(' + taskId + ')" style="background:var(--accent);color:#fff;border:none;padding:0.4rem 0.8rem;border-radius:6px;font-size:0.82rem;cursor:pointer;font-weight:600;">Post</button>' +
        '</div>';
      }

      content.innerHTML = html;
      modal.style.display = 'flex';

      // Request comments
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({ type: 'task_comments_request', task_id: taskId }));
      }
    }

    function renderCommentHtml(c) {
      const time = new Date(c.created_at).toLocaleString();
      return '<div style="background:var(--bg-input,#111);border-radius:6px;padding:0.4rem 0.6rem;margin-bottom:0.3rem;">' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:0.2rem;"><span style="font-size:0.75rem;font-weight:600;color:var(--accent);">' + escHtml(c.author_name) + '</span><span style="font-size:0.65rem;color:var(--text-muted);">' + time + '</span></div>' +
        '<div style="font-size:0.8rem;color:var(--text);white-space:pre-wrap;">' + escHtml(c.content) + '</div>' +
      '</div>';
    }

    function closeTaskModal() {
      document.getElementById('task-modal').style.display = 'none';
    }

    function boardAddComment(taskId) {
      const input = document.getElementById('task-comment-input');
      if (!input || !input.value.trim()) return;
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({ type: 'task_comment', task_id: taskId, content: input.value.trim() }));
        input.value = '';
      }
    }

    function boardDeleteTask(id) {
      if (!confirm('Delete this task?')) return;
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({ type: 'task_delete', id: id }));
      }
      closeTaskModal();
    }

    function showCreateTaskModal() {
      const modal = document.getElementById('task-modal');
      const content = document.getElementById('task-modal-content');
      content.dataset.taskId = '';
      content.innerHTML =
        '<h3 style="color:var(--text);margin:0 0 1rem;font-size:1.1rem;">Create New Task</h3>' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Title</label>' +
        '<input type="text" id="new-task-title" maxlength="200" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:0.6rem;">' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Description</label>' +
        '<textarea id="new-task-desc" rows="4" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;resize:vertical;margin-bottom:0.6rem;"></textarea>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.6rem;margin-bottom:0.6rem;">' +
          '<div><label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Priority</label>' +
            '<select id="new-task-priority" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem;border-radius:6px;font-size:0.82rem;font-family:inherit;"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option><option value="critical">Critical</option></select></div>' +
          '<div><label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Status</label>' +
            '<select id="new-task-status" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem;border-radius:6px;font-size:0.82rem;font-family:inherit;"><option value="backlog" selected>Backlog</option><option value="in_progress">In Progress</option><option value="testing">Testing</option><option value="done">Done</option></select></div>' +
        '</div>' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Assignee (optional)</label>' +
        '<input type="text" id="new-task-assignee" maxlength="50" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:0.6rem;">' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Labels (comma-separated)</label>' +
        '<input type="text" id="new-task-labels" placeholder="bug, feature, urgent" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:1rem;">' +
        '<button onclick="boardSubmitCreateTask()" style="background:var(--accent);color:#fff;border:none;padding:0.5rem 1.5rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;width:100%;">Create Task</button>';
      modal.style.display = 'flex';
    }

    function boardSubmitCreateTask() {
      const title = document.getElementById('new-task-title').value.trim();
      if (!title) return;
      const labelsStr = document.getElementById('new-task-labels').value.trim();
      const labels = labelsStr ? JSON.stringify(labelsStr.split(',').map(l => l.trim()).filter(Boolean)) : '[]';
      const assignee = document.getElementById('new-task-assignee').value.trim() || null;
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({
          type: 'task_create',
          title: title,
          description: document.getElementById('new-task-desc').value,
          priority: document.getElementById('new-task-priority').value,
          status: document.getElementById('new-task-status').value,
          assignee: assignee,
          labels: labels,
        }));
      }
      closeTaskModal();
    }

    function showEditTaskForm(taskId) {
      const task = boardTasks.find(t => t.id === taskId);
      if (!task) return;
      const content = document.getElementById('task-modal-content');
      const labels = (() => { try { return JSON.parse(task.labels || '[]'); } catch { return []; } })();
      content.innerHTML =
        '<h3 style="color:var(--text);margin:0 0 1rem;font-size:1.1rem;">Edit Task</h3>' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Title</label>' +
        '<input type="text" id="edit-task-title" maxlength="200" value="' + escHtml(task.title).replace(/"/g,'&quot;') + '" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:0.6rem;">' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Description</label>' +
        '<textarea id="edit-task-desc" rows="4" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;resize:vertical;margin-bottom:0.6rem;">' + escHtml(task.description) + '</textarea>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.6rem;margin-bottom:0.6rem;">' +
          '<div><label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Priority</label>' +
            '<select id="edit-task-priority" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem;border-radius:6px;font-size:0.82rem;font-family:inherit;"><option value="low"' + (task.priority==='low'?' selected':'') + '>Low</option><option value="medium"' + (task.priority==='medium'?' selected':'') + '>Medium</option><option value="high"' + (task.priority==='high'?' selected':'') + '>High</option><option value="critical"' + (task.priority==='critical'?' selected':'') + '>Critical</option></select></div>' +
          '<div><label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Assignee</label>' +
            '<input type="text" id="edit-task-assignee" maxlength="50" value="' + escHtml(task.assignee||'').replace(/"/g,'&quot;') + '" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.82rem;outline:none;font-family:inherit;"></div>' +
        '</div>' +
        '<label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.2rem;">Labels (comma-separated)</label>' +
        '<input type="text" id="edit-task-labels" value="' + labels.join(', ').replace(/"/g,'&quot;') + '" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:6px;font-size:0.85rem;outline:none;font-family:inherit;margin-bottom:1rem;">' +
        '<button onclick="boardSubmitEditTask(' + task.id + ')" style="background:var(--accent);color:#fff;border:none;padding:0.5rem 1.5rem;border-radius:6px;font-size:0.85rem;cursor:pointer;font-weight:600;width:100%;">Save Changes</button>';
    }

    function boardSubmitEditTask(id) {
      const title = document.getElementById('edit-task-title').value.trim();
      if (!title) return;
      const labelsStr = document.getElementById('edit-task-labels').value.trim();
      const labels = labelsStr ? JSON.stringify(labelsStr.split(',').map(l => l.trim()).filter(Boolean)) : '[]';
      const assignee = document.getElementById('edit-task-assignee').value.trim() || null;
      if (boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({
          type: 'task_update',
          id: id,
          title: title,
          description: document.getElementById('edit-task-desc').value,
          priority: document.getElementById('edit-task-priority').value,
          assignee: assignee,
          labels: labels,
        }));
      }
      closeTaskModal();
    }

    // Close modal on backdrop click
    document.getElementById('task-modal').addEventListener('click', function(e) {
      if (e.target === this) closeTaskModal();
    });

    // Connect board WebSocket when tab switches to board
    const origSwitchTab2 = switchTab;
    switchTab = function(tabId, pushState) {
      origSwitchTab2(tabId, pushState);
      if (tabId === 'board' && (!boardWs || boardWs.readyState > 1)) {
        boardConnect();
      } else if (tabId === 'board' && boardWs && boardWs.readyState === 1) {
        boardWs.send(JSON.stringify({ type: 'task_list' }));
      }
    };

    // Auto-connect if initial tab is board
    if (initialTab === 'board') boardConnect();

    // Mobile responsive: stack columns on small screens
    (function() {
      const style = document.createElement('style');
      style.textContent = '@media (max-width: 768px) { #board-columns { grid-template-columns: 1fr !important; } }';
      document.head.appendChild(style);
    })();

    // â”€â”€ Auto-refresh on server update â”€â”€
    (function() {
      let knownVersion = null;
      async function checkVersion() {
        try {
          const res = await fetch('/api/stats');
          if (!res.ok) return;
          const data = await res.json();
          if (!data.version) return;
          if (knownVersion === null) {
            knownVersion = data.version;
          } else if (knownVersion !== data.version) {
            console.log('Server updated (' + knownVersion + ' â†’ ' + data.version + '), reloadingâ€¦');
            location.reload();
          }
        } catch (e) { /* network hiccup, try again next cycle */ }
      }
      checkVersion();
      setInterval(checkVersion, 30000);
    })();
  </script>
</body>
</html>
