<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Humanity Network</title>
  <meta name="description" content="A cooperative chat platform with cryptographic identity. No accounts, no tracking. Just people talking freely.">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Humanity Network â€” Chat">
  <meta property="og:description" content="A cooperative chat platform with cryptographic identity. No accounts, no tracking, no surveillance.">
  <meta property="og:url" content="https://united-humanity.us/chat">
  <meta property="og:image" content="https://united-humanity.us/favicon.png">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Humanity Network â€” Chat">
  <meta name="twitter:description" content="Cooperative chat with Ed25519 identity. No accounts. No tracking.">
  <meta name="twitter:image" content="https://united-humanity.us/favicon.png">
  <meta name="theme-color" content="#FF8811">
  <link rel="manifest" href="/shared/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Humanity">
  <link rel="apple-touch-icon" href="/shared/icons/icon-192.png">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="/shared/theme.css">
  <link rel="stylesheet" href="/chat/style.css">
  <script src="https://cdn.jsdelivr.net/npm/@twemoji/api@latest/dist/twemoji.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <script src="/shared/shell.js"></script>
  <script src="/shared/settings.js"></script>

  <!-- Login Screen -->
  <div id="login-screen">
    <h1>ğŸŒ Humanity Network</h1>
    <p>A cooperative communication platform.<br>No accounts. No tracking. Just people.</p>
    <input type="text" id="name-input" placeholder="Choose a name" autofocus>
    <input type="text" id="link-code-input" placeholder="Link code (optional)" style="margin-top:0.5rem; display:block;">
    <input type="text" id="invite-code-input" placeholder="Invite code (optional)" style="margin-top:0.5rem; display:block;">
    <button onclick="connect()">Enter</button>
    <button onclick="document.getElementById('import-file-input').click()" style="background:var(--bg-input);color:var(--text-muted);border:1px solid var(--border);padding:0.5rem 1.5rem;border-radius:6px;font-size:0.85rem;cursor:pointer;margin-top:0.3rem;">ğŸ“¥ Import Identity Backup</button>
    <input type="file" id="import-file-input" accept=".json" style="display:none;" onchange="handleImportFile(event)">
    <p class="subtitle" id="login-error" style="color:#e74c3c; display:none;"></p>
    <p class="subtitle" id="crypto-status">Checking Ed25519 supportâ€¦</p>
    <p class="subtitle" style="margin-top: 1rem; font-size: 0.68rem; max-width: 380px; line-height: 1.5;">
      By entering, you confirm you are <strong style="color:var(--text);">18 years or older</strong> and agree to be respectful.<br>
      Your identity is a cryptographic key stored in your browser â€” <a href="https://shaostoul.com/Humanity/" target="_blank" rel="noopener" style="color:var(--accent);">learn more</a>.
    </p>
  </div>

  <!-- Chat Screen -->
  <div id="chat-screen">
    <header>
      <div class="header-left">
        <button id="hamburger" onclick="toggleSidebar('sidebar')">â˜°</button>
        <h1>ğŸŒ Humanity</h1>
        <span id="stats"></span>
      </div>
      <div style="display:flex;align-items:center;gap:0.5rem;">
        <button id="search-toggle" onclick="toggleSearch()" title="Search messages">ğŸ”</button>
        <button id="sound-toggle" onclick="toggleSoundMenu()" title="Notification sounds" style="background:none;border:none;color:var(--text);cursor:pointer;font-size:1.1rem;padding:0.2rem;">ğŸ””</button>
        <button id="people-toggle" onclick="toggleSidebar('right-sidebar')" title="Users">ğŸ‘¤</button>
        <div id="status" class="disconnected"><span class="dot"></span><span id="status-text">Disconnected</span></div>
      </div>
      <div id="sound-menu" style="display:none;position:absolute;top:3rem;right:5rem;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:0.6rem;z-index:200;min-width:200px;box-shadow:0 4px 12px rgba(0,0,0,0.3);">
        <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:0.4rem;font-weight:600;">NOTIFICATION SOUND</div>
        <div id="sound-options" style="display:flex;flex-direction:column;gap:0.25rem;"></div>
        <div style="border-top:1px solid var(--border);margin-top:0.5rem;padding-top:0.4rem;">
          <label style="font-size:0.75rem;color:var(--text);display:flex;align-items:center;gap:0.4rem;cursor:pointer;">
            <input type="checkbox" id="sound-enabled" checked onchange="toggleSoundEnabled()" style="accent-color:var(--accent);">
            Sounds enabled
          </label>
        </div>
      </div>
    </header>
    <div class="main">
      <div id="sidebar-overlay"></div>
      <div id="sidebar">
        <h3>Your Identity</h3>
        <div id="my-identity" style="font-size:0.7rem; color:var(--text-muted); margin-bottom:0.75rem; word-break:break-all;">
          <div id="my-key-display" style="font-family:monospace; font-size:0.6rem;"></div>
          <div id="my-sign-status" style="margin-top:0.2rem;"></div>
          <button id="edit-profile-btn" onclick="openEditProfileModal()" style="margin-top:0.4rem;background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.25rem 0.5rem;border-radius:4px;font-size:0.7rem;cursor:pointer;width:100%;">âœï¸ Edit Profile</button>
          <button id="export-identity-btn" onclick="downloadIdentityBackup(myName)" style="margin-top:0.25rem;background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.25rem 0.5rem;border-radius:4px;font-size:0.7rem;cursor:pointer;width:100%;">ğŸ“¥ Export Identity</button>
          <button id="my-devices-btn" onclick="openDevicePanel()" style="margin-top:0.25rem;background:var(--bg-input);border:1px solid var(--border);color:var(--text-muted);padding:0.25rem 0.5rem;border-radius:4px;font-size:0.7rem;cursor:pointer;width:100%;">ğŸ”‘ My Devices</button>
        </div>
        <div class="sidebar-tabs" id="sidebar-tabs">
          <button class="sidebar-tab active" data-tab="servers">ğŸ  Servers</button>
          <button class="sidebar-tab" data-tab="groups">ğŸ‘¥ Groups</button>
          <button class="sidebar-tab" data-tab="dms">ğŸ’¬ DMs</button>
        </div>
        <div id="tab-servers" class="sidebar-tab-content active">
          <div id="server-list"></div>
        </div>
        <div id="tab-groups" class="sidebar-tab-content">
          <div class="groups-placeholder">P2P group chats â€” coming soon</div>
        </div>
        <div id="tab-dms" class="sidebar-tab-content">
          <div id="dm-list"></div>
        </div>
        <!-- Hidden channel-list container used by renderChannelList() -->
        <div id="channel-list" style="display:none;"></div>
        <!-- Voice Control Bar (shown when in a voice channel) -->
        <div id="voice-control-bar">
          <div class="vc-bar-header" id="vc-bar-channel-name">ğŸ”Š Connected</div>
          <div class="vc-bar-controls">
            <button id="vc-mute-btn" onclick="toggleVoiceRoomMute()" title="Mute/Unmute">ğŸ¤</button>
            <button id="vc-video-btn" onclick="toggleVoiceRoomVideo()" oncontextmenu="event.preventDefault();showCameraSelector('vr')" title="Toggle Camera (right-click to select device)">ğŸ“¹</button>
            <button id="vc-screen-btn" onclick="toggleVoiceRoomScreenShare()" title="Screen Share">ğŸ–¥ï¸</button>
            <button id="vc-pip-btn" onclick="togglePiP()" title="Picture-in-Picture">ğŸ“Œ</button>
            <input type="range" class="vc-volume" id="vc-volume-slider" min="0" max="100" value="100" title="Master volume" oninput="setVoiceRoomVolume(this.value)">
            <button class="vc-disconnect" onclick="leaveVoiceRoom()" title="Disconnect">ğŸ”Œ</button>
          </div>
        </div>
      </div>
      <div id="chat-area">
        <div id="search-bar" style="position:relative;">
          <div style="display:flex;gap:6px;align-items:center;padding:8px 12px;">
            <input type="text" id="search-input" placeholder="Search messagesâ€¦" autocomplete="off" style="flex:1;">
            <input type="text" id="search-from" placeholder="From userâ€¦" autocomplete="off" style="width:120px;padding:6px 8px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.85rem;">
            <span id="search-count" style="color:var(--text-muted);font-size:0.75rem;white-space:nowrap;"></span>
            <button class="search-close" onclick="closeSearch()">âœ•</button>
          </div>
          <div id="search-results"></div>
        </div>
        <div id="channel-header"></div>
        <div id="call-bar">
          <div class="call-info">
            <span>ğŸ”Š</span>
            <span id="call-peer-name">In call</span>
            <span class="call-timer" id="call-timer">00:00</span>
          </div>
          <div class="call-actions">
            <button class="btn-mute" id="mute-btn" onclick="toggleMute()">ğŸ¤ Mute</button>
            <button class="btn-video" id="video-btn" onclick="toggleVideo()" oncontextmenu="event.preventDefault();showCameraSelector('dm')">ğŸ“¹ Video</button>
            <button class="btn-video" id="screen-btn" onclick="toggleScreenShare()">ğŸ–¥ï¸ Screen</button>
            <button class="btn-video" id="pip-btn" onclick="togglePiP()">ğŸ“Œ PiP</button>
            <button class="btn-hangup" onclick="hangupCall()">ğŸ“µ Hangup</button>
            <div class="camera-selector" id="camera-selector-dm"></div>
          </div>
        </div>
        <div id="ringing-status">ğŸ“ Callingâ€¦</div>
        <div id="pin-bar" onclick="togglePinList()">
          <span class="pin-summary"><span class="pin-icon">ğŸ“Œ</span> <span id="pin-count">0</span> pinned â€” click to expand</span>
        </div>
        <div id="pin-list">
          <div id="server-pins-section" style="display:none;">
            <div class="pin-section-header">ğŸ“Œ Server Pins</div>
            <div id="server-pins"></div>
          </div>
          <div id="my-pins-section" style="display:none;">
            <div class="pin-section-header">â­ My Pins</div>
            <div id="my-pins"></div>
          </div>
        </div>
        <div id="messages"></div>
        <div id="typing-indicator"></div>
        <div id="reply-bar" style="display:none;">
          <div id="reply-preview"></div>
          <button id="reply-cancel" title="Cancel reply">âœ•</button>
        </div>
        <div id="upload-indicator"></div>
        <div id="char-counter"></div>
        <div id="cmd-palette-overlay" onclick="closeCmdPalette()">
          <div id="cmd-palette" onclick="event.stopPropagation()"></div>
        </div>
        <div id="input-area">
          <button id="cmd-palette-btn" onclick="toggleCmdPalette()" title="Commands">+</button>
          <button id="attach-btn" onclick="document.getElementById('file-upload-input').click()" title="Attach file">ğŸ“</button>
          <input type="file" id="file-upload-input" style="display:none;" accept=".png,.jpg,.jpeg,.gif,.webp,.pdf,.txt,.md,.json,.zip,.tar.gz,.mp3,.mp4,.webm,.ogg,.wav" onchange="handleFileAttachment(event)">
          <textarea id="msg-input" placeholder="Type a messageâ€¦" rows="1" disabled></textarea>
          <button id="send-btn" onclick="sendMessage()" disabled>Send</button>
          <button id="help-btn" onclick="toggleHelpModal()" title="Help & Commands">?</button>
        </div>
      </div>
      <div id="right-sidebar">
        <h3>Users</h3>
        <div id="peer-list"></div>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="help-modal-overlay" onclick="closeHelpModal(event)">
    <div id="help-modal" onclick="event.stopPropagation()">
      <button id="help-close" onclick="toggleHelpModal()">âœ•</button>
      <h2>ğŸ“– Commands & Help</h2>

      <h4>ğŸ’¬ Basic Commands</h4>
      <div class="cmd"><code>/help</code> â€” Show available commands</div>
      <div class="cmd"><code>/profile</code> â€” Open your profile editor (bio &amp; socials)</div>
      <div class="cmd"><code>/link</code> â€” Generate a code to link another device</div>
      <div class="cmd"><code>/revoke &lt;key_prefix&gt;</code> â€” Remove a lost/stolen device from your name</div>
      <div class="cmd"><code>/users</code> â€” List all registered users (online/offline)</div>
      <div class="cmd"><code>/report &lt;name&gt; [reason]</code> â€” Report a user</div>
      <div class="cmd"><code>/export</code> â€” Download your identity backup file</div>
      <div class="cmd"><code>/dm &lt;name&gt; &lt;message&gt;</code> â€” Send a direct message</div>
      <div class="cmd"><code>/dms</code> â€” List your DM conversations</div>
      <div class="cmd"><code>/block &lt;name&gt;</code> â€” Block a user (hides their messages)</div>
      <div class="cmd"><code>/unblock &lt;name&gt;</code> â€” Unblock a user</div>
      <div class="cmd"><code>/blocklist</code> â€” Show your blocked users</div>

      <h4>ğŸ‘¥ Social</h4>
      <div class="cmd"><code>/follow &lt;name&gt;</code> â€” Follow a user (mutual follow = friends, unlocks DMs)</div>
      <div class="cmd"><code>/unfollow &lt;name&gt;</code> â€” Unfollow a user</div>
      <div class="cmd"><code>/friend-code</code> â€” Generate a friend code to share outside the platform</div>
      <div class="cmd"><code>/redeem &lt;code&gt;</code> â€” Redeem a friend code (auto-adds as friends)</div>

      <h4>ğŸ‘¥ Groups</h4>
      <div class="cmd"><code>/group-create &lt;name&gt;</code> â€” Create a new group chat</div>
      <div class="cmd"><code>/group-join &lt;invite_code&gt;</code> â€” Join a group by invite code</div>
      <div class="cmd"><code>/group-invite</code> â€” Copy the current group's invite code</div>
      <div class="cmd"><code>/group-leave</code> â€” Leave the current group</div>

      <h4>âœï¸ Formatting</h4>
      <div class="cmd"><code>**bold**</code> â†’ <strong>bold</strong></div>
      <div class="cmd"><code>*italic*</code> â†’ <em>italic</em></div>
      <div class="cmd"><code>~~strike~~</code> â†’ <del>strike</del></div>
      <div class="cmd"><code>`code`</code> â†’ <code style="background:var(--bg-hover);padding:0.1rem 0.3rem;border-radius:3px;">code</code></div>
      <div class="cmd">Click â†© on a message to quote-reply</div>
      <div class="cmd">Click âœï¸ on your own message to edit it</div>
      <div class="cmd"><code>/edit &lt;text&gt;</code> â€” Edit your last message</div>
      <div class="cmd">Paste or drag an image to upload</div>

      <h4>ğŸ“Œ Pins</h4>
      <div class="cmd"><code>/pins</code> â€” List pinned messages in this channel</div>
      <div class="cmd"><code>/pin</code> â€” Pin the last message (mod/admin)</div>
      <div class="cmd"><code>/unpin &lt;N&gt;</code> â€” Unpin message by index (mod/admin)</div>

      <h4>ğŸ›¡ï¸ Moderator Commands</h4>
      <div class="cmd"><code>/kick &lt;name&gt;</code> â€” Disconnect a user</div>
      <div class="cmd"><code>/mute &lt;name&gt;</code> â€” Mute a user</div>
      <div class="cmd"><code>/unmute &lt;name&gt;</code> â€” Unmute a user</div>

      <h4>ğŸ‘‘ Admin Commands</h4>
      <div class="cmd"><code>/ban &lt;name&gt;</code> â€” Ban a user</div>
      <div class="cmd"><code>/unban &lt;name&gt;</code> â€” Unban a user</div>
      <div class="cmd"><code>/mod &lt;name&gt;</code> â€” Make a user a moderator</div>
      <div class="cmd"><code>/unmod &lt;name&gt;</code> â€” Remove moderator role</div>
      <div class="cmd"><code>/verify &lt;name&gt;</code> â€” Mark user as verified</div>
      <div class="cmd"><code>/unverify &lt;name&gt;</code> â€” Remove verified status</div>
      <div class="cmd"><code>/lockdown</code> â€” Toggle registration lock</div>
      <div class="cmd"><code>/wipe</code> â€” Delete all chat history</div>
      <div class="cmd"><code>/gc</code> â€” Garbage collect inactive names (90 days)</div>
      <div class="cmd"><code>/channel-create &lt;name&gt; [--readonly] [desc]</code> â€” Create a channel</div>
      <div class="cmd"><code>/channel-delete &lt;name&gt;</code> â€” Delete a channel</div>
      <div class="cmd"><code>/channel-readonly &lt;name&gt;</code> â€” Toggle read-only on a channel</div>
      <div class="cmd"><code>/channel-reorder &lt;name&gt; &lt;pos&gt;</code> â€” Set channel sort position (lower = higher)</div>
      <div class="cmd"><code>/invite</code> â€” Generate an invite code for lockdown bypass</div>
      <div class="cmd"><code>/name-release &lt;name&gt;</code> â€” Release a name for re-registration</div>
      <div class="cmd"><code>/reports</code> â€” View recent reports</div>
      <div class="cmd"><code>/reports-clear</code> â€” Clear all reports</div>
    </div>
  </div>

  <!-- User Context Menu -->
  <div id="user-context-menu"></div>

  <!-- Edit Profile Modal -->
  <div id="edit-profile-overlay" class="profile-modal-overlay" onclick="closeEditProfileModal(event)">
    <div class="profile-modal" onclick="event.stopPropagation()">
      <button class="close-btn" onclick="closeEditProfileOverlay()">âœ•</button>
      <h2>âœï¸ Edit Profile</h2>
      <label for="profile-bio">Bio</label>
      <textarea id="profile-bio" rows="3" maxlength="280" placeholder="Tell people about yourselfâ€¦"></textarea>
      <div class="bio-counter" id="bio-counter">0 / 280</div>
      <label for="profile-website">ğŸŒ Website</label>
      <input type="text" id="profile-website" maxlength="200" placeholder="https://yoursite.com">
      <label for="profile-discord">ğŸ’¬ Discord</label>
      <input type="text" id="profile-discord" maxlength="100" placeholder="username">
      <label for="profile-twitter">ğ• X / Twitter</label>
      <input type="text" id="profile-twitter" maxlength="100" placeholder="handle (without @)">
      <label for="profile-youtube">â–¶ï¸ YouTube</label>
      <input type="text" id="profile-youtube" maxlength="200" placeholder="https://youtube.com/@channel or channel name">
      <label for="profile-github">ğŸ™ GitHub</label>
      <input type="text" id="profile-github" maxlength="200" placeholder="username">
      <div class="btn-row">
        <button class="btn-cancel" onclick="closeEditProfileOverlay()">Cancel</button>
        <button class="btn-save" onclick="saveProfile()">Save</button>
      </div>
    </div>
  </div>

  <!-- Incoming Call Modal -->
  <div id="incoming-call-overlay">
    <div id="incoming-call-box">
      <div class="call-icon">ğŸ“</div>
      <div class="caller-name" id="incoming-caller-name">Someone</div>
      <div class="call-label">is calling youâ€¦</div>
      <div class="call-btns">
        <button class="btn-reject" onclick="rejectIncomingCall()">Reject</button>
        <button class="btn-accept" onclick="acceptIncomingCall()">Accept</button>
      </div>
    </div>
  </div>

  <!-- Video Panel -->
  <div id="video-panel"></div>

  <!-- Status Picker -->
  <div id="status-picker">
    <h4>Set Status</h4>
    <div class="status-option" data-status="online" onclick="setMyStatus('online')">
      <span class="status-indicator status-online"></span>
      <span class="status-label">Online</span>
    </div>
    <div class="status-option" data-status="away" onclick="setMyStatus('away')">
      <span class="status-indicator status-away"></span>
      <span class="status-label">Away</span>
    </div>
    <div class="status-option" data-status="busy" onclick="setMyStatus('busy')">
      <span class="status-indicator status-busy"></span>
      <span class="status-label">Busy</span>
    </div>
    <div class="status-option" data-status="dnd" onclick="setMyStatus('dnd')">
      <span class="status-indicator status-dnd"></span>
      <span class="status-label">Do Not Disturb</span>
    </div>
    <input type="text" id="status-text-input" placeholder="What are you up to?" maxlength="128">
    <button class="status-clear-btn" onclick="clearMyStatus()">Clear Status</button>
  </div>

  <!-- Device Management Modal -->
  <div id="device-panel-overlay" class="profile-modal-overlay" onclick="if(event.target===this)this.classList.remove('open')">
    <div class="profile-modal" onclick="event.stopPropagation()" style="max-width:420px;">
      <button class="close-btn" onclick="document.getElementById('device-panel-overlay').classList.remove('open')">âœ•</button>
      <h2>ğŸ”‘ My Devices</h2>
      <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.5rem">Keys linked to your account. Label them to remember which device is which.</p>
      <div id="device-list"></div>
      <button onclick="requestDeviceList()" style="margin-top:0.5rem;font-size:0.8rem;padding:0.3rem 0.6rem;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;color:var(--text);cursor:pointer">â†» Refresh</button>
    </div>
  </div>

  <!-- View Profile Modal -->
  <div id="view-profile-overlay" class="profile-modal-overlay" onclick="closeViewProfileModal(event)">
    <div class="profile-modal" id="view-profile-card" onclick="event.stopPropagation()">
      <button class="close-btn" onclick="closeViewProfileOverlay()">âœ•</button>
      <div id="view-profile-content">
        <div style="color:var(--text-muted);font-style:italic;">Loading profileâ€¦</div>
      </div>
    </div>
  </div>

  <!-- Thread Panel -->
  <div id="thread-panel">
    <div id="thread-panel-header">
      <span>Thread</span>
      <button onclick="closeThreadPanel()" title="Close">âœ•</button>
    </div>
    <div id="thread-panel-messages"></div>
    <div id="thread-panel-input">
      <textarea id="thread-input" placeholder="Reply in thread..." rows="1"></textarea>
      <button onclick="sendThreadReply()">Reply</button>
    </div>
  </div>


  <!-- External scripts: crypto module must load before app -->
  <!-- nginx serves these from /chat/ which aliases to this directory -->
  <script src="/chat/crypto.js"></script>
  <script src="/chat/app.js"></script>

</body>
</html>
